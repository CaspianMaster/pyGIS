
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta content="Introducing PyGIS an open source book on spatial programming. We cover how to handle points, lines and polygons, including shapefiles, handling remote sensing imagery, and other raster data." lang="en" name="description" xml:lang="en" />
<meta content="Présentation de PyGIS, un livre open source sur la programmation géospatiale. Nous expliquons comment gérer les points, les lignes et les polygones, y compris les fichiers de formes, la gestion des images de télédétection et d'autres données raster." lang="fr" name="description" xml:lang="fr" />
<meta content="Presentamos PyGIS, un libro de código abierto sobre programación geoespacial. Cubrimos cómo manejar puntos, líneas y polígonos, incluidos los shapefiles, el manejo de imágenes de detección remota y otros datos ráster." lang="es" name="description" xml:lang="es" />
<meta content="Shapefiles, points, lines, polygons,raster, Remote Sensing" name="keywords" />
<meta content="en_US" property="og:locale" />
<meta content="Learn how install a working python environment for spatial data and remote sensing. Here we utilize Docker to make the process replicable and at least somewhat easy to understand." lang="en" name="description" xml:lang="en" />
<meta content="Découvrez comment installer un environnement python fonctionnel pour les données spatiales et la télédétection. Ici, nous utilisons Docker pour rendre le processus reproductible et au moins quelque peu facile à comprendre." lang="fr" name="description" xml:lang="fr" />
<meta content="Aprenda a instalar un entorno Python que funcione para datos espaciales y detección remota. Aquí utilizamos Docker para hacer que el proceso sea replicable y al menos algo fácil de entender." lang="es" name="description" xml:lang="es" />
<meta content="python environment, Docker, spatial, raster, shapefile, remote sensing" name="keywords" />
<meta content="en_US" property="og:locale" />
<meta content="Learn the difference between raster and vector data, manually create spatial data, and data measurement issues" lang="en" name="description" xml:lang="en" />
<meta content="Découvrez la différence entre les données raster et vectorielles, créez manuellement des données géospatiales et les problèmes de mesure des données" lang="fr" name="description" xml:lang="fr" />
<meta content="Conozca la diferencia entre datos ráster y vectoriales, cree manualmente datos geoespaciales y problemas de medición de datos" lang="es" name="description" xml:lang="es" />
<meta content="points, lines, polygons,raster, spatial, attribute table" name="keywords" />
<meta content="en_US" property="og:locale" />
<meta content="Learn to create new vector objects, assign projections or CRS, and write them to a shapefile or geojson. We also cover creating basic maps with points, lines and polygons." lang="en" name="description" xml:lang="en" />
<meta content="Apprenez à créer de nouveaux objets vectoriels, à attribuer des projections ou à des CRS et à les écrire dans un fichier de formes ou un geojson. Nous couvrons également la création de cartes de base avec des points, des lignes et des polygones." lang="fr" name="description" xml:lang="fr" />
<meta content="Aprenda a crear nuevos objetos vectoriales, asigne proyecciones o CRS y escríbalos en un shapefile o geojson. También cubrimos la creación de mapas básicos con puntos, líneas y polígonos." lang="es" name="description" xml:lang="es" />
<meta content=" spatial, shapefile, geopandas" name="keywords" />
<meta content="en_US" property="og:locale" />
<meta content="Learn how to create new vector data (shapefile), and assign a projection (CRS). This includes an example of plotting latitude longitude data stored in a .csv file." lang="en" name="description" xml:lang="en" />
<meta content="Apprenez à modifier, sous-ensemble et tracer des données attributaires de données vectorielles (fichier de formes). Cela inclut un exemple de traçage des données de longitude de latitude ainsi que le sous-ensemble (indexation) par emplacement." lang="fr" name="description" xml:lang="fr" />
<meta content="Aprenda a cambiar, crear subconjuntos y trazar datos de atributos de datos vectoriales (shapefile). Esto incluye un ejemplo de trazado de datos de latitud y longitud, así como subconjuntos (indexación) por ubicación." lang="es" name="description" xml:lang="es" />
<meta content="spatial, attribute data, subset,  shapefile" name="keywords" />
<meta content="en_US" property="og:locale" />
<meta content="Learn to create new spatial raster objects, assign projections or CRS." lang="en" name="description" xml:lang="en" />
<meta content="Apprenez à créer de nouveaux objets raster, à attribuer des projections ou CRS." lang="fr" name="description" xml:lang="fr" />
<meta content="Aprenda a crear nuevos objetos ráster, asignar proyecciones o CRS." lang="es" name="description" xml:lang="es" />
<meta content="raster, spatial, shapefile, rasterio, numpy" name="keywords" />
<meta content="en_US" property="og:locale" />
<meta content="Learn the basics of coordinate reference systems (CRS) or projections, how to differentiate projected and geographic CRSs and their impact on size, shape, area, and distance." lang="en" name="description" xml:lang="en" />
<meta content="Apprenez les bases des systèmes de référence de coordonnées (CRS) ou des projections, comment différencier les CRS projetés et géographiques et leur impact sur la taille, la forme, la surface et la distance." lang="fr" name="description" xml:lang="fr" />
<meta content="Aprenda los conceptos básicos de los sistemas de referencia de coordenadas (CRS) o proyecciones, cómo diferenciar los CRS proyectados y geográficos y su impacto en el tamaño, la forma, el área y la distancia." lang="es" name="description" xml:lang="es" />
<meta content="spatial,  crs, coordinate reference system, projection" name="keywords" />
<meta content="en_US" property="og:locale" />
<meta content="Learn how to interpret and use coordinate reference codes like proj4strings, and EPSG codes. This includes defining a CRS, creating custom projections, interpreting proj4strings, with examples of false easting and northing, and changing the prime meridian." lang="en" name="description" xml:lang="en" />
<meta content="Apprenez à interpréter et à utiliser des codes de référence de coordonnées tels que proj4strings et codes EPSG. Cela comprend la définition d'un CRS, la création de projections personnalisées, l'interprétation de chaînes de projection, avec des exemples de faux est et nord, et la modification du méridien principal." lang="fr" name="description" xml:lang="fr" />
<meta content="Aprenda a interpretar y utilizar códigos de referencia de coordenadas como proj4strings y códigos EPSG. Esto incluye la definición de un CRS, la creación de proyecciones personalizadas, la interpretación de cadenas de proyectos, con ejemplos de falso este y norte, y el cambio del primer meridiano." lang="es" name="description" xml:lang="es" />
<meta content="spatial, crs, proj4string, EPSG, coordinate reference system, projection" name="keywords" />
<meta content="en_US" property="og:locale" />
<meta content="Learn to the mechanics of reprojecting spatial raster data through affine transformation. We cover topics like translate, rotate, skew and shear by learning the basic principals of matrix algebra and how it can be used to scale spatial operations." lang="en" name="description" xml:lang="en" />
<meta content="Apprenez aux mécanismes de reprojection de données raster géospatiales par transformation affine. Nous abordons des sujets tels que la traduction, la rotation, l'inclinaison et le cisaillement en apprenant les principes de base de l'algèbre matricielle et comment elle peut être utilisée pour mettre à l'échelle des opérations spatiales." lang="fr" name="description" xml:lang="fr" />
<meta content="Aprenda la mecánica de reproyectar datos ráster geoespaciales a través de la transformación afín. Cubrimos temas como traducir, rotar, sesgar y cortar aprendiendo los principios básicos del álgebra matricial y cómo se puede utilizar para escalar operaciones espaciales." lang="es" name="description" xml:lang="es" />
<meta content=" spatial,raster, crs, coordinate reference system, reproject, affine, transform" name="keywords" />
<meta content="en_US" property="og:locale" />
<meta content="Learn how to define a projection for and reproject vector data (shapefiles, geojson) using geopandas. We use examples based on changes to proj4strings." lang="en" name="description" xml:lang="en" />
<meta content="Apprenez à définir une projection et à reprojeter des données vectorielles (fichiers de formes, geojson) à l'aide de géopandas. Nous utilisons des exemples basés sur des changements apportés à proj4strings." lang="fr" name="description" xml:lang="fr" />
<meta content="Aprenda a definir una proyección y reproyectar datos vectoriales (shapefiles, geojson) usando geopandas. Usamos ejemplos basados en cambios en proj4strings." lang="es" name="description" xml:lang="es" />
<meta content="spatial, crs, proj4string, EPSG, coordinate reference system, projection, vector, shapefile" name="keywords" />
<meta content="en_US" property="og:locale" />
<meta content="Learn the basics of coordinate reference systems (CRS) or projections for spatial raster data. We also cover how to transform CRS using rasterio and geowombat." lang="en" name="description" xml:lang="en" />
<meta content="Apprenez les bases des systèmes de référence de coordonnées (CRS) ou des projections pour les données raster géospatiales. Nous expliquons également comment transformer CRS en utilisant rasterio et geowombat." lang="fr" name="description" xml:lang="fr" />
<meta content="Aprenda los conceptos básicos de los sistemas de referencia de coordenadas (CRS) o proyecciones para datos ráster geoespaciales. También cubrimos cómo transformar CRS usando rasterio y geowombat." lang="es" name="description" xml:lang="es" />
<meta content="spatial, raster, affine, crs, coordinate reference system, interpolation, projection" name="keywords" />
<meta content="en_US" property="og:locale" />
<meta content="Learn how to change, subset, and plot vector data (shapefile) attribute data. This includes an example of plotting latitude longitude data as well as subsetting (indexing) by location." lang="en" name="description" xml:lang="en" />
<meta content="Apprenez à modifier, sous-ensemble et tracer des données attributaires de données vectorielles (fichier de formes). Cela inclut un exemple de traçage des données de longitude de latitude ainsi que le sous-ensemble (indexation) par emplacement." lang="fr" name="description" xml:lang="fr" />
<meta content="Aprenda a cambiar, crear subconjuntos y trazar datos de atributos de datos vectoriales (shapefile). Esto incluye un ejemplo de trazado de datos de latitud y longitud, así como subconjuntos (indexación) por ubicación." lang="es" name="description" xml:lang="es" />
<meta content="spatial, attribute data, subset,  shapefile" name="keywords" />
<meta content="en_US" property="og:locale" />
<meta content="In python create buffers and find the nearest neighbor for points" lang="en" name="description" xml:lang="en" />
<meta content="python spatial buffer neighbor" name="keywords" />
<meta content="en_US" property="og:locale" />
<meta content="Learn how to merge new data into a shapefiles attribute table, dissolve polygons by attributes, and other group-by operations in geopandas." lang="en" name="description" xml:lang="en" />
<meta content="Découvrez comment fusionner de nouvelles données dans une table attributaire de fichiers de formes, dissoudre des polygones par attributs et d'autres opérations de regroupement dans les géopandas." lang="fr" name="description" xml:lang="fr" />
<meta content="Aprenda a fusionar nuevos datos en una tabla de atributos de shapefiles, disolver polígonos por atributos y otras operaciones de agrupamiento en geopandas." lang="es" name="description" xml:lang="es" />
<meta content="python, spatial, polygon,vector,  shapefile, dissolve by attributes, merge attributes" name="keywords" />
<meta content="en_US" property="og:locale" />
<meta content="Learn how to subset and extract data from a GeoDataFrame through clipping, selecting by attribute, and selecting by location." lang="en" name="description" xml:lang="en" />
<meta content="spatial, attribute data, subset, extract, selection, vector, shapefile" name="keywords" />
<meta content="en_US" property="og:locale" />
<meta content="Learn how to overlay and join vector data to create new geometries." lang="en" name="description" xml:lang="en" />
<meta content="spatial, overlay, join, vector, shapefile" name="keywords" />
<meta content="en_US" property="og:locale" />
<meta content="Learn all about conducting spatial joins." lang="en" name="description" xml:lang="en" />
<meta content="spatial, spatial, join" name="keywords" />
<meta content="en_US" property="og:locale" />
<meta content="Learn how to aggregate spatial data to identify areas of high and low concentration." lang="en" name="description" xml:lang="en" />
<meta content="spatial, aggregate, summarize, binning, vector, shapefile" name="keywords" />
<meta content="en_US" property="og:locale" />
<meta content="Learn how to interpolate spatial data using python. Interpolation is the process of using locations with known, sampled values (of a phenomenon) to estimate the values at unknown, unsampled areas." lang="en" name="description" xml:lang="en" />
<meta content="python, spatial, interpolation, vector, shapefile" name="keywords" />
<meta content="en_US" property="og:locale" />
<meta content="spatial, raster, reproject, crs, landsat" name="keywords" />
<meta content="en_US" property="og:locale" />
<meta content="Learn how to reproject single and multi-band rasters using rasterio and geowombat. We demonstrate these using LandSat imagery as examples." lang="en" name="description" xml:lang="en" />
<meta content="Apprenez à reprojeter des rasters mono et multibande à l'aide de rasterio et de geowombat. Nous les démontrons en utilisant les images LandSat comme exemples." lang="fr" name="description" xml:lang="fr" />
<meta content="Aprenda a reproyectar rásteres de una o varias bandas mediante rasterio y geowombat. Demostramos esto usando imágenes de LandSat como ejemplos." lang="es" name="description" xml:lang="es" />
<meta content="spatial, raster, reproject, crs, landsat" name="keywords" />
<meta content="en_US" property="og:locale" />
<meta content="Learn how to resample single and multi-band rasters using rasterio and geowombat. This includes creating using a 'snap raster' as well as seperately matching extent and or resolution of another raster. We demonstrate these using LandSat imagery as examples." lang="en" name="description" xml:lang="en" />
<meta content="Apprenez à rééchantillonner des rasters mono et multicanaux à l'aide de rasterio et geowombat. Cela inclut la création à l'aide d'un « raster d'accrochage » ainsi que la correspondance séparée de l'étendue et/ou de la résolution d'un autre raster. Nous les démontrons en utilisant les images LandSat comme exemples." lang="fr" name="description" xml:lang="fr" />
<meta content="Aprenda a volver a muestrear rásteres de una o varias bandas mediante rasterio y geowombat. Esto incluye la creación mediante un 'ráster de ajuste', así como la extensión y / o resolución coincidentes por separado de otro ráster. Demostramos esto usando imágenes de LandSat como ejemplos." lang="es" name="description" xml:lang="es" />
<meta content="en_US" property="og:locale" />
<meta content="Learn how to perform mathematical operations on raster bands using rasterio." lang="en" name="description" xml:lang="en" />
<meta content="spatial, python, rasterio, raster, band, math" name="keywords" />
<meta content="en_US" property="og:locale" />
<meta content="Learn how to replace values in a raster using rasterio and GeoWombat." lang="en" name="description" xml:lang="en" />
<meta content="spatial, python, rasterio, raster, replace, interpolation" name="keywords" />
<meta content="en_US" property="og:locale" />
<meta content="Learn how to convert vector shapefiles into raster files using rasterio." lang="en" name="description" xml:lang="en" />
<meta content="spatial, python, rasterio, raster, vector, shapefile, rasterize" name="keywords" />
<meta content="en_US" property="og:locale" />
<meta content="Learn how to conduct moving window operations over rasters." lang="en" name="description" xml:lang="en" />
<meta content="spatial, python, rasterio, geowombat, raster, moving window, window operations, filter" name="keywords" />
<meta content="en_US" property="og:locale" />
<meta content="Learn how to access OpenStreetMap (OSM) roads, buildings, and other data via python. " lang="en" name="description" xml:lang="en" />
<meta content="Découvrez comment accéder aux routes, bâtiments et autres données OpenStreetMap (OSM) via python." lang="fr" name="description" xml:lang="fr" />
<meta content="Aprenda a acceder a carreteras, edificios y otros datos de OpenStreetMap (OSM) a través de Python." lang="es" name="description" xml:lang="es" />
<meta content="python open street map OSM" name="keywords" />
<meta content="en_US" property="og:locale" />
<meta content="Learn how to access US Census, and American Community Survey data via python. " lang="en" name="description" xml:lang="en" />
<meta content="Découvrez comment accéder aux données du recensement américain et de l'enquête communautaire américaine via python." lang="fr" name="description" xml:lang="fr" />
<meta content="Aprenda a acceder a los datos del Censo de EE. UU. Y de la Encuesta sobre la comunidad estadounidense a través de Python." lang="es" name="description" xml:lang="es" />
<meta content="python, spatial, census, american community survey, ACS" name="keywords" />
<meta content="en_US" property="og:locale" />
<meta content="Learn how to easily read and write remote sensing data from a variety of sensors, mosaic images, or create time series stacks." lang="en" name="description" xml:lang="en" />
<meta content="Apprenez à lire et à écrire facilement des données de télédétection à partir d'une variété de capteurs, d'images mosaïques ou de créer des piles de séries chronologiques" lang="fr" name="description" xml:lang="fr" />
<meta content="Aprenda a leer y escribir fácilmente datos de teledetección de una variedad de sensores, imágenes de mosaico o crear pilas de series de tiempo." lang="es" name="description" xml:lang="es" />
<meta content="spatial,raster, remote sensing, read, write, mosaic, time series, landsat, sentinel" name="keywords" />
<meta content="en_US" property="og:locale" />
<meta content="Learn how to easily read in remote sensing data from a variety of sensors including LandSat, Sentinel, PlanetScope, and QuickBird, do easy reprojection and snap raster operations on-the-fly, and resampling." lang="en" name="description" xml:lang="en" />
<meta content="Apprenez à lire facilement les données de télédétection à partir d'une variété de capteurs, y compris LandSat, Sentinel, PlanetScope et QuickBird, effectuez une reprojection facile et capturez des opérations raster à la volée, et rééchantillonnez." lang="fr" name="description" xml:lang="fr" />
<meta content="Aprenda a leer fácilmente los datos de teledetección de una variedad de sensores, incluidos LandSat, Sentinel, PlanetScope y QuickBird, realice operaciones de reproyección y captura de ráster sobre la marcha y remuestreo." lang="es" name="description" xml:lang="es" />
<meta content="spatial,raster, remote sensing, projection, resample, sentinel, landsat " name="keywords" />
<meta content="en_US" property="og:locale" />
<meta content="Learn how to calculate vegetation indices like EVI, NDVI, and Tasseled Cap from remotely sensed data using python" lang="en" name="description" xml:lang="en" />
<meta content="Apprenez à calculer les indices de végétation tels que EVI, NDVI et Tasseled Cap à partir de données détectées à distance à l'aide de python" lang="fr" name="description" xml:lang="fr" />
<meta content="Aprenda a calcular índices de vegetación como EVI, NDVI y Tasseled Cap a partir de datos de detección remota usando Python" lang="es" name="description" xml:lang="es" />
<meta content="Remote Sensing, EVI, NDVI, Tasseled Cap, Vegetation Index" name="keywords" />
<meta content="en_US" property="og:locale" />
<meta content="Learn how extract pixel values from raster data like sentinel imagery, additionally extract by row and column index, extract by bound window, extract by coordinate, extract by polygon." lang="en" name="description" xml:lang="en" />
<meta content="Découvrez comment extraire des valeurs de pixels à partir de données raster telles que l'imagerie sentinelle, extraire en outre par index de ligne et de colonne, extraire par fenêtre liée, extraire par coordonnées, extraire par polygone." lang="fr" name="description" xml:lang="fr" />
<meta content="Aprenda a extraer valores de píxeles de datos ráster como imágenes centinela, extraer adicionalmente por índice de fila y columna, extraer por ventana vinculada, extraer por coordenada, extraer por polígono." lang="es" name="description" xml:lang="es" />
<meta content="spatial,raster, extract by point, extract by polygon, extract by bounds, remote sensing" name="keywords" />
<meta content="en_US" property="og:locale" />
<meta content="Spatial classification and prediction models. Train and fit sklearn models on raster data including LandSat or other gridded data. " lang="en" name="description" xml:lang="en" />
<meta content="Classification spatiale et modèles de prédiction. Entraînez et adaptez des modèles sklearn sur des données raster, y compris LandSat ou d'autres données maillées." lang="fr" name="description" xml:lang="fr" />
<meta content="Modelos de clasificación y predicción espacial. Entrene y ajuste modelos sklearn en datos ráster, incluido LandSat u otros datos cuadriculados." lang="es" name="description" xml:lang="es" />
<meta content="sklearn, spatial,raster, remote sensing, time series, landsat, sentinel" name="keywords" />
<meta content="en_US" property="og:locale" />

    <title>Python Open Source Spatial Programming &amp; Remote Sensing</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=62ba249389abaaa9ffc34bf36a076bdc1d65ee18" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/tabs.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=f31d14ad54b65d19161ba51d4ffff3a77ae00456"></script>
    <script src="../_static/tabs.js"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="canonical" href="https://pygis.io/docs/a_intro.html" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
<script async="" src="https://www.google-analytics.com/analytics.js"></script>
<script>
                        window.ga = window.ga || function () {
                            (ga.q = ga.q || []).push(arguments) };
                        ga.l = +new Date;
                        ga('create', 'UA-192844775-1', 'auto');
                        ga('set', 'anonymizeIp', true);
                        ga('send', 'pageview');
                    </script>

  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint single-page" id="site-navigation">
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
    </div>
    <div class="header-article__right">
<div class="menu-dropdown menu-dropdown-launch-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Launch interactive content">
      <i class="fas fa-rocket"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://mybinder.org/v2/gh/mmann1123/pyGIS/main?urlpath=tree/./pygis/docs/a_intro.md"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Launch on Binder"
>
  

<span class="headerbtn__icon-container">
  
    <img src="../_static/images/logo_binder.svg">
  </span>
<span class="headerbtn__text-container">Binder</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>

<div class="menu-dropdown menu-dropdown-repository-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Source repositories">
      <i class="fab fa-github"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://github.com/mmann1123/pyGIS"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Source repository"
>
  

<span class="headerbtn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="headerbtn__text-container">repository</span>
</a>

      </li>
      
      <li>
        <a href="https://github.com/mmann1123/pyGIS/issues/new?title=Issue%20on%20page%20%2Fdocs/a_intro.html&body=Your%20issue%20content%20here."
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Open an issue"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="headerbtn__text-container">open issue</span>
</a>

      </li>
      
    </ul>
  </div>
</div>
<label for="__page-toc"
  class="headerbtn headerbtn-page-toc"
  
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-list"></i>
  </span>

</label>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
    <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list"></i> Contents
    </div>
    <nav id="bd-toc-nav" aria-label="Page">
        <p class="caption" role="heading">
 <span class="caption-text">
  0 - Get Started in Spatial Python
 </span>
</p>
<ul class="visible nav section-nav flex-column">
 <li class="toctree-l1 toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="docs/a_intro.html#document-docs/b_intro_py">
   Welcome - Let’s get started
  </a>
 </li>
 <li class="toctree-l1 toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="docs/a_intro.html#document-docs/b_about_py">
   Getting Started in Python
  </a>
 </li>
 <li class="toctree-l1 toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="docs/a_intro.html#document-docs/b_getting_started">
   Setting up a Normal Python Environment
  </a>
 </li>
 <li class="toctree-l1 toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="docs/a_intro.html#document-docs/b_conda_started">
   Setting up Python for Spatial on Mac, Windows, and Linux
  </a>
 </li>
 <li class="toctree-l1 toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="docs/a_intro.html#document-docs/b_python_by_example">
   An Introductory Example
  </a>
 </li>
 <li class="toctree-l1 toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="docs/a_intro.html#document-docs/b_learn_more">
   Learn More
  </a>
 </li>
</ul>
<p class="caption" role="heading">
 <span class="caption-text">
  1 - Spatial Data Types in Python
 </span>
</p>
<ul class="nav section-nav flex-column">
 <li class="toctree-l1 nav-item toc-entry">
  <a class="reference internal nav-link" href="docs/a_intro.html#document-docs/c_features">
   Spatial Data
  </a>
 </li>
 <li class="toctree-l1 nav-item toc-entry">
  <a class="reference internal nav-link" href="docs/a_intro.html#document-docs/c_store_features">
   Data Storage Formats
  </a>
 </li>
 <li class="toctree-l1 nav-item toc-entry">
  <a class="reference internal nav-link" href="docs/a_intro.html#document-docs/c_vectors">
   Spatial Vector Data
  </a>
 </li>
 <li class="toctree-l1 nav-item toc-entry">
  <a class="reference internal nav-link" href="docs/a_intro.html#document-docs/c_new_vectors">
   Spatial Points Lines Polygons in Python
  </a>
 </li>
 <li class="toctree-l1 nav-item toc-entry">
  <a class="reference internal nav-link" href="docs/a_intro.html#document-docs/c_rasters">
   Spatial Raster Data in Python
  </a>
 </li>
</ul>
<p class="caption" role="heading">
 <span class="caption-text">
  2 - Nature of Coordinate Systems in Python
 </span>
</p>
<ul class="nav section-nav flex-column">
 <li class="toctree-l1 nav-item toc-entry">
  <a class="reference internal nav-link" href="docs/a_intro.html#document-docs/d_crs_what_is_it">
   What is a CRS?
  </a>
 </li>
 <li class="toctree-l1 nav-item toc-entry">
  <a class="reference internal nav-link" href="docs/a_intro.html#document-docs/d_understand_crs_codes">
   Understanding a CRS: Proj4 and CRS codes
  </a>
 </li>
 <li class="toctree-l1 nav-item toc-entry">
  <a class="reference internal nav-link" href="docs/a_intro.html#document-docs/d_affine">
   Affine Transforms
  </a>
 </li>
 <li class="toctree-l1 nav-item toc-entry">
  <a class="reference internal nav-link" href="docs/a_intro.html#document-docs/d_vector_crs_intro">
   Vector Coordinate Reference Systems (CRS)
  </a>
 </li>
 <li class="toctree-l1 nav-item toc-entry">
  <a class="reference internal nav-link" href="docs/a_intro.html#document-docs/d_raster_crs_intro">
   Raster Coordinate Reference Systems (CRS)
  </a>
 </li>
</ul>
<p class="caption" role="heading">
 <span class="caption-text">
  3 - Vector Operations in Python
 </span>
</p>
<ul class="nav section-nav flex-column">
 <li class="toctree-l1 nav-item toc-entry">
  <a class="reference internal nav-link" href="docs/a_intro.html#document-docs/e_attributes">
   Attributes &amp; Indexing for Vector Data
  </a>
 </li>
 <li class="toctree-l1 nav-item toc-entry">
  <a class="reference internal nav-link" href="docs/a_intro.html#document-docs/e_buffer_neighbors">
   Proximity Analysis - Buffers, Nearest Neighbor
  </a>
 </li>
 <li class="toctree-l1 nav-item toc-entry">
  <a class="reference internal nav-link" href="docs/a_intro.html#document-docs/e_vector_merge_dissolve">
   Merge Data &amp; Dissolve Polygons
  </a>
 </li>
 <li class="toctree-l1 nav-item toc-entry">
  <a class="reference internal nav-link" href="docs/a_intro.html#document-docs/e_extraction">
   Extracting Spatial Data
  </a>
 </li>
 <li class="toctree-l1 nav-item toc-entry">
  <a class="reference internal nav-link" href="docs/a_intro.html#document-docs/e_vector_overlay">
   Spatial Overlays and Joins
  </a>
 </li>
 <li class="toctree-l1 nav-item toc-entry">
  <a class="reference internal nav-link" href="docs/a_intro.html#document-docs/e_spatial_joins">
   Spatial Joins
  </a>
 </li>
 <li class="toctree-l1 nav-item toc-entry">
  <a class="reference internal nav-link" href="docs/a_intro.html#document-docs/e_summarize_vector">
   Point Density Measures - Counts &amp; Kernel Density
  </a>
 </li>
 <li class="toctree-l1 nav-item toc-entry">
  <a class="reference internal nav-link" href="docs/a_intro.html#document-docs/e_interpolation">
   Spatial Interpolation
  </a>
 </li>
</ul>
<p class="caption" role="heading">
 <span class="caption-text">
  4 - Raster Operations in Python
 </span>
</p>
<ul class="nav section-nav flex-column">
 <li class="toctree-l1 nav-item toc-entry">
  <a class="reference internal nav-link" href="docs/a_intro.html#document-docs/e_new_rasters">
   Reading &amp; Writing Rasters with Rasterio
  </a>
 </li>
 <li class="toctree-l1 nav-item toc-entry">
  <a class="reference internal nav-link" href="docs/a_intro.html#document-docs/e_raster_reproject">
   Reproject Rasters w. Rasterio and Geowombat
  </a>
 </li>
 <li class="toctree-l1 nav-item toc-entry">
  <a class="reference internal nav-link" href="docs/a_intro.html#document-docs/e_raster_resample">
   Resampling &amp; Registering Rasters w. Rasterio and Geowombat
  </a>
 </li>
 <li class="toctree-l1 nav-item toc-entry">
  <a class="reference internal nav-link" href="docs/a_intro.html#document-docs/e_raster_math">
   Band Math w. Rasterio
  </a>
 </li>
 <li class="toctree-l1 nav-item toc-entry">
  <a class="reference internal nav-link" href="docs/a_intro.html#document-docs/e_raster_replace_values">
   Replacing Values w. Rasterio
  </a>
 </li>
 <li class="toctree-l1 nav-item toc-entry">
  <a class="reference internal nav-link" href="docs/a_intro.html#document-docs/e_raster_rasterize">
   Rasterize Vectors w. Rasterio
  </a>
 </li>
 <li class="toctree-l1 nav-item toc-entry">
  <a class="reference internal nav-link" href="docs/a_intro.html#document-docs/e_raster_window_operations">
   Window Operations with Rasterio and GeoWombat
  </a>
 </li>
</ul>
<p class="caption" role="heading">
 <span class="caption-text">
  5 - Accessing OSM &amp; Census Data in Python
 </span>
</p>
<ul class="nav section-nav flex-column">
 <li class="toctree-l1 nav-item toc-entry">
  <a class="reference internal nav-link" href="docs/a_intro.html#document-docs/d_access_osm">
   Accessing OSM Data in Python
  </a>
 </li>
 <li class="toctree-l1 nav-item toc-entry">
  <a class="reference internal nav-link" href="docs/a_intro.html#document-docs/d_access_census">
   Accessing Census and ACS Data in Python
  </a>
 </li>
</ul>
<p class="caption" role="heading">
 <span class="caption-text">
  6 - Remote Sensing in Python
 </span>
</p>
<ul class="nav section-nav flex-column">
 <li class="toctree-l1 nav-item toc-entry">
  <a class="reference internal nav-link" href="docs/a_intro.html#document-docs/f_rs_io">
   Reading/Writing Remote Sensed Images
  </a>
 </li>
 <li class="toctree-l1 nav-item toc-entry">
  <a class="reference internal nav-link" href="docs/a_intro.html#document-docs/f_rs_config">
   Configuration manager
  </a>
 </li>
 <li class="toctree-l1 nav-item toc-entry">
  <a class="reference internal nav-link" href="docs/a_intro.html#document-docs/f_rs_edit">
   Editing Rasters and Remotely Sensed Data
  </a>
 </li>
 <li class="toctree-l1 nav-item toc-entry">
  <a class="reference internal nav-link" href="docs/a_intro.html#document-docs/f_rs_plot">
   Plot Remote Sensed Images
  </a>
 </li>
 <li class="toctree-l1 nav-item toc-entry">
  <a class="reference internal nav-link" href="docs/a_intro.html#document-docs/f_rs_crs">
   Remote Sensing Coordinate Reference Systems
  </a>
 </li>
 <li class="toctree-l1 nav-item toc-entry">
  <a class="reference internal nav-link" href="docs/a_intro.html#document-docs/f_rs_mosaic">
   Handle Multiple Remotely Sensed Images
  </a>
 </li>
 <li class="toctree-l1 nav-item toc-entry">
  <a class="reference internal nav-link" href="docs/a_intro.html#document-docs/f_rs_band_math">
   Band Math &amp; Vegetation Indices
  </a>
 </li>
 <li class="toctree-l1 nav-item toc-entry">
  <a class="reference internal nav-link" href="docs/a_intro.html#document-docs/f_rs_extraction">
   Raster Data Extraction
  </a>
 </li>
 <li class="toctree-l1 nav-item toc-entry">
  <a class="reference internal nav-link" href="docs/a_intro.html#document-docs/f_rs_ml_predict">
   Spatial Prediction using ML in Python
  </a>
 </li>
</ul>

    </nav>
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>PyGIS - Open Source Spatial Programming & Remote Sensing</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <p class="caption" role="heading">
 <span class="caption-text">
  0 - Get Started in Spatial Python
 </span>
</p>
<ul class="visible nav section-nav flex-column">
 <li class="toctree-l1 toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="docs/a_intro.html#document-docs/b_intro_py">
   Welcome - Let’s get started
  </a>
 </li>
 <li class="toctree-l1 toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="docs/a_intro.html#document-docs/b_about_py">
   Getting Started in Python
  </a>
 </li>
 <li class="toctree-l1 toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="docs/a_intro.html#document-docs/b_getting_started">
   Setting up a Normal Python Environment
  </a>
 </li>
 <li class="toctree-l1 toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="docs/a_intro.html#document-docs/b_conda_started">
   Setting up Python for Spatial on Mac, Windows, and Linux
  </a>
 </li>
 <li class="toctree-l1 toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="docs/a_intro.html#document-docs/b_python_by_example">
   An Introductory Example
  </a>
 </li>
 <li class="toctree-l1 toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="docs/a_intro.html#document-docs/b_learn_more">
   Learn More
  </a>
 </li>
</ul>
<p class="caption" role="heading">
 <span class="caption-text">
  1 - Spatial Data Types in Python
 </span>
</p>
<ul class="nav section-nav flex-column">
 <li class="toctree-l1 nav-item toc-entry">
  <a class="reference internal nav-link" href="docs/a_intro.html#document-docs/c_features">
   Spatial Data
  </a>
 </li>
 <li class="toctree-l1 nav-item toc-entry">
  <a class="reference internal nav-link" href="docs/a_intro.html#document-docs/c_store_features">
   Data Storage Formats
  </a>
 </li>
 <li class="toctree-l1 nav-item toc-entry">
  <a class="reference internal nav-link" href="docs/a_intro.html#document-docs/c_vectors">
   Spatial Vector Data
  </a>
 </li>
 <li class="toctree-l1 nav-item toc-entry">
  <a class="reference internal nav-link" href="docs/a_intro.html#document-docs/c_new_vectors">
   Spatial Points Lines Polygons in Python
  </a>
 </li>
 <li class="toctree-l1 nav-item toc-entry">
  <a class="reference internal nav-link" href="docs/a_intro.html#document-docs/c_rasters">
   Spatial Raster Data in Python
  </a>
 </li>
</ul>
<p class="caption" role="heading">
 <span class="caption-text">
  2 - Nature of Coordinate Systems in Python
 </span>
</p>
<ul class="nav section-nav flex-column">
 <li class="toctree-l1 nav-item toc-entry">
  <a class="reference internal nav-link" href="docs/a_intro.html#document-docs/d_crs_what_is_it">
   What is a CRS?
  </a>
 </li>
 <li class="toctree-l1 nav-item toc-entry">
  <a class="reference internal nav-link" href="docs/a_intro.html#document-docs/d_understand_crs_codes">
   Understanding a CRS: Proj4 and CRS codes
  </a>
 </li>
 <li class="toctree-l1 nav-item toc-entry">
  <a class="reference internal nav-link" href="docs/a_intro.html#document-docs/d_affine">
   Affine Transforms
  </a>
 </li>
 <li class="toctree-l1 nav-item toc-entry">
  <a class="reference internal nav-link" href="docs/a_intro.html#document-docs/d_vector_crs_intro">
   Vector Coordinate Reference Systems (CRS)
  </a>
 </li>
 <li class="toctree-l1 nav-item toc-entry">
  <a class="reference internal nav-link" href="docs/a_intro.html#document-docs/d_raster_crs_intro">
   Raster Coordinate Reference Systems (CRS)
  </a>
 </li>
</ul>
<p class="caption" role="heading">
 <span class="caption-text">
  3 - Vector Operations in Python
 </span>
</p>
<ul class="nav section-nav flex-column">
 <li class="toctree-l1 nav-item toc-entry">
  <a class="reference internal nav-link" href="docs/a_intro.html#document-docs/e_attributes">
   Attributes &amp; Indexing for Vector Data
  </a>
 </li>
 <li class="toctree-l1 nav-item toc-entry">
  <a class="reference internal nav-link" href="docs/a_intro.html#document-docs/e_buffer_neighbors">
   Proximity Analysis - Buffers, Nearest Neighbor
  </a>
 </li>
 <li class="toctree-l1 nav-item toc-entry">
  <a class="reference internal nav-link" href="docs/a_intro.html#document-docs/e_vector_merge_dissolve">
   Merge Data &amp; Dissolve Polygons
  </a>
 </li>
 <li class="toctree-l1 nav-item toc-entry">
  <a class="reference internal nav-link" href="docs/a_intro.html#document-docs/e_extraction">
   Extracting Spatial Data
  </a>
 </li>
 <li class="toctree-l1 nav-item toc-entry">
  <a class="reference internal nav-link" href="docs/a_intro.html#document-docs/e_vector_overlay">
   Spatial Overlays and Joins
  </a>
 </li>
 <li class="toctree-l1 nav-item toc-entry">
  <a class="reference internal nav-link" href="docs/a_intro.html#document-docs/e_spatial_joins">
   Spatial Joins
  </a>
 </li>
 <li class="toctree-l1 nav-item toc-entry">
  <a class="reference internal nav-link" href="docs/a_intro.html#document-docs/e_summarize_vector">
   Point Density Measures - Counts &amp; Kernel Density
  </a>
 </li>
 <li class="toctree-l1 nav-item toc-entry">
  <a class="reference internal nav-link" href="docs/a_intro.html#document-docs/e_interpolation">
   Spatial Interpolation
  </a>
 </li>
</ul>
<p class="caption" role="heading">
 <span class="caption-text">
  4 - Raster Operations in Python
 </span>
</p>
<ul class="nav section-nav flex-column">
 <li class="toctree-l1 nav-item toc-entry">
  <a class="reference internal nav-link" href="docs/a_intro.html#document-docs/e_new_rasters">
   Reading &amp; Writing Rasters with Rasterio
  </a>
 </li>
 <li class="toctree-l1 nav-item toc-entry">
  <a class="reference internal nav-link" href="docs/a_intro.html#document-docs/e_raster_reproject">
   Reproject Rasters w. Rasterio and Geowombat
  </a>
 </li>
 <li class="toctree-l1 nav-item toc-entry">
  <a class="reference internal nav-link" href="docs/a_intro.html#document-docs/e_raster_resample">
   Resampling &amp; Registering Rasters w. Rasterio and Geowombat
  </a>
 </li>
 <li class="toctree-l1 nav-item toc-entry">
  <a class="reference internal nav-link" href="docs/a_intro.html#document-docs/e_raster_math">
   Band Math w. Rasterio
  </a>
 </li>
 <li class="toctree-l1 nav-item toc-entry">
  <a class="reference internal nav-link" href="docs/a_intro.html#document-docs/e_raster_replace_values">
   Replacing Values w. Rasterio
  </a>
 </li>
 <li class="toctree-l1 nav-item toc-entry">
  <a class="reference internal nav-link" href="docs/a_intro.html#document-docs/e_raster_rasterize">
   Rasterize Vectors w. Rasterio
  </a>
 </li>
 <li class="toctree-l1 nav-item toc-entry">
  <a class="reference internal nav-link" href="docs/a_intro.html#document-docs/e_raster_window_operations">
   Window Operations with Rasterio and GeoWombat
  </a>
 </li>
</ul>
<p class="caption" role="heading">
 <span class="caption-text">
  5 - Accessing OSM &amp; Census Data in Python
 </span>
</p>
<ul class="nav section-nav flex-column">
 <li class="toctree-l1 nav-item toc-entry">
  <a class="reference internal nav-link" href="docs/a_intro.html#document-docs/d_access_osm">
   Accessing OSM Data in Python
  </a>
 </li>
 <li class="toctree-l1 nav-item toc-entry">
  <a class="reference internal nav-link" href="docs/a_intro.html#document-docs/d_access_census">
   Accessing Census and ACS Data in Python
  </a>
 </li>
</ul>
<p class="caption" role="heading">
 <span class="caption-text">
  6 - Remote Sensing in Python
 </span>
</p>
<ul class="nav section-nav flex-column">
 <li class="toctree-l1 nav-item toc-entry">
  <a class="reference internal nav-link" href="docs/a_intro.html#document-docs/f_rs_io">
   Reading/Writing Remote Sensed Images
  </a>
 </li>
 <li class="toctree-l1 nav-item toc-entry">
  <a class="reference internal nav-link" href="docs/a_intro.html#document-docs/f_rs_config">
   Configuration manager
  </a>
 </li>
 <li class="toctree-l1 nav-item toc-entry">
  <a class="reference internal nav-link" href="docs/a_intro.html#document-docs/f_rs_edit">
   Editing Rasters and Remotely Sensed Data
  </a>
 </li>
 <li class="toctree-l1 nav-item toc-entry">
  <a class="reference internal nav-link" href="docs/a_intro.html#document-docs/f_rs_plot">
   Plot Remote Sensed Images
  </a>
 </li>
 <li class="toctree-l1 nav-item toc-entry">
  <a class="reference internal nav-link" href="docs/a_intro.html#document-docs/f_rs_crs">
   Remote Sensing Coordinate Reference Systems
  </a>
 </li>
 <li class="toctree-l1 nav-item toc-entry">
  <a class="reference internal nav-link" href="docs/a_intro.html#document-docs/f_rs_mosaic">
   Handle Multiple Remotely Sensed Images
  </a>
 </li>
 <li class="toctree-l1 nav-item toc-entry">
  <a class="reference internal nav-link" href="docs/a_intro.html#document-docs/f_rs_band_math">
   Band Math &amp; Vegetation Indices
  </a>
 </li>
 <li class="toctree-l1 nav-item toc-entry">
  <a class="reference internal nav-link" href="docs/a_intro.html#document-docs/f_rs_extraction">
   Raster Data Extraction
  </a>
 </li>
 <li class="toctree-l1 nav-item toc-entry">
  <a class="reference internal nav-link" href="docs/a_intro.html#document-docs/f_rs_ml_predict">
   Spatial Prediction using ML in Python
  </a>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <div class="tex2jax_ignore mathjax_ignore section" id="pygis-open-source-spatial-programming-remote-sensing">
<h1>PyGIS - Open Source Spatial Programming &amp; Remote Sensing<a class="headerlink" href="#pygis-open-source-spatial-programming-remote-sensing" title="Permalink to this headline">#</a></h1>
<p>The globe is now digital. Everything from monitoring deforestation, predicting wildfires, to training autonomous vehicles and tracking uprisings on social media requires you to understand how to leverage location data. This book will introduce you to the methods required for spatial programming. We focus on building your core programming techniques while helping you: leverage spatial data from OSM and the US Census, use satellite imagery, track land-use change, and track social distance during a pandemic, amongst others. We will leverage open source Python packages such as GeoPandas, Rasterio, Sklearn, and Geowombat to better understand our world and help predict its future. Some Python programming experience is required, however the material will be presented in a student-friendly manner and will focus on real-world application.</p>
<div class="toctree-wrapper compound">
<span id="document-docs/b_intro_py"></span><div class="tex2jax_ignore mathjax_ignore section" id="welcome-let-s-get-started">
<span id="b-intro-py"></span><h2>Welcome - Let’s get started<a class="headerlink" href="#welcome-let-s-get-started" title="Permalink to this headline">#</a></h2>
<p>This section will answer a few basic questions about python:</p>
<ul class="simple">
<li><p>What is python?</p></li>
<li><p>How do we use it?</p></li>
<li><p>How can we extend its functionality?</p></li>
</ul>
</div>
<span id="document-docs/b_about_py"></span><div class="tex2jax_ignore mathjax_ignore section" id="getting-started-in-python">
<span id="b-about-py"></span><h2>Getting Started in Python<a class="headerlink" href="#getting-started-in-python" title="Permalink to this headline">#</a></h2>
<blockquote>
<div><p>“Python has gotten sufficiently weapons grade that we don’t descend
into R anymore. Sorry, R people. I used to be one of you but we no
longer descend into R.” – Chris Wiggins</p>
</div></blockquote>
<div class="section" id="what-s-python">
<h3>What’s Python?<a class="headerlink" href="#what-s-python" title="Permalink to this headline">#</a></h3>
<p><a class="reference external" href="https://www.python.org">Python</a> is a general-purpose programming
language conceived in 1989 by Dutch programmer <a class="reference external" href="https://en.wikipedia.org/wiki/Guido_van_Rossum">Guido van
Rossum</a>.</p>
<p>Python is free and open source, with development coordinated through the
<a class="reference external" href="https://www.python.org/psf/">Python Software Foundation</a>.</p>
<p>Python has experienced rapid adoption in the last decade and is now one
of the most commonly used programming languages.</p>
<p>Popular textbooks on Python programming include <span id="id1">[]</span> and <span id="id2">[]</span>.</p>
<div class="section" id="common-uses">
<h4>Common Uses<a class="headerlink" href="#common-uses" title="Permalink to this headline">#</a></h4>
<p>Python is a general-purpose language used in almost all application domains
such as</p>
<ul class="simple">
<li><p>communications</p></li>
<li><p>web development</p></li>
<li><p>CGI and graphical user interfaces</p></li>
<li><p>game development</p></li>
<li><p>multimedia, data processing, security, etc., etc., etc.</p></li>
</ul>
<p>Python is beginner-friendly and routinely used to teach computer science and
programming in top computer science programs.</p>
<p>Python is particularly popular within the scientific and data science
communities.</p>
<p>It is steadily <a class="reference external" href="https://news.efinancialcareers.com/us-en/3002556/python-replaced-excel-banking">replacing familiar tools like
Excel</a>
in the fields of finance and banking.</p>
</div>
<div class="section" id="relative-popularity">
<h4>Relative Popularity<a class="headerlink" href="#relative-popularity" title="Permalink to this headline">#</a></h4>
<p>The following chart, produced using Stack Overflow Trends, shows one
measure of the relative popularity of Python</p>
<div class="figure align-default">
<a class="reference internal image-reference" href="../_images/python_vs_matlab.png"><img alt="../_images/python_vs_matlab.png" src="../_images/python_vs_matlab.png" style="width: 457.2px; height: 288.0px;" /></a>
</div>
<p>The figure indicates not only that Python is widely used but also that
adoption of Python has accelerated significantly since 2012.</p>
<p>This is driven at least in part by uptake in the scientific
domain, particularly in rapidly growing fields like data science.</p>
<p>For example, the popularity of <a class="reference external" href="http://pandas.pydata.org/">pandas</a>, a
library for data analysis with Python has exploded, as seen here.</p>
<p>(The corresponding time path for MATLAB is shown for comparison)</p>
<div class="figure align-default">
<a class="reference internal image-reference" href="../_images/pandas_vs_matlab.png"><img alt="../_images/pandas_vs_matlab.png" src="../_images/pandas_vs_matlab.png" style="width: 474.49px; height: 287.5px;" /></a>
</div>
<p>Note that pandas takes off in 2012, which is the same year that we see
Python’s popularity begin to spike in the first figure.</p>
<p>Overall, it’s clear that</p>
<ul class="simple">
<li><p>Python is <a class="reference external" href="http://spectrum.ieee.org/computing/software/the-2017-top-programming-languages">one of the most popular programming languages worldwide</a>.</p></li>
<li><p>Python is a major tool for scientific computing, accounting for a
rapidly rising share of scientific work around the globe.</p></li>
</ul>
</div>
<div class="section" id="features">
<h4>Features<a class="headerlink" href="#features" title="Permalink to this headline">#</a></h4>
<p>Python is a <a class="reference external" href="https://en.wikipedia.org/wiki/High-level_programming_language">high-level language</a>
suitable for rapid development.</p>
<p>It has a relatively small core language supported by many libraries.</p>
<p>Multiple programming styles are supported (procedural, object-oriented, functional, etc.)</p>
<p>Python is interpreted rather than compiled.</p>
</div>
<div class="section" id="syntax-and-design">
<h4>Syntax and Design<a class="headerlink" href="#syntax-and-design" title="Permalink to this headline">#</a></h4>
<p>One nice feature of Python is its elegant syntax — we’ll see many
examples later on.</p>
<p>Elegant code might sound superfluous but in fact it’s highly beneficial
because it makes the syntax easy to read and easy to remember.</p>
<p>Remembering how to read from files, sort dictionaries and other such
routine tasks means that you don’t need to break your flow in order to
hunt down correct syntax.</p>
<p>Closely related to elegant syntax is an elegant design.</p>
<p>Features like iterators, generators, decorators and list comprehensions
make Python highly expressive, allowing you to get more done with less
code.</p>
<p><a class="reference external" href="https://en.wikipedia.org/wiki/Namespace">Namespaces</a> improve
productivity by cutting down on bugs and syntax errors.</p>
</div>
</div>
<div class="section" id="scientific-programming">
<h3>Scientific Programming<a class="headerlink" href="#scientific-programming" title="Permalink to this headline">#</a></h3>
<p>Python has become one of the core languages of scientific computing.</p>
<p>It’s either the dominant player or a major player in</p>
<ul class="simple">
<li><p><a class="reference external" href="http://scikit-learn.org/stable/">machine learning and data science</a></p></li>
<li><p><a class="reference external" href="http://www.astropy.org/">astronomy</a></p></li>
<li><p><a class="reference external" href="https://wiki.python.org/moin/PythonForArtificialIntelligence">artificial intelligence</a></p></li>
<li><p><a class="reference external" href="http://chemlab.github.io/chemlab/">chemistry</a></p></li>
<li><p><a class="reference external" href="http://biopython.org/wiki/Main_Page">computational biology</a></p></li>
<li><p><a class="reference external" href="https://pypi.org/project/meteorology/">meteorology</a></p></li>
</ul>
<p>Its popularity in economics is also beginning to rise.</p>
</div>
<div class="section" id="bibliography">
<h3>Bibliography<a class="headerlink" href="#bibliography" title="Permalink to this headline">#</a></h3>
<span class="target" id="id3"></span></div>
</div>
<span id="document-docs/b_getting_started"></span><div class="tex2jax_ignore mathjax_ignore section" id="setting-up-a-normal-python-environment">
<span id="b-getting-started"></span><h2>Setting up a Normal Python Environment<a class="headerlink" href="#setting-up-a-normal-python-environment" title="Permalink to this headline">#</a></h2>
<div class="section" id="overview">
<h3>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">#</a></h3>
<p>In this lecture, you will learn how to</p>
<ol class="simple">
<li><p>get a Python environment up and running</p></li>
<li><p>execute simple Python commands</p></li>
<li><p>run a sample program</p></li>
<li><p>install the code libraries that underpin these lectures</p></li>
</ol>
</div>
<div class="section" id="anaconda">
<h3>Anaconda<a class="headerlink" href="#anaconda" title="Permalink to this headline">#</a></h3>
<p>The <a class="reference external" href="https://www.python.org/downloads/">core Python package</a> is easy to
install but <em>not</em> what you should choose for these lectures.</p>
<p>These lectures require the entire scientific programming ecosystem,
which</p>
<ul class="simple">
<li><p>the core installation doesn’t provide</p></li>
<li><p>is painful to install one piece at a time.</p></li>
</ul>
<p>Hence the best approach for our purposes is to install a Python
distribution that contains</p>
<ol class="simple">
<li><p>the core Python language <strong>and</strong></p></li>
<li><p>compatible versions of the most popular scientific libraries.</p></li>
</ol>
<p>The best such distribution is
<a class="reference external" href="https://www.anaconda.com/what-is-anaconda/">Anaconda</a>.</p>
<p>Anaconda is</p>
<ul class="simple">
<li><p>very popular</p></li>
<li><p>cross-platform</p></li>
<li><p>comprehensive</p></li>
<li><p>completely unrelated to the Nicki Minaj song of the same name</p></li>
</ul>
<p>Anaconda also comes with a great package management system to organize
your code libraries.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>All of what follows assumes that you adopt this recommendation!</p>
</div>
<div class="section" id="installing-anaconda">
<span id="install-anaconda"></span><h4>Installing Anaconda<a class="headerlink" href="#installing-anaconda" title="Permalink to this headline">#</a></h4>
<p>To install Anaconda, <a class="reference external" href="https://www.anaconda.com/download/">download</a> the
binary and follow the instructions.</p>
<p>Important points:</p>
<ul class="simple">
<li><p>Install the latest version!</p></li>
<li><p>If you are asked during the installation process whether you’d like
to make Anaconda your default Python installation, say yes.</p></li>
</ul>
</div>
<div class="section" id="updating-anaconda">
<h4>Updating Anaconda<a class="headerlink" href="#updating-anaconda" title="Permalink to this headline">#</a></h4>
<p>Anaconda supplies a tool called <code class="docutils literal notranslate"><span class="pre">conda</span></code> to manage and
upgrade your Anaconda packages.</p>
<p>One <code class="docutils literal notranslate"><span class="pre">conda</span></code> command you should execute regularly is the one
that updates the whole Anaconda distribution.</p>
<p>As a practice run, please execute the following</p>
<ol class="simple">
<li><p>Open up a terminal</p></li>
<li><p>Type <code class="docutils literal notranslate"><span class="pre">conda</span> <span class="pre">update</span> <span class="pre">anaconda</span></code></p></li>
</ol>
<p>For more information on <code class="docutils literal notranslate"><span class="pre">conda</span></code>, type <code class="docutils literal notranslate"><span class="pre">conda</span> <span class="pre">help</span></code> in a terminal.</p>
</div>
</div>
<div class="section" id="jupyter-notebooks">
<span id="ipython-notebook"></span><h3>Jupyter Notebooks<a class="headerlink" href="#jupyter-notebooks" title="Permalink to this headline">#</a></h3>
<p><a class="reference external" href="http://jupyter.org/">Jupyter</a> notebooks are one of the many possible
ways to interact with Python and the scientific libraries.</p>
<p>They use a <em>browser-based</em> interface to Python with</p>
<ul class="simple">
<li><p>The ability to write and execute Python commands.</p></li>
<li><p>Formatted output in the browser, including tables, figures,
animation, etc.</p></li>
<li><p>The option to mix in formatted text and mathematical expressions.</p></li>
</ul>
<p>Because of these features, Jupyter is now a major player in the
scientific computing ecosystem.</p>
<p><a class="reference internal" href="#jp-demo"><span class="std std-numref">Figure 1</span></a> shows the execution of some code (borrowed from
<a class="reference external" href="http://matplotlib.org/examples/pylab_examples/hexbin_demo.html">here</a>)
in a Jupyter notebook</p>
<div class="figure align-default" id="jp-demo">
<a class="reference internal image-reference" href="../_images/jp_demo.png"><img alt="../_images/jp_demo.png" src="../_images/jp_demo.png" style="width: 403.0px; height: 476.0px;" /></a>
<p class="caption"><span class="caption-number">Fig. 1 </span><span class="caption-text">A Jupyter notebook viewed in the browser</span><a class="headerlink" href="#jp-demo" title="Permalink to this image">#</a></p>
</div>
<p>While Jupyter isn’t the only way to code in Python, it’s great for
when you wish to</p>
<ul class="simple">
<li><p>get started</p></li>
<li><p>test new ideas or interact with small pieces of code</p></li>
<li><p>share scientific ideas with students or colleagues</p></li>
</ul>
<div class="section" id="starting-the-jupyter-notebook">
<h4>Starting the Jupyter Notebook<a class="headerlink" href="#starting-the-jupyter-notebook" title="Permalink to this headline">#</a></h4>
<p>Once you have installed Anaconda, you can start the Jupyter notebook.</p>
<p>Either</p>
<ul class="simple">
<li><p>search for Jupyter in your applications menu, or</p></li>
<li><p>open up a terminal and type <code class="docutils literal notranslate"><span class="pre">jupyter</span> <span class="pre">notebook</span></code></p>
<ul>
<li><p>Windows users should substitute “Anaconda command prompt” for “terminal” in the previous line.</p></li>
</ul>
</li>
</ul>
<p>If you use the second option, you will see something like this</p>
<div class="figure align-default">
<a class="reference internal image-reference" href="../_images/starting_nb.png"><img alt="../_images/starting_nb.png" src="../_images/starting_nb.png" style="width: 369.5px; height: 217.5px;" /></a>
</div>
<p>The output tells us the notebook is running at <code class="docutils literal notranslate"><span class="pre">http://localhost:8888/</span></code></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">localhost</span></code> is the name of the local machine</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">8888</span></code> refers to <a class="reference external" href="https://en.wikipedia.org/wiki/Port_%28computer_networking%29">port number</a>
8888 on your computer</p></li>
</ul>
<p>Thus, the Jupyter kernel is listening for Python commands on port 8888 of our
local machine.</p>
<p>Hopefully, your default browser has also opened up with a web page that
looks something like this</p>
<div class="figure align-default">
<a class="reference internal image-reference" href="../_images/nb.png"><img alt="../_images/nb.png" src="../_images/nb.png" style="width: 472.0px; height: 464.5px;" /></a>
</div>
<p>What you see here is called the Jupyter <em>dashboard</em>.</p>
<p>If you look at the URL at the top, it should be <code class="docutils literal notranslate"><span class="pre">localhost:8888</span></code> or
similar, matching the message above.</p>
<p>Assuming all this has worked OK, you can now click on <code class="docutils literal notranslate"><span class="pre">New</span></code> at the top
right and select <code class="docutils literal notranslate"><span class="pre">Python</span> <span class="pre">3</span></code> or similar.</p>
<p>Here’s what shows up on our machine:</p>
<div class="figure align-default">
<a class="reference internal image-reference" href="../_images/nb2.png"><img alt="../_images/nb2.png" src="../_images/nb2.png" style="width: 472.0px; height: 464.5px;" /></a>
</div>
<p>The notebook displays an <em>active cell</em>, into which you can type Python
commands.</p>
</div>
<div class="section" id="notebook-basics">
<h4>Notebook Basics<a class="headerlink" href="#notebook-basics" title="Permalink to this headline">#</a></h4>
<p>Let’s start with how to edit code and run simple programs.</p>
<div class="section" id="running-cells">
<h5>Running Cells<a class="headerlink" href="#running-cells" title="Permalink to this headline">#</a></h5>
<p>Notice that, in the previous figure, the cell is surrounded by a green
border.</p>
<p>This means that the cell is in <em>edit mode</em>.</p>
<p>In this mode, whatever you type will appear in the cell with the
flashing cursor.</p>
<p>When you’re ready to execute the code in a cell, hit <code class="docutils literal notranslate"><span class="pre">Shift-Enter</span></code>
instead of the usual <code class="docutils literal notranslate"><span class="pre">Enter</span></code>.</p>
<div class="figure align-default">
<a class="reference internal image-reference" href="../_images/nb3.png"><img alt="../_images/nb3.png" src="../_images/nb3.png" style="width: 472.0px; height: 443.0px;" /></a>
</div>
<p>(Note: There are also menu and button options for running code in a cell
that you can find by exploring)</p>
</div>
<div class="section" id="modal-editing">
<h5>Modal Editing<a class="headerlink" href="#modal-editing" title="Permalink to this headline">#</a></h5>
<p>The next thing to understand about the Jupyter notebook is that it uses
a <em>modal</em> editing system.</p>
<p>This means that the effect of typing at the keyboard <strong>depends on which
mode you are in</strong>.</p>
<p>The two modes are</p>
<ol class="simple">
<li><p>Edit mode</p>
<ul class="simple">
<li><p>Indicated by a green border around one cell, plus a blinking cursor</p></li>
<li><p>Whatever you type appears as is in that cell</p></li>
</ul>
</li>
<li><p>Command mode</p>
<ul class="simple">
<li><p>The green border is replaced by a grey (or grey and blue) border</p></li>
<li><p>Keystrokes are interpreted as commands — for example, typing <code class="docutils literal notranslate"><span class="pre">b</span></code> adds a new cell below the current one</p></li>
</ul>
</li>
</ol>
<p>To switch to</p>
<ul class="simple">
<li><p>command mode from edit mode, hit the <code class="docutils literal notranslate"><span class="pre">Esc</span></code> key or <code class="docutils literal notranslate"><span class="pre">Ctrl-M</span></code></p></li>
<li><p>edit mode from command mode, hit <code class="docutils literal notranslate"><span class="pre">Enter</span></code> or click in a cell</p></li>
</ul>
<p>The modal behavior of the Jupyter notebook is very efficient when you
get used to it.</p>
</div>
<div class="section" id="inserting-unicode-e-g-greek-letters">
<h5>Inserting Unicode (e.g., Greek Letters)<a class="headerlink" href="#inserting-unicode-e-g-greek-letters" title="Permalink to this headline">#</a></h5>
<p>Python supports <a class="reference external" href="https://docs.python.org/3/howto/unicode.html">unicode</a>,
allowing the use of characters such as <span class="math notranslate nohighlight">\(\alpha\)</span> and <span class="math notranslate nohighlight">\(\beta\)</span> as names in
your code.</p>
<p>In a code cell, try typing <code class="docutils literal notranslate"><span class="pre">\alpha</span></code> and then hitting the
<code class="docutils literal notranslate"><span class="pre">tab</span></code> key on your keyboard.</p>
</div>
<div class="section" id="a-test-program">
<span id="id1"></span><h5>A Test Program<a class="headerlink" href="#a-test-program" title="Permalink to this headline">#</a></h5>
<p>Let’s run a test program.</p>
<p>Here’s an arbitrary program we can use:
<a class="reference external" href="http://matplotlib.org/3.1.1/gallery/pie_and_polar_charts/polar_bar.html">http://matplotlib.org/3.1.1/gallery/pie_and_polar_charts/polar_bar.html</a>.</p>
<p>On that page, you’ll see the following code</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="o">%</span><span class="k">matplotlib</span> inline

<span class="c1"># Fixing random state for reproducibility</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">19680801</span><span class="p">)</span>

<span class="c1"># Compute pie slices</span>
<span class="n">N</span> <span class="o">=</span> <span class="mi">20</span>
<span class="n">θ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">radii</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
<span class="n">width</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
<span class="n">colors</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">viridis</span><span class="p">(</span><span class="n">radii</span> <span class="o">/</span> <span class="mf">10.</span><span class="p">)</span>

<span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="s1">&#39;polar&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">θ</span><span class="p">,</span> <span class="n">radii</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/b_getting_started_1_0.png" src="../_images/b_getting_started_1_0.png" />
</div>
</div>
<p>Don’t worry about the details for now — let’s just run it and see
what happens.</p>
<p>The easiest way to run this code is to copy and paste it into a cell in
the notebook.</p>
<p>Hopefully you will get a similar plot.</p>
</div>
</div>
<div class="section" id="working-with-the-notebook">
<h4>Working with the Notebook<a class="headerlink" href="#working-with-the-notebook" title="Permalink to this headline">#</a></h4>
<p>Here are a few more tips on working with Jupyter notebooks.</p>
<div class="section" id="tab-completion">
<h5>Tab Completion<a class="headerlink" href="#tab-completion" title="Permalink to this headline">#</a></h5>
<p>In the previous program, we executed the line <code class="docutils literal notranslate"><span class="pre">import</span> <span class="pre">numpy</span> <span class="pre">as</span> <span class="pre">np</span></code></p>
<ul class="simple">
<li><p>NumPy is a numerical library we’ll work with in depth.</p></li>
</ul>
<p>After this import command, functions in NumPy can be accessed with
<code class="docutils literal notranslate"><span class="pre">np.function_name</span></code> type syntax.</p>
<ul class="simple">
<li><p>For example, try <code class="docutils literal notranslate"><span class="pre">np.random.randn(3)</span></code>.</p></li>
</ul>
<p>We can explore these attributes of <code class="docutils literal notranslate"><span class="pre">np</span></code> using the <code class="docutils literal notranslate"><span class="pre">Tab</span></code> key.</p>
<p>For example, here we type <code class="docutils literal notranslate"><span class="pre">np.ran</span></code> and hit Tab</p>
<div class="figure align-default">
<a class="reference internal image-reference" href="../_images/nb6.png"><img alt="../_images/nb6.png" src="../_images/nb6.png" style="width: 472.0px; height: 464.5px;" /></a>
</div>
<p>Jupyter offers up the two possible completions, <code class="docutils literal notranslate"><span class="pre">random</span></code> and <code class="docutils literal notranslate"><span class="pre">rank</span></code>.</p>
<p>In this way, the Tab key helps remind you of what’s available and also
saves you typing.</p>
</div>
<div class="section" id="on-line-help">
<span id="gs-help"></span><h5>On-Line Help<a class="headerlink" href="#on-line-help" title="Permalink to this headline">#</a></h5>
<p>To get help on <code class="docutils literal notranslate"><span class="pre">np.rank</span></code>, say, we can execute <code class="docutils literal notranslate"><span class="pre">np.rank?</span></code>.</p>
<p>Documentation appears in a split window of the browser, like so</p>
<div class="figure align-default">
<a class="reference internal image-reference" href="../_images/nb6a.png"><img alt="../_images/nb6a.png" src="../_images/nb6a.png" style="width: 472.0px; height: 464.5px;" /></a>
</div>
<p>Clicking on the top right of the lower split closes the on-line help.</p>
</div>
<div class="section" id="other-content">
<h5>Other Content<a class="headerlink" href="#other-content" title="Permalink to this headline">#</a></h5>
<p>In addition to executing code, the Jupyter notebook allows you to embed
text, equations, figures and even videos in the page.</p>
<p>For example, here we enter a mixture of plain text and LaTeX instead of
code</p>
<div class="figure align-default">
<a class="reference internal image-reference" href="../_images/nb7.png"><img alt="../_images/nb7.png" src="../_images/nb7.png" style="width: 472.0px; height: 464.5px;" /></a>
</div>
<p>Next we <code class="docutils literal notranslate"><span class="pre">Esc</span></code> to enter command mode and then type <code class="docutils literal notranslate"><span class="pre">m</span></code> to indicate that
we are writing <a class="reference external" href="http://daringfireball.net/projects/markdown/">Markdown</a>,
a mark-up language similar to (but simpler than) LaTeX.</p>
<p>(You can also use your mouse to select <code class="docutils literal notranslate"><span class="pre">Markdown</span></code> from the <code class="docutils literal notranslate"><span class="pre">Code</span></code>
drop-down box just below the list of menu items)</p>
<p>Now we <code class="docutils literal notranslate"><span class="pre">Shift+Enter</span></code> to produce this</p>
<div class="figure align-default">
<a class="reference internal image-reference" href="../_images/nb8.png"><img alt="../_images/nb8.png" src="../_images/nb8.png" style="width: 472.0px; height: 464.5px;" /></a>
</div>
</div>
</div>
<div class="section" id="sharing-notebooks">
<h4>Sharing Notebooks<a class="headerlink" href="#sharing-notebooks" title="Permalink to this headline">#</a></h4>
<p>Notebook files are just text files structured in
<a class="reference external" href="https://en.wikipedia.org/wiki/JSON">JSON</a> and typically ending with
<code class="docutils literal notranslate"><span class="pre">.ipynb</span></code>.</p>
<p>You can share them in the usual way that you share files — or by
using web services such as <a class="reference external" href="http://nbviewer.jupyter.org/">nbviewer</a>.</p>
<p>The notebooks you see on that site are <strong>static</strong> html representations.</p>
<p>To run one, download it as an <code class="docutils literal notranslate"><span class="pre">ipynb</span></code> file by clicking on the download
icon.</p>
<p>Save it somewhere, navigate to it from the Jupyter dashboard and then
run as discussed above.</p>
</div>
</div>
</div>
<span id="document-docs/b_conda_started"></span><hr class="docutils" id="conda-started" />
<div class="admonition-learning-objectives admonition">
<p class="admonition-title">Learning Objectives</p>
<ul class="simple">
<li><p>Learn the basics of Docker</p></li>
<li><p>Pull, run, and update a container set up for spatial modeling</p></li>
</ul>
</div>
<div class="admonition-review admonition">
<p class="admonition-title">Review</p>
<ul class="simple">
<li><p><a class="reference internal" href="docs/a_intro.html#b-getting-started"><span class="std std-ref">A normal intro to python environments</span></a></p></li>
</ul>
</div>
<hr class="docutils" />
<div class="tex2jax_ignore mathjax_ignore section" id="setting-up-python-for-spatial-on-mac-windows-and-linux">
<h2>Setting up Python for Spatial on Mac, Windows, and Linux<a class="headerlink" href="#setting-up-python-for-spatial-on-mac-windows-and-linux" title="Permalink to this headline">#</a></h2>
<p>Spatial analysis requires a pretty broad set of python modules and with it, comes a lot of dependencies. And to be honest, the only thing Python doesn’t do well with, is dependencies. Luckily we have a few tricks up our sleeves to help you get to work fast.</p>
<div class="section" id="docker-for-spatial-python-gdal-included">
<h3>Docker for Spatial Python - GDAL Included<a class="headerlink" href="#docker-for-spatial-python-gdal-included" title="Permalink to this headline">#</a></h3>
<p>Docker allows us to essentially package and share operating systems with specific modifications. Importantly for us this includes libraries and dependencies that are difficult to install otherwise (I’m looking at you GDAL). Before we start you should familiarize yourself with the basic concepts behind Docker, please read the following: <a class="reference external" href="https://docs.microsoft.com/en-us/dotnet/architecture/microservices/container-docker-introduction/docker-defined">a simple intro to Docker concepts</a></p>
<p>To get this done we will be accessing <a class="reference external" href="https://hub.docker.com/">DockerHub</a>, which allows coders like us to store their Docker images. We will be downloading an image of the Linux operating system (Ubuntu, which is “debian-based”), that already has GDAL built for us. Once we “pull” a copy of the image of this operating system we will open it as “a container”. This “container” is a running instance of the “image” that we can run our applications on, and customize for our use case.  Read some more on <a class="reference external" href="https://docs.microsoft.com/en-us/dotnet/architecture/microservices/container-docker-introduction/docker-containers-images-registries">“images” vs “containers” etc here</a>.</p>
<div class="section" id="install-docker">
<h4>Install Docker<a class="headerlink" href="#install-docker" title="Permalink to this headline">#</a></h4>
<p>Follow the instructions for installing Docker on your system, take your time, and make sure you understand what you are doing before you do it!</p>
<div class="tab-set docutils">
<input checked="True" class="tab-input" id="tab-set--0-input--1" name="tab-set--0" type="radio"><label class="tab-label" for="tab-set--0-input--1">Mac</label><div class="tab-content docutils">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">docs</span><span class="o">.</span><span class="n">docker</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">desktop</span><span class="o">/</span><span class="n">mac</span><span class="o">/</span><span class="n">install</span><span class="o">/</span>
</pre></div>
</div>
</div>
<input class="tab-input" id="tab-set--0-input--2" name="tab-set--0" type="radio"><label class="tab-label" for="tab-set--0-input--2">Windows</label><div class="tab-content docutils">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">docs</span><span class="o">.</span><span class="n">docker</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">desktop</span><span class="o">/</span><span class="n">windows</span><span class="o">/</span><span class="n">install</span><span class="o">/</span>
</pre></div>
</div>
</div>
<input class="tab-input" id="tab-set--0-input--3" name="tab-set--0" type="radio"><label class="tab-label" for="tab-set--0-input--3">Linux</label><div class="tab-content docutils">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># click on your platform</span>
<span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">docs</span><span class="o">.</span><span class="n">docker</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">engine</span><span class="o">/</span><span class="n">install</span><span class="o">/</span><span class="c1">#server</span>
</pre></div>
</div>
</div>
</div>
<p>There are two ways we can do this, the <a class="reference internal" href="#theeasyway"><span class="std std-ref">easy way</span></a>, or the much more <a class="reference internal" href="#thedetailedway"><span class="std std-ref">detailed way</span></a>. Choose your poison.</p>
<hr class="docutils" />
</div>
</div>
<div class="section" id="the-easy-way">
<span id="theeasyway"></span><h3>The Easy Way<a class="headerlink" href="#the-easy-way" title="Permalink to this headline">#</a></h3>
<hr class="docutils" />
<div class="section" id="pulling-a-docker-image-ready-for-gis">
<h4>Pulling a Docker Image Ready for GIS<a class="headerlink" href="#pulling-a-docker-image-ready-for-gis" title="Permalink to this headline">#</a></h4>
<p>Now we are going to get an Ubuntu image running that already has everything installed and ready to use. We are going to pull the lastest build of our image from <a class="reference external" href="https://hub.docker.com/r/mmann1123/gw_pygis">my docker hub page</a>.</p>
<p>First open a <strong>terminal</strong> or <strong>powershell</strong> in windows… yes powershell not terminal, type the following:</p>
<div class="tab-set docutils">
<input checked="True" class="tab-input" id="tab-set--1-input--1" name="tab-set--1" type="radio"><label class="tab-label" for="tab-set--1-input--1">Mac</label><div class="tab-content docutils">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># download the image</span>
<span class="n">docker</span> <span class="n">pull</span> <span class="n">mmann1123</span><span class="o">/</span><span class="n">gw_pygis</span>

<span class="c1"># list your images </span>
<span class="n">docker</span> <span class="n">images</span> <span class="o">-</span><span class="n">a</span> 

<span class="c1"># you should see mmann1123/gw_pygis</span>
</pre></div>
</div>
</div>
<input class="tab-input" id="tab-set--1-input--2" name="tab-set--1" type="radio"><label class="tab-label" for="tab-set--1-input--2">Windows</label><div class="tab-content docutils">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># IN POWERSHELL TERMINAL </span>

<span class="c1"># download the image</span>
<span class="n">docker</span> <span class="n">pull</span> <span class="n">mmann1123</span><span class="o">/</span><span class="n">gw_pygis</span>

<span class="c1"># list your images </span>
<span class="n">docker</span> <span class="n">images</span> <span class="o">-</span><span class="n">a</span> 

<span class="c1"># you should see mmann1123/gw_pygis</span>
</pre></div>
</div>
</div>
<input class="tab-input" id="tab-set--1-input--3" name="tab-set--1" type="radio"><label class="tab-label" for="tab-set--1-input--3">Linux</label><div class="tab-content docutils">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># download the image</span>
<span class="n">docker</span> <span class="n">pull</span> <span class="n">mmann1123</span><span class="o">/</span><span class="n">gw_pygis</span>

<span class="c1"># list your images </span>
<span class="n">sudo</span> <span class="n">docker</span> <span class="n">images</span> <span class="o">-</span><span class="n">a</span> 

<span class="c1"># you should see mmann1123/gw_pygis</span>
</pre></div>
</div>
</div>
</div>
<p>Now we can access python through jupyter notebooks (<a class="reference external" href="https://coderefinery.github.io/jupyter/motivation/">read about jupyter notebooks here</a>). Jupyter is probably the easiest way to start your coding.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You can mount a volume from your normal operating system to your linux container using the <code class="docutils literal notranslate"><span class="pre">-v</span></code> option of <code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">run</span></code>. In the above case you can connect your <code class="docutils literal notranslate"><span class="pre">/Users/&lt;user_name&gt;/Documents</span></code> folder into the <code class="docutils literal notranslate"><span class="pre">/home</span></code> folder of your container by running <code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">run</span> <span class="pre">-v</span> <span class="pre">/Users/&lt;user_name&gt;/Documents:/home</span></code> (mac), <code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">run</span> <span class="pre">-v</span> <span class="pre">//c/User/&lt;user&gt;/Documents:/home</span></code> (windows), or <code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">run</span> <span class="pre">-v</span> <span class="pre">/home/&lt;user_name&gt;/Documents:/home</span></code> (linux). To access your documents folder from within you container just <code class="docutils literal notranslate"><span class="pre">cd</span></code> into it e.g. <code class="docutils literal notranslate"><span class="pre">cd</span> <span class="pre">/home</span></code>.</p>
</div>
<p>To do this we are going to attach a local volume with <code class="docutils literal notranslate"><span class="pre">-v</span></code>, open a port with <code class="docutils literal notranslate"><span class="pre">-p</span></code> and run mmann1123/gw_pygis, once inside of the runnning linux computer we will launch jupyter notebook and set an ip address to access it using <code class="docutils literal notranslate"><span class="pre">-ip</span></code>, and we will allow administrative privileges using <code class="docutils literal notranslate"><span class="pre">--allow-root</span></code>.  After executing the code we simply need to open up the URL displayed in response.</p>
<div class="tab-set docutils">
<input checked="True" class="tab-input" id="tab-set--2-input--1" name="tab-set--2" type="radio"><label class="tab-label" for="tab-set--2-input--1">Mac</label><div class="tab-content docutils">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Or if browser is  present</span>
<span class="n">docker</span> <span class="n">run</span> <span class="o">-</span><span class="n">v</span> <span class="o">/</span><span class="n">Users</span><span class="o">/&lt;</span><span class="n">user_name</span><span class="o">&gt;/</span><span class="n">path_to_folder_you_want_access_to</span><span class="p">:</span><span class="o">/</span><span class="n">home</span>  <span class="o">-</span><span class="n">it</span> <span class="o">-</span><span class="n">p</span> <span class="mi">8888</span><span class="p">:</span><span class="mi">8888</span> <span class="n">mmann1123</span><span class="o">/</span><span class="n">gw_pygis</span>
<span class="n">jupyter</span> <span class="n">notebook</span> <span class="o">--</span><span class="n">ip</span> <span class="mf">0.0.0.0</span>  <span class="o">--</span><span class="n">allow</span><span class="o">-</span><span class="n">root</span>

<span class="c1"># or if the jupyter notebooks doesn&#39;t launch automatically</span>
<span class="n">docker</span> <span class="n">run</span> <span class="o">-</span><span class="n">v</span> <span class="o">/</span><span class="n">Users</span><span class="o">/&lt;</span><span class="n">user_name</span><span class="o">&gt;/</span><span class="n">path_to_folder_you_want_access_to</span><span class="p">:</span><span class="o">/</span><span class="n">home</span>  <span class="o">-</span><span class="n">it</span> <span class="o">-</span><span class="n">p</span> <span class="mi">8888</span><span class="p">:</span><span class="mi">8888</span> <span class="n">mmann1123</span><span class="o">/</span><span class="n">gw_pygis</span>
<span class="n">jupyter</span> <span class="n">notebook</span> <span class="o">--</span><span class="n">ip</span> <span class="mf">0.0.0.0</span> <span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">browser</span> <span class="o">--</span><span class="n">allow</span><span class="o">-</span><span class="n">root</span>
<span class="c1"># THEN control click on URL printed to the bottom of terminal</span>
</pre></div>
</div>
</div>
<input class="tab-input" id="tab-set--2-input--2" name="tab-set--2" type="radio"><label class="tab-label" for="tab-set--2-input--2">Windows</label><div class="tab-content docutils">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Or if browser is  present</span>
<span class="n">docker</span> <span class="n">run</span> <span class="o">-</span><span class="n">v</span> <span class="o">//</span><span class="n">c</span><span class="o">/</span><span class="n">User</span><span class="o">/&lt;</span><span class="n">user_name</span><span class="o">&gt;/</span><span class="n">path_to_folder_you_want_access_to</span><span class="p">:</span><span class="o">/</span><span class="n">home</span>  <span class="o">-</span><span class="n">it</span> <span class="o">-</span><span class="n">p</span> <span class="mi">8888</span><span class="p">:</span><span class="mi">8888</span> <span class="n">mmann1123</span><span class="o">/</span><span class="n">gw_pygis</span>
<span class="n">jupyter</span> <span class="n">notebook</span> <span class="o">--</span><span class="n">ip</span> <span class="mf">0.0.0.0</span>  <span class="o">--</span><span class="n">allow</span><span class="o">-</span><span class="n">root</span>

<span class="c1"># or if the jupyter notebooks doesn&#39;t launch automatically</span>
<span class="n">docker</span> <span class="n">run</span> <span class="o">-</span><span class="n">v</span> <span class="o">//</span><span class="n">c</span><span class="o">/</span><span class="n">User</span><span class="o">/&lt;</span><span class="n">user_name</span><span class="o">&gt;/</span><span class="n">path_to_folder_you_want_access_to</span><span class="p">:</span><span class="o">/</span><span class="n">home</span>  <span class="o">-</span><span class="n">it</span> <span class="o">-</span><span class="n">p</span> <span class="mi">8888</span><span class="p">:</span><span class="mi">8888</span> <span class="n">mmann1123</span><span class="o">/</span><span class="n">gw_pygis</span>
<span class="n">jupyter</span> <span class="n">notebook</span> <span class="o">--</span><span class="n">ip</span> <span class="mf">0.0.0.0</span> <span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">browser</span> <span class="o">--</span><span class="n">allow</span><span class="o">-</span><span class="n">root</span>
<span class="c1"># THEN control click on URL printed to the bottom of terminal</span>
</pre></div>
</div>
</div>
<input class="tab-input" id="tab-set--2-input--3" name="tab-set--2" type="radio"><label class="tab-label" for="tab-set--2-input--3">Linux</label><div class="tab-content docutils">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Iff browser is  present</span>
<span class="n">sudo</span> <span class="n">docker</span> <span class="n">run</span> <span class="o">-</span><span class="n">v</span> <span class="o">/</span><span class="n">home</span><span class="o">/&lt;</span><span class="n">user_name</span><span class="o">&gt;/</span><span class="n">path_to_folder_you_want_access_to</span><span class="p">:</span><span class="o">/</span><span class="n">home</span>  <span class="o">-</span><span class="n">it</span> <span class="o">-</span><span class="n">p</span> <span class="mi">8888</span><span class="p">:</span><span class="mi">8888</span> <span class="n">mmann1123</span><span class="o">/</span><span class="n">gw_pygis</span>
<span class="n">jupyter</span> <span class="n">notebook</span> <span class="o">--</span><span class="n">ip</span> <span class="mf">0.0.0.0</span>  <span class="o">--</span><span class="n">allow</span><span class="o">-</span><span class="n">root</span>

<span class="c1"># or if the jupyter notebooks doesn&#39;t launch automatically</span>
<span class="n">sudo</span> <span class="n">docker</span> <span class="n">run</span> <span class="o">-</span><span class="n">v</span> <span class="o">/</span><span class="n">home</span><span class="o">/&lt;</span><span class="n">user_name</span><span class="o">&gt;/</span><span class="n">path_to_folder_you_want_access_to</span><span class="p">:</span><span class="o">/</span><span class="n">home</span>  <span class="o">-</span><span class="n">it</span> <span class="o">-</span><span class="n">p</span> <span class="mi">8888</span><span class="p">:</span><span class="mi">8888</span> <span class="n">mmann1123</span><span class="o">/</span><span class="n">gw_pygis</span>
<span class="n">jupyter</span> <span class="n">notebook</span> <span class="o">--</span><span class="n">ip</span> <span class="mf">0.0.0.0</span> <span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">browser</span> <span class="o">--</span><span class="n">allow</span><span class="o">-</span><span class="n">root</span>
<span class="c1"># THEN control click on URL printed to the bottom of terminal</span>
</pre></div>
</div>
</div>
</div>
<p>Every time you want to run pygis you are going to <code class="docutils literal notranslate"><span class="pre">run</span></code> the docker container called <code class="docutils literal notranslate"><span class="pre">mmann1123/gw_pygis</span></code>.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p><strong>When working in your container make sure to store all your data outside of the container!</strong> This is kind of like a school computer, where every time you log out, all the changes you made are deleted.</p>
<p>You can save your data in your linked volume which in these examples can be found by typing <code class="docutils literal notranslate"><span class="pre">cd</span> <span class="pre">/home/</span></code> while inside your container. The connected folder was defined with the <code class="docutils literal notranslate"><span class="pre">-v</span> <span class="pre">/home/&lt;user_name&gt;/path_to_folder_you_want_access_to:/home</span></code> option with docker run.</p>
</div>
<p>To make this a little easier you can create an executable script on your desktop to run it when you want.</p>
<div class="tab-set docutils">
<input checked="True" class="tab-input" id="tab-set--3-input--1" name="tab-set--3" type="radio"><label class="tab-label" for="tab-set--3-input--1">Mac Bash</label><div class="tab-content docutils">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># move to your desktop</span>
<span class="n">cd</span> <span class="o">~/</span><span class="n">Desktop</span><span class="o">/</span>

<span class="c1"># write a shell script called run_pygis</span>
<span class="c1"># between the &#39;&#39;s put whatever bash code you want</span>
<span class="n">echo</span> <span class="s1">&#39;</span>
<span class="n">sudo</span> <span class="n">docker</span> <span class="n">run</span> <span class="o">-</span><span class="n">v</span> <span class="o">/</span><span class="n">Users</span><span class="o">/&lt;</span><span class="n">user_name</span><span class="o">&gt;/</span><span class="n">path_to_folder_you_want_access_to</span><span class="p">:</span><span class="o">/</span><span class="n">home</span>  <span class="o">-</span><span class="n">it</span> <span class="o">-</span><span class="n">p</span> <span class="mi">8888</span><span class="p">:</span><span class="mi">8888</span> <span class="n">mmann1123</span><span class="o">/</span><span class="n">gw_pygis</span>
<span class="n">jupyter</span> <span class="n">notebook</span> <span class="o">--</span><span class="n">ip</span> <span class="mf">0.0.0.0</span>  <span class="o">--</span><span class="n">allow</span><span class="o">-</span><span class="n">root</span>
<span class="s1">&#39; &gt; run_pygis.sh</span>

<span class="c1"># allow it to be executable</span>
<span class="n">chmod</span> <span class="mi">755</span> <span class="n">run_pygis</span><span class="o">.</span><span class="n">sh</span>  
</pre></div>
</div>
</div>
<input class="tab-input" id="tab-set--3-input--2" name="tab-set--3" type="radio"><label class="tab-label" for="tab-set--3-input--2">Windows</label><div class="tab-content docutils">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Not sure yet!</span>
</pre></div>
</div>
</div>
<input class="tab-input" id="tab-set--3-input--3" name="tab-set--3" type="radio"><label class="tab-label" for="tab-set--3-input--3">Linux</label><div class="tab-content docutils">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># move to your desktop</span>
<span class="n">cd</span> <span class="o">~/</span><span class="n">Desktop</span><span class="o">/</span>

<span class="c1"># write a shell script called run_pygis</span>
<span class="c1"># between the &#39;&#39;s put whatever bash code you want</span>
<span class="n">echo</span> <span class="s1">&#39;</span>
<span class="n">sudo</span> <span class="n">docker</span> <span class="n">run</span> <span class="o">-</span><span class="n">v</span> <span class="o">/</span><span class="n">home</span><span class="o">/&lt;</span><span class="n">user_name</span><span class="o">&gt;/</span><span class="n">path_to_folder_you_want_access_to</span><span class="p">:</span><span class="o">/</span><span class="n">home</span>  <span class="o">-</span><span class="n">it</span> <span class="o">-</span><span class="n">p</span> <span class="mi">8888</span><span class="p">:</span><span class="mi">8888</span> <span class="n">mmann1123</span><span class="o">/</span><span class="n">gw_pygis</span>
<span class="n">jupyter</span> <span class="n">notebook</span> <span class="o">--</span><span class="n">ip</span> <span class="mf">0.0.0.0</span>  <span class="o">--</span><span class="n">allow</span><span class="o">-</span><span class="n">root</span>
<span class="s1">&#39; &gt; run_pygis.sh</span>

<span class="c1"># allow it to be executable</span>
<span class="n">chmod</span> <span class="o">+</span><span class="n">x</span> <span class="n">run_pygis</span><span class="o">.</span><span class="n">sh</span>  
</pre></div>
</div>
</div>
</div>
<p>Now that we have an executable file we need to execute this, on linux at least, the only one I can test on, we need to execute it from the command line. But its pretty easy.</p>
<p>To execute our run_geowombat.sh script we need to navigate to the Desktop in your local terminal, then execute the file:</p>
<div class="tab-set docutils">
<input checked="True" class="tab-input" id="tab-set--4-input--1" name="tab-set--4" type="radio"><label class="tab-label" for="tab-set--4-input--1">Mac Bash</label><div class="tab-content docutils">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># move to your desktop</span>
<span class="n">cd</span> <span class="o">~/</span><span class="n">Desktop</span><span class="o">/</span>

<span class="c1"># execute it</span>
<span class="o">./</span><span class="n">run_pygis</span><span class="o">.</span><span class="n">sh</span>
</pre></div>
</div>
</div>
<input class="tab-input" id="tab-set--4-input--2" name="tab-set--4" type="radio"><label class="tab-label" for="tab-set--4-input--2">Windows</label><div class="tab-content docutils">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Not sure yet!</span>
</pre></div>
</div>
</div>
<input class="tab-input" id="tab-set--4-input--3" name="tab-set--4" type="radio"><label class="tab-label" for="tab-set--4-input--3">Linux</label><div class="tab-content docutils">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># move to your desktop</span>
<span class="n">cd</span> <span class="o">~/</span><span class="n">Desktop</span><span class="o">/</span>

<span class="c1"># execute it</span>
<span class="o">./</span><span class="n">run_pygis</span><span class="o">.</span><span class="n">sh</span>
</pre></div>
</div>
</div>
</div>
<p>When you’re done with your work inside the container, and double checked that your data is saved locally - not on the container - you can type <code class="docutils literal notranslate"><span class="pre">exit</span></code> in the terminal window to exit your geowombat container.</p>
<hr class="docutils" />
</div>
</div>
<div class="section" id="the-more-detailed-way">
<span id="thedetailedway"></span><h3>The More Detailed Way<a class="headerlink" href="#the-more-detailed-way" title="Permalink to this headline">#</a></h3>
<hr class="docutils" />
<div class="section" id="pull-and-run-a-linux-image-with-gdal">
<h4>Pull and Run a Linux Image with GDAL<a class="headerlink" href="#pull-and-run-a-linux-image-with-gdal" title="Permalink to this headline">#</a></h4>
<p>Now we are going to get an Ubuntu image running that already has GDAL installed. We are going to pull the lastest build of our image from <a class="reference external" href="https://github.com/OSGeo/gdal/tree/master/gdal/docker">OSGEO’s docker hub page</a>.</p>
<p>First open a terminal or powershell, type the following:</p>
<div class="tab-set docutils">
<input checked="True" class="tab-input" id="tab-set--5-input--1" name="tab-set--5" type="radio"><label class="tab-label" for="tab-set--5-input--1">Mac</label><div class="tab-content docutils">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># download the image</span>
<span class="n">docker</span> <span class="n">pull</span> <span class="n">osgeo</span><span class="o">/</span><span class="n">gdal</span><span class="p">:</span><span class="n">ubuntu</span><span class="o">-</span><span class="n">full</span><span class="o">-</span><span class="n">latest</span>

<span class="c1"># list your images </span>
<span class="n">docker</span> <span class="n">images</span> <span class="o">-</span><span class="n">a</span> 

<span class="c1"># run osgeo/gdal image, but link my volume /your_folder_to_share_with_image:/location_on_container_to_access_it</span>
<span class="c1"># here I am linking my &lt;user_name&gt; home folder to the containers home folder</span>
<span class="c1"># important: update the &lt;user_name&gt; portion with your windows user name</span>
<span class="n">docker</span> <span class="n">run</span> <span class="o">-</span><span class="n">v</span> <span class="o">/</span><span class="n">Users</span><span class="o">/&lt;</span><span class="n">user_name</span><span class="o">&gt;/</span><span class="n">path_to_folder_you_want_access_to</span><span class="p">:</span><span class="o">/</span><span class="n">home</span>  <span class="o">-</span><span class="n">it</span> <span class="n">osgeo</span><span class="o">/</span><span class="n">gdal</span><span class="p">:</span><span class="n">ubuntu</span><span class="o">-</span><span class="n">full</span><span class="o">-</span><span class="n">latest</span>
</pre></div>
</div>
</div>
<input class="tab-input" id="tab-set--5-input--2" name="tab-set--5" type="radio"><label class="tab-label" for="tab-set--5-input--2">Windows</label><div class="tab-content docutils">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># download the image</span>
<span class="n">docker</span> <span class="n">pull</span> <span class="n">osgeo</span><span class="o">/</span><span class="n">gdal</span><span class="p">:</span><span class="n">ubuntu</span><span class="o">-</span><span class="n">full</span><span class="o">-</span><span class="n">latest</span>

<span class="c1"># list your images </span>
<span class="n">docker</span> <span class="n">images</span> <span class="o">-</span><span class="n">a</span> 

<span class="c1"># run osgeo/gdal image, but link my volume /your_folder_to_share_with_image:/location_on_container_to_access_it</span>
<span class="c1"># here I am linking my &lt;user_name&gt; home folder to the containers home folder</span>
<span class="c1"># important: update the &lt;user_name&gt; portion with your windows user name</span>
<span class="n">docker</span> <span class="n">run</span> <span class="o">-</span><span class="n">v</span> <span class="o">//</span><span class="n">c</span><span class="o">/</span><span class="n">User</span><span class="o">/</span><span class="n">Users</span><span class="o">/&lt;</span><span class="n">user_name</span><span class="o">&gt;/</span><span class="n">path_to_folder_you_want_access_to</span><span class="p">:</span><span class="o">/</span><span class="n">home</span>  <span class="o">-</span><span class="n">it</span> <span class="n">osgeo</span><span class="o">/</span><span class="n">gdal</span><span class="p">:</span><span class="n">ubuntu</span><span class="o">-</span><span class="n">full</span><span class="o">-</span><span class="n">latest</span>
</pre></div>
</div>
</div>
<input class="tab-input" id="tab-set--5-input--3" name="tab-set--5" type="radio"><label class="tab-label" for="tab-set--5-input--3">Linux</label><div class="tab-content docutils">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># download the image</span>
<span class="n">sudo</span> <span class="n">docker</span> <span class="n">pull</span> <span class="n">osgeo</span><span class="o">/</span><span class="n">gdal</span><span class="p">:</span><span class="n">ubuntu</span><span class="o">-</span><span class="n">full</span><span class="o">-</span><span class="n">latest</span>

<span class="c1"># list your images </span>
<span class="n">sudo</span> <span class="n">docker</span> <span class="n">images</span> <span class="o">-</span><span class="n">a</span> 

<span class="c1"># Run osgeo/gdal image, but link my volume /your_folder_to_share_with_image:/location_on_container_to_access_it</span>
<span class="c1"># here I am linking my home folder to the containers home folder</span>
<span class="n">sudo</span> <span class="n">docker</span> <span class="n">run</span> <span class="o">-</span><span class="n">v</span> <span class="o">/</span><span class="n">home</span><span class="o">/&lt;</span><span class="n">user_name</span><span class="o">&gt;/</span><span class="n">path_to_folder_you_want_access_to</span><span class="p">:</span><span class="o">/</span><span class="n">home</span>  <span class="o">-</span><span class="n">it</span> <span class="n">osgeo</span><span class="o">/</span><span class="n">gdal</span><span class="p">:</span><span class="n">ubuntu</span><span class="o">-</span><span class="n">full</span><span class="o">-</span><span class="n">latest</span>
</pre></div>
</div>
</div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You can mount a volume from your normal operating system to your linux container using the <code class="docutils literal notranslate"><span class="pre">-v</span></code> option of <code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">run</span></code>. In the above case you can connect your <code class="docutils literal notranslate"><span class="pre">C:/User/&lt;user&gt;/Documents</span></code> folder into the <code class="docutils literal notranslate"><span class="pre">/home</span></code> folder of your container by running <code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">run</span> <span class="pre">-v</span> <span class="pre">//c/User/&lt;user&gt;/Documents:/home</span></code>. To access your documents folder from within you container just <code class="docutils literal notranslate"><span class="pre">cd</span></code> into it e.g. <code class="docutils literal notranslate"><span class="pre">cd</span> <span class="pre">/home</span></code>.</p>
</div>
<p>Your command prompt in the terminal window should now say something funny like <code class="docutils literal notranslate"><span class="pre">root&#64;b0c5ab799195:/#</span> </code>. You are now INSIDE your running docker container, which is running Ubuntu linux.</p>
<p>Just to demonstrate this is really linux, let’s ask the system what OS is running:</p>
<div class="tab-set docutils">
<input checked="True" class="tab-input" id="tab-set--6-input--1" name="tab-set--6" type="radio"><label class="tab-label" for="tab-set--6-input--1">Linux Container</label><div class="tab-content docutils">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">uname</span>
</pre></div>
</div>
<p>Should return <code class="docutils literal notranslate"><span class="pre">Linux</span></code></p>
</div>
</div>
<p>We will need to update/upgrade the OS, install pip and a few other applications we need, pip install geowombat, and a few more python dependancies for it. We will then exit the container and save a named copy of it.</p>
<div class="tab-set docutils">
<input checked="True" class="tab-input" id="tab-set--7-input--1" name="tab-set--7" type="radio"><label class="tab-label" for="tab-set--7-input--1">Linux Container</label><div class="tab-content docutils">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># update Ubuntu</span>
<span class="n">apt</span> <span class="n">update</span> <span class="o">-</span><span class="n">y</span> 
<span class="n">apt</span> <span class="n">upgrade</span> <span class="o">-</span><span class="n">y</span>

<span class="c1"># install pip and a few other things </span>
<span class="n">apt</span> <span class="n">install</span> <span class="n">python3</span><span class="o">-</span><span class="n">pip</span> <span class="n">git</span> <span class="n">gdal</span><span class="o">-</span><span class="nb">bin</span> <span class="n">libgdal</span><span class="o">-</span><span class="n">dev</span> <span class="n">libspatialindex</span><span class="o">-</span><span class="n">dev</span>   <span class="o">-</span><span class="n">y</span> 

<span class="c1"># install geowombat and with it geopandas, rasterio etc</span>
<span class="n">pip</span> <span class="n">install</span> <span class="n">git</span><span class="o">+</span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">jgrss</span><span class="o">/</span><span class="n">geowombat</span>

<span class="c1"># install a few more dependancies for geowombat, including jupyter notebooks</span>
<span class="n">pip</span> <span class="n">install</span> <span class="n">cython</span> <span class="n">numpy</span> <span class="n">retry</span> <span class="n">requests</span> <span class="n">opencv</span><span class="o">-</span><span class="n">python</span> <span class="n">notebook</span>

<span class="c1">#test and exit - this should print the version of geowombat installed</span>
<span class="n">python</span> <span class="o">-</span><span class="n">c</span> <span class="s2">&quot;import geowombat as gw;print(gw.__version__)&quot;</span>

<span class="c1"># Install any other modules you want via pip</span>

</pre></div>
</div>
</div>
</div>
<p>Now we need to exit the container and go back to your local computer command line.</p>
<div class="tab-set docutils">
<input checked="True" class="tab-input" id="tab-set--8-input--1" name="tab-set--8" type="radio"><label class="tab-label" for="tab-set--8-input--1">Linux Container</label><div class="tab-content docutils">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">exit</span>
</pre></div>
</div>
</div>
</div>
<p>Note that we are now in your boring old terminal/shell, we exited Ubuntu.</p>
<p>We now need to create a named image that includes geowombat etc. Without doing this, the next time we start the osgeo/gdal image nothing will have been saved.</p>
<div class="tab-set docutils">
<input checked="True" class="tab-input" id="tab-set--9-input--1" name="tab-set--9" type="radio"><label class="tab-label" for="tab-set--9-input--1">Mac</label><div class="tab-content docutils">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># list all available containers</span>
<span class="n">docker</span> <span class="n">ps</span> <span class="o">-</span><span class="n">a</span>

<span class="c1"># find the &quot;CONTAINER ID&quot; of the container that was just exited seconds ago, </span>
<span class="c1"># and replace the example ID used below</span>

<span class="c1"># commit changes to new named image (replace 12 digit container id from one listed above)</span>
<span class="n">docker</span> <span class="n">commit</span> <span class="mi">9</span><span class="n">c3f33afcff9</span> <span class="n">pygis</span>

<span class="c1"># list all available images, look for pygis.</span>
<span class="n">docker</span> <span class="n">images</span>
</pre></div>
</div>
</div>
<input class="tab-input" id="tab-set--9-input--2" name="tab-set--9" type="radio"><label class="tab-label" for="tab-set--9-input--2">Windows</label><div class="tab-content docutils">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># list all available containers</span>
<span class="n">docker</span> <span class="n">ps</span> <span class="o">-</span><span class="n">a</span>

<span class="c1"># find the &quot;CONTAINER ID&quot; of the container that was just exited seconds ago, </span>
<span class="c1"># and replace the example ID used below</span>

<span class="c1"># commit changes to new named image</span>
<span class="n">docker</span> <span class="n">commit</span> <span class="mi">9</span><span class="n">c3f33afcff9</span> <span class="n">pygis</span>

<span class="c1"># list all available images, look for pygis.</span>
<span class="n">docker</span> <span class="n">images</span>
</pre></div>
</div>
</div>
<input class="tab-input" id="tab-set--9-input--3" name="tab-set--9" type="radio"><label class="tab-label" for="tab-set--9-input--3">Linux</label><div class="tab-content docutils">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span># list all available containers
sudo docker ps -a

# find the &quot;CONTAINER ID&quot; of the container that was just exited seconds ago, 
# and replace the example ID used below

# commit changes to new named image
sudo docker commit 9c3f33afcff9 pygis

# list all available images, look for pygis.
sudo docker images

# if you want to stop typing &quot;sudo&quot; before docker run the following, and log out of your computer
sudo usermod -aG docker $USER
</pre></div>
</div>
</div>
</div>
<p>Ok, now we are getting somewhere. We have created a new image called “pygis” that should have everything we need to get this done! Now the problem is how to access it?!</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Keep in mind if you want to make changes to the ‘pygis’ image you will need to first run it via the command line, make your changes, and then ‘commit’ or save another named version (ideally with a different name)</p>
</div>
</div>
<div class="section" id="access-your-spatial-python-image">
<h4>Access your spatial python image<a class="headerlink" href="#access-your-spatial-python-image" title="Permalink to this headline">#</a></h4>
<p>There are two ways to access this 1) through the command-line and 2) through Jupyter Notebooks.</p>
<p>Let’s start with command line only access. Note that this is almost exactly how we ran the osgeo/gdal image, except we replaced its name with geowombat. <em>Don’t forget to replace <code class="docutils literal notranslate"><span class="pre">&lt;user_name&gt;</span></code> with your user name!</em></p>
<div class="tab-set docutils">
<input checked="True" class="tab-input" id="tab-set--10-input--1" name="tab-set--10" type="radio"><label class="tab-label" for="tab-set--10-input--1">Mac</label><div class="tab-content docutils">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">docker</span> <span class="n">run</span> <span class="o">-</span><span class="n">v</span> <span class="o">/</span><span class="n">Users</span><span class="o">/&lt;</span><span class="n">user_name</span><span class="o">&gt;/</span><span class="n">path_to_folder_you_want_access_to</span><span class="p">:</span><span class="o">/</span><span class="n">home</span>  <span class="o">-</span><span class="n">it</span> <span class="n">pygis</span>
<span class="n">python</span>
</pre></div>
</div>
</div>
<input class="tab-input" id="tab-set--10-input--2" name="tab-set--10" type="radio"><label class="tab-label" for="tab-set--10-input--2">Windows</label><div class="tab-content docutils">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">docker</span> <span class="n">run</span> <span class="o">-</span><span class="n">v</span> <span class="o">//</span><span class="n">c</span><span class="o">/</span><span class="n">Users</span><span class="o">/&lt;</span><span class="n">user_name</span><span class="o">&gt;/</span><span class="n">path_to_folder_you_want_access_to</span><span class="p">:</span><span class="o">/</span><span class="n">home</span>  <span class="o">-</span><span class="n">it</span> <span class="n">pygis</span>
<span class="n">python</span>
</pre></div>
</div>
</div>
<input class="tab-input" id="tab-set--10-input--3" name="tab-set--10" type="radio"><label class="tab-label" for="tab-set--10-input--3">Linux</label><div class="tab-content docutils">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">docker</span> <span class="n">run</span> <span class="o">-</span><span class="n">v</span> <span class="o">/</span><span class="n">home</span><span class="o">/&lt;</span><span class="n">user_name</span><span class="o">&gt;/</span><span class="n">path_to_folder_you_want_access_to</span><span class="p">:</span><span class="o">/</span><span class="n">home</span>  <span class="o">-</span><span class="n">it</span> <span class="n">pygis</span>
<span class="n">python</span>
</pre></div>
</div>
</div>
</div>
<p>Now you are at the python command prompt, start coding!</p>
<p>Alternatively, we can access python through jupyter notebooks (<a class="reference external" href="https://coderefinery.github.io/jupyter/motivation/">read about jupyter notebooks here</a>). Jupyter is probably the easiest way to start your coding.</p>
<p>To do this we are going to</p>
<div class="tab-set docutils">
<input checked="True" class="tab-input" id="tab-set--11-input--1" name="tab-set--11" type="radio"><label class="tab-label" for="tab-set--11-input--1">Mac</label><div class="tab-content docutils">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Or if browser is  present</span>
<span class="n">docker</span> <span class="n">run</span> <span class="o">-</span><span class="n">v</span> <span class="o">/</span><span class="n">Users</span><span class="o">/&lt;</span><span class="n">user_name</span><span class="o">&gt;/</span><span class="n">path_to_folder_you_want_access_to</span><span class="p">:</span><span class="o">/</span><span class="n">home</span>  <span class="o">-</span><span class="n">it</span> <span class="o">-</span><span class="n">p</span> <span class="mi">8888</span><span class="p">:</span><span class="mi">8888</span> <span class="n">pygis</span>
<span class="n">jupyter</span> <span class="n">notebook</span> <span class="o">--</span><span class="n">ip</span> <span class="mf">0.0.0.0</span>  <span class="o">--</span><span class="n">allow</span><span class="o">-</span><span class="n">root</span>

<span class="c1"># or if the jupyter notebooks doesn&#39;t launch automatically</span>
<span class="n">docker</span> <span class="n">run</span> <span class="o">-</span><span class="n">v</span> <span class="o">/</span><span class="n">Users</span><span class="o">/&lt;</span><span class="n">user_name</span><span class="o">&gt;/</span><span class="n">path_to_folder_you_want_access_to</span><span class="p">:</span><span class="o">/</span><span class="n">home</span>  <span class="o">-</span><span class="n">it</span> <span class="o">-</span><span class="n">p</span> <span class="mi">8888</span><span class="p">:</span><span class="mi">8888</span> <span class="n">pygis</span>
<span class="n">jupyter</span> <span class="n">notebook</span> <span class="o">--</span><span class="n">ip</span> <span class="mf">0.0.0.0</span> <span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">browser</span> <span class="o">--</span><span class="n">allow</span><span class="o">-</span><span class="n">root</span>
<span class="c1"># THEN control click on URL printed to the bottom of terminal</span>
</pre></div>
</div>
</div>
<input class="tab-input" id="tab-set--11-input--2" name="tab-set--11" type="radio"><label class="tab-label" for="tab-set--11-input--2">Windows</label><div class="tab-content docutils">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Or if browser is  present</span>
<span class="n">docker</span> <span class="n">run</span> <span class="o">-</span><span class="n">v</span> <span class="o">//</span><span class="n">c</span><span class="o">/</span><span class="n">User</span><span class="o">/&lt;</span><span class="n">user_name</span><span class="o">&gt;/</span><span class="n">path_to_folder_you_want_access_to</span><span class="p">:</span><span class="o">/</span><span class="n">home</span>  <span class="o">-</span><span class="n">it</span> <span class="o">-</span><span class="n">p</span> <span class="mi">8888</span><span class="p">:</span><span class="mi">8888</span> <span class="n">pygis</span>
<span class="n">jupyter</span> <span class="n">notebook</span> <span class="o">--</span><span class="n">ip</span> <span class="mf">0.0.0.0</span>  <span class="o">--</span><span class="n">allow</span><span class="o">-</span><span class="n">root</span>

<span class="c1"># or if the jupyter notebooks doesn&#39;t launch automatically</span>
<span class="n">docker</span> <span class="n">run</span> <span class="o">-</span><span class="n">v</span> <span class="o">//</span><span class="n">c</span><span class="o">/</span><span class="n">User</span><span class="o">/&lt;</span><span class="n">user_name</span><span class="o">&gt;/</span><span class="n">path_to_folder_you_want_access_to</span><span class="p">:</span><span class="o">/</span><span class="n">home</span>  <span class="o">-</span><span class="n">it</span> <span class="o">-</span><span class="n">p</span> <span class="mi">8888</span><span class="p">:</span><span class="mi">8888</span> <span class="n">pygis</span>
<span class="n">jupyter</span> <span class="n">notebook</span> <span class="o">--</span><span class="n">ip</span> <span class="mf">0.0.0.0</span> <span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">browser</span> <span class="o">--</span><span class="n">allow</span><span class="o">-</span><span class="n">root</span>
<span class="c1"># THEN control click on URL printed to the bottom of terminal</span>
</pre></div>
</div>
</div>
<input class="tab-input" id="tab-set--11-input--3" name="tab-set--11" type="radio"><label class="tab-label" for="tab-set--11-input--3">Linux</label><div class="tab-content docutils">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Iff browser is  present</span>
<span class="n">sudo</span> <span class="n">docker</span> <span class="n">run</span> <span class="o">-</span><span class="n">v</span> <span class="o">/</span><span class="n">home</span><span class="o">/&lt;</span><span class="n">user_name</span><span class="o">&gt;/</span><span class="n">path_to_folder_you_want_access_to</span><span class="p">:</span><span class="o">/</span><span class="n">home</span>  <span class="o">-</span><span class="n">it</span> <span class="o">-</span><span class="n">p</span> <span class="mi">8888</span><span class="p">:</span><span class="mi">8888</span> <span class="n">pygis</span>
<span class="n">jupyter</span> <span class="n">notebook</span> <span class="o">--</span><span class="n">ip</span> <span class="mf">0.0.0.0</span>  <span class="o">--</span><span class="n">allow</span><span class="o">-</span><span class="n">root</span>

<span class="c1"># or if the jupyter notebooks doesn&#39;t launch automatically</span>
<span class="n">sudo</span> <span class="n">docker</span> <span class="n">run</span> <span class="o">-</span><span class="n">v</span> <span class="o">/</span><span class="n">home</span><span class="o">/&lt;</span><span class="n">user_name</span><span class="o">&gt;/</span><span class="n">path_to_folder_you_want_access_to</span><span class="p">:</span><span class="o">/</span><span class="n">home</span>  <span class="o">-</span><span class="n">it</span> <span class="o">-</span><span class="n">p</span> <span class="mi">8888</span><span class="p">:</span><span class="mi">8888</span> <span class="n">pygis</span>
<span class="n">jupyter</span> <span class="n">notebook</span> <span class="o">--</span><span class="n">ip</span> <span class="mf">0.0.0.0</span> <span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">browser</span> <span class="o">--</span><span class="n">allow</span><span class="o">-</span><span class="n">root</span>
<span class="c1"># THEN control click on URL printed to the bottom of terminal</span>
</pre></div>
</div>
</div>
</div>
<p>Every time you want to run pygis you are going to <code class="docutils literal notranslate"><span class="pre">run</span></code> the docker container called <code class="docutils literal notranslate"><span class="pre">pygis</span></code>.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p><strong>When working in your container make sure to store all your data outside of the container!</strong> This is kind of like a school computer, where every time you log out, all the changes you made are deleted.</p>
<p>You can save your data in your linked volume which in these examples can be found by typing <code class="docutils literal notranslate"><span class="pre">cd</span> <span class="pre">/home/</span></code> while inside your container. The connected folder was defined with the <code class="docutils literal notranslate"><span class="pre">-v</span> <span class="pre">/home/&lt;user_name&gt;/path_to_folder_you_want_access_to:/home</span></code> option with docker run.</p>
</div>
<p>To make this a little easier you can create an executable script on your desktop to run it when you want.</p>
<div class="tab-set docutils">
<input checked="True" class="tab-input" id="tab-set--12-input--1" name="tab-set--12" type="radio"><label class="tab-label" for="tab-set--12-input--1">Mac Bash</label><div class="tab-content docutils">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># move to your desktop</span>
<span class="n">cd</span> <span class="o">~/</span><span class="n">Desktop</span><span class="o">/</span>

<span class="c1"># write a shell script called run_pygis</span>
<span class="c1"># between the &#39;&#39;s put whatever bash code you want</span>
<span class="n">echo</span> <span class="s1">&#39;</span>
<span class="n">docker</span> <span class="n">run</span> <span class="o">-</span><span class="n">v</span> <span class="o">/</span><span class="n">Users</span><span class="o">/&lt;</span><span class="n">user_name</span><span class="o">&gt;/</span><span class="n">path_to_folder_you_want_access_to</span><span class="p">:</span><span class="o">/</span><span class="n">home</span>  <span class="o">-</span><span class="n">it</span> <span class="o">-</span><span class="n">p</span> <span class="mi">8888</span><span class="p">:</span><span class="mi">8888</span> <span class="n">pygis</span>
<span class="n">jupyter</span> <span class="n">notebook</span> <span class="o">--</span><span class="n">ip</span> <span class="mf">0.0.0.0</span>  <span class="o">--</span><span class="n">allow</span><span class="o">-</span><span class="n">root</span>
<span class="s1">&#39; &gt; run_pygis.sh</span>

<span class="c1"># allow it to be executable</span>
<span class="n">chmod</span> <span class="mi">755</span> <span class="n">run_pygis</span><span class="o">.</span><span class="n">sh</span>  
</pre></div>
</div>
</div>
<input class="tab-input" id="tab-set--12-input--2" name="tab-set--12" type="radio"><label class="tab-label" for="tab-set--12-input--2">Windows</label><div class="tab-content docutils">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Not sure yet!</span>
</pre></div>
</div>
</div>
<input class="tab-input" id="tab-set--12-input--3" name="tab-set--12" type="radio"><label class="tab-label" for="tab-set--12-input--3">Linux</label><div class="tab-content docutils">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># move to your desktop</span>
<span class="n">cd</span> <span class="o">~/</span><span class="n">Desktop</span><span class="o">/</span>

<span class="c1"># write a shell script called run_pygis</span>
<span class="c1"># between the &#39;&#39;s put whatever bash code you want</span>
<span class="n">echo</span> <span class="s1">&#39;</span>
<span class="n">docker</span> <span class="n">run</span> <span class="o">-</span><span class="n">v</span> <span class="o">/</span><span class="n">home</span><span class="o">/&lt;</span><span class="n">user_name</span><span class="o">&gt;/</span><span class="n">path_to_folder_you_want_access_to</span><span class="p">:</span><span class="o">/</span><span class="n">home</span>  <span class="o">-</span><span class="n">it</span> <span class="o">-</span><span class="n">p</span> <span class="mi">8888</span><span class="p">:</span><span class="mi">8888</span> <span class="n">pygis</span>
<span class="n">jupyter</span> <span class="n">notebook</span> <span class="o">--</span><span class="n">ip</span> <span class="mf">0.0.0.0</span>  <span class="o">--</span><span class="n">allow</span><span class="o">-</span><span class="n">root</span>
<span class="s1">&#39; &gt; run_pygis.sh</span>

<span class="c1"># allow it to be executable</span>
<span class="n">chmod</span> <span class="o">+</span><span class="n">x</span> <span class="n">run_pygis</span><span class="o">.</span><span class="n">sh</span>  
</pre></div>
</div>
</div>
</div>
<p>Now that we have an executable file we need to execute this, on linux at least, the only one I can test on, we need to execute it from the command line. But its pretty easy.</p>
<p>To execute our run_geowombat.sh script we need to navigate to the Desktop, then execute the file:</p>
<div class="tab-set docutils">
<input checked="True" class="tab-input" id="tab-set--13-input--1" name="tab-set--13" type="radio"><label class="tab-label" for="tab-set--13-input--1">Mac Bash</label><div class="tab-content docutils">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># move to your desktop</span>
<span class="n">cd</span> <span class="o">~/</span><span class="n">Desktop</span><span class="o">/</span>

<span class="c1"># execute it</span>
<span class="o">./</span><span class="n">run_pygis</span><span class="o">.</span><span class="n">sh</span>
</pre></div>
</div>
</div>
<input class="tab-input" id="tab-set--13-input--2" name="tab-set--13" type="radio"><label class="tab-label" for="tab-set--13-input--2">Windows</label><div class="tab-content docutils">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Not sure yet!</span>
</pre></div>
</div>
</div>
<input class="tab-input" id="tab-set--13-input--3" name="tab-set--13" type="radio"><label class="tab-label" for="tab-set--13-input--3">Linux</label><div class="tab-content docutils">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># move to your desktop</span>
<span class="n">cd</span> <span class="o">~/</span><span class="n">Desktop</span><span class="o">/</span>

<span class="c1"># execute it</span>
<span class="o">./</span><span class="n">run_pygis</span><span class="o">.</span><span class="n">sh</span>
</pre></div>
</div>
</div>
</div>
<p>When you’re done with your work inside the container, and double checked that your data is saved locally - not on the container - you can type <code class="docutils literal notranslate"><span class="pre">exit</span></code> in the terminal window to exit your geowombat container.</p>
</div>
</div>
</div>
<span id="document-docs/b_python_by_example"></span><div class="tex2jax_ignore mathjax_ignore section" id="an-introductory-example">
<span id="python-by-example"></span><h2>An Introductory Example<a class="headerlink" href="#an-introductory-example" title="Permalink to this headline">#</a></h2>
<div class="section" id="overview">
<h3>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">#</a></h3>
<p>We’re now ready to start learning the Python language itself.</p>
<p>In this lecture, we will write and then pick apart small Python
programs.</p>
<p>The objective is to introduce you to basic Python syntax and data
structures.</p>
<p>Deeper concepts will be covered in later lectures.</p>
<p>You should have read the <span class="xref std std-ref">lecture</span> on getting started with Python before beginning this one.</p>
</div>
<div class="section" id="the-task-plotting-a-white-noise-process">
<h3>The Task: Plotting a White Noise Process<a class="headerlink" href="#the-task-plotting-a-white-noise-process" title="Permalink to this headline">#</a></h3>
<p>Suppose we want to simulate and plot the white noise process
<span class="math notranslate nohighlight">\(\epsilon_0, \epsilon_1, \ldots, \epsilon_T\)</span>, where each draw
<span class="math notranslate nohighlight">\(\epsilon_t\)</span> is independent standard normal.</p>
<p>In other words, we want to generate figures that look something like
this:</p>
<div class="figure align-default">
<img alt="../_images/test_program_1_updated.png" src="../_images/test_program_1_updated.png" />
</div>
<p>(Here <span class="math notranslate nohighlight">\(t\)</span> is on the horizontal axis and <span class="math notranslate nohighlight">\(\epsilon_t\)</span> is on the vertical
axis.)</p>
<p>We’ll do this in several different ways, each time learning something
more about Python.</p>
<p>We run the following command first, which helps ensure that plots appear
in the notebook if you run it on your own machine.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">matplotlib</span> inline
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="version-1">
<h3>Version 1<a class="headerlink" href="#version-1" title="Permalink to this headline">#</a></h3>
<p id="ourfirstprog">Here are a few lines of code that perform the task we set</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="n">ϵ_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ϵ_values</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/b_python_by_example_3_0.png" src="../_images/b_python_by_example_3_0.png" />
</div>
</div>
<p>Let’s break this program down and see how it works.</p>
<div class="section" id="imports">
<span id="import"></span><h4>Imports<a class="headerlink" href="#imports" title="Permalink to this headline">#</a></h4>
<p>The first two lines of the program import functionality from external
code libraries.</p>
<p>The first line imports NumPy, a
favorite Python package for tasks like</p>
<ul class="simple">
<li><p>working with arrays (vectors and matrices)</p></li>
<li><p>common mathematical functions like <code class="docutils literal notranslate"><span class="pre">cos</span></code> and <code class="docutils literal notranslate"><span class="pre">sqrt</span></code></p></li>
<li><p>generating random numbers</p></li>
<li><p>linear algebra, etc.</p></li>
</ul>
<p>After <code class="docutils literal notranslate"><span class="pre">import</span> <span class="pre">numpy</span> <span class="pre">as</span> <span class="pre">np</span></code> we have access to these attributes via the
syntax <code class="docutils literal notranslate"><span class="pre">np.attribute</span></code>.</p>
<p>Here’s two more examples</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2.0
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.3862943611198906
</pre></div>
</div>
</div>
</div>
<p>We could also use the following syntax:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span>

<span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2.0
</pre></div>
</div>
</div>
</div>
<p>But the former method (using the short name <code class="docutils literal notranslate"><span class="pre">np</span></code>) is convenient and more
standard.</p>
<div class="section" id="why-so-many-imports">
<h5>Why So Many Imports?<a class="headerlink" href="#why-so-many-imports" title="Permalink to this headline">#</a></h5>
<p>Python programs typically require several import statements.</p>
<p>The reason is that the core language is deliberately kept small, so that
it’s easy to learn and maintain.</p>
<p>When you want to do something interesting with Python, you almost always
need to import additional functionality.</p>
</div>
<div class="section" id="packages">
<h5>Packages<a class="headerlink" href="#packages" title="Permalink to this headline">#</a></h5>
<p>As stated above, NumPy is a Python <em>package</em>.</p>
<p>Packages are used by developers to organize code they wish to share.</p>
<p>In fact, a package is just a directory containing</p>
<ol class="simple">
<li><p>files with Python code — called <strong>modules</strong> in Python speak</p></li>
<li><p>possibly some compiled code that can be accessed by Python (e.g.,
functions compiled from C or FORTRAN code)</p></li>
<li><p>a file called <code class="docutils literal notranslate"><span class="pre">__init__.py</span></code> that specifies what will be executed
when we type <code class="docutils literal notranslate"><span class="pre">import</span> <span class="pre">package_name</span></code></p></li>
</ol>
<p>In fact, you can find and explore the directory for NumPy on your
computer easily enough if you look around.</p>
<p>On this machine, it’s located in</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>anaconda3/lib/python3.7/site-packages/numpy
</pre></div>
</div>
</div>
<div class="section" id="subpackages">
<h5>Subpackages<a class="headerlink" href="#subpackages" title="Permalink to this headline">#</a></h5>
<p>Consider the line <code class="docutils literal notranslate"><span class="pre">ϵ_values</span> <span class="pre">=</span> <span class="pre">np.random.randn(100)</span></code>.</p>
<p>Here <code class="docutils literal notranslate"><span class="pre">np</span></code> refers to the package NumPy, while <code class="docutils literal notranslate"><span class="pre">random</span></code> is a
<strong>subpackage</strong> of NumPy.</p>
<p>Subpackages are just packages that are subdirectories of another
package.</p>
</div>
</div>
<div class="section" id="importing-names-directly">
<h4>Importing Names Directly<a class="headerlink" href="#importing-names-directly" title="Permalink to this headline">#</a></h4>
<p>Recall this code that we saw above</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2.0
</pre></div>
</div>
</div>
</div>
<p>Here’s another way to access NumPy’s square root function</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">sqrt</span>

<span class="n">sqrt</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2.0
</pre></div>
</div>
</div>
</div>
<p>This is also fine.</p>
<p>The advantage is less typing if we use <code class="docutils literal notranslate"><span class="pre">sqrt</span></code> often in our code.</p>
<p>The disadvantage is that, in a long program, these two lines might be
separated by many other lines.</p>
<p>Then it’s harder for readers to know where <code class="docutils literal notranslate"><span class="pre">sqrt</span></code> came from, should
they wish to.</p>
</div>
<div class="section" id="random-draws">
<h4>Random Draws<a class="headerlink" href="#random-draws" title="Permalink to this headline">#</a></h4>
<p>Returning to our program that plots white noise, the remaining three
lines after the import statements are</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ϵ_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ϵ_values</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/b_python_by_example_14_0.png" src="../_images/b_python_by_example_14_0.png" />
</div>
</div>
<p>The first line generates 100 (quasi) independent standard normals and
stores them in <code class="docutils literal notranslate"><span class="pre">ϵ_values</span></code>.</p>
<p>The next two lines genererate the plot.</p>
<p>We can and will look at various ways to configure and improve this plot
below.</p>
</div>
</div>
<div class="section" id="alternative-implementations">
<h3>Alternative Implementations<a class="headerlink" href="#alternative-implementations" title="Permalink to this headline">#</a></h3>
<p>Let’s try writing some alternative versions of
<a class="reference internal" href="#ourfirstprog"><span class="std std-ref">our first program</span></a>, which
plotted IID draws from the normal distribution.</p>
<p>The programs below are less efficient than the original one, and hence
somewhat artificial.</p>
<p>But they do help us illustrate some important Python syntax and
semantics in a familiar setting.</p>
<div class="section" id="a-version-with-a-for-loop">
<h4>A Version with a For Loop<a class="headerlink" href="#a-version-with-a-for-loop" title="Permalink to this headline">#</a></h4>
<p>Here’s a version that illustrates <code class="docutils literal notranslate"><span class="pre">for</span></code> loops and Python lists.</p>
<div class="cell docutils container" id="firstloopprog">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ts_length</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">ϵ_values</span> <span class="o">=</span> <span class="p">[]</span>   <span class="c1"># empty list</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ts_length</span><span class="p">):</span>
    <span class="n">e</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">()</span>
    <span class="n">ϵ_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ϵ_values</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/b_python_by_example_16_0.png" src="../_images/b_python_by_example_16_0.png" />
</div>
</div>
<p>In brief,</p>
<ul class="simple">
<li><p>The first line sets the desired length of the time series.</p></li>
<li><p>The next line creates an empty <em>list</em> called <code class="docutils literal notranslate"><span class="pre">ϵ_values</span></code> that will
store the <span class="math notranslate nohighlight">\(\epsilon_t\)</span> values as we generate them.</p></li>
<li><p>The statement <code class="docutils literal notranslate"><span class="pre">#</span> <span class="pre">empty</span> <span class="pre">list</span></code> is a <em>comment</em>, and is ignored by
Python’s interpreter.</p></li>
<li><p>The next three lines are the <code class="docutils literal notranslate"><span class="pre">for</span></code> loop, which repeatedly draws a
new random number <span class="math notranslate nohighlight">\(\epsilon_t\)</span> and appends it to the end of the list
<code class="docutils literal notranslate"><span class="pre">ϵ_values</span></code>.</p></li>
<li><p>The last two lines generate the plot and display it to the user.</p></li>
</ul>
<p>Let’s study some parts of this program in more detail.</p>
</div>
<div class="section" id="lists">
<span id="lists-ref"></span><h4>Lists<a class="headerlink" href="#lists" title="Permalink to this headline">#</a></h4>
<p>Consider the statement <code class="docutils literal notranslate"><span class="pre">ϵ_values</span> <span class="pre">=</span> <span class="pre">[]</span></code>, which creates an empty list.</p>
<p>Lists are a <em>native Python data structure</em> used to group a collection of
objects.</p>
<p>For example, try</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">]</span>
<span class="nb">type</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>list
</pre></div>
</div>
</div>
</div>
<p>The first element of <code class="docutils literal notranslate"><span class="pre">x</span></code> is an
<a class="reference external" href="https://en.wikipedia.org/wiki/Integer_%28computer_science%29">integer</a>,
the next is a
<a class="reference external" href="https://en.wikipedia.org/wiki/String_%28computer_science%29">string</a>,
and the third is a <a class="reference external" href="https://en.wikipedia.org/wiki/Boolean_data_type">Boolean value</a>.</p>
<p>When adding a value to a list, we can use the syntax
<code class="docutils literal notranslate"><span class="pre">list_name.append(some_value)</span></code></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">x</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[10, &#39;foo&#39;, False]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">2.5</span><span class="p">)</span>
<span class="n">x</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[10, &#39;foo&#39;, False, 2.5]
</pre></div>
</div>
</div>
</div>
<p>Here <code class="docutils literal notranslate"><span class="pre">append()</span></code> is what’s called a <em>method</em>, which is a function
“attached to” an object—in this case, the list <code class="docutils literal notranslate"><span class="pre">x</span></code>.</p>
<p>We’ll learn all about methods later on, but just to give you some idea,</p>
<ul class="simple">
<li><p>Python objects such as lists, strings, etc. all have methods that
are used to manipulate the data contained in the object.</p></li>
<li><p>String objects have <a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#string-methods">string methods</a>,
list objects have <a class="reference external" href="https://docs.python.org/3/tutorial/datastructures.html#more-on-lists">list methods</a>,
etc.</p></li>
</ul>
<p>Another useful list method is <code class="docutils literal notranslate"><span class="pre">pop()</span></code></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">x</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[10, &#39;foo&#39;, False, 2.5]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">x</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2.5
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">x</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[10, &#39;foo&#39;, False]
</pre></div>
</div>
</div>
</div>
<p>Lists in Python are zero-based (as in C, Java or Go), so the first
element is referenced by <code class="docutils literal notranslate"><span class="pre">x[0]</span></code></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>   <span class="c1"># first element of x</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>10
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>   <span class="c1"># second element of x</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;foo&#39;
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="the-for-loop">
<h4>The For Loop<a class="headerlink" href="#the-for-loop" title="Permalink to this headline">#</a></h4>
<p>Now let’s consider the <code class="docutils literal notranslate"><span class="pre">for</span></code> loop from
<a class="reference internal" href="#firstloopprog"><span class="std std-ref">the program above</span></a>, which
was</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ts_length</span><span class="p">):</span>
    <span class="n">e</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">()</span>
    <span class="n">ϵ_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Python executes the two indented lines <code class="docutils literal notranslate"><span class="pre">ts_length</span></code> times before moving
on.</p>
<p>These two lines are called a <code class="docutils literal notranslate"><span class="pre">code</span> <span class="pre">block</span></code>, since they comprise the
“block” of code that we are looping over.</p>
<p>Unlike most other languages, Python knows the extent of the code block
<em>only from indentation</em>.</p>
<p>In our program, indentation decreases after line <code class="docutils literal notranslate"><span class="pre">ϵ_values.append(e)</span></code>,
telling Python that this line marks the lower limit of the code block.</p>
<p>More on indentation below—for now, let’s look at another example of
a <code class="docutils literal notranslate"><span class="pre">for</span></code> loop</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">animals</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;dog&#39;</span><span class="p">,</span> <span class="s1">&#39;cat&#39;</span><span class="p">,</span> <span class="s1">&#39;bird&#39;</span><span class="p">]</span>
<span class="k">for</span> <span class="n">animal</span> <span class="ow">in</span> <span class="n">animals</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The plural of &quot;</span> <span class="o">+</span> <span class="n">animal</span> <span class="o">+</span> <span class="s2">&quot; is &quot;</span> <span class="o">+</span> <span class="n">animal</span> <span class="o">+</span> <span class="s2">&quot;s&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>The plural of dog is dogs
The plural of cat is cats
The plural of bird is birds
</pre></div>
</div>
</div>
</div>
<p>This example helps to clarify how the <code class="docutils literal notranslate"><span class="pre">for</span></code> loop works: When we execute
a loop of the form</p>
<div class="no-execute highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">variable_name</span> <span class="ow">in</span> <span class="n">sequence</span><span class="p">:</span>
    <span class="o">&lt;</span><span class="n">code</span> <span class="n">block</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>The Python interpreter performs the following:</p>
<ul class="simple">
<li><p>For each element of the <code class="docutils literal notranslate"><span class="pre">sequence</span></code>, it “binds” the name
<code class="docutils literal notranslate"><span class="pre">variable_name</span></code> to that element and then executes the code block.</p></li>
</ul>
<p>The <code class="docutils literal notranslate"><span class="pre">sequence</span></code> object can in fact be a very general object, as we’ll
see soon enough.</p>
</div>
<div class="section" id="a-comment-on-indentation">
<h4>A Comment on Indentation<a class="headerlink" href="#a-comment-on-indentation" title="Permalink to this headline">#</a></h4>
<p>In discussing the <code class="docutils literal notranslate"><span class="pre">for</span></code> loop, we explained that the code blocks being
looped over are delimited by indentation.</p>
<p>In fact, in Python, <strong>all</strong> code blocks (i.e., those occurring inside
loops, if clauses, function definitions, etc.) are delimited by
indentation.</p>
<p>Thus, unlike most other languages, whitespace in Python code affects the
output of the program.</p>
<p>Once you get used to it, this is a good thing: It</p>
<ul class="simple">
<li><p>forces clean, consistent indentation, improving readability</p></li>
<li><p>removes clutter, such as the brackets or end statements used in
other languages</p></li>
</ul>
<p>On the other hand, it takes a bit of care to get right, so please
remember:</p>
<ul class="simple">
<li><p>The line before the start of a code block always ends in a colon</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">for</span> <span class="pre">i</span> <span class="pre">in</span> <span class="pre">range(10):</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">if</span> <span class="pre">x</span> <span class="pre">&gt;</span> <span class="pre">y:</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">while</span> <span class="pre">x</span> <span class="pre">&lt;</span> <span class="pre">100:</span></code></p></li>
<li><p>etc., etc.</p></li>
</ul>
</li>
<li><p>All lines in a code block <strong>must have the same amount of indentation</strong>.</p></li>
<li><p>The Python standard is 4 spaces, and that’s what you should use.</p></li>
</ul>
</div>
<div class="section" id="while-loops">
<h4>While Loops<a class="headerlink" href="#while-loops" title="Permalink to this headline">#</a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">for</span></code> loop is the most common technique for iteration in Python.</p>
<p>But, for the purpose of illustration, let’s modify
<a class="reference internal" href="#firstloopprog"><span class="std std-ref">the program above</span></a> to use
a <code class="docutils literal notranslate"><span class="pre">while</span></code> loop instead.</p>
<div class="cell docutils container" id="whileloopprog">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ts_length</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">ϵ_values</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ts_length</span><span class="p">:</span>
    <span class="n">e</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">()</span>
    <span class="n">ϵ_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ϵ_values</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/b_python_by_example_34_0.png" src="../_images/b_python_by_example_34_0.png" />
</div>
</div>
<p>Note that</p>
<ul class="simple">
<li><p>the code block for the <code class="docutils literal notranslate"><span class="pre">while</span></code> loop is again delimited only by indentation</p></li>
<li><p>the statement <code class="docutils literal notranslate"><span class="pre">i</span> <span class="pre">=</span> <span class="pre">i</span> <span class="pre">+</span> <span class="pre">1</span></code> can be replaced by <code class="docutils literal notranslate"><span class="pre">i</span> <span class="pre">+=</span> <span class="pre">1</span></code></p></li>
</ul>
</div>
</div>
<div class="section" id="another-application">
<h3>Another Application<a class="headerlink" href="#another-application" title="Permalink to this headline">#</a></h3>
<p>Let’s do one more application before we turn to exercises.</p>
<p>In this application, we plot the balance of a bank account over time.</p>
<p>There are no withdraws over the time period, the last date of which is
denoted by <span class="math notranslate nohighlight">\(T\)</span>.</p>
<p>The initial balance is <span class="math notranslate nohighlight">\(b_0\)</span> and the interest rate is <span class="math notranslate nohighlight">\(r\)</span>.</p>
<p>The balance updates from period <span class="math notranslate nohighlight">\(t\)</span> to <span class="math notranslate nohighlight">\(t+1\)</span> according to</p>
<div class="math notranslate nohighlight" id="equation-ilom">
<span class="eqno">(1)<a class="headerlink" href="#equation-ilom" title="Permalink to this equation">#</a></span>\[    b_{t+1} = (1 + r) b_t\]</div>
<p>In the code below, we generate and plot the sequence <span class="math notranslate nohighlight">\(b_0, b_1, \ldots, b_T\)</span>
generated by <a class="reference internal" href="#equation-ilom">(1)</a>.</p>
<p>Instead of using a Python list to store this sequence, we will use a
NumPy array.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">r</span> <span class="o">=</span> <span class="mf">0.025</span>         <span class="c1"># interest rate</span>
<span class="n">T</span> <span class="o">=</span> <span class="mi">50</span>            <span class="c1"># end date</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">T</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># an empty NumPy array, to store all b_t</span>
<span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span>         <span class="c1"># initial balance</span>

<span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">T</span><span class="p">):</span>
    <span class="n">b</span><span class="p">[</span><span class="n">t</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">r</span><span class="p">)</span> <span class="o">*</span> <span class="n">b</span><span class="p">[</span><span class="n">t</span><span class="p">]</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;bank balance&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/b_python_by_example_36_0.png" src="../_images/b_python_by_example_36_0.png" />
</div>
</div>
<p>The statement <code class="docutils literal notranslate"><span class="pre">b</span> <span class="pre">=</span> <span class="pre">np.empty(T+1)</span></code> allocates storage in memory for <code class="docutils literal notranslate"><span class="pre">T+1</span></code>
(floating point) numbers.</p>
<p>These numbers are filled in by the <code class="docutils literal notranslate"><span class="pre">for</span></code> loop.</p>
<p>Allocating memory at the start is more efficient than using a Python
list and <code class="docutils literal notranslate"><span class="pre">append</span></code>, since the latter must repeatedly ask for storage
space from the operating system.</p>
<p>Notice that we added a legend to the plot.</p>
<!-- 
 --- a feature you will be
asked to use in the exercises.
## Exercises

Now we turn to exercises. It is important that you complete them before
continuing, since they present new concepts we will need.

### Exercise 1

Your first task is to simulate and plot the correlated time series

$$
x_{t+1} = \alpha \, x_t + \epsilon_{t+1}
\quad \text{where} \quad
x_0 = 0
\quad \text{and} \quad t = 0,\ldots,T
$$

The sequence of shocks $\{\epsilon_t\}$ is assumed to be IID and
standard normal.

In your solution, restrict your import statements to

```{code-cell} python3
import numpy as np
import matplotlib.pyplot as plt
```

Set $T=200$ and $\alpha = 0.9$.

### Exercise 2

Starting with your solution to exercise 2, plot three simulated time
series, one for each of the cases $\alpha=0$, $\alpha=0.8$ and
$\alpha=0.98$.

Use a `for` loop to step through the $\alpha$ values.

If you can, add a legend, to help distinguish between the three time
series.

Hints:

-   If you call the `plot()` function multiple times before calling
    `show()`, all of the lines you produce will end up on the same
    figure.
-   For the legend, noted that the expression `'foo' + str(42)`
    evaluates to `'foo42'`.

### Exercise 3

Similar to the previous exercises, plot the time series

$$
x_{t+1} = \alpha \, |x_t| + \epsilon_{t+1}
\quad \text{where} \quad
x_0 = 0
\quad \text{and} \quad t = 0,\ldots,T
$$

Use $T=200$, $\alpha = 0.9$ and $\{\epsilon_t\}$ as before.

Search online for a function that can be used to compute the absolute
value $|x_t|$.

### Exercise 4

One important aspect of essentially all programming languages is
branching and conditions.

In Python, conditions are usually implemented with if--else syntax.

Here\'s an example, that prints -1 for each negative number in an array
and 1 for each nonnegative number

```{code-cell} python3
numbers = [-9, 2.3, -11, 0]
```

```{code-cell} python3
for x in numbers:
    if x < 0:
        print(-1)
    else:
        print(1)
```

Now, write a new solution to Exercise 3 that does not use an existing
function to compute the absolute value.

Replace this existing function with an if--else condition.

(pbe_ex3)=

### Exercise 5

Here\'s a harder exercise, that takes some thought and planning.

The task is to compute an approximation to $\pi$ using [Monte Carlo](https://en.wikipedia.org/wiki/Monte_Carlo_method).

Use no imports besides

```{code-cell} python3
import numpy as np
```

Your hints are as follows:

-   If $U$ is a bivariate uniform random variable on the unit square
    $(0, 1)^2$, then the probability that $U$ lies in a subset $B$ of
    $(0,1)^2$ is equal to the area of $B$.
-   If $U_1,\ldots,U_n$ are IID copies of $U$, then, as $n$ gets large,
    the fraction that falls in $B$, converges to the probability of
    landing in $B$.
-   For a circle, $area = \pi * radius^2$.

## Solutions

### Exercise 1

Here\'s one solution.

```{code-cell} python3
α = 0.9
T = 200
x = np.empty(T+1)
x[0] = 0

for t in range(T):
    x[t+1] = α * x[t] + np.random.randn()

plt.plot(x)
plt.show()
```

### Exercise 2

```{code-cell} python3
α_values = [0.0, 0.8, 0.98]
T = 200
x = np.empty(T+1)

for α in α_values:
    x[0] = 0
    for t in range(T):
        x[t+1] = α * x[t] + np.random.randn()
    plt.plot(x, label=f'$\\alpha = {α}$')

plt.legend()
plt.show()
```

### Exercise 3

Here\'s one solution:

```{code-cell} python3
α = 0.9
T = 200
x = np.empty(T+1)
x[0] = 0

for t in range(T):
    x[t+1] = α * np.abs(x[t]) + np.random.randn()

plt.plot(x)
plt.show()
```

### Exercise 4

Here\'s one way:

```{code-cell} python3
α = 0.9
T = 200
x = np.empty(T+1)
x[0] = 0

for t in range(T):
    if x[t] < 0:
        abs_x = - x[t]
    else:
        abs_x = x[t]
    x[t+1] = α * abs_x + np.random.randn()

plt.plot(x)
plt.show()
```

Here\'s a shorter way to write the same thing:

```{code-cell} python3
α = 0.9
T = 200
x = np.empty(T+1)
x[0] = 0

for t in range(T):
    abs_x = - x[t] if x[t] < 0 else x[t]
    x[t+1] = α * abs_x + np.random.randn()

plt.plot(x)
plt.show()
```

### Exercise 5

Consider the circle of diameter 1 embedded in the unit square.

Let $A$ be its area and let $r=1/2$ be its radius.

If we know $\pi$ then we can compute $A$ via $A = \pi r^2$.

But here the point is to compute $\pi$, which we can do by
$\pi = A / r^2$.

Summary: If we can estimate the area of a circle with diameter 1, then
dividing by $r^2 = (1/2)^2 = 1/4$ gives an estimate of $\pi$.

We estimate the area by sampling bivariate uniforms and looking at the
fraction that falls into the circle.

```{code-cell} python3
n = 100000

count = 0
for i in range(n):
    u, v = np.random.uniform(), np.random.uniform()
    d = np.sqrt((u - 0.5)**2 + (v - 0.5)**2)
    if d < 0.5:
        count += 1

area_estimate = count / n

print(area_estimate * 4)  # dividing by radius**2
``` --></div>
</div>
<span id="document-docs/b_learn_more"></span><div class="tex2jax_ignore mathjax_ignore section" id="learn-more">
<h2>Learn More<a class="headerlink" href="#learn-more" title="Permalink to this headline">#</a></h2>
<p>We’re about ready to wrap up this brief course on Python for scientific
computing.</p>
<p>In this last lecture we give some pointers to the major scientific libraries
and suggestions for further reading.</p>
<div class="section" id="numpy">
<h3>NumPy<a class="headerlink" href="#numpy" title="Permalink to this headline">#</a></h3>
<p>Fundamental matrix and array processing capabilities are provided by the
excellent <a class="reference external" href="http://www.numpy.org/">NumPy</a> library.</p>
<p>For example, let’s build some arrays</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>                     <span class="c1"># Load the library</span>

<span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>    <span class="c1"># Create even grid from -π to π</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>                          <span class="c1"># Apply cosine to each element of a</span>
<span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>                          <span class="c1"># Apply sin to each element of a</span>
</pre></div>
</div>
</div>
</div>
<p>Now let’s take the inner product</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">b</span> <span class="o">@</span> <span class="n">c</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>4.04891256782214e-16
</pre></div>
</div>
</div>
</div>
<p>The number you see here might vary slightly due to floating point arithmetic
but it’s essentially zero.</p>
<p>As with other standard NumPy operations, this inner product calls into highly
optimized machine code.</p>
<p>It is as efficient as carefully hand-coded FORTRAN or C.</p>
</div>
<div class="section" id="scipy">
<h3>SciPy<a class="headerlink" href="#scipy" title="Permalink to this headline">#</a></h3>
<p>The <a class="reference external" href="http://www.scipy.org">SciPy</a> library is built on top of NumPy and
provides additional functionality.</p>
<p id="tuple-unpacking-example">For example, let’s calculate <span class="math notranslate nohighlight">\(\int_{-2}^2 \phi(z) dz\)</span> where <span class="math notranslate nohighlight">\(\phi\)</span> is
the standard normal density.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">norm</span>
<span class="kn">from</span> <span class="nn">scipy.integrate</span> <span class="kn">import</span> <span class="n">quad</span>

<span class="n">ϕ</span> <span class="o">=</span> <span class="n">norm</span><span class="p">()</span>
<span class="n">value</span><span class="p">,</span> <span class="n">error</span> <span class="o">=</span> <span class="n">quad</span><span class="p">(</span><span class="n">ϕ</span><span class="o">.</span><span class="n">pdf</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># Integrate using Gaussian quadrature</span>
<span class="n">value</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.9544997361036417
</pre></div>
</div>
</div>
</div>
<p>SciPy includes many of the standard routines used in</p>
<ul class="simple">
<li><p><a class="reference external" href="http://docs.scipy.org/doc/scipy/reference/linalg.html">linear algebra</a></p></li>
<li><p><a class="reference external" href="http://docs.scipy.org/doc/scipy/reference/integrate.html">integration</a></p></li>
<li><p><a class="reference external" href="http://docs.scipy.org/doc/scipy/reference/interpolate.html">interpolation</a></p></li>
<li><p><a class="reference external" href="http://docs.scipy.org/doc/scipy/reference/optimize.html">optimization</a></p></li>
<li><p><a class="reference external" href="http://docs.scipy.org/doc/scipy/reference/stats.html">distributions and random number generation</a></p></li>
<li><p><a class="reference external" href="http://docs.scipy.org/doc/scipy/reference/signal.html">signal processing</a></p></li>
</ul>
<p>See them all <a class="reference external" href="http://docs.scipy.org/doc/scipy/reference/index.html">here</a>.</p>
</div>
<div class="section" id="graphics">
<h3>Graphics<a class="headerlink" href="#graphics" title="Permalink to this headline">#</a></h3>
<p>The most popular and comprehensive Python library for creating figures
and graphs is <a class="reference external" href="http://matplotlib.org/">Matplotlib</a>, with functionality
including</p>
<ul class="simple">
<li><p>plots, histograms, contour images, 3D graphs, bar charts etc.</p></li>
<li><p>output in many formats (PDF, PNG, EPS, etc.)</p></li>
<li><p>LaTeX integration</p></li>
</ul>
<p>Example 2D plot with embedded LaTeX annotations</p>
<div class="figure align-default">
<a class="reference internal image-reference" href="../_images/qs.png"><img alt="../_images/qs.png" src="../_images/qs.png" style="width: 446.6px; height: 336.6px;" /></a>
</div>
<p>Example contour plot</p>
<div class="figure align-default">
<a class="reference internal image-reference" href="../_images/bn_density1.png"><img alt="../_images/bn_density1.png" src="../_images/bn_density1.png" style="width: 328.35px; height: 257.95000000000005px;" /></a>
</div>
<p>Example 3D plot</p>
<div class="figure align-default">
<a class="reference internal image-reference" href="../_images/career_vf.png"><img alt="../_images/career_vf.png" src="../_images/career_vf.png" style="width: 373.6px; height: 277.6px;" /></a>
</div>
<p>More examples can be found in the <a class="reference external" href="http://matplotlib.org/gallery.html">Matplotlib thumbnail
gallery</a>.</p>
<p>Other graphics libraries include</p>
<ul class="simple">
<li><p><a class="reference external" href="https://plot.ly/python/">Plotly</a></p></li>
<li><p><a class="reference external" href="http://bokeh.pydata.org/en/latest/">Bokeh</a></p></li>
</ul>
</div>
<div class="section" id="symbolic-algebra">
<h3>Symbolic Algebra<a class="headerlink" href="#symbolic-algebra" title="Permalink to this headline">#</a></h3>
<p>It’s useful to be able to manipulate symbolic expressions, as in
Mathematica or Maple.</p>
<p>The <a class="reference external" href="http://www.sympy.org/">SymPy</a> library provides this functionality
from within the Python shell.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sympy</span> <span class="kn">import</span> <span class="n">Symbol</span>

<span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">Symbol</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">),</span> <span class="n">Symbol</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>  <span class="c1"># Treat &#39;x&#39; and &#39;y&#39; as algebraic symbols</span>
<span class="n">x</span> <span class="o">+</span> <span class="n">x</span> <span class="o">+</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_latex math notranslate nohighlight">
\[\displaystyle 3 x + y\]</div>
</div>
</div>
<p>We can manipulate expressions</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">expression</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">y</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
<span class="n">expression</span><span class="o">.</span><span class="n">expand</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_latex math notranslate nohighlight">
\[\displaystyle x^{2} + 2 x y + y^{2}\]</div>
</div>
</div>
<p>solve polynomials</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sympy</span> <span class="kn">import</span> <span class="n">solve</span>

<span class="n">solve</span><span class="p">(</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[-1/2 - sqrt(7)*I/2, -1/2 + sqrt(7)*I/2]
</pre></div>
</div>
</div>
</div>
<p>and calculate limits, derivatives and integrals</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sympy</span> <span class="kn">import</span> <span class="n">limit</span><span class="p">,</span> <span class="n">sin</span><span class="p">,</span> <span class="n">diff</span>

<span class="n">limit</span><span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_latex math notranslate nohighlight">
\[\displaystyle \infty\]</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">limit</span><span class="p">(</span><span class="n">sin</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">/</span> <span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_latex math notranslate nohighlight">
\[\displaystyle 1\]</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">diff</span><span class="p">(</span><span class="n">sin</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_latex math notranslate nohighlight">
\[\displaystyle \cos{\left(x \right)}\]</div>
</div>
</div>
<p>The beauty of importing this functionality into Python is that we are
working within a fully fledged programming language.</p>
<p>We can easily create tables of derivatives, generate LaTeX output, add
that output to figures and so on.</p>
</div>
<div class="section" id="pandas">
<h3>Pandas<a class="headerlink" href="#pandas" title="Permalink to this headline">#</a></h3>
<p>One of the most popular libraries for working with data is
<a class="reference external" href="http://pandas.pydata.org/">pandas</a>.</p>
<p>Pandas is fast, efficient, flexible and well designed.</p>
<p>Here’s a simple example, using some dummy data generated with Numpy’s
excellent <code class="docutils literal notranslate"><span class="pre">random</span></code> functionality.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">1234</span><span class="p">)</span>

<span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># 5x2 matrix of N(0, 1) random draws</span>
<span class="n">dates</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="s1">&#39;28/12/2010&#39;</span><span class="p">,</span> <span class="n">periods</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;price&#39;</span><span class="p">,</span> <span class="s1">&#39;weight&#39;</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="n">dates</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>               price    weight
2010-12-28  0.471435 -1.190976
2010-12-29  1.432707 -0.312652
2010-12-30 -0.720589  0.887163
2010-12-31  0.859588 -0.636524
2011-01-01  0.015696 -2.242685
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>price     0.411768
weight   -0.699135
dtype: float64
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="further-reading">
<h3>Further Reading<a class="headerlink" href="#further-reading" title="Permalink to this headline">#</a></h3>
<p>These lectures were originally taken from a longer and more complete lecture
series on Python programming hosted by <a class="reference external" href="https://quantecon.org">QuantEcon</a>.</p>
<p>The <a class="reference external" href="https://python-programming.quantecon.org/">full set of lectures</a> might be
useful as the next step of your study.</p>
</div>
</div>
</div>
<div class="toctree-wrapper compound">
<span id="document-docs/c_features"></span><hr class="docutils" id="c-features" />
<div class="admonition-learning-objectives admonition">
<p class="admonition-title">Learning Objectives</p>
<ul class="simple">
<li><p>Learn the difference between raster and vector data</p></li>
<li><p>Learn how to manually create each data structure</p></li>
<li><p>Learn about data measurement</p></li>
</ul>
</div>
<hr class="docutils" />
<div class="tex2jax_ignore mathjax_ignore section" id="spatial-data">
<h2>Spatial Data<a class="headerlink" href="#spatial-data" title="Permalink to this headline">#</a></h2>
<div class="section" id="vector-vs-raster-data">
<h3>Vector vs. Raster Data<a class="headerlink" href="#vector-vs-raster-data" title="Permalink to this headline">#</a></h3>
<p>To work in a GIS environment, real world observations (objects or events that can be recorded in 2D or 3D space) need to be reduced to spatial entities. These spatial entities can be represented in a GIS as a <strong>vector data model</strong> or a <strong>raster data model</strong>.</p>
<div class="figure align-default" id="raster-vs-vector">
<img alt="../_images/vector_vs_raster.jpg" src="../_images/vector_vs_raster.jpg" />
<p class="caption"><span class="caption-number">Fig. 2 </span><span class="caption-text">Vector and raster representations of a river feature.</span><a class="headerlink" href="#raster-vs-vector" title="Permalink to this image">#</a></p>
</div>
<div class="section" id="vector-data">
<h4>Vector Data<a class="headerlink" href="#vector-data" title="Permalink to this headline">#</a></h4>
<p>Vector features can be decomposed into three different geometric primitives: <strong>points</strong>, <strong>polylines</strong> and <strong>polygons</strong>.</p>
<div class="section" id="point">
<h5>Point<a class="headerlink" href="#point" title="Permalink to this headline">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">geopandas</span> <span class="k">as</span> <span class="nn">gpd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">shapely.geometry</span> <span class="kn">import</span> <span class="n">Point</span>

<span class="n">d</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Washington</span><span class="se">\n</span><span class="s1">(38.90, -77.03)&#39;</span><span class="p">,</span> <span class="s1">&#39;Baltimore</span><span class="se">\n</span><span class="s1">(39.29, -76.61)&#39;</span><span class="p">,</span><span class="s1">&#39;Fredrick</span><span class="se">\n</span><span class="s1">(39.41,-77.40)&#39;</span><span class="p">],</span> 
     <span class="s1">&#39;geometry&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">Point</span><span class="p">(</span><span class="o">-</span><span class="mf">77.036873</span><span class="p">,</span><span class="mf">38.907192</span><span class="p">),</span> <span class="n">Point</span><span class="p">(</span><span class="o">-</span><span class="mf">76.612190</span><span class="p">,</span><span class="mf">39.290386</span><span class="p">,),</span> <span class="n">Point</span><span class="p">(</span><span class="o">-</span><span class="mf">77.408456</span><span class="p">,</span><span class="mf">39.412006</span><span class="p">)]}</span>

<span class="n">gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="s2">&quot;EPSG:4326&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">gdf</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                          name                    geometry
0  Washington\n(38.90, -77.03)  POINT (-77.03687 38.90719)
1   Baltimore\n(39.29, -76.61)  POINT (-76.61219 39.29039)
2     Fredrick\n(39.41,-77.40)  POINT (-77.40846 39.41201)
</pre></div>
</div>
</div>
</div>
<p>A point is composed of one coordinate pair representing a specific location in a coordinate system. Points are the most basic geometric primitives having no length or area. By definition a point can’t be “seen” since it has no area; but this is not practical if such primitives are to be mapped. So points on a map are represented using <em>symbols</em> that have both area and shape (e.g. circle, square, plus signs).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;bmh&#39;</span><span class="p">)</span> <span class="c1"># better for plotting geometries vs general plots.</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">gdf</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">([</span><span class="mf">38.8</span><span class="p">,</span> <span class="mf">39.6</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">([</span><span class="o">-</span><span class="mf">77.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">76.2</span><span class="p">])</span>

<span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">gdf</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">gdf</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">gdf</span><span class="o">.</span><span class="n">name</span><span class="p">):</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">textcoords</span><span class="o">=</span><span class="s2">&quot;offset points&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/c_features_3_0.png" src="../_images/c_features_3_0.png" />
</div>
</div>
<p>We seem capable of interpreting such symbols as points, but there may be instances when such interpretation may be ambiguous (e.g. is a round symbol delineating the area of a round feature on the ground such as a large oil storage tank or is it representing the point location of that tank?).</p>
</div>
<div class="section" id="polyline">
<h5>Polyline<a class="headerlink" href="#polyline" title="Permalink to this headline">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">shapely.geometry</span> <span class="kn">import</span> <span class="n">LineString</span>

<span class="n">d</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Washington</span><span class="se">\n</span><span class="s1">(38.90, -77.03)&#39;</span> <span class="p">],</span> 
     <span class="s1">&#39;geometry&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">LineString</span><span class="p">([</span><span class="n">Point</span><span class="p">(</span><span class="o">-</span><span class="mf">77.036873</span><span class="p">,</span><span class="mf">38.907192</span><span class="p">),</span> <span class="n">Point</span><span class="p">(</span><span class="o">-</span><span class="mf">76.612190</span><span class="p">,</span><span class="mf">39.290386</span><span class="p">,),</span> <span class="n">Point</span><span class="p">(</span><span class="o">-</span><span class="mf">77.408456</span><span class="p">,</span><span class="mf">39.412006</span><span class="p">)])]}</span>
<span class="n">gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="s2">&quot;EPSG:4326&quot;</span><span class="p">)</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">gdf</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;AxesSubplot:&gt;
</pre></div>
</div>
<img alt="../_images/c_features_5_1.png" src="../_images/c_features_5_1.png" />
</div>
</div>
<p>A polyline is composed of a sequence of two or more coordinate pairs called vertices. A vertex is defined by coordinate pairs, just like a point, but what differentiates a vertex from a point is its explicitly defined relationship with neighboring vertices. A vertex is connected to at least one other vertex.</p>
<p>Like a point, a true line can’t be seen since it has no area. And like a point, a line is symbolized using shapes that have a color, width and style (e.g. solid, dashed, dotted, etc…). Roads and rivers are commonly stored as polylines in a GIS.</p>
</div>
<div class="section" id="polygon">
<h5>Polygon<a class="headerlink" href="#polygon" title="Permalink to this headline">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">shapely.geometry</span> <span class="kn">import</span> <span class="n">Polygon</span>

<span class="n">d</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Washington</span><span class="se">\n</span><span class="s1">(38.90, -77.03)&#39;</span> <span class="p">],</span> 
     <span class="s1">&#39;geometry&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">Polygon</span><span class="p">([</span><span class="n">Point</span><span class="p">(</span><span class="o">-</span><span class="mf">77.036873</span><span class="p">,</span><span class="mf">38.907192</span><span class="p">),</span> <span class="n">Point</span><span class="p">(</span><span class="o">-</span><span class="mf">76.612190</span><span class="p">,</span><span class="mf">39.290386</span><span class="p">,),</span> <span class="n">Point</span><span class="p">(</span><span class="o">-</span><span class="mf">77.408456</span><span class="p">,</span><span class="mf">39.412006</span><span class="p">)])]}</span>
<span class="n">gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="s2">&quot;EPSG:4326&quot;</span><span class="p">)</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">gdf</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/c_features_7_0.png" src="../_images/c_features_7_0.png" />
</div>
</div>
<p>A polygon is composed of three or more line segments whose starting and ending coordinate pairs are the same. Sometimes you will see the words <em>lattice</em> or <em>area</em> used in lieu of ‘polygon’. Polygons represent both length (i.e. the perimeter of the area) and area. They also embody the idea of an inside and an outside; in fact, the area that a polygon encloses is explicitly defined in a GIS environment. If it isn’t, then you are working with a polyline feature. If this does not seem intuitive, think of three connected lines defining a triangle: they can represent three connected road segments (thus polyline features), or they can represent the grassy strip enclosed by the connected roads (in which case an ‘inside’ is implied thus defining a polygon).</p>
</div>
</div>
<div class="section" id="raster-data">
<h4>Raster Data<a class="headerlink" href="#raster-data" title="Permalink to this headline">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="n">X</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Plot 2D array&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/c_features_9_0.png" src="../_images/c_features_9_0.png" />
</div>
</div>
<p>A raster data model uses an array of cells, or pixels, to represent real-world objects. Raster datasets are commonly used for representing and managing imagery, surface temperatures, digital elevation models, and numerous other entities.</p>
<p>A raster can be thought of as a special case of an area object where the area is divided into a regular grid of cells. But a regularly spaced array of marked points may be a better analogy since rasters are stored as an array of values where each cell is defined by a single coordinate pair inside of most GIS environments.</p>
<p>Implicit in a raster data model is a value associated with each cell or pixel. This is in contrast to a vector model that may or may not have a value associated with the geometric primitive.</p>
</div>
<div class="section" id="object-vs-field">
<h4>Object vs. Field<a class="headerlink" href="#object-vs-field" title="Permalink to this headline">#</a></h4>
<p>The traditional vector/raster perspective of our world is one that has been driven by software and data storage environments. But this perspective is not particularly helpful if one is interested in analyzing the pattern. In fact, it can mask some important properties of the entity being studied. An object vs. field view of the world proves to be more insightful even though it may seem more abstract.</p>
<div class="section" id="object-view">
<h5>Object View<a class="headerlink" href="#object-view" title="Permalink to this headline">#</a></h5>
<p>An object view of the world treats entities as discrete objects; they need not occur at every location within a study area. Point locations of cities would be an example of an object. So would be polygonal representations of urban areas which may be non-contiguous.</p>
</div>
<div class="section" id="field-view">
<h5>Field View<a class="headerlink" href="#field-view" title="Permalink to this headline">#</a></h5>
<p>A field view of the world treats entities as a scalar field. This is a mathematical concept in which a scalar is a quantity having a magnitude. It is measurable at every location within the study region. Two popular examples of a scalar field are surface elevation and surface temperature. Each represents a property that can be measured at any location.</p>
<p>Another example of a scalar field is the presence and absence of a building. This is a binary scalar where a value of 0 is assigned to a location devoid of buildings and a value of 1 is assigned to locations having one or more buildings. A field representation of buildings may not seem intuitive, in fact, given the definition of an object view of the world in the last section, it would seem only fitting to view buildings as objects. In fact, buildings can be viewed as both field or objects. The context of the analysis is ultimately what will dictate which view to adopt. If we’re interested in studying the distribution of buildings over a study area, then an object view of the features makes sense. If, on the other hand, we are interested in identifying all locations where buildings don’t exist, then a binary field view of these entities would make sense.</p>
</div>
</div>
<div class="section" id="scale">
<h4>Scale<a class="headerlink" href="#scale" title="Permalink to this headline">#</a></h4>
<p>How one chooses to represent a real-world entity will be in large part dictated by the <strong>scale</strong> of the analysis. In a GIS, scale has a specific meaning: it’s the ratio of distance on the map to that in the real world. So a <strong>large scale</strong> map implies a relatively large ratio and thus a small extent. This is counter to the layperson’s interpretation of <em>large scale</em> which focuses on the scope or extent of a study; so a large scale analysis would imply one that covers a <em>large</em> area.</p>
<p>The following two maps represent the same entity: the Boston region. At a small scale (e.g. 1:10,000,000), Boston and other cities may be best represented as points. At a large scale (e.g. 1:34,000), Boston may be best represented as a polygon. Note that at this large scale, roads may also be represented as polygon features instead of polylines.</p>
<div class="figure align-default" id="boston-small-scale">
<img alt="../_images/Boston_small_scale.jpg" src="../_images/Boston_small_scale.jpg" />
<p class="caption"><span class="caption-number">Fig. 3 </span><span class="caption-text">Map of the Boston area at a 1:10,000,000 scale. Note that in geography, this is considered small scale whereas in layperson terms, this extent is often referred to as a large scale (i.e. covering a large area).</span><a class="headerlink" href="#boston-small-scale" title="Permalink to this image">#</a></p>
</div>
<div class="figure align-default" id="boston-large-scale">
<img alt="../_images/Boston_large_scale.jpg" src="../_images/Boston_large_scale.jpg" />
<p class="caption"><span class="caption-number">Fig. 4 </span><span class="caption-text">Map of the Boston area at a 1:34,000 scale. Note that in geography, this is considered large scale whereas in layperson terms, this extent is often referred to as a small scale (i.e. covering a small area).</span><a class="headerlink" href="#boston-large-scale" title="Permalink to this image">#</a></p>
</div>
</div>
<div class="section" id="attribute-tables">
<h4>Attribute Tables<a class="headerlink" href="#attribute-tables" title="Permalink to this headline">#</a></h4>
<p>Non-spatial information associated with a spatial feature is referred to as an <strong>attribute</strong>. A feature on a GIS map is linked to its record in the attribute table by a unique numerical feature identifier (FID). Every feature in a layer has an identifier. It is important to understand the one-to-one or many-to-one relationship between feature, and attribute record. Because features on the map are linked to their records in the table, many GIS software will allow you to click on a map feature and see its related attributes in the table.</p>
<p>Raster data can also have attributes only if pixels are represented using a small set of unique integer values. Raster datasets that contain attribute tables typically have cell values that represent or define a class, group, category, or membership. NOTE: not all GIS raster data formats can store attribute information; in fact most raster datasets you will work with in this course will not have attribute tables.</p>
<div class="section" id="measurement-levels">
<h5>Measurement Levels<a class="headerlink" href="#measurement-levels" title="Permalink to this headline">#</a></h5>
<p>Attribute data can be broken down into four <strong>measurement levels</strong>:</p>
<ul class="simple">
<li><p><strong>Nominal</strong> data which have no implied order, size or quantitative information (e.g. paved and unpaved roads)</p></li>
<li><p><strong>Ordinal</strong> data have an implied order (e.g. ranked scores), however, we cannot quantify the difference since a linear scale is not implied.</p></li>
<li><p><strong>Interval</strong> data are numeric and have a linear scale, however they do not have a true zero and can therefore not be used to measure <em>relative</em> magnitudes. For example, one cannot say that 60°F is twice as warm as 30°F since when presented in degrees °C the temperature values are 15.5°C and -1.1°C respectively (and 15.5 is clearly not twice as big as -1.1).</p></li>
<li><p><strong>Ratio</strong> scale data are interval data with a true zero such as monetary value (e.g. <span class="math notranslate nohighlight">\(1, \)</span>20, $100).</p></li>
</ul>
</div>
</div>
<div class="section" id="data-type">
<h4>Data type<a class="headerlink" href="#data-type" title="Permalink to this headline">#</a></h4>
<p>Another way to categorize an attribute is by its <strong>data type</strong>. ArcGIS supports several data types such as <strong>integer, float, double and text</strong>. Knowing your data type and measurement level should dictate how they are stored in a GIS environment. The following table lists popular data types available in most GIS applications.</p>
<table class="colwidths-auto docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Type</p></th>
<th class="head"><p>Stored values</p></th>
<th class="head"><p>Note</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Short integer</p></td>
<td><p>-32,768 to 32,768</p></td>
<td><p>Whole numbers</p></td>
</tr>
<tr class="row-odd"><td><p>Long integer</p></td>
<td><p>-2,147,483,648 to 2,147,483,648</p></td>
<td><p>Whole numbers</p></td>
</tr>
<tr class="row-even"><td><p>Float</p></td>
<td><p>-3.4 * E-38 to 1.2 E38</p></td>
<td><p>Real numbers</p></td>
</tr>
<tr class="row-odd"><td><p>Double</p></td>
<td><p>-2.2 * E-308 to 1.8 * E308</p></td>
<td><p>Real numbers</p></td>
</tr>
<tr class="row-even"><td><p>Text</p></td>
<td><p>Up to 64,000 characters</p></td>
<td><p>Letters and words</p></td>
</tr>
</tbody>
</table>
<p>While whole numbers can be stored as a float or double (i.e. we can store the number 2 as 2.0) doing so comes at a cost: an increase in storage space. This may not be a big deal if the dataset is small, but if it consists of tens of thousands of records the increase in file size and processing time may become an issue.</p>
<p>While storing an integer value as a float may not have dire consequences, the same cannot be said of storing a float as an integer. For example, if your values consist of 0.2, 0.01, 0.34, 0.1 and 0.876, their integer counterpart would be 0, 0, 0, and 1 (i.e. values rounded to the nearest whole number).</p>
<!-- This can have a significant impact on a map as shown in the following example.

```{r echo=FALSE, fig.cap = "Map of data represented as decimal (float) values.",  fig.height=3}

library(spdep)
library(maptools)
library(RColorBrewer)
fn     <- system.file("etc/shapes/eire.shp", package = "spdep")[1] 
prj    <- CRS("+proj=utm +zone=30 +units=km") 
eire   <- readShapeSpatial(fn, ID = "names", proj4string = prj) 
eire$x <- log(eire$INCOME) / max(log(eire$INCOME)) 
brks   <- seq(0.5,1.0, .1) 
brks[6] <- 1.00001 
clr     <- brewer.pal(5,"Greens")
l1 <- list(sp.text, coordinates(eire), as.character(round(eire$x,2)), cex=0.5 ) 
spplot(eire, z="x", at= brks, col.regions =clr, col="white", sp.layout=l1)

```


```{r echo=FALSE, fig.cap = "Map of same data represented as integers instead of float.", fig.height=3}
eire$x.int <- round(eire$x) 
l2 <- list(sp.text, coordinates(eire), as.character(round(eire$x.int,2)), cex=0.5 ) 
spplot(eire, z="x.int", at= brks, col.regions =clr, col="white", sp.layout=l2)

```  --></div>
</div>
</div>
<span id="document-docs/c_store_features"></span><hr class="docutils" id="c-store-features" />
<div class="admonition-learning-objectives admonition">
<p class="admonition-title">Learning Objectives</p>
<ul class="simple">
<li><p>Learn about spatial data storage formats</p></li>
</ul>
</div>
<hr class="docutils" />
<div class="tex2jax_ignore mathjax_ignore section" id="data-storage-formats">
<h2>Data Storage Formats<a class="headerlink" href="#data-storage-formats" title="Permalink to this headline">#</a></h2>
<div class="section" id="vector-data-file-formats">
<h3>Vector Data File Formats<a class="headerlink" href="#vector-data-file-formats" title="Permalink to this headline">#</a></h3>
<div class="section" id="geojson">
<h4>GeoJSON<a class="headerlink" href="#geojson" title="Permalink to this headline">#</a></h4>
<p>GeoJSON is an open standard format designed for representing simple geographical features, along with their non-spatial attributes. It is based on the JSON format. The features include points, line strings, polygons, and multi-part collections of these types. One of it’s primary advantages is that it is human readible and stores all the relevant data in a single text file. As result however, these files can get very large when storing complex geometries.</p>
<p>Here’s a simple example of a FeatureCollection that includes a point, line and polygon <code class="docutils literal notranslate"><span class="pre">geometry</span></code> with some attributes stored as <code class="docutils literal notranslate"><span class="pre">properties</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="p">{</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;FeatureCollection&quot;</span><span class="p">,</span>
    <span class="s2">&quot;features&quot;</span><span class="p">:</span> <span class="p">[</span>
      <span class="p">{</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;Feature&quot;</span><span class="p">,</span>
        <span class="s2">&quot;geometry&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;Point&quot;</span><span class="p">,</span> <span class="s2">&quot;coordinates&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">102.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">]},</span>
        <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;prop0&quot;</span><span class="p">:</span> <span class="s2">&quot;value0&quot;</span><span class="p">}</span>
        <span class="p">},</span>
      <span class="p">{</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;Feature&quot;</span><span class="p">,</span>
        <span class="s2">&quot;geometry&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;LineString&quot;</span><span class="p">,</span>
          <span class="s2">&quot;coordinates&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">[</span><span class="mf">102.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="p">[</span><span class="mf">103.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">],</span> <span class="p">[</span><span class="mf">104.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="p">[</span><span class="mf">105.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]</span>
            <span class="p">]</span>
          <span class="p">},</span>
        <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="s2">&quot;prop0&quot;</span><span class="p">:</span> <span class="s2">&quot;value0&quot;</span><span class="p">,</span>
          <span class="s2">&quot;prop1&quot;</span><span class="p">:</span> <span class="mf">0.0</span>
          <span class="p">}</span>
        <span class="p">},</span>
      <span class="p">{</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;Feature&quot;</span><span class="p">,</span>
         <span class="s2">&quot;geometry&quot;</span><span class="p">:</span> <span class="p">{</span>
           <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;Polygon&quot;</span><span class="p">,</span>
           <span class="s2">&quot;coordinates&quot;</span><span class="p">:</span> <span class="p">[</span>
             <span class="p">[</span> <span class="p">[</span><span class="mf">100.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="p">[</span><span class="mf">101.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="p">[</span><span class="mf">101.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">],</span>
               <span class="p">[</span><span class="mf">100.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">],</span> <span class="p">[</span><span class="mf">100.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]</span> <span class="p">]</span>
             <span class="p">]</span>
         <span class="p">},</span>
         <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
           <span class="s2">&quot;prop0&quot;</span><span class="p">:</span> <span class="s2">&quot;value0&quot;</span><span class="p">,</span>
           <span class="s2">&quot;prop1&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;this&quot;</span><span class="p">:</span> <span class="s2">&quot;that&quot;</span><span class="p">}</span>
           <span class="p">}</span>
         <span class="p">}</span>
       <span class="p">]</span>
     <span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="geopackage">
<h4>GeoPackage<a class="headerlink" href="#geopackage" title="Permalink to this headline">#</a></h4>
<p>This is a relatively new data format that follows <a class="reference external" href="https://en.wikipedia.org/wiki/Open_format">open format standards</a> (i.e. it is non-proprietary). It’s built on top of SQLite (a self-contained relational database). Its one big advantage over many other vector formats is its compactness–coordinate value, metadata, attribute table, projection information, etc…, are all stored in a <em>single</em> file which facilitates portability. Its filename usually ends in <code class="docutils literal notranslate"><span class="pre">.gpkg</span></code>. Applications such as QGIS (2.12 and up), R and ArcGIS will recognize this format (ArcGIS version 10.2.2 and above will read the file from ArcCatalog but requires a script to create a GeoPackage).</p>
</div>
<div class="section" id="shapefile">
<h4>Shapefile<a class="headerlink" href="#shapefile" title="Permalink to this headline">#</a></h4>
<p>A <strong>shapefile</strong> is a file-based data format native to ArcView 3.x software (a much older version of ArcMap). Conceptually, a shapefile is a feature class–it stores a collection of features that have the same geometry type (point, line, or polygon), the same attributes, and a common spatial extent.</p>
<p>Despite what its name may imply, a “single” shapefile is actually composed of at least three files, and as many as eight. Each file that makes up a “shapefile” has a common filename but different extension type.</p>
<p>The list of files that define a “shapefile” are shown in the following table. Note that each file has a specific role in defining a shapefile.</p>
<table class="colwidths-auto docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>File extension</p></th>
<th class="head"><p>Content</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>.dbf</p></td>
<td><p>Attribute information</p></td>
</tr>
<tr class="row-odd"><td><p>.shp</p></td>
<td><p>Feature geometry</p></td>
</tr>
<tr class="row-even"><td><p>.shx</p></td>
<td><p>Feature geometry index</p></td>
</tr>
<tr class="row-odd"><td><p>.aih</p></td>
<td><p>Attribute index</p></td>
</tr>
<tr class="row-even"><td><p>.ain</p></td>
<td><p>Attribute index</p></td>
</tr>
<tr class="row-odd"><td><p>.prj</p></td>
<td><p>Coordinate system information</p></td>
</tr>
<tr class="row-even"><td><p>.sbn</p></td>
<td><p>Spatial index file</p></td>
</tr>
<tr class="row-odd"><td><p>.sbx</p></td>
<td><p>Spatial index file</p></td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="file-geodatabase">
<h4>File Geodatabase<a class="headerlink" href="#file-geodatabase" title="Permalink to this headline">#</a></h4>
<p>A <strong>file geodatabase</strong> is a relational database storage format. It’s a far more complex data structure than the shapefile and consists of a <strong>.gdb</strong> folder housing dozens of files. Its complexity renders it more versatile allowing it to store multiple feature classes and enabling topological definitions (i.e. allowing the user to define rules that govern the way different feature classes relate to one another). An example of the contents of a geodatabase is shown in the following figure.</p>
<div class="figure align-default" id="geodatabase">
<img alt="../_images/geodatabase.jpg" src="../_images/geodatabase.jpg" />
</div>
</div>
</div>
<div class="section" id="raster-data-file-formats">
<h3>Raster Data File Formats<a class="headerlink" href="#raster-data-file-formats" title="Permalink to this headline">#</a></h3>
<p>Rasters are in part defined by their pixel depth. Pixel depth defines the range of distinct values the raster can store. For example, a 1-bit raster can only store 2 distinct values: 0 and 1.</p>
<div class="figure align-default" id="pixel-depth">
<img alt="../_images/raster_storage.png" src="../_images/raster_storage.png" />
<p class="caption"><span class="caption-number">Fig. 5 </span><span class="caption-text">Pixel depth allows for a wider range of values but also take up more space</span><a class="headerlink" href="#pixel-depth" title="Permalink to this image">#</a></p>
</div>
<p>There is a wide range of raster file formats used in the GIS world. Some of the most popular ones are listed below.</p>
<div class="section" id="imagine">
<h4>Imagine<a class="headerlink" href="#imagine" title="Permalink to this headline">#</a></h4>
<p>The <strong>Imagine</strong> file format was originally created by an image processing software company called ERDAS. This file format consists of a single <strong>.img</strong> file. This is a simpler file format than the shapefile. It is sometimes accompanied by an .xml file which usually stores metadata information about the raster layer.</p>
</div>
<div class="section" id="geotiff">
<h4>GeoTiff<a class="headerlink" href="#geotiff" title="Permalink to this headline">#</a></h4>
<p>A popular public domain raster data format is the <strong>GeoTIFF</strong> format. If maximum portability and platform independence is important, this file format may be a good choice.</p>
</div>
<div class="section" id="id1">
<h4>File Geodatabase<a class="headerlink" href="#id1" title="Permalink to this headline">#</a></h4>
<p>A raster file can also be stored in a file geodatabase alongside vector files. Geodatabases have the benefit of defining image mosaic structures thus allowing the user to create “stitched” images from multiple image files stored in the geodatabase. Also, processing very large raster files can be computationally more efficient when stored in a file geodatabase as opposed to an Imagine or GeoTiff file format.</p>
</div>
</div>
</div>
<span id="document-docs/c_vectors"></span><hr class="docutils" id="c-vectors" />
<div class="admonition-learning-objectives admonition">
<p class="admonition-title">Learning Objectives</p>
<ul class="simple">
<li><p>Create a Geopandas GeoSeries and Dataframe</p></li>
<li><p>Plot a basic map</p></li>
</ul>
</div>
<div class="admonition-review admonition">
<p class="admonition-title">Review</p>
<ul class="simple">
<li><p><a class="reference internal" href="docs/a_intro.html#document-docs/c_features"><span class="doc std std-doc">Data Structures</span></a></p></li>
</ul>
</div>
<hr class="docutils" />
<div class="tex2jax_ignore mathjax_ignore section" id="spatial-vector-data">
<h2>Spatial Vector Data<a class="headerlink" href="#spatial-vector-data" title="Permalink to this headline">#</a></h2>
<div class="section" id="intro-to-geopandas">
<h3>Intro to GeoPandas<a class="headerlink" href="#intro-to-geopandas" title="Permalink to this headline">#</a></h3>
<p>The goal of GeoPandas is to make working with spatial data in python easier. It combines the capabilities of pandas and shapely, providing spatial operations in pandas and a high-level interface to multiple geometries to shapely. GeoPandas enables you to easily do operations in python that would otherwise require a spatial database such as PostGIS.</p>
</div>
<div class="section" id="data-structures">
<h3>Data Structures<a class="headerlink" href="#data-structures" title="Permalink to this headline">#</a></h3>
<p>GeoPandas implements two main data structures, a <code class="docutils literal notranslate"><span class="pre">GeoSeries</span></code> and a <code class="docutils literal notranslate"><span class="pre">GeoDataFrame</span></code>. These are subclasses of pandas Series and DataFrame, respectively.</p>
<div class="section" id="geoseries">
<h4>GeoSeries<a class="headerlink" href="#geoseries" title="Permalink to this headline">#</a></h4>
<p>A <code class="docutils literal notranslate"><span class="pre">GeoSeries</span></code> is essentially a vector where each entry in the vector is a set of shapes corresponding to one observation. An entry may consist of only one shape (like a single polygon) or multiple shapes that are meant to be thought of as one observation (like the many polygons that make up the State of Hawaii or a country like Indonesia).</p>
<p>geopandas has three basic classes of geometric objects (which are actually shapely objects):</p>
<ul class="simple">
<li><p>Points / Multi-Points</p></li>
<li><p>Lines / Multi-Lines</p></li>
<li><p>Polygons / Multi-Polygons</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">geopandas</span>
<span class="kn">from</span> <span class="nn">shapely.geometry</span> <span class="kn">import</span> <span class="n">Point</span>
<span class="n">s</span> <span class="o">=</span> <span class="n">geopandas</span><span class="o">.</span><span class="n">GeoSeries</span><span class="p">([</span><span class="n">Point</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">Point</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">Point</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)])</span>
<span class="n">s</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0    POINT (1.00000 1.00000)
1    POINT (2.00000 2.00000)
2    POINT (3.00000 3.00000)
dtype: geometry
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">shapely.geometry</span> <span class="kn">import</span> <span class="n">LineString</span>
<span class="n">l</span><span class="o">=</span> <span class="n">geopandas</span><span class="o">.</span><span class="n">GeoSeries</span><span class="p">([</span><span class="n">LineString</span><span class="p">([</span><span class="n">Point</span><span class="p">(</span><span class="o">-</span><span class="mf">77.036873</span><span class="p">,</span><span class="mf">38.907192</span><span class="p">),</span> <span class="n">Point</span><span class="p">(</span><span class="o">-</span><span class="mf">76.612190</span><span class="p">,</span><span class="mf">39.290386</span><span class="p">,),</span> <span class="n">Point</span><span class="p">(</span><span class="o">-</span><span class="mf">77.408456</span><span class="p">,</span><span class="mf">39.412006</span><span class="p">)])])</span>
<span class="n">l</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0    LINESTRING (-77.03687 38.90719, -76.61219 39.2...
dtype: geometry
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">shapely.geometry</span> <span class="kn">import</span> <span class="n">Polygon</span>
<span class="n">p</span><span class="o">=</span> <span class="n">geopandas</span><span class="o">.</span><span class="n">GeoSeries</span><span class="p">([</span><span class="n">Polygon</span><span class="p">([</span><span class="n">Point</span><span class="p">(</span><span class="o">-</span><span class="mf">77.036873</span><span class="p">,</span><span class="mf">38.907192</span><span class="p">),</span> <span class="n">Point</span><span class="p">(</span><span class="o">-</span><span class="mf">76.612190</span><span class="p">,</span><span class="mf">39.290386</span><span class="p">,),</span> <span class="n">Point</span><span class="p">(</span><span class="o">-</span><span class="mf">77.408456</span><span class="p">,</span><span class="mf">39.412006</span><span class="p">)])])</span>
<span class="n">p</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0    POLYGON ((-77.03687 38.90719, -76.61219 39.290...
dtype: geometry
</pre></div>
</div>
</div>
</div>
<p>Note that all entries in a <code class="docutils literal notranslate"><span class="pre">GeoSeries</span></code> need not be of the same geometric type, although certain export operations will fail if this is not the case.</p>
</div>
<div class="section" id="geodataframe">
<h4>GeoDataFrame<a class="headerlink" href="#geodataframe" title="Permalink to this headline">#</a></h4>
<p>A <code class="docutils literal notranslate"><span class="pre">GeoDataFrame</span></code> is a tabular data structure that contains a <code class="docutils literal notranslate"><span class="pre">GeoSeries</span></code>.</p>
<p>The most important property of a <code class="docutils literal notranslate"><span class="pre">GeoDataFrame</span></code> is that it always has one <code class="docutils literal notranslate"><span class="pre">GeoSeries</span></code> column that holds a special status. This <code class="docutils literal notranslate"><span class="pre">GeoSeries</span></code> is referred to as the <code class="docutils literal notranslate"><span class="pre">GeoDataFrame’s</span></code> “geometry”. When a spatial method is applied to a <code class="docutils literal notranslate"><span class="pre">GeoDataFrame</span></code> (or a spatial attribute like area is called), this commands will always act on the “geometry” column.</p>
<p>The “geometry” column – no matter its name – can be accessed through the geometry attribute (gdf.geometry), and the name of the geometry column can be found by typing <a class="reference external" href="http://gdf.geometry.name">gdf.geometry.name</a>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>A <code class="docutils literal notranslate"><span class="pre">GeoDataFrame</span></code> may also contain other columns with geometrical (shapely) objects, but only one column can be the active geometry at a time. To change which column is the active geometry column, use the <code class="docutils literal notranslate"><span class="pre">GeoDataFrame.set_geometry()</span></code> method.</p>
</div>
<p>An example using the worlds <code class="docutils literal notranslate"><span class="pre">GeoDataFrame</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">world</span> <span class="o">=</span> <span class="n">geopandas</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">geopandas</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">get_path</span><span class="p">(</span><span class="s1">&#39;naturalearth_lowres&#39;</span><span class="p">))</span>
<span class="n">world</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>pop_est</th>
      <th>continent</th>
      <th>name</th>
      <th>iso_a3</th>
      <th>gdp_md_est</th>
      <th>geometry</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>920938</td>
      <td>Oceania</td>
      <td>Fiji</td>
      <td>FJI</td>
      <td>8374.0</td>
      <td>MULTIPOLYGON (((180.00000 -16.06713, 180.00000...</td>
    </tr>
    <tr>
      <th>1</th>
      <td>53950935</td>
      <td>Africa</td>
      <td>Tanzania</td>
      <td>TZA</td>
      <td>150600.0</td>
      <td>POLYGON ((33.90371 -0.95000, 34.07262 -1.05982...</td>
    </tr>
    <tr>
      <th>2</th>
      <td>603253</td>
      <td>Africa</td>
      <td>W. Sahara</td>
      <td>ESH</td>
      <td>906.5</td>
      <td>POLYGON ((-8.66559 27.65643, -8.66512 27.58948...</td>
    </tr>
    <tr>
      <th>3</th>
      <td>35623680</td>
      <td>North America</td>
      <td>Canada</td>
      <td>CAN</td>
      <td>1674000.0</td>
      <td>MULTIPOLYGON (((-122.84000 49.00000, -122.9742...</td>
    </tr>
    <tr>
      <th>4</th>
      <td>326625791</td>
      <td>North America</td>
      <td>United States of America</td>
      <td>USA</td>
      <td>18560000.0</td>
      <td>MULTIPOLYGON (((-122.84000 49.00000, -120.0000...</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">world</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;AxesSubplot:&gt;
</pre></div>
</div>
<img alt="../_images/c_vectors_6_1.png" src="../_images/c_vectors_6_1.png" />
</div>
</div>
</div>
</div>
</div>
<span id="document-docs/c_new_vectors"></span><hr class="docutils" id="c-new-vectors" />
<div class="admonition-learning-objectives admonition">
<p class="admonition-title">Learning Objectives</p>
<ul class="simple">
<li><p>Create new spatial objects (points, lines, polygons)</p></li>
<li><p>Assign the correct projection or CRS</p></li>
<li><p>Create points from a table or csv of lat and lon</p></li>
</ul>
</div>
<div class="admonition-review admonition">
<p class="admonition-title">Review</p>
<ul class="simple">
<li><p><a class="reference internal" href="docs/a_intro.html#document-docs/d_crs_what_is_it"><span class="doc std std-doc">CRS what is it?</span></a></p></li>
<li><p><a class="reference internal" href="docs/a_intro.html#document-docs/d_understand_crs_codes"><span class="doc std std-doc">Understand CRS codes</span></a></p></li>
<li><p><a class="reference internal" href="docs/a_intro.html#document-docs/c_vectors"><span class="doc std std-doc">Vector data structures</span></a></p></li>
<li><p><a class="reference external" href="https://geojson.io/">Find Lat Lon of your own points, lines, polygons</a></p></li>
</ul>
</div>
<hr class="docutils" />
<div class="tex2jax_ignore mathjax_ignore section" id="spatial-points-lines-polygons-in-python">
<h2>Spatial Points Lines Polygons in Python<a class="headerlink" href="#spatial-points-lines-polygons-in-python" title="Permalink to this headline">#</a></h2>
<p>We often find ourselves in a situation where we need to generate new spatial data from scratch, or need to better understand how our data is constructed. This lesson will walk you through some of the most common forms of data generation.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Import necessary modules first</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">geopandas</span> <span class="k">as</span> <span class="nn">gpd</span>
<span class="kn">from</span> <span class="nn">shapely.geometry</span> <span class="kn">import</span> <span class="n">Point</span><span class="p">,</span> <span class="n">LineString</span><span class="p">,</span> <span class="n">Polygon</span>
<span class="kn">import</span> <span class="nn">fiona</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;bmh&#39;</span><span class="p">)</span> <span class="c1"># better for plotting geometries vs general plots.</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="creating-geodataframe-geometries">
<h3>Creating GeoDataFrame Geometries<a class="headerlink" href="#creating-geodataframe-geometries" title="Permalink to this headline">#</a></h3>
<p>A <code class="docutils literal notranslate"><span class="pre">GeoDataFrame</span></code> object is a <code class="docutils literal notranslate"><span class="pre">pandas.DataFrame</span></code> that has a column with geometry. An empty <code class="docutils literal notranslate"><span class="pre">GeoDataFrame</span></code> is just that, empty, essentially just like the pandas one. Let’s create an empty <code class="docutils literal notranslate"><span class="pre">GeoDataFrame</span></code> and create a new column called geometry that will contain our Shapely objects:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create an empty geopandas GeoDataFrame</span>
<span class="n">newdata</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">newdata</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Empty GeoDataFrame
Columns: []
Index: []
</pre></div>
</div>
</div>
</div>
<p>In order to have a working spatial dataframe we need define a few things:</p>
<div class="section" id="geodataframe-components">
<h4>GeoDataFrame Components<a class="headerlink" href="#geodataframe-components" title="Permalink to this headline">#</a></h4>
<ul class="simple">
<li><p>data: a pandas.DataFrame, dictionary, or empty list [] containing an desired attribute data. Use [] if no data is</p></li>
<li><p>crs:  Coordinate Reference System of the geometry objects. Can be anything accepted by <code class="docutils literal notranslate"><span class="pre">pyproj.CRS.from_user_input()</span></code>, such as an authority string (eg “EPSG:4326”) or a WKT string.</p></li>
<li><p>geometry:  Column name in a DataFrame to use as geometry or Shapely point, line, or polygon object.</p></li>
</ul>
<p>Since geopandas takes advantage of Shapely geometric objects it is possible to create a Shapefile from a scratch by passing Shapely’s geometric objects into the GeoDataFrame. This is useful as it makes it easy to convert e.g. a text file that contains coordinates into a Shapefile.</p>
<p>Now we have a geometry column in our GeoDataFrame but we don’t have any data yet.</p>
</div>
<div class="section" id="create-points-from-list-of-coordinates">
<h4>Create Points from list of coordinates<a class="headerlink" href="#create-points-from-list-of-coordinates" title="Permalink to this headline">#</a></h4>
<p>Creating geopandas point objects is a snap! All we need is a coordinate pair from which we generate a Shapely point geometry object, we then create a dictionary that holds that geometry and any attributes we want, and a coordinate reference system. In this case we use a <a class="reference internal" href="docs/a_intro.html#document-docs/d_understand_crs_codes"><span class="doc std std-doc">ESPG code</span></a>.<br />
<span class="xref myst">Click here for a more detailed explanation of this process</span></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Coordinates of the GW department of geography in Decimal Degrees</span>
<span class="n">coordinate</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">77.04639494419096</span><span class="p">,</span>  <span class="mf">38.89934963421794</span><span class="p">]</span>

<span class="c1"># Create a Shapely point from a coordinate pair</span>
<span class="n">point_coord</span> <span class="o">=</span> <span class="n">Point</span><span class="p">(</span><span class="n">coordinate</span><span class="p">)</span>

<span class="c1"># create a dataframe with needed attributes and required geometry column</span>
<span class="n">df</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;GWU&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Dept Geography&#39;</span><span class="p">],</span> <span class="s1">&#39;geometry&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">point_coord</span><span class="p">]}</span>

<span class="c1"># Convert shapely object to a geodataframe </span>
<span class="n">point</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">geometry</span><span class="o">=</span><span class="s1">&#39;geometry&#39;</span><span class="p">,</span> <span class="n">crs</span> <span class="o">=</span><span class="s2">&quot;EPSG:4326&quot;</span><span class="p">)</span>

<span class="c1"># Let&#39;s see what we have</span>
<span class="n">point</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;AxesSubplot:&gt;
</pre></div>
</div>
<img alt="../_images/c_new_vectors_5_1.png" src="../_images/c_new_vectors_5_1.png" />
</div>
</div>
<p>We can apply the same process to a set of points stored in a pandas dataframe.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># list of attributes and coordinates</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="p">{</span><span class="s1">&#39;City&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Buenos Aires&#39;</span><span class="p">,</span> <span class="s1">&#39;Brasilia&#39;</span><span class="p">,</span> <span class="s1">&#39;Santiago&#39;</span><span class="p">,</span> <span class="s1">&#39;Bogota&#39;</span><span class="p">,</span> <span class="s1">&#39;Caracas&#39;</span><span class="p">],</span>
     <span class="s1">&#39;Country&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Argentina&#39;</span><span class="p">,</span> <span class="s1">&#39;Brazil&#39;</span><span class="p">,</span> <span class="s1">&#39;Chile&#39;</span><span class="p">,</span> <span class="s1">&#39;Colombia&#39;</span><span class="p">,</span> <span class="s1">&#39;Venezuela&#39;</span><span class="p">],</span>
     <span class="s1">&#39;lat&#39;</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mf">34.58</span><span class="p">,</span> <span class="o">-</span><span class="mf">15.78</span><span class="p">,</span> <span class="o">-</span><span class="mf">33.45</span><span class="p">,</span> <span class="mf">4.60</span><span class="p">,</span> <span class="mf">10.48</span><span class="p">],</span>
     <span class="s1">&#39;lon&#39;</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mf">58.66</span><span class="p">,</span> <span class="o">-</span><span class="mf">47.91</span><span class="p">,</span> <span class="o">-</span><span class="mf">70.66</span><span class="p">,</span> <span class="o">-</span><span class="mf">74.08</span><span class="p">,</span> <span class="o">-</span><span class="mf">66.86</span><span class="p">]})</span>

<span class="c1"># Create a Shapely points from the coordinate-tuple list</span>
<span class="n">ply_coord</span> <span class="o">=</span> <span class="p">[</span><span class="n">Point</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">lon</span><span class="p">)]</span>

<span class="c1"># Convert shapely object to a geodataframe with a crs</span>
<span class="n">poly</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">geometry</span><span class="o">=</span><span class="n">ply_coord</span><span class="p">,</span> <span class="n">crs</span> <span class="o">=</span><span class="s2">&quot;EPSG:4326&quot;</span><span class="p">)</span>

<span class="c1"># Let&#39;s see what we have</span>
<span class="n">poly</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;AxesSubplot:&gt;
</pre></div>
</div>
<img alt="../_images/c_new_vectors_7_1.png" src="../_images/c_new_vectors_7_1.png" />
</div>
</div>
<p><a class="reference external" href="https://geopandas.org/gallery/create_geopandas_from_pandas.html">adapted from geopandas</a></p>
</div>
<div class="section" id="creating-points-from-csv-of-latitude-and-longitude-lat-lon">
<h4>Creating Points from csv of latitude and longitude (lat, lon)<a class="headerlink" href="#creating-points-from-csv-of-latitude-and-longitude-lat-lon" title="Permalink to this headline">#</a></h4>
<p>One of the most common data creation tasks is creating a shapefile from a list of points or a <code class="docutils literal notranslate"><span class="pre">.csv</span></code> file. Luckily getting this data into usable format is easy enough.</p>
<p>First we have to create an example <code class="docutils literal notranslate"><span class="pre">.csv</span></code> dataset to work from:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="c1"># create an outline of Washington DC and write to csv</span>
<span class="n">path_to_csv</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;../temp/points.csv&#39;</span>
<span class="n">points</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Corner&#39;</span><span class="p">:[</span><span class="s1">&#39;N&#39;</span><span class="p">,</span><span class="s1">&#39;E&#39;</span><span class="p">,</span><span class="s1">&#39;S&#39;</span><span class="p">,</span><span class="s1">&#39;W&#39;</span><span class="p">],</span>
          <span class="s1">&#39;lon&#39;</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mf">77.0412826538086</span><span class="p">,</span> <span class="o">-</span><span class="mf">77.11681365966797</span><span class="p">,</span> <span class="o">-</span><span class="mf">77.01896667480469</span><span class="p">,</span> <span class="o">-</span><span class="mf">77.0412826538086</span><span class="p">],</span> 
          <span class="s1">&#39;lat&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">38.99570671505043</span><span class="p">,</span> <span class="mf">38.936713143230044</span><span class="p">,</span> <span class="mf">38.807610542357594</span><span class="p">,</span> <span class="mf">38.99570671505043</span><span class="p">]}</span>
<span class="n">points</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">points</span><span class="p">)</span>
<span class="n">points</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">path_to_csv</span><span class="p">)</span>              
</pre></div>
</div>
</div>
</div>
<p>To create a <code class="docutils literal notranslate"><span class="pre">geodataframe</span></code> from our data you simply need to read it back in, an specify the geometry column values using <code class="docutils literal notranslate"><span class="pre">points_from_xy</span></code> pointing it to the correct columns of <code class="docutils literal notranslate"><span class="pre">df</span></code>, namely <code class="docutils literal notranslate"><span class="pre">df.lon</span></code> anf <code class="docutils literal notranslate"><span class="pre">df.lat</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># read the point data in </span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">path_to_csv</span><span class="p">)</span>

<span class="c1"># Create a geodataframe from the data using and &#39;EPSG&#39; code to assign WGS84 coordinate reference system</span>
<span class="n">points</span><span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">geometry</span><span class="o">=</span><span class="n">gpd</span><span class="o">.</span><span class="n">points_from_xy</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">lon</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">lat</span><span class="p">),</span> <span class="n">crs</span> <span class="o">=</span> <span class="s1">&#39;EPSG:4326&#39;</span><span class="p">)</span>
<span class="n">points</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Unnamed: 0</th>
      <th>Corner</th>
      <th>lon</th>
      <th>lat</th>
      <th>geometry</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>N</td>
      <td>-77.041283</td>
      <td>38.995707</td>
      <td>POINT (-77.04128 38.99571)</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>E</td>
      <td>-77.116814</td>
      <td>38.936713</td>
      <td>POINT (-77.11681 38.93671)</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2</td>
      <td>S</td>
      <td>-77.018967</td>
      <td>38.807611</td>
      <td>POINT (-77.01897 38.80761)</td>
    </tr>
    <tr>
      <th>3</th>
      <td>3</td>
      <td>W</td>
      <td>-77.041283</td>
      <td>38.995707</td>
      <td>POINT (-77.04128 38.99571)</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>In this case <code class="docutils literal notranslate"><span class="pre">points_from_xy()</span></code> was used to transform lat and lon into a list of <code class="docutils literal notranslate"><span class="pre">shapely.Point</span></code> objects. This then is used as the geometry for the GeoDataFrame. (<code class="docutils literal notranslate"><span class="pre">points_from_xy()</span></code> is simply an enhanced wrapper for <code class="docutils literal notranslate"><span class="pre">[Point(x,</span> <span class="pre">y)</span> <span class="pre">for</span> <span class="pre">x,</span> <span class="pre">y</span> <span class="pre">in</span> <span class="pre">zip(df.lon,</span> <span class="pre">df.lat)]</span></code>)</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<ul class="simple">
<li><p>Although we say “lat lon” python uses “lon lat” instead, this follows the preference for using x,y for notation.</p></li>
<li><p>Typically, like the data above, these data are stored in WGS84 lat lon, but be sure to check this, another common format is UTM coordinates (look for values around 500,000 east to west and measured in meters)</p></li>
</ul>
</div>
</div>
<div class="section" id="creating-spatial-lines">
<h4>Creating Spatial lines<a class="headerlink" href="#creating-spatial-lines" title="Permalink to this headline">#</a></h4>
<p>Following the examples above we can specify lines easily. In this case let’s say we have lines tracking three people riding their bikes through town. We keep track of their unique id <code class="docutils literal notranslate"><span class="pre">ID</span></code>, their location <code class="docutils literal notranslate"><span class="pre">X,Y</span></code>, and their <code class="docutils literal notranslate"><span class="pre">Speed</span></code>, and read in the data below:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">StringIO</span> 
<span class="n">data</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">ID,X,Y,Speed</span>
<span class="s2">1,  -87.789,  41.976,  16</span>
<span class="s2">1,  -87.482,  41.677,  17</span>
<span class="s2">2,  -87.739,  41.876,  16</span>
<span class="s2">2,  -87.681,  41.798,  16</span>
<span class="s2">2,  -87.599,  41.708,  16</span>
<span class="s2">3,  -87.599,  41.908,  17</span>
<span class="s2">3,  -87.598,  41.708,  17</span>
<span class="s2">3,  -87.643,  41.675,  17</span>
<span class="s2">&quot;&quot;&quot;</span>
<span class="c1"># use StringIO to read in text chunk</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_table</span><span class="p">(</span><span class="n">StringIO</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s convert these to points and take a look. Notice that points are not a good replacement for lines in the case, we have three individuals, and they need to be treated separately.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#zip the coordinates into a point object and convert to a GeoData Frame</span>
<span class="n">points</span> <span class="o">=</span> <span class="p">[</span><span class="n">Point</span><span class="p">(</span><span class="n">xy</span><span class="p">)</span> <span class="k">for</span> <span class="n">xy</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">Y</span><span class="p">)]</span>
<span class="n">geo_df</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">geometry</span><span class="o">=</span><span class="n">points</span><span class="p">,</span> <span class="n">crs</span> <span class="o">=</span> <span class="s1">&#39;EPSG:4326&#39;</span><span class="p">)</span>
<span class="n">geo_df</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;AxesSubplot:&gt;
</pre></div>
</div>
<img alt="../_images/c_new_vectors_15_1.png" src="../_images/c_new_vectors_15_1.png" />
</div>
</div>
<p>Now let’s tread these data as lines, we can take advantage of the column <code class="docutils literal notranslate"><span class="pre">ID</span></code> to <code class="docutils literal notranslate"><span class="pre">.groupby</span></code>. Luckily geopandas <code class="docutils literal notranslate"><span class="pre">.groupby</span></code> is consistent with the use in pandas. So here we <code class="docutils literal notranslate"><span class="pre">.groupby(['ID'])</span></code>, for each <code class="docutils literal notranslate"><span class="pre">ID</span></code> group we convert the values to a list, and store it in a Fiona <code class="docutils literal notranslate"><span class="pre">LineString</span></code> object.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># treat each `ID` group of points as a line</span>
<span class="n">lines</span> <span class="o">=</span> <span class="n">geo_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;ID&#39;</span><span class="p">])[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span>  <span class="n">LineString</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">tolist</span><span class="p">()))</span>

<span class="c1"># store as a GeodataFrame and add &#39;ID&#39; as a column (currently stored as the &#39;index&#39;)</span>
<span class="n">lines</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">geometry</span><span class="o">=</span><span class="s1">&#39;geometry&#39;</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="s2">&quot;EPSG:4326&quot;</span><span class="p">)</span> 
<span class="n">lines</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">lines</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">column</span><span class="o">=</span><span class="s1">&#39;ID&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;AxesSubplot:&gt;
</pre></div>
</div>
<img alt="../_images/c_new_vectors_17_1.png" src="../_images/c_new_vectors_17_1.png" />
</div>
</div>
<p>Now we can see that each line is treated separately by <code class="docutils literal notranslate"><span class="pre">ID</span></code>, and plot them using <code class="docutils literal notranslate"><span class="pre">.plot(column='ID')</span></code>.</p>
</div>
<div class="section" id="creating-spatial-polygons">
<h4>Creating Spatial Polygons<a class="headerlink" href="#creating-spatial-polygons" title="Permalink to this headline">#</a></h4>
<p>Creating a polyon in geopandas is very similiar to the other exercises. First we create a Fiona geometry object from our coordinates, add that to a dataframe with any attributes and then create a <code class="docutils literal notranslate"><span class="pre">GeoDataFrame</span></code> with an assigned coordinate reference system (CRS).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># list of coordindate pairs</span>
<span class="n">coordinates</span> <span class="o">=</span> <span class="p">[[</span> <span class="o">-</span><span class="mf">77.0412826538086</span><span class="p">,</span> <span class="mf">38.99570671505043</span> <span class="p">],</span> <span class="p">[</span> <span class="o">-</span><span class="mf">77.11681365966797</span><span class="p">,</span> <span class="mf">38.936713143230044</span> <span class="p">],</span> <span class="p">[</span> <span class="o">-</span><span class="mf">77.01896667480469</span><span class="p">,</span> <span class="mf">38.807610542357594</span><span class="p">],</span>
               <span class="p">[</span><span class="o">-</span><span class="mf">76.90910339355469</span><span class="p">,</span>  <span class="mf">38.892636142310295</span><span class="p">]]</span>           

<span class="c1"># Create a Shapely polygon from the coordinate-tuple list</span>
<span class="n">ply_coord</span> <span class="o">=</span> <span class="n">Polygon</span><span class="p">(</span><span class="n">coordinates</span><span class="p">)</span>

<span class="c1"># create a dictionary with needed attributes and required geometry column</span>
<span class="n">df</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Attribute&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;name1&#39;</span><span class="p">],</span> <span class="s1">&#39;geometry&#39;</span><span class="p">:</span> <span class="n">ply_coord</span><span class="p">}</span>

<span class="c1"># Convert shapely object to a geodataframe </span>
<span class="n">poly</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">geometry</span><span class="o">=</span><span class="s1">&#39;geometry&#39;</span><span class="p">,</span> <span class="n">crs</span> <span class="o">=</span><span class="s2">&quot;EPSG:4326&quot;</span><span class="p">)</span>

<span class="c1"># Let&#39;s see what we have</span>
<span class="n">poly</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;AxesSubplot:&gt;
</pre></div>
</div>
<img alt="../_images/c_new_vectors_19_1.png" src="../_images/c_new_vectors_19_1.png" />
</div>
</div>
</div>
<div class="section" id="creating-spatial-points-admittedly-the-long-way">
<span id="e-points-the-long-way"></span><h4>Creating Spatial Points (admittedly the long way)<a class="headerlink" href="#creating-spatial-points-admittedly-the-long-way" title="Permalink to this headline">#</a></h4>
<p>Since geopandas takes advantage of Shapely geometric objects it is possible to create a Shapefile from a scratch by passing Shapely’s geometric objects into the GeoDataFrame. This is useful as it makes it easy to convert e.g. a text file that contains coordinates into a Shapefile.</p>
<p>Let’s create an empty <code class="docutils literal notranslate"><span class="pre">GeoDataFrame</span></code> and create a new column called geometry that will contain our Shapely objects:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create an empty geopandas GeoDataFrame</span>
<span class="n">newdata</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">()</span>
<span class="c1"># Create a new column called &#39;geometry&#39; to the GeoDataFrame</span>
<span class="n">newdata</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

<span class="nb">print</span><span class="p">(</span><span class="n">newdata</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Empty GeoDataFrame
Columns: [geometry]
Index: []
</pre></div>
</div>
</div>
</div>
<p>Let’s create a Shapely Point representing the GWU Department of Geography that we can insert to our GeoDataFrame:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Coordinates of the GW department of geography in Decimal Degrees</span>
<span class="n">coordinates</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">77.04639494419096</span><span class="p">,</span>  <span class="mf">38.89934963421794</span><span class="p">)</span>

<span class="c1"># Create a Shapely polygon from the coordinate-tuple list</span>
<span class="n">point</span> <span class="o">=</span> <span class="n">Point</span><span class="p">(</span><span class="n">coordinates</span><span class="p">)</span>

<span class="c1"># Let&#39;s see what we have</span>
<span class="n">point</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/c_new_vectors_23_0.svg" src="../_images/c_new_vectors_23_0.svg" /></div>
</div>
<p>Okay, so now we have appropriate Polygon -object.</p>
<p>Let’s insert the polygon into our ‘geometry’ column in our GeoDataFrame:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Insert the polygon into &#39;geometry&#39; -column at index 0</span>
<span class="n">newdata</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;geometry&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">point</span>

<span class="c1"># Let&#39;s see what we have now</span>
<span class="n">newdata</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>geometry</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>POINT (-77.04639 38.89935)</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Now we have a GeoDataFrame with Point that we can export to a Shapefile.</p>
<p>Let’s add another column to our GeoDataFrame called Location with text GWU Geography.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Add a new column and insert data</span>
<span class="n">newdata</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;Location&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;GWU Geography&#39;</span>

<span class="c1"># Let&#39;s check the data</span>
<span class="n">newdata</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>geometry</th>
      <th>Location</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>POINT (-77.04639 38.89935)</td>
      <td>GWU Geography</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Okay, now we have additional information that is useful to be able to recognize what the feature represents.</p>
<p>Before exporting the data it is useful to determine the coordinate reference system (CRS, ‘projection’) for the GeoDataFrame.</p>
<p>GeoDataFrame has a property called <code class="docutils literal notranslate"><span class="pre">.crs</span></code> that (<a class="reference internal" href="docs/a_intro.html#document-docs/d_understand_crs_codes"><span class="doc std std-doc">review here</span></a>) shows the coordinate system of the data which is empty (None) in our case since we are creating the data from the scratch (e.g. <code class="docutils literal notranslate"><span class="pre">newdata.crs</span></code> returns <code class="docutils literal notranslate"><span class="pre">None</span></code>).</p>
<p>Let’s add a crs for our GeoDataFrame. A Python module called fiona has a nice function called from_epsg() for passing coordinate system for the GeoDataFrame. Next we will use that and determine the projection to WGS84 (epsg code: 4326) which is the most common choice for lat lon CRSs:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Import specific function &#39;from_epsg&#39; from fiona module</span>
<span class="kn">from</span> <span class="nn">fiona.crs</span> <span class="kn">import</span> <span class="n">from_epsg</span>

<span class="c1"># Set the GeoDataFrame&#39;s coordinate system to WGS84</span>
<span class="n">newdata</span><span class="o">.</span><span class="n">crs</span> <span class="o">=</span> <span class="n">from_epsg</span><span class="p">(</span><span class="n">code</span> <span class="o">=</span> <span class="mi">4326</span><span class="p">)</span>

<span class="c1"># Let&#39;s see how the crs definition looks like</span>
<span class="n">newdata</span><span class="o">.</span><span class="n">crs</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/home/mmann1123/anaconda3/envs/pygisbookgw/lib/python3.7/site-packages/pyproj/crs/crs.py:68: FutureWarning: &#39;+init=&lt;authority&gt;:&lt;code&gt;&#39; syntax is deprecated. &#39;&lt;authority&gt;:&lt;code&gt;&#39; is the preferred initialization method. When making the change, be mindful of axis order changes: https://pyproj4.github.io/pyproj/stable/gotchas.html#axis-order-changes-in-proj-6
  return _prepare_from_string(&quot; &quot;.join(pjargs))
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;Geographic 2D CRS: +init=epsg:4326 +no_defs +type=crs&gt;
Name: WGS 84
Axis Info [ellipsoidal]:
- lon[east]: Longitude (degree)
- lat[north]: Latitude (degree)
Area of Use:
- name: World.
- bounds: (-180.0, -90.0, 180.0, 90.0)
Datum: World Geodetic System 1984
- Ellipsoid: WGS 84
- Prime Meridian: Greenwich
</pre></div>
</div>
</div>
</div>
<p>Finally, we can export the data using GeoDataFrames .to_file() -function. The function works similarly as numpy or pandas, but here we only need to provide the output path for the Shapefile. Easy isn’t it!:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Determine the output path for the Shapefile</span>
<span class="n">outfp</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;../temp/gwu_geog.shp&quot;</span>

<span class="c1"># Write the data into that Shapefile</span>
<span class="n">newdata</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span><span class="n">outfp</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Because GeoPandas are so intertwined spend the time to learn more about here <a class="reference external" href="https://pandas.pydata.org/pandas-docs/stable/user_guide/index.html">Pandas User Guide</a></p>
</div>
<hr class="docutils" />
<p><a class="reference external" href="https://automating-gis-processes.github.io/CSC18/lessons/L2/geopandas-basics.html#creating-geometries-into-a-geodataframe">Adapted from Intro to Python GIS</a></p>
</div>
</div>
</div>
<span id="document-docs/c_rasters"></span><hr class="docutils" id="c-rasters" />
<div class="admonition-learning-objectives admonition">
<p class="admonition-title">Learning Objectives</p>
<ul class="simple">
<li><p>Create new raster objects</p></li>
<li><p>Assign the correct projection or CRS</p></li>
</ul>
</div>
<div class="admonition-review admonition">
<p class="admonition-title">Review</p>
<ul class="simple">
<li><p><a class="reference internal" href="docs/a_intro.html#document-docs/d_affine"><span class="doc std std-doc">Please review Affine transformation</span></a></p></li>
</ul>
</div>
<hr class="docutils" />
<div class="tex2jax_ignore mathjax_ignore section" id="spatial-raster-data-in-python">
<h2>Spatial Raster Data in Python<a class="headerlink" href="#spatial-raster-data-in-python" title="Permalink to this headline">#</a></h2>
<p>A raster data model uses an array of cells, or pixels, to represent real-world objects. Raster datasets are commonly used for representing and managing imagery, surface temperatures, digital elevation models, and numerous other entities. A raster can be thought of as a special case of an area object where the area is divided into a regular grid of cells. But a regularly spaced array of marked points may be a better analogy since rasters are stored as an array of values where each cell is defined by a single coordinate pair inside of most GIS environments. Implicit in a raster data model is a value associated with each cell or pixel. This is in contrast to a vector model that may or may not have a value associated with the geometric primitive.</p>
<p>In order to work with raster data we will be using <code class="docutils literal notranslate"><span class="pre">rasterio</span></code> and later <code class="docutils literal notranslate"><span class="pre">geowombat</span></code>. Behind the scenes a <code class="docutils literal notranslate"><span class="pre">numpy.ndarray</span></code> does all the heavy lifting. To understand how raster works it helps to construct one from scratch.</p>
<p>Here we create two <code class="docutils literal notranslate"><span class="pre">ndarray</span></code> objects one <code class="docutils literal notranslate"><span class="pre">X</span></code> spans [-90°,90°] longitude, and <code class="docutils literal notranslate"><span class="pre">Y</span></code> covers [-90°,90°] latitude.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">90</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">90</span><span class="p">,</span> <span class="o">-</span><span class="mi">90</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
<span class="n">X</span><span class="p">,</span> <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<span class="n">X</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[-90., -54., -18.,  18.,  54.,  90.],
       [-90., -54., -18.,  18.,  54.,  90.],
       [-90., -54., -18.,  18.,  54.,  90.],
       [-90., -54., -18.,  18.,  54.,  90.],
       [-90., -54., -18.,  18.,  54.,  90.],
       [-90., -54., -18.,  18.,  54.,  90.]])
</pre></div>
</div>
</div>
</div>
<p>Let’s generate some data representing temperature and store it an array <code class="docutils literal notranslate"><span class="pre">Z</span></code></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="n">Z1</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(((</span><span class="n">X</span> <span class="o">-</span> <span class="mi">10</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">Y</span> <span class="o">-</span> <span class="mi">10</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">Z2</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(((</span><span class="n">X</span> <span class="o">+</span> <span class="mi">10</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">Y</span> <span class="o">+</span> <span class="mi">10</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.5</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">Z</span> <span class="o">=</span>  <span class="p">(</span><span class="n">Z1</span> <span class="o">-</span> <span class="n">Z2</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">Z</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Temperature&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/c_rasters_3_0.png" src="../_images/c_rasters_3_0.png" />
</div>
</div>
<p>Note that <em><code class="docutils literal notranslate"><span class="pre">Z</span></code> contains no data on its location</em>. Its just an array, the information stored in <code class="docutils literal notranslate"><span class="pre">x</span></code> and <code class="docutils literal notranslate"><span class="pre">y</span></code> aren’t associated with it at all. This location data will often be stored in the header of file. In order to ‘locate’ the array on the map we will use affine transformations.</p>
<div class="section" id="assigning-spatial-data-to-an-array-in-python">
<h3>Assigning spatial data to an array in python<a class="headerlink" href="#assigning-spatial-data-to-an-array-in-python" title="Permalink to this headline">#</a></h3>
<p>Ok we have an array of data and some coordinates for each cell, but how do we create a spatial dataset from it? In order to do this we need three components:</p>
<ol class="simple">
<li><p>An array of data and typically the xy coordinates</p></li>
<li><p>A coordinate reference system which defines what coordinate space we are using (e.g. degrees or meters, where is the prime meridian etc)</p></li>
<li><p>A transform defining the coordinate of the upper left hand corner and the cell resolution</p></li>
</ol>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>These topic is covered extensively in the next chapter. We will briefly introduce the topic here, but will go into the details later.</p>
<ul class="simple">
<li><p>For more info on transforms go <a class="reference internal" href="docs/a_intro.html#document-docs/d_raster_crs_intro"><span class="doc std std-doc">here</span></a>.</p></li>
<li><p>For more info on coordinate references systems go <a class="reference internal" href="docs/a_intro.html#document-docs/d_crs_what_is_it"><span class="doc std std-doc">here</span></a></p></li>
<li><p>or to understand CRS codes go <a class="reference internal" href="docs/a_intro.html#d-understand-crs-codes"><span class="std std-ref">here</span></a>.</p></li>
<li><p>To help bring it all together, read/writing rasters go to <a class="reference internal" href="docs/a_intro.html#document-docs/e_new_rasters"><span class="doc std std-doc">Reading &amp; Writing Rasters with Rasterio</span></a>.</p></li>
</ul>
</div>
<p>Once you have those components you can write out a working spatial raster dataset in python in a few lines of code. We just need to provide the information listed above in a format that rasterio understands.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">rasterio.transform</span> <span class="kn">import</span> <span class="n">Affine</span>
<span class="kn">import</span> <span class="nn">rasterio</span> <span class="k">as</span> <span class="nn">rio</span>

<span class="n">res</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="mf">240.0</span>
<span class="n">transform</span> <span class="o">=</span> <span class="n">Affine</span><span class="o">.</span><span class="n">translation</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">res</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">res</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">Affine</span><span class="o">.</span><span class="n">scale</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">res</span><span class="p">)</span>

<span class="c1"># open in &#39;write&#39; mode, unpack profile info to dst</span>
<span class="k">with</span> <span class="n">rio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span>
   <span class="s2">&quot;../temp/new_raster.tif&quot;</span><span class="p">,</span>
   <span class="s2">&quot;w&quot;</span><span class="p">,</span>
   <span class="n">driver</span><span class="o">=</span><span class="s2">&quot;GTiff&quot;</span><span class="p">,</span>         <span class="c1"># output file type</span>
   <span class="n">height</span><span class="o">=</span><span class="n">Z</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>      <span class="c1"># shape of array</span>
   <span class="n">width</span><span class="o">=</span><span class="n">Z</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
   <span class="n">count</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>                <span class="c1"># number of bands</span>
   <span class="n">dtype</span><span class="o">=</span><span class="n">Z</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>          <span class="c1"># output datatype</span>
   <span class="n">crs</span><span class="o">=</span><span class="s2">&quot;+proj=latlong&quot;</span><span class="p">,</span>    <span class="c1"># CRS</span>
   <span class="n">transform</span><span class="o">=</span><span class="n">transform</span><span class="p">,</span>    <span class="c1"># location and resolution of upper left cell</span>
<span class="p">)</span> <span class="k">as</span> <span class="n">dst</span><span class="p">:</span>
   <span class="c1"># check for number of bands</span>
   <span class="k">if</span> <span class="n">dst</span><span class="o">.</span><span class="n">count</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
       <span class="c1"># write single band</span>
       <span class="n">dst</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
   <span class="k">else</span><span class="p">:</span>
       <span class="c1"># write each band individually</span>
       <span class="k">for</span> <span class="n">band</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Z</span><span class="p">)):</span>
           <span class="c1"># write data, band # (starting from 1)</span>
           <span class="n">dst</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">Z</span><span class="p">[</span><span class="n">band</span><span class="p">],</span> <span class="n">band</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Raster data is often ‘multiband’ (e.g. red, green, blue), so I provided code that works for both multiband and single band data.</p>
<p>If you are storing multiband data the dimensions should be stored as (band, y, x ).</p>
<p>Read more about this here: <a class="reference internal" href="docs/a_intro.html#document-docs/e_new_rasters"><span class="doc std std-doc">Reading &amp; Writing Rasters with Rasterio</span></a></p>
</div>
</div>
</div>
</div>
<div class="toctree-wrapper compound">
<span id="document-docs/d_crs_what_is_it"></span><hr class="docutils" id="d-crs-what-is-it" />
<div class="admonition-learning-objectives admonition">
<p class="admonition-title">Learning Objectives</p>
<ul class="simple">
<li><p>Learn what a Coordinate Reference System (CRS) is</p></li>
<li><p>Learn about the properties of a CRS</p></li>
<li><p>Differentiate projected and geographic CRSs</p></li>
<li><p>Understand CRS impact on shape, area and distance</p></li>
</ul>
</div>
<div class="admonition-review admonition">
<p class="admonition-title">Review</p>
<ul class="simple">
<li><p><a class="reference internal" href="docs/a_intro.html#document-docs/d_affine"><span class="doc std std-doc">Affine Transforms</span></a></p></li>
</ul>
</div>
<hr class="docutils" />
<div class="tex2jax_ignore mathjax_ignore section" id="what-is-a-crs">
<h2>What is a CRS?<a class="headerlink" href="#what-is-a-crs" title="Permalink to this headline">#</a></h2>
<p>Implicit with any GIS data is a spatial reference system. It can consist of a simple arbitrary reference system such as a 10 m x 10 m sampling grid in a wood lot or, the boundaries of a soccer field or, it can consist of a geographic reference system, i.e. one where the spatial features are mapped to an earth based reference system. The focus of this topic is on earth reference systems which can be based on a Geographic Coordinate System (GCS) or a Project Coordinate System (PCS).</p>
<div class="section" id="geographic-coordinate-systems">
<h3>Geographic Coordinate Systems<a class="headerlink" href="#geographic-coordinate-systems" title="Permalink to this headline">#</a></h3>
<p>A geographic coordinate system is a reference system for identifying locations on the curved surface of the earth. Locations on the earth’s surface are measured in angular units from the center of the earth relative to two planes: the plane defined by the equator and the plane defined by the prime meridian (which crosses Greenwich England). A location is therefore defined by two values: a latitudinal value and a longitudinal value.</p>
<div class="figure align-default" id="lat-lon">
<img alt="../_images/lat_vs_lon.png" src="../_images/lat_vs_lon.png" />
<p class="caption"><span class="caption-number">Fig. 6 </span><span class="caption-text">Examples of latitudinal lines are shown on the left and examples of longitudinal lines are shown on the right. The 0° degree reference lines for each are shown in red (equator for latitudinal measurements and prime meridian for longitudinal measurements).</span><a class="headerlink" href="#lat-lon" title="Permalink to this image">#</a></p>
</div>
<p>A latitude measures the angle from the equatorial plane to the location on the earth’s surface. A longitude measures the angle between the prime meridian plane and the north-south plane that intersects the location of interest. For example The George Washington University is located at around 38.89° North and -77.04° West. In a GIS system, the North-South and East-West directions are encoded as signs. North and East are assigned a positive (<code class="docutils literal notranslate"><span class="pre">+</span></code>) sign and South and West are assigned a negative (<code class="docutils literal notranslate"><span class="pre">-</span></code>) sign. The university location is therefore encoded as +38.89° and -77.04°.</p>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">geopandas</span>
<span class="kn">import</span> <span class="nn">contextily</span> <span class="k">as</span> <span class="nn">ctx</span>
<span class="n">cities</span> <span class="o">=</span> <span class="n">geopandas</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">geopandas</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">get_path</span><span class="p">(</span><span class="s1">&#39;naturalearth_cities&#39;</span><span class="p">))</span>
<span class="n">cities</span> <span class="o">=</span> <span class="n">cities</span><span class="p">[</span><span class="n">cities</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;Washington, D.C.&#39;</span><span class="p">]</span>
<span class="n">cities</span> <span class="o">=</span> <span class="n">cities</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">epsg</span><span class="o">=</span><span class="mi">3857</span><span class="p">)</span> <span class="c1"># project to webmercator</span>

<span class="n">ax</span> <span class="o">=</span> <span class="n">cities</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
<span class="n">ctx</span><span class="o">.</span><span class="n">add_basemap</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">ctx</span><span class="o">.</span><span class="n">providers</span><span class="o">.</span><span class="n">CartoDB</span><span class="o">.</span><span class="n">Positron</span><span class="p">,</span><span class="n">zoom</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span> <span class="n">reset_extent</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/d_crs_what_is_it_1_0.png" src="../_images/d_crs_what_is_it_1_0.png" />
</div>
</div>
<p>A GCS is defined by an <strong>ellipsoid</strong>, <strong>geoid</strong> and <strong>datum</strong>. These elements are presented next.</p>
<div class="section" id="sphere-and-ellipsoid">
<h4>Sphere and Ellipsoid<a class="headerlink" href="#sphere-and-ellipsoid" title="Permalink to this headline">#</a></h4>
<p>Assuming that the earth is a perfect sphere greatly simplifies mathematical calculations and works well for small-scale maps (maps that show a <em>large</em> area of the earth). However, when working at larger scales, an ellipsoid representation of earth may be desired if accurate measurements are needed. An ellipsoid is defined by two radii: the semi-major axis (the equatorial radius) and the semi-minor axis (the polar radius).</p>
<div class="figure align-default">
<img alt="../_images/Ellipsoid.svg" src="../_images/Ellipsoid.svg" /></div>
<p>The reason the earth has a slightly ellipsoidal shape has to do with its rotation which induces a centripetal force along the equator. This results in an equatorial axis that is roughly 21 km longer than the polar axis.</p>
<div class="figure align-default" id="the-earth-can-be-mathematically-modeled-as-a-simple-sphere-left-or-an-ellipsoid-right">
<img alt="../_images/Globe_0_0_center.svg" src="../_images/Globe_0_0_center.svg" /><p class="caption"><span class="caption-number">Fig. 7 </span><span class="caption-text">The earth can be mathematically modeled as a simple sphere (left) or an ellipsoid (right).</span><a class="headerlink" href="#the-earth-can-be-mathematically-modeled-as-a-simple-sphere-left-or-an-ellipsoid-right" title="Permalink to this image">#</a></p>
</div>
<p>Our estimate of these radii is quite precise thanks to satellite and computational capabilities. The semi-major axis is 6,378,137 meters and the semi-minor axis is 6,356,752 meters.</p>
<p>Differences in distance measurements along the surfaces of an ellipsoid vs. a sphere are small but measurable (the difference can be as high as 20 km) as illustrated in the following lattice plots.</p>
<div class="figure align-default" id="differences-in-distance-measurements-between-the-surface-of-a-sphere-and-an-ellipsoid-each-graphic-plots-the-differences-in-distance-measurements-made-from-a-single-point-location-along-the-0-amp-deg-meridian-identified-by-the-green-colored-box-latitude-value-to-various-latitudinal-locations-along-a-longitude-whose-value-is-listed-in-the-bisque-colored-box-for-example-the-second-plot-from-the-top-left-corner-plot-shows-the-differences-in-distance-measurements-made-from-a-location-at-90-amp-deg-north-along-the-prime-meridian-to-a-range-of-latitudinal-locations-along-the-45-amp-deg-meridian">
<img alt="../_images/Ellipsoid_vs_sphere_distances.svg" src="../_images/Ellipsoid_vs_sphere_distances.svg" /><p class="caption"><span class="caption-number">Fig. 8 </span><span class="caption-text">Differences in distance measurements between the surface of a sphere and an ellipsoid. Each graphic plots the differences in distance measurements made from a single point location along the 0&amp;deg; meridian identified by the green colored box (latitude value) to various latitudinal locations along a longitude (whose value is listed in the bisque colored box). For example, the second plot from the top-left corner plot shows the differences in distance measurements made from a location at 90&amp;deg; north (along the prime meridian) to a range of latitudinal locations along the 45&amp;deg; meridian.</span><a class="headerlink" href="#differences-in-distance-measurements-between-the-surface-of-a-sphere-and-an-ellipsoid-each-graphic-plots-the-differences-in-distance-measurements-made-from-a-single-point-location-along-the-0-amp-deg-meridian-identified-by-the-green-colored-box-latitude-value-to-various-latitudinal-locations-along-a-longitude-whose-value-is-listed-in-the-bisque-colored-box-for-example-the-second-plot-from-the-top-left-corner-plot-shows-the-differences-in-distance-measurements-made-from-a-location-at-90-amp-deg-north-along-the-prime-meridian-to-a-range-of-latitudinal-locations-along-the-45-amp-deg-meridian" title="Permalink to this image">#</a></p>
</div>
</div>
<div class="section" id="geoid">
<h4>Geoid<a class="headerlink" href="#geoid" title="Permalink to this headline">#</a></h4>
<p>Representing the earth’s true shape, the <em>geoid</em>, as a mathematical model is crucial for a GIS environment. However, the earth’s shape is not a perfectly smooth surface. It has undulations resulting from changes in gravitational pull across its surface. These undulations may not be visible with the naked eye, but they are measurable and can influence locational measurements. Note that we are not including mountains and ocean bottoms in our discussion, instead we are focusing solely on the earth’s gravitational potential which can be best visualized by imagining the earth’s surface completely immersed in water and measuring the distance from the earth’s center to the water surface over the entire earth surface.</p>
<div class="figure align-default" id="earth-s-geoid-with-gravitational-field-shown-in-rainbow-colors-the-ondulations-depicted-in-the-graphics-are-exaggerated-for-visual-effects-source-nasa">
<img alt="../_images/Geoids_sm_NASA.jpg" src="../_images/Geoids_sm_NASA.jpg" />
<p class="caption"><span class="caption-number">Fig. 9 </span><span class="caption-text">Earth’s geoid with gravitational field shown in rainbow colors. The ondulations depicted in the graphics are exaggerated for visual effects. (source- NASA)</span><a class="headerlink" href="#earth-s-geoid-with-gravitational-field-shown-in-rainbow-colors-the-ondulations-depicted-in-the-graphics-are-exaggerated-for-visual-effects-source-nasa" title="Permalink to this image">#</a></p>
</div>
<p>The earth’s gravitational field is dynamic and is tied to the flow of the earth’s hot and fluid core. Hence its geoid is constantly changing, albeit at a large temporal scale.The measurement and representation of the earth’s shape is at the heart of geodesy–a branch of applied mathematics.</p>
</div>
<div class="section" id="datum">
<h4>Datum<a class="headerlink" href="#datum" title="Permalink to this headline">#</a></h4>
<p>So how are we to reconcile our need to work with a (simple) mathematical model of the earth’s shape with the ondulating nature of the earth’s surface (i.e. its geoid)? The solution is to align the geoid with the ellipsoid (or sphere) representation of the earth and to map the earth’s surface features onto this ellipsoid/sphere. The alignment can be local where the ellipsoid surface is closely fit to the geoid at a particular location on the earth’s surface (such as the state of Kansas) or <strong>geocentric</strong> where the ellipsoid is aligned with the center of the earth. How one chooses to align the ellipsoid to the geoid defines a <strong>datum</strong>.</p>
<div class="section" id="local-datum">
<h5>Local Datum<a class="headerlink" href="#local-datum" title="Permalink to this headline">#</a></h5>
<div class="figure align-default" id="a-local-datum-couples-a-geoid-with-the-ellipsoid-at-a-location-on-each-element-s-surface">
<img alt="../_images/Datum_local.svg" src="../_images/Datum_local.svg" /><p class="caption"><span class="caption-number">Fig. 10 </span><span class="caption-text">A local datum couples a geoid with the ellipsoid at a location on each element’s surface.</span><a class="headerlink" href="#a-local-datum-couples-a-geoid-with-the-ellipsoid-at-a-location-on-each-element-s-surface" title="Permalink to this image">#</a></p>
</div>
<p>There are many local datums to choose from, some are old while others are more recently defined. The choice of datum is largely driven by the location of interest. For example, when working in the US, a popular local datum to choose from is the North American Datum of 1927 (or NAD27 for short). NAD27 works well for the US but it’s not well suited for other parts of the world. For example, a far better local datum for Europe is the European Datum of 1950 (ED50 for short). Examples of common local datums are shown in the following table:</p>
<table class="colwidths-auto docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Local datum</p></th>
<th class="head"><p>Acronym</p></th>
<th class="head"><p>Best for</p></th>
<th class="head"><p>Comment</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>North American Datum of 1927</p></td>
<td><p>NAD27</p></td>
<td><p>Continental US</p></td>
<td><p>This is an old datum but still prevalent because of the wide use of older maps.</p></td>
</tr>
<tr class="row-odd"><td><p>European Datum of 1950</p></td>
<td><p>ED50</p></td>
<td><p>Western Europe</p></td>
<td><p>Developed after World War II and still quite popular today. Not used in the UK.</p></td>
</tr>
<tr class="row-even"><td><p>World Geodetic System 1972</p></td>
<td><p>WGS72</p></td>
<td><p>Global</p></td>
<td><p>Developed by the Department of Defense.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="geocentric-datum">
<h5>Geocentric Datum<a class="headerlink" href="#geocentric-datum" title="Permalink to this headline">#</a></h5>
<div class="figure align-default" id="a-geocentric-datum-couples-a-geoid-with-the-ellipsoid-at-each-element-s-center-of-mass">
<img alt="../_images/Datum_geocentric.svg" src="../_images/Datum_geocentric.svg" /><p class="caption"><span class="caption-number">Fig. 11 </span><span class="caption-text">A geocentric  datum couples a geoid with the ellipsoid at each element’s center of mass.</span><a class="headerlink" href="#a-geocentric-datum-couples-a-geoid-with-the-ellipsoid-at-each-element-s-center-of-mass" title="Permalink to this image">#</a></p>
</div>
<p>Many of the modern datums use a geocentric alignment. These include the popular World Geodetic Survey for 1984 (WGS84) and the North American Datums of 1983 (NAD83). Most of the popular geocentric datums use the WGS84 ellipsoid or the GRS80 ellipsoid. These two ellipsoids share nearly identical semi-major and semi-minor axes: 6,378,137 meters and 6,356,752 meters respectively. Examples of popular geocentric datums are shown in the following table:</p>
<table class="colwidths-auto docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Geocentric datum</p></th>
<th class="head"><p>Acronym</p></th>
<th class="head"><p>Best for</p></th>
<th class="head"><p>Comment</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>North American Datum of 1983</p></td>
<td><p>NAD83</p></td>
<td><p>Continental US</p></td>
<td><p>This is one of the most popular modern datums for the contiguous US.</p></td>
</tr>
<tr class="row-odd"><td><p>European Terrestrial Reference System 1989</p></td>
<td><p>ETRS89</p></td>
<td><p>Western Europe</p></td>
<td><p>This is the most popular modern datum for much of Europe.</p></td>
</tr>
<tr class="row-even"><td><p>World Geodetic System 1984</p></td>
<td><p>WGS84</p></td>
<td><p>Global</p></td>
<td><p>Developed by the Department of Defense.</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="section" id="building-the-geographic-coordinate-system">
<h4>Building the Geographic Coordinate System<a class="headerlink" href="#building-the-geographic-coordinate-system" title="Permalink to this headline">#</a></h4>
<p>A Geographic Coordinate System (GCS) is defined by the ellipsoid model and by the way this ellipsoid is aligned with the geoid (defining the datum). It is important to know which GCS is associated with a GIS file or a map document reference system. This is particularly true when the overlapping layers are tied to different datums (and therefore GCS’). This is because a location on the earth’s surface can take on different coordinate values. For example, a location recorded in an NAD 1927 GCS having a coordinate pair of 44.56698° north and 69.65939° west will register a coordinate value of 44.56704° north and 69.65888° west in a NAD83 GCS and a coordinate value of 44.37465° north and -69.65888° west in a sphere based WGS84 GCS. If the coordinate systems for these point coordinate values were not properly defined, then they could be misplaced on a map.  This is analogous to recording temperature using different units of measure (degrees Celsius, Fahrenheit and Kelvin)–each unit of measure will produce a different numeric value.</p>
<div class="figure align-default" id="map-of-the-colby-flagpole-in-two-different-geographic-coordinate-systems-gcs-nad-1983-on-the-left-and-gcs-nad-1927-on-the-right-note-the-offset-in-the-44-5639-deg-line-of-latitude-relative-to-the-flagpole-also-note-the-0-0005deg-longitudinal-offset-between-both-reference-systems">
<img alt="../_images/GCS_diff_coord_values.png" src="../_images/GCS_diff_coord_values.png" />
<p class="caption"><span class="caption-number">Fig. 12 </span><span class="caption-text">Map of the Colby flagpole in two different geographic coordinate systems (<em>GCS NAD 1983</em> on the left and <em>GCS NAD 1927</em> on the right). Note the offset in the 44.5639° line of latitude relative to the flagpole. Also note the 0.0005° longitudinal offset between both reference systems.</span><a class="headerlink" href="#map-of-the-colby-flagpole-in-two-different-geographic-coordinate-systems-gcs-nad-1983-on-the-left-and-gcs-nad-1927-on-the-right-note-the-offset-in-the-44-5639-deg-line-of-latitude-relative-to-the-flagpole-also-note-the-0-0005deg-longitudinal-offset-between-both-reference-systems" title="Permalink to this image">#</a></p>
</div>
</div>
</div>
<div class="section" id="projected-coordinate-systems">
<h3>Projected Coordinate Systems<a class="headerlink" href="#projected-coordinate-systems" title="Permalink to this headline">#</a></h3>
<p>The surface of the earth is curved but maps are flat. A projected coordinate system (PCS) is a reference system for identifying locations and measuring features on a flat (map) surface. It consists of lines that intersect at right angles, forming a grid. Projected coordinate systems (which are based on Cartesian coordinates) have an origin, an <em>x</em> axis, a <em>y</em> axis, and a linear unit of measure. Going from a GCS to a PCS requires mathematical transformations. The myriad of projection types can be aggregated into three groups: <strong>planar</strong>, <strong>cylindrical</strong> and <strong>conical</strong>.</p>
<div class="section" id="planar-projections">
<h4>Planar Projections<a class="headerlink" href="#planar-projections" title="Permalink to this headline">#</a></h4>
<p><strong>Tangent Case</strong>
A planar projection (aka Azimuthal projection) maps the earth surface features to a flat surface that touches the earth’s surface at a point (<strong>tangent</strong> case),</p>
<div class="figure align-default">
<img alt="../_images/Planar_projection_tangent.svg" src="../_images/Planar_projection_tangent.svg" /></div>
<p><strong>Secant Case</strong>
or along a line of tangency (a <strong>secant</strong> case).</p>
<div class="figure align-default">
<img alt="../_images/Planar_projection_secant.svg" src="../_images/Planar_projection_secant.svg" /></div>
<p>This projection is often used in mapping polar regions but can be used for any location on the earth’s surface (in which case they are called oblique planar projections).</p>
<div class="figure align-default" id="examples-of-three-planar-projections-orthographic-left-gnomonic-center-and-equidistant-right-each-covers-a-different-spatial-range-with-the-latter-covering-both-northern-and-southern-hemispheres-and-each-preserves-a-unique-set-of-spatial-properties">
<img alt="../_images/Planar_Examples.svg" src="../_images/Planar_Examples.svg" /><p class="caption"><span class="caption-number">Fig. 13 </span><span class="caption-text">Examples of three planar projections - orthographic (left), gnomonic (center) and equidistant (right). Each covers a different spatial range (with the latter covering both northern and southern hemispheres) and each preserves a unique set of spatial properties.</span><a class="headerlink" href="#examples-of-three-planar-projections-orthographic-left-gnomonic-center-and-equidistant-right-each-covers-a-different-spatial-range-with-the-latter-covering-both-northern-and-southern-hemispheres-and-each-preserves-a-unique-set-of-spatial-properties" title="Permalink to this image">#</a></p>
</div>
</div>
<div class="section" id="cylindrical-projection">
<h4>Cylindrical Projection<a class="headerlink" href="#cylindrical-projection" title="Permalink to this headline">#</a></h4>
<p>A cylindrical map projection maps the earth surface onto a map rolled into a cylinder (which can then be flattened into a plane). The cylinder can touch the surface of the earth along a single line of tangency (a <strong>tangent</strong> case),</p>
<div class="figure align-default">
<img alt="../_images/Cylindrical_projection_tangent.svg" src="../_images/Cylindrical_projection_tangent.svg" /></div>
<p>or along two lines of tangency (a <strong>secant</strong> case).</p>
<div class="figure align-default">
<img alt="../_images/Cylindrical_projection_secant.svg" src="../_images/Cylindrical_projection_secant.svg" /></div>
<p>The cylinder can be tangent to the equator or it can be oblique. A special case is the Transverse aspect which is tangent to lines of longitude. This is a popular projection used in defining the Universal Transverse Mercator (UTM) and State Plane coordinate systems. The UTM PCS covers the entire globe and is a popular coordinate system in the US. It’s important to note that the UTM PCS is broken down into zones and therefore limits its extent to these zones that are 6° wide. For example, the State of Maine (USA) uses the UTM coordinate system (Zone 19 North) for most of its statewide GIS maps. Most USGS quad maps are also presented in a UTM coordinate system. Popular datums tied to the UTM coordinate system in the US include NAD27 and NAD83. There is also a WGS84 based UTM coordinate system.</p>
<p>Distortion is minimized along the tangent or secant lines and increases as the distance from these lines increases.</p>
<div class="figure align-default" id="examples-of-two-cylindrical-projections-mercator-preserves-shape-but-distorts-area-and-distance-and-equal-area-preserves-area-but-distorts-shape">
<img alt="../_images/Cylindrical_Examples.svg" src="../_images/Cylindrical_Examples.svg" /><p class="caption"><span class="caption-number">Fig. 14 </span><span class="caption-text">Examples of two cylindrical projections Mercator (preserves shape but distorts area and distance) and equal-area (preserves area but distorts shape).```</span><a class="headerlink" href="#examples-of-two-cylindrical-projections-mercator-preserves-shape-but-distorts-area-and-distance-and-equal-area-preserves-area-but-distorts-shape" title="Permalink to this image">#</a></p>
<div class="legend">
</div>
</div>
<p>or along two lines of tangency (a <strong>secant</strong> case).</p>
<div class="figure align-default">
<img alt="../_images/Conical_projection_secant.svg" src="../_images/Conical_projection_secant.svg" /></div>
<p>Distortion is minimized along the tangent or secant lines and increases as the distance from these lines increases. When distance or area measurements are needed for the contiguous 48 states, use one of the conical projections such as Equidistant Conic (distance preserving) or Albers Equal Area Conic (area preserving).</p>
<p>Conical projections are also popular PCS’ in European maps such as Europe Albers Equal Area Conic and Europe Lambert Conformal Conic.</p>
<div class="figure align-default" id="examples-of-three-conical-projections-albers-equal-area-preserves-area-equidistant-preserves-distance-and-conformal-preserves-shape">
<img alt="../_images/Conical_Examples.svg" src="../_images/Conical_Examples.svg" /><p class="caption"><span class="caption-number">Fig. 15 </span><span class="caption-text">Examples of three conical projections - Albers equal area (preserves area), equidistant (preserves distance) and conformal (preserves shape).</span><a class="headerlink" href="#examples-of-three-conical-projections-albers-equal-area-preserves-area-equidistant-preserves-distance-and-conformal-preserves-shape" title="Permalink to this image">#</a></p>
</div>
</div>
<div class="section" id="conical-projection">
<h4>Conical Projection<a class="headerlink" href="#conical-projection" title="Permalink to this headline">#</a></h4>
<p>A conical map projection maps the earth surface onto a map rolled into a cone. Like the cylindrical projection, the cone can touch the surface of the earth along a single line of tangency (a <strong>tangent</strong> case),</p>
<div class="figure align-default">
<img alt="../_images/Conical_projection_tangent.svg" src="../_images/Conical_projection_tangent.svg" /></div>
</div>
</div>
<div class="section" id="spatial-properties">
<h3>Spatial Properties<a class="headerlink" href="#spatial-properties" title="Permalink to this headline">#</a></h3>
<p>All projections distort real-world geographic features to some degree. The four spatial properties that are subject to distortion are: <strong>shape</strong>, <strong>area</strong>, <strong>distance</strong> and <strong>direction</strong>. A map that preserves shape is called conformal; one that preserves area is called equal-area; one that preserves distance is called equidistant; and one that preserves direction is called azimuthal.</p>
<blockquote>
<div><p>For most GIS applications (e.g. ArcGIS and QGIS), many of the built-in projections are named after the spatial properties they preserve.</p>
</div></blockquote>
<p>Each map projection is good at preserving only one or two of the four spatial properties. So when working with small-scale (large area) maps and when multiple spatial properties are to be preserved, it is best to break the analyses across different projections to minimize errors associated with spatial distortion.</p>
<p>If you want to assess a projection’s spatial distortion across your study region, you can generate Tissot indicatrix (TI) ellipses. The idea is to project a small circle (i.e. small enough so that the distortion remains relatively uniform across the circle’s extent) and to measure its distorted shape on the projected map. For example, in assessing the type of distortion one could expect with a Mollweide projection across the continental US, a grid of circles could be generated at regular latitudinal and longitudinal intervals.</p>
<div class="figure align-default">
<img alt="../_images/Moll_Tissot.png" src="../_images/Moll_Tissot.png" />
</div>
<p>Note the varying levels of distortion type and magnitude across the region. Let’s explore a Tissot circle at 44.5°N and 69.5°W (near Waterville Maine):</p>
<div class="figure align-default">
<img alt="../_images/Moll_Tissot_Zoom.png" src="../_images/Moll_Tissot_Zoom.png" />
</div>
<p>The plot shows a perfect circle (displayed in a filled bisque color) that one would expect to see if no distortion was at play. The blue distorted ellipse (the indicatrix) is the transformed circle for this particular projection and location. The green and red lines show the magnitude and direction of the ellipse’s major and minor axes respectively. These lines can also be used to assess scale distortion (note that scale distortion can vary as a function of bearing). The green line shows maximum scale distortion and the red line shows minimum scale distortion–these are sometimes referred to as the principal directions. In this working example, the principal directions are 1.1293 and 0.8856. A scale value of 1 indicates no distortion. A value less than 1 indicates a smaller-than-true scale and a value greater than 1 indicates a greater-than-true scale.</p>
<p>Projections can distort scale, but this does not necessarily mean that area is distorted. In fact, for this particular projection, area is relatively well preserved despite distortion in principal directions. Area distortion can easily be computed by taking the product of the two aforementioned principal directions. In this working example, area distortion is 1.0001 (i.e. negligible).</p>
<p>The north-south dashed line in the graphic shows the orientation of the meridian. The east-west dotted line shows the orientation of the parallel.</p>
<blockquote>
<div><p>It’s important to recall that these distortions occur at the point where the TI is centered and not necessarily across the region covered by the TI circle.</p>
</div></blockquote>
</div>
<div class="section" id="geodesic-geometries">
<h3>Geodesic geometries<a class="headerlink" href="#geodesic-geometries" title="Permalink to this headline">#</a></h3>
<p>The reason projected coordinate systems introduce errors in their geometric measurements has to do with the nature of the projection whereby the distance between two points on a sphere or ellipsoid will be difficult to replicate on a projected coordinate system unless these points are relatively close to one another. In most cases, such errors can be tolerated if the expected level of precision is met; many other sources of error in the spatial representation of the features can often usurp any measurement errors made in a projected coordinate system. However, if the scale of analysis is small (i.e. the spatial extent covers a large proportion of the earth’s surface such as the North American continent), then the measurement errors associated with a projected coordinate system may no longer be acceptable. A way to circumvent projected coordinate system limitations is to adopt a geodesic solution.
A <strong>geodesic distance</strong> is the shortest distance between two points on an ellipsoid (or spheroid). Likewise, a <strong>geodesic area</strong> measurement is one that is measured on an ellipsoid. Such measurements are independent of the underlying projected coordinate system. The Tissot circles presented in figures from the last section were all generated using geodesic geometry.</p>
<p>If you are not convinced of the benefits afforded by geodesic geometry, compare the distances measured between two points located on either sides of the Atlantic in the following map. The blue dashed line represents the shortest distance between the two points on a <em>planar</em> coordinate system. The red line represents the shortest distance between the two points as measured on a <em>spheroid</em>.</p>
<div class="figure align-default">
<img alt="../_images/unnamed-chunk-9-1.png" src="../_images/unnamed-chunk-9-1.png" />
</div>
<p>At first glance, the geodesic distance may seem nonsensical given its curved appearance on the projected map. However, this curvature is a byproduct of the current reference system’s increasing distance distortion as one progresses poleward. If you are still not convinced, you can display the geodesic and planar distance layers on a 3D globe (or a projection that mimics the view of the 3D earth as viewed from space centered on the mid-point of the geodesic line segment).</p>
<div class="figure align-default">
<img alt="../_images/unnamed-chunk-10-1.png" src="../_images/unnamed-chunk-10-1.png" />
</div>
<p>So if a geodesic measurement is more precise than a planar measurement, why not perform all spatial operations using geodesic geometry? In many cases, a geodesic approach to spatial operations can be perfectly acceptable and is even encouraged. The downside is in its computational requirements. It’s far more computationally efficient to compute area/distance on a plane than it is on a spheroid. This is because geodesic calculations have no simple algebraic solutions and involve approximations that may require iterative solutions. So this may be a computationally taxing approach if processing millions of line segments.</p>
<p>Note that not all geodesic measurement implementations are equal. Some more efficient algorithms that minimize computation time may reduce precision in the process. Some of ArcMap’s functions offer the option to compute geodesic distances and areas however ArcMap does not clearly indicate how its geodesic calculations are implemented. The data analysis environment R has a package called <code class="docutils literal notranslate"><span class="pre">geosphere</span></code> that implements well defined geodesic measurement algorithms adopted from the authoritative set of  <a class="reference external" href="https://geographiclib.sourceforge.io/">GeographicLib</a> libraries.</p>
<p><a class="reference external" href="https://mgimond.github.io/Spatial/chp09_0.html">Adapted from Manuel Gimond’s excellent “Intro to GIS and Spatial Analysis”</a> under This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.</p>
</div>
</div>
<span id="document-docs/d_understand_crs_codes"></span><div class="tex2jax_ignore mathjax_ignore section" id="understanding-a-crs-proj4-and-crs-codes">
<span id="d-understand-crs-codes"></span><h2>Understanding a CRS: Proj4 and CRS codes<a class="headerlink" href="#understanding-a-crs-proj4-and-crs-codes" title="Permalink to this headline">#</a></h2>
<hr class="docutils" />
<div class="admonition-learning-objectives admonition">
<p class="admonition-title">Learning Objectives</p>
<ul class="simple">
<li><p>Understand how to read a <code class="docutils literal notranslate"><span class="pre">PROJ.4</span></code> string</p></li>
<li><p>Understand how a <code class="docutils literal notranslate"><span class="pre">PROJ.4</span></code> string relates to an <code class="docutils literal notranslate"><span class="pre">EPSG</span></code> code</p></li>
<li><p>Visually explore changing <code class="docutils literal notranslate"><span class="pre">PROJ.4</span></code> string parameters</p></li>
</ul>
</div>
<div class="admonition-review admonition">
<p class="admonition-title">Review</p>
<ul class="simple">
<li><p><a class="reference internal" href="docs/a_intro.html#document-docs/d_crs_what_is_it"><span class="doc std std-doc">CRS what is it?</span></a></p></li>
</ul>
</div>
<hr class="docutils" />
<p>By: Steven Chao</p>
<hr class="docutils" />
<div class="section" id="intro-to-coordinate-reference-systems">
<h3>Intro to Coordinate Reference Systems<a class="headerlink" href="#intro-to-coordinate-reference-systems" title="Permalink to this headline">#</a></h3>
<p>A coordinate reference system tells Python where and how to place coordinates on Earth’s surface. For a detailed lesson on projections please go <a class="reference internal" href="docs/a_intro.html#d-crs-what-is-it"><span class="std std-ref">here</span></a>.</p>
<p>As you may recall, a coordinate reference system can either be a geographic coordinate system or a projected coordinate system (also known as a map projection). A geographic coordinate system consists of a datum, which consists of an ellipsoid model and how this ellipsoid is aligned with the geoid. It’s spherical in nature, and units are typically angular (latitude and longitude). A projected coordinate system is created by taking a geographic coordinate system and using math to transform a 3-D surface onto a flat, 2-D surface. Units are typically linear and are oftentimes measured in meters. For a refresher on coordinate systems, check out this <a class="reference external" href="https://youtu.be/HnWNhyxyUHg">YouTube video</a>.</p>
<p>All map projections introduce error because they are inherently imperfect. The “best” or “perfect” projection to use is highly dependent on what needs to be mapped and where. Therefore, as you can expect, there are many projections to choose from.</p>
<hr class="docutils" />
<p>In this chapter, we will check, utilize, change, and create CRSs in Python. To provide visual examples along the way, we will use a shapefile of the Washington, DC, boundary from Open Data DC (<a class="reference external" href="https://opendata.dc.gov/datasets/washington-dc-boundary">https://opendata.dc.gov/datasets/washington-dc-boundary</a>).</p>
<p>Let’s begin by reading in this dataset (no need to download the shapefile as we will pull it directly from the website).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Import module</span>
<span class="kn">import</span> <span class="nn">geopandas</span> <span class="k">as</span> <span class="nn">gpd</span>

<span class="c1"># Read data (shapefile)</span>
<span class="n">dc</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="s2">&quot;https://opendata.arcgis.com/datasets/7241f6d500b44288ad983f0942b39663_10.geojson&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s also define a function that will allow us to quickly produce a map of our data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Import module</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="k">def</span> <span class="nf">map_data</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">header</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Function superimposes all the data on a map and sets a title for the map.&#39;&#39;&#39;</span>    
    
    <span class="c1"># Create subplots</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
    
    <span class="c1"># Set colors</span>
    <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;#a3ddcb&quot;</span><span class="p">,</span> <span class="s2">&quot;#03506f&quot;</span><span class="p">]</span>
    
    <span class="c1"># Iterate through list of data and colors to superimpose them onto map</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)):</span>
        <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">facecolor</span> <span class="o">=</span> <span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">)</span>
    
    <span class="c1"># Add title</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
    
    <span class="c1"># Utilize BMH plotting style</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s2">&quot;bmh&quot;</span><span class="p">)</span>
    
    <span class="c1"># Remove empty white space around the plot</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Now, we can see how the shapefile we just read in looks like.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create map using DC shapefile</span>
<span class="n">map_data</span><span class="p">([</span><span class="n">dc</span><span class="p">],</span> <span class="s2">&quot;Washington, DC&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/d_understand_crs_codes_5_0.png" src="../_images/d_understand_crs_codes_5_0.png" />
</div>
</div>
<p>It looks like Washington, DC, albeit a bit squished! Next, let’s see how we can work with CRSs in Python.</p>
</div>
<div class="section" id="checking-and-setting-coordinate-reference-systems-in-python">
<h3>Checking and Setting Coordinate Reference Systems in Python<a class="headerlink" href="#checking-and-setting-coordinate-reference-systems-in-python" title="Permalink to this headline">#</a></h3>
<div class="section" id="checking-a-dataset-s-coordinate-reference-system">
<h4>Checking a dataset’s coordinate reference system<a class="headerlink" href="#checking-a-dataset-s-coordinate-reference-system" title="Permalink to this headline">#</a></h4>
<p>To check the dataset’s CRS (assuming it has one), use the <code class="docutils literal notranslate"><span class="pre">.crs</span></code> attribute.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get CRS for DC shapefile</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;CRS: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dc</span><span class="o">.</span><span class="n">crs</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>CRS: epsg:4326
</pre></div>
</div>
</div>
</div>
<p>For our shapefile, the output is a dictionary with a value of <code class="docutils literal notranslate"><span class="pre">'epsg:4326'</span></code>. We’ll cover what this means in more detail later in this chapter, but just know for now that an <code class="docutils literal notranslate"><span class="pre">EPSG</span></code> code is a way to reference a CRS.</p>
</div>
<div class="section" id="change-a-dataset-s-crs">
<h4>Change a dataset’s CRS<a class="headerlink" href="#change-a-dataset-s-crs" title="Permalink to this headline">#</a></h4>
<p>To change a dataset’s CRS, we’ll need to reproject the data. Here, we will project copies of our data twice using the <code class="docutils literal notranslate"><span class="pre">to_crs()</span></code> function, once with a <code class="docutils literal notranslate"><span class="pre">PROJ.4</span></code> string and once with an <code class="docutils literal notranslate"><span class="pre">EPSG</span></code> code. Both of these values reference the same CRS (in this case, NAD83)–they are simply different ways to reference it. The projection will remain in latitude and longitude, but we will change the ellipsoid and datum.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Example 1: Create a copy of the DC shapefile</span>
<span class="n">dc_reproject_proj4</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="c1"># Example 1: Reproject the data to NAD83 using PROJ.4 string</span>
<span class="c1"># Source: https://spatialreference.org/ref/epsg/nad83/</span>
<span class="n">dc_reproject_proj4</span> <span class="o">=</span> <span class="n">dc_reproject_proj4</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="s2">&quot;+proj=longlat +ellps=GRS80 +datum=NAD83 +no_defs&quot;</span><span class="p">)</span>


<span class="c1"># Example 2: Create a copy of the DC shapefile</span>
<span class="n">dc_reproject_epsg</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="c1"># Example 2: Reproject the data to NAD83 using EPSG code</span>
<span class="n">dc_reproject_epsg</span> <span class="o">=</span> <span class="n">dc_reproject_epsg</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">epsg</span><span class="o">=</span><span class="mi">4269</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>There are some other formats we can pass as values, but we’ll cover <code class="docutils literal notranslate"><span class="pre">PROJ.4</span></code> string and <code class="docutils literal notranslate"><span class="pre">EPSG</span></code> in this chapter.</p>
<p>When we call the <code class="docutils literal notranslate"><span class="pre">.crs</span></code> attribute, it’s no longer <code class="docutils literal notranslate"><span class="pre">'epsg:4326'</span></code>, which means that the data has been reprojected!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Example 1: Print new CRS of DC</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Example 1 (PROJ.4 string) CRS: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dc_reproject_proj4</span><span class="o">.</span><span class="n">crs</span><span class="p">))</span>

<span class="c1"># Example 2: Print new CRS of DC</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Example 2 (EPSG code) CRS: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dc_reproject_epsg</span><span class="o">.</span><span class="n">crs</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Example 1 (PROJ.4 string) CRS: +proj=longlat +ellps=GRS80 +datum=NAD83 +no_defs +type=crs
Example 2 (EPSG code) CRS: epsg:4269
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="proj-4-string">
<h3>PROJ.4 String<a class="headerlink" href="#proj-4-string" title="Permalink to this headline">#</a></h3>
<p>A <code class="docutils literal notranslate"><span class="pre">PROJ.4</span></code> string identifies and defines a particular CRS. The string holds the parameters (e.g., units, datum) of a given CRS.</p>
<p>Sources: <a class="reference external" href="https://proj.org/usage/quickstart.html">Using PROJ</a>; <a class="reference external" href="https://www.earthdatascience.org/courses/use-data-open-source-python/intro-vector-data-python/spatial-data-vector-shapefiles/epsg-proj4-coordinate-reference-system-formats-python/">Lesson 4. Understand EPSG, WKT and Other CRS Definition Styles, Leah Wasser</a></p>
<div class="section" id="what-is-in-a-proj-4-string">
<h4>What is in a PROJ.4 string?<a class="headerlink" href="#what-is-in-a-proj-4-string" title="Permalink to this headline">#</a></h4>
<p>Multiple parameters are needed in the string to describe a CRS. To separate the parameters in the string and identify each individual parameter, each parameter begins with a <code class="docutils literal notranslate"><span class="pre">+</span></code> sign. A CRS parameter is defined after the <code class="docutils literal notranslate"><span class="pre">+</span></code> sign.</p>
<p>A few <code class="docutils literal notranslate"><span class="pre">PROJ.4</span></code> parameters can be applied to most CRSs:</p>
<table class="colwidths-auto docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Parameter</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">+a</span></code></p></td>
<td><p>Semimajor radius of the ellipsoid axis</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">+axis</span></code></p></td>
<td><p>Axis orientation</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">+b</span></code></p></td>
<td><p>Semiminor radius of the ellipsoid axis</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">+ellps</span></code></p></td>
<td><p>Ellipsoid name</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">+k_0</span></code></p></td>
<td><p>Scaling factor</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">+lat_0</span></code></p></td>
<td><p>Latitude of origin</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">+lat_1</span> <span class="pre">or</span> <span class="pre">2</span></code></p></td>
<td><p>Standard parallels</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">+lon_0</span></code></p></td>
<td><p>Central meridian</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">+lon_wrap</span></code></p></td>
<td><p>Center longitude to use for wrapping</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">+over</span></code></p></td>
<td><p>Allow longitude output outside -180 to 180 range, disables wrapping</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">+pm</span></code></p></td>
<td><p>Alternate prime meridian (typically a city name)</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">+proj</span></code></p></td>
<td><p>Projection name</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">+units</span></code></p></td>
<td><p>meters, US survey feet, etc.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">+vunits</span></code></p></td>
<td><p>vertical units</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">+x_0</span></code></p></td>
<td><p>False easting</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">+y_0</span></code></p></td>
<td><p>False northing</p></td>
</tr>
</tbody>
</table>
<p>Some parameters (not listed above) are specific to certain CRSs. Be sure to always verify the parameters that are allowed for each projection. You can’t always “mix and match” the <code class="docutils literal notranslate"><span class="pre">PROJ.4</span></code> parameters when creating a custom projection.</p>
<p>These parameters can be confusing. To help with this we developed some visual examples.</p>
<p>Take for instance lambert conformal conic with the proj4 string of “+proj=lcc +lat_1=20 +lat_2=60 lon_0=-96 +datum=NAD83 +units=m”. We can see that <code class="docutils literal notranslate"><span class="pre">lat_1</span></code> and <code class="docutils literal notranslate"><span class="pre">lat_2</span></code> specify the standard parallels. This is an example of a “secant” projection which touches the globe in two places in order to minimize distortion.  The central meridian <code class="docutils literal notranslate"><span class="pre">lon_0</span></code> is moved away from Greenwich England 96 degrees W to be over roughly Dallas TX.</p>
<div class="figure align-default" id="visualization-of-lambert-conformal-conic-proj4-string">
<img alt="../_images/d_LambertProj_Code.png" src="../_images/d_LambertProj_Code.png" />
<p class="caption"><span class="caption-number">Fig. 16 </span><span class="caption-text">Visualization of lambert conformal conic Proj4 string</span><a class="headerlink" href="#visualization-of-lambert-conformal-conic-proj4-string" title="Permalink to this image">#</a></p>
</div>
<p>We can look at another example for a UTM projection with the proj4 string of “+proj=tmerc +lon_0=-99 +x_0=500,000 units=m”. This projection by comparison has a central meridian <code class="docutils literal notranslate"><span class="pre">lon_0</span></code> directly over Dallas TX which is 99 degrees W of Greenwich. This central meridan is assigned the ‘false easting’ <code class="docutils literal notranslate"><span class="pre">x_0</span></code> of 500,000 meters.</p>
<div class="figure align-default" id="visualization-of-utm-zone-14-proj4-string">
<img alt="../_images/d_MercatorProj_Code.png" src="../_images/d_MercatorProj_Code.png" />
<p class="caption"><span class="caption-number">Fig. 17 </span><span class="caption-text">Visualization of UTM zone 14 Proj4 string</span><a class="headerlink" href="#visualization-of-utm-zone-14-proj4-string" title="Permalink to this image">#</a></p>
</div>
<p>Sources: <a class="reference external" href="https://proj.org/usage/projections.html">Cartographic projection</a>; <a class="reference external" href="https://proj.org/usage/quickstart.html">Using PROJ</a>; <a class="reference external" href="https://www.earthdatascience.org/courses/use-data-open-source-python/intro-vector-data-python/spatial-data-vector-shapefiles/epsg-proj4-coordinate-reference-system-formats-python/">Lesson 4. Understand EPSG, WKT and Other CRS Definition Styles, Leah Wasser</a></p>
</div>
<div class="section" id="creating-a-custom-crs-using-proj-4-string">
<h4>Creating a custom CRS using PROJ.4 string<a class="headerlink" href="#creating-a-custom-crs-using-proj-4-string" title="Permalink to this headline">#</a></h4>
<p>We can change the parameters to create a custom CRS that suits our specific needs. In this section, we will create a CRS tailored to our DC shapefile.</p>
<p>Below is the original shapefile of DC that we read in above–this will serve as a reference point for comparison.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Map original DC shapefile</span>
<span class="n">map_data</span><span class="p">([</span><span class="n">dc</span><span class="p">],</span> <span class="s2">&quot;Washington, DC - WGS84&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/d_understand_crs_codes_13_0.png" src="../_images/d_understand_crs_codes_13_0.png" />
</div>
</div>
<p>The map above utilizes a geographic coordinate system, as evidenced by the latitude and longitude values on the axes. Another way to check is to look at the geometry of the shapefile.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Check geometry values of original shapefile</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Geometry of shapefile:</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dc</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">head</span><span class="p">()))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Geometry of shapefile:
0    POLYGON ((-77.11980 38.93435, -77.11979 38.934...
Name: geometry, dtype: geometry
</pre></div>
</div>
</div>
</div>
<p>Looks like latitude and longitude coordinates!</p>
<div class="section" id="reprojecting-shapefile-to-a-projected-coordinate-system">
<h5>Reprojecting shapefile to a projected coordinate system<a class="headerlink" href="#reprojecting-shapefile-to-a-projected-coordinate-system" title="Permalink to this headline">#</a></h5>
<p>Now, we will reproject the shapefile using a projected coordinate system. Here, we will use the Lambert Conformal Conic projection.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create a copy of the DC shapefile</span>
<span class="n">dc_lcc</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="c1"># Reproject the data to Lambert Conformal Conic</span>
<span class="c1"># Source: https://proj.org/operations/projections/lcc.html</span>
<span class="n">dc_lcc</span> <span class="o">=</span> <span class="n">dc_lcc</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="s2">&quot;+proj=lcc +lon_0=-90 +lat_1=33 +lat_2=45 +ellps=GRS80&quot;</span><span class="p">)</span>

<span class="c1"># Map reprojected DC shapefile</span>
<span class="n">map_data</span><span class="p">([</span><span class="n">dc_lcc</span><span class="p">],</span> <span class="s2">&quot;Washington, DC - Lambert Conformal Conic&quot;</span><span class="p">)</span>

<span class="c1"># Check geometry values</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Geometry of shapefile:</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dc_lcc</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">head</span><span class="p">()))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Geometry of shapefile:
0    POLYGON ((1106986.814 4694966.592, 1106987.032...
Name: geometry, dtype: geometry
</pre></div>
</div>
<img alt="../_images/d_understand_crs_codes_17_1.png" src="../_images/d_understand_crs_codes_17_1.png" />
</div>
</div>
<p>Notice how the values on the axes changed from latitude and longitude to meters.</p>
</div>
<div class="section" id="setting-center-point-of-projection">
<h5>Setting center point of projection<a class="headerlink" href="#setting-center-point-of-projection" title="Permalink to this headline">#</a></h5>
<p>Also notice how the DC appears to be “tilted” to the left when compared to DC mapped using the previous CRS (WGS84). That’s because the center of this projection is at the 90th meridian west (<code class="docutils literal notranslate"><span class="pre">+lon_0=-90</span></code>; negative is used to denote West) and the Equator (<code class="docutils literal notranslate"><span class="pre">+lat_0=0</span></code>; <code class="docutils literal notranslate"><span class="pre">0</span></code> is the default value when not specified in the <code class="docutils literal notranslate"><span class="pre">PROJ.4</span></code> string).</p>
<p>We can change the values for <code class="docutils literal notranslate"><span class="pre">lat_0</span></code> and <code class="docutils literal notranslate"><span class="pre">lon_0</span></code>, which refer to the latitude of origin and the central meridian, respectively. We will change those values to <code class="docutils literal notranslate"><span class="pre">38.9072</span></code> and <code class="docutils literal notranslate"><span class="pre">-77.0369</span></code>, which is the center of DC.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create a copy of the DC shapefile</span>
<span class="n">dc_lcc_center</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="c1"># Reproject the data to Lambert Conformal Conic with specified center point</span>
<span class="n">dc_lcc_center</span> <span class="o">=</span> <span class="n">dc_lcc_center</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="s2">&quot;+proj=lcc +lat_0=38.9072 +lon_0=-77.0369 +lat_1=33 +lat_2=45 +ellps=GRS80&quot;</span><span class="p">)</span>

<span class="c1"># Map reprojected DC shapefile</span>
<span class="n">map_data</span><span class="p">([</span><span class="n">dc_lcc_center</span><span class="p">],</span> <span class="s2">&quot;Washington, DC - Lambert Conformal Conic</span><span class="se">\n</span><span class="s2">DC as Center&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/d_understand_crs_codes_19_0.png" src="../_images/d_understand_crs_codes_19_0.png" />
</div>
</div>
<p>As seen in the new map above, the values on both axes have changed. The origin <code class="docutils literal notranslate"><span class="pre">(0,</span> <span class="pre">0)</span></code> is now in the center of DC.</p>
</div>
<div class="section" id="setting-and-exploring-standard-parallels">
<h5>Setting and exploring standard parallels<a class="headerlink" href="#setting-and-exploring-standard-parallels" title="Permalink to this headline">#</a></h5>
<p>The <a class="reference external" href="https://proj.org/operations/projections/lcc.html"><code class="docutils literal notranslate"><span class="pre">PROJ.4</span></code> string for this projection</a> has two additional parameters <code class="docutils literal notranslate"><span class="pre">lat_1</span></code> and <code class="docutils literal notranslate"><span class="pre">lat_2</span></code>, which specify the first and second parallel respectively. Recall that a conic projection “intersects” a globe at what is termed the standard parallels.</p>
<p>Here, we will set our two standard parallels at <code class="docutils literal notranslate"><span class="pre">38.850</span></code> and <code class="docutils literal notranslate"><span class="pre">39.950</span></code> as they fall within the DC boundaries.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create a copy of the DC shapefile</span>
<span class="n">dc_lcc_parallels_1</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="c1"># Reproject the data to Lambert Conformal Conic with specified center point and standard parallels</span>
<span class="n">dc_lcc_parallels_1</span> <span class="o">=</span> <span class="n">dc_lcc_parallels_1</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="s2">&quot;+proj=lcc +lat_0=38.9072 +lon_0=-77.0369 +lat_1=38.850 +lat_2=39.950 +ellps=GRS80&quot;</span><span class="p">)</span>

<span class="c1"># Map reprojected DC shapefile</span>
<span class="n">map_data</span><span class="p">([</span><span class="n">dc_lcc_parallels_1</span><span class="p">],</span> <span class="s2">&quot;Washington, DC - Lambert Conformal Conic</span><span class="se">\n</span><span class="s2">Standard Parallels in DC&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/d_understand_crs_codes_21_0.png" src="../_images/d_understand_crs_codes_21_0.png" />
</div>
</div>
<p>Nothing really appears to be different; however, these values are important. Look what happens when we assign different values–ones that don’t really make sense for mapping in DC–and compare the resulting DC map to the previous map.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create a copy of the DC shapefile</span>
<span class="n">dc_lcc_parallels_2</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="c1"># # Reproject the data to Lambert Conformal Conic with specified center point and arbitrary standard parallels</span>
<span class="n">dc_lcc_parallels_2</span> <span class="o">=</span> <span class="n">dc_lcc_parallels_2</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="s2">&quot;+proj=lcc +lat_0=38.9072 +lon_0=-77.0369 +lat_1=10 +lat_2=60 +ellps=GRS80&quot;</span><span class="p">)</span>

<span class="c1"># Map reprojected DC shapefile</span>
<span class="n">map_data</span><span class="p">([</span><span class="n">dc_lcc_parallels_1</span><span class="p">,</span> <span class="n">dc_lcc_parallels_2</span><span class="p">],</span> <span class="s2">&quot;Washington, DC - Lambert Conformal Conic</span><span class="se">\n</span><span class="s2">Comparing Standard Parallels&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/d_understand_crs_codes_23_0.png" src="../_images/d_understand_crs_codes_23_0.png" />
</div>
</div>
<p>It appears DC has shrunk! Of course, that’s not the case in reality, but because map projections are inherently imperfect, choosing arbitrary parameters can make things worse. In this case, since the chosen standard parallels are relatively far from each other and from DC, all the data in between the standard parallels end up being compressed even more. For more information, check out this <a class="reference external" href="https://giscourses.cfans.umn.edu/sites/giscourses.cfans.umn.edu/files/understanding_map_projections.pdf">Esri publication on map projections</a>.</p>
</div>
<div class="section" id="setting-false-easting-and-false-northing">
<h5>Setting false easting and false northing<a class="headerlink" href="#setting-false-easting-and-false-northing" title="Permalink to this headline">#</a></h5>
<p>Finally, two other parameters we can change are <code class="docutils literal notranslate"><span class="pre">+x_0</span></code> and <code class="docutils literal notranslate"><span class="pre">+y_0</span></code>, which are false easting and false northing respectively. The values assigned to these parameters simply offset the axes by the respective values; they do not change or affect the projection. False easting (with a value of 500,000 m) is used in Universal Tranverse Mercator (UTM) projections so that negative coordinates are avoided to the west of the central meridian in each zone. Similarly, false northing (with a value of 10,000,000 m) is also used to avoid negative coordinates when a UTM zone is in the southern hemisphere.</p>
<p>Let’s set a false easting value of <code class="docutils literal notranslate"><span class="pre">500000</span></code> and a false northing value of <code class="docutils literal notranslate"><span class="pre">0</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create a copy of the DC shapefile</span>
<span class="n">dc_lcc_false_e</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="c1"># Reproject the data to Lambert Conformal Conic with specified center point, standard parallels, and false easting/northing</span>
<span class="n">dc_lcc_false_e</span> <span class="o">=</span> <span class="n">dc_lcc_false_e</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="s2">&quot;+proj=lcc +lat_0=38.9072 +lon_0=-77.0369 +lat_1=38.850 +lat_2=39.950 +x_0=500000 +y_0=0 +ellps=GRS80&quot;</span><span class="p">)</span>

<span class="c1"># Map reprojected DC shapefile</span>
<span class="n">map_data</span><span class="p">([</span><span class="n">dc_lcc_false_e</span><span class="p">],</span> <span class="s2">&quot;Washington, DC - Lambert Conformal Conic</span><span class="se">\n</span><span class="s2">False Easting&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/d_understand_crs_codes_25_0.png" src="../_images/d_understand_crs_codes_25_0.png" />
</div>
</div>
<p>Notice that the x-axis shifted to the left by 500,000 meters. The y-axis stayed the same because we did not use false northing. Now, the “origin” is <code class="docutils literal notranslate"><span class="pre">(500000,</span> <span class="pre">0)</span></code>.</p>
<p>Source: <a class="reference external" href="http://www.geo.hunter.cuny.edu/~jochen/gtech201/lectures/lec6concepts/Map%20coordinate%20systems/UTM%20and%20UPS.htm">Universal Transverse Mercator system, Hunter College Department of Geography and Environmental Science</a></p>
</div>
<div class="section" id="comparing-custom-projection-to-universal-tranverse-mercator">
<h5>Comparing custom projection to Universal Tranverse Mercator<a class="headerlink" href="#comparing-custom-projection-to-universal-tranverse-mercator" title="Permalink to this headline">#</a></h5>
<p>UTM is conformal. So let’s compare our custom projection to UTM Zone 18N (in which DC falls).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create a copy of the DC shapefile</span>
<span class="n">dc_utm18n</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="c1"># Reproject the data to UTM Zone 18N</span>
<span class="c1"># Source: https://www.spatialreference.org/ref/epsg/wgs-84-utm-zone-18n/</span>
<span class="n">dc_utm18n</span> <span class="o">=</span> <span class="n">dc_utm18n</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="s2">&quot;+proj=utm +zone=18 +ellps=WGS84 +datum=WGS84 +units=m +no_defs&quot;</span><span class="p">)</span>

<span class="c1"># Map reprojected DC shapefile</span>
<span class="n">map_data</span><span class="p">([</span><span class="n">dc_utm18n</span><span class="p">],</span> <span class="s2">&quot;Washington, DC - UTM Zone 18N&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/d_understand_crs_codes_27_0.png" src="../_images/d_understand_crs_codes_27_0.png" />
</div>
</div>
<p>Looks pretty much the same as our custom one!</p>
<p>Source: <a class="reference external" href="https://desktop.arcgis.com/en/arcmap/10.3/guide-books/map-projections/universal-transverse-mercator.htm">Universal Transverse Mercator, Esri</a></p>
</div>
</div>
</div>
<div class="section" id="epsg-codes">
<h3>EPSG Codes<a class="headerlink" href="#epsg-codes" title="Permalink to this headline">#</a></h3>
<p>Many CRSs are assigned and can be referenced by an <code class="docutils literal notranslate"><span class="pre">EPSG</span></code> code, which consists of a four or five digit number. <code class="docutils literal notranslate"><span class="pre">EPSG</span></code> stands for the European Petroleum Survey Group, a now-defunct organization that compiled this CRS dataset. <code class="docutils literal notranslate"><span class="pre">EPSG</span></code> codes can be further explored with the <a class="reference external" href="http://www.epsg-registry.org/">EPSG Geodetic Parameter Dataset</a> or at <a class="reference external" href="https://spatialreference.org/ref/epsg/">SpatialReference.org</a>.</p>
<p>Sources:
<a class="reference external" href="https://www.nceas.ucsb.edu/sites/default/files/2020-04/OverviewCoordinateReferenceSystems.pdf">Overview of Coordinate Reference Systems (CRS) in R, University of California, Santa Barbara</a>; <a class="reference external" href="https://www.earthdatascience.org/courses/use-data-open-source-python/intro-vector-data-python/spatial-data-vector-shapefiles/epsg-proj4-coordinate-reference-system-formats-python/">Lesson 4. Understand EPSG, WKT and Other CRS Definition Styles, Leah Wasser</a></p>
<div class="section" id="obtaining-epsg-code-from-proj-4-string">
<h4>Obtaining EPSG code from PROJ.4 string<a class="headerlink" href="#obtaining-epsg-code-from-proj-4-string" title="Permalink to this headline">#</a></h4>
<p>Not all CRSs have a corresponding <code class="docutils literal notranslate"><span class="pre">EPSG</span></code> code, but we can find the <code class="docutils literal notranslate"><span class="pre">EPSG</span></code> code (if it exists) given a <code class="docutils literal notranslate"><span class="pre">PROJ.4</span></code> string. To do so, we can use the <code class="docutils literal notranslate"><span class="pre">to_espg()</span></code> function in the <code class="docutils literal notranslate"><span class="pre">pyproj</span></code> module.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Import module</span>
<span class="kn">import</span> <span class="nn">pyproj</span>

<span class="k">def</span> <span class="nf">get_epsg</span><span class="p">(</span><span class="n">proj4_string</span><span class="p">,</span> <span class="n">min_confidence</span> <span class="o">=</span> <span class="mi">70</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Function takes a PROJ.4 string and optional minimum confidence level as inputs and outputs the relevant EPSG code, if one exists. Source: https://geopandas.org/docs/user_guide/projections.html&#39;&#39;&#39;</span>
    
    <span class="c1"># Get relevant EPSG at the specified minimum confidence level</span>
    <span class="k">return</span> <span class="n">pyproj</span><span class="o">.</span><span class="n">CRS</span><span class="p">(</span><span class="n">proj4_string</span><span class="p">)</span><span class="o">.</span><span class="n">to_epsg</span><span class="p">(</span><span class="n">min_confidence</span> <span class="o">=</span> <span class="n">min_confidence</span><span class="p">)</span>


<span class="c1"># Set variable to the PROJ.4 string of NAD83 / California zone 3</span>
<span class="c1"># Source: https://www.spatialreference.org/ref/epsg/26943/</span>
<span class="n">proj4_full</span> <span class="o">=</span> <span class="s2">&quot;+proj=lcc +lat_1=38.43333333333333 +lat_2=37.06666666666667 +lat_0=36.5 +lon_0=-120.5 +x_0=2000000 +y_0=500000 +ellps=GRS80 +datum=NAD83 +units=m +no_defs&quot;</span>

<span class="c1"># Call function to obtain relevant EPSG code</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">get_epsg</span><span class="p">(</span><span class="n">proj4_full</span><span class="p">)</span>

<span class="c1"># Print result</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;EPSG code for </span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">proj4_full</span><span class="p">,</span> <span class="n">result</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>EPSG code for +proj=lcc +lat_1=38.43333333333333 +lat_2=37.06666666666667 +lat_0=36.5 +lon_0=-120.5 +x_0=2000000 +y_0=500000 +ellps=GRS80 +datum=NAD83 +units=m +no_defs: 26943.
</pre></div>
</div>
</div>
</div>
<p>Success! In the example above, we were able to successfully obtain the <code class="docutils literal notranslate"><span class="pre">EPSG</span></code> code (in this case, <code class="docutils literal notranslate"><span class="pre">26943</span></code> for NAD83 / California zone 3) because it is exactly matched to the <code class="docutils literal notranslate"><span class="pre">PROJ.4</span></code> string. If we’re missing some information in the <code class="docutils literal notranslate"><span class="pre">PROJ.4</span></code> string, however, we might not be able to get an exact <code class="docutils literal notranslate"><span class="pre">EPSG</span></code> code match.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set variable to the PROJ.4 string of NAD83 / California zone 3, with a few parameters missing</span>
<span class="n">proj4_missing</span> <span class="o">=</span> <span class="s2">&quot;+proj=lcc +lat_1=38.43333333333333 +lat_2=37.06666666666667 +lat_0=36.5 +lon_0=-120.5 +ellps=GRS80 +datum=NAD83 +units=m +no_defs&quot;</span>

<span class="c1"># Call function to obtain relevant EPSG code</span>
<span class="n">result_missing</span> <span class="o">=</span> <span class="n">get_epsg</span><span class="p">(</span><span class="n">proj4_missing</span><span class="p">)</span>

<span class="c1"># Print result</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;EPSG code for </span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">proj4_missing</span><span class="p">,</span> <span class="n">result_missing</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>EPSG code for +proj=lcc +lat_1=38.43333333333333 +lat_2=37.06666666666667 +lat_0=36.5 +lon_0=-120.5 +ellps=GRS80 +datum=NAD83 +units=m +no_defs: None.
</pre></div>
</div>
</div>
</div>
<p>Source: <a class="reference external" href="https://geopandas.org/docs/user_guide/projections.html">Managing Projections: Coordinate Reference Systems, GeoPandas</a></p>
<div class="section" id="lowering-minimum-confidence-parameter">
<h5>Lowering minimum confidence parameter<a class="headerlink" href="#lowering-minimum-confidence-parameter" title="Permalink to this headline">#</a></h5>
<p>We can lower the min_confidence parameter value in the <code class="docutils literal notranslate"><span class="pre">to_epsg()</span></code> function, which will cause the function to return an <code class="docutils literal notranslate"><span class="pre">EPSG</span></code> code that is the closest match to the provided <code class="docutils literal notranslate"><span class="pre">PROJ.4</span></code> string.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Call function to obtain relevant EPSG code and lower the minimum confidence value</span>
<span class="n">result_lower_confidence</span> <span class="o">=</span> <span class="n">get_epsg</span><span class="p">(</span><span class="n">proj4_missing</span><span class="p">,</span> <span class="n">min_confidence</span> <span class="o">=</span> <span class="mi">20</span><span class="p">)</span>

<span class="c1"># Print result</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;EPSG code for </span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">proj4_missing</span><span class="p">,</span> <span class="n">result_lower_confidence</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>EPSG code for +proj=lcc +lat_1=38.43333333333333 +lat_2=37.06666666666667 +lat_0=36.5 +lon_0=-120.5 +ellps=GRS80 +datum=NAD83 +units=m +no_defs: 26943.
</pre></div>
</div>
</div>
</div>
<p>Source: <a class="reference external" href="https://geopandas.org/docs/user_guide/projections.html">Managing Projections: Coordinate Reference Systems, GeoPandas</a></p>
<p>To get the <code class="docutils literal notranslate"><span class="pre">PROJ.4</span></code> string from an <code class="docutils literal notranslate"><span class="pre">EPSG</span></code> code, we can <a class="reference external" href="https://rasterio.readthedocs.io/en/latest/api/rasterio.crs.html">use the <code class="docutils literal notranslate"><span class="pre">rasterio</span></code> module</a>.</p>
<p>Sources: <a class="reference external" href="https://www.nceas.ucsb.edu/sites/default/files/2020-04/OverviewCoordinateReferenceSystems.pdf">Overview of Coordinate Reference Systems (CRS) in R, University of California, Santa Barbara</a>; <a class="reference external" href="https://mgimond.github.io/Spatial/chp09-0.html">Chapter 9: Coordinate Systems, Manuel Gimond</a>; <a class="reference external" href="https://www.esri.com/arcgis-blog/products/arcgis-pro/mapping/coordinate-systems-difference/">Coordinate Systems: What’s the Difference?, Esri</a>; <a class="reference external" href="https://automating-gis-processes.github.io/CSC18/lessons/L2/projections.html">Map projections, Henrikki Tenkanen</a>; <a class="reference external" href="https://autogis-site.readthedocs.io/en/stable/notebooks/L2/projections.html">Map projections, Henrikki Tenkanen &amp; Vuokko Heikinheimo</a></p>
</div>
</div>
</div>
</div>
<span id="document-docs/d_affine"></span><hr class="docutils" id="d-affine" />
<div class="admonition-learning-objectives admonition">
<p class="admonition-title">Learning Objectives</p>
<ul class="simple">
<li><p>Learn how to use Affine transforms</p></li>
<li><p>Differentiate translate, rotate, skew, shear</p></li>
</ul>
</div>
<div class="admonition-review admonition">
<p class="admonition-title">Review</p>
<ul class="simple">
<li><p><a class="reference internal" href="docs/a_intro.html#document-docs/c_features"><span class="doc std std-doc">Data Structures</span></a></p></li>
<li><p><a class="reference internal" href="docs/a_intro.html#document-docs/c_vectors"><span class="doc std std-doc">Vector Data </span></a></p></li>
<li><p><a class="reference internal" href="docs/a_intro.html#document-docs/c_rasters"><span class="doc std std-doc">Raster Data </span></a></p></li>
<li><p><a class="reference external" href="https://youtu.be/OMA2Mwo0aZg">Matrix Algebra Intro</a></p></li>
</ul>
</div>
<hr class="docutils" />
<div class="tex2jax_ignore mathjax_ignore section" id="affine-transforms">
<h2>Affine Transforms<a class="headerlink" href="#affine-transforms" title="Permalink to this headline">#</a></h2>
<!-- https://docs.geotools.org/stable/userguide/tutorial/affinetransform.html -->
<!-- https://people.cs.clemson.edu/~dhouse/courses/401/notes/affines-matrices.pdf -->
<p>Affine transformations allows us to use simple systems of linear equations to manipulate any point or set of points. It allows us to move, stretch, or even rotate a point or set of points. In the case of GIS, it is used to distort raster data, for instance satellite imagery, to fit a new projection or CRS.</p>
<div class="figure align-default" id="example-of-a-warped-reprojected-image">
<img alt="../_images/warp.png" src="../_images/warp.png" />
<p class="caption"><span class="caption-number">Fig. 18 </span><span class="caption-text">Example of a warped (reprojected) image</span><a class="headerlink" href="#example-of-a-warped-reprojected-image" title="Permalink to this image">#</a></p>
</div>
<p>First some general properties of affine transforms:</p>
<ul class="simple">
<li><p><strong>Preserves</strong></p>
<ul>
<li><p>Points, straight linear &amp; planes</p></li>
<li><p>Sets of parallel lines</p></li>
<li><p>Ratio of distances between points on same straight line</p></li>
</ul>
</li>
<li><p><strong>Distorts</strong></p>
<ul>
<li><p>Angle between lines</p></li>
<li><p>Distance between points</p></li>
</ul>
</li>
</ul>
<div class="section" id="types-of-transformations">
<h3>Types of Transformations<a class="headerlink" href="#types-of-transformations" title="Permalink to this headline">#</a></h3>
<p>There are four core ways that you can manipulate an image. These are called “Transforms”:</p>
<table class="colwidths-auto docutils align-default">
<thead>
<tr class="row-odd"><th class="text-align:left head"><p>Transform</p></th>
<th class="text-align:right head"><p>Description</p></th>
<th class="text-align:right head"><p>Example</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td class="text-align:left"><p>Translation</p></td>
<td class="text-align:right"><p>Moves a set of points some fixed distance in the x and y plane</p></td>
<td class="text-align:right"><p><img alt="translate image" src="../_images/translate.png" /></p></td>
</tr>
<tr class="row-odd"><td class="text-align:left"><p>Scale</p></td>
<td class="text-align:right"><p>Increases or decreases the scale, or distance between points in the x and y plane</p></td>
<td class="text-align:right"><p><img alt="scale image" src="../_images/scale.png" /></p></td>
</tr>
<tr class="row-even"><td class="text-align:left"><p>Rotate</p></td>
<td class="text-align:right"><p>Rotates points around the origin, or some defined axis</p></td>
<td class="text-align:right"><p><img alt="rotate image" src="../_images/rotate.png" /></p></td>
</tr>
<tr class="row-odd"><td class="text-align:left"><p>Shear</p></td>
<td class="text-align:right"><p>Shifts points in proportion to any given points x and y coordinate</p></td>
<td class="text-align:right"><p><img alt="shear image" src="../_images/shear.png" /></p></td>
</tr>
<tr class="row-even"><td class="text-align:left"><p><em>Image Credit: <a class="reference external" href="https://en.wikipedia.org/wiki/Affine_transformation">Wikipedia</a></em></p></td>
<td class="text-align:right"><p></p></td>
<td class="text-align:right"><p></p></td>
</tr>
</tbody>
</table>
<p>In combination we can warp any point, or set of points (e.g. raster image) into a new projection. This is the equivalent of reprojection for vector data. In order to implement these transforms we will need to learn about the math behind <em>Affine Transforms</em>! Yeah!</p>
<div class="section" id="simple-transform-examples">
<span id="d-affine-simple"></span><h4>Simple Transform Examples<a class="headerlink" href="#simple-transform-examples" title="Permalink to this headline">#</a></h4>
<p>To simplify things first lets think about how to do transformations of a single point in a 2d space.</p>
<p>For any location <span class="math notranslate nohighlight">\( \mathbf{x} = (x,y)\)</span> we can transform <span class="math notranslate nohighlight">\( \mathbf{x} \)</span> to <span class="math notranslate nohighlight">\(\mathbf{\acute{x}}\)</span> using simple linear adjustments. Here we can think of point <span class="math notranslate nohighlight">\(\mathbf{x}\)</span> as being stored as an array:</p>
<div class="math notranslate nohighlight">
\[\begin{split}
   \begin{eqnarray}
      \mathbf{x}  =  \left[ \begin{array}{cc|r}x \\ y \end{array} \right] \mbox{can be transformed to } \mathbf{\acute{x}}  =  \left[ \begin{array}{cc|r}\acute{x} \\ \acute{y} \end{array} \right]
   \end{eqnarray} 
\end{split}\]</div>
<p>From here we can transform the values in the <span class="math notranslate nohighlight">\(x\)</span> and <span class="math notranslate nohighlight">\(y\)</span> position using scaler values <span class="math notranslate nohighlight">\(a\)</span> through <span class="math notranslate nohighlight">\(f\)</span>:</p>
<div class="math notranslate nohighlight">
\[\begin{split}
   \begin{eqnarray}
      \mathbf{\acute{x}}  =  \left[ \begin{array}{cc|r}ax+by+c \\ dx+ey+f \end{array} \right]
   \end{eqnarray}
\end{split}\]</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Looking at the formula above, we are adjusting the value of <span class="math notranslate nohighlight">\(x\)</span> with <span class="math notranslate nohighlight">\(ax+by+c\)</span>, so <span class="math notranslate nohighlight">\(x\)</span> can be multiplied (scaled) by some value <span class="math notranslate nohighlight">\(a\)</span>, it can also be scaled based on the <span class="math notranslate nohighlight">\(y\)</span> value with <span class="math notranslate nohighlight">\(+ by\)</span>, or simply adjusted up or down by the value <span class="math notranslate nohighlight">\(+ c\)</span></p>
</div>
<p>To understand how this works, let’s walk through the basic transformations of <span class="math notranslate nohighlight">\(\mathbf{x}\)</span>:</p>
<p>If we multiply <span class="math notranslate nohighlight">\(x\)</span> and <span class="math notranslate nohighlight">\(y\)</span> by one, by setting <span class="math notranslate nohighlight">\(a,e = 1\)</span>, and zero out the effect of the other axis, by setting <span class="math notranslate nohighlight">\(b,d = 0\)</span>, we have a simple case of translation, where <span class="math notranslate nohighlight">\(x\)</span> moves right by <span class="math notranslate nohighlight">\(c\)</span> and <span class="math notranslate nohighlight">\(y\)</span> up by the value of <span class="math notranslate nohighlight">\(f\)</span>:</p>
<div class="math notranslate nohighlight">
\[\begin{split}
   \begin{eqnarray}
      \mathbf{\acute{x}}  =  \left[ \begin{array}{cc|r}1x+0y+c \\ 0x+1y+f \end{array} \right]
   \end{eqnarray}
\end{split}\]</div>
<div class="figure align-default" id="translate-a-coordinate">
<img alt="../_images/translate_coord.png" src="../_images/translate_coord.png" />
<p class="caption"><span class="caption-number">Fig. 19 </span><span class="caption-text">Translate a coordinate</span><a class="headerlink" href="#translate-a-coordinate" title="Permalink to this image">#</a></p>
</div>
<p>We can scale <span class="math notranslate nohighlight">\(x\)</span> and <span class="math notranslate nohighlight">\(y\)</span> by setting <span class="math notranslate nohighlight">\(a\)</span> and <span class="math notranslate nohighlight">\(e\)</span> to 0.5 (or some fraction), and setting all other values to zero (<span class="math notranslate nohighlight">\(b,d,c,f = 0\)</span>):</p>
<div class="math notranslate nohighlight">
\[\begin{split}
   \begin{eqnarray}
      \mathbf{\acute{x}}  =  \left[ \begin{array}{cc|r}ax \\ ey \end{array} \right]
   \end{eqnarray}
\end{split}\]</div>
<div class="figure align-default" id="scale-a-coordinate">
<img alt="../_images/scale_coord.png" src="../_images/scale_coord.png" />
<p class="caption"><span class="caption-number">Fig. 20 </span><span class="caption-text">Scale a coordinate</span><a class="headerlink" href="#scale-a-coordinate" title="Permalink to this image">#</a></p>
</div>
<p>We can rotate a point around the origin by setting <span class="math notranslate nohighlight">\(a,e = \cos\theta\)</span>, <span class="math notranslate nohighlight">\(b = -\sin\theta\)</span> and <span class="math notranslate nohighlight">\(c,f = 0\)</span>:</p>
<div class="math notranslate nohighlight">
\[\begin{split}
   \begin{eqnarray}
      \mathbf{\acute{x}}  =  \left[ \begin{array}{cc|r} x\cos\theta - y\sin\theta \\ x\sin\theta+y\cos\theta \end{array} \right]
   \end{eqnarray}
\end{split}\]</div>
<p>where <span class="math notranslate nohighlight">\(\theta\)</span> is the angle of rotation (counterclockwise) around the origin.</p>
<div class="figure align-default" id="rotate-a-coordinate">
<img alt="../_images/rotate_coord.png" src="../_images/rotate_coord.png" />
<p class="caption"><span class="caption-number">Fig. 21 </span><span class="caption-text">Rotate a coordinate</span><a class="headerlink" href="#rotate-a-coordinate" title="Permalink to this image">#</a></p>
</div>
<p>Finally by adjusting <span class="math notranslate nohighlight">\(x\)</span> based on the value of <span class="math notranslate nohighlight">\(y\)</span> (and visa versa), we can achieve a shear transform:</p>
<div class="math notranslate nohighlight">
\[\begin{split}
   \begin{eqnarray}
      \mathbf{\acute{x}}  =  \left[ \begin{array}{cc|r} x+by \\ y+dx \end{array} \right]
   \end{eqnarray}
\end{split}\]</div>
<div class="figure align-default" id="shear-transform-a-coordinate">
<img alt="../_images/shear_coord.png" src="../_images/shear_coord.png" />
<p class="caption"><span class="caption-number">Fig. 22 </span><span class="caption-text">Shear transform a coordinate</span><a class="headerlink" href="#shear-transform-a-coordinate" title="Permalink to this image">#</a></p>
</div>
</div>
<div class="section" id="transforming-matrices">
<span id="d-affine-transform-matrix"></span><h4>Transforming Matrices<a class="headerlink" href="#transforming-matrices" title="Permalink to this headline">#</a></h4>
<p>It is often convenient to represent these equations as matrices. This allows us to easily chain together a series of operations. We can represent our transformed point <span class="math notranslate nohighlight">\(\mathbf{\acute{x}}\)</span> as follows:</p>
<div class="math notranslate nohighlight">
\[\begin{split}
   \begin{eqnarray}
    \left[ \begin{array}{cc|r} \acute{x} \\ \acute{y} \end{array} \right] =
    \left[ \begin{array}{cc|r} ax+by \\ dx+ey \end{array} \right]  =
    \left[ \begin{array}{cc|r} a \ \ b \\ d \ \ e \end{array} \right] \left[ \begin{array}{cc|r} x \\ y \end{array} \right] 
     
   \end{eqnarray}
\end{split}\]</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you aren’t familiar with how matrix multiplication works please watch <a class="reference external" href="https://youtu.be/OMA2Mwo0aZg">this</a>.</p>
</div>
<p>In this new context we can easily do a scale, rotate or shear transform by replacing the matrix of <span class="math notranslate nohighlight">\(a,b,d,e\)</span> with:</p>
<div class="math notranslate nohighlight">
\[\begin{split}
   \begin{eqnarray}
     \mbox{Rotate: } \left[ \begin{array}{cc|r} \cos\theta \ \ -\sin\theta \\  \sin\theta \ \ \cos\theta  \end{array} \right] 
   \end{eqnarray}
\end{split}\]</div>
<div class="math notranslate nohighlight">
\[\begin{split}
   \begin{eqnarray}
     \mbox{Scale: } \left[ \begin{array}{cc|r} S_{x} \ \ 0  \\ 0 \ \ S_{y}  \end{array} \right] 
   \end{eqnarray}
\end{split}\]</div>
<div class="math notranslate nohighlight">
\[\begin{split}
   \begin{eqnarray}
   \mbox{Shear: } \left[ \begin{array}{cc|r} 1 \ \ r_{x} \\ r_{y} \ \ 1  \end{array} \right] 
   \end{eqnarray}
\end{split}\]</div>
<p><em>But wait, what about the easiest transform, “translation”?</em> Unfortunately that makes things a little more complicated! But not that complicated.</p>
<p>In order to be able to perform a translate in matrix form we need to extend our matrices, adding one row along the bottom.  In the following form we can now perform all the basic transformations to calculate <span class="math notranslate nohighlight">\(
\mathbf{\acute{x}}\)</span>:</p>
<div class="math notranslate nohighlight">
\[\begin{split}
   \begin{eqnarray}
    \left[ \begin{array}{cc|r} \acute{x} \\ \acute{y} \\ 1 \end{array} \right] =
    \left[ \begin{array}{cc|r} a \ \ b \ \ c \\ d \ \ e \ \ f \\ 0 \ \ 0 \ \ 1 \end{array} \right] 
    \left[ \begin{array}{cc|r} x \\ y \\ 1  \end{array} \right] =
    \left[ \begin{array}{cc|r} ax+by+c \\ dx+ey+f \\ 1 \end{array} \right] 
     
   \end{eqnarray}
\end{split}\]</div>
<p id="d-affine-trans-scale">Now that we have scalers <span class="math notranslate nohighlight">\(c\)</span> and <span class="math notranslate nohighlight">\(f\)</span> all the transforms are possible. We do however, need to update our previous operations:</p>
<div class="math notranslate nohighlight">
\[\begin{split}
   \begin{eqnarray}
     \mbox{Translate: }  \begin{bmatrix} 1 &amp; 0 &amp; \Delta x \\  0 &amp; 1 &amp; \Delta y \\ 0 &amp; 0 &amp; 1 \end{bmatrix}  
   \end{eqnarray}
\end{split}\]</div>
<p>Where <span class="math notranslate nohighlight">\(\Delta x\)</span> shifts in the <span class="math notranslate nohighlight">\(x\)</span> axis and <span class="math notranslate nohighlight">\(\Delta y\)</span> determines the shift in the <span class="math notranslate nohighlight">\(y\)</span> axis.</p>
<div class="math notranslate nohighlight">
\[\begin{split}
   \begin{eqnarray}
     \mbox{Rotate: } \begin{bmatrix} \cos\theta &amp; -\sin\theta &amp; 0 \\  \sin\theta &amp; \cos\theta &amp; 0 \\ 0 &amp; 0 &amp; 1 \end{bmatrix} 
   \end{eqnarray}
\end{split}\]</div>
<div class="math notranslate nohighlight">
\[\begin{split}
   \begin{eqnarray}
   \mbox{Scale: }  \begin{bmatrix} S_{x} &amp; 0 &amp; 0 \\ 0 &amp; S_{y} &amp; 0 \\ 0 &amp; 0 &amp; 1 \end{bmatrix} 
   \end{eqnarray}
\end{split}\]</div>
<div class="math notranslate nohighlight">
\[\begin{split}
   \begin{eqnarray}
   \mbox{Shear: }  \begin{bmatrix} 1 &amp; r_{x} &amp; 0 \\ r_{y} &amp; 1 &amp; 0 \\ 0 &amp; 0 &amp; 1 \end{bmatrix} 
   \end{eqnarray}
\end{split}\]</div>
</div>
<div class="section" id="numeric-examples">
<h4>Numeric Examples<a class="headerlink" href="#numeric-examples" title="Permalink to this headline">#</a></h4>
<div class="section" id="translate">
<span id="d-affine-trans"></span><h5>Translate<a class="headerlink" href="#translate" title="Permalink to this headline">#</a></h5>
<p>Now let’s assume we have a point a at (-2,-2) for (x,y). For simplicity sake lets assume we want to move it up to the origin by adding 2 to both x and y.</p>
<p>Let’s start by defining our point in our matrix form:</p>
<div class="math notranslate nohighlight">
\[\begin{split}
   \begin{eqnarray}
    \begin{bmatrix} x \\ y \\ 1 \end{bmatrix}  =  \begin{bmatrix} -2 \\ -2 \\ 1 \end{bmatrix}  
   \end{eqnarray}
\end{split}\]</div>
<p>Let’s get our transform matrix <span class="math notranslate nohighlight">\(M\)</span> to perform our translate, where <span class="math notranslate nohighlight">\(\Delta x, \Delta y = 2\)</span> because we want to move it up and to the right:</p>
<div class="math notranslate nohighlight">
\[\begin{split}
   \begin{eqnarray}
      \begin{bmatrix} 1 &amp; 0 &amp; 2 \\  0 &amp; 1 &amp; 2 \\ 0 &amp; 0 &amp; 1 \end{bmatrix}  
   \end{eqnarray}
\end{split}\]</div>
<p>We can then multiply the two:</p>
<div class="math notranslate nohighlight">
\[\begin{split}
   \begin{eqnarray}
      \begin{bmatrix} -2 \\ -2 \\ 1 \end{bmatrix}   \begin{bmatrix} 1 &amp; 0 &amp; 2 \\  0 &amp; 1 &amp; 2 \\ 0 &amp; 0 &amp; 1 \end{bmatrix}  =
      \begin{bmatrix} -2 \times 1 + -2 \times 0 + 1 \times 2  \\  -2 \times 0 + -2 \times 1 + 1 \times 2 \\ -2 \times 0 + -2 \times 0 + 1 \times 1  \end{bmatrix} = 
      \begin{bmatrix} 0  \\  0 \\ 1  \end{bmatrix}
   \end{eqnarray}
\end{split}\]</div>
<p>Congrats you reached (0,0), just like you always dreamed!</p>
<div class="figure align-default" id="moving-a-point">
<img alt="../_images/translate_ex.png" src="../_images/translate_ex.png" />
<p class="caption"><span class="caption-number">Fig. 23 </span><span class="caption-text">Moving a point</span><a class="headerlink" href="#moving-a-point" title="Permalink to this image">#</a></p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Remember the bottom row can be ignored because <span class="math notranslate nohighlight">\( \begin{bmatrix} x  \\  y \\ 1  \end{bmatrix}\)</span></p>
</div>
</div>
<div class="section" id="rotate">
<h5>Rotate<a class="headerlink" href="#rotate" title="Permalink to this headline">#</a></h5>
<p>All the transformations follow the same procedure, let’s try rotation just to make sure that we have it figured out. Let’s rotate our point at (-2,-2) by 180 degrees around the origin:</p>
<div class="math notranslate nohighlight">
\[\begin{split}
   \begin{eqnarray}
     \begin{bmatrix} -2 \\ -2 \\  1 \end{bmatrix} 
     \begin{bmatrix} \cos{180} &amp; -\sin{180} &amp; 0 \\  \sin{180} &amp; \cos{180} &amp; 0 \\ 0 &amp; 0 &amp; 1 \end{bmatrix}  =
   \end{eqnarray}
\end{split}\]</div>
<div class="math notranslate nohighlight">
\[\begin{split}
   \begin{eqnarray}
     \begin{bmatrix} -2 \times \cos{180} + -2 \times -\sin{180} + 1 \times 0 \\ -2 \times \sin{180} + -2 \times \cos{180} + 1 \times 0 \\ 1 \times 0 + 1 \times 0 + 1 \times 1 \end{bmatrix}  =  \begin{bmatrix} 2 \\ 2 \\  1 \end{bmatrix} 
   \end{eqnarray}
\end{split}\]</div>
<div class="figure align-default" id="rotate-a-point">
<img alt="../_images/rotate_ex.png" src="../_images/rotate_ex.png" />
<p class="caption"><span class="caption-number">Fig. 24 </span><span class="caption-text">Rotate a point</span><a class="headerlink" href="#rotate-a-point" title="Permalink to this image">#</a></p>
</div>
</div>
</div>
</div>
</div>
<span id="document-docs/d_vector_crs_intro"></span><hr class="docutils" id="d-vector-crs-intro" />
<div class="admonition-learning-objectives admonition">
<p class="admonition-title">Learning Objectives</p>
<ul class="simple">
<li><p>How to assign a projection to vector data</p></li>
<li><p>How to reproject vector data</p></li>
</ul>
</div>
<div class="admonition-review admonition">
<p class="admonition-title">Review</p>
<ul class="simple">
<li><p><a class="reference internal" href="docs/a_intro.html#document-docs/d_understand_crs_codes"><span class="doc std std-doc">Understanding CRS codes</span></a></p></li>
<li><p><a class="reference internal" href="docs/a_intro.html#document-docs/c_new_vectors"><span class="doc std std-doc">Creating Points, Lines, Polygons</span></a></p></li>
</ul>
</div>
<hr class="docutils" />
<div class="tex2jax_ignore mathjax_ignore section" id="vector-coordinate-reference-systems-crs">
<h2>Vector Coordinate Reference Systems (CRS)<a class="headerlink" href="#vector-coordinate-reference-systems-crs" title="Permalink to this headline">#</a></h2>
<p>When it comes to coordinate reference systems points, lines and polygons are convenient because each point or node has an assigned coordinate pair (x,y). The only trick then is to know how those coordinates relate to the coordinate space, or location on the ground.</p>
<div class="section" id="define-a-projection-for-points-lines-polygons">
<h3>Define a Projection for Points, Lines, Polygons<a class="headerlink" href="#define-a-projection-for-points-lines-polygons" title="Permalink to this headline">#</a></h3>
<p>When a point, line or polyon is created each point or node has two coordinates <code class="docutils literal notranslate"><span class="pre">x</span></code> and <code class="docutils literal notranslate"><span class="pre">y</span></code>. The location of these two points on the ground will change wildly between projections. The coordinate pair (0,0) might mean a location just off shore from Ghana with WGS84 LatLon, or in the middle of the Pacific ocean in another.</p>
<p>Let’s take a look at the example of a polygon with coordinates (0,45),(5,45),(5,40),(0,40) below. In the left pane we can see that, although we have the polygon’s node coordinates, we don’t know where they are located! This is because no coordinate reference system has been assigned to it. Could be in outer space for all we know. On the right, we can see that we have assigned it WGS84 geographic lat lon i.e. <code class="docutils literal notranslate"><span class="pre">EPSG:4326</span></code>. Suddenly the coordinates make sense, because we know how they relate to locations on the ground.</p>
<div class="figure align-default" id="example-of-assigning-a-coordinate-reference-system">
<a class="reference internal image-reference" href="../_images/d_crs_assigned.png"><img alt="../_images/d_crs_assigned.png" src="../_images/d_crs_assigned.png" style="width: 700px;" /></a>
<p class="caption"><span class="caption-number">Fig. 25 </span><span class="caption-text">Example of assigning a coordinate reference system</span><a class="headerlink" href="#example-of-assigning-a-coordinate-reference-system" title="Permalink to this image">#</a></p>
</div>
<p>Every time we create vector data (or receive it from someone else), we need to make sure that a projection is assigned to it.</p>
<p>The following demonstrates how to</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">geopandas</span> <span class="k">as</span> <span class="nn">gpd</span>
<span class="kn">from</span> <span class="nn">shapely.geometry</span> <span class="kn">import</span> <span class="n">Point</span><span class="p">,</span> <span class="n">Polygon</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;bmh&#39;</span><span class="p">)</span>  

<span class="n">a_square</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Washington</span><span class="se">\n</span><span class="s1">(38.90, -77.03)&#39;</span> <span class="p">],</span> 
     <span class="s1">&#39;geometry&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">Polygon</span><span class="p">([</span><span class="n">Point</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">45</span><span class="p">),</span> <span class="n">Point</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">45</span><span class="p">),</span> <span class="n">Point</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">40</span><span class="p">),</span> <span class="n">Point</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">40</span><span class="p">)])]}</span>

<span class="c1"># create a dataframe from the nodes and assign the CRS</span>
<span class="n">gdf_square</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">a_square</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="s2">&quot;EPSG:4326&quot;</span><span class="p">)</span>  
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">gdf_square</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mi">38</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/d_vector_crs_intro_1_0.png" src="../_images/d_vector_crs_intro_1_0.png" />
</div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Take a moment to review proj4 string and EPSG codes <a class="reference internal" href="docs/a_intro.html#document-docs/d_understand_crs_codes"><span class="doc std std-doc">here</span></a></p>
</div>
</div>
<div class="section" id="reproject-points-lines-polygons">
<h3>Reproject Points, Lines, Polygons<a class="headerlink" href="#reproject-points-lines-polygons" title="Permalink to this headline">#</a></h3>
<p>Once a projection is assigned we often have to ‘reproject’ it to another one. Reprojection entails using a set of formulas to convert (x,y) stored in latitude and longitude into another coordinate space. This entails a two step process.</p>
<p>Looking at the example below, we will move from Sinosoidal to Hobo-Dyer. The first step however is to use the “inverse equation” to convert coordinate pairs from Sinosoidal back to lat lon, and the use the forward equation to convert lat lon into the Hobo-Dyer coordinate space.</p>
<div class="figure align-default" id="reprojecting-vectors-with-inverse-and-forward-equations">
<a class="reference internal image-reference" href="../_images/d_reprojection_example.jpg"><img alt="../_images/d_reprojection_example.jpg" src="../_images/d_reprojection_example.jpg" style="width: 500px;" /></a>
<p class="caption"><span class="caption-number">Fig. 26 </span><span class="caption-text">Reprojecting vectors with inverse and forward equations</span><a class="headerlink" href="#reprojecting-vectors-with-inverse-and-forward-equations" title="Permalink to this image">#</a></p>
</div>
<!-- Affine transformations allows us to use simple systems of linear equations to manipulate any point or set of points. It allows us to move, stretch, or even rotate a point or set of points. In this case it is used to move and reshape vector data (point, lines, polygons). In this case we will learn how affine transforms are used to reproject data. -->
<p>These ‘forward’ and ‘inverse’ equations can be simple or complex. To make things easy to understand lets look at the example of reprojecting from proj4 code <code class="docutils literal notranslate"><span class="pre">+proj=longlat</span> <span class="pre">+datum=WGS84</span></code> to <code class="docutils literal notranslate"><span class="pre">+proj=longlat</span> <span class="pre">+datum=WGS84</span> <span class="pre">+lon_0=-10</span></code>, where <code class="docutils literal notranslate"><span class="pre">+lon_0=-10</span></code> just moves the prime meridian 10 degrees west (west is negative). Because we are already in latitude and longitude we can ignore the ‘inverse’ equation and just look at the ‘forward’ equation.</p>
<p>In this case the ‘forward’ equation is very simple:</p>
<div class="math notranslate nohighlight">
\[
x = x + 10 
\]</div>
<div class="math notranslate nohighlight">
\[
y = y
\]</div>
<p>As result the polygon remains in the same location, but in the ‘new’ projection longitude values are now all 10 degrees higher.</p>
<div class="figure align-default" id="reprojecting-by-moving-the-prime-meridian-west">
<a class="reference internal image-reference" href="../_images/d_europe_translate_vector.png"><img alt="../_images/d_europe_translate_vector.png" src="../_images/d_europe_translate_vector.png" style="width: 500px;" /></a>
<p class="caption"><span class="caption-number">Fig. 27 </span><span class="caption-text">Reprojecting by moving the prime meridian west</span><a class="headerlink" href="#reprojecting-by-moving-the-prime-meridian-west" title="Permalink to this image">#</a></p>
</div>
<p>Most ‘forward’ and ‘inverse’ equations are non-linear and more complex. Take for instance the Gall-Peters forward projection equations are shown below:</p>
<div class="math notranslate nohighlight">
\[
x=\frac {R\pi \lambda \cos 45^{\circ }}{180^{\circ }}
\]</div>
<div class="math notranslate nohighlight">
\[
y={\frac {R\sin \varphi }{\cos 45^{\circ }}} 
\]</div>
<p>where <span class="math notranslate nohighlight">\(\lambda\)</span> is the longitude from the central meridian in degrees, <span class="math notranslate nohighlight">\(\varphi\)</span> is the latitude, and R is the radius of the globe used as the model of the earth for projection. Luckily computers make all these calculation quick and easy.</p>
<p>Refering back to our previous example, let’s use geopandas to move the prime meridian 10 degrees west:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># reproject the data</span>
<span class="n">gdf_square_10w</span> <span class="o">=</span> <span class="n">gdf_square</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="s2">&quot;+proj=longlat +datum=WGS84 +lon_0=-10&quot;</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">gdf_square_10w</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mi">38</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/d_vector_crs_intro_3_0.png" src="../_images/d_vector_crs_intro_3_0.png" />
</div>
</div>
<p>Note the shift in coordinates along x by 10 degrees west.</p>
<!--
https://kartoweb.itc.nl/geometrics/Coordinate%20transformations/coordtrans.html

 https://geopandas.org/gallery/plotting_with_geoplot.html

https://geocompr.robinlovelace.net/geometric-operations.html
 In this section we will learn how to reproject vector data:


 Affine transformation is any transformation that preserves lines and parallelism. However, angles or length are not necessarily preserved. Affine transformations include, among others, shifting (translation), scaling and rotation. Additionally, it is possible to use any combination of these. Affine transformations are an essential part of geocomputation. For example, shifting is needed for labels placement, scaling is used in non-contiguous area cartograms (see Section 8.6), and many affine transformations are applied when reprojecting or improving the geometry that was created based on a distorted or wrongly projected map. The sf package implements affine transformation for objects of classes sfg and sfc.

nz_sfc = st_geometry(nz)

Shifting moves every point by the same distance in map units. It could be done by adding a numerical vector to a vector object. For example, the code below shifts all y-coordinates by 100,000 meters to the north, but leaves the x-coordinates untouched (left panel of Figure 5.5).

nz_shift = nz_sfc + c(0, 100000)

Scaling enlarges or shrinks objects by a factor. It can be applied either globally or locally. Global scaling increases or decreases all coordinates values in relation to the origin coordinates, while keeping all geometries topological relations intact. It can be done by subtraction or multiplication of asfg or sfc object.

Local scaling treats geometries independently and requires points around which geometries are going to be scaled, e.g., centroids. In the example below, each geometry is shrunk by a factor of two around the centroids (middle panel in Figure 5.5). To achieve that, each object is firstly shifted in a way that its center has coordinates of 0, 0 ((nz_sfc - nz_centroid_sfc)). Next, the sizes of the geometries are reduced by half (* 0.5). Finally, each object’s centroid is moved back to the input data coordinates (+ nz_centroid_sfc).

nz_centroid_sfc = st_centroid(nz_sfc)
nz_scale = (nz_sfc - nz_centroid_sfc) * 0.5 + nz_centroid_sfc

Rotation of two-dimensional coordinates requires a rotation matrix:

R=[cosθ−sinθsinθcosθ]

It rotates points in a clockwise direction. The rotation matrix can be implemented in R as:

rotation = function(a){
  r = a * pi / 180 #degrees to radians
  matrix(c(cos(r), sin(r), -sin(r), cos(r)), nrow = 2, ncol = 2)
} 

The rotation function accepts one argument a - a rotation angle in degrees. Rotation could be done around selected points, such as centroids (right panel of Figure 5.5). See vignette("sf3") for more examples.

nz_rotate = (nz_sfc - nz_centroid_sfc) * rotation(30) + nz_centroid_sfc

Illustrations of affine transformations: shift, scale and rotate.

FIGURE 5.5: Illustrations of affine transformations: shift, scale and rotate.

Finally, the newly created geometries can replace the old ones with the st_set_geometry() function:

nz_scale_sf = st_set_geometry(nz, nz_scale) --></div>
</div>
<span id="document-docs/d_raster_crs_intro"></span><hr class="docutils" id="d-raster-crs-intro" />
<div class="admonition-learning-objectives admonition">
<p class="admonition-title">Learning Objectives</p>
<ul class="simple">
<li><p>Learn how rasters are reprojected</p></li>
<li><p>Learn how affine transforms are used</p></li>
<li><p>Use rasterio to reproject a raster</p></li>
<li><p>Learn about interpolation options during transforms</p></li>
</ul>
</div>
<div class="admonition-review admonition">
<p class="admonition-title">Review</p>
<ul class="simple">
<li><p><a class="reference internal" href="docs/a_intro.html#document-docs/c_rasters"><span class="doc std std-doc">Intro to Raster data</span></a></p></li>
<li><p><a class="reference internal" href="docs/a_intro.html#document-docs/d_affine"><span class="doc std std-doc">Affine transformation</span></a></p></li>
</ul>
</div>
<hr class="docutils" />
<div class="tex2jax_ignore mathjax_ignore section" id="raster-coordinate-reference-systems-crs">
<h2>Raster Coordinate Reference Systems (CRS)<a class="headerlink" href="#raster-coordinate-reference-systems-crs" title="Permalink to this headline">#</a></h2>
<p>Raster data is very different that vector data, one of the key differences is that we don’t have a pair of coordinates (x,y) for each pixel in a raster. How then do we know where the raster is located in addition to what the data values are? For a new spatial raster (e.g. geotif) we need to store a few other pieces of information seperately. We need to keep track of the location of the upper left hand corner, the resolution (in both the x and y direction) and a description of the coordinate space (i.e. the CRS), amongst others.</p>
<div class="figure align-default" id="example-of-a-warped-reprojected-image">
<img alt="../_images/warp.png" src="../_images/warp.png" />
<p class="caption"><span class="caption-number">Fig. 28 </span><span class="caption-text">Example of a warped (reprojected) image</span><a class="headerlink" href="#example-of-a-warped-reprojected-image" title="Permalink to this image">#</a></p>
</div>
<p>Let’s start from the <code class="docutils literal notranslate"><span class="pre">ndarray</span></code> <code class="docutils literal notranslate"><span class="pre">Z</span></code> that we want to span from [-90°,90°] longitude, and [-90°,90°] latitude. For more detail on the construction of these arrays please refer to <a class="reference internal" href="docs/a_intro.html#document-docs/c_rasters"><span class="doc std std-doc">the raster section</span></a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">90</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">90</span><span class="p">,</span> <span class="o">-</span><span class="mi">90</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
<span class="n">X</span><span class="p">,</span> <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

<span class="n">Z1</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(((</span><span class="n">X</span> <span class="o">-</span> <span class="mi">10</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">Y</span> <span class="o">-</span> <span class="mi">10</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">Z2</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(((</span><span class="n">X</span> <span class="o">+</span> <span class="mi">10</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">Y</span> <span class="o">+</span> <span class="mi">10</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.5</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">Z</span> <span class="o">=</span>  <span class="p">(</span><span class="n">Z1</span> <span class="o">-</span> <span class="n">Z2</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">Z</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Temperature&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/d_raster_crs_intro_1_0.png" src="../_images/d_raster_crs_intro_1_0.png" />
</div>
</div>
<p>Note that <em><code class="docutils literal notranslate"><span class="pre">Z</span></code> contains no data on its location</em>. Its just an array, the information stored in <code class="docutils literal notranslate"><span class="pre">x</span></code> and <code class="docutils literal notranslate"><span class="pre">y</span></code> aren’t associated with it at all. This location data will often be stored in the header of file. In order to ‘locate’ the array on the map we will use affine transformations.</p>
<p>Affine transformations allows us to use simple systems of linear equations to manipulate any point or set of points (<a class="reference internal" href="docs/a_intro.html#document-docs/d_affine"><span class="doc std std-doc">review affine transforms here</span></a>). It allows us to move, stretch, or even rotate a point or set of points. In the case of GIS, it is used to move raster data, a satellite image, to the correct location in the CRS coordinate space.</p>
<div class="section" id="describing-the-array-location-define-a-projection">
<h3>Describing the Array Location (Define a Projection)<a class="headerlink" href="#describing-the-array-location-define-a-projection" title="Permalink to this headline">#</a></h3>
<p>In this example the coordinate reference system will be ‘+proj=latlong’, which describes an equirectangular coordinate reference system with units of decimal degrees. Although <code class="docutils literal notranslate"><span class="pre">X</span></code> and <code class="docutils literal notranslate"><span class="pre">Y</span></code> seems relevant to understanding the location of cell values, <code class="docutils literal notranslate"><span class="pre">rasterio</span></code> instead uses affine transformations instead. Affine transforms uses matrix algebra to describe where a cell is located (translation) and what its resolution is (scale). <span class="xref myst">Review affine transformations</span> and <span class="xref myst">see an example here</span>.</p>
<p>The affine transformation matrix can be computed from the matrix product of a translation (moving N,S,E,W) and a scaling (resolution). First, we start with translation where <span class="math notranslate nohighlight">\(\Delta x\)</span> and <span class="math notranslate nohighlight">\(\Delta y\)</span> define the location of the upper left hand corner of our new <code class="docutils literal notranslate"><span class="pre">Z</span></code> ndarray. As a reminder the translation matrix takes the form:</p>
<div class="math notranslate nohighlight">
\[\begin{split}
   \begin{eqnarray}
     \mbox{Translate} =  \begin{bmatrix} 1 &amp; 0 &amp; \Delta x \\  0 &amp; 1 &amp; \Delta y \\ 0 &amp; 0 &amp; 1 \end{bmatrix}  
   \end{eqnarray}
\end{split}\]</div>
<p>Now we can define our translation matrix using the point coordinates (<code class="docutils literal notranslate"><span class="pre">x[0]</span></code>,<code class="docutils literal notranslate"><span class="pre">y[0]</span></code>), but these need to be offset by 1/2 the resolution so that the cell is centered over the coordinate (-90,90). Notice however there are some difference between the x and y resolution:</p>
<p>Both arrays have the same spatial resolution</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">xres</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">xres</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>30.0
</pre></div>
</div>
</div>
</div>
<p>But notice that the y resolution is <strong>negative</strong>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">yres</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
<span class="n">yres</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-30.0
</pre></div>
</div>
</div>
</div>
<p>We need to create our translation matrix by defining the location of the upper left hand corner. Looking back at our definitions of our coordinates <code class="docutils literal notranslate"><span class="pre">X</span></code> and <code class="docutils literal notranslate"><span class="pre">Y</span></code> we can see that they are defined with <code class="docutils literal notranslate"><span class="pre">x</span> <span class="pre">=</span> <span class="pre">np.linspace(-90,</span> <span class="pre">90,</span> <span class="pre">6);</span> <span class="pre">y</span> <span class="pre">=</span> <span class="pre">np.linspace(90,</span> <span class="pre">-90,</span> <span class="pre">6);</span> <span class="pre">X,</span> <span class="pre">Y</span> <span class="pre">=</span> <span class="pre">np.meshgrid(x,</span> <span class="pre">y)</span></code>, if you run <code class="docutils literal notranslate"><span class="pre">print(X);print(Y)</span></code> you will see that the <strong>center</strong> of the upper left hand corner should be located at (-90,90). The <strong>upper left hand corner</strong> of that same cell is actually further up and to the left than (-90,90). It follows then that that corner should be shifted exactly 1/2 the resolution of the cell, both up and to the left.</p>
<p>We can therefore define the upper left hand corner by setting <span class="math notranslate nohighlight">\(\Delta x = x[0] - xres / 2\)</span> and <span class="math notranslate nohighlight">\(\Delta y = y[0] - yres / 2\)</span>. Remember yres is negative, so subtraction is correct.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">rasterio.transform</span> <span class="kn">import</span> <span class="n">Affine</span>
<span class="nb">print</span><span class="p">(</span><span class="n">Affine</span><span class="o">.</span><span class="n">translation</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">xres</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">yres</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>| 1.00, 0.00,-105.00|
| 0.00, 1.00, 105.00|
| 0.00, 0.00, 1.00|
</pre></div>
</div>
</div>
</div>
<p>We also need to scale our data based on the resolution of each cell, the scale matrix takes the following form:</p>
<div class="math notranslate nohighlight">
\[\begin{split}
   \begin{eqnarray}
   \mbox{Scale} = \begin{bmatrix} xres &amp; 0 &amp; 0 \\ 0 &amp; yres &amp; 0 \\ 0 &amp; 0 &amp; 1 \end{bmatrix} 
   \end{eqnarray}
\end{split}\]</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">Affine</span><span class="o">.</span><span class="n">scale</span><span class="p">(</span><span class="n">xres</span><span class="p">,</span> <span class="n">yres</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>| 30.00, 0.00, 0.00|
| 0.00,-30.00, 0.00|
| 0.00, 0.00, 1.00|
</pre></div>
</div>
</div>
</div>
<p>We can do both operations simultaneously in a new <code class="docutils literal notranslate"><span class="pre">transform</span></code> matrix by calculating the product of the Translate and Scale matrix:</p>
<div class="math notranslate nohighlight">
\[\begin{split}
    \mbox{Translate} \cdot \mbox{Scale} =  \begin{bmatrix} xres &amp; 0 &amp; \Delta x \\ 0 &amp; yres &amp; \Delta y \\ 0 &amp; 0 &amp; 1 \end{bmatrix} 
\end{split}\]</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">transform</span> <span class="o">=</span> <span class="n">Affine</span><span class="o">.</span><span class="n">translation</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">xres</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">yres</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">Affine</span><span class="o">.</span><span class="n">scale</span><span class="p">(</span><span class="n">xres</span><span class="p">,</span> <span class="n">yres</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">transform</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>| 30.00, 0.00,-105.00|
| 0.00,-30.00, 105.00|
| 0.00, 0.00, 1.00|
</pre></div>
</div>
</div>
</div>
<p>Now we need to write out a <code class="docutils literal notranslate"><span class="pre">tif</span></code> file that holds the data in <code class="docutils literal notranslate"><span class="pre">Z</span></code> and its data type with <code class="docutils literal notranslate"><span class="pre">dtype</span></code>, the location described by <code class="docutils literal notranslate"><span class="pre">transform</span></code>, in coordinates described by the coordinate reference system <code class="docutils literal notranslate"><span class="pre">+proj=latlon</span></code>, the number of ‘bands’ of data in <code class="docutils literal notranslate"><span class="pre">count</span></code> (in this case just one), and the shape in <code class="docutils literal notranslate"><span class="pre">height</span></code> and <code class="docutils literal notranslate"><span class="pre">width</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">rasterio</span>
<span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span>
    <span class="s1">&#39;../temp/Z.tif&#39;</span><span class="p">,</span>
    <span class="s1">&#39;w&#39;</span><span class="p">,</span>
    <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;GTiff&#39;</span><span class="p">,</span>
    <span class="n">height</span><span class="o">=</span><span class="n">Z</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
    <span class="n">width</span><span class="o">=</span><span class="n">Z</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="n">count</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">dtype</span><span class="o">=</span><span class="n">Z</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
    <span class="n">crs</span><span class="o">=</span><span class="s1">&#39;+proj=latlong&#39;</span><span class="p">,</span>
    <span class="n">transform</span><span class="o">=</span><span class="n">transform</span><span class="p">,</span>
<span class="p">)</span> <span class="k">as</span> <span class="n">dst</span><span class="p">:</span>
    <span class="n">dst</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>All this info is stored in <code class="docutils literal notranslate"><span class="pre">dst</span></code> and then written to disk with <code class="docutils literal notranslate"><span class="pre">dst.write(Z,1)</span></code>. Where <code class="docutils literal notranslate"><span class="pre">write</span></code> gets the array of data <code class="docutils literal notranslate"><span class="pre">Z</span></code> and the band location to write to, in this case band <code class="docutils literal notranslate"><span class="pre">1</span></code>. This is a bit awkward, but I believe is a carryover from GDAL which rasterio relies on heavily (like all other platforms including arcmap etc).</p>
<div class="section" id="the-crazy-tale-of-the-upper-left-hand-corner">
<h4>The Crazy Tale of the Upper Left Hand Corner<a class="headerlink" href="#the-crazy-tale-of-the-upper-left-hand-corner" title="Permalink to this headline">#</a></h4>
<p>To help us understand what is going on with <code class="docutils literal notranslate"><span class="pre">transform</span></code> it helps to work an example. For our example above we need to define the translate matrix that helps define the upper left hand corner of our rainfall raster data <code class="docutils literal notranslate"><span class="pre">Z</span></code>. In particular we need the upper left cell center to be located at (-90,90), so the upper left hand corner need to be 1/2 the resolution above and to the left of (-90,90), implying a location of (-105,105) since the resolution is 25 degrees.</p>
<p>We can visualize what we need to do here:</p>
<div class="figure align-default" id="example-of-using-affine-translation-to-shift-the-upper-left-hand-corner">
<a class="reference internal image-reference" href="../_images/c_raster_upperleft_drawing.png"><img alt="../_images/c_raster_upperleft_drawing.png" src="../_images/c_raster_upperleft_drawing.png" style="width: 500px;" /></a>
<p class="caption"><span class="caption-number">Fig. 29 </span><span class="caption-text">Example of using translation to shift the upper left hand corner</span><a class="headerlink" href="#example-of-using-affine-translation-to-shift-the-upper-left-hand-corner" title="Permalink to this image">#</a></p>
</div>
<p>Let’s walk through the math behind the scenes. Here we use our transform matrix to move our upper left hand corner which is assumed to start at the origin (0,0).</p>
<div class="figure align-default" id="example-of-using-affine-translation-of-a-matrix-to-shift-the-upper-left-hand-corner">
<a class="reference internal image-reference" href="../_images/c_raster_upperleft_transform.png"><img alt="../_images/c_raster_upperleft_transform.png" src="../_images/c_raster_upperleft_transform.png" style="width: 500px;" /></a>
<p class="caption"><span class="caption-number">Fig. 30 </span><span class="caption-text">Example of using affine translation of a matrix to shift the upper left hand corner</span><a class="headerlink" href="#example-of-using-affine-translation-of-a-matrix-to-shift-the-upper-left-hand-corner" title="Permalink to this image">#</a></p>
</div>
<p>The final coordinate of the upper left hand corner are <span class="math notranslate nohighlight">\((x_0,y_0) = (-105,105)\)</span></p>
</div>
<div class="section" id="translate-is-a-map">
<h4>Translate is a “map”<a class="headerlink" href="#translate-is-a-map" title="Permalink to this headline">#</a></h4>
<p>Now here’s the magic, our new <code class="docutils literal notranslate"><span class="pre">translate</span></code> matrix can be used to easily find the coordinates of any cell based on its row and column number. To see how if works, we are going to multiply our <code class="docutils literal notranslate"><span class="pre">translate</span></code> matrix by <code class="docutils literal notranslate"><span class="pre">(column_number,</span> <span class="pre">row_number)</span></code> to retrieve the coordinates of that cell’s upper right hand corner. Essentially, <code class="docutils literal notranslate"><span class="pre">translate</span></code> “maps” row and column indexes to coordinates! OMG! This is fun… ok kidding, but it’s useful.</p>
<p>Let’s see how we can calculate a few coordinates (upper left) based on the visual examples below:</p>
<div class="figure align-default" id="example-of-using-transform-to-identify-coordinates-based-on-row-and-column">
<a class="reference internal image-reference" href="../_images/c_raster_raster.png"><img alt="../_images/c_raster_raster.png" src="../_images/c_raster_raster.png" style="width: 500px;" /></a>
<p class="caption"><span class="caption-number">Fig. 31 </span><span class="caption-text">Example of using transform to identify coordinates based on row and column</span><a class="headerlink" href="#example-of-using-transform-to-identify-coordinates-based-on-row-and-column" title="Permalink to this image">#</a></p>
</div>
<p>Let’s start with the easiest and retrieve the upper left corner coordinates based on <code class="docutils literal notranslate"><span class="pre">transform</span> <span class="pre">*</span> <span class="pre">(row_number,</span> <span class="pre">column_number)</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">transform</span><span class="o">*</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(-105.0, 105.0)
</pre></div>
</div>
</div>
</div>
<p>Let’s find the corner that is one cell down (-30°) and to the right (+30°)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">transform</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(-75.0, 75.0)
</pre></div>
</div>
</div>
</div>
<p>Just to make sure it works let’s find a harder one, 5th column right, 2nd row down:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">transform</span><span class="o">*</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(45.0, 45.0)
</pre></div>
</div>
</div>
</div>
<div class="section" id="how-transforms-works">
<h5>How Transforms Works<a class="headerlink" href="#how-transforms-works" title="Permalink to this headline">#</a></h5>
<p>Let’s work the example of finding the upper left coordinates of with <code class="docutils literal notranslate"><span class="pre">row=5</span></code>, <code class="docutils literal notranslate"><span class="pre">column=2</span></code>:</p>
<div class="math notranslate nohighlight">
\[\begin{split}
   \begin{eqnarray}
      \begin{bmatrix} 5 \\ 2 \\ 1 \end{bmatrix}   
      \begin{bmatrix} 
          30 &amp; 0 &amp; -105 \\  
          0 &amp; -30 &amp; 105 \\ 
          0 &amp; 0 &amp; 1 
      \end{bmatrix}  =
      \begin{bmatrix} 
          5 \times 30 + 2 \times 0 + 1 \times -105  \\  
          5 \times 0 + 2 \times -30 + 1 \times 105 \\ 
          5 \times 0 + 2 \times 0 + 1 \times 1  
      \end{bmatrix} = 
      \begin{bmatrix} 45  \\  45 \\ 1  \end{bmatrix}
   \end{eqnarray}
\end{split}\]</div>
<p>Wow, it works! Come on it’s at least a little bit cool. Depending on your definition of cool.</p>
</div>
</div>
</div>
<div class="section" id="reproject-a-raster-the-simple-case">
<h3>Reproject a Raster - The Simple Case<a class="headerlink" href="#reproject-a-raster-the-simple-case" title="Permalink to this headline">#</a></h3>
<p>How then do we reproject a raster? Since <code class="docutils literal notranslate"><span class="pre">transform</span></code> is a map of pixel locations, warping a raster then becomes as simple as knowing the <code class="docutils literal notranslate"><span class="pre">transform</span></code> of your destination based on the description of the new coordinate reference system (CRS). If you haven’t please study <a class="reference internal" href="docs/a_intro.html#document-docs/d_affine"><span class="doc std std-doc">affine transformations</span></a>.</p>
<div class="section" id="shifting-the-prime-meridian">
<h4>Shifting the Prime Meridian<a class="headerlink" href="#shifting-the-prime-meridian" title="Permalink to this headline">#</a></h4>
<p>One of the easiest cases is that of false easting, or moving the prime meridian. Let’s walk through an example where we start with a raster with an upper left hand corner at (0, 45), then we will apply a transform to move it to (10, 45) by moving the prime meridian 10° to the west (e.g. using <code class="docutils literal notranslate"><span class="pre">+lon_0=-10</span></code> from the  <a class="reference internal" href="docs/a_intro.html#document-docs/d_understand_crs_codes"><span class="doc std std-doc">proj4string</span></a>).</p>
<p>Let’s start be looking visually at what we plan to do:</p>
<div class="figure align-default" id="example-of-using-translate-to-reproject-an-image-by-moving-prime-meridian">
<a class="reference internal image-reference" href="../_images/d_europe_translate_raster.png"><img alt="../_images/d_europe_translate_raster.png" src="../_images/d_europe_translate_raster.png" style="width: 500px;" /></a>
<p class="caption"><span class="caption-number">Fig. 32 </span><span class="caption-text">Example of using translate to reproject an image by moving prime meridian</span><a class="headerlink" href="#example-of-using-translate-to-reproject-an-image-by-moving-prime-meridian" title="Permalink to this image">#</a></p>
</div>
<p>We can then use our knowledge of matrix algebra and transform matrices to solve for the new upper left hand corner coordinate (<span class="math notranslate nohighlight">\(x_B\)</span>, <span class="math notranslate nohighlight">\(y_B\)</span>)</p>
<div class="figure align-default" id="example-of-using-translate-matrix-to-reproject-an-image-by-moving-prime-meridian">
<a class="reference internal image-reference" href="../_images/d_europe_translate_raster_m.png"><img alt="../_images/d_europe_translate_raster_m.png" src="../_images/d_europe_translate_raster_m.png" style="width: 400px;" /></a>
<p class="caption"><span class="caption-number">Fig. 33 </span><span class="caption-text">Example of using translate matrix to reproject an image by moving prime meridian</span><a class="headerlink" href="#example-of-using-translate-matrix-to-reproject-an-image-by-moving-prime-meridian" title="Permalink to this image">#</a></p>
</div>
</div>
</div>
<div class="section" id="reproject-a-raster-the-complex-case">
<h3>Reproject a Raster - The Complex Case<a class="headerlink" href="#reproject-a-raster-the-complex-case" title="Permalink to this headline">#</a></h3>
<p>In many cases reprojecting a raster requires changing the number of rows or columns, or ‘warping’ (i.e. bending) an image. All of these examples create a problem, the centroids of the new projected raster don’t line up with the centroids of the original raster. Therefore they now represent locations on the ground that weren’t in the original dataset.</p>
<p>Take for instance the case of a ‘warped’ raster image (below) which for instance occurs when you switch from a spherical CRS (like lat lon) to a projected (or flat) CRS. Notice that the centroids of the two rasters no longer over lap:</p>
<div class="figure align-default" id="example-of-warping-an-image-during-reprojection">
<a class="reference internal image-reference" href="../_images/d_warp.png"><img alt="../_images/d_warp.png" src="../_images/d_warp.png" style="width: 500px;" /></a>
<p class="caption"><span class="caption-number">Fig. 34 </span><span class="caption-text">Example of warping an image during reprojection</span><a class="headerlink" href="#example-of-warping-an-image-during-reprojection" title="Permalink to this image">#</a></p>
</div>
<p>In this case we have a decision to make, how will we assign values to the new warped raster? Keep in mind the values must change because they now point to different locations on the ground.  For this we have a number of ‘interpolation’ options, some simple, some complex.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>What is interpolation? Interpolation allows us to make an informed guess of a value at a new location. <a class="reference external" href="http://wiki.gis.com/wiki/index.php/Interpolation">Read more here</a></p>
</div>
<div class="section" id="interpolation-options">
<span id="d-raster-crs-intro-interpolation-options"></span><h4>Interpolation Options<a class="headerlink" href="#interpolation-options" title="Permalink to this headline">#</a></h4>
<p>There are three commonly used interpolation methods: a) Nearest neighbor - assigns the value of the nearest centroid, b) bilinear interpolation - uses a straight line between know locations, c) bicubic interpolation - uses curved line between known locations.</p>
<p>In the visual example below we will try to estimate the value for location <code class="docutils literal notranslate"><span class="pre">C</span></code> based on the known values at locations <code class="docutils literal notranslate"><span class="pre">A</span></code> and <code class="docutils literal notranslate"><span class="pre">B</span></code>.</p>
<div class="figure align-default" id="example-of-nearest-neighbor-and-bilinear-interpolation">
<a class="reference internal image-reference" href="../_images/d_bilinear.png"><img alt="../_images/d_bilinear.png" src="../_images/d_bilinear.png" style="width: 500px;" /></a>
<p class="caption"><span class="caption-number">Fig. 35 </span><span class="caption-text">Example of nearest neighbor and bilinear interpolation</span><a class="headerlink" href="#example-of-nearest-neighbor-and-bilinear-interpolation" title="Permalink to this image">#</a></p>
</div>
<div class="figure align-default" id="example-of-nearest-neighbor-and-bicubic-interpolation">
<a class="reference internal image-reference" href="../_images/d_bicubic.png"><img alt="../_images/d_bicubic.png" src="../_images/d_bicubic.png" style="width: 400px;" /></a>
<p class="caption"><span class="caption-number">Fig. 36 </span><span class="caption-text">Example of nearest neighbor and bicubic interpolation</span><a class="headerlink" href="#example-of-nearest-neighbor-and-bicubic-interpolation" title="Permalink to this image">#</a></p>
</div>
</div>
<div class="section" id="choosing-the-right-interpolation-method">
<h4>Choosing the Right Interpolation Method<a class="headerlink" href="#choosing-the-right-interpolation-method" title="Permalink to this headline">#</a></h4>
<p>Choosing the correct interpolation method is important. The following table should help you to decided. Remember categorical data might include land cover classes (forest, water, etc), and continuous data is measurable for instance rainfall (values 0 to 20mm).</p>
<table class="colwidths-auto docutils align-default">
<thead>
<tr class="row-odd"><th class="text-align:left head"><p>Method</p></th>
<th class="text-align:right head"><p>Description</p></th>
<th class="text-align:left head"><p>Fast</p></th>
<th class="text-align:right head"><p>Categorical</p></th>
<th class="text-align:left head"><p>Continuous</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td class="text-align:left"><p>Nearest<br>Neighbor</p></td>
<td class="text-align:right"><p>Assigns nearest value</p></td>
<td class="text-align:left"><p>Y</p></td>
<td class="text-align:right"><p>Y</p></td>
<td class="text-align:left"><p></p></td>
</tr>
<tr class="row-odd"><td class="text-align:left"><p>Bilinear</p></td>
<td class="text-align:right"><p>Linear estimation</p></td>
<td class="text-align:left"><p>Y</p></td>
<td class="text-align:right"><p></p></td>
<td class="text-align:left"><p>Y</p></td>
</tr>
<tr class="row-even"><td class="text-align:left"><p>Bicubic</p></td>
<td class="text-align:right"><p>Non-Linear estimation</p></td>
<td class="text-align:left"><p>Most of<br>the time</p></td>
<td class="text-align:right"><p></p></td>
<td class="text-align:left"><p>Y</p></td>
</tr>
</tbody>
</table>
<p>For categorical data, Nearest Neighbor is your only choice, enjoy it. For continuous data, like quantity of rain, you can choose between Bilinear and Bicubic (i.e. “cubic convolution”). For most data Bilinear interpolation is fast and effective. However if you believe your data is highly non-linear, or widely spaced, you might consider using Bicubic. Some experimentation here is often informative.</p>
</div>
</div>
<div class="section" id="reprojecting-a-raster-with-rasterio">
<h3>Reprojecting a Raster with Rasterio<a class="headerlink" href="#reprojecting-a-raster-with-rasterio" title="Permalink to this headline">#</a></h3>
<p>Ok enough talk already, how do we reproject a raster? Before we get into it, we need to talk some more… about <code class="docutils literal notranslate"><span class="pre">calculate_default_transform</span></code>. <code class="docutils literal notranslate"><span class="pre">calculate_default_transform</span></code> allows us to generate the transform matrix required for the new reprojected raster based on the characteristics of the original and the desired output CRS. Note that the <code class="docutils literal notranslate"><span class="pre">source</span></code> (src) is the original input raster, and the <code class="docutils literal notranslate"><span class="pre">destination</span></code> (dst) is the outputed reprojected raster.</p>
<p>First, remember that the transform matrix takes the following form:</p>
<div class="math notranslate nohighlight">
\[\begin{split}
    \mbox{Transform} =  \begin{bmatrix} xres &amp; 0 &amp; \Delta x \\ 0 &amp; yres &amp; \Delta y \\ 0 &amp; 0 &amp; 1 \end{bmatrix} 
\end{split}\]</div>
<p>Now let’s calculate the tranform matrix for the destination raster:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">rasterio</span>
<span class="kn">from</span> <span class="nn">rasterio.warp</span> <span class="kn">import</span> <span class="n">reproject</span><span class="p">,</span> <span class="n">Resampling</span><span class="p">,</span> <span class="n">calculate_default_transform</span>

<span class="n">dst_crs</span> <span class="o">=</span> <span class="s2">&quot;EPSG:3857&quot;</span>  <span class="c1"># web mercator(ie google maps)</span>

<span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;../data/LC08_L1TP_224078_20200518_20200518_01_RT.TIF&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>

    <span class="c1"># transform for input raster</span>
    <span class="n">src_transform</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">transform</span>

    <span class="c1"># calculate the transform matrix for the output</span>
    <span class="n">dst_transform</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="n">calculate_default_transform</span><span class="p">(</span>
        <span class="n">src</span><span class="o">.</span><span class="n">crs</span><span class="p">,</span>    <span class="c1"># source CRS</span>
        <span class="n">dst_crs</span><span class="p">,</span>    <span class="c1"># destination CRS</span>
        <span class="n">src</span><span class="o">.</span><span class="n">width</span><span class="p">,</span>    <span class="c1"># column count</span>
        <span class="n">src</span><span class="o">.</span><span class="n">height</span><span class="p">,</span>  <span class="c1"># row count</span>
        <span class="o">*</span><span class="n">src</span><span class="o">.</span><span class="n">bounds</span><span class="p">,</span>  <span class="c1"># unpacks outer boundaries (left, bottom, right, top)</span>
    <span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Source Transform:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span><span class="n">src_transform</span><span class="p">,</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Destination Transform:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">dst_transform</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Source Transform:
 | 30.00, 0.00, 717345.00|
| 0.00,-30.00,-2776995.00|
| 0.00, 0.00, 1.00| 

Destination Transform:
 | 33.24, 0.00,-6105300.09|
| 0.00,-33.24,-2885952.71|
| 0.00, 0.00, 1.00|
</pre></div>
</div>
</div>
</div>
<p>Notice that in order to keep the same number of rows and columns that the resolution of the destination raster increased from 30 meters to 33.24 meters. Also the coordinates of the upper left hand corner have shifted (check <span class="math notranslate nohighlight">\(\Delta x, \Delta x\)</span>).</p>
<p>Ok finally!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dst_crs</span> <span class="o">=</span> <span class="s2">&quot;EPSG:3857&quot;</span>  <span class="c1"># web mercator(ie google maps)</span>

<span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;../data/LC08_L1TP_224078_20200518_20200518_01_RT.TIF&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
    <span class="n">src_transform</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">transform</span>

    <span class="c1"># calculate the transform matrix for the output</span>
    <span class="n">dst_transform</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="n">calculate_default_transform</span><span class="p">(</span>
        <span class="n">src</span><span class="o">.</span><span class="n">crs</span><span class="p">,</span>
        <span class="n">dst_crs</span><span class="p">,</span>
        <span class="n">src</span><span class="o">.</span><span class="n">width</span><span class="p">,</span>
        <span class="n">src</span><span class="o">.</span><span class="n">height</span><span class="p">,</span>
        <span class="o">*</span><span class="n">src</span><span class="o">.</span><span class="n">bounds</span><span class="p">,</span>  <span class="c1"># unpacks outer boundaries (left, bottom, right, top)</span>
    <span class="p">)</span>

    <span class="c1"># set properties for output</span>
    <span class="n">dst_kwargs</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">dst_kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="s2">&quot;crs&quot;</span><span class="p">:</span> <span class="n">dst_crs</span><span class="p">,</span>
            <span class="s2">&quot;transform&quot;</span><span class="p">:</span> <span class="n">dst_transform</span><span class="p">,</span>
            <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="n">width</span><span class="p">,</span>
            <span class="s2">&quot;height&quot;</span><span class="p">:</span> <span class="n">height</span><span class="p">,</span>
            <span class="s2">&quot;nodata&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>  <span class="c1"># replace 0 with np.nan</span>
        <span class="p">}</span>
    <span class="p">)</span>

    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;../temp/LC08_20200518_webMC.tif&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">dst_kwargs</span><span class="p">)</span> <span class="k">as</span> <span class="n">dst</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">src</span><span class="o">.</span><span class="n">count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">reproject</span><span class="p">(</span>
                <span class="n">source</span><span class="o">=</span><span class="n">rasterio</span><span class="o">.</span><span class="n">band</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">i</span><span class="p">),</span>
                <span class="n">destination</span><span class="o">=</span><span class="n">rasterio</span><span class="o">.</span><span class="n">band</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">i</span><span class="p">),</span>
                <span class="n">src_transform</span><span class="o">=</span><span class="n">src</span><span class="o">.</span><span class="n">transform</span><span class="p">,</span>
                <span class="n">src_crs</span><span class="o">=</span><span class="n">src</span><span class="o">.</span><span class="n">crs</span><span class="p">,</span>
                <span class="n">dst_transform</span><span class="o">=</span><span class="n">dst_transform</span><span class="p">,</span>
                <span class="n">dst_crs</span><span class="o">=</span><span class="n">dst_crs</span><span class="p">,</span>
                <span class="n">resampling</span><span class="o">=</span><span class="n">Resampling</span><span class="o">.</span><span class="n">nearest</span><span class="p">,</span>
            <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="figure align-default" id="reprojected-landsat-image">
<a class="reference internal image-reference" href="../_images/d_reproj_image.png"><img alt="../_images/d_reproj_image.png" src="../_images/d_reproj_image.png" style="width: 400px;" /></a>
<p class="caption"><span class="caption-number">Fig. 37 </span><span class="caption-text">Reprojected Landsat Image</span><a class="headerlink" href="#reprojected-landsat-image" title="Permalink to this image">#</a></p>
</div>
<p>Source: <a class="reference external" href="https://rasterio.readthedocs.io/en/latest/quickstart.html?highlight=X%2C%20Y%20%3D%20np.meshgrid(x%2C%20y)#creating-data">Creating Raster Data</a></p>
<!-- 
6.6 Reprojecting raster geometries

The projection concepts described in the previous section apply equally to rasters. However, there are important differences in reprojection of vectors and rasters: transforming a vector object involves changing the coordinates of every vertex but this does not apply to raster data. Rasters are composed of rectangular cells of the same size (expressed by map units, such as degrees or meters), so it is impossible to transform coordinates of pixels separately. Raster reprojection involves creating a new raster object, often with a different number of columns and rows than the original. The attributes must subsequently be re-estimated, allowing the new pixels to be ‘filled’ with appropriate values. In other words, raster reprojection can be thought of as two separate spatial operations: a vector reprojection of cell centroids to another CRS (Section 6.4), and computation of new pixel values through resampling (Section 5.3.3). Thus in most cases when both raster and vector data are used, it is better to avoid reprojecting rasters and reproject vectors instead.

The raster reprojection process is done with projectRaster() from the raster package. Like the st_transform() function demonstrated in the previous section, projectRaster() takes a geographic object (a raster dataset in this case) and a crs argument. However, projectRaster() only accepts the lengthy proj4string definitions of a CRS rather than concise EPSG codes.
It is possible to use a EPSG code in a proj4string definition with "+init=epsg:MY_NUMBER". For example, one can use the "+init=epsg:4326" definition to set CRS to WGS84 (EPSG code of 4326). The PROJ library automatically adds the rest of the parameters and converts them into "+init=epsg:4326 +proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0".

Let’s take a look at two examples of raster transformation: using categorical and continuous data. Land cover data are usually represented by categorical maps. The nlcd2011.tif file provides information for a small area in Utah, USA obtained from National Land Cover Database 2011 in the NAD83 / UTM zone 12N CRS.

cat_raster = raster(system.file("raster/nlcd2011.tif", package = "spDataLarge"))
#> Warning in showSRID(uprojargs, format = "PROJ", multiline = "NO", prefer_proj
#> = prefer_proj): Discarded datum Unknown based on GRS80 ellipsoid in Proj4
#> definition
crs(cat_raster)
#> CRS arguments:
#>  +proj=utm +zone=12 +ellps=GRS80 +units=m +no_defs

In this region, 14 land cover classes were distinguished (a full list of NLCD2011 land cover classes can be found at mrlc.gov):

unique(cat_raster)
#>  [1] 11 21 22 23 31 41 42 43 52 71 81 82 90 95

When reprojecting categorical rasters, the estimated values must be the same as those of the original. This could be done using the nearest neighbor method (ngb). This method sets each new cell value to the value of the nearest cell (center) of the input raster. An example is reprojecting cat_raster to WGS84, a geographic CRS well suited for web mapping. The first step is to obtain the PROJ definition of this CRS, which can be done using the http://spatialreference.org webpage. The final step is to reproject the raster with the projectRaster() function which, in the case of categorical data, uses the nearest neighbor method (ngb):

wgs84 = "+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs"
cat_raster_wgs84 = projectRaster(cat_raster, crs = wgs84, method = "ngb")

Many properties of the new object differ from the previous one, including the number of columns and rows (and therefore number of cells), resolution (transformed from meters into degrees), and extent, as illustrated in Table 6.1 (note that the number of categories increases from 14 to 15 because of the addition of NA values, not because a new category has been created — the land cover classes are preserved).
TABLE 6.1: Key attributes in the original (‘cat_raster’) and projected (‘cat_raster_wgs84’) categorical raster datasets. CRS 	nrow 	ncol 	ncell 	resolution 	unique_categories
NAD83 	1359 	1073 	1458207 	31.5275 	14
WGS84 	1394 	1111 	1548734 	0.0003 	15

Reprojecting numeric rasters (with numeric or in this case integer values) follows an almost identical procedure. This is demonstrated below with srtm.tif in spDataLarge from the Shuttle Radar Topography Mission (SRTM), which represents height in meters above sea level (elevation) with the WGS84 CRS:

con_raster = raster(system.file("raster/srtm.tif", package = "spDataLarge"))
crs(con_raster)
#> CRS arguments: +proj=longlat +datum=WGS84 +no_defs

We will reproject this dataset into a projected CRS, but not with the nearest neighbor method which is appropriate for categorical data. Instead, we will use the bilinear method which computes the output cell value based on the four nearest cells in the original raster. The values in the projected dataset are the distance-weighted average of the values from these four cells: the closer the input cell is to the center of the output cell, the greater its weight. The following commands create a text string representing the Oblique Lambert azimuthal equal-area projection, and reproject the raster into this CRS, using the bilinear method:

equalarea = "+proj=laea +lat_0=37.32 +lon_0=-113.04"
con_raster_ea = projectRaster(con_raster, crs = equalarea, method = "bilinear")
crs(con_raster_ea)
#> CRS arguments:
#>  +proj=laea +lat_0=37.32 +lon_0=-113.04 +x_0=0 +y_0=0 +datum=WGS84
#> +units=m +no_defs

Raster reprojection on numeric variables also leads to small changes to values and spatial properties, such as the number of cells, resolution, and extent. These changes are demonstrated in Table 6.230:
TABLE 6.2: Key attributes in the original (‘con_raster’) and projected (‘con_raster_ea’) continuous raster datasets. CRS 	nrow 	ncol 	ncell 	resolution 	mean
WGS84 	457 	465 	212505 	0.0008 	1843
Equal-area 	467 	478 	223226 	83.2000 	1842
Of course, the limitations of 2D Earth projections apply as much to vector as to raster data. At best we can comply with two out of three spatial properties (distance, area, direction). Therefore, the task at hand determines which projection to choose. For instance, if we are interested in a density (points per grid cell or inhabitants per grid cell) we should use an equal-area projection (see also Chapter 13).

There is more to learn about CRSs. An excellent resource in this area, also implemented in R, is the website R Spatial. Chapter 6 for this free online book is recommended reading — see: rspatial.org/spatial/6-crs.html --></div>
</div>
</div>
<div class="toctree-wrapper compound">
<span id="document-docs/e_attributes"></span><hr class="docutils" id="e-attributes" />
<div class="admonition-learning-objectives admonition">
<p class="admonition-title">Learning Objectives</p>
<ul class="simple">
<li><p>Create and manipulate vector attributes</p></li>
<li><p>Subset data</p></li>
<li><p>Plot lat lon as points</p></li>
<li><p>Subset points by location</p></li>
</ul>
</div>
<div class="admonition-review admonition">
<p class="admonition-title">Review</p>
<ul class="simple">
<li><p><a class="reference internal" href="docs/a_intro.html#document-docs/c_vectors"><span class="doc std std-doc">Vector Data</span></a></p></li>
</ul>
</div>
<hr class="docutils" />
<div class="tex2jax_ignore mathjax_ignore section" id="attributes-indexing-for-vector-data">
<h2>Attributes &amp; Indexing for Vector Data<a class="headerlink" href="#attributes-indexing-for-vector-data" title="Permalink to this headline">#</a></h2>
<div class="figure align-default" id="vector-properties">
<img alt="../_images/dataframe.svg" src="../_images/dataframe.svg" /><p class="caption"><span class="caption-number">Fig. 38 </span><span class="caption-text">Structure of a <code class="docutils literal notranslate"><span class="pre">GeoDataFrame</span></code> extends the functionality of a Pandas <code class="docutils literal notranslate"><span class="pre">DataFrame</span></code></span><a class="headerlink" href="#vector-properties" title="Permalink to this image">#</a></p>
</div>
<p>Each <code class="docutils literal notranslate"><span class="pre">GeoSeries</span></code> can contain any geometry type (e.g. points, lines, polygon) and has a <code class="docutils literal notranslate"><span class="pre">GeoSeries.crs</span></code> attribute, which stores information on the projection (CRS stands for Coordinate Reference System). Therefore, each <code class="docutils literal notranslate"><span class="pre">GeoSeries</span></code> in a <code class="docutils literal notranslate"><span class="pre">GeoDataFrame</span></code> can be in a different projection, allowing you to have, for example, multiple versions of the same geometry, just in a different CRS.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Becuase GeoPandas are so intertwined spend the time to learn more about here <a class="reference external" href="https://pandas.pydata.org/pandas-docs/stable/user_guide/index.html">Pandas User Guide</a></p>
</div>
<div class="section" id="create-new-attributes">
<h3>Create New Attributes<a class="headerlink" href="#create-new-attributes" title="Permalink to this headline">#</a></h3>
<p>One of the most basic operations is creating new attributes. Let’s say for instance we want to look at the world population in millions. We can start with an existing column of data <code class="docutils literal notranslate"><span class="pre">pop_est</span></code>. Let’s start by looking at the column names:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">geopandas</span>
<span class="n">world</span> <span class="o">=</span> <span class="n">geopandas</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">geopandas</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">get_path</span><span class="p">(</span><span class="s1">&#39;naturalearth_lowres&#39;</span><span class="p">))</span>
<span class="n">world</span><span class="o">.</span><span class="n">columns</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Index([&#39;pop_est&#39;, &#39;continent&#39;, &#39;name&#39;, &#39;iso_a3&#39;, &#39;gdp_md_est&#39;, &#39;geometry&#39;], dtype=&#39;object&#39;)
</pre></div>
</div>
</div>
</div>
<p>We can then do basic operations on the basis of column names. Here we create a new column <code class="docutils literal notranslate"><span class="pre">m_pop_est</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">world</span><span class="p">[</span><span class="s1">&#39;m_pop_est&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">world</span><span class="p">[</span><span class="s1">&#39;pop_est&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mf">1e6</span>
<span class="n">world</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>pop_est</th>
      <th>continent</th>
      <th>name</th>
      <th>iso_a3</th>
      <th>gdp_md_est</th>
      <th>geometry</th>
      <th>m_pop_est</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>920938</td>
      <td>Oceania</td>
      <td>Fiji</td>
      <td>FJI</td>
      <td>8374.0</td>
      <td>MULTIPOLYGON (((180.00000 -16.06713, 180.00000...</td>
      <td>0.920938</td>
    </tr>
    <tr>
      <th>1</th>
      <td>53950935</td>
      <td>Africa</td>
      <td>Tanzania</td>
      <td>TZA</td>
      <td>150600.0</td>
      <td>POLYGON ((33.90371 -0.95000, 34.07262 -1.05982...</td>
      <td>53.950935</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</div>
<hr class="docutils" />
<div class="section" id="indexing-and-selecting-data">
<h3>Indexing and Selecting Data<a class="headerlink" href="#indexing-and-selecting-data" title="Permalink to this headline">#</a></h3>
<p>GeoPandas inherits the standard pandas methods for indexing/selecting data. This includes label based indexing with .loc and integer position based indexing with .iloc, which apply to both GeoSeries and GeoDataFrame objects. For more information on indexing/selecting, see the <a class="reference external" href="https://pandas.pydata.org/pandas-docs/stable/user_guide/index.html">pandas documentation</a>.</p>
<div class="section" id="selection-by-index-position">
<h4>Selection by Index Position<a class="headerlink" href="#selection-by-index-position" title="Permalink to this headline">#</a></h4>
<p>Pandas provides a suite of methods in order to get purely integer based indexing. The semantics follow closely Python and NumPy slicing. These are 0-based indexing. When slicing, the start bound is included, while the upper bound is excluded.  For instance <code class="docutils literal notranslate"><span class="pre">name</span> <span class="pre">=</span> <span class="pre">'fudge'</span></code> with <code class="docutils literal notranslate"><span class="pre">name[0:3]</span></code> returns <code class="docutils literal notranslate"><span class="pre">'fud'</span></code>, where f is at 0 and g is at the 3 position with the upper bound excluded.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;bmh&#39;</span><span class="p">)</span> <span class="c1"># better for plotting geometries vs general plots.</span>

<span class="n">world</span> <span class="o">=</span> <span class="n">geopandas</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">geopandas</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">get_path</span><span class="p">(</span><span class="s1">&#39;naturalearth_cities&#39;</span><span class="p">))</span>
<span class="n">northern_world</span> <span class="o">=</span> <span class="n">world</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span> <span class="mi">0</span><span class="p">:</span><span class="mi">4</span> <span class="p">]</span>    
<span class="n">northern_world</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>  
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/e_attributes_5_0.png" src="../_images/e_attributes_5_0.png" />
</div>
</div>
<div class="section" id="different-choices-for-indexing">
<h5>Different choices for indexing<a class="headerlink" href="#different-choices-for-indexing" title="Permalink to this headline">#</a></h5>
<p>Object selection has had a number of user-requested additions in order to
support more explicit location based indexing.</p>
<p>Getting values from an object with multi-axes selection uses the following
notation (using <code class="docutils literal notranslate"><span class="pre">.loc</span></code> as an example, but the following applies to <code class="docutils literal notranslate"><span class="pre">.iloc</span></code> as
well). Any of the axes accessors may be the null slice <code class="docutils literal notranslate"><span class="pre">:</span></code>. Axes left out of
the specification are assumed to be <code class="docutils literal notranslate"><span class="pre">:</span></code>, e.g. <code class="docutils literal notranslate"><span class="pre">p.loc['a']</span></code> is equivalent to
<code class="docutils literal notranslate"><span class="pre">p.loc['a',</span> <span class="pre">:,</span> <span class="pre">:]</span></code>.</p>
<table class="colwidths-auto docutils align-default">
<thead>
<tr class="row-odd"><th class="text-align:left head"><p>Object Type</p></th>
<th class="text-align:right head"><p>Indexers</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td class="text-align:left"><p>Series</p></td>
<td class="text-align:right"><p><code class="docutils literal notranslate"><span class="pre">s.loc[indexer]</span></code></p></td>
</tr>
<tr class="row-odd"><td class="text-align:left"><p>DataFrame</p></td>
<td class="text-align:right"><p><code class="docutils literal notranslate"><span class="pre">df.loc[row_indexer,column_indexer]</span></code></p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="section" id="subset-points-by-location">
<h4>Subset Points by Location<a class="headerlink" href="#subset-points-by-location" title="Permalink to this headline">#</a></h4>
<p>In addition to the standard pandas methods, GeoPandas also provides coordinate based indexing with the cx indexer, which slices using a bounding box. Geometries in the GeoSeries or GeoDataFrame that intersect the bounding box will be returned.</p>
<p>Using the world dataset, we can use this functionality to quickly select all cities in the northern and southern hemisphere using a <code class="docutils literal notranslate"><span class="pre">_CoordinateIndexer</span></code> using <code class="docutils literal notranslate"><span class="pre">.cx</span></code>. <code class="docutils literal notranslate"><span class="pre">.cx</span></code> allows you to quickly access the table’s <code class="docutils literal notranslate"><span class="pre">geometry</span></code>, where indexing reflects <code class="docutils literal notranslate"><span class="pre">[x,y]</span></code> or <code class="docutils literal notranslate"><span class="pre">[lon,lat]</span></code>. Here we will query points above and below 0 degrees latitude:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">world</span> <span class="o">=</span> <span class="n">geopandas</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">geopandas</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">get_path</span><span class="p">(</span><span class="s1">&#39;naturalearth_cities&#39;</span><span class="p">))</span>
<span class="n">northern_world</span> <span class="o">=</span> <span class="n">world</span><span class="o">.</span><span class="n">cx</span><span class="p">[</span> <span class="p">:</span> <span class="p">,</span> <span class="mi">0</span><span class="p">:</span> <span class="p">]</span>   <span class="c1"># subsets all rows above 0 with a slice</span>
<span class="n">northern_world</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/e_attributes_7_0.png" src="../_images/e_attributes_7_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">world</span> <span class="o">=</span> <span class="n">geopandas</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">geopandas</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">get_path</span><span class="p">(</span><span class="s1">&#39;naturalearth_cities&#39;</span><span class="p">))</span>
<span class="n">southern_world</span> <span class="o">=</span> <span class="n">world</span><span class="o">.</span><span class="n">cx</span><span class="p">[</span> <span class="p">:</span> <span class="p">,</span> <span class="p">:</span><span class="mi">0</span> <span class="p">]</span>   <span class="c1"># subsets all rows below 0  with a slice</span>
<span class="n">southern_world</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/e_attributes_8_0.png" src="../_images/e_attributes_8_0.png" />
</div>
</div>
</div>
</div>
</div>
<span id="document-docs/e_buffer_neighbors"></span><hr class="docutils" />
<div class="admonition-learning-objectives admonition">
<p class="admonition-title">Learning Objectives</p>
<ul class="simple">
<li><p>Do distance/proximity based analysis for points, lines, polygons</p></li>
<li><p>Create buffers</p></li>
<li><p>Get nearest neighbors</p></li>
</ul>
</div>
<div class="admonition-review admonition">
<p class="admonition-title">Review</p>
<ul class="simple">
<li><p><a class="reference internal" href="docs/a_intro.html#document-docs/c_vectors"><span class="doc std std-doc">Spatial Vector Data</span></a></p></li>
<li><p><a class="reference internal" href="docs/a_intro.html#document-docs/e_attributes"><span class="doc std std-doc">Attributes &amp; Indexing for Vector Data</span></a></p></li>
<li><p><a class="reference internal" href="docs/a_intro.html#document-docs/c_new_vectors"><span class="doc std std-doc">Creating Spatial Vector Data</span></a></p></li>
</ul>
</div>
<hr class="docutils" />
<div class="tex2jax_ignore mathjax_ignore section" id="proximity-analysis-buffers-nearest-neighbor">
<h2>Proximity Analysis - Buffers, Nearest Neighbor<a class="headerlink" href="#proximity-analysis-buffers-nearest-neighbor" title="Permalink to this headline">#</a></h2>
<p>In this chapter we are going to dig into some of the most common spatial operations. After this section you will be able to answer simple questions like “where is the nearest wendy’s?”, “Are there any homes within 50 yards of a highway?”.</p>
<div class="section" id="buffer-analysis">
<h3>Buffer Analysis<a class="headerlink" href="#buffer-analysis" title="Permalink to this headline">#</a></h3>
<p>First, we will import the necessary modules and create two lines (click the + below to show code cell).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Import modules</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">geopandas</span> <span class="k">as</span> <span class="nn">gpd</span>
<span class="kn">from</span> <span class="nn">shapely.geometry</span> <span class="kn">import</span> <span class="n">Point</span><span class="p">,</span> <span class="n">LineString</span><span class="p">,</span> <span class="n">Polygon</span>
<span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">StringIO</span> 

<span class="n">data</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">ID,X,Y</span>
<span class="s2">1,  -87.789,  41.976</span>
<span class="s2">1,  -87.482,  41.677</span>
<span class="s2">2,  -87.599,  41.908</span>
<span class="s2">2,  -87.598,  41.708</span>
<span class="s2">2,  -87.643,  41.675</span>
<span class="s2">&quot;&quot;&quot;</span>
<span class="c1"># use StringIO to read in text chunk</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_table</span><span class="p">(</span><span class="n">StringIO</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>

<span class="c1">#zip the coordinates into a point object and convert to a GeoData Frame</span>
<span class="n">points</span> <span class="o">=</span> <span class="p">[</span><span class="n">Point</span><span class="p">(</span><span class="n">xy</span><span class="p">)</span> <span class="k">for</span> <span class="n">xy</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">Y</span><span class="p">)]</span>
<span class="n">points</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">geometry</span><span class="o">=</span><span class="n">points</span><span class="p">,</span> <span class="n">crs</span> <span class="o">=</span> <span class="s1">&#39;EPSG:4326&#39;</span><span class="p">)</span>
<span class="c1"># create line for each ID </span>
<span class="n">lines</span> <span class="o">=</span> <span class="n">points</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;ID&#39;</span><span class="p">])[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span>  <span class="n">LineString</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">tolist</span><span class="p">()))</span>
<span class="n">lines</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">geometry</span><span class="o">=</span><span class="s1">&#39;geometry&#39;</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="s2">&quot;EPSG:4326&quot;</span><span class="p">)</span> 
<span class="n">lines</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s take a look at the data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># plot county outline and add wells to axis (ax)</span>
<span class="n">lines</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">column</span><span class="o">=</span><span class="s1">&#39;ID&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;AxesSubplot:&gt;
</pre></div>
</div>
<img alt="../_images/e_buffer_neighbors_3_1.png" src="../_images/e_buffer_neighbors_3_1.png" />
</div>
</div>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>NEVER do distance analysis with unprojeted data (e.g. lat lon). Distances are best not measured in degrees! Instead use .to_crs() to convert it to a projected coordinate system with a linear unit in feet or meters etc.</p>
</div>
<p>Although it is not clearly stated the <code class="docutils literal notranslate"><span class="pre">distance</span></code> parameter is measured in the linear unit of the projection. So before we get started we need to make sure to use <code class="docutils literal notranslate"><span class="pre">to_crs()</span></code> to convert to a projected coordinate system.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># plot county outline and add wells to axis (ax)</span>
<span class="n">lines</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="mi">3857</span><span class="p">)</span>
<span class="c1"># check the linear unit name in `unit_name`.</span>
<span class="nb">print</span><span class="p">(</span><span class="n">lines</span><span class="o">.</span><span class="n">crs</span><span class="o">.</span><span class="n">axis_info</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[Axis(name=Easting, abbrev=X, direction=east, unit_auth_code=EPSG, unit_code=9001, unit_name=metre), Axis(name=Northing, abbrev=Y, direction=north, unit_auth_code=EPSG, unit_code=9001, unit_name=metre)]
</pre></div>
</div>
</div>
</div>
<p>Starting from two lines we can start playing around with the buffer function. You can read the docs for the buffer function, unfortunately is split between two docs <a class="reference external" href="https://geopandas.org/en/stable/docs/reference/api/geopandas.GeoSeries.buffer.html">geopandas</a> and <a class="reference external" href="https://shapely.readthedocs.io/en/latest/manual.html#object.buffer">shapely</a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">buf</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">buffer</span><span class="p">(</span><span class="n">distance</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">)</span>
<span class="n">bp</span> <span class="o">=</span> <span class="n">buf</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">lines</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">bp</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0    POLYGON ((-9737657.488 5113325.388, -9737601.7...
1    POLYGON ((-9750364.761 5117342.850, -9750369.3...
dtype: geometry
</pre></div>
</div>
<img alt="../_images/e_buffer_neighbors_7_1.png" src="../_images/e_buffer_neighbors_7_1.png" />
</div>
</div>
<p>Notice that we now have to polygon GEOMETRIES. This no longer has the line attributes associated with it. If we want to add back the attribute data we need to replace the original geometry column with new buffer geometry values.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">line_buffer</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">line_buffer</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">buf</span>
<span class="nb">print</span><span class="p">(</span><span class="n">line_buffer</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>   ID                                           geometry
0   1  POLYGON ((-9737657.488 5113325.388, -9737601.7...
1   2  POLYGON ((-9750364.761 5117342.850, -9750369.3...
</pre></div>
</div>
</div>
</div>
<p>There are a number of other parameters available to use, namely <code class="docutils literal notranslate"><span class="pre">cap_style</span></code>, and <code class="docutils literal notranslate"><span class="pre">single_sided</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">buf</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">buffer</span><span class="p">(</span><span class="n">distance</span> <span class="o">=</span> <span class="mi">3000</span><span class="p">,</span> <span class="n">cap_style</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">bp</span> <span class="o">=</span> <span class="n">buf</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">lines</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">bp</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;AxesSubplot:&gt;
</pre></div>
</div>
<img alt="../_images/e_buffer_neighbors_11_1.png" src="../_images/e_buffer_neighbors_11_1.png" />
</div>
</div>
<table class="colwidths-auto docutils align-default" id="cap-style">
<caption><span class="caption-number">Table 1 </span><span class="caption-text">Buffer caps can be different shapes</span><a class="headerlink" href="#cap-style" title="Permalink to this table">#</a></caption>
<thead>
<tr class="row-odd"><th class="head"><p>attribute</p></th>
<th class="head"><p>value</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>round</p></td>
<td><p>1</p></td>
</tr>
<tr class="row-odd"><td><p>flat</p></td>
<td><p>2</p></td>
</tr>
<tr class="row-even"><td><p>square</p></td>
<td><p>3</p></td>
</tr>
</tbody>
</table>
<p>We can also create left or right side buffers. Use negative distances for left, and positive values for right.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">buf_right</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">buffer</span><span class="p">(</span><span class="n">distance</span> <span class="o">=</span> <span class="mi">3000</span><span class="p">,</span> <span class="n">single_sided</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
<span class="n">bp</span> <span class="o">=</span> <span class="n">buf_right</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">)</span>

<span class="n">buf_left</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">buffer</span><span class="p">(</span><span class="n">distance</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1500</span><span class="p">,</span> <span class="n">single_sided</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
<span class="n">buf_left</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">bp</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;purple&#39;</span><span class="p">)</span>
<span class="n">lines</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">bp</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;AxesSubplot:&gt;
</pre></div>
</div>
<img alt="../_images/e_buffer_neighbors_13_1.png" src="../_images/e_buffer_neighbors_13_1.png" />
</div>
</div>
</div>
<div class="section" id="nearest-neighbor-analysis">
<h3>Nearest Neighbor Analysis<a class="headerlink" href="#nearest-neighbor-analysis" title="Permalink to this headline">#</a></h3>
<p>One commonly used GIS task is to be able to find the nearest neighbor. For instance, you might have a single Point object representing your home location, and then another set of locations representing e.g. public transport stops. Then, quite typical question is <em>“which of the stops is closest one to my home?”</em> This is a typical nearest neighbor analysis, where the aim is to find the closest geometry to another geometry. <a class="footnote-reference brackets" href="#gpd-clip" id="id1">1</a></p>
<p>In Python this kind of analysis can be done with shapely function called <code class="docutils literal notranslate"><span class="pre">nearest_points()</span></code> that returns a tuple of the <a class="reference external" href="https://shapely.readthedocs.io/en/latest/manual.html#shapely.ops.nearest_points">nearest points</a> in the input geometries.</p>
<div class="section" id="nearest-point-using-shapely">
<h4>Nearest point using Shapely<a class="headerlink" href="#nearest-point-using-shapely" title="Permalink to this headline">#</a></h4>
<p>Let’s start by testing how we can find the nearest Point using the <code class="docutils literal notranslate"><span class="pre">nearest_points</span></code> function of Shapely.</p>
<p>Let’s create an origin Point and a few destination Points and find out the closest destination.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">shapely.geometry</span> <span class="kn">import</span> <span class="n">Point</span><span class="p">,</span> <span class="n">MultiPoint</span>
<span class="kn">from</span> <span class="nn">shapely.ops</span> <span class="kn">import</span> <span class="n">nearest_points</span>

<span class="n">orig</span> <span class="o">=</span> <span class="n">Point</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">1.67</span><span class="p">)</span>
<span class="n">dest1</span><span class="p">,</span> <span class="n">dest2</span><span class="p">,</span> <span class="n">dest3</span> <span class="o">=</span> <span class="n">Point</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.45</span><span class="p">),</span> <span class="n">Point</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">Point</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>To be able to find out the closest destination point from the origin, we need to create a MultiPoint object from the destination points.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">destinations</span> <span class="o">=</span> <span class="n">MultiPoint</span><span class="p">([</span><span class="n">dest1</span><span class="p">,</span> <span class="n">dest2</span><span class="p">,</span> <span class="n">dest3</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">destinations</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>MULTIPOINT (0 1.45, 2 2, 0 2.5)
</pre></div>
</div>
</div>
</div>
<p>Okey, now we can see that all the destination points are represented as a single MultiPoint object. Now we can find out the nearest destination point by using <code class="docutils literal notranslate"><span class="pre">nearest_points()</span></code> function.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">nearest_geoms</span> <span class="o">=</span> <span class="n">nearest_points</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span> <span class="n">destinations</span><span class="p">)</span>
<span class="n">original_point</span><span class="p">,</span> <span class="n">nearest_destination</span> <span class="o">=</span> <span class="n">nearest_geoms</span>
<span class="nb">print</span><span class="p">(</span><span class="n">nearest_geoms</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Coordinates of original point:&#39;</span><span class="p">,</span><span class="n">original_point</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Coordinates of closest destination point:&#39;</span><span class="p">,</span><span class="n">nearest_destination</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(&lt;shapely.geometry.point.Point object at 0x7ff96043f750&gt;, &lt;shapely.geometry.point.Point object at 0x7ff96043fe90&gt;)
Coordinates of original point: POINT (1 1.67)
Coordinates of closest destination point: POINT (0 1.45)
</pre></div>
</div>
</div>
</div>
<p>As you can see the <code class="docutils literal notranslate"><span class="pre">nearest_points</span></code> function returns a tuple of geometries where the first item is the geometry of our origin point and the second item (at index 1) is the actual nearest geometry from the destination points. Hence, the closest destination point seems to be the one located at coordinates (0, 1.45).</p>
<p>This is the basic logic how we can find the nearest point from a set of points.</p>
</div>
<div class="section" id="nearest-points-using-geopandas">
<h4>Nearest points using Geopandas<a class="headerlink" href="#nearest-points-using-geopandas" title="Permalink to this headline">#</a></h4>
<p>Of course, the previous example is not really useful yet. Hence, next I show, how it is possible to find nearest points from a set of origin points to a set of destination points using GeoDataFrames. In this example we will recreate the previous example but use geopandas, however this data could come from any shapefile.</p>
<ul class="simple">
<li><p>First we need to create a function that takes advantage of the previous function but is tailored to work with two GeoDataFrames.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">shapely.ops</span> <span class="kn">import</span> <span class="n">nearest_points</span>

<span class="k">def</span> <span class="nf">_nearest</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">df1</span><span class="p">,</span> <span class="n">df2</span><span class="p">,</span> <span class="n">geom1</span><span class="o">=</span><span class="s1">&#39;geometry&#39;</span><span class="p">,</span> <span class="n">geom2</span><span class="o">=</span><span class="s1">&#39;geometry&#39;</span><span class="p">,</span> <span class="n">df2_column</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Find the nearest point and return the corresponding value from specified column.&quot;&quot;&quot;</span>

    <span class="c1"># create object usable by Shapely</span>
    <span class="n">geom_union</span> <span class="o">=</span> <span class="n">df2</span><span class="o">.</span><span class="n">unary_union</span>

    <span class="c1"># Find the geometry that is closest</span>
    <span class="n">nearest</span> <span class="o">=</span> <span class="n">df2</span><span class="p">[</span><span class="n">geom2</span><span class="p">]</span> <span class="o">==</span> <span class="n">nearest_points</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">geom1</span><span class="p">],</span> <span class="n">geom_union</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="c1"># Get the corresponding value from df2 (matching is based on the geometry)</span>
    <span class="k">if</span> <span class="n">df2_column</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">df2</span><span class="p">[</span><span class="n">nearest</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">df2</span><span class="p">[</span><span class="n">nearest</span><span class="p">][</span><span class="n">df2_column</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">value</span>

<span class="k">def</span> <span class="nf">nearest</span><span class="p">(</span><span class="n">df1</span><span class="p">,</span> <span class="n">df2</span><span class="p">,</span> <span class="n">geom1_col</span><span class="o">=</span><span class="s1">&#39;geometry&#39;</span><span class="p">,</span> <span class="n">geom2_col</span><span class="o">=</span><span class="s1">&#39;geometry&#39;</span><span class="p">,</span> <span class="n">df2_column</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Find the nearest point and return the corresponding value from specified column.</span>
<span class="sd">    :param df1: Origin points</span>
<span class="sd">    :type df1: geopandas.GeoDataFrame</span>
<span class="sd">    :param df2: Destination points</span>
<span class="sd">    :type df2: geopandas.GeoDataFrame</span>
<span class="sd">    :param geom1_col: name of column holding coordinate geometry, defaults to &#39;geometry&#39;</span>
<span class="sd">    :type geom1_col: str, optional</span>
<span class="sd">    :param geom2_col: name of column holding coordinate geometry, defaults to &#39;geometry&#39;</span>
<span class="sd">    :type geom2_col: str, optional</span>
<span class="sd">    :param df2_column: column name to return from df2, defaults to None</span>
<span class="sd">    :type df2_column: str, optional</span>
<span class="sd">    :return: df1 with nearest neighbor index or df2_column appended</span>
<span class="sd">    :rtype: geopandas.GeoDataFrame</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">df1</span><span class="p">[</span><span class="s1">&#39;nearest_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df1</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">_nearest</span><span class="p">,</span>  <span class="n">df1</span><span class="o">=</span><span class="n">df1</span><span class="p">,</span> <span class="n">df2</span><span class="o">=</span><span class="n">df2</span><span class="p">,</span> 
                                  <span class="n">geom1</span><span class="o">=</span><span class="n">geom1_col</span><span class="p">,</span> <span class="n">geom2</span><span class="o">=</span><span class="n">geom2_col</span><span class="p">,</span> 
                                  <span class="n">df2_column</span><span class="o">=</span><span class="n">df2_column</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df1</span> 
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># generate origin and destination points as geodataframe</span>
<span class="n">orig</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Origin_1&#39;</span><span class="p">,</span><span class="s1">&#39;Origin_2&#39;</span><span class="p">],</span> 
     <span class="s1">&#39;geometry&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">Point</span><span class="p">(</span><span class="o">-</span><span class="mf">77.3</span><span class="p">,</span><span class="mf">38.94</span><span class="p">),</span><span class="n">Point</span><span class="p">(</span><span class="o">-</span><span class="mf">77.41</span><span class="p">,</span><span class="mf">39.93</span><span class="p">)]}</span>
<span class="n">orig</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="s2">&quot;EPSG:4326&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">orig</span><span class="p">)</span>

<span class="n">dest</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Baltimore&#39;</span><span class="p">,</span><span class="s1">&#39;Washington&#39;</span><span class="p">,</span> <span class="s1">&#39;Fredrick&#39;</span><span class="p">],</span> 
     <span class="s1">&#39;geometry&#39;</span><span class="p">:</span> <span class="p">[</span> <span class="n">Point</span><span class="p">(</span><span class="o">-</span><span class="mf">76.61</span><span class="p">,</span><span class="mf">39.29</span><span class="p">,),</span> <span class="n">Point</span><span class="p">(</span><span class="o">-</span><span class="mf">77.04</span><span class="p">,</span><span class="mf">38.91</span><span class="p">),</span> <span class="n">Point</span><span class="p">(</span><span class="o">-</span><span class="mf">77.40</span><span class="p">,</span><span class="mf">39.41</span><span class="p">)]}</span>
<span class="n">dest</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="s2">&quot;EPSG:4326&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">dest</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>       name                    geometry
0  Origin_1  POINT (-77.30000 38.94000)
1  Origin_2  POINT (-77.41000 39.93000)
         name                    geometry
0   Baltimore  POINT (-76.61000 39.29000)
1  Washington  POINT (-77.04000 38.91000)
2    Fredrick  POINT (-77.40000 39.41000)
</pre></div>
</div>
</div>
</div>
<p>Okay now we are ready to use our function and find closest Points (taking the value from id column) from df2 to df1 centroids</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">nearest</span> <span class="o">=</span> <span class="n">nearest</span><span class="p">(</span><span class="n">df1</span><span class="o">=</span><span class="n">orig</span><span class="p">,</span> <span class="n">df2</span><span class="o">=</span><span class="n">dest</span><span class="p">,</span> <span class="n">df2_column</span><span class="o">=</span><span class="s1">&#39;name&#39;</span><span class="p">)</span>
<span class="n">nearest</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>name</th>
      <th>geometry</th>
      <th>nearest_id</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Origin_1</td>
      <td>POINT (-77.30000 38.94000)</td>
      <td>Washington</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Origin_2</td>
      <td>POINT (-77.41000 39.93000)</td>
      <td>Fredrick</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>That’s it! Now we found the closest point for each centroid and got the <code class="docutils literal notranslate"><span class="pre">index</span></code> value or column name from our addresses into the <code class="docutils literal notranslate"><span class="pre">df1</span></code> GeoDataFrame.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you want to do nearest neighbor analysis with polygons, you can simply use the centroid. If you have a geopandas polygon called poly, run poly[‘centroid’] = poly.centroid to store the centroid values in the attribute table.</p>
</div>
<p>Sources</p>
<hr class="footnotes docutils" />
<dl class="footnote brackets">
<dt class="label" id="gpd-clip"><span class="brackets"><a class="fn-backref" href="#id1">1</a></span></dt>
<dd><p><a class="reference external" href="https://automating-gis-processes.github.io/2017/lessons/L3/nearest-neighbour.html">automating-gis-processes</a></p>
</dd>
</dl>
</div>
</div>
</div>
<span id="document-docs/e_vector_merge_dissolve"></span><div class="tex2jax_ignore mathjax_ignore section" id="merge-data-dissolve-polygons">
<h2>Merge Data &amp; Dissolve Polygons<a class="headerlink" href="#merge-data-dissolve-polygons" title="Permalink to this headline">#</a></h2>
<p>By: Steven Chao</p>
<hr class="docutils" />
<div class="admonition-learning-objectives admonition">
<p class="admonition-title">Learning Objectives</p>
<ul class="simple">
<li><p>Import dataframes into Python for analysis</p></li>
<li><p>Perform basic dataframe column operations</p></li>
<li><p>Merge dataframes using a unique key</p></li>
<li><p>Group attributes based on a similar attribute</p></li>
<li><p>Dissolve vector geometries based on attribute values</p></li>
</ul>
</div>
<div class="admonition-review admonition">
<p class="admonition-title">Review</p>
<ul class="simple">
<li><p><a class="reference internal" href="docs/a_intro.html#document-docs/c_features"><span class="doc std std-doc">Data Structures</span></a></p></li>
<li><p><a class="reference internal" href="docs/a_intro.html#document-docs/c_vectors"><span class="doc std std-doc">Vector Data </span></a></p></li>
</ul>
</div>
<hr class="docutils" />
<div class="section" id="introduction">
<h3>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">#</a></h3>
<p>Dataframes are widely used in Python for manipulating data. Recall that a dataframe is essentially an Excel spreadsheet (a 2-D table of rows and columns); in fact, many of the functions that you might use in Excel can often be replicated when working with dataframes in Python!</p>
<p>This chapter will introduce you to some of the basic operations that you can perform on dataframes. We will use these basic operations in order to calculate and map poverty rates in the Commonwealth of Virginia. We will pull data from the US Census Bureau’s <a class="reference external" href="https://www.census.gov/programs-surveys/acs">American Community Survey (ACS)</a> 2019 (see <a class="reference external" href="https://www.census.gov/data/developers/data-sets/acs-5year.html">this page</a> for the data).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Import modules</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">geopandas</span> <span class="k">as</span> <span class="nn">gpd</span>
<span class="kn">from</span> <span class="nn">census</span> <span class="kn">import</span> <span class="n">Census</span>
<span class="kn">from</span> <span class="nn">us</span> <span class="kn">import</span> <span class="n">states</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="accessing-data">
<h3>Accessing Data<a class="headerlink" href="#accessing-data" title="Permalink to this headline">#</a></h3>
<div class="section" id="import-census-data">
<h4>Import census data<a class="headerlink" href="#import-census-data" title="Permalink to this headline">#</a></h4>
<p>Let’s begin by accessing and importing census data. Importing census data into Python requires a Census API key. A key can be obtained from <a class="reference external" href="http://api.census.gov/data/key_signup.html">Census API Key</a>.  <strong>It will provide you with a unique 40 digit text string. Please keep track of this number. Store it in a safe place.</strong></p>
<div class="cell tag_remove-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set API key</span>
<span class="n">c</span> <span class="o">=</span> <span class="n">Census</span><span class="p">(</span><span class="s2">&quot;CENSUS API KEY HERE&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#ignore this, I am just reading in my api key privately</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;../../../census_api.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">Census</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>With the Census API key set, we will access the census data at the tract level for the Commonwealth of Virginia from the 2019 ACS, specifically the <code class="docutils literal notranslate"><span class="pre">ratio</span> <span class="pre">of</span> <span class="pre">income</span> <span class="pre">to</span> <span class="pre">poverty</span> <span class="pre">in</span> <span class="pre">the</span> <span class="pre">past</span> <span class="pre">12</span> <span class="pre">months</span></code> (<code class="docutils literal notranslate"><span class="pre">C17002_001E</span></code>, total; <code class="docutils literal notranslate"><span class="pre">C17002_002E</span></code>, &lt; 0.50; and <code class="docutils literal notranslate"><span class="pre">C17002_003E</span></code>, 0.50 - 0.99) variables and the <code class="docutils literal notranslate"><span class="pre">total</span> <span class="pre">population</span></code> (<code class="docutils literal notranslate"><span class="pre">B01003_001E</span></code>) variable. For more information on why these variables are used, refer to the US Census Bureau’s <a class="reference external" href="https://www.census.gov/topics/income-poverty/poverty/guidance/poverty-measures.html">article on how the Census Bureau measures poverty</a> and the <a class="reference external" href="https://api.census.gov/data/2019/acs/acs5/variables.html">list of variables found in ACS</a>.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">census</span></code> package provides us with some easy convenience methods that allow us to obtain data for a wide variety of geographies. The FIPS code for Virginia is 51, but if needed, we can also use the <code class="docutils literal notranslate"><span class="pre">us</span></code> library to help us figure out the relevant FIPS code.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Obtain Census variables from the 2019 ACS at the tract level for the Commonwealth of Virginia (FIPS code: 51)</span>
<span class="c1"># C17002_001E: count of ratio of income to poverty in the past 12 months (total)</span>
<span class="c1"># C17002_002E: count of ratio of income to poverty in the past 12 months (&lt; 0.50)</span>
<span class="c1"># C17002_003E: count of ratio of income to poverty in the past 12 months (0.50 - 0.99)</span>
<span class="c1"># B01003_001E: total population</span>
<span class="c1"># Sources: https://api.census.gov/data/2019/acs/acs5/variables.html; https://pypi.org/project/census/</span>
<span class="n">va_census</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">acs5</span><span class="o">.</span><span class="n">state_county_tract</span><span class="p">(</span><span class="n">fields</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;NAME&#39;</span><span class="p">,</span> <span class="s1">&#39;C17002_001E&#39;</span><span class="p">,</span> <span class="s1">&#39;C17002_002E&#39;</span><span class="p">,</span> <span class="s1">&#39;C17002_003E&#39;</span><span class="p">,</span> <span class="s1">&#39;B01003_001E&#39;</span><span class="p">),</span>
                                      <span class="n">state_fips</span> <span class="o">=</span> <span class="n">states</span><span class="o">.</span><span class="n">VA</span><span class="o">.</span><span class="n">fips</span><span class="p">,</span>
                                      <span class="n">county_fips</span> <span class="o">=</span> <span class="s2">&quot;*&quot;</span><span class="p">,</span>
                                      <span class="n">tract</span> <span class="o">=</span> <span class="s2">&quot;*&quot;</span><span class="p">,</span>
                                      <span class="n">year</span> <span class="o">=</span> <span class="mi">2017</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Now that we have accessed the data and assigned it to a variable, we can read the data into a dataframe using the <code class="docutils literal notranslate"><span class="pre">pandas</span></code> library.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create a dataframe from the census data</span>
<span class="n">va_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">va_census</span><span class="p">)</span>

<span class="c1"># Show the dataframe</span>
<span class="nb">print</span><span class="p">(</span><span class="n">va_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Shape: &#39;</span><span class="p">,</span> <span class="n">va_df</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                                         NAME  C17002_001E  C17002_002E  \
0     Census Tract 60, Norfolk city, Virginia       3947.0        284.0   
1  Census Tract 65.02, Norfolk city, Virginia       3287.0        383.0   

   C17002_003E  B01003_001E state county   tract  
0        507.0       3947.0    51    710  006000  
1        480.0       3302.0    51    710  006502  
Shape:  (1907, 8)
</pre></div>
</div>
</div>
</div>
<p>By showing the dataframe, we can see that there are 1907 rows (therefore 1907 census tracts) and 8 columns.</p>
</div>
<div class="section" id="import-shapefile">
<h4>Import Shapefile<a class="headerlink" href="#import-shapefile" title="Permalink to this headline">#</a></h4>
<p>Let’s also read into Python a shapefile of the Virginia census tracts and reproject it to the UTM Zone 17N projection. (This shapefile can be downloaded on the Census Bureau’s website on the <a class="reference external" href="https://www.census.gov/geographies/mapping-files/time-series/geo/cartographic-boundary.html">Cartographic Boundary Files page</a> or the <a class="reference external" href="https://www.census.gov/geographies/mapping-files/time-series/geo/tiger-line-file.html">TIGER/Line Shapefiles page</a>.)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Access shapefile of Virginia census tracts</span>
<span class="n">va_tract</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="s2">&quot;https://www2.census.gov/geo/tiger/TIGER2019/TRACT/tl_2019_51_tract.zip&quot;</span><span class="p">)</span>

<span class="c1"># Reproject shapefile to UTM Zone 17N</span>
<span class="c1"># https://spatialreference.org/ref/epsg/wgs-84-utm-zone-17n/</span>
<span class="n">va_tract</span> <span class="o">=</span> <span class="n">va_tract</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">epsg</span> <span class="o">=</span> <span class="mi">32617</span><span class="p">)</span>

<span class="c1"># Print GeoDataFrame of shapefile</span>
<span class="nb">print</span><span class="p">(</span><span class="n">va_tract</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Shape: &#39;</span><span class="p">,</span> <span class="n">va_tract</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="c1"># Check shapefile projection</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">The shapefile projection is: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">va_tract</span><span class="o">.</span><span class="n">crs</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  STATEFP COUNTYFP TRACTCE        GEOID    NAME             NAMELSAD  MTFCC  \
0      51      700  032132  51700032132  321.32  Census Tract 321.32  G5020   
1      51      700  032226  51700032226  322.26  Census Tract 322.26  G5020   

  FUNCSTAT    ALAND  AWATER     INTPTLAT      INTPTLON  \
0        S  2552457       0  +37.1475176  -076.5212499   
1        S  3478916  165945  +37.1625163  -076.5527816   

                                            geometry  
0  POLYGON ((897174.191 4119897.084, 897174.811 4...  
1  POLYGON ((893470.562 4123469.385, 893542.722 4...  
Shape:  (1907, 13)

The shapefile projection is: epsg:32617
</pre></div>
</div>
</div>
</div>
<p>By printing the shapefile, we can see that the shapefile also has 1907 rows (1907 tracts). This number matches with the number of census records that we have on file. Perfect!</p>
<p>Not so fast, though. We have a potential problem: We have the census data, and we have the shapefile of census tracts that correspond with that data, but they are stored in two separate variables (<code class="docutils literal notranslate"><span class="pre">va_df</span></code> and <code class="docutils literal notranslate"><span class="pre">va_tract</span></code> respectively)! That makes it a bit difficult to map since these two separate datasets aren’t connected to each other.</p>
</div>
</div>
<div class="section" id="performing-dataframe-operations">
<h3>Performing Dataframe Operations<a class="headerlink" href="#performing-dataframe-operations" title="Permalink to this headline">#</a></h3>
<div class="section" id="create-new-column-from-old-columns-to-get-combined-fips-code">
<h4>Create new column from old columns to get combined FIPS code<a class="headerlink" href="#create-new-column-from-old-columns-to-get-combined-fips-code" title="Permalink to this headline">#</a></h4>
<p>To solve this problem, we can join the two dataframes together via a field or column that is common to both dataframes, which is referred to as a key.</p>
<p>Looking at the two datasets above, it appears that the <code class="docutils literal notranslate"><span class="pre">GEOID</span></code> column from <code class="docutils literal notranslate"><span class="pre">va_tract</span></code> and the <code class="docutils literal notranslate"><span class="pre">state</span></code>, <code class="docutils literal notranslate"><span class="pre">county</span></code>, and <code class="docutils literal notranslate"><span class="pre">tract</span></code> columns combined from <code class="docutils literal notranslate"><span class="pre">va_df</span></code> could serve as the unique key for joining these two dataframes together. In their current forms, this join will not be successful, as we’ll need to merge the <code class="docutils literal notranslate"><span class="pre">state</span></code>, <code class="docutils literal notranslate"><span class="pre">county</span></code>, and <code class="docutils literal notranslate"><span class="pre">tract</span></code> columns from <code class="docutils literal notranslate"><span class="pre">va_df</span></code> together to make it parallel to the <code class="docutils literal notranslate"><span class="pre">GEOID</span></code> column from <code class="docutils literal notranslate"><span class="pre">va_tract</span></code>. We can simply add the columns together, much like math or the basic operators in Python, and assign the “sum” to a new column.</p>
<p>To create a new column–or call an existing column in a dataframe–we can use indexing with <code class="docutils literal notranslate"><span class="pre">[]</span></code> and the column name (string). (There is a different way if you want to access columns using the index number; read more about indexing and selecting data <a class="reference external" href="https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html">in the pandas documentation</a>.)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Combine state, county, and tract columns together to create a new string and assign to new column</span>
<span class="n">va_df</span><span class="p">[</span><span class="s2">&quot;GEOID&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">va_df</span><span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">va_df</span><span class="p">[</span><span class="s2">&quot;county&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">va_df</span><span class="p">[</span><span class="s2">&quot;tract&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>Printing out the first rew rows of the dataframe, we can see that the new column <code class="docutils literal notranslate"><span class="pre">GEOID</span></code> has been created with the values from the three columns combined.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Print head of dataframe</span>
<span class="n">va_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>NAME</th>
      <th>C17002_001E</th>
      <th>C17002_002E</th>
      <th>C17002_003E</th>
      <th>B01003_001E</th>
      <th>state</th>
      <th>county</th>
      <th>tract</th>
      <th>GEOID</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Census Tract 60, Norfolk city, Virginia</td>
      <td>3947.0</td>
      <td>284.0</td>
      <td>507.0</td>
      <td>3947.0</td>
      <td>51</td>
      <td>710</td>
      <td>006000</td>
      <td>51710006000</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Census Tract 65.02, Norfolk city, Virginia</td>
      <td>3287.0</td>
      <td>383.0</td>
      <td>480.0</td>
      <td>3302.0</td>
      <td>51</td>
      <td>710</td>
      <td>006502</td>
      <td>51710006502</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</div>
<div class="section" id="remove-dataframe-columns-that-are-no-longer-needed">
<h4>Remove dataframe columns that are no longer needed<a class="headerlink" href="#remove-dataframe-columns-that-are-no-longer-needed" title="Permalink to this headline">#</a></h4>
<p>To reduce clutter, we can delete the <code class="docutils literal notranslate"><span class="pre">state</span></code>, <code class="docutils literal notranslate"><span class="pre">county</span></code>, and <code class="docutils literal notranslate"><span class="pre">tract</span></code> columns from <code class="docutils literal notranslate"><span class="pre">va_df</span></code> since we don’t need them anymore. Remember that when we want to modify a dataframe, we must assign the modified dataframe back to the original variable (or a new one, if preferred). Otherwise, any modifications won’t be saved. An alternative to assigning the dataframe back to the variable is to simply pass <code class="docutils literal notranslate"><span class="pre">inplace</span> <span class="pre">=</span> <span class="pre">True</span></code>. For more information, see the <a class="reference external" href="https://pandas.pydata.org/docs/reference/api/pandas.DataFrame.drop.html">pandas help documentation on <code class="docutils literal notranslate"><span class="pre">drop</span></code></a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Remove columns</span>
<span class="n">va_df</span> <span class="o">=</span> <span class="n">va_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">,</span> <span class="s2">&quot;county&quot;</span><span class="p">,</span> <span class="s2">&quot;tract&quot;</span><span class="p">])</span>

<span class="c1"># Show updated dataframe</span>
<span class="n">va_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>NAME</th>
      <th>C17002_001E</th>
      <th>C17002_002E</th>
      <th>C17002_003E</th>
      <th>B01003_001E</th>
      <th>GEOID</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Census Tract 60, Norfolk city, Virginia</td>
      <td>3947.0</td>
      <td>284.0</td>
      <td>507.0</td>
      <td>3947.0</td>
      <td>51710006000</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Census Tract 65.02, Norfolk city, Virginia</td>
      <td>3287.0</td>
      <td>383.0</td>
      <td>480.0</td>
      <td>3302.0</td>
      <td>51710006502</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</div>
<div class="section" id="check-column-data-types">
<h4>Check column data types<a class="headerlink" href="#check-column-data-types" title="Permalink to this headline">#</a></h4>
<p>The key in both dataframe must be of the same data type. Let’s check the data type of the <code class="docutils literal notranslate"><span class="pre">GEOID</span></code> columns in both dataframes. If they aren’t the same, we will have to change the data type of columns to make them the same.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Check column data types for census data</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Column data types for census data:</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">va_df</span><span class="o">.</span><span class="n">dtypes</span><span class="p">))</span>

<span class="c1"># Check column data types for census shapefile</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Column data types for census shapefile:</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">va_tract</span><span class="o">.</span><span class="n">dtypes</span><span class="p">))</span>

<span class="c1"># Source: https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.dtypes.html</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Column data types for census data:
NAME            object
C17002_001E    float64
C17002_002E    float64
C17002_003E    float64
B01003_001E    float64
GEOID           object
dtype: object

Column data types for census shapefile:
STATEFP       object
COUNTYFP      object
TRACTCE       object
GEOID         object
NAME          object
NAMELSAD      object
MTFCC         object
FUNCSTAT      object
ALAND          int64
AWATER         int64
INTPTLAT      object
INTPTLON      object
geometry    geometry
dtype: object
</pre></div>
</div>
</div>
</div>
<p>Looks like the <code class="docutils literal notranslate"><span class="pre">GEOID</span></code> columns are the same!</p>
</div>
<div class="section" id="merge-dataframes">
<h4>Merge dataframes<a class="headerlink" href="#merge-dataframes" title="Permalink to this headline">#</a></h4>
<p>Now, we are ready to merge the two dataframes together, using the <code class="docutils literal notranslate"><span class="pre">GEOID</span></code> columns as the primary key. We can use the <code class="docutils literal notranslate"><span class="pre">merge</span></code> method in <code class="docutils literal notranslate"><span class="pre">GeoPandas</span></code> called on the <code class="docutils literal notranslate"><span class="pre">va_tract</span></code> shapefile dataset.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Join the attributes of the dataframes together</span>
<span class="c1"># Source: https://geopandas.org/docs/user_guide/mergingdata.html</span>
<span class="n">va_merge</span> <span class="o">=</span> <span class="n">va_tract</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">va_df</span><span class="p">,</span> <span class="n">on</span> <span class="o">=</span> <span class="s2">&quot;GEOID&quot;</span><span class="p">)</span>

<span class="c1"># Show result</span>
<span class="nb">print</span><span class="p">(</span><span class="n">va_merge</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Shape: &#39;</span><span class="p">,</span> <span class="n">va_merge</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  STATEFP COUNTYFP TRACTCE        GEOID  NAME_x             NAMELSAD  MTFCC  \
0      51      700  032132  51700032132  321.32  Census Tract 321.32  G5020   
1      51      700  032226  51700032226  322.26  Census Tract 322.26  G5020   

  FUNCSTAT    ALAND  AWATER     INTPTLAT      INTPTLON  \
0        S  2552457       0  +37.1475176  -076.5212499   
1        S  3478916  165945  +37.1625163  -076.5527816   

                                            geometry  \
0  POLYGON ((897174.191 4119897.084, 897174.811 4...   
1  POLYGON ((893470.562 4123469.385, 893542.722 4...   

                                             NAME_y  C17002_001E  C17002_002E  \
0  Census Tract 321.32, Newport News city, Virginia       5025.0        161.0   
1  Census Tract 322.26, Newport News city, Virginia       4167.0        736.0   

   C17002_003E  B01003_001E  
0        342.0       5079.0  
1        559.0       4167.0  
Shape:  (1907, 18)
</pre></div>
</div>
</div>
</div>
<p>Success! We still have 1907 rows, which means that all rows (or most of them) were successfully matched! Notice how the census data has been added on after the shapefile data in the dataframe.</p>
<p>Some additional notes about joining dataframes:</p>
<ul class="simple">
<li><p>the columns for the key do not need to have the same name.</p></li>
<li><p>for this join, we had a one-to-one relationship, meaning one attribute in one dataframe matched to one (and only one) attribute in the other dataframe. Joins with a many-to-one, one-to-many, or many-to-many relationship are also possible, but in some cases, they require some special considerations. See this <a class="reference external" href="https://desktop.arcgis.com/en/arcmap/10.3/manage-data/tables/about-joining-and-relating-tables.htm">Esri ArcGIS help documentation on joins and relates</a> for more information.</p></li>
</ul>
</div>
<div class="section" id="subset-dataframe">
<h4>Subset dataframe<a class="headerlink" href="#subset-dataframe" title="Permalink to this headline">#</a></h4>
<p>Now that we merged the dataframes together, we can further clean up the dataframe and remove columns that are not needed. Instead of using the <code class="docutils literal notranslate"><span class="pre">drop</span></code> method, we can simply select the columns we want to keep and create a new dataframe with those selected columns.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create new dataframe from select columns</span>
<span class="n">va_poverty_tract</span> <span class="o">=</span> <span class="n">va_merge</span><span class="p">[[</span><span class="s2">&quot;STATEFP&quot;</span><span class="p">,</span> <span class="s2">&quot;COUNTYFP&quot;</span><span class="p">,</span> <span class="s2">&quot;TRACTCE&quot;</span><span class="p">,</span> <span class="s2">&quot;GEOID&quot;</span><span class="p">,</span> <span class="s2">&quot;geometry&quot;</span><span class="p">,</span> <span class="s2">&quot;C17002_001E&quot;</span><span class="p">,</span> <span class="s2">&quot;C17002_002E&quot;</span><span class="p">,</span> <span class="s2">&quot;C17002_003E&quot;</span><span class="p">,</span> <span class="s2">&quot;B01003_001E&quot;</span><span class="p">]]</span>

<span class="c1"># Show dataframe</span>
<span class="nb">print</span><span class="p">(</span><span class="n">va_poverty_tract</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Shape: &#39;</span><span class="p">,</span> <span class="n">va_poverty_tract</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  STATEFP COUNTYFP TRACTCE        GEOID  \
0      51      700  032132  51700032132   
1      51      700  032226  51700032226   

                                            geometry  C17002_001E  \
0  POLYGON ((897174.191 4119897.084, 897174.811 4...       5025.0   
1  POLYGON ((893470.562 4123469.385, 893542.722 4...       4167.0   

   C17002_002E  C17002_003E  B01003_001E  
0        161.0        342.0       5079.0  
1        736.0        559.0       4167.0  
Shape:  (1907, 9)
</pre></div>
</div>
</div>
</div>
<p>Notice how the number of columns dropped from 13 to 9.</p>
</div>
<div class="section" id="dissolve-geometries-and-get-summarized-statistics-to-get-poverty-statistics-at-the-county-level">
<h4>Dissolve geometries and get summarized statistics to get poverty statistics at the county level<a class="headerlink" href="#dissolve-geometries-and-get-summarized-statistics-to-get-poverty-statistics-at-the-county-level" title="Permalink to this headline">#</a></h4>
<p>Next, we will group all the census tracts within the same county (<code class="docutils literal notranslate"><span class="pre">COUNTYFP</span></code>) and aggregate the poverty and population values for those tracts within the same county. We can use the <code class="docutils literal notranslate"><span class="pre">dissolve</span></code> function in <code class="docutils literal notranslate"><span class="pre">GeoPandas</span></code>, which is the spatial version of <code class="docutils literal notranslate"><span class="pre">groupby</span></code> in <code class="docutils literal notranslate"><span class="pre">pandas</span></code>. We use <code class="docutils literal notranslate"><span class="pre">dissolve</span></code> instead of <code class="docutils literal notranslate"><span class="pre">groupby</span></code> because the former also groups and merges all the geometries (in this case, census tracts) within a given group (in this case, counties).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Dissolve and group the census tracts within each county and aggregate all the values together</span>
<span class="c1"># Source: https://geopandas.org/docs/user_guide/aggregation_with_dissolve.html</span>
<span class="n">va_poverty_county</span> <span class="o">=</span> <span class="n">va_poverty_tract</span><span class="o">.</span><span class="n">dissolve</span><span class="p">(</span><span class="n">by</span> <span class="o">=</span> <span class="s1">&#39;COUNTYFP&#39;</span><span class="p">,</span> <span class="n">aggfunc</span> <span class="o">=</span> <span class="s1">&#39;sum&#39;</span><span class="p">)</span>

<span class="c1"># Show dataframe</span>
<span class="nb">print</span><span class="p">(</span><span class="n">va_poverty_county</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Shape: &#39;</span><span class="p">,</span> <span class="n">va_poverty_county</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                                                   geometry  C17002_001E  \
COUNTYFP                                                                   
001       POLYGON ((971901.668 4160101.088, 971814.409 4...      32345.0   
003       POLYGON ((734957.267 4207640.156, 734931.249 4...      97587.0   

          C17002_002E  C17002_003E  B01003_001E  
COUNTYFP                                         
001            2423.0       3993.0      32840.0  
003            5276.0       4305.0     105105.0  
Shape:  (133, 5)
</pre></div>
</div>
</div>
</div>
<p>Notice that we got the number of rows down from 1907 to 133.</p>
</div>
<div class="section" id="perform-column-math-to-get-poverty-rates">
<h4>Perform column math to get poverty rates<a class="headerlink" href="#perform-column-math-to-get-poverty-rates" title="Permalink to this headline">#</a></h4>
<p>We can estimate the poverty rate by dividing the sum of <code class="docutils literal notranslate"><span class="pre">C17002_002E</span></code> (ratio of income to poverty in the past 12 months, &lt; 0.50) and <code class="docutils literal notranslate"><span class="pre">C17002_003E</span></code> (ratio of income to poverty in the past 12 months, 0.50 - 0.99) by <code class="docutils literal notranslate"><span class="pre">B01003_001E</span></code> (total population).</p>
<p>Side note: Notice that <code class="docutils literal notranslate"><span class="pre">C17002_001E</span></code> (ratio of income to poverty in the past 12 months, total), which theoretically should count everyone, does not exactly match up with <code class="docutils literal notranslate"><span class="pre">B01003_001E</span></code> (total population). We’ll disregard this for now since the difference is not too significant.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get poverty rate and store values in new column</span>
<span class="n">va_poverty_county</span><span class="p">[</span><span class="s2">&quot;Poverty_Rate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">va_poverty_county</span><span class="p">[</span><span class="s2">&quot;C17002_002E&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">va_poverty_county</span><span class="p">[</span><span class="s2">&quot;C17002_003E&quot;</span><span class="p">])</span> <span class="o">/</span> <span class="n">va_poverty_county</span><span class="p">[</span><span class="s2">&quot;B01003_001E&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span>

<span class="c1"># Show dataframe</span>
<span class="n">va_poverty_county</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>geometry</th>
      <th>C17002_001E</th>
      <th>C17002_002E</th>
      <th>C17002_003E</th>
      <th>B01003_001E</th>
      <th>Poverty_Rate</th>
    </tr>
    <tr>
      <th>COUNTYFP</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>001</th>
      <td>POLYGON ((971901.668 4160101.088, 971814.409 4...</td>
      <td>32345.0</td>
      <td>2423.0</td>
      <td>3993.0</td>
      <td>32840.0</td>
      <td>19.537150</td>
    </tr>
    <tr>
      <th>003</th>
      <td>POLYGON ((734957.267 4207640.156, 734931.249 4...</td>
      <td>97587.0</td>
      <td>5276.0</td>
      <td>4305.0</td>
      <td>105105.0</td>
      <td>9.115646</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</div>
</div>
<div class="section" id="plotting-results">
<h3>Plotting Results<a class="headerlink" href="#plotting-results" title="Permalink to this headline">#</a></h3>
<p>Finally, since we have the spatial component connected to our census data, we can plot the results!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create subplots</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

<span class="c1"># Plot data</span>
<span class="c1"># Source: https://geopandas.readthedocs.io/en/latest/docs/user_guide/mapping.html</span>
<span class="n">va_poverty_county</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">column</span> <span class="o">=</span> <span class="s2">&quot;Poverty_Rate&quot;</span><span class="p">,</span>
                       <span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span>
                       <span class="n">cmap</span> <span class="o">=</span> <span class="s2">&quot;RdPu&quot;</span><span class="p">,</span>
                       <span class="n">legend</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

<span class="c1"># Stylize plots</span>
<span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;bmh&#39;</span><span class="p">)</span>

<span class="c1"># Set title</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Poverty Rates (%) in Virginia&#39;</span><span class="p">,</span> <span class="n">fontdict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;fontsize&#39;</span><span class="p">:</span> <span class="s1">&#39;25&#39;</span><span class="p">,</span> <span class="s1">&#39;fontweight&#39;</span> <span class="p">:</span> <span class="s1">&#39;3&#39;</span><span class="p">})</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0.5, 1.0, &#39;Poverty Rates (%) in Virginia&#39;)
</pre></div>
</div>
<img alt="../_images/e_vector_merge_dissolve_28_1.png" src="../_images/e_vector_merge_dissolve_28_1.png" />
</div>
</div>
</div>
</div>
<span id="document-docs/e_extraction"></span><hr class="docutils" />
<div class="admonition-learning-objectives admonition">
<p class="admonition-title">Learning Objectives</p>
<ul class="simple">
<li><p>Clip a vector feature using another vector feature</p></li>
<li><p>Select features by their attributes</p></li>
<li><p>Select features by their locations</p></li>
</ul>
</div>
<div class="admonition-review admonition">
<p class="admonition-title">Review</p>
<ul class="simple">
<li><p><a class="reference internal" href="docs/a_intro.html#document-docs/c_vectors"><span class="doc std std-doc">Spatial Vector Data</span></a></p></li>
<li><p><a class="reference internal" href="docs/a_intro.html#document-docs/e_attributes"><span class="doc std std-doc">Attributes &amp; Indexing for Vector Data</span></a></p></li>
<li><p><a class="reference internal" href="docs/a_intro.html#document-docs/c_new_vectors"><span class="doc std std-doc">Creating Spatial Vector Data</span></a></p></li>
</ul>
</div>
<hr class="docutils" />
<div class="tex2jax_ignore mathjax_ignore section" id="extracting-spatial-data">
<h2>Extracting Spatial Data<a class="headerlink" href="#extracting-spatial-data" title="Permalink to this headline">#</a></h2>
<p>Subsetting and extracting data is useful when we want to select or analyze a portion of the dataset based on a feature’s location, attribute, or its spatial relationship to another dataset.</p>
<p>In this chapter, we will explore three ways that data from a GeoDataFrame can be subsetted and extracted: clip, select location by attribute, and select by location.</p>
<div class="section" id="setup">
<h3>Setup<a class="headerlink" href="#setup" title="Permalink to this headline">#</a></h3>
<p>First, let’s import the necessary modules (click the + below to show code cell).</p>
<div class="cell tag_hide-cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Import modules</span>
<span class="kn">import</span> <span class="nn">geopandas</span> <span class="k">as</span> <span class="nn">gpd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">shapely.geometry</span> <span class="kn">import</span> <span class="n">Polygon</span>
</pre></div>
</div>
</div>
</div>
<p>We will utilize shapefiles of San Francisco Bay Area county boundaries and wells within the Bay Area and the surrounding 50 km. We will first load in the data and reproject the data (click the + below to show code cell).</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>All the data must have the same coordinate system in order for extraction to work correctly.</p>
</div>
<div class="cell tag_hide-cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Load data</span>

<span class="c1"># County boundaries</span>
<span class="c1"># Source: https://opendata.mtc.ca.gov/datasets/san-francisco-bay-region-counties-clipped?geometry=-125.590%2C37.123%2C-119.152%2C38.640</span>
<span class="n">counties</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="s2">&quot;../_static/e_vector_shapefiles/sf_bay_counties/sf_bay_counties.shp&quot;</span><span class="p">)</span>

<span class="c1"># Well locations</span>
<span class="c1"># Source: https://gis.data.ca.gov/datasets/3a3e681b894644a9a95f9815aeeeb57f_0?geometry=-123.143%2C36.405%2C-119.230%2C37.175</span>
<span class="c1"># Modified by author so that only the well locations within the counties and the surrounding 50 km were kept</span>
<span class="n">wells</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="s2">&quot;../_static/e_vector_shapefiles/sf_bay_wells_50km/sf_bay_wells_50km.shp&quot;</span><span class="p">)</span>

<span class="c1"># Reproject data to NAD83(HARN) / California Zone 3</span>
<span class="c1"># https://spatialreference.org/ref/epsg/2768/</span>
<span class="n">proj</span> <span class="o">=</span> <span class="mi">2768</span>
<span class="n">counties</span> <span class="o">=</span> <span class="n">counties</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">proj</span><span class="p">)</span>
<span class="n">wells</span> <span class="o">=</span> <span class="n">wells</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">proj</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We will also create a rectangle over a part of the Bay Area. We have identified coordinates to use for this rectangle, but you can also use <a class="reference external" href="http://bboxfinder.com/">bbox finder</a> to generate custom bounding boxes and obtain their coordinates (click the + below to show code cell).</p>
<div class="cell tag_hide-cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create list of coordinate pairs</span>
<span class="n">coordinates</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">1790787</span><span class="p">,</span> <span class="mi">736108</span><span class="p">],</span> <span class="p">[</span><span class="mi">1929652</span><span class="p">,</span> <span class="mi">736108</span><span class="p">],</span> <span class="p">[</span><span class="mi">1929652</span><span class="p">,</span> <span class="mi">598414</span><span class="p">],</span> <span class="p">[</span><span class="mi">1790787</span><span class="p">,</span> <span class="mi">598414</span><span class="p">]]</span>

<span class="c1"># Create a Shapely polygon from the coordinate-tuple list</span>
<span class="n">poly_shapely</span> <span class="o">=</span> <span class="n">Polygon</span><span class="p">(</span><span class="n">coordinates</span><span class="p">)</span>

<span class="c1"># Create a dictionary with needed attributes and required geometry column</span>
<span class="n">attributes_df</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Attribute&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;name1&#39;</span><span class="p">],</span> <span class="s1">&#39;geometry&#39;</span><span class="p">:</span> <span class="n">poly_shapely</span><span class="p">}</span>

<span class="c1"># Convert shapely object to a GeoDataFrame</span>
<span class="n">poly</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">attributes_df</span><span class="p">,</span> <span class="n">geometry</span> <span class="o">=</span> <span class="s1">&#39;geometry&#39;</span><span class="p">,</span> <span class="n">crs</span> <span class="o">=</span> <span class="s2">&quot;EPSG:2768&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We’ll define some functions to make displaying and mapping our results a bit easier (click the + below to show code cell).</p>
<div class="cell tag_hide-cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">display_table</span><span class="p">(</span><span class="n">table_name</span><span class="p">,</span> <span class="n">attribute_table</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Display the first and last five rows of attribute table.&#39;&#39;&#39;</span>

    <span class="c1"># Print title</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Attribute Table: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">table_name</span><span class="p">))</span>

    <span class="c1"># Print number of rows and columns</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Table shape (rows, columns): </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">attribute_table</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>

    <span class="c1"># Display first two rows of attribute table</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">First two rows:&quot;</span><span class="p">)</span>
    <span class="n">display</span><span class="p">(</span><span class="n">attribute_table</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>

    <span class="c1"># Display last two rows of attribute table</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Last two rows:&quot;</span><span class="p">)</span>
    <span class="n">display</span><span class="p">(</span><span class="n">attribute_table</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">plot_df</span><span class="p">(</span><span class="n">result_name</span><span class="p">,</span> <span class="n">result_df</span><span class="p">,</span> <span class="n">result_geom_type</span><span class="p">,</span> <span class="n">area</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Plot the result on a map and add the outlines of the original shapefiles.&#39;&#39;&#39;</span>

    <span class="c1"># Create subplots</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

    <span class="c1"># Plot data depending on vector type</span>
    <span class="c1"># For points</span>
    <span class="k">if</span> <span class="n">result_geom_type</span> <span class="o">==</span> <span class="s2">&quot;point&quot;</span><span class="p">:</span>

        <span class="c1"># Plot data</span>
        <span class="n">counties</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;dimgray&#39;</span><span class="p">)</span>
        <span class="n">wells</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span> <span class="n">marker</span> <span class="o">=</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;dimgray&#39;</span><span class="p">,</span> <span class="n">markersize</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">result_df</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span> <span class="n">marker</span> <span class="o">=</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;dodgerblue&#39;</span><span class="p">,</span> <span class="n">markersize</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span>

    <span class="c1"># For polygons</span>
    <span class="k">else</span><span class="p">:</span>

        <span class="c1"># Plot overlay data</span>
        <span class="n">result_df</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;Set2&#39;</span><span class="p">,</span> <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;black&#39;</span><span class="p">)</span>

        <span class="c1"># Plot outlines of original shapefiles</span>
        <span class="n">counties</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;dimgray&#39;</span><span class="p">)</span>

    <span class="c1"># Add additional outlined boundary if specified</span>
    <span class="k">if</span> <span class="n">area</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

        <span class="c1"># Plot data</span>
        <span class="n">area</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;lightseagreen&#39;</span><span class="p">,</span> <span class="n">linewidth</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span>

    <span class="c1"># Else, pass</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="c1"># Stylize plots</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;bmh&#39;</span><span class="p">)</span>

    <span class="c1"># Set title</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">result_name</span><span class="p">,</span> <span class="n">fontdict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;fontsize&#39;</span><span class="p">:</span> <span class="s1">&#39;15&#39;</span><span class="p">,</span> <span class="s1">&#39;fontweight&#39;</span> <span class="p">:</span> <span class="s1">&#39;3&#39;</span><span class="p">})</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s take a look at what our input data looks like.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create subplots</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

<span class="c1"># Plot data</span>
<span class="n">counties</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;bisque&#39;</span><span class="p">,</span> <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;dimgray&#39;</span><span class="p">)</span>
<span class="n">wells</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span> <span class="n">marker</span> <span class="o">=</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;dodgerblue&#39;</span><span class="p">,</span> <span class="n">markersize</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">poly</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;aquamarine&#39;</span><span class="p">,</span> <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;lightseagreen&#39;</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.55</span><span class="p">)</span>

<span class="c1"># Stylize plots</span>
<span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;bmh&#39;</span><span class="p">)</span>

<span class="c1"># Set title</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;San Francisco Bay Area&#39;</span><span class="p">,</span> <span class="n">fontdict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;fontsize&#39;</span><span class="p">:</span> <span class="s1">&#39;15&#39;</span><span class="p">,</span> <span class="s1">&#39;fontweight&#39;</span> <span class="p">:</span> <span class="s1">&#39;3&#39;</span><span class="p">})</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0.5, 1.0, &#39;San Francisco Bay Area&#39;)
</pre></div>
</div>
<img alt="../_images/e_extraction_9_1.png" src="../_images/e_extraction_9_1.png" />
</div>
</div>
</div>
<div class="section" id="clip-spatial-polygons">
<h3>Clip Spatial Polygons<a class="headerlink" href="#clip-spatial-polygons" title="Permalink to this headline">#</a></h3>
<p>Clip extracts and keeps only the geometries of a vector feature that are within extent of another vector feature (think of it like a cookie-cutter or mask). We can use  <code class="docutils literal notranslate"><span class="pre">clip()</span></code> in <code class="docutils literal notranslate"><span class="pre">geopandas</span></code>, with the first parameter being the vector that will be clipped and the second parameter being the vector that will define the extent of the clip. <em>All attributes for the resulting clipped vector will be kept.</em> <a class="footnote-reference brackets" href="#gpd-clip" id="id1">1</a></p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This function is only available in the more recent versions of <code class="docutils literal notranslate"><span class="pre">geopandas</span></code>.</p>
</div>
<p>We will first clip the Bay Area counties polygon to our created rectangle polygon.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Clip data</span>
<span class="n">clip_counties</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">counties</span><span class="p">,</span> <span class="n">poly</span><span class="p">)</span>

<span class="c1"># Display attribute table</span>
<span class="n">display</span><span class="p">(</span><span class="n">clip_counties</span><span class="p">)</span>

<span class="c1"># Plot clip</span>
<span class="n">plot_df</span><span class="p">(</span><span class="n">result_name</span> <span class="o">=</span> <span class="s2">&quot;San Francisco Bay Area Counties</span><span class="se">\n</span><span class="s2">Clip&quot;</span><span class="p">,</span> <span class="n">result_df</span> <span class="o">=</span> <span class="n">clip_counties</span><span class="p">,</span> <span class="n">result_geom_type</span> <span class="o">=</span> <span class="s2">&quot;polygon&quot;</span><span class="p">,</span> <span class="n">area</span> <span class="o">=</span> <span class="n">poly</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>coname</th>
      <th>geometry</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Alameda County</td>
      <td>MULTIPOLYGON (((1860234.837 612219.122, 186007...</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Contra Costa County</td>
      <td>MULTIPOLYGON (((1836501.066 656512.837, 183649...</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Marin County</td>
      <td>MULTIPOLYGON (((1822277.787 655539.623, 182231...</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Napa County</td>
      <td>POLYGON ((1860171.549 724651.231, 1860170.736 ...</td>
    </tr>
    <tr>
      <th>4</th>
      <td>San Francisco County</td>
      <td>MULTIPOLYGON (((1834364.295 641524.540, 183435...</td>
    </tr>
    <tr>
      <th>5</th>
      <td>San Mateo County</td>
      <td>MULTIPOLYGON (((1850042.437 615031.357, 185003...</td>
    </tr>
    <tr>
      <th>6</th>
      <td>Santa Clara County</td>
      <td>MULTIPOLYGON (((1858733.082 607586.450, 185874...</td>
    </tr>
    <tr>
      <th>7</th>
      <td>Solano County</td>
      <td>MULTIPOLYGON (((1875491.908 673077.900, 187549...</td>
    </tr>
    <tr>
      <th>8</th>
      <td>Sonoma County</td>
      <td>POLYGON ((1813621.641 736108.000, 1813605.098 ...</td>
    </tr>
  </tbody>
</table>
</div></div><img alt="../_images/e_extraction_11_1.png" src="../_images/e_extraction_11_1.png" />
</div>
</div>
<p>We can clip any vector type. Next, we will clip the wells point data to our created rectangle polygon.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Clip data</span>
<span class="n">clip_wells</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">wells</span><span class="p">,</span> <span class="n">poly</span><span class="p">)</span>

<span class="c1"># Display attribute table</span>
<span class="n">display</span><span class="p">(</span><span class="n">clip_wells</span><span class="p">)</span>

<span class="c1"># Plot clip</span>
<span class="n">plot_df</span><span class="p">(</span><span class="n">result_name</span> <span class="o">=</span> <span class="s2">&quot;San Francisco Bay Area Wells</span><span class="se">\n</span><span class="s2">Clip&quot;</span><span class="p">,</span> <span class="n">result_df</span> <span class="o">=</span> <span class="n">clip_wells</span><span class="p">,</span> <span class="n">result_geom_type</span> <span class="o">=</span> <span class="s2">&quot;point&quot;</span><span class="p">,</span> <span class="n">area</span> <span class="o">=</span> <span class="n">poly</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>WELL_NAME</th>
      <th>WELL_USE</th>
      <th>WELL_TYPE</th>
      <th>WELL_DEPTH</th>
      <th>geometry</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2</th>
      <td>Flag City Well 3</td>
      <td>Unknown</td>
      <td>Single Well</td>
      <td>0</td>
      <td>POINT (1922067.711 679380.918)</td>
    </tr>
    <tr>
      <th>14</th>
      <td>Flag City Well 1</td>
      <td>Unknown</td>
      <td>Single Well</td>
      <td>170</td>
      <td>POINT (1922680.537 679641.516)</td>
    </tr>
    <tr>
      <th>15</th>
      <td>Flag City Well 2</td>
      <td>Unknown</td>
      <td>Single Well</td>
      <td>180</td>
      <td>POINT (1921777.555 679393.668)</td>
    </tr>
    <tr>
      <th>25</th>
      <td>W-041</td>
      <td>Other</td>
      <td>Single Well</td>
      <td>256</td>
      <td>POINT (1919777.393 713390.175)</td>
    </tr>
    <tr>
      <th>26</th>
      <td>W-042</td>
      <td>Other</td>
      <td>Single Well</td>
      <td>245</td>
      <td>POINT (1917586.004 713468.595)</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>6029</th>
      <td>None</td>
      <td>Unknown</td>
      <td>Unknown</td>
      <td>465</td>
      <td>POINT (1848120.290 703766.303)</td>
    </tr>
    <tr>
      <th>6030</th>
      <td>None</td>
      <td>Irrigation</td>
      <td>Unknown</td>
      <td>51</td>
      <td>POINT (1842158.280 695286.242)</td>
    </tr>
    <tr>
      <th>6031</th>
      <td>None</td>
      <td>Unknown</td>
      <td>Unknown</td>
      <td>315</td>
      <td>POINT (1848812.488 704308.579)</td>
    </tr>
    <tr>
      <th>6032</th>
      <td>GV FARM</td>
      <td>Residential</td>
      <td>Single Well</td>
      <td>67</td>
      <td>POINT (1855297.377 693189.634)</td>
    </tr>
    <tr>
      <th>6033</th>
      <td>None</td>
      <td>Residential</td>
      <td>Unknown</td>
      <td>76</td>
      <td>POINT (1841755.238 707939.225)</td>
    </tr>
  </tbody>
</table>
<p>2013 rows × 5 columns</p>
</div></div><img alt="../_images/e_extraction_13_1.png" src="../_images/e_extraction_13_1.png" />
</div>
</div>
</div>
<div class="section" id="select-location-by-attributes">
<h3>Select Location by Attributes<a class="headerlink" href="#select-location-by-attributes" title="Permalink to this headline">#</a></h3>
<p>Selecting by attribute selects only the features in a dataset whose attribute values match the specified criteria. <code class="docutils literal notranslate"><span class="pre">geopandas</span></code> uses the indexing and selection methods  in <code class="docutils literal notranslate"><span class="pre">pandas</span></code>, so data in a GeoDataFrame can be selected and queried in the same way a <code class="docutils literal notranslate"><span class="pre">pandas</span></code> dataframe can. <a class="footnote-reference brackets" href="#gpd-select" id="id2">2</a>, <a class="footnote-reference brackets" href="#pd-select" id="id3">3</a>, <a class="footnote-reference brackets" href="#pd-subset" id="id4">4</a></p>
<p>We will use use different criteria to subset the wells dataset.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Display attribute table</span>
<span class="n">display</span><span class="p">(</span><span class="n">wells</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>WELL_NAME</th>
      <th>WELL_USE</th>
      <th>WELL_TYPE</th>
      <th>WELL_DEPTH</th>
      <th>geometry</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2400064-001</td>
      <td>Public Supply</td>
      <td>Single Well</td>
      <td>0</td>
      <td>POINT (1968290.923 592019.918)</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2400099-001</td>
      <td>Public Supply</td>
      <td>Single Well</td>
      <td>0</td>
      <td>POINT (1969113.543 595876.691)</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>The criteria can use a variety of operators, including comparison and logical operators.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Select wells that are public supply</span>
<span class="n">wells_public</span> <span class="o">=</span> <span class="n">wells</span><span class="p">[(</span><span class="n">wells</span><span class="p">[</span><span class="s2">&quot;WELL_USE&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Public Supply&quot;</span><span class="p">)]</span>

<span class="c1"># Display first two and last two rows of attribute table</span>
<span class="n">display_table</span><span class="p">(</span><span class="n">table_name</span> <span class="o">=</span> <span class="s2">&quot;San Francisco Bay Area Wells - Public Supply&quot;</span><span class="p">,</span> <span class="n">attribute_table</span> <span class="o">=</span> <span class="n">wells_public</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Attribute Table: San Francisco Bay Area Wells - Public Supply

Table shape (rows, columns): (33, 5)

First two rows:
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>WELL_NAME</th>
      <th>WELL_USE</th>
      <th>WELL_TYPE</th>
      <th>WELL_DEPTH</th>
      <th>geometry</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2400064-001</td>
      <td>Public Supply</td>
      <td>Single Well</td>
      <td>0</td>
      <td>POINT (1968290.923 592019.918)</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2400099-001</td>
      <td>Public Supply</td>
      <td>Single Well</td>
      <td>0</td>
      <td>POINT (1969113.543 595876.691)</td>
    </tr>
  </tbody>
</table>
</div></div><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Last two rows:
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>WELL_NAME</th>
      <th>WELL_USE</th>
      <th>WELL_TYPE</th>
      <th>WELL_DEPTH</th>
      <th>geometry</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>3368</th>
      <td>Aptos Creek PW</td>
      <td>Public Supply</td>
      <td>Single Well</td>
      <td>713</td>
      <td>POINT (1875127.938 553764.966)</td>
    </tr>
    <tr>
      <th>3369</th>
      <td>Country Club PW</td>
      <td>Public Supply</td>
      <td>Single Well</td>
      <td>495</td>
      <td>POINT (1877219.818 552137.819)</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Select wells that are public supply and have a depth greater than 50 ft</span>
<span class="n">wells_public_deep</span> <span class="o">=</span> <span class="n">wells</span><span class="p">[(</span><span class="n">wells</span><span class="p">[</span><span class="s2">&quot;WELL_USE&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Public Supply&quot;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">wells</span><span class="p">[</span><span class="s2">&quot;WELL_DEPTH&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">)]</span>

<span class="c1"># Display first two and last two rows of attribute table</span>
<span class="n">display_table</span><span class="p">(</span><span class="n">table_name</span> <span class="o">=</span> <span class="s2">&quot;San Francisco Bay Area Wells - Public Supply with Depth Greater than 50 ft&quot;</span><span class="p">,</span> <span class="n">attribute_table</span> <span class="o">=</span> <span class="n">wells_public_deep</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Attribute Table: San Francisco Bay Area Wells - Public Supply with Depth Greater than 50 ft

Table shape (rows, columns): (24, 5)

First two rows:
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>WELL_NAME</th>
      <th>WELL_USE</th>
      <th>WELL_TYPE</th>
      <th>WELL_DEPTH</th>
      <th>geometry</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>919</th>
      <td>Granite Way PW</td>
      <td>Public Supply</td>
      <td>Single Well</td>
      <td>670</td>
      <td>POINT (1875403.340 554078.279)</td>
    </tr>
    <tr>
      <th>1082</th>
      <td>Aptos Jr. High 2 PW</td>
      <td>Public Supply</td>
      <td>Single Well</td>
      <td>590</td>
      <td>POINT (1876872.389 553821.138)</td>
    </tr>
  </tbody>
</table>
</div></div><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Last two rows:
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>WELL_NAME</th>
      <th>WELL_USE</th>
      <th>WELL_TYPE</th>
      <th>WELL_DEPTH</th>
      <th>geometry</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>3368</th>
      <td>Aptos Creek PW</td>
      <td>Public Supply</td>
      <td>Single Well</td>
      <td>713</td>
      <td>POINT (1875127.938 553764.966)</td>
    </tr>
    <tr>
      <th>3369</th>
      <td>Country Club PW</td>
      <td>Public Supply</td>
      <td>Single Well</td>
      <td>495</td>
      <td>POINT (1877219.818 552137.819)</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Select wells that are public supply and have a depth greater than 50 ft OR are residential</span>
<span class="n">wells_public_deep_residential</span> <span class="o">=</span> <span class="n">wells</span><span class="p">[((</span><span class="n">wells</span><span class="p">[</span><span class="s2">&quot;WELL_USE&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Public Supply&quot;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">wells</span><span class="p">[</span><span class="s2">&quot;WELL_DEPTH&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">))</span> <span class="o">|</span> <span class="p">(</span><span class="n">wells</span><span class="p">[</span><span class="s2">&quot;WELL_USE&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Residential&quot;</span><span class="p">)]</span>

<span class="c1"># Display first two and last two rows of attribute table</span>
<span class="n">display_table</span><span class="p">(</span><span class="n">table_name</span> <span class="o">=</span> <span class="s2">&quot;San Francisco Bay Area Wells - Public Supply with Depth Greater than 50 ft or Residential&quot;</span><span class="p">,</span> <span class="n">attribute_table</span> <span class="o">=</span> <span class="n">wells_public_deep_residential</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Attribute Table: San Francisco Bay Area Wells - Public Supply with Depth Greater than 50 ft or Residential

Table shape (rows, columns): (725, 5)

First two rows:
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>WELL_NAME</th>
      <th>WELL_USE</th>
      <th>WELL_TYPE</th>
      <th>WELL_DEPTH</th>
      <th>geometry</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>137</th>
      <td>None</td>
      <td>Residential</td>
      <td>Unknown</td>
      <td>78</td>
      <td>POINT (1886296.744 730378.969)</td>
    </tr>
    <tr>
      <th>138</th>
      <td>None</td>
      <td>Residential</td>
      <td>Unknown</td>
      <td>80</td>
      <td>POINT (1877320.295 730464.652)</td>
    </tr>
  </tbody>
</table>
</div></div><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Last two rows:
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>WELL_NAME</th>
      <th>WELL_USE</th>
      <th>WELL_TYPE</th>
      <th>WELL_DEPTH</th>
      <th>geometry</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>6032</th>
      <td>GV FARM</td>
      <td>Residential</td>
      <td>Single Well</td>
      <td>67</td>
      <td>POINT (1855297.377 693189.634)</td>
    </tr>
    <tr>
      <th>6033</th>
      <td>None</td>
      <td>Residential</td>
      <td>Unknown</td>
      <td>76</td>
      <td>POINT (1841755.238 707939.225)</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</div>
<div class="section" id="select-by-location">
<h3>Select by Location<a class="headerlink" href="#select-by-location" title="Permalink to this headline">#</a></h3>
<p>Selecting by location selects features based on its relative spatial relationship with another dataset. In other words, features are selected based on their location relative to the location of another dataset.</p>
<p>For example:</p>
<ul class="simple">
<li><p>to know how many wells there are in Santa Clara County, we could select all the wells that fall within Santa Clara County boundaries (which we do in one of the examples below)</p></li>
<li><p>to know what rivers flow through Santa Clara County, we could select all the river polylines that intersect with Santa Clara County boundaries</p></li>
</ul>
<p>For more information on selecting by location and spatial relationships, check out this <a class="reference external" href="https://desktop.arcgis.com/en/arcmap/10.3/map/working-with-layers/using-select-by-location.htm">ArcGIS documentation</a>.</p>
<p>There are multiple spatial relationships available in <code class="docutils literal notranslate"><span class="pre">geopandas</span></code>: <a class="footnote-reference brackets" href="#gpd-binary" id="id5">5</a></p>
<table class="colwidths-auto docutils align-default">
<thead>
<tr class="row-odd"><th class="text-align:left head"><p>Spatial Relationship</p></th>
<th class="head"><p>Function(s)</p></th>
<th class="text-align:right head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td class="text-align:left"><p>contains</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">contains()</span></code></p></td>
<td class="text-align:right"><p>geometry encompasses the other geometry’s boundary and interior without any boundaries touching</p></td>
</tr>
<tr class="row-odd"><td class="text-align:left"><p>covers</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">covers()</span></code></p></td>
<td class="text-align:right"><p>all of the geometry’s points are to the exterior of the other geometry’s points</p></td>
</tr>
<tr class="row-even"><td class="text-align:left"><p>covered by</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">covered_by()</span></code></p></td>
<td class="text-align:right"><p>all of the geometry’s points are to the interior of the other geometry’s points</p></td>
</tr>
<tr class="row-odd"><td class="text-align:left"><p>crosses</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">crosses()</span></code></p></td>
<td class="text-align:right"><p>geometry’s interior intersects that of the other geometry, provided that the geometry does not contain the other and the dimension of the intersection is less than the dimension of either geometry</p></td>
</tr>
<tr class="row-even"><td class="text-align:left"><p>disjoint</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">disjoint()</span></code></p></td>
<td class="text-align:right"><p>geometry’s boundary and interior do not intersect the boundary and interior of the other geometry</p></td>
</tr>
<tr class="row-odd"><td class="text-align:left"><p>equal geometry</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">geom_equals()</span></code>, <code class="docutils literal notranslate"><span class="pre">geom_almost_equals()</span></code>, <code class="docutils literal notranslate"><span class="pre">geom_equals_exact()</span></code></p></td>
<td class="text-align:right"><p>geometry’s boundary, interior, and exterior matches (within a range) those of the other</p></td>
</tr>
<tr class="row-even"><td class="text-align:left"><p>intersects</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">intersects()</span></code></p></td>
<td class="text-align:right"><p>geometry’s boundary or interior touches or crosses any part of the other geometry</p></td>
</tr>
<tr class="row-odd"><td class="text-align:left"><p>overlaps</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">overlaps()</span></code></p></td>
<td class="text-align:right"><p>geometry shares at least one point, but not all points, with the other geometry, provided that the geometries and the intersection of their interiors all have the same dimensions</p></td>
</tr>
<tr class="row-even"><td class="text-align:left"><p>touches</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">touches()</span></code></p></td>
<td class="text-align:right"><p>geometry shares at least one point with the other geometry, provided that no part of the geometry’s interior intersects with the other geometry</p></td>
</tr>
<tr class="row-odd"><td class="text-align:left"><p>within</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">within()</span></code></p></td>
<td class="text-align:right"><p>geometry is enclosed in the other geometry (geometry’s boundary and interior intersects with the other geometry’s interior only)</p></td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The functions for these spatial relationships will generally output a <code class="docutils literal notranslate"><span class="pre">pandas</span></code> series with Boolean values (<code class="docutils literal notranslate"><span class="pre">True</span></code> or <code class="docutils literal notranslate"><span class="pre">False</span></code>) whose indexing corresponds with the input dataset (from where we want to subset the data). We can use these Boolean values to subset the dataset (where only the rows that have a <code class="docutils literal notranslate"><span class="pre">True</span></code> output will be retained).</p>
</div>
<div class="section" id="method-1-shapely-vector">
<h4>Method 1 - Shapely vector<a class="headerlink" href="#method-1-shapely-vector" title="Permalink to this headline">#</a></h4>
<p>These functions can be used to select features that have the specified spatial relationship with a single Shapely vector.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Select wells that fall within Shapely rectangle</span>
<span class="n">wells_within_rect_shapely</span> <span class="o">=</span> <span class="n">wells</span><span class="p">[</span><span class="n">wells</span><span class="o">.</span><span class="n">within</span><span class="p">(</span><span class="n">poly_shapely</span><span class="p">)]</span>

<span class="c1"># Display first two and last two rows of attribute table</span>
<span class="n">display_table</span><span class="p">(</span><span class="n">table_name</span> <span class="o">=</span> <span class="s2">&quot;San Francisco Bay Area Wells within a User-Defined Rectangle&quot;</span><span class="p">,</span> <span class="n">attribute_table</span> <span class="o">=</span> <span class="n">wells_within_rect_shapely</span><span class="p">)</span>

<span class="c1"># Plot selection</span>
<span class="n">plot_df</span><span class="p">(</span><span class="n">result_name</span> <span class="o">=</span> <span class="s2">&quot;San Francisco Bay Area Wells within a User-Defined Rectangle&quot;</span><span class="p">,</span> <span class="n">result_df</span> <span class="o">=</span> <span class="n">wells_within_rect_shapely</span><span class="p">,</span> <span class="n">result_geom_type</span> <span class="o">=</span> <span class="s2">&quot;point&quot;</span><span class="p">,</span> <span class="n">area</span> <span class="o">=</span> <span class="n">poly</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Attribute Table: San Francisco Bay Area Wells within a User-Defined Rectangle

Table shape (rows, columns): (2013, 5)

First two rows:
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>WELL_NAME</th>
      <th>WELL_USE</th>
      <th>WELL_TYPE</th>
      <th>WELL_DEPTH</th>
      <th>geometry</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2</th>
      <td>Flag City Well 3</td>
      <td>Unknown</td>
      <td>Single Well</td>
      <td>0</td>
      <td>POINT (1922067.711 679380.918)</td>
    </tr>
    <tr>
      <th>14</th>
      <td>Flag City Well 1</td>
      <td>Unknown</td>
      <td>Single Well</td>
      <td>170</td>
      <td>POINT (1922680.537 679641.516)</td>
    </tr>
  </tbody>
</table>
</div></div><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Last two rows:
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>WELL_NAME</th>
      <th>WELL_USE</th>
      <th>WELL_TYPE</th>
      <th>WELL_DEPTH</th>
      <th>geometry</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>6032</th>
      <td>GV FARM</td>
      <td>Residential</td>
      <td>Single Well</td>
      <td>67</td>
      <td>POINT (1855297.377 693189.634)</td>
    </tr>
    <tr>
      <th>6033</th>
      <td>None</td>
      <td>Residential</td>
      <td>Unknown</td>
      <td>76</td>
      <td>POINT (1841755.238 707939.225)</td>
    </tr>
  </tbody>
</table>
</div></div><img alt="../_images/e_extraction_21_4.png" src="../_images/e_extraction_21_4.png" />
</div>
</div>
</div>
<div class="section" id="method-2-geodataframe">
<h4>Method 2 - GeoDataFrame<a class="headerlink" href="#method-2-geodataframe" title="Permalink to this headline">#</a></h4>
<p>If we’re trying to select features that have a specified spatial relationship with another <code class="docutils literal notranslate"><span class="pre">geopandas</span></code> object, it gets a little tricky. This is because the <code class="docutils literal notranslate"><span class="pre">geopandas</span></code> spatial relationship functions verify the spatial relationship either row by row or index by index. In other words, the first row in the first dataset will be compared with the corresponding row or index in the second dataset, the second row in the first dataset will be compared with the corresponding row or index in the second dataset, and so on. <a class="footnote-reference brackets" href="#gpd-within" id="id6">6</a>, <a class="footnote-reference brackets" href="#gpd-data" id="id7">7</a></p>
<p>As a result, the number of rows need to correspond or the indices numbers need to match between the two datasets–or else we’ll get a warning and the output will be empty.</p>
<p>Because each record in a GeoDataFrame has a geometry column that stores that record’s geometry as a <code class="docutils literal notranslate"><span class="pre">shapely</span></code> object, we can call this object if we want to check a bunch of features against one extent (with one geometry). <a class="footnote-reference brackets" href="#gpd-within" id="id8">6</a>, <a class="footnote-reference brackets" href="#gpd-data" id="id9">7</a></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Select the Santa Clara County boundary</span>
<span class="n">sc_county</span> <span class="o">=</span> <span class="n">counties</span><span class="p">[</span><span class="n">counties</span><span class="p">[</span><span class="s2">&quot;coname&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Santa Clara County&quot;</span><span class="p">]</span>

<span class="c1"># Subset the GeoDataFrame by checking which wells are within Santa Clara County&#39;s Shapely object</span>
<span class="n">wells_within_sc_shapely</span> <span class="o">=</span> <span class="n">wells</span><span class="p">[</span><span class="n">wells</span><span class="o">.</span><span class="n">within</span><span class="p">(</span><span class="n">sc_county</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>

<span class="c1"># Display first two and last two rows of attribute table</span>
<span class="n">display_table</span><span class="p">(</span><span class="n">table_name</span> <span class="o">=</span> <span class="s2">&quot;San Francisco Bay Area Wells within Santa Clara County&quot;</span><span class="p">,</span> <span class="n">attribute_table</span> <span class="o">=</span> <span class="n">wells_within_sc_shapely</span><span class="p">)</span>

<span class="c1"># Plot selection</span>
<span class="n">plot_df</span><span class="p">(</span><span class="n">result_name</span> <span class="o">=</span> <span class="s2">&quot;San Francisco Bay Area Wells within Santa Clara County&quot;</span><span class="p">,</span> <span class="n">result_df</span> <span class="o">=</span> <span class="n">wells_within_sc_shapely</span><span class="p">,</span> <span class="n">result_geom_type</span> <span class="o">=</span> <span class="s2">&quot;point&quot;</span><span class="p">,</span> <span class="n">area</span> <span class="o">=</span> <span class="n">sc_county</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Attribute Table: San Francisco Bay Area Wells within Santa Clara County

Table shape (rows, columns): (136, 5)

First two rows:
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>WELL_NAME</th>
      <th>WELL_USE</th>
      <th>WELL_TYPE</th>
      <th>WELL_DEPTH</th>
      <th>geometry</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>980</th>
      <td>CalFire Pacheco No 2</td>
      <td>Residential</td>
      <td>Single Well</td>
      <td>0</td>
      <td>POINT (1924674.853 557296.117)</td>
    </tr>
    <tr>
      <th>1020</th>
      <td>05S02W35R002</td>
      <td>Observation</td>
      <td>Part of a nested/multi-completion well</td>
      <td>80</td>
      <td>POINT (1863211.218 606236.916)</td>
    </tr>
  </tbody>
</table>
</div></div><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Last two rows:
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>WELL_NAME</th>
      <th>WELL_USE</th>
      <th>WELL_TYPE</th>
      <th>WELL_DEPTH</th>
      <th>geometry</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>5962</th>
      <td>07S01W25L001</td>
      <td>Observation</td>
      <td>Single Well</td>
      <td>404</td>
      <td>POINT (1873814.137 589052.339)</td>
    </tr>
    <tr>
      <th>6036</th>
      <td>06S02W34B006</td>
      <td>Observation</td>
      <td>Single Well</td>
      <td>152</td>
      <td>POINT (1861394.207 597916.983)</td>
    </tr>
  </tbody>
</table>
</div></div><img alt="../_images/e_extraction_23_4.png" src="../_images/e_extraction_23_4.png" />
</div>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>If we are interested in wells that fall within two or more counties (i.e., we have multiple records that will be used for selection), we can enclose the above code in a <code class="docutils literal notranslate"><span class="pre">for</span></code> loop.</p>
</div>
<hr class="footnotes docutils" />
<dl class="footnote brackets">
<dt class="label" id="gpd-clip"><span class="brackets"><a class="fn-backref" href="#id1">1</a></span></dt>
<dd><p><a class="reference external" href="https://geopandas.org/gallery/plot_clip.html">Clip Vector Data with GeoPandas, GeoPandas</a></p>
</dd>
<dt class="label" id="gpd-select"><span class="brackets"><a class="fn-backref" href="#id2">2</a></span></dt>
<dd><p><a class="reference external" href="https://geopandas.org/docs/user_guide/indexing.html">Indexing and Selecting Data, GeoPandas</a></p>
</dd>
<dt class="label" id="pd-select"><span class="brackets"><a class="fn-backref" href="#id3">3</a></span></dt>
<dd><p><a class="reference external" href="https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html">Indexing and selecting data, pandas</a></p>
</dd>
<dt class="label" id="pd-subset"><span class="brackets"><a class="fn-backref" href="#id4">4</a></span></dt>
<dd><p><a class="reference external" href="https://pandas.pydata.org/pandas-docs/stable/getting_started/intro_tutorials/03_subset_data.html">How do I select a subset of a DataFrame?, pandas</a></p>
</dd>
<dt class="label" id="gpd-binary"><span class="brackets"><a class="fn-backref" href="#id5">5</a></span></dt>
<dd><p><a class="reference external" href="https://geopandas.org/docs/reference/geoseries.html#binary-predicates">GeoSeries - Binary Predicates, GeoPandas</a></p>
</dd>
<dt class="label" id="gpd-within"><span class="brackets">6</span><span class="fn-backref">(<a href="#id6">1</a>,<a href="#id8">2</a>)</span></dt>
<dd><p><a class="reference external" href="https://geopandas.org/docs/reference/api/geopandas.GeoSeries.within.html">geopandas.GeoSeries.within, GeoPandas</a></p>
</dd>
<dt class="label" id="gpd-data"><span class="brackets">7</span><span class="fn-backref">(<a href="#id7">1</a>,<a href="#id9">2</a>)</span></dt>
<dd><p><a class="reference external" href="https://geopandas.org/docs/user_guide/data_structures.html">Data Structures, GeoPandas</a></p>
</dd>
</dl>
</div>
</div>
</div>
<span id="document-docs/e_vector_overlay"></span><hr class="docutils" />
<div class="admonition-learning-objectives admonition">
<p class="admonition-title">Learning Objectives</p>
<ul class="simple">
<li><p>Utilize different vector overlays and understand the differences between each</p></li>
<li><p>Join data based on their geographic location and explore the different join types</p></li>
</ul>
</div>
<div class="admonition-review admonition">
<p class="admonition-title">Review</p>
<ul class="simple">
<li><p><a class="reference internal" href="docs/a_intro.html#document-docs/c_vectors"><span class="doc std std-doc">Spatial Vector Data</span></a></p></li>
<li><p><a class="reference internal" href="docs/a_intro.html#document-docs/e_attributes"><span class="doc std std-doc">Attributes &amp; Indexing for Vector Data</span></a></p></li>
<li><p><a class="reference internal" href="docs/a_intro.html#document-docs/c_new_vectors"><span class="doc std std-doc">Creating Spatial Vector Data</span></a></p></li>
</ul>
</div>
<hr class="docutils" />
<div class="tex2jax_ignore mathjax_ignore section" id="spatial-overlays-and-joins">
<h2>Spatial Overlays and Joins<a class="headerlink" href="#spatial-overlays-and-joins" title="Permalink to this headline">#</a></h2>
<p>Combining two or more datasets together is a fundamental aspect of GIS. Using <code class="docutils literal notranslate"><span class="pre">geopandas</span></code>, we can create new geometries from existing datasets by overlaying them on top of each other, identifying where they do and do not overlap, and deciding what parts we want to extract from these overlays. For each of these new shapes, the attribute data from the existing constituent datasets are also combined together. <a class="footnote-reference brackets" href="#gpd-set" id="id1">1</a>, <a class="footnote-reference brackets" href="#bolstad" id="id2">2</a></p>
<p>In this chapter, we will focus on vector overlays, which involve combining vector data. We’ll explore five types of vector overlays and merging: union, intersection, difference (erase), identity, and spatial join.</p>
<div class="section" id="setup">
<h3>Setup<a class="headerlink" href="#setup" title="Permalink to this headline">#</a></h3>
<p>First, let’s import the necessary modules (click the + below to show code cell).</p>
<div class="cell tag_hide-cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Import modules</span>
<span class="kn">import</span> <span class="nn">geopandas</span> <span class="k">as</span> <span class="nn">gpd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
</pre></div>
</div>
</div>
</div>
<p>To illustrate these geoprocessing tools, we will utilize shapefiles of San Francisco Bay Area county boundaries, Bay Area watershed boundaries, and wells within the Bay Area and the surrounding 50 km. We will load in the data and reproject the data (click the + below to show code cell).</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>All the data must have the same coordinate system in order for extraction to work correctly.</p>
</div>
<div class="cell tag_hide-cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Load data</span>

<span class="c1"># County boundaries</span>
<span class="c1"># Source: https://opendata.mtc.ca.gov/datasets/san-francisco-bay-region-counties-clipped?geometry=-125.590%2C37.123%2C-119.152%2C38.640</span>
<span class="n">counties</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="s2">&quot;../_static/e_vector_shapefiles/sf_bay_counties/sf_bay_counties.shp&quot;</span><span class="p">)</span>

<span class="c1"># Watershed boundaries</span>
<span class="c1"># Source: https://gis.data.ca.gov/datasets/CDFW::epa-surf-your-watershed-ds732?geometry=-128.711%2C36.474%2C-115.835%2C39.504</span>
<span class="c1"># Modified by author so that only the watersheds with centroids in the Bay Area counties were kept</span>
<span class="n">watersheds</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="s2">&quot;../_static/e_vector_shapefiles/sf_bay_watersheds/sf_bay_watersheds.shp&quot;</span><span class="p">)</span>

<span class="c1"># Well locations</span>
<span class="c1"># Source: https://gis.data.ca.gov/datasets/3a3e681b894644a9a95f9815aeeeb57f_0?geometry=-123.143%2C36.405%2C-119.230%2C37.175</span>
<span class="c1"># Modified by author so that only the well locations within the counties and the surrounding 50 km were kept</span>
<span class="n">wells</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="s2">&quot;../_static/e_vector_shapefiles/sf_bay_wells_50km/sf_bay_wells_50km.shp&quot;</span><span class="p">)</span>

<span class="c1"># Reproject data to NAD83(HARN) / California Zone 3</span>
<span class="c1"># https://spatialreference.org/ref/epsg/2768/</span>
<span class="n">proj</span> <span class="o">=</span> <span class="mi">2768</span>
<span class="n">counties</span> <span class="o">=</span> <span class="n">counties</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">proj</span><span class="p">)</span>
<span class="n">watersheds</span> <span class="o">=</span> <span class="n">watersheds</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">proj</span><span class="p">)</span>
<span class="n">wells</span> <span class="o">=</span> <span class="n">wells</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">proj</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We’ll define some functions to make displaying and mapping our results a bit easier (click the + below to show code cell).</p>
<div class="cell tag_hide-cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">display_table</span><span class="p">(</span><span class="n">table_name</span><span class="p">,</span> <span class="n">attribute_table</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Display the first and last two rows of attribute table.&#39;&#39;&#39;</span>

    <span class="c1"># Print title</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Attribute Table: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">table_name</span><span class="p">))</span>

    <span class="c1"># Print number of rows and columns</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Table shape (rows, columns): </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">attribute_table</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>

    <span class="c1"># Display first two rows of attribute table</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">First two rows:&quot;</span><span class="p">)</span>
    <span class="n">display</span><span class="p">(</span><span class="n">attribute_table</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>

    <span class="c1"># Display last two rows of attribute table</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Last two rows:&quot;</span><span class="p">)</span>
    <span class="n">display</span><span class="p">(</span><span class="n">attribute_table</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">plot_overlay</span><span class="p">(</span><span class="n">overlay_type</span><span class="p">,</span> <span class="n">overlay_result</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Plot the overlay result on a map and add the outlines of the original shapefiles on top.&#39;&#39;&#39;</span>

    <span class="c1"># Create subplots</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

    <span class="c1"># Plot overlay data</span>
    <span class="n">overlay_result</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;Set2&#39;</span><span class="p">,</span> <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;black&#39;</span><span class="p">)</span>

    <span class="c1"># Plot outlines of original shapefiles</span>
    <span class="n">counties</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;dimgray&#39;</span><span class="p">)</span>
    <span class="n">watersheds</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;dodgerblue&#39;</span><span class="p">)</span>

    <span class="c1"># Stylize plots</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;bmh&#39;</span><span class="p">)</span>

    <span class="c1"># Set title</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;San Francisco Bay Area County and Watershed Boundaries</span><span class="se">\n</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">overlay_type</span><span class="p">),</span> <span class="n">fontdict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;fontsize&#39;</span><span class="p">:</span> <span class="s1">&#39;15&#39;</span><span class="p">,</span> <span class="s1">&#39;fontweight&#39;</span> <span class="p">:</span> <span class="s1">&#39;3&#39;</span><span class="p">})</span>


<span class="k">def</span> <span class="nf">plot_merge</span><span class="p">(</span><span class="n">merge_type</span><span class="p">,</span> <span class="n">merge_result</span><span class="p">,</span> <span class="n">merge_vector</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Plot the merge result on a map.&#39;&#39;&#39;</span>

    <span class="c1"># Create subplots</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

    <span class="c1"># Plot data depending on vector type</span>
    <span class="c1"># For points</span>
    <span class="k">if</span> <span class="n">merge_vector</span> <span class="o">==</span> <span class="s2">&quot;point&quot;</span><span class="p">:</span>

        <span class="c1"># Plot data</span>
        <span class="n">counties</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;dimgray&#39;</span><span class="p">)</span>
        <span class="n">merge_result</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span> <span class="n">marker</span> <span class="o">=</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;dodgerblue&#39;</span><span class="p">,</span> <span class="n">markersize</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span>

    <span class="c1"># For polygons</span>
    <span class="k">else</span><span class="p">:</span>

        <span class="c1"># Plot data</span>
        <span class="n">merge_result</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;Set2&#39;</span><span class="p">,</span> <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;black&#39;</span><span class="p">)</span>

    <span class="c1"># Stylize plots</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;bmh&#39;</span><span class="p">)</span>

    <span class="c1"># Set title</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;San Francisco Bay Area County Boundaries and Well Locations</span><span class="se">\n</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">merge_type</span><span class="p">),</span> <span class="n">fontdict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;fontsize&#39;</span><span class="p">:</span> <span class="s1">&#39;15&#39;</span><span class="p">,</span> <span class="s1">&#39;fontweight&#39;</span> <span class="p">:</span> <span class="s1">&#39;3&#39;</span><span class="p">})</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="overlays">
<h3>Overlays<a class="headerlink" href="#overlays" title="Permalink to this headline">#</a></h3>
<p>For the first four, we can use the <code class="docutils literal notranslate"><span class="pre">overlay</span></code> function in <code class="docutils literal notranslate"><span class="pre">geopandas</span></code>. We simply change the argument for the <code class="docutils literal notranslate"><span class="pre">how</span></code> parameter to the overlay of our choosing.</p>
<p>We will use the county boundaries and watershed boundaries shapefiles in these examples. The overlays will allow us to see what areas are only in a county, only in a watershed, or in both.</p>
<p>Let’s briefly examine the attribute table of our shapefiles and plot the data so that we know what we’re working with.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create subplots</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

<span class="c1"># Plot data</span>
<span class="n">counties</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;bisque&#39;</span><span class="p">,</span> <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;dimgray&#39;</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.75</span><span class="p">)</span>
<span class="n">watersheds</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;lightskyblue&#39;</span><span class="p">,</span> <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;dodgerblue&#39;</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.55</span><span class="p">)</span>

<span class="c1"># Stylize plots</span>
<span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;bmh&#39;</span><span class="p">)</span>

<span class="c1"># Set title</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;San Francisco Bay Area County and Watershed Boundaries&#39;</span><span class="p">,</span> <span class="n">fontdict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;fontsize&#39;</span><span class="p">:</span> <span class="s1">&#39;15&#39;</span><span class="p">,</span> <span class="s1">&#39;fontweight&#39;</span> <span class="p">:</span> <span class="s1">&#39;3&#39;</span><span class="p">})</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0.5, 1.0, &#39;San Francisco Bay Area County and Watershed Boundaries&#39;)
</pre></div>
</div>
<img alt="../_images/e_vector_overlay_7_1.png" src="../_images/e_vector_overlay_7_1.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Print attribute table</span>
<span class="n">display</span><span class="p">(</span><span class="n">counties</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>coname</th>
      <th>geometry</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Alameda County</td>
      <td>MULTIPOLYGON (((1860234.837 612219.122, 186007...</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Contra Costa County</td>
      <td>MULTIPOLYGON (((1836501.066 656512.837, 183649...</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Marin County</td>
      <td>MULTIPOLYGON (((1830493.060 653832.167, 183050...</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Napa County</td>
      <td>POLYGON ((1860171.549 724651.231, 1860170.736 ...</td>
    </tr>
    <tr>
      <th>4</th>
      <td>San Francisco County</td>
      <td>MULTIPOLYGON (((1779231.793 635380.766, 177918...</td>
    </tr>
    <tr>
      <th>5</th>
      <td>San Mateo County</td>
      <td>MULTIPOLYGON (((1836712.268 569216.860, 183671...</td>
    </tr>
    <tr>
      <th>6</th>
      <td>Santa Clara County</td>
      <td>MULTIPOLYGON (((1858733.082 607586.450, 185874...</td>
    </tr>
    <tr>
      <th>7</th>
      <td>Solano County</td>
      <td>MULTIPOLYGON (((1875491.908 673077.900, 187549...</td>
    </tr>
    <tr>
      <th>8</th>
      <td>Sonoma County</td>
      <td>MULTIPOLYGON (((1746855.532 743026.706, 174685...</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Print attribute table</span>
<span class="n">display</span><span class="p">(</span><span class="n">watersheds</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>CUNAME</th>
      <th>geometry</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>RUSSIAN</td>
      <td>POLYGON ((1772952.612 823099.656, 1775209.737 ...</td>
    </tr>
    <tr>
      <th>1</th>
      <td>UPPER_PUTAH</td>
      <td>POLYGON ((1825517.283 769282.042, 1826065.366 ...</td>
    </tr>
    <tr>
      <th>2</th>
      <td>GUALALA-SALMON</td>
      <td>POLYGON ((1747656.800 769294.908, 1748144.659 ...</td>
    </tr>
    <tr>
      <th>3</th>
      <td>SAN_PABLO_BAY</td>
      <td>POLYGON ((1815758.957 741414.318, 1816340.883 ...</td>
    </tr>
    <tr>
      <th>4</th>
      <td>BODEGA_BAY</td>
      <td>POLYGON ((1778048.116 714367.855, 1780284.096 ...</td>
    </tr>
    <tr>
      <th>5</th>
      <td>TOMALES-DRAKE_BAYS</td>
      <td>POLYGON ((1783925.368 698933.179, 1784977.305 ...</td>
    </tr>
    <tr>
      <th>6</th>
      <td>SAN_FRANCISCO_BAY</td>
      <td>POLYGON ((1856614.017 653898.716, 1856857.793 ...</td>
    </tr>
    <tr>
      <th>7</th>
      <td>SAN_FRANCISCO_COASTAL_SOUTH</td>
      <td>POLYGON ((1826732.900 640369.438, 1827321.624 ...</td>
    </tr>
    <tr>
      <th>8</th>
      <td>COYOTE</td>
      <td>POLYGON ((1875229.662 619208.108, 1875664.986 ...</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="section" id="union">
<h4>Union<a class="headerlink" href="#union" title="Permalink to this headline">#</a></h4>
<p>With <code class="docutils literal notranslate"><span class="pre">how='union'</span></code>, all data (all geometries regardless of overlap) is kept. <a class="footnote-reference brackets" href="#gpd-set" id="id3">1</a></p>
<div class="figure align-default" id="union-of-all-geometries-keeps-all-data">
<img alt="../_images/vector_union.jpg" src="../_images/vector_union.jpg" />
<p class="caption"><span class="caption-number">Fig. 39 </span><span class="caption-text">Union keeps all the data. In the figure above, all of A and B are kept.</span><a class="headerlink" href="#union-of-all-geometries-keeps-all-data" title="Permalink to this image">#</a></p>
</div>
<p>Looking at the attribute table, we see that the attributes from both individual datasets have been combined. The areas that are unique to one dataset (no overlap) have <code class="docutils literal notranslate"><span class="pre">NaN</span></code> as values in the fields that originated from the other dataset. <a class="footnote-reference brackets" href="#gpd-set" id="id4">1</a>, <a class="footnote-reference brackets" href="#bolstad" id="id5">2</a></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get union</span>
<span class="n">union_result</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">overlay</span><span class="p">(</span><span class="n">counties</span><span class="p">,</span> <span class="n">watersheds</span><span class="p">,</span> <span class="n">how</span> <span class="o">=</span> <span class="s1">&#39;union&#39;</span><span class="p">)</span>

<span class="c1"># Print head and tail of attribute table</span>
<span class="n">display_table</span><span class="p">(</span><span class="n">table_name</span> <span class="o">=</span> <span class="s2">&quot;Union&quot;</span><span class="p">,</span> <span class="n">attribute_table</span> <span class="o">=</span> <span class="n">union_result</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Attribute Table: Union

Table shape (rows, columns): (46, 3)

First two rows:
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>coname</th>
      <th>CUNAME</th>
      <th>geometry</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Alameda County</td>
      <td>SAN_PABLO_BAY</td>
      <td>POLYGON ((1844308.600 657338.949, 1844333.772 ...</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Contra Costa County</td>
      <td>SAN_PABLO_BAY</td>
      <td>MULTIPOLYGON (((1850770.778 650276.858, 185076...</td>
    </tr>
  </tbody>
</table>
</div></div><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Last two rows:
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>coname</th>
      <th>CUNAME</th>
      <th>geometry</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>44</th>
      <td>None</td>
      <td>SAN_FRANCISCO_COASTAL_SOUTH</td>
      <td>MULTIPOLYGON (((1853276.563 580696.796, 185327...</td>
    </tr>
    <tr>
      <th>45</th>
      <td>None</td>
      <td>COYOTE</td>
      <td>MULTIPOLYGON (((1880333.343 567100.327, 188026...</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Next, we can map the data, filling in the areas with color that have been retained. As the plot shows, no data was removed.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot overlay</span>
<span class="n">plot_overlay</span><span class="p">(</span><span class="n">overlay_type</span> <span class="o">=</span> <span class="s2">&quot;Union&quot;</span><span class="p">,</span> <span class="n">overlay_result</span> <span class="o">=</span> <span class="n">union_result</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/e_vector_overlay_13_0.png" src="../_images/e_vector_overlay_13_0.png" />
</div>
</div>
</div>
<div class="section" id="intersection">
<h4>Intersection<a class="headerlink" href="#intersection" title="Permalink to this headline">#</a></h4>
<p>With <code class="docutils literal notranslate"><span class="pre">how='intersection'</span></code>, only the areas where all datasets contain data (have geometries) are combined together. <a class="footnote-reference brackets" href="#gpd-set" id="id6">1</a></p>
<div class="figure align-default" id="intersection-of-geometries-keeps-overlapping-geometries">
<img alt="../_images/vector_intersection.jpg" src="../_images/vector_intersection.jpg" />
<p class="caption"><span class="caption-number">Fig. 40 </span><span class="caption-text">Intersection keeps the geometries that overlap with each other. In the figure above, only the portion where A and B overlap is kept.</span><a class="headerlink" href="#intersection-of-geometries-keeps-overlapping-geometries" title="Permalink to this image">#</a></p>
</div>
<p>Because there are no areas unique to one dataset, notice how the attribute table of the combined dataset does not have any <code class="docutils literal notranslate"><span class="pre">NaN</span></code> values. When mapping the intersection overlay, we can see that any areas that did not have any overlay were discarded (areas with an outline but no fill). Areas covered by the county and watershed boundaries datasets are kept (shown in color). <a class="footnote-reference brackets" href="#gpd-set" id="id7">1</a>, <a class="footnote-reference brackets" href="#bolstad" id="id8">2</a></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get intersection</span>
<span class="n">intersection_result</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">overlay</span><span class="p">(</span><span class="n">counties</span><span class="p">,</span> <span class="n">watersheds</span><span class="p">,</span> <span class="n">how</span> <span class="o">=</span> <span class="s1">&#39;intersection&#39;</span><span class="p">)</span>

<span class="c1"># Print head and tail of attribute table</span>
<span class="n">display_table</span><span class="p">(</span><span class="n">table_name</span> <span class="o">=</span> <span class="s2">&quot;Intersection&quot;</span><span class="p">,</span> <span class="n">attribute_table</span> <span class="o">=</span> <span class="n">intersection_result</span><span class="p">)</span>

<span class="c1"># Plot overlay</span>
<span class="n">plot_overlay</span><span class="p">(</span><span class="n">overlay_type</span> <span class="o">=</span> <span class="s2">&quot;Intersection&quot;</span><span class="p">,</span> <span class="n">overlay_result</span> <span class="o">=</span> <span class="n">intersection_result</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Attribute Table: Intersection

Table shape (rows, columns): (28, 3)

First two rows:
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>coname</th>
      <th>CUNAME</th>
      <th>geometry</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Alameda County</td>
      <td>SAN_PABLO_BAY</td>
      <td>POLYGON ((1844308.600 657338.949, 1844333.772 ...</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Contra Costa County</td>
      <td>SAN_PABLO_BAY</td>
      <td>MULTIPOLYGON (((1850770.778 650276.858, 185076...</td>
    </tr>
  </tbody>
</table>
</div></div><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Last two rows:
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>coname</th>
      <th>CUNAME</th>
      <th>geometry</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>26</th>
      <td>Santa Clara County</td>
      <td>SAN_FRANCISCO_COASTAL_SOUTH</td>
      <td>MULTIPOLYGON (((1855641.060 585520.902, 185560...</td>
    </tr>
    <tr>
      <th>27</th>
      <td>Sonoma County</td>
      <td>GUALALA-SALMON</td>
      <td>MULTIPOLYGON (((1770306.496 719948.583, 177028...</td>
    </tr>
  </tbody>
</table>
</div></div><img alt="../_images/e_vector_overlay_15_4.png" src="../_images/e_vector_overlay_15_4.png" />
</div>
</div>
</div>
<div class="section" id="identity">
<h4>Identity<a class="headerlink" href="#identity" title="Permalink to this headline">#</a></h4>
<p>With <code class="docutils literal notranslate"><span class="pre">how='identity'</span></code>, data from both layers are combined, but only the geometries that are unique to the first dataset or are covered by both datasets are kept. Any geometries unique to the second dataset (no overlapping with the first dataset) are discarded. <a class="footnote-reference brackets" href="#gpd-set" id="id9">1</a></p>
<div class="figure align-default" id="identity-of-the-geometries-keeps-the-geometries-covered-by-the-first-dataset-or-both-datasets">
<img alt="../_images/vector_identity.jpg" src="../_images/vector_identity.jpg" />
<p class="caption"><span class="caption-number">Fig. 41 </span><span class="caption-text">Identity keeps the geometries of the first dataset. Any intersecting geometries from the second dataset are also combined and included. In the figure, all of A and the portion of B that intersects A are kept.</span><a class="headerlink" href="#identity-of-the-geometries-keeps-the-geometries-covered-by-the-first-dataset-or-both-datasets" title="Permalink to this image">#</a></p>
</div>
<p>Looking at the attribute table, the fields from the individual datasets have been combined. For those geometries unique to the first dataset, the fields that came from the second dataset have <code class="docutils literal notranslate"><span class="pre">NaN</span></code> as values.</p>
<p>Looking at the map, we see all combined geometries except for the areas that are unique to the second dataset (watershed boundaries dataset).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get identity</span>
<span class="n">identity_result</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">overlay</span><span class="p">(</span><span class="n">counties</span><span class="p">,</span> <span class="n">watersheds</span><span class="p">,</span> <span class="n">how</span> <span class="o">=</span> <span class="s1">&#39;identity&#39;</span><span class="p">)</span>

<span class="c1"># Print head and tail of attribute table</span>
<span class="n">display_table</span><span class="p">(</span><span class="n">table_name</span> <span class="o">=</span> <span class="s2">&quot;Identity&quot;</span><span class="p">,</span> <span class="n">attribute_table</span> <span class="o">=</span> <span class="n">identity_result</span><span class="p">)</span>

<span class="c1"># Plot overlay</span>
<span class="n">plot_overlay</span><span class="p">(</span><span class="n">overlay_type</span> <span class="o">=</span> <span class="s2">&quot;Identity&quot;</span><span class="p">,</span> <span class="n">overlay_result</span> <span class="o">=</span> <span class="n">identity_result</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Attribute Table: Identity

Table shape (rows, columns): (37, 3)

First two rows:
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>coname</th>
      <th>CUNAME</th>
      <th>geometry</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Alameda County</td>
      <td>SAN_PABLO_BAY</td>
      <td>POLYGON ((1844308.600 657338.949, 1844333.772 ...</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Contra Costa County</td>
      <td>SAN_PABLO_BAY</td>
      <td>MULTIPOLYGON (((1850770.778 650276.858, 185076...</td>
    </tr>
  </tbody>
</table>
</div></div><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Last two rows:
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>coname</th>
      <th>CUNAME</th>
      <th>geometry</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>35</th>
      <td>Solano County</td>
      <td>None</td>
      <td>MULTIPOLYGON (((1893901.284 678662.321, 189390...</td>
    </tr>
    <tr>
      <th>36</th>
      <td>Sonoma County</td>
      <td>None</td>
      <td>MULTIPOLYGON (((1804439.333 758178.073, 180446...</td>
    </tr>
  </tbody>
</table>
</div></div><img alt="../_images/e_vector_overlay_17_4.png" src="../_images/e_vector_overlay_17_4.png" />
</div>
</div>
</div>
<div class="section" id="difference-erase">
<h4>Difference (Erase)<a class="headerlink" href="#difference-erase" title="Permalink to this headline">#</a></h4>
<p>With <code class="docutils literal notranslate"><span class="pre">how='difference'</span></code>, the areas covered by the second dataset is used to “cut out” or erase those corresponding areas in the first dataset. In other words, only the areas in the first dataset that do not overlap with the second dataset are kept. <a class="footnote-reference brackets" href="#gpd-set" id="id10">1</a>, <a class="footnote-reference brackets" href="#bolstad" id="id11">2</a></p>
<div class="figure align-default" id="difference-or-erase-removes-the-geometries-of-the-first-dataset-from-the-second-dataset">
<img alt="../_images/vector_erase.jpg" src="../_images/vector_erase.jpg" />
<p class="caption"><span class="caption-number">Fig. 42 </span><span class="caption-text">Difference (erase) removes geometries that intersect with each other. In the figure above, B is used to cut out and remove a portion of A.</span><a class="headerlink" href="#difference-or-erase-removes-the-geometries-of-the-first-dataset-from-the-second-dataset" title="Permalink to this image">#</a></p>
</div>
<p>Looking at the attribute table, the fields from the second dataset do not appear in the combined dataset. The second dataset was “combined” with the first dataset by discarding some data (altering the geometry) from the first dataset.</p>
<p>Looking at the map, we only see areas of the first dataset (county dataset) that are not covered by the second dataset (watershed boundaries dataset).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get difference</span>
<span class="n">difference_result</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">overlay</span><span class="p">(</span><span class="n">counties</span><span class="p">,</span> <span class="n">watersheds</span><span class="p">,</span> <span class="n">how</span> <span class="o">=</span> <span class="s1">&#39;difference&#39;</span><span class="p">)</span>

<span class="c1"># Print head and tail of attribute table</span>
<span class="n">display_table</span><span class="p">(</span><span class="n">table_name</span> <span class="o">=</span> <span class="s2">&quot;Difference&quot;</span><span class="p">,</span> <span class="n">attribute_table</span> <span class="o">=</span> <span class="n">difference_result</span><span class="p">)</span>

<span class="c1"># Plot overlay</span>
<span class="n">plot_overlay</span><span class="p">(</span><span class="n">overlay_type</span> <span class="o">=</span> <span class="s2">&quot;Difference&quot;</span><span class="p">,</span> <span class="n">overlay_result</span> <span class="o">=</span> <span class="n">difference_result</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Attribute Table: Difference

Table shape (rows, columns): (9, 2)

First two rows:
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>coname</th>
      <th>geometry</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Alameda County</td>
      <td>MULTIPOLYGON (((1913747.025 610819.209, 191379...</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Contra Costa County</td>
      <td>MULTIPOLYGON (((1866870.506 674116.607, 186699...</td>
    </tr>
  </tbody>
</table>
</div></div><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Last two rows:
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>coname</th>
      <th>geometry</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>7</th>
      <td>Solano County</td>
      <td>MULTIPOLYGON (((1879629.756 727080.818, 187969...</td>
    </tr>
    <tr>
      <th>8</th>
      <td>Sonoma County</td>
      <td>MULTIPOLYGON (((1804439.333 758178.073, 180446...</td>
    </tr>
  </tbody>
</table>
</div></div><img alt="../_images/e_vector_overlay_19_4.png" src="../_images/e_vector_overlay_19_4.png" />
</div>
</div>
</div>
</div>
<div class="section" id="merge">
<h3>Merge<a class="headerlink" href="#merge" title="Permalink to this headline">#</a></h3>
<div class="section" id="spatial-join">
<h4>Spatial Join<a class="headerlink" href="#spatial-join" title="Permalink to this headline">#</a></h4>
<p>With spatial join, attributes from one dataset are appended to those in another dataset based on a specified relative spatial relationship. <a class="footnote-reference brackets" href="#gpd-merge" id="id12">3</a>, <a class="footnote-reference brackets" href="#esri-join" id="id13">4</a></p>
<p>In <code class="docutils literal notranslate"><span class="pre">geopandas</span></code>, we use the <code class="docutils literal notranslate"><span class="pre">sjoin()</span></code> function. In addition to passing the datasets as arguments, and we also pass arguments for two parameters <code class="docutils literal notranslate"><span class="pre">op</span></code> and <code class="docutils literal notranslate"><span class="pre">how</span></code>. The <code class="docutils literal notranslate"><span class="pre">op</span></code> parameter specifies the spatial relationship needed in order for the attributes of one feature to be joined to another. <a class="footnote-reference brackets" href="#gpd-merge" id="id14">3</a></p>
<p>The following spatial relationships are available in <code class="docutils literal notranslate"><span class="pre">geopandas</span></code>:</p>
<table class="colwidths-auto docutils align-default">
<thead>
<tr class="row-odd"><th class="text-align:left head"><p>Spatial Relationship</p></th>
<th class="text-align:right head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td class="text-align:left"><p><code class="docutils literal notranslate"><span class="pre">contains</span></code></p></td>
<td class="text-align:right"><p>geometry’s points are not to the exterior of the other geometry, provided that the geometry’s interior contains at least one point of the other geometry’s interior</p></td>
</tr>
<tr class="row-odd"><td class="text-align:left"><p><code class="docutils literal notranslate"><span class="pre">crosses</span></code></p></td>
<td class="text-align:right"><p>geometry’s interior intersects that of the other geometry, provided that the geometry does not contain the other and the dimension of the intersection is less than the dimension of either geometry</p></td>
</tr>
<tr class="row-even"><td class="text-align:left"><p><code class="docutils literal notranslate"><span class="pre">intersects</span></code></p></td>
<td class="text-align:right"><p>geometry’s boundary or interior touches or crosses any part of the other geometry</p></td>
</tr>
<tr class="row-odd"><td class="text-align:left"><p><code class="docutils literal notranslate"><span class="pre">overlaps</span></code></p></td>
<td class="text-align:right"><p>geometry shares at least one point, but not all points, with the other geometry, provided that the geometries and the intersection of their interiors all have the same dimensions</p></td>
</tr>
<tr class="row-even"><td class="text-align:left"><p><code class="docutils literal notranslate"><span class="pre">touches</span></code></p></td>
<td class="text-align:right"><p>geometry shares at least one point with the other geometry, provided that no part of the geometry’s interior intersects with the other geometry</p></td>
</tr>
<tr class="row-odd"><td class="text-align:left"><p><code class="docutils literal notranslate"><span class="pre">within</span></code></p></td>
<td class="text-align:right"><p>geometry is enclosed in the other geometry (geometry’s boundary and interior intersects with the other geometry’s interior only)</p></td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>These relationships are defined from the first dataset to the second dataset (for example, <code class="docutils literal notranslate"><span class="pre">contains</span></code> specifies that a feature from the first dataset must contain a feature from the second dataset for a join to occur).</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Depending on the argument specified in the <code class="docutils literal notranslate"><span class="pre">op</span></code> parameter, a geometry that falls directly on the boundary of another geometry may be counted, may be counted twice, or may not be counted at all. For example, if a point falls on a boundary between two geometries, <code class="docutils literal notranslate"><span class="pre">op</span> <span class="pre">=</span> <span class="pre">&quot;intersects&quot;</span></code> will count that point twice and allocate (join) it to both geometries that share the boundary, whereas <code class="docutils literal notranslate"><span class="pre">op</span> <span class="pre">=</span> <span class="pre">&quot;within&quot;</span></code> will not count or allocate the point at all.</p>
</div>
<p>Just like regular table joins, there are multiple types of spatial joins, which determine which features from both datasets are kept in the output dataset. This is specified using the <code class="docutils literal notranslate"><span class="pre">how</span></code> parameter. <a class="footnote-reference brackets" href="#gpd-merge" id="id15">3</a>, <a class="footnote-reference brackets" href="#esri-join" id="id16">4</a></p>
<table class="colwidths-auto docutils align-default">
<thead>
<tr class="row-odd"><th class="text-align:left head"><p>Join Type</p></th>
<th class="text-align:right head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td class="text-align:left"><p><code class="docutils literal notranslate"><span class="pre">left</span></code></p></td>
<td class="text-align:right"><p>all features from the first or left dataset are kept, regardless if the feature met the specified spatial relationship criteria for a join/regardless if there is a match</p></td>
</tr>
<tr class="row-odd"><td class="text-align:left"><p><code class="docutils literal notranslate"><span class="pre">right</span></code></p></td>
<td class="text-align:right"><p>all features from the second or right dataset are kept, regardless if the feature met the specified spatial relationship  for a join</p></td>
</tr>
<tr class="row-even"><td class="text-align:left"><p><code class="docutils literal notranslate"><span class="pre">inner</span></code></p></td>
<td class="text-align:right"><p>only features from both datasets that met the spatial relationship and were joined are kept; the geometries from the first or left dataset are used for the join</p></td>
</tr>
</tbody>
</table>
<p>We’ll illustrate this geoprocessing using the county boundaries shapefile and the well locations shapefile. Let’s quickly examine the wells attribute table and plot both datasets.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Print head and tail of attribute table</span>
<span class="n">display_table</span><span class="p">(</span><span class="n">table_name</span> <span class="o">=</span> <span class="s2">&quot;San Francisco Bay Area and Surrounding Area Wells&quot;</span><span class="p">,</span> <span class="n">attribute_table</span> <span class="o">=</span> <span class="n">wells</span><span class="p">)</span>

<span class="c1"># Create subplots</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

<span class="c1"># Plot data</span>
<span class="n">counties</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;bisque&#39;</span><span class="p">,</span> <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;dimgray&#39;</span><span class="p">)</span>
<span class="n">wells</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span> <span class="n">marker</span> <span class="o">=</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;dodgerblue&#39;</span><span class="p">,</span> <span class="n">markersize</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span>

<span class="c1"># Stylize plots</span>
<span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;bmh&#39;</span><span class="p">)</span>

<span class="c1"># Set title</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;San Francisco Bay Area County Boundaries and Well Locations&#39;</span><span class="p">,</span> <span class="n">fontdict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;fontsize&#39;</span><span class="p">:</span> <span class="s1">&#39;15&#39;</span><span class="p">,</span> <span class="s1">&#39;fontweight&#39;</span> <span class="p">:</span> <span class="s1">&#39;3&#39;</span><span class="p">})</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Attribute Table: San Francisco Bay Area and Surrounding Area Wells

Table shape (rows, columns): (6037, 5)

First two rows:
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>WELL_NAME</th>
      <th>WELL_USE</th>
      <th>WELL_TYPE</th>
      <th>WELL_DEPTH</th>
      <th>geometry</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2400064-001</td>
      <td>Public Supply</td>
      <td>Single Well</td>
      <td>0</td>
      <td>POINT (1968290.923 592019.918)</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2400099-001</td>
      <td>Public Supply</td>
      <td>Single Well</td>
      <td>0</td>
      <td>POINT (1969113.543 595876.691)</td>
    </tr>
  </tbody>
</table>
</div></div><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Last two rows:
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>WELL_NAME</th>
      <th>WELL_USE</th>
      <th>WELL_TYPE</th>
      <th>WELL_DEPTH</th>
      <th>geometry</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>6035</th>
      <td>None</td>
      <td>Unknown</td>
      <td>Unknown</td>
      <td>0</td>
      <td>POINT (1960933.648 610295.428)</td>
    </tr>
    <tr>
      <th>6036</th>
      <td>06S02W34B006</td>
      <td>Observation</td>
      <td>Single Well</td>
      <td>152</td>
      <td>POINT (1861394.207 597916.983)</td>
    </tr>
  </tbody>
</table>
</div></div><div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0.5, 1.0, &#39;San Francisco Bay Area County Boundaries and Well Locations&#39;)
</pre></div>
</div>
<img alt="../_images/e_vector_overlay_21_5.png" src="../_images/e_vector_overlay_21_5.png" />
</div>
</div>
<div class="section" id="left-join">
<h5>Left Join<a class="headerlink" href="#left-join" title="Permalink to this headline">#</a></h5>
<p>We’ll first demonstrate a left join. Notice that all features from the left dataset (wells dataset) are kept. The features that did not meet the spatial relationship criteria for a join have <code class="docutils literal notranslate"><span class="pre">NaN</span></code> as values for the fields that originated from the right dataset (county boundaries dataset).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get inner join</span>
<span class="n">left_join_result</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">sjoin</span><span class="p">(</span><span class="n">wells</span><span class="p">,</span> <span class="n">counties</span><span class="p">,</span> <span class="n">how</span> <span class="o">=</span> <span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="n">op</span> <span class="o">=</span> <span class="s1">&#39;within&#39;</span><span class="p">)</span>

<span class="c1"># Print head and tail of attribute table</span>
<span class="n">display_table</span><span class="p">(</span><span class="n">table_name</span> <span class="o">=</span> <span class="s2">&quot;Left Join&quot;</span><span class="p">,</span> <span class="n">attribute_table</span> <span class="o">=</span> <span class="n">left_join_result</span><span class="p">)</span>

<span class="c1"># Plot merge</span>
<span class="n">plot_merge</span><span class="p">(</span><span class="n">merge_type</span> <span class="o">=</span> <span class="s2">&quot;Left Join&quot;</span><span class="p">,</span> <span class="n">merge_result</span> <span class="o">=</span> <span class="n">left_join_result</span><span class="p">,</span> <span class="n">merge_vector</span> <span class="o">=</span> <span class="s2">&quot;point&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Attribute Table: Left Join

Table shape (rows, columns): (6037, 7)

First two rows:
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>WELL_NAME</th>
      <th>WELL_USE</th>
      <th>WELL_TYPE</th>
      <th>WELL_DEPTH</th>
      <th>geometry</th>
      <th>index_right</th>
      <th>coname</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2400064-001</td>
      <td>Public Supply</td>
      <td>Single Well</td>
      <td>0</td>
      <td>POINT (1968290.923 592019.918)</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2400099-001</td>
      <td>Public Supply</td>
      <td>Single Well</td>
      <td>0</td>
      <td>POINT (1969113.543 595876.691)</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
</div></div><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Last two rows:
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>WELL_NAME</th>
      <th>WELL_USE</th>
      <th>WELL_TYPE</th>
      <th>WELL_DEPTH</th>
      <th>geometry</th>
      <th>index_right</th>
      <th>coname</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>6035</th>
      <td>None</td>
      <td>Unknown</td>
      <td>Unknown</td>
      <td>0</td>
      <td>POINT (1960933.648 610295.428)</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>6036</th>
      <td>06S02W34B006</td>
      <td>Observation</td>
      <td>Single Well</td>
      <td>152</td>
      <td>POINT (1861394.207 597916.983)</td>
      <td>6.0</td>
      <td>Santa Clara County</td>
    </tr>
  </tbody>
</table>
</div></div><img alt="../_images/e_vector_overlay_23_4.png" src="../_images/e_vector_overlay_23_4.png" />
</div>
</div>
</div>
<div class="section" id="right-join">
<h5>Right Join<a class="headerlink" href="#right-join" title="Permalink to this headline">#</a></h5>
<p>For a right join, all features from the right dataset (county boundaries dataset) are kept but are repeated multiple times. This is because a “new” county feature is created for every well point that falls within a county’s boundary. As a result, because wells must fall within the county boundaries for a join to occur on the county boundaries feature, there are no resulting features with <code class="docutils literal notranslate"><span class="pre">NaN</span></code> as values in the attribute table.</p>
<div class="admonition attention">
<p class="admonition-title">Attention</p>
<p>The results here are a bit useless, since it’s just each county boundary multiplied by the number of wells in that county, but we kept this example for comprehensiveness.</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get inner join</span>
<span class="n">right_join_result</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">sjoin</span><span class="p">(</span><span class="n">wells</span><span class="p">,</span> <span class="n">counties</span><span class="p">,</span> <span class="n">how</span> <span class="o">=</span> <span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="n">op</span> <span class="o">=</span> <span class="s1">&#39;within&#39;</span><span class="p">)</span>

<span class="c1"># Print head and tail of attribute table</span>
<span class="n">display_table</span><span class="p">(</span><span class="n">table_name</span> <span class="o">=</span> <span class="s2">&quot;Right Join&quot;</span><span class="p">,</span> <span class="n">attribute_table</span> <span class="o">=</span> <span class="n">right_join_result</span><span class="p">)</span>

<span class="c1"># Plot merge</span>
<span class="n">plot_merge</span><span class="p">(</span><span class="n">merge_type</span> <span class="o">=</span> <span class="s2">&quot;Right Join&quot;</span><span class="p">,</span> <span class="n">merge_result</span> <span class="o">=</span> <span class="n">right_join_result</span><span class="p">,</span> <span class="n">merge_vector</span> <span class="o">=</span> <span class="s2">&quot;polygon&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Attribute Table: Right Join

Table shape (rows, columns): (1337, 7)

First two rows:
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>index_left</th>
      <th>WELL_NAME</th>
      <th>WELL_USE</th>
      <th>WELL_TYPE</th>
      <th>WELL_DEPTH</th>
      <th>coname</th>
      <th>geometry</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>787</td>
      <td>3S/1E  9M 4</td>
      <td>Industrial</td>
      <td>Single Well</td>
      <td>498</td>
      <td>Alameda County</td>
      <td>MULTIPOLYGON (((1860234.837 612219.122, 186007...</td>
    </tr>
    <tr>
      <th>0</th>
      <td>755</td>
      <td>3S/1E  8H13</td>
      <td>Observation</td>
      <td>Single Well</td>
      <td>800</td>
      <td>Alameda County</td>
      <td>MULTIPOLYGON (((1860234.837 612219.122, 186007...</td>
    </tr>
  </tbody>
</table>
</div></div><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Last two rows:
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>index_left</th>
      <th>WELL_NAME</th>
      <th>WELL_USE</th>
      <th>WELL_TYPE</th>
      <th>WELL_DEPTH</th>
      <th>coname</th>
      <th>geometry</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>8</th>
      <td>1697</td>
      <td>AVCA-01</td>
      <td>Residential</td>
      <td>Single Well</td>
      <td>100</td>
      <td>Sonoma County</td>
      <td>MULTIPOLYGON (((1746855.532 743026.706, 174685...</td>
    </tr>
    <tr>
      <th>8</th>
      <td>3508</td>
      <td>11N10W08P001M</td>
      <td>Residential</td>
      <td>Single Well</td>
      <td>30</td>
      <td>Sonoma County</td>
      <td>MULTIPOLYGON (((1746855.532 743026.706, 174685...</td>
    </tr>
  </tbody>
</table>
</div></div><img alt="../_images/e_vector_overlay_25_4.png" src="../_images/e_vector_overlay_25_4.png" />
</div>
</div>
</div>
<div class="section" id="inner-join">
<h5>Inner Join<a class="headerlink" href="#inner-join" title="Permalink to this headline">#</a></h5>
<p>Finally, with an inner join, only the well locations that fall within the county boundaries are kept. These well locations have the county boundaries dataset appended to them. Because it’s an inner join, there are no resulting features with <code class="docutils literal notranslate"><span class="pre">NaN</span></code> as values in the attribute table.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get inner join</span>
<span class="n">inner_join_result</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">sjoin</span><span class="p">(</span><span class="n">wells</span><span class="p">,</span> <span class="n">counties</span><span class="p">,</span> <span class="n">how</span> <span class="o">=</span> <span class="s2">&quot;inner&quot;</span><span class="p">,</span> <span class="n">op</span> <span class="o">=</span> <span class="s1">&#39;within&#39;</span><span class="p">)</span>

<span class="c1"># Print head and tail of attribute table</span>
<span class="n">display_table</span><span class="p">(</span><span class="n">table_name</span> <span class="o">=</span> <span class="s2">&quot;Inner Join&quot;</span><span class="p">,</span> <span class="n">attribute_table</span> <span class="o">=</span> <span class="n">inner_join_result</span><span class="p">)</span>

<span class="c1"># Plot merge</span>
<span class="n">plot_merge</span><span class="p">(</span><span class="n">merge_type</span> <span class="o">=</span> <span class="s2">&quot;Inner Join&quot;</span><span class="p">,</span> <span class="n">merge_result</span> <span class="o">=</span> <span class="n">inner_join_result</span><span class="p">,</span> <span class="n">merge_vector</span> <span class="o">=</span> <span class="s2">&quot;point&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Attribute Table: Inner Join

Table shape (rows, columns): (1337, 7)

First two rows:
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>WELL_NAME</th>
      <th>WELL_USE</th>
      <th>WELL_TYPE</th>
      <th>WELL_DEPTH</th>
      <th>geometry</th>
      <th>index_right</th>
      <th>coname</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>128</th>
      <td>None</td>
      <td>Stockwatering</td>
      <td>Unknown</td>
      <td>40</td>
      <td>POINT (1882982.865 701605.988)</td>
      <td>7</td>
      <td>Solano County</td>
    </tr>
    <tr>
      <th>129</th>
      <td>None</td>
      <td>Irrigation</td>
      <td>Unknown</td>
      <td>240</td>
      <td>POINT (1884096.112 699303.331)</td>
      <td>7</td>
      <td>Solano County</td>
    </tr>
  </tbody>
</table>
</div></div><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Last two rows:
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>WELL_NAME</th>
      <th>WELL_USE</th>
      <th>WELL_TYPE</th>
      <th>WELL_DEPTH</th>
      <th>geometry</th>
      <th>index_right</th>
      <th>coname</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1759</th>
      <td>T2S/R5W-06M01</td>
      <td>Residential</td>
      <td>Single Well</td>
      <td>275</td>
      <td>POINT (1827410.559 644648.215)</td>
      <td>4</td>
      <td>San Francisco County</td>
    </tr>
    <tr>
      <th>2316</th>
      <td>Kirkham MW130</td>
      <td>Observation</td>
      <td>Part of a nested/multi-completion well</td>
      <td>130</td>
      <td>POINT (1823285.838 641661.323)</td>
      <td>4</td>
      <td>San Francisco County</td>
    </tr>
  </tbody>
</table>
</div></div><img alt="../_images/e_vector_overlay_27_4.png" src="../_images/e_vector_overlay_27_4.png" />
</div>
</div>
<hr class="footnotes docutils" />
<dl class="footnote brackets">
<dt class="label" id="gpd-set"><span class="brackets">1</span><span class="fn-backref">(<a href="#id1">1</a>,<a href="#id3">2</a>,<a href="#id4">3</a>,<a href="#id6">4</a>,<a href="#id7">5</a>,<a href="#id9">6</a>,<a href="#id10">7</a>)</span></dt>
<dd><p><a class="reference external" href="https://geopandas.org/docs/user_guide/set_operations.html">Set-Operations with Overlay, GeoPandas</a></p>
</dd>
<dt class="label" id="bolstad"><span class="brackets">2</span><span class="fn-backref">(<a href="#id2">1</a>,<a href="#id5">2</a>,<a href="#id8">3</a>,<a href="#id11">4</a>)</span></dt>
<dd><p>GIS Fundamentals: A First Text on Geographic Information Systems, 5th ed., Paul Bolstad</p>
</dd>
<dt class="label" id="gpd-merge"><span class="brackets">3</span><span class="fn-backref">(<a href="#id12">1</a>,<a href="#id14">2</a>,<a href="#id15">3</a>)</span></dt>
<dd><p><a class="reference external" href="https://geopandas.org/docs/user_guide/mergingdata.html">Merging Data, GeoPandas</a></p>
</dd>
<dt class="label" id="esri-join"><span class="brackets">4</span><span class="fn-backref">(<a href="#id13">1</a>,<a href="#id16">2</a>)</span></dt>
<dd><p><a class="reference external" href="https://pro.arcgis.com/en/pro-app/latest/tool-reference/analysis/spatial-join.htm">Spatial Join (Analysis), Esri</a></p>
</dd>
</dl>
</div>
</div>
</div>
</div>
<span id="document-docs/e_spatial_joins"></span><hr class="docutils" />
<div class="admonition-learning-objectives admonition">
<p class="admonition-title">Learning Objectives</p>
<ul class="simple">
<li><p>Understand various types of spatial join relationships</p></li>
<li><p>Recognize different types of spatial joins</p></li>
<li><p>Understand how table relationships can affect a spatial join</p></li>
</ul>
</div>
<hr class="docutils" />
<div class="tex2jax_ignore mathjax_ignore section" id="spatial-joins">
<h2>Spatial Joins<a class="headerlink" href="#spatial-joins" title="Permalink to this headline">#</a></h2>
<p>To spatially join one dataset to another, attributes from the first dataset (join feature) are appended to the attributes in the second dataset (target feature) based on the relative spatial relationship between the two datasets’ geometries. <a class="footnote-reference brackets" href="#esri-join" id="id1">1</a>, <a class="footnote-reference brackets" href="#gpd-merge" id="id2">2</a></p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Unlike table joins by attributes, we’re not really concerned with the tables having a primary key (a column, or columns, that uniquely identifies each record in a table) to conduct a join. Instead, the relative spatial location between the features in two datasets will determine what gets joined.</p>
</div>
<p>This chapter will cover spatial join relationships, spatial join types, and attribute table relationships.</p>
<div class="section" id="spatial-join-relationships">
<h3>Spatial Join Relationships<a class="headerlink" href="#spatial-join-relationships" title="Permalink to this headline">#</a></h3>
<p>There are multiple spatial join relationships that we can specify. Only the features that meet the specified spatial relationship criteria will be joined together. <a class="footnote-reference brackets" href="#esri-join" id="id3">1</a>, <a class="footnote-reference brackets" href="#gpd-merge" id="id4">2</a> The spatial arrangement necessary to satisfy a specified spatial relationship depends on the vector types (i.e., point, line, polygon) of the join feature and the target feature. Note that some spatial relationships are not possible for certain combinations of vector types.</p>
<p>Below is a description of the spatial relationships available in the <code class="docutils literal notranslate"><span class="pre">geopandas</span></code> module (this list is not necessarily exhaustive). [^gpd_meerge] We also provide diagrams visualizing the spatial arrangement needed for various combinations of vector types to satisfy the spatial relationship criteria and allow for a join.</p>
<div class="section" id="contains">
<h4>Contains<a class="headerlink" href="#contains" title="Permalink to this headline">#</a></h4>
<p>One feature contains another if the geometry’s points are not to the exterior of the other’s geometry and the geometry’s interior contains at least one point of the other geometry’s interior.</p>
<div class="figure align-default" id="id5">
<img alt="../_images/overlay_contains.jpg" src="../_images/overlay_contains.jpg" />
<p class="caption"><span class="caption-number">Fig. 43 </span><span class="caption-text">Spatial arrangements for <em>contains</em> for different combinations of vector types.</span><a class="headerlink" href="#id5" title="Permalink to this image">#</a></p>
</div>
</div>
<div class="section" id="crosses">
<h4>Crosses<a class="headerlink" href="#crosses" title="Permalink to this headline">#</a></h4>
<p>The geometry’s interior <em>crosses</em> that of the other geometry, provided that the geometry does not contain the other and the dimension of the intersection is less than the dimension of either geometry.</p>
<div class="figure align-default" id="id6">
<img alt="../_images/overlay_crosses.jpg" src="../_images/overlay_crosses.jpg" />
<p class="caption"><span class="caption-number">Fig. 44 </span><span class="caption-text">Spatial arrangements for <em>crosses</em> for different combinations of vector types.</span><a class="headerlink" href="#id6" title="Permalink to this image">#</a></p>
</div>
</div>
<div class="section" id="intersects">
<h4>Intersects<a class="headerlink" href="#intersects" title="Permalink to this headline">#</a></h4>
<p>A feature <em>intersects</em> another if the geometry’s boundary or interior has any part in common with the other geometry.</p>
<div class="figure align-default" id="id7">
<img alt="../_images/overlay_intersects.jpg" src="../_images/overlay_intersects.jpg" />
<p class="caption"><span class="caption-number">Fig. 45 </span><span class="caption-text">Spatial arrangements for <em>intersects</em> for different combinations of vector types.</span><a class="headerlink" href="#id7" title="Permalink to this image">#</a></p>
</div>
</div>
<div class="section" id="overlaps">
<h4>Overlaps<a class="headerlink" href="#overlaps" title="Permalink to this headline">#</a></h4>
<p>A feature <em>overlaps</em> another if the geometry shares at least one point, but not all points, with the other geometry, provided that the geometries and the intersection of their interiors all have the same dimensions.</p>
<div class="figure align-default" id="id8">
<img alt="../_images/overlay_overlaps.jpg" src="../_images/overlay_overlaps.jpg" />
<p class="caption"><span class="caption-number">Fig. 46 </span><span class="caption-text">Spatial arrangements for <em>overlaps</em> for different combinations of vector types.</span><a class="headerlink" href="#id8" title="Permalink to this image">#</a></p>
</div>
</div>
<div class="section" id="touches">
<h4>Touches<a class="headerlink" href="#touches" title="Permalink to this headline">#</a></h4>
<p>A feature <em>touches</em> another if the geometry shares at least one point with the other geometry, provided that no part of the geometry’s interior intersects with the other geometry.</p>
<div class="figure align-default" id="id9">
<img alt="../_images/overlay_touches.jpg" src="../_images/overlay_touches.jpg" />
<p class="caption"><span class="caption-number">Fig. 47 </span><span class="caption-text">Spatial arrangements for <em>touches</em> for different combinations of vector types.</span><a class="headerlink" href="#id9" title="Permalink to this image">#</a></p>
</div>
</div>
<div class="section" id="within">
<h4>Within<a class="headerlink" href="#within" title="Permalink to this headline">#</a></h4>
<p>A feature is <em>within</em> another if the geometry is enclosed in the other geometry (geometry’s boundary and interior intersects with the other geometry’s interior only).</p>
<div class="figure align-default" id="id10">
<img alt="../_images/overlay_within.jpg" src="../_images/overlay_within.jpg" />
<p class="caption"><span class="caption-number">Fig. 48 </span><span class="caption-text">Spatial arrangements for <em>within</em> for different combinations of vector types.</span><a class="headerlink" href="#id10" title="Permalink to this image">#</a></p>
</div>
</div>
</div>
<div class="section" id="spatial-join-types">
<h3>Spatial Join Types<a class="headerlink" href="#spatial-join-types" title="Permalink to this headline">#</a></h3>
<p>There are four types of spatial joins: outer join, inner join, left join, and right join. These spatial join types determine which features from both datasets are kept in the resulting output dataset.</p>
<div class="figure align-default" id="join-types">
<img alt="../_images/join_types.jpg" src="../_images/join_types.jpg" />
<p class="caption"><span class="caption-number">Fig. 49 </span><span class="caption-text">There are four types of spatial joins. These Venn diagrams depict which features from both datasets are kept when they are joined together for each join type.</span><a class="headerlink" href="#join-types" title="Permalink to this image">#</a></p>
</div>
<p>Only the inner, left, and right join types are available in the <code class="docutils literal notranslate"><span class="pre">geopandas</span></code> module and are identical to those in <code class="docutils literal notranslate"><span class="pre">pandas</span></code>. <a class="footnote-reference brackets" href="#gpd-merge" id="id11">2</a></p>
<div class="section" id="outer-join">
<h4>Outer join<a class="headerlink" href="#outer-join" title="Permalink to this headline">#</a></h4>
<p>All features from both datasets are kept, regardless if the features meet the specified spatial relationship criteria for a join. As all attribute fields are combined, rows that do not have a match may have null values in the fields that originated from the other dataset. <a class="footnote-reference brackets" href="#bolstad" id="id12">3</a></p>
</div>
<div class="section" id="inner-join">
<h4>Inner join<a class="headerlink" href="#inner-join" title="Permalink to this headline">#</a></h4>
<p>Only features from both datasets that meet the spatial relationship for the joined are kept. The geometries from the first or left dataset are used for the join. <a class="footnote-reference brackets" href="#bolstad" id="id13">3</a></p>
</div>
<div class="section" id="left-join">
<h4>Left join<a class="headerlink" href="#left-join" title="Permalink to this headline">#</a></h4>
<p>All features from the first or left dataset are kept, regardless if the features meet the specified spatial relationship criteria for a join. As all attribute fields are combined, rows that do not have a match with the right dataset may have null values in the fields that originated from the right dataset.</p>
</div>
<div class="section" id="right-join">
<h4>Right join<a class="headerlink" href="#right-join" title="Permalink to this headline">#</a></h4>
<p>All features from the second or right dataset are kept, regardless if the features meet the specified spatial relationship criteria for a join. As all attribute fields are combined, rows that do not have a match with the left dataset may have null values in the fields that originated from the left dataset.</p>
<p>For more details on join types, see the <span class="xref myst">chapter on joining by attributes</span>.</p>
</div>
</div>
<div class="section" id="table-relationships">
<h3>Table Relationships<a class="headerlink" href="#table-relationships" title="Permalink to this headline">#</a></h3>
<p>Table relationships, or cardinality, specify the direction of the join and the relationship between the two datasets. There are four types of table relationships: one-to-one, one-to-many, many-to-one, and many-to-many. While these relationships are not specified as a parameter in the <code class="docutils literal notranslate"><span class="pre">geopandas</span></code> module when conducting a spatial join, it is important to have a general idea of the table relationship between the two datasets. Generally, a many-to-one join and a many-to-many join should be avoided because it can create ambiguity and unpredictability when analyzing and manipulating the resulting attribute table. <a class="footnote-reference brackets" href="#bolstad" id="id14">3</a></p>
<div class="section" id="one-to-one-relationship">
<h4>One-to-one relationship<a class="headerlink" href="#one-to-one-relationship" title="Permalink to this headline">#</a></h4>
<p>Each feature in one geometry is linked to one (and only one) feature in the second geometry (and vice versa). Each feature in both datasets will appear only once at most. <a class="footnote-reference brackets" href="#bolstad" id="id15">3</a></p>
<div class="figure align-default" id="id16">
<img alt="../_images/relationship_one_to_one.jpg" src="../_images/relationship_one_to_one.jpg" />
<p class="caption"><span class="caption-number">Fig. 50 </span><span class="caption-text">Two joined tables have a one-to-one relationship when each feature in one geometry is linked to one (and only one) feature in the second geometry.</span><a class="headerlink" href="#id16" title="Permalink to this image">#</a></p>
</div>
</div>
<div class="section" id="one-to-many-relationship-or-many-to-one-relationship">
<h4>One-to-many relationship or many-to-one relationship<a class="headerlink" href="#one-to-many-relationship-or-many-to-one-relationship" title="Permalink to this headline">#</a></h4>
<p>Each feature in one geometry is linked to one or more features in the second geometry. The output geometry may see the “one” feature duplicated across multiple rows to accommodate its multiple linkages in the other dataset (the “many”). A one-to-many or many-to-one relationship can be dependent on the spatial join type (for example, if a left join results in a one-to-many relationship, then a right join will result in a many-to-one relationship). <a class="footnote-reference brackets" href="#bolstad" id="id17">3</a></p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>These two table relationships—while similar—are not the same! In a one-to-many relationship, the “many” geometry is the dataset that is being joined to. Alternatively, in a many-to-one relationship, the “one” geometry is the dataset being joined to. Thus, the many-to-one relationship can result in duplicate “one” geometries and create uncertainty, which is why a many-to-one join should be avoided. <a class="footnote-reference brackets" href="#bolstad" id="id18">3</a></p>
</div>
<div class="figure align-default" id="one-to-many-relationship">
<img alt="../_images/relationship_one_to_many.jpg" src="../_images/relationship_one_to_many.jpg" />
<p class="caption"><span class="caption-number">Fig. 51 </span><span class="caption-text">Two joined tables have a one-to-many relationship when each feature in one geometry is linked to one or more features in the second geometry.</span><a class="headerlink" href="#one-to-many-relationship" title="Permalink to this image">#</a></p>
</div>
</div>
<div class="section" id="many-to-many-relationship">
<h4>Many-to-many relationship<a class="headerlink" href="#many-to-many-relationship" title="Permalink to this headline">#</a></h4>
<p>One or more features in one geometry are linked to one or more features in the second geometry. The output geometry may have multiple rows of each target and join feature to accommodate the multiple linkages, which can create ambiguity—hence why a many-to-many join should be avoided. <a class="footnote-reference brackets" href="#bolstad" id="id19">3</a></p>
<div class="figure align-default" id="id20">
<img alt="../_images/relationship_many_to_many.jpg" src="../_images/relationship_many_to_many.jpg" />
<p class="caption"><span class="caption-number">Fig. 52 </span><span class="caption-text">Two joined tables have a many-to-many relationship when one or more features in one geometry are linked to one or more features in the second geometry.</span><a class="headerlink" href="#id20" title="Permalink to this image">#</a></p>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>To ensure you’re doing a one-to-one or one-to-many join, it may be helpful to envision your spatial join before performing a spatial join. Think about what geometries you will be joining to (the target feature) and what geometry or geometries from the join feature might be joined to one geometry in the target feature.</p>
</div>
<hr class="footnotes docutils" />
<dl class="footnote brackets">
<dt class="label" id="esri-join"><span class="brackets">1</span><span class="fn-backref">(<a href="#id1">1</a>,<a href="#id3">2</a>)</span></dt>
<dd><p><a class="reference external" href="https://pro.arcgis.com/en/pro-app/latest/tool-reference/analysis/spatial-join.htm">Spatial Join (Analysis), Esri</a></p>
</dd>
<dt class="label" id="gpd-merge"><span class="brackets">2</span><span class="fn-backref">(<a href="#id2">1</a>,<a href="#id4">2</a>,<a href="#id11">3</a>)</span></dt>
<dd><p><a class="reference external" href="https://geopandas.org/docs/user_guide/mergingdata.html">Merging Data, GeoPandas</a></p>
</dd>
<dt class="label" id="bolstad"><span class="brackets">3</span><span class="fn-backref">(<a href="#id12">1</a>,<a href="#id13">2</a>,<a href="#id14">3</a>,<a href="#id15">4</a>,<a href="#id17">5</a>,<a href="#id18">6</a>,<a href="#id19">7</a>)</span></dt>
<dd><p>GIS Fundamentals: A First Text on Geographic Information Systems, 5th ed., Paul Bolstad</p>
</dd>
</dl>
</div>
</div>
</div>
<span id="document-docs/e_summarize_vector"></span><hr class="docutils" />
<div class="admonition-learning-objectives admonition">
<p class="admonition-title">Learning Objectives</p>
<ul class="simple">
<li><p>Create a grid to bin features</p></li>
<li><p>Bin features using the grid</p></li>
<li><p>Display kernel density estimation results and export resulting raster</p></li>
</ul>
</div>
<div class="admonition-review admonition">
<p class="admonition-title">Review</p>
<ul class="simple">
<li><p><a class="reference internal" href="docs/a_intro.html#document-docs/c_vectors"><span class="doc std std-doc">Spatial Vector Data</span></a></p></li>
<li><p><a class="reference internal" href="docs/a_intro.html#document-docs/c_rasters"><span class="doc std std-doc">Spatial Raster Data</span></a></p></li>
<li><p><a class="reference internal" href="docs/a_intro.html#document-docs/e_attributes"><span class="doc std std-doc">Attributes &amp; Indexing for Vector Data</span></a></p></li>
<li><p><a class="reference internal" href="docs/a_intro.html#document-docs/c_new_vectors"><span class="doc std std-doc">Creating Spatial Vector Data</span></a></p></li>
</ul>
</div>
<hr class="docutils" />
<div class="tex2jax_ignore mathjax_ignore section" id="point-density-measures-counts-kernel-density">
<h2>Point Density Measures - Counts &amp; Kernel Density<a class="headerlink" href="#point-density-measures-counts-kernel-density" title="Permalink to this headline">#</a></h2>
<p>Summary operations are useful for aggregating data, whether it be for analyzing overall trends or visualizing concentrations of data. Summarizing allows for effective analysis and communication of the data as compared to simply looking at or displaying points, lines, and polygons on a map.</p>
<p>This chapter will explore two summary operations that highlight concentrations of data: count points in a rectangular or hexagonal grid or by polygon and kernel density.</p>
<p><strong>Setup</strong></p>
<p>First, we will import the necessary modules (click the + below to show code cell).</p>
<div class="cell tag_hide-cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Import modules</span>
<span class="kn">import</span> <span class="nn">geopandas</span> <span class="k">as</span> <span class="nn">gpd</span>
<span class="kn">import</span> <span class="nn">geoplot</span> <span class="k">as</span> <span class="nn">gplt</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">rasterio</span>
<span class="kn">from</span> <span class="nn">rasterio.transform</span> <span class="kn">import</span> <span class="n">Affine</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span>
<span class="kn">from</span> <span class="nn">shapely.geometry</span> <span class="kn">import</span> <span class="n">Polygon</span><span class="p">,</span> <span class="n">box</span>
<span class="kn">from</span> <span class="nn">sklearn.datasets</span> <span class="kn">import</span> <span class="n">fetch_species_distributions</span>
<span class="kn">from</span> <span class="nn">sklearn.neighbors</span> <span class="kn">import</span> <span class="n">KernelDensity</span>
</pre></div>
</div>
</div>
</div>
<p>We will utilize shapefiles of San Francisco Bay Area county boundaries and wells within the Bay Area and the surrounding 50 km. We will load in the data and reproject the data (click the + below to show code cell).</p>
<div class="cell tag_hide-cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Load data</span>

<span class="c1"># County boundaries</span>
<span class="c1"># Source: https://opendata.mtc.ca.gov/datasets/san-francisco-bay-region-counties-clipped?geometry=-125.590%2C37.123%2C-119.152%2C38.640</span>
<span class="n">counties</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="s2">&quot;../_static/e_vector_shapefiles/sf_bay_counties/sf_bay_counties.shp&quot;</span><span class="p">)</span>

<span class="c1"># Well locations</span>
<span class="c1"># Source: https://gis.data.ca.gov/datasets/3a3e681b894644a9a95f9815aeeeb57f_0?geometry=-123.143%2C36.405%2C-119.230%2C37.175</span>
<span class="c1"># Modified by author so that only the well locations within the counties and the surrounding 50 km were kept</span>
<span class="n">wells</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="s2">&quot;../_static/e_vector_shapefiles/sf_bay_wells_50km/sf_bay_wells_50km.shp&quot;</span><span class="p">)</span>

<span class="c1"># Reproject data to NAD83(HARN) / California Zone 3</span>
<span class="c1"># https://spatialreference.org/ref/epsg/2768/</span>
<span class="n">proj</span> <span class="o">=</span> <span class="mi">2768</span>
<span class="n">counties</span> <span class="o">=</span> <span class="n">counties</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">proj</span><span class="p">)</span>
<span class="n">wells</span> <span class="o">=</span> <span class="n">wells</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">proj</span><span class="p">)</span>

<span class="c1"># Create a column that assigns each well a number</span>
<span class="n">wells</span><span class="p">[</span><span class="s2">&quot;Well_ID&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">wells</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="count-points-in-rectangular-or-hexagonal-grid-or-by-polygon">
<h3>Count Points in Rectangular or Hexagonal Grid or by Polygon<a class="headerlink" href="#count-points-in-rectangular-or-hexagonal-grid-or-by-polygon" title="Permalink to this headline">#</a></h3>
<p>To summarize by grid, we create a new polygon layer consisting of a grid and overlay on another feature. We can summarize an aspect of that feature within each cell of the grid. The polygon layer commonly consists of a fishnet (rectangular cells), but using hexagons as a grid is becoming increasingly widespread.</p>
<p>Let’s define a function that will create a grid of either rectangles or hexagons of a specified side length.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">create_grid</span><span class="p">(</span><span class="n">feature</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">side_length</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Create a grid consisting of either rectangles or hexagons with a specified side length that covers the extent of input feature.&#39;&#39;&#39;</span>

    <span class="c1"># Slightly displace the minimum and maximum values of the feature extent by creating a buffer</span>
    <span class="c1"># This decreases likelihood that a feature will fall directly on a cell boundary (in between two cells)</span>
    <span class="c1"># Buffer is projection dependent (due to units)</span>
    <span class="n">feature</span> <span class="o">=</span> <span class="n">feature</span><span class="o">.</span><span class="n">buffer</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>

    <span class="c1"># Get extent of buffered input feature</span>
    <span class="n">min_x</span><span class="p">,</span> <span class="n">min_y</span><span class="p">,</span> <span class="n">max_x</span><span class="p">,</span> <span class="n">max_y</span> <span class="o">=</span> <span class="n">feature</span><span class="o">.</span><span class="n">total_bounds</span>


    <span class="c1"># Create empty list to hold individual cells that will make up the grid</span>
    <span class="n">cells_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Create grid of squares if specified</span>
    <span class="k">if</span> <span class="n">shape</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;square&quot;</span><span class="p">,</span> <span class="s2">&quot;rectangle&quot;</span><span class="p">,</span> <span class="s2">&quot;box&quot;</span><span class="p">]:</span>

        <span class="c1"># Adapted from https://james-brennan.github.io/posts/fast_gridding_geopandas/</span>
        <span class="c1"># Create and iterate through list of x values that will define column positions with specified side length</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">min_x</span> <span class="o">-</span> <span class="n">side_length</span><span class="p">,</span> <span class="n">max_x</span> <span class="o">+</span> <span class="n">side_length</span><span class="p">,</span> <span class="n">side_length</span><span class="p">):</span>

            <span class="c1"># Create and iterate through list of y values that will define row positions with specified side length</span>
            <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">min_y</span> <span class="o">-</span> <span class="n">side_length</span><span class="p">,</span> <span class="n">max_y</span> <span class="o">+</span> <span class="n">side_length</span><span class="p">,</span> <span class="n">side_length</span><span class="p">):</span>

                <span class="c1"># Create a box with specified side length and append to list</span>
                <span class="n">cells_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">box</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span> <span class="o">+</span> <span class="n">side_length</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="n">side_length</span><span class="p">))</span>


    <span class="c1"># Otherwise, create grid of hexagons</span>
    <span class="k">elif</span> <span class="n">shape</span> <span class="o">==</span> <span class="s2">&quot;hexagon&quot;</span><span class="p">:</span>

        <span class="c1"># Set horizontal displacement that will define column positions with specified side length (based on normal hexagon)</span>
        <span class="n">x_step</span> <span class="o">=</span> <span class="mf">1.5</span> <span class="o">*</span> <span class="n">side_length</span>

        <span class="c1"># Set vertical displacement that will define row positions with specified side length (based on normal hexagon)</span>
        <span class="c1"># This is the distance between the centers of two hexagons stacked on top of each other (vertically)</span>
        <span class="n">y_step</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">side_length</span>

        <span class="c1"># Get apothem (distance between center and midpoint of a side, based on normal hexagon)</span>
        <span class="n">apothem</span> <span class="o">=</span> <span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">side_length</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>

        <span class="c1"># Set column number</span>
        <span class="n">column_number</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Create and iterate through list of x values that will define column positions with vertical displacement</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">min_x</span><span class="p">,</span> <span class="n">max_x</span> <span class="o">+</span> <span class="n">x_step</span><span class="p">,</span> <span class="n">x_step</span><span class="p">):</span>

            <span class="c1"># Create and iterate through list of y values that will define column positions with horizontal displacement</span>
            <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">min_y</span><span class="p">,</span> <span class="n">max_y</span> <span class="o">+</span> <span class="n">y_step</span><span class="p">,</span> <span class="n">y_step</span><span class="p">):</span>

                <span class="c1"># Create hexagon with specified side length</span>
                <span class="n">hexagon</span> <span class="o">=</span> <span class="p">[[</span><span class="n">x</span> <span class="o">+</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">angle</span><span class="p">))</span> <span class="o">*</span> <span class="n">side_length</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">angle</span><span class="p">))</span> <span class="o">*</span> <span class="n">side_length</span><span class="p">]</span> <span class="k">for</span> <span class="n">angle</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">360</span><span class="p">,</span> <span class="mi">60</span><span class="p">)]</span>

                <span class="c1"># Append hexagon to list</span>
                <span class="n">cells_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Polygon</span><span class="p">(</span><span class="n">hexagon</span><span class="p">))</span>

            <span class="c1"># Check if column number is even</span>
            <span class="k">if</span> <span class="n">column_number</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>

                <span class="c1"># If even, expand minimum and maximum y values by apothem value to vertically displace next row</span>
                <span class="c1"># Expand values so as to not miss any features near the feature extent</span>
                <span class="n">min_y</span> <span class="o">-=</span> <span class="n">apothem</span>
                <span class="n">max_y</span> <span class="o">+=</span> <span class="n">apothem</span>

            <span class="c1"># Else, odd</span>
            <span class="k">else</span><span class="p">:</span>

                <span class="c1"># Revert minimum and maximum y values back to original</span>
                <span class="n">min_y</span> <span class="o">+=</span> <span class="n">apothem</span>
                <span class="n">max_y</span> <span class="o">-=</span> <span class="n">apothem</span>

            <span class="c1"># Increase column number by 1</span>
            <span class="n">column_number</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="c1"># Else, raise error</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Specify a rectangle or hexagon as the grid shape.&quot;</span><span class="p">)</span>

    <span class="c1"># Create grid from list of cells</span>
    <span class="n">grid</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">cells_list</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">],</span> <span class="n">crs</span> <span class="o">=</span> <span class="n">proj</span><span class="p">)</span>

    <span class="c1"># Create a column that assigns each grid a number</span>
    <span class="n">grid</span><span class="p">[</span><span class="s2">&quot;Grid_ID&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">grid</span><span class="p">))</span>

    <span class="c1"># Return grid</span>
    <span class="k">return</span> <span class="n">grid</span>
</pre></div>
</div>
</div>
</div>
<p>We will illustrate this methodology by counting the number of well points within each cell of the grid. There are two different ways we can accomplish this methodology, both with advantages and disadvantages.</p>
<p>To begin, we will set some global parameters for both examples.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set side length for cells in grid</span>
<span class="c1"># This is dependent on projection chosen as length is in units specified in projection</span>
<span class="n">side_length</span> <span class="o">=</span> <span class="mi">5000</span>

<span class="c1"># Set shape of grid</span>
<span class="n">shape</span> <span class="o">=</span> <span class="s2">&quot;hexagon&quot;</span>
<span class="c1"># shape = &quot;rectangle&quot;</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="method-1-group-by">
<h4>Method 1 - Group by<a class="headerlink" href="#method-1-group-by" title="Permalink to this headline">#</a></h4>
<p>This method involves using spatial joins to allocate each point to the cell in which it resides. All the points within each cell are subsequently grouped together and counted.</p>
<div class="figure align-default" id="point-density-using-groupby-and-geopandas">
<img alt="../_images/PointDensity_Groupby.png" src="../_images/PointDensity_Groupby.png" />
<p class="caption"><span class="caption-number">Fig. 53 </span><span class="caption-text">Point density using groupby and geopandas</span><a class="headerlink" href="#point-density-using-groupby-and-geopandas" title="Permalink to this image">#</a></p>
</div>
<p>First, we will create a grid over the Bay Area.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create grid</span>
<span class="n">bay_area_grid</span> <span class="o">=</span> <span class="n">create_grid</span><span class="p">(</span><span class="n">feature</span> <span class="o">=</span> <span class="n">wells</span><span class="p">,</span> <span class="n">shape</span> <span class="o">=</span> <span class="n">shape</span><span class="p">,</span> <span class="n">side_length</span> <span class="o">=</span> <span class="n">side_length</span><span class="p">)</span>

<span class="c1"># Create subplots</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

<span class="c1"># Plot data</span>
<span class="n">counties</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;bisque&#39;</span><span class="p">,</span> <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;dimgray&#39;</span><span class="p">)</span>
<span class="n">wells</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span> <span class="n">marker</span> <span class="o">=</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;dodgerblue&#39;</span><span class="p">,</span> <span class="n">markersize</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">bay_area_grid</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;lightseagreen&#39;</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.55</span><span class="p">)</span>

<span class="c1"># Set title</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;San Francisco Bay Area - Boundaries, Wells, and Grids&#39;</span><span class="p">,</span> <span class="n">fontdict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;fontsize&#39;</span><span class="p">:</span> <span class="s1">&#39;15&#39;</span><span class="p">,</span> <span class="s1">&#39;fontweight&#39;</span> <span class="p">:</span> <span class="s1">&#39;3&#39;</span><span class="p">})</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0.5, 1.0, &#39;San Francisco Bay Area - Boundaries, Wells, and Grids&#39;)
</pre></div>
</div>
<img alt="../_images/e_summarize_vector_9_1.png" src="../_images/e_summarize_vector_9_1.png" />
</div>
</div>
<p>Next, we will conduct a spatial join for each well point, essentially assigning it to a cell. We can add a field with a value of <code class="docutils literal notranslate"><span class="pre">1</span></code>, group all the wells in a cell, and aggregate <strong>(sum)</strong> all those <code class="docutils literal notranslate"><span class="pre">1</span></code> values to get the total number of wells in a cell.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Perform spatial join, merging attribute table of wells point and that of the cell with which it intersects</span>
<span class="c1"># op = &quot;intersects&quot; also counts those that fall on a cell boundary (between two cells)</span>
<span class="c1"># op = &quot;within&quot; will not count those fall on a cell boundary</span>
<span class="n">wells_cell</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">sjoin</span><span class="p">(</span><span class="n">wells</span><span class="p">,</span> <span class="n">bay_area_grid</span><span class="p">,</span> <span class="n">how</span> <span class="o">=</span> <span class="s2">&quot;inner&quot;</span><span class="p">,</span> <span class="n">op</span> <span class="o">=</span> <span class="s2">&quot;intersects&quot;</span><span class="p">)</span>

<span class="c1"># Remove duplicate counts</span>
<span class="c1"># With intersect, those that fall on a boundary will be allocated to all cells that share that boundary</span>
<span class="n">wells_cell</span> <span class="o">=</span> <span class="n">wells_cell</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Well_ID&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

<span class="c1"># Set field name to hold count value</span>
<span class="n">count_field</span> <span class="o">=</span> <span class="s2">&quot;Count&quot;</span>

<span class="c1"># Add a field with constant value of 1</span>
<span class="n">wells_cell</span><span class="p">[</span><span class="n">count_field</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

<span class="c1"># Group GeoDataFrame by cell while aggregating the Count values</span>
<span class="n">wells_cell</span> <span class="o">=</span> <span class="n">wells_cell</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;Grid_ID&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">({</span><span class="n">count_field</span><span class="p">:</span><span class="s1">&#39;sum&#39;</span><span class="p">})</span>

<span class="c1"># Merge the resulting grouped dataframe with the grid GeoDataFrame, using a left join to keep all cell polygons</span>
<span class="n">bay_area_grid</span> <span class="o">=</span> <span class="n">bay_area_grid</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">wells_cell</span><span class="p">,</span> <span class="n">on</span> <span class="o">=</span> <span class="s1">&#39;Grid_ID&#39;</span><span class="p">,</span> <span class="n">how</span> <span class="o">=</span> <span class="s2">&quot;left&quot;</span><span class="p">)</span>

<span class="c1"># Fill the NaN values (cells without any points) with 0</span>
<span class="n">bay_area_grid</span><span class="p">[</span><span class="n">count_field</span><span class="p">]</span> <span class="o">=</span> <span class="n">bay_area_grid</span><span class="p">[</span><span class="n">count_field</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="c1"># Convert Count field to integer</span>
<span class="n">bay_area_grid</span><span class="p">[</span><span class="n">count_field</span><span class="p">]</span> <span class="o">=</span> <span class="n">bay_area_grid</span><span class="p">[</span><span class="n">count_field</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="c1"># Display grid attribute table</span>
<span class="n">display</span><span class="p">(</span><span class="n">bay_area_grid</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>geometry</th>
      <th>Grid_ID</th>
      <th>Count</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>POLYGON ((1724272.398 497763.821, 1721772.398 ...</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>POLYGON ((1724272.398 506424.075, 1721772.398 ...</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>POLYGON ((1724272.398 515084.329, 1721772.398 ...</td>
      <td>2</td>
      <td>0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>POLYGON ((1724272.398 523744.583, 1721772.398 ...</td>
      <td>3</td>
      <td>0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>POLYGON ((1724272.398 532404.837, 1721772.398 ...</td>
      <td>4</td>
      <td>0</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>1381</th>
      <td>POLYGON ((1986772.398 787882.331, 1984272.398 ...</td>
      <td>1381</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1382</th>
      <td>POLYGON ((1986772.398 796542.585, 1984272.398 ...</td>
      <td>1382</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1383</th>
      <td>POLYGON ((1986772.398 805202.839, 1984272.398 ...</td>
      <td>1383</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1384</th>
      <td>POLYGON ((1986772.398 813863.093, 1984272.398 ...</td>
      <td>1384</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1385</th>
      <td>POLYGON ((1986772.398 822523.347, 1984272.398 ...</td>
      <td>1385</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
<p>1386 rows × 3 columns</p>
</div></div></div>
</div>
<p>We can plot the data to see how it looks.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create subplots</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

<span class="c1"># Plot data</span>
<span class="n">counties</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;dimgray&#39;</span><span class="p">)</span>
<span class="n">wells</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span> <span class="n">marker</span> <span class="o">=</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;dimgray&#39;</span><span class="p">,</span> <span class="n">markersize</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">bay_area_grid</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span> <span class="n">column</span> <span class="o">=</span> <span class="s2">&quot;Count&quot;</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="s2">&quot;RdPu&quot;</span><span class="p">,</span> <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;lightseagreen&#39;</span><span class="p">,</span> <span class="n">linewidth</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.70</span><span class="p">,</span> <span class="n">legend</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

<span class="c1"># Set title</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;San Francisco Bay Area - Binning Well Points&#39;</span><span class="p">,</span> <span class="n">fontdict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;fontsize&#39;</span><span class="p">:</span> <span class="s1">&#39;15&#39;</span><span class="p">,</span> <span class="s1">&#39;fontweight&#39;</span> <span class="p">:</span> <span class="s1">&#39;3&#39;</span><span class="p">})</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0.5, 1.0, &#39;San Francisco Bay Area - Binning Well Points&#39;)
</pre></div>
</div>
<img alt="../_images/e_summarize_vector_13_1.png" src="../_images/e_summarize_vector_13_1.png" />
</div>
</div>
<p>The advantage of this method is that it is pretty fast. To verify that all points have been counted once, we can check the aggregate of all the point sums for each cell.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Check total number of well points counted and compare to number of well points in input data</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Total number of well points counted: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">Number of well points in input data: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">bay_area_grid</span><span class="o">.</span><span class="n">Count</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">wells</span><span class="p">)))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Total number of well points counted: 6037
Number of well points in input data: 6037
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="method-2-iterate-through-each-feature">
<h4>Method 2 - Iterate through each feature<a class="headerlink" href="#method-2-iterate-through-each-feature" title="Permalink to this headline">#</a></h4>
<p>This second method is slightly more intuitive, but it can take a long time to run. We will use a subset of the input data–those that fall within Santa Clara County–to illustrate this example. We will first subset our data to Santa Clara County (click the + below to show code cell).</p>
<div class="cell tag_hide-cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Select the Santa Clara County boundary</span>
<span class="n">sc_county</span> <span class="o">=</span> <span class="n">counties</span><span class="p">[</span><span class="n">counties</span><span class="p">[</span><span class="s2">&quot;coname&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Santa Clara County&quot;</span><span class="p">]</span>

<span class="c1"># Subset the GeoDataFrame by checking which wells are within Santa Clara County</span>
<span class="n">sc_county_wells</span> <span class="o">=</span> <span class="n">wells</span><span class="p">[</span><span class="n">wells</span><span class="o">.</span><span class="n">within</span><span class="p">(</span><span class="n">sc_county</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>
</pre></div>
</div>
</div>
</div>
<p>Next, we will create a grid over Santa Clara County.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create grid</span>
<span class="n">sc_county_grid</span> <span class="o">=</span> <span class="n">create_grid</span><span class="p">(</span><span class="n">feature</span> <span class="o">=</span> <span class="n">sc_county_wells</span><span class="p">,</span> <span class="n">shape</span> <span class="o">=</span> <span class="n">shape</span><span class="p">,</span> <span class="n">side_length</span> <span class="o">=</span> <span class="n">side_length</span><span class="p">)</span>

<span class="c1"># Create subplots</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

<span class="c1"># Plot data</span>
<span class="n">sc_county</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;bisque&#39;</span><span class="p">,</span> <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;dimgray&#39;</span><span class="p">)</span>
<span class="n">sc_county_wells</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span> <span class="n">marker</span> <span class="o">=</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;dodgerblue&#39;</span><span class="p">,</span> <span class="n">markersize</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">sc_county_grid</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;lightseagreen&#39;</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.55</span><span class="p">)</span>

<span class="c1"># Set title</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Santa Clara County - Boundaries, Wells, and Grids&#39;</span><span class="p">,</span> <span class="n">fontdict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;fontsize&#39;</span><span class="p">:</span> <span class="s1">&#39;15&#39;</span><span class="p">,</span> <span class="s1">&#39;fontweight&#39;</span> <span class="p">:</span> <span class="s1">&#39;3&#39;</span><span class="p">})</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0.5, 1.0, &#39;Santa Clara County - Boundaries, Wells, and Grids&#39;)
</pre></div>
</div>
<img alt="../_images/e_summarize_vector_19_1.png" src="../_images/e_summarize_vector_19_1.png" />
</div>
</div>
<p>We iterate through each cell in the grid and set a counter for each cell. We iterate through each well point and see if it is within (or intersects) the cell. If it is, the counter is increased by 1, and the feature is “discarded” so that it won’t be counted again (resolving the issue of a point falling on the boundary between two cells).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create empty list used to hold count values for each grid</span>
<span class="n">counts_list</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># Create empty list to hold index of points that have already been matched to a grid</span>
<span class="n">counted_points</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># Iterate through each cell in grid</span>
<span class="k">for</span> <span class="n">i_1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">sc_county_grid</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>

    <span class="c1"># Get a cell by index</span>
    <span class="n">cell</span> <span class="o">=</span> <span class="n">sc_county_grid</span><span class="o">.</span><span class="n">iloc</span><span class="p">[[</span><span class="n">i_1</span><span class="p">]]</span>

    <span class="c1"># Reset index of cell to 0</span>
    <span class="n">cell</span> <span class="o">=</span> <span class="n">cell</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Set point count to 0</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># Iterate through each feature in wells dataset</span>
    <span class="k">for</span> <span class="n">i_2</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">sc_county_wells</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>

        <span class="c1"># Check if index of point is in list of indices whose points have already been matched to a grid and counted</span>
        <span class="k">if</span> <span class="n">i_2</span> <span class="ow">in</span> <span class="n">counted_points</span><span class="p">:</span>

            <span class="c1"># If already counted, skip remaining statements in loop and start at top of loop</span>
            <span class="k">continue</span>

        <span class="c1"># Otherwise, continue with remaining statements</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="c1"># Get a well point by index</span>
        <span class="n">well</span> <span class="o">=</span> <span class="n">sc_county_wells</span><span class="o">.</span><span class="n">iloc</span><span class="p">[[</span><span class="n">i_2</span><span class="p">]]</span>

        <span class="c1"># Reset index of well point (to 0) to match the index-reset cell</span>
        <span class="n">well</span> <span class="o">=</span> <span class="n">well</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Check if well intersects the cell</span>
        <span class="c1"># Best to use intersects instead of within or contains, as intersect will count points that fall exactly on the cell boundaries</span>
        <span class="c1"># Points that fall exactly on a cell boundary (between two cells) will be allocated to the first of the two cells called in script</span>
        <span class="n">criteria_met</span> <span class="o">=</span> <span class="n">well</span><span class="o">.</span><span class="n">intersects</span><span class="p">(</span><span class="n">cell</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># If preferred, can check if well is within cell or if cell contains well</span>
        <span class="c1"># Both statements do the same thing</span>
        <span class="c1"># criteria_met = well.within(cell)[0]</span>
        <span class="c1"># criteria_met = cell.contains(well)[0]</span>

        <span class="c1"># Check if criteria has been met (True)</span>
        <span class="k">if</span> <span class="n">criteria_met</span><span class="p">:</span>

            <span class="c1"># If True, increase counter by 1 for the cell</span>
            <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c1"># Add index of counted point to the list</span>
            <span class="n">counted_points</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i_2</span><span class="p">)</span>

        <span class="c1"># Otherwise, criteria is not met (False)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="c1"># Add total count for that cell to the list of counts</span>
    <span class="n">counts_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">count</span><span class="p">)</span>

<span class="c1"># print(counts_list)</span>

<span class="c1"># Add a new column to the grid GeoDataFrame with the list of counts for each cell</span>
<span class="n">sc_county_grid</span><span class="p">[</span><span class="s1">&#39;Count&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">counts_list</span><span class="p">)</span>

<span class="c1"># Display grid attribute table</span>
<span class="n">display</span><span class="p">(</span><span class="n">sc_county_grid</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>geometry</th>
      <th>Grid_ID</th>
      <th>Count</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>POLYGON ((1859618.426 548178.942, 1857118.426 ...</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>POLYGON ((1859618.426 556839.196, 1857118.426 ...</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>POLYGON ((1859618.426 565499.450, 1857118.426 ...</td>
      <td>2</td>
      <td>0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>POLYGON ((1859618.426 574159.704, 1857118.426 ...</td>
      <td>3</td>
      <td>0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>POLYGON ((1859618.426 582819.958, 1857118.426 ...</td>
      <td>4</td>
      <td>0</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>88</th>
      <td>POLYGON ((1934618.426 574159.704, 1932118.426 ...</td>
      <td>88</td>
      <td>0</td>
    </tr>
    <tr>
      <th>89</th>
      <td>POLYGON ((1934618.426 582819.958, 1932118.426 ...</td>
      <td>89</td>
      <td>0</td>
    </tr>
    <tr>
      <th>90</th>
      <td>POLYGON ((1934618.426 591480.212, 1932118.426 ...</td>
      <td>90</td>
      <td>0</td>
    </tr>
    <tr>
      <th>91</th>
      <td>POLYGON ((1934618.426 600140.466, 1932118.426 ...</td>
      <td>91</td>
      <td>0</td>
    </tr>
    <tr>
      <th>92</th>
      <td>POLYGON ((1934618.426 608800.720, 1932118.426 ...</td>
      <td>92</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
<p>93 rows × 3 columns</p>
</div></div></div>
</div>
<p>We can check to make sure all well points in Santa Clara County were counted.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Check total number of well points counted and compare to number of well points in input data</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Total number of well points counted: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">Number of well points in input data: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">counts_list</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">sc_county_wells</span><span class="p">)))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Total number of well points counted: 136
Number of well points in input data: 136
</pre></div>
</div>
</div>
</div>
<p>Finally, we can plot the data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create subplots</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

<span class="c1"># Plot data</span>
<span class="n">sc_county</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;dimgray&#39;</span><span class="p">)</span>
<span class="n">sc_county_wells</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span> <span class="n">marker</span> <span class="o">=</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;dimgray&#39;</span><span class="p">,</span> <span class="n">markersize</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">sc_county_grid</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span> <span class="n">column</span> <span class="o">=</span> <span class="s2">&quot;Count&quot;</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="s2">&quot;RdPu&quot;</span><span class="p">,</span> <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;lightseagreen&#39;</span><span class="p">,</span> <span class="n">linewidth</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.70</span><span class="p">,</span> <span class="n">legend</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

<span class="c1"># Set title</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Santa Clara County - Binning Well Points&#39;</span><span class="p">,</span> <span class="n">fontdict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;fontsize&#39;</span><span class="p">:</span> <span class="s1">&#39;15&#39;</span><span class="p">,</span> <span class="s1">&#39;fontweight&#39;</span> <span class="p">:</span> <span class="s1">&#39;3&#39;</span><span class="p">})</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0.5, 1.0, &#39;Santa Clara County - Binning Well Points&#39;)
</pre></div>
</div>
<img alt="../_images/e_summarize_vector_25_1.png" src="../_images/e_summarize_vector_25_1.png" />
</div>
</div>
</div>
</div>
<div class="section" id="kernel-density-estimation">
<h3>Kernel Density Estimation<a class="headerlink" href="#kernel-density-estimation" title="Permalink to this headline">#</a></h3>
<p>Kernel density estimation (KDE) visualizes concentrations points or polylines. It calculates a magnitude per unit area, providing the density estimate of features within a specified neighborhood surrounding each feature. <a class="footnote-reference brackets" href="#esri-kernel" id="id1">1</a>, <a class="footnote-reference brackets" href="#bolstad" id="id2">2</a></p>
<p>A kernel function is used to fit a smooth surface to each feature. One of the most common types of kernels is the Gaussian kernel, which is a normal density function. Other types of kernel functions can be used, and the type affects the influence of surrounding points on a location’s density estimate as the points’ distances increase from that location. These kernels’ functions vary in shapes and characteristics, such as where the function peaks, how pointed the peak is, and how fast the peak is reached with distance. <a class="footnote-reference brackets" href="#esri-kernel" id="id3">1</a>, <a class="footnote-reference brackets" href="#bolstad" id="id4">2</a></p>
<p>In addition to specifying a kernel, the bandwith can also be specified. This parameter defines how spread out the kernel is. A lower bandwith allows points far away from a location to affect the density estimate at that location, whereas with a higher bandwith, only close points have influence. <a class="footnote-reference brackets" href="#esri-kernel" id="id5">1</a>, <a class="footnote-reference brackets" href="#bolstad" id="id6">2</a></p>
<p>Individual density functions based on a specified kernel are plotted for each feature. Then, individual density function values at a location are aggregated to produce the KDE value at that location, and this is repeated across the entire point or polyline extent. The final KDE result is a raster depicting the sum of all individual density functions. <a class="footnote-reference brackets" href="#esri-kernel" id="id7">1</a>, <a class="footnote-reference brackets" href="#bolstad" id="id8">2</a></p>
<p>For more information on KDE, check out <a class="reference external" href="https://mathisonian.github.io/kde/">this visualization</a>.</p>
<p>We will demonstrate two ways to perform kernel density estimation. The first way allows us to quickly visualize the KDE. The second way also allows us to export and save a KDE raster for additional analysis.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>We are intentionally keeping the well points beyond (but within 50 km) of the Bay Area boundaries. This provides a buffer to ensure that the KDE for wells data near the boundaries is not inadvertently influenced by these artificial county boundaries. Once KDE is run, the result can be clipped to the Bay Area boundaries (which we do in the first method).</p>
</div>
<div class="section" id="method-1-display">
<h4>Method 1 - Display<a class="headerlink" href="#method-1-display" title="Permalink to this headline">#</a></h4>
<p>This method uses <code class="docutils literal notranslate"><span class="pre">geoplot</span></code>, a high-level plotting library for spatial data that complements <code class="docutils literal notranslate"><span class="pre">matplotlib</span></code>. For more information on <code class="docutils literal notranslate"><span class="pre">geoplot</span></code>, check out the <a class="reference external" href="https://residentmario.github.io/geoplot/index.html">documentation</a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set projection to WGS 84 and reproject data</span>
<span class="n">proj_wgs</span> <span class="o">=</span> <span class="mi">4326</span>
<span class="n">counties_wgs</span> <span class="o">=</span> <span class="n">counties</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">proj_wgs</span><span class="p">)</span>
<span class="n">wells_wgs</span> <span class="o">=</span> <span class="n">wells</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">proj_wgs</span><span class="p">)</span>

<span class="c1"># Create subplots</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

<span class="c1"># Plot data</span>
<span class="n">counties_wgs</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;dimgray&#39;</span><span class="p">)</span>
<span class="n">wells_wgs</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span> <span class="n">marker</span> <span class="o">=</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;dimgray&#39;</span><span class="p">,</span> <span class="n">markersize</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">gplt</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">(</span><span class="n">wells_wgs</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="s2">&quot;RdPu&quot;</span><span class="p">,</span> <span class="n">shade</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">clip</span> <span class="o">=</span> <span class="n">counties_wgs</span><span class="p">,</span> <span class="n">thresh</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">)</span>

<span class="c1"># Set title</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;San Francisco Bay Area - Kernel Density Estimation for Wells&#39;</span><span class="p">,</span> <span class="n">fontdict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;fontsize&#39;</span><span class="p">:</span> <span class="s1">&#39;15&#39;</span><span class="p">,</span> <span class="s1">&#39;fontweight&#39;</span> <span class="p">:</span> <span class="s1">&#39;3&#39;</span><span class="p">})</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/home/mmann1123/anaconda3/envs/pygisbookgw/lib/python3.7/site-packages/seaborn/_decorators.py:43: FutureWarning: Pass the following variable as a keyword arg: y. From version 0.12, the only valid positional argument will be `data`, and passing other arguments without an explicit keyword will result in an error or misinterpretation.
  FutureWarning
/home/mmann1123/anaconda3/envs/pygisbookgw/lib/python3.7/site-packages/seaborn/distributions.py:1676: UserWarning: `shade_lowest` is now deprecated in favor of `thresh`. Setting `thresh=0`, but please update your code.
  warnings.warn(msg, UserWarning)
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0.5, 1.0, &#39;San Francisco Bay Area - Kernel Density Estimation for Wells&#39;)
</pre></div>
</div>
<img alt="../_images/e_summarize_vector_27_2.png" src="../_images/e_summarize_vector_27_2.png" />
</div>
</div>
</div>
<div class="section" id="method-2-display-and-export-with-scikit-learn">
<h4>Method 2 - Display and export with <code class="docutils literal notranslate"><span class="pre">scikit-learn</span></code><a class="headerlink" href="#method-2-display-and-export-with-scikit-learn" title="Permalink to this headline">#</a></h4>
<p>This method uses <code class="docutils literal notranslate"><span class="pre">scikit-learn</span></code> to visualize and export the KDE result. We are able to specify and change various estimator parameters. Examples include:</p>
<ul class="simple">
<li><p>kernel type</p></li>
<li><p><a class="reference external" href="https://scikit-learn.org/stable/modules/generated/sklearn.neighbors.DistanceMetric.html">metric (how distances from a location are calculated)</a></p></li>
<li><p><a class="reference external" href="https://scikit-learn.org/stable/modules/neighbors.html#nearest-neighbor-algorithms">algorithm (how to quickly identify neighboring points instead of performing time and resource intensive brute force)</a></p></li>
</ul>
<p>For further reading, check out the <a class="reference external" href="https://scikit-learn.org/stable/modules/generated/sklearn.neighbors.KernelDensity.html#sklearn.neighbors.KernelDensity"><code class="docutils literal notranslate"><span class="pre">scikit-learn</span></code> documentation</a> and the <a class="reference external" href="https://scikit-learn.org/stable/auto_examples/neighbors/plot_species_kde.html#sphx-glr-auto-examples-neighbors-plot-species-kde-py">associated example</a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get X and Y coordinates of well points</span>
<span class="n">x_sk</span> <span class="o">=</span> <span class="n">wells_wgs</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">x</span>
<span class="n">y_sk</span> <span class="o">=</span> <span class="n">wells_wgs</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">y</span>

<span class="c1"># Get minimum and maximum coordinate values of well points</span>
<span class="n">min_x_sk</span><span class="p">,</span> <span class="n">min_y_sk</span><span class="p">,</span> <span class="n">max_x_sk</span><span class="p">,</span> <span class="n">max_y_sk</span> <span class="o">=</span> <span class="n">wells_wgs</span><span class="o">.</span><span class="n">total_bounds</span>

<span class="c1"># Create a cell mesh grid</span>
<span class="c1"># Horizontal and vertical cell counts should be the same</span>
<span class="n">XX_sk</span><span class="p">,</span> <span class="n">YY_sk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mgrid</span><span class="p">[</span><span class="n">min_x_sk</span><span class="p">:</span><span class="n">max_x_sk</span><span class="p">:</span><span class="mi">100</span><span class="n">j</span><span class="p">,</span> <span class="n">min_y_sk</span><span class="p">:</span><span class="n">max_y_sk</span><span class="p">:</span><span class="mi">100</span><span class="n">j</span><span class="p">]</span>

<span class="c1"># Create 2-D array of the coordinates (paired) of each cell in the mesh grid</span>
<span class="n">positions_sk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">XX_sk</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">YY_sk</span><span class="o">.</span><span class="n">ravel</span><span class="p">()])</span><span class="o">.</span><span class="n">T</span>

<span class="c1"># Create 2-D array of the coordinate values of the well points</span>
<span class="n">Xtrain_sk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">x_sk</span><span class="p">,</span> <span class="n">y_sk</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>

<span class="c1"># Get kernel density estimator (can change parameters as desired)</span>
<span class="n">kde_sk</span> <span class="o">=</span> <span class="n">KernelDensity</span><span class="p">(</span><span class="n">bandwidth</span> <span class="o">=</span> <span class="mf">0.04</span><span class="p">,</span> <span class="n">metric</span> <span class="o">=</span> <span class="s1">&#39;euclidean&#39;</span><span class="p">,</span> <span class="n">kernel</span> <span class="o">=</span> <span class="s1">&#39;gaussian&#39;</span><span class="p">,</span> <span class="n">algorithm</span> <span class="o">=</span> <span class="s1">&#39;auto&#39;</span><span class="p">)</span>

<span class="c1"># Fit kernel density estimator to wells coordinates</span>
<span class="n">kde_sk</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">Xtrain_sk</span><span class="p">)</span>

<span class="c1"># Evaluate the estimator on coordinate pairs</span>
<span class="n">Z_sk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">kde_sk</span><span class="o">.</span><span class="n">score_samples</span><span class="p">(</span><span class="n">positions_sk</span><span class="p">))</span>

<span class="c1"># Reshape the data to fit mesh grid</span>
<span class="n">Z_sk</span> <span class="o">=</span> <span class="n">Z_sk</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">XX_sk</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="c1"># Plot data</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">rot90</span><span class="p">(</span><span class="n">Z_sk</span><span class="p">),</span> <span class="n">cmap</span> <span class="o">=</span> <span class="s2">&quot;RdPu&quot;</span><span class="p">,</span> <span class="n">extent</span> <span class="o">=</span> <span class="p">[</span><span class="n">min_x_sk</span><span class="p">,</span> <span class="n">max_x_sk</span><span class="p">,</span> <span class="n">min_y_sk</span><span class="p">,</span> <span class="n">max_y_sk</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_sk</span><span class="p">,</span> <span class="n">y_sk</span><span class="p">,</span> <span class="s1">&#39;k.&#39;</span><span class="p">,</span> <span class="n">markersize</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">)</span>
<span class="n">counties_wgs</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;dimgray&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;San Francisco Bay Area - SciKit-Learn Kernel Density Estimation for Wells&#39;</span><span class="p">,</span> <span class="n">fontdict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;fontsize&#39;</span><span class="p">:</span> <span class="s1">&#39;15&#39;</span><span class="p">,</span> <span class="s1">&#39;fontweight&#39;</span> <span class="p">:</span> <span class="s1">&#39;3&#39;</span><span class="p">})</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/e_summarize_vector_29_0.png" src="../_images/e_summarize_vector_29_0.png" />
</div>
</div>
<p>We can export the raster if necessary.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">export_kde_raster</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="n">XX</span><span class="p">,</span> <span class="n">YY</span><span class="p">,</span> <span class="n">min_x</span><span class="p">,</span> <span class="n">max_x</span><span class="p">,</span> <span class="n">min_y</span><span class="p">,</span> <span class="n">max_y</span><span class="p">,</span> <span class="n">proj</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Export and save a kernel density raster.&#39;&#39;&#39;</span>

    <span class="c1"># Flip array vertically and rotate 270 degrees</span>
    <span class="n">Z_export</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rot90</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span>

    <span class="c1"># Get resolution</span>
    <span class="n">xres</span> <span class="o">=</span> <span class="p">(</span><span class="n">max_x</span> <span class="o">-</span> <span class="n">min_x</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">XX</span><span class="p">)</span>
    <span class="n">yres</span> <span class="o">=</span> <span class="p">(</span><span class="n">max_y</span> <span class="o">-</span> <span class="n">min_y</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">YY</span><span class="p">)</span>

    <span class="c1"># Set transform</span>
    <span class="n">transform</span> <span class="o">=</span> <span class="n">Affine</span><span class="o">.</span><span class="n">translation</span><span class="p">(</span><span class="n">min_x</span> <span class="o">-</span> <span class="n">xres</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">min_y</span> <span class="o">-</span> <span class="n">yres</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">Affine</span><span class="o">.</span><span class="n">scale</span><span class="p">(</span><span class="n">xres</span><span class="p">,</span> <span class="n">yres</span><span class="p">)</span>

    <span class="c1"># Export array as raster</span>
    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span>
            <span class="n">filename</span><span class="p">,</span>
            <span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span>
            <span class="n">driver</span> <span class="o">=</span> <span class="s2">&quot;GTiff&quot;</span><span class="p">,</span>
            <span class="n">height</span> <span class="o">=</span> <span class="n">Z_export</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">width</span> <span class="o">=</span> <span class="n">Z_export</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="n">Z_export</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
            <span class="n">crs</span> <span class="o">=</span> <span class="n">proj</span><span class="p">,</span>
            <span class="n">transform</span> <span class="o">=</span> <span class="n">transform</span><span class="p">,</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">new_dataset</span><span class="p">:</span>
            <span class="n">new_dataset</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">Z_export</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Export raster</span>
<span class="n">export_kde_raster</span><span class="p">(</span><span class="n">Z</span> <span class="o">=</span> <span class="n">Z_sk</span><span class="p">,</span> <span class="n">XX</span> <span class="o">=</span> <span class="n">XX_sk</span><span class="p">,</span> <span class="n">YY</span> <span class="o">=</span> <span class="n">YY_sk</span><span class="p">,</span>
                  <span class="n">min_x</span> <span class="o">=</span> <span class="n">min_x_sk</span><span class="p">,</span> <span class="n">max_x</span> <span class="o">=</span> <span class="n">max_x_sk</span><span class="p">,</span> <span class="n">min_y</span> <span class="o">=</span> <span class="n">min_y_sk</span><span class="p">,</span> <span class="n">max_y</span> <span class="o">=</span> <span class="n">max_y_sk</span><span class="p">,</span>
                  <span class="n">proj</span> <span class="o">=</span> <span class="n">proj_wgs</span><span class="p">,</span> <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;../temp/bay-area-wells_kde_sklearn.tif&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>There are a few other ways to compute KDE in Python. This <a class="reference external" href="https://jakevdp.github.io/blog/2013/12/01/kernel-density-estimation/">article</a> reviews and compares all these implementations.</p>
<hr class="footnotes docutils" />
<dl class="footnote brackets">
<dt class="label" id="esri-kernel"><span class="brackets">1</span><span class="fn-backref">(<a href="#id1">1</a>,<a href="#id3">2</a>,<a href="#id5">3</a>,<a href="#id7">4</a>)</span></dt>
<dd><p><a class="reference external" href="https://desktop.arcgis.com/en/arcmap/10.3/tools/spatial-analyst-toolbox/how-kernel-density-works.htm">How Kernel Density works, Esri</a></p>
</dd>
<dt class="label" id="bolstad"><span class="brackets">2</span><span class="fn-backref">(<a href="#id2">1</a>,<a href="#id4">2</a>,<a href="#id6">3</a>,<a href="#id8">4</a>)</span></dt>
<dd><p>GIS Fundamentals: A First Text on Geographic Information Systems, 5th ed., Paul Bolstad</p>
</dd>
</dl>
</div>
</div>
</div>
<span id="document-docs/e_interpolation"></span><div class="tex2jax_ignore mathjax_ignore section" id="spatial-interpolation">
<h2>Spatial Interpolation<a class="headerlink" href="#spatial-interpolation" title="Permalink to this headline">#</a></h2>
<hr class="docutils" />
<div class="admonition-learning-objectives admonition">
<p class="admonition-title">Learning Objectives</p>
<ul class="simple">
<li><p>Conduct various types of interpolation on point dataset</p></li>
<li><p>Obtain interpolated values at specified unsampled locations</p></li>
</ul>
</div>
<div class="admonition-review admonition">
<p class="admonition-title">Review</p>
<ul class="simple">
<li><p><a class="reference internal" href="docs/a_intro.html#document-docs/c_vectors"><span class="doc std std-doc">Spatial Vector Data</span></a></p></li>
<li><p><a class="reference internal" href="docs/a_intro.html#document-docs/e_attributes"><span class="doc std std-doc">Attributes &amp; Indexing for Vector Data</span></a></p></li>
<li><p><a class="reference internal" href="docs/a_intro.html#document-docs/c_new_vectors"><span class="doc std std-doc">Creating Spatial Vector Data</span></a></p></li>
<li><p><a class="reference internal" href="docs/a_intro.html#document-docs/e_vector_merge_dissolve"><span class="doc std std-doc">Merge Data &amp; Dissolve Polygons</span></a></p></li>
</ul>
</div>
<hr class="docutils" />
<p>Interpolation is the process of using locations with known, sampled values (of a phenomenon) to estimate the values at unknown, unsampled areas <a class="footnote-reference brackets" href="#bolstad" id="id1">1</a>. In this chapter, we will explore three interpolation methods: Thiessen polygons (Voronoi diagrams), k-nearest neighbors (KNN), and kriging.</p>
<p>We will first begin by importing modules (click the + below to show code cell).</p>
<div class="cell tag_hide-cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Import modules</span>
<span class="kn">import</span> <span class="nn">geopandas</span> <span class="k">as</span> <span class="nn">gpd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">pykrige.ok</span> <span class="kn">import</span> <span class="n">OrdinaryKriging</span>
<span class="kn">import</span> <span class="nn">rasterio</span>
<span class="kn">import</span> <span class="nn">rasterio.mask</span>
<span class="kn">from</span> <span class="nn">rasterio.plot</span> <span class="kn">import</span> <span class="n">show</span>
<span class="kn">from</span> <span class="nn">rasterio.transform</span> <span class="kn">import</span> <span class="n">Affine</span>
<span class="kn">from</span> <span class="nn">scipy.spatial</span> <span class="kn">import</span> <span class="n">Voronoi</span><span class="p">,</span> <span class="n">voronoi_plot_2d</span>
<span class="kn">from</span> <span class="nn">shapely.geometry</span> <span class="kn">import</span> <span class="n">box</span>
<span class="kn">from</span> <span class="nn">shapely.geometry</span> <span class="kn">import</span> <span class="n">Polygon</span><span class="p">,</span> <span class="n">Point</span>
<span class="kn">from</span> <span class="nn">sklearn.gaussian_process</span> <span class="kn">import</span> <span class="n">GaussianProcessRegressor</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">r2_score</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">from</span> <span class="nn">sklearn.neighbors</span> <span class="kn">import</span> <span class="n">KNeighborsRegressor</span>
</pre></div>
</div>
</div>
</div>
<p>We will utilize shapefiles of San Francisco Bay Area county boundaries and rainfall “values” that were “sampled” in the Bay Area. We will load in the data and reproject the data (click the + below to show code cell).</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>It is critical to use a ‘projected’ coordinate system when doing interpolation. If you keep your data in geographic lat lon distances will vary significantly as you move up and down in latitude… since interpolation depends on distance as a way of establishing relationships this would be a problem… a big one.</p>
</div>
<div class="cell tag_hide-cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Load data</span>

<span class="c1"># County boundaries</span>
<span class="c1"># Source: https://opendata.mtc.ca.gov/datasets/san-francisco-bay-region-counties-clipped?geometry=-125.590%2C37.123%2C-119.152%2C38.640</span>
<span class="n">counties</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="s2">&quot;../_static/e_vector_shapefiles/sf_bay_counties/sf_bay_counties.shp&quot;</span><span class="p">)</span>

<span class="c1"># Rainfall measurement &quot;locations&quot;</span>
<span class="c1"># Source: https://earthworks.stanford.edu/catalog/stanford-td754wr4701</span>
<span class="c1"># Modified by author by clipping raster to San Francisco Bay Area, generating random points, and extracting raster values (0-255) to the points</span>
<span class="n">rainfall</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="s2">&quot;../_static/e_vector_shapefiles/sf_bay_rainfall/sf_bay_rainfall.shp&quot;</span><span class="p">)</span>

<span class="c1"># Reproject data to CA Teale Albert</span>
<span class="c1"># https://nrm.dfg.ca.gov/FileHandler.ashx?DocumentID=109326&amp;inline</span>
<span class="n">proj</span> <span class="o">=</span> <span class="s2">&quot;+proj=aea +lat_1=34 +lat_2=40.5 +lat_0=0 +lon_0=-120 +x_0=0 +y_0=-4000000 +ellps=GRS80 +datum=NAD83 +units=m +no_defs &quot;</span>
<span class="n">counties</span> <span class="o">=</span> <span class="n">counties</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">proj</span><span class="p">)</span>
<span class="n">rainfall</span> <span class="o">=</span> <span class="n">rainfall</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">proj</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Next, we’ll prepare the data for geoprocessing (click the + below to show code cell).</p>
<div class="cell tag_hide-cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get X and Y coordinates of rainfall points</span>
<span class="n">x_rain</span> <span class="o">=</span> <span class="n">rainfall</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">x</span>
<span class="n">y_rain</span> <span class="o">=</span> <span class="n">rainfall</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">y</span>

<span class="c1"># Create list of XY coordinate pairs</span>
<span class="n">coords_rain</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">xy</span><span class="p">)</span> <span class="k">for</span> <span class="n">xy</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">x_rain</span><span class="p">,</span> <span class="n">y_rain</span><span class="p">)]</span>

<span class="c1"># Get extent of counties feature</span>
<span class="n">min_x_counties</span><span class="p">,</span> <span class="n">min_y_counties</span><span class="p">,</span> <span class="n">max_x_counties</span><span class="p">,</span> <span class="n">max_y_counties</span> <span class="o">=</span> <span class="n">counties</span><span class="o">.</span><span class="n">total_bounds</span>

<span class="c1"># Get list of rainfall &quot;values&quot;</span>
<span class="n">value_rain</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">rainfall</span><span class="p">[</span><span class="s2">&quot;VALUE&quot;</span><span class="p">])</span>

<span class="c1"># Create a copy of counties dataset</span>
<span class="n">counties_dissolved</span> <span class="o">=</span> <span class="n">counties</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="c1"># Add a field with constant value of 1</span>
<span class="n">counties_dissolved</span><span class="p">[</span><span class="s2">&quot;constant&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

<span class="c1"># Dissolve all counties to create one polygon</span>
<span class="n">counties_dissolved</span> <span class="o">=</span> <span class="n">counties_dissolved</span><span class="o">.</span><span class="n">dissolve</span><span class="p">(</span><span class="n">by</span> <span class="o">=</span> <span class="s2">&quot;constant&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We will also define a function for exporting rasters.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">export_kde_raster</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="n">XX</span><span class="p">,</span> <span class="n">YY</span><span class="p">,</span> <span class="n">min_x</span><span class="p">,</span> <span class="n">max_x</span><span class="p">,</span> <span class="n">min_y</span><span class="p">,</span> <span class="n">max_y</span><span class="p">,</span> <span class="n">proj</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Export and save a kernel density raster.&#39;&#39;&#39;</span>

    <span class="c1"># Get resolution</span>
    <span class="n">xres</span> <span class="o">=</span> <span class="p">(</span><span class="n">max_x</span> <span class="o">-</span> <span class="n">min_x</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">XX</span><span class="p">)</span>
    <span class="n">yres</span> <span class="o">=</span> <span class="p">(</span><span class="n">max_y</span> <span class="o">-</span> <span class="n">min_y</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">YY</span><span class="p">)</span>

    <span class="c1"># Set transform</span>
    <span class="n">transform</span> <span class="o">=</span> <span class="n">Affine</span><span class="o">.</span><span class="n">translation</span><span class="p">(</span><span class="n">min_x</span> <span class="o">-</span> <span class="n">xres</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">min_y</span> <span class="o">-</span> <span class="n">yres</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">Affine</span><span class="o">.</span><span class="n">scale</span><span class="p">(</span><span class="n">xres</span><span class="p">,</span> <span class="n">yres</span><span class="p">)</span>

    <span class="c1"># Export array as raster</span>
    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span>
            <span class="n">filename</span><span class="p">,</span>
            <span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span>
            <span class="n">driver</span> <span class="o">=</span> <span class="s2">&quot;GTiff&quot;</span><span class="p">,</span>
            <span class="n">height</span> <span class="o">=</span> <span class="n">Z</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">width</span> <span class="o">=</span> <span class="n">Z</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="n">Z</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
            <span class="n">crs</span> <span class="o">=</span> <span class="n">proj</span><span class="p">,</span>
            <span class="n">transform</span> <span class="o">=</span> <span class="n">transform</span><span class="p">,</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">new_dataset</span><span class="p">:</span>
            <span class="n">new_dataset</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>With any model used for prediction, it is important to assess the model fit for unobserved locations (or the accuracy of the values predicted by the model in relation to their actual values). Thus, in order to assess the fit, we break our data into two portions, a “training” data set used to train the model, and a “testing” set that remains “unseen” by the model but can be used to assess model performance. Effectively, we can use this “unseen” testing subset to validate the model because we can compare their true values with the estimated value from the model prediction.</p>
<p>We will separate our rainfall dataset into two subsets: one for training and the other for testing. These subsets will be used in our KNN and kriging analyses.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Split data into testing and training sets</span>
<span class="n">coords_rain_train</span><span class="p">,</span> <span class="n">coords_rain_test</span><span class="p">,</span> <span class="n">value_rain_train</span><span class="p">,</span> <span class="n">value_rain_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">coords_rain</span><span class="p">,</span> <span class="n">value_rain</span><span class="p">,</span> <span class="n">test_size</span> <span class="o">=</span> <span class="mf">0.20</span><span class="p">,</span> <span class="n">random_state</span> <span class="o">=</span> <span class="mi">42</span><span class="p">)</span>

<span class="c1"># Create separate GeoDataFrames for testing and training sets</span>
<span class="n">rain_train_gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">geometry</span> <span class="o">=</span> <span class="p">[</span><span class="n">Point</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">coords_rain_train</span><span class="p">],</span> <span class="n">crs</span> <span class="o">=</span> <span class="n">proj</span><span class="p">)</span>
<span class="n">rain_train_gdf</span><span class="p">[</span><span class="s2">&quot;Actual_Value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value_rain_train</span>
<span class="n">rain_test_gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">geometry</span> <span class="o">=</span> <span class="p">[</span><span class="n">Point</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">coords_rain_test</span><span class="p">],</span> <span class="n">crs</span> <span class="o">=</span> <span class="n">proj</span><span class="p">)</span>
<span class="n">rain_test_gdf</span><span class="p">[</span><span class="s2">&quot;Actual_Value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value_rain_test</span>

<span class="c1"># Get minimum and maximum coordinate values of rainfall training points</span>
<span class="n">min_x_rain</span><span class="p">,</span> <span class="n">min_y_rain</span><span class="p">,</span> <span class="n">max_x_rain</span><span class="p">,</span> <span class="n">max_y_rain</span> <span class="o">=</span> <span class="n">rain_train_gdf</span><span class="o">.</span><span class="n">total_bounds</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s plot our data!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create subplots</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

<span class="c1"># Stylize plots</span>
<span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;bmh&#39;</span><span class="p">)</span>

<span class="c1"># Plot data</span>
<span class="n">counties</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;bisque&#39;</span><span class="p">,</span> <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;dimgray&#39;</span><span class="p">)</span>
<span class="n">rain_train_gdf</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span> <span class="n">marker</span> <span class="o">=</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;limegreen&#39;</span><span class="p">,</span> <span class="n">markersize</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">rain_test_gdf</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span> <span class="n">marker</span> <span class="o">=</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;royalblue&#39;</span><span class="p">,</span> <span class="n">markersize</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span>
<span class="c1"># Set title</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;San Francisco Bay Area - Rainfall Measurement Locations&#39;</span><span class="p">,</span> <span class="n">fontdict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;fontsize&#39;</span><span class="p">:</span> <span class="s1">&#39;15&#39;</span><span class="p">,</span> <span class="s1">&#39;fontweight&#39;</span> <span class="p">:</span> <span class="s1">&#39;3&#39;</span><span class="p">})</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0.5, 1.0, &#39;San Francisco Bay Area - Rainfall Measurement Locations&#39;)
</pre></div>
</div>
<img alt="../_images/e_interpolation_11_1.png" src="../_images/e_interpolation_11_1.png" />
</div>
</div>
<p>In the map above, the green and blue points are the rainfall points that we loaded separated into the training set and testing set, respectively.</p>
<div class="section" id="thiessen-polygons-voronoi-diagrams">
<h3>Thiessen Polygons (Voronoi Diagrams)<a class="headerlink" href="#thiessen-polygons-voronoi-diagrams" title="Permalink to this headline">#</a></h3>
<p>Thiessen polygons (also known as Voronoi diagrams) polygons allow us to perform nearest neighbor interpolation, which is perhaps the most basic type of interpolation. Thiessen polygons are be constructed around each sampled point so all the space within a specific polygon is closest in distance to that sampled point (as compared to other sampled points). Then, to perform nearest neighbor interpolation, all that space is assigned the value of that sampled point. <a class="footnote-reference brackets" href="#bolstad" id="id2">1</a></p>
<p>We can use the <a class="reference external" href="https://docs.scipy.org/doc/scipy/reference/generated/scipy.spatial.Voronoi.html"><code class="docutils literal notranslate"><span class="pre">scipy</span></code> package</a> to create Thiessen polygons. After running the <code class="docutils literal notranslate"><span class="pre">Voronoi()</span></code> function, we can use the <code class="docutils literal notranslate"><span class="pre">vertices</span></code> attribute to get a list of vertices, which we can subsequently use to generate polygons.</p>
<div class="admonition attention">
<p class="admonition-title">Attention</p>
<p>When creating Thiessen polygons, the sample points toward the edges of the point shapefile’s extent will have infinite Voronoi regions, because not all sides of these edge points have adjacent sample points that would constrain the regions. Consequently, these infinite regions will not be exported. To mitigate this issue, we can create dummy points well beyond the extent of our datasets, which will create finite Voronoi regions for all of our actual sample points. Then, we can clip the regions to our extent shapefile (creating dummy points far away from our actual sample points will ensure the dummy points and their infinite Voronoi regions do not interfere with the sample points and their associated finite Voronoi regions after all regions are clipped).</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Extend extent of counties feature by using buffer</span>
<span class="n">counties_buffer</span> <span class="o">=</span> <span class="n">counties</span><span class="o">.</span><span class="n">buffer</span><span class="p">(</span><span class="mi">100000</span><span class="p">)</span>

<span class="c1"># Get extent of buffered input feature</span>
<span class="n">min_x_cty_tp</span><span class="p">,</span> <span class="n">min_y_cty_tp</span><span class="p">,</span> <span class="n">max_x_cty_tp</span><span class="p">,</span> <span class="n">max_y_cty_tp</span> <span class="o">=</span> <span class="n">counties_buffer</span><span class="o">.</span><span class="n">total_bounds</span>

<span class="c1"># Use extent to create dummy points and add them to list of coordinates</span>
<span class="n">coords_tp</span> <span class="o">=</span> <span class="n">coords_rain_train</span> <span class="o">+</span> <span class="p">[[</span><span class="n">min_x_cty_tp</span><span class="p">,</span> <span class="n">min_y_cty_tp</span><span class="p">],</span> <span class="p">[</span><span class="n">max_x_cty_tp</span><span class="p">,</span> <span class="n">min_y_cty_tp</span><span class="p">],</span>
                                 <span class="p">[</span><span class="n">max_x_cty_tp</span><span class="p">,</span> <span class="n">max_y_cty_tp</span><span class="p">],</span> <span class="p">[</span><span class="n">min_x_cty_tp</span><span class="p">,</span> <span class="n">max_y_cty_tp</span><span class="p">]]</span>

<span class="c1"># Compute Voronoi diagram</span>
<span class="n">tp</span> <span class="o">=</span> <span class="n">Voronoi</span><span class="p">(</span><span class="n">coords_tp</span><span class="p">)</span>

<span class="c1"># Create empty list of hold Voronoi polygons</span>
<span class="n">tp_poly_list</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># Create a polygon for each region</span>
<span class="c1"># &#39;regions&#39; attribute provides a list of indices of the vertices (in the &#39;vertices&#39; attribute) that make up the region</span>
<span class="c1"># Source: https://docs.scipy.org/doc/scipy/reference/generated/scipy.spatial.Voronoi.html</span>
<span class="k">for</span> <span class="n">region</span> <span class="ow">in</span> <span class="n">tp</span><span class="o">.</span><span class="n">regions</span><span class="p">:</span>

    <span class="c1"># Ignore region if -1 is in the list (based on documentation)</span>
    <span class="k">if</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">in</span> <span class="n">region</span><span class="p">:</span>

        <span class="c1"># Return to top of loop</span>
        <span class="k">continue</span>

    <span class="c1"># Otherwise, pass</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="c1"># Check that region list has values in it</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">region</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>

        <span class="c1"># Create a polygon by using the region list to call the correct elements in the &#39;vertices&#39; attribute</span>
        <span class="n">tp_poly_region</span> <span class="o">=</span> <span class="n">Polygon</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">tp</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="n">region</span><span class="p">]))</span>

        <span class="c1"># Append polygon to list</span>
        <span class="n">tp_poly_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tp_poly_region</span><span class="p">)</span>

    <span class="c1"># If no values, return to top of loop</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">continue</span>

<span class="c1"># Create GeoDataFrame from list of polygon regions</span>
<span class="n">tp_polys</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">tp_poly_list</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">],</span> <span class="n">crs</span> <span class="o">=</span> <span class="n">proj</span><span class="p">)</span>

<span class="c1"># Clip polygon regions to the counties boundary</span>
<span class="n">tp_polys_clipped</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">tp_polys</span><span class="p">,</span> <span class="n">counties_dissolved</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>A spatial join can be conducted to assign the rainfall training “values” to its associated Thiessen polygon.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># If rainfall point within the polygon, assign that rainfall value to the polygon</span>
<span class="n">tp_polys_clipped_values</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">sjoin</span><span class="p">(</span><span class="n">rain_train_gdf</span><span class="p">,</span> <span class="n">tp_polys_clipped</span><span class="p">,</span> <span class="n">how</span> <span class="o">=</span> <span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="n">op</span> <span class="o">=</span> <span class="s1">&#39;within&#39;</span><span class="p">)</span>

<span class="c1"># Drop un-needed column</span>
<span class="n">tp_polys_clipped_values</span> <span class="o">=</span> <span class="n">tp_polys_clipped_values</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;index_left&quot;</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>

<span class="c1"># Rename column</span>
<span class="n">tp_polys_clipped_values</span> <span class="o">=</span> <span class="n">tp_polys_clipped_values</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Actual_Value&quot;</span><span class="p">:</span> <span class="s2">&quot;VALUE_Thiessen&quot;</span><span class="p">})</span>

<span class="c1"># Display head of attribute table</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Attribute Table: Thiessen Polygon Interpolated Values&quot;</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">tp_polys_clipped_values</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Attribute Table: Thiessen Polygon Interpolated Values
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>VALUE_Thiessen</th>
      <th>geometry</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>31</td>
      <td>POLYGON ((-112269.760 -116571.101, -118993.986...</td>
    </tr>
    <tr>
      <th>1</th>
      <td>30</td>
      <td>POLYGON ((-123619.813 -116449.307, -118993.986...</td>
    </tr>
    <tr>
      <th>2</th>
      <td>58</td>
      <td>POLYGON ((-246788.933 78896.506, -260275.835 8...</td>
    </tr>
    <tr>
      <th>3</th>
      <td>62</td>
      <td>POLYGON ((-260275.835 80739.699, -260874.252 8...</td>
    </tr>
    <tr>
      <th>4</th>
      <td>66</td>
      <td>POLYGON ((-237973.581 88639.620, -246524.775 8...</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>A second spatial join can be conducted to assign those values from the Thiessen polygons to the points from the testing dataset (only if a test point falls within a polygon). We can subsequently get the out-of-sample r-squared value, which is calculated by using the data points that the model did not use (the testing dataset) and comparing the testing dataset’s actual values to the values as predicted by the model.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># If test point is within a polygon, assign that polygon&#39;s value to the test point</span>
<span class="n">rain_test_pred_tp</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">sjoin</span><span class="p">(</span><span class="n">rain_test_gdf</span><span class="p">,</span> <span class="n">tp_polys_clipped_values</span><span class="p">,</span> <span class="n">how</span> <span class="o">=</span> <span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="n">op</span> <span class="o">=</span> <span class="s1">&#39;within&#39;</span><span class="p">)</span>

<span class="c1"># Drop un-needed column</span>
<span class="n">rain_test_pred_tp</span> <span class="o">=</span> <span class="n">rain_test_pred_tp</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;index_right&quot;</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>

<span class="c1"># Rename column</span>
<span class="n">rain_test_pred_tp</span> <span class="o">=</span> <span class="n">rain_test_pred_tp</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Actual_Value&quot;</span><span class="p">:</span> <span class="s2">&quot;VALUE_Actual&quot;</span><span class="p">,</span> <span class="s2">&quot;VALUE_Thiessen&quot;</span><span class="p">:</span> <span class="s2">&quot;VALUE_Predict&quot;</span><span class="p">})</span>

<span class="c1"># Generate out-of-sample R^2</span>
<span class="n">out_r_squared_tp</span> <span class="o">=</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">rain_test_pred_tp</span><span class="o">.</span><span class="n">VALUE_Actual</span><span class="p">,</span> <span class="n">rain_test_pred_tp</span><span class="o">.</span><span class="n">VALUE_Predict</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Thiessen polygon out-of-sample r-squared: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">out_r_squared_tp</span><span class="p">,</span> <span class="mi">2</span><span class="p">)))</span>

<span class="c1"># Display attribute table</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Attribute Table: Testing Dataset Interpolated Values - Thiessen Polygon Method&quot;</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">rain_test_pred_tp</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Thiessen polygon out-of-sample r-squared: 0.89

Attribute Table: Testing Dataset Interpolated Values - Thiessen Polygon Method
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>geometry</th>
      <th>VALUE_Actual</th>
      <th>VALUE_Predict</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>POINT (-229633.026 40063.754)</td>
      <td>56</td>
      <td>62</td>
    </tr>
    <tr>
      <th>1</th>
      <td>POINT (-273849.350 92453.689)</td>
      <td>73</td>
      <td>91</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Plotting the data, we see that each polygon has one green training point (and vice-versa). All space within one polygon is closest to the known training point (green dot) within the polygon. The testing points (blue dots) are assigned the value of the Thiessen polygon in which it falls.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create subplots</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">))</span>

<span class="c1"># Stylize plots</span>
<span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;bmh&#39;</span><span class="p">)</span>

<span class="c1"># Plot data</span>
<span class="n">counties_dissolved</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;dimgray&#39;</span><span class="p">)</span>
<span class="n">tp_polys_clipped</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;Set3&#39;</span><span class="p">,</span> <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">linewidth</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">)</span>
<span class="n">rain_train_gdf</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span> <span class="n">marker</span> <span class="o">=</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;limegreen&#39;</span><span class="p">,</span> <span class="n">markersize</span> <span class="o">=</span> <span class="mi">15</span><span class="p">)</span>
<span class="n">rain_test_pred_tp</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span> <span class="n">marker</span> <span class="o">=</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;royalblue&#39;</span><span class="p">,</span> <span class="n">markersize</span> <span class="o">=</span> <span class="mi">15</span><span class="p">)</span>

<span class="c1"># Iterate through each rainfall train point to add a label with its value to the plot</span>
<span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rain_train_gdf</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">Actual_Value</span><span class="p">,</span> <span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">y</span><span class="p">))</span>

<span class="c1"># Iterate through each rainfall test point to add a label with its value to the plot</span>
<span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rain_test_pred_tp</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">VALUE_Predict</span><span class="p">,</span> <span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">y</span><span class="p">))</span>

<span class="c1"># Set title</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;San Francisco Bay Area - Rainfall Measurement Locations &amp; Thiessen Polygons&#39;</span><span class="p">,</span> <span class="n">fontdict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;fontsize&#39;</span><span class="p">:</span> <span class="s1">&#39;15&#39;</span><span class="p">,</span> <span class="s1">&#39;fontweight&#39;</span> <span class="p">:</span> <span class="s1">&#39;3&#39;</span><span class="p">})</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0.5, 1.0, &#39;San Francisco Bay Area - Rainfall Measurement Locations &amp; Thiessen Polygons&#39;)
</pre></div>
</div>
<img alt="../_images/e_interpolation_19_1.png" src="../_images/e_interpolation_19_1.png" />
</div>
</div>
<p>In addition to <code class="docutils literal notranslate"><span class="pre">vertices</span></code>, there are a few other attributes we can call if we want to further explore the polygons. These attributes will provide actual values (e.g., vertices) or provide the indices for querying other attributes. <a class="footnote-reference brackets" href="#scipy-voronoi" id="id3">2</a></p>
<p>In the example below, we demonstrate how to extract the value of one of the Thiessen polygons at a new location for which we want a predicted value. We use the <code class="docutils literal notranslate"><span class="pre">point_region</span></code> attribute to provide the index of a point’s Voronoi region, and we use that index to get the region in <code class="docutils literal notranslate"><span class="pre">regions</span></code>. That provides indices of the vertices that make up the polygon, which we use to get the appropriate values in <code class="docutils literal notranslate"><span class="pre">vertices</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set index for feature of interest</span>
<span class="n">feature_index_one</span> <span class="o">=</span> <span class="mi">5</span>

<span class="c1"># Get a Voronoi polygon for one feature</span>
<span class="c1"># &#39;point_region&#39; attribute provides the index of the Voronoi region belonging to a specified point</span>
<span class="c1"># Can use the index to call the appropriate element in the &#39;regions&#39; attribute</span>
<span class="n">tp_poly_region_one</span> <span class="o">=</span> <span class="n">Polygon</span><span class="p">(</span><span class="n">tp</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="n">tp</span><span class="o">.</span><span class="n">regions</span><span class="p">[</span><span class="n">tp</span><span class="o">.</span><span class="n">point_region</span><span class="p">[</span><span class="n">feature_index_one</span><span class="p">]]])</span>

<span class="c1"># Create GeoDataFrame for polygon</span>
<span class="n">tp_poly_region_one</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">([</span><span class="n">tp_poly_region_one</span><span class="p">],</span> <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">],</span> <span class="n">crs</span> <span class="o">=</span> <span class="n">proj</span><span class="p">)</span>

<span class="c1"># Clip polygon to county boundary</span>
<span class="n">tp_poly_region_one</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">tp_poly_region_one</span><span class="p">,</span> <span class="n">counties_dissolved</span><span class="p">)</span>

<span class="c1"># Get the equivalent feature from the rainfall dataset</span>
<span class="n">rain_one</span> <span class="o">=</span> <span class="n">rain_train_gdf</span><span class="o">.</span><span class="n">iloc</span><span class="p">[[</span><span class="n">feature_index_one</span><span class="p">]]</span>

<span class="c1"># Add the rainfall value to the polygon attribute table</span>
<span class="n">tp_poly_region_one</span><span class="p">[</span><span class="s2">&quot;VALUE_Predict&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rain_one</span><span class="p">[</span><span class="s2">&quot;Actual_Value&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

<span class="c1"># Display attribute table</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Attribute Table: Thiessen Polygon Interpolated Value&quot;</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">tp_poly_region_one</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Attribute Table: Thiessen Polygon Interpolated Value
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>geometry</th>
      <th>VALUE_Predict</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>POLYGON ((-173793.383 -34945.420, -175342.667 ...</td>
      <td>38</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Here’s how that one Thiessen polygon looks.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create subplots</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

<span class="c1"># Stylize plots</span>
<span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;bmh&#39;</span><span class="p">)</span>

<span class="c1"># Plot data</span>
<span class="n">tp_poly_region_one</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;lightseagreen&#39;</span><span class="p">,</span> <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">linewidth</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">)</span>
<span class="n">rain_one</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span> <span class="n">marker</span> <span class="o">=</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;dimgray&#39;</span><span class="p">,</span> <span class="n">markersize</span> <span class="o">=</span> <span class="mi">100</span><span class="p">)</span>

<span class="c1"># Set title</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;San Francisco Bay Area - One Point and Thiessen Polygon&#39;</span><span class="p">,</span> <span class="n">fontdict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;fontsize&#39;</span><span class="p">:</span> <span class="s1">&#39;15&#39;</span><span class="p">,</span> <span class="s1">&#39;fontweight&#39;</span> <span class="p">:</span> <span class="s1">&#39;3&#39;</span><span class="p">})</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0.5, 1.0, &#39;San Francisco Bay Area - One Point and Thiessen Polygon&#39;)
</pre></div>
</div>
<img alt="../_images/e_interpolation_23_1.png" src="../_images/e_interpolation_23_1.png" />
</div>
</div>
</div>
<div class="section" id="k-nearest-neighbors">
<h3>K-Nearest Neighbors<a class="headerlink" href="#k-nearest-neighbors" title="Permalink to this headline">#</a></h3>
<p>KNN (also stylized as kNN) is a neighbor-based learning method that can be used for interpolation. Unlike the Thiessen polygons method, KNN looks for a specified number <code class="docutils literal notranslate"><span class="pre">K</span></code> of sampled points closest to an unknown point. The <code class="docutils literal notranslate"><span class="pre">K</span></code> known points can be used to predict the value (discrete or continuous) of the unknown point. <a class="footnote-reference brackets" href="#sk-nn" id="id4">3</a></p>
<p>We can use the <a class="reference external" href="https://scikit-learn.org/stable/modules/generated/sklearn.neighbors.KNeighborsRegressor.html"><code class="docutils literal notranslate"><span class="pre">scikit-learn</span></code> module</a> to perform KNN analysis.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set number of neighbors to look for</span>
<span class="n">neighbors</span> <span class="o">=</span> <span class="mi">5</span>

<span class="c1"># Initialize KNN regressor</span>
<span class="n">knn_regressor</span> <span class="o">=</span> <span class="n">KNeighborsRegressor</span><span class="p">(</span><span class="n">n_neighbors</span> <span class="o">=</span> <span class="n">neighbors</span><span class="p">,</span> <span class="n">weights</span> <span class="o">=</span> <span class="s2">&quot;distance&quot;</span><span class="p">)</span>

<span class="c1"># Fit regressor to data</span>
<span class="n">knn_regressor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">coords_rain_train</span><span class="p">,</span> <span class="n">value_rain_train</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>KNeighborsRegressor(weights=&#39;distance&#39;)
</pre></div>
</div>
</div>
</div>
<p>Now that we have created the KNN model, we can get the in-sample r-squared value. An in-sample statistic, as suggested by its name, is calculated by using the data that were used to build the model (the “training” dataset).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Generate in-sample R^2</span>
<span class="n">in_r_squared_knn</span> <span class="o">=</span> <span class="n">knn_regressor</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">coords_rain_train</span><span class="p">,</span> <span class="n">value_rain_train</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;KNN in-sample r-squared: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">in_r_squared_knn</span><span class="p">,</span> <span class="mi">2</span><span class="p">)))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>KNN in-sample r-squared: 1.0
</pre></div>
</div>
</div>
</div>
<p>Here, the in-sample r-squared value is 100% because KNN is a “exact interpolator.” For exact interpolators, estimated values for known points are exactly equal to actual values. Other methods like Kriging, shown below, are inexact interpolators. For inexact interpolators, estimated values for known points are not exactly equal to actual values. Here’s a <a class="reference external" href="https://www.onestopgis.com/GIS-Theory-and-Techniques/Spatial-Interpolation/Elements-of-Spatial-Interpolation/posts/Types-of-Spatial-Interpolation/Image-shows-Exact-interpolation-and-Inexact-interpolation.png?__cf_chl_jschl_tk__=231d8a46e00aa6fe5352048bff01af55174b6c40-1625260397-0-ARqVOIsPHXJ9wPUqWrXKldltKnf_3GrT_RVaKb7djF6cUYCwnIzVeYww8nW4e_3GiIiCNZ15eVXmksePbUz-sKbuHtD2UsSh9OWZ4w2Y2dS_zCeIMCVRUIrYCjZEEcH722m7Y2vCDGAaA6gh1RObvtBx_3Se3gCdldO6c65zunRmX4vE0jLONpdckY6MEo4YPiyZr_11QAdPLYBWwgtl3wC2XhM5mhsmVYmInXWYTiyr35sXWVn86DedDNC2rKMnvrQGo8BuBgjskX6uf_Y3tWWpYCpyghV9s0zpygqgTQYG8rNaKJyFFQdoX--tMMEYY2AwzAI2BNmAxlGlxM07tBndOjZFgphEsU9nbFhOAB-Wji4u0wwD_N97FBKdFwsNl8bGbPSpLoiIMZ94GVZqETiD29W_lFPsiunLAt3EU2Ra-pf2QC1lCaUUhUt2aCIgHH6SnzTAm-JictSfAD4cnYolpP7D27Cj_UOGLSfo2sk4KcOH9JAG3ZGF1UCkX2fBUTivVWmuYPL4l1xaGS7e0BgKuiz_TdAbeMNkyi2TtWgMzT2sZEqf5QXZzvSwbsOVf5Z8ph6imf4gaHYhhYU87yKTDkK8PnYkbuyS3zeDWnM7hTj-Gn-LtNSYpiTjA68NZA">visual of inexact versus exact interpolators</a>.</p>
<p>Similarily, we can also get the out-of-sample r-squared value and compare the test dataset’s actual values to the values as predicted by the model.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Generate out-of-sample R^2</span>
<span class="n">out_r_squared_knn</span> <span class="o">=</span> <span class="n">knn_regressor</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">coords_rain_test</span><span class="p">,</span> <span class="n">value_rain_test</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;KNN out-of-sample r-squared: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">out_r_squared_knn</span><span class="p">,</span> <span class="mi">2</span><span class="p">)))</span>

<span class="c1"># Predict values for testing dataset</span>
<span class="n">coords_rain_test_predict_knn</span> <span class="o">=</span> <span class="n">knn_regressor</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">coords_rain_test</span><span class="p">)</span>

<span class="c1"># Create dictionary holding the actual and predicted values</span>
<span class="n">predict_dict_knn</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Coordinate_Pair&quot;</span><span class="p">:</span> <span class="n">coords_rain_test</span><span class="p">,</span> <span class="s2">&quot;VALUE_Actual&quot;</span><span class="p">:</span> <span class="n">value_rain_test</span><span class="p">,</span> <span class="s2">&quot;VALUE_Predict&quot;</span><span class="p">:</span> <span class="n">coords_rain_test_predict_knn</span><span class="p">}</span>

<span class="c1"># Create dataframe from dictionary</span>
<span class="n">predict_df_knn</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">predict_dict_knn</span><span class="p">)</span>

<span class="c1"># Display attribute table</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Attribute Table: Testing Set Interpolated Values - KNN Method&quot;</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">predict_df_knn</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>KNN out-of-sample r-squared: 0.93

Attribute Table: Testing Set Interpolated Values - KNN Method
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Coordinate_Pair</th>
      <th>VALUE_Actual</th>
      <th>VALUE_Predict</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>[-229633.02624581114, 40063.75429398427]</td>
      <td>56</td>
      <td>55.827992</td>
    </tr>
    <tr>
      <th>1</th>
      <td>[-273849.3497429455, 92453.68931061402]</td>
      <td>73</td>
      <td>87.640078</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Out-of-sample r-squared looks pretty strong!</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>If you are just interested in identifying the <code class="docutils literal notranslate"><span class="pre">k</span></code> nearest neighbors (no interpolation), use the <a class="reference external" href="https://scikit-learn.org/stable/modules/generated/sklearn.neighbors.NearestNeighbors.html#sklearn.neighbors.NearestNeighbors"><code class="docutils literal notranslate"><span class="pre">NearestNeighbors()</span></code> function</a>.</p>
</div>
</div>
<div class="section" id="kriging">
<h3>Kriging<a class="headerlink" href="#kriging" title="Permalink to this headline">#</a></h3>
<p>Kriging is a type of interpolation that uses a semivariogram, which measures spatial autocorrelation (how similar close points are in value and how this similarity changes as distance between points increases). Thus, the semivariogram determines how much influence a known point has on an unknown point as the distance between the known point and the unknown point increases. In other words, the weight of a known point on an unknown point decreases with increasing distance, and the semivariogram determines how quickly that weight tapers with increasing distance. <a class="footnote-reference brackets" href="#bolstad" id="id5">1</a>, <a class="footnote-reference brackets" href="#esri-kriging" id="id6">4</a></p>
<p>For more information, see this <a class="reference external" href="https://pro.arcgis.com/en/pro-app/latest/tool-reference/3d-analyst/how-kriging-works.htm">ArcGIS help guide on kriging</a>.</p>
<p>Two Python packages that can be used for kriging include <code class="docutils literal notranslate"><span class="pre">scikit-learn</span></code> and <code class="docutils literal notranslate"><span class="pre">pykrige</span></code>. The former package works best when the input data has a WGS 84 projection, so we will begin by reprojecting all of our data to that coordinate system (click the + below to show code cell).</p>
<div class="cell tag_hide-cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd"># Set projection to WGS 84 and reproject data</span>
<span class="sd">proj_wgs = 4326</span>
<span class="sd">counties_wgs = counties.to_crs(proj_wgs)</span>
<span class="sd">rainfall_wgs = rainfall.to_crs(proj_wgs)</span>
<span class="sd">rain_train_gdf_wgs = rain_train_gdf.to_crs(proj_wgs)</span>
<span class="sd">rain_test_gdf_wgs = rain_test_gdf.to_crs(proj_wgs)</span>

<span class="sd"># Get X and Y coordinates of rainfall points</span>
<span class="sd">x_rain_wgs = rainfall_wgs[&quot;geometry&quot;].x</span>
<span class="sd">y_rain_wgs = rainfall_wgs[&quot;geometry&quot;].y</span>

<span class="sd"># Create list of XY coordinate pairs</span>
<span class="sd">coords_rain_train_wgs = [list(xy) for xy in zip(rain_train_gdf_wgs[&quot;geometry&quot;].x, rain_train_gdf_wgs[&quot;geometry&quot;].y)]</span>
<span class="sd">coords_rain_test_wgs = [list(xy) for xy in zip(rain_test_gdf_wgs[&quot;geometry&quot;].x, rain_test_gdf_wgs[&quot;geometry&quot;].y)]</span>

<span class="sd"># Get minimum and maximum coordinate values of rainfall points</span>
<span class="sd">min_x_rain_wgs, min_y_rain_wgs, max_x_rain_wgs, max_y_rain_wgs = rain_train_gdf_wgs.total_bounds</span>
<span class="sd">&#39;&#39;&#39;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;\n# Set projection to WGS 84 and reproject data\nproj_wgs = 4326\ncounties_wgs = counties.to_crs(proj_wgs)\nrainfall_wgs = rainfall.to_crs(proj_wgs)\nrain_train_gdf_wgs = rain_train_gdf.to_crs(proj_wgs)\nrain_test_gdf_wgs = rain_test_gdf.to_crs(proj_wgs)\n\n# Get X and Y coordinates of rainfall points\nx_rain_wgs = rainfall_wgs[&quot;geometry&quot;].x\ny_rain_wgs = rainfall_wgs[&quot;geometry&quot;].y\n\n# Create list of XY coordinate pairs\ncoords_rain_train_wgs = [list(xy) for xy in zip(rain_train_gdf_wgs[&quot;geometry&quot;].x, rain_train_gdf_wgs[&quot;geometry&quot;].y)]\ncoords_rain_test_wgs = [list(xy) for xy in zip(rain_test_gdf_wgs[&quot;geometry&quot;].x, rain_test_gdf_wgs[&quot;geometry&quot;].y)]\n\n# Get minimum and maximum coordinate values of rainfall points\nmin_x_rain_wgs, min_y_rain_wgs, max_x_rain_wgs, max_y_rain_wgs = rain_train_gdf_wgs.total_bounds\n&#39;
</pre></div>
</div>
</div>
</div>
<div class="section" id="method-1-using-pykrige">
<h4>Method 1 - Using <code class="docutils literal notranslate"><span class="pre">PyKrige</span></code><a class="headerlink" href="#method-1-using-pykrige" title="Permalink to this headline">#</a></h4>
<p>The <a class="reference external" href="https://geostat-framework.readthedocs.io/projects/pykrige/en/stable/index.html"><code class="docutils literal notranslate"><span class="pre">pykrige</span></code> module</a> offers ordinary and universal kriging. It also supports various variogram models in addition to Gaussian.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Adapted from: https://geostat-framework.readthedocs.io/projects/pykrige/en/latest/examples/04_krige_geometric.html</span>

<span class="c1"># Create a 100 by 100 grid</span>
<span class="c1"># Horizontal and vertical cell counts should be the same</span>
<span class="n">XX_pk_krig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">min_x_rain</span><span class="p">,</span> <span class="n">max_x_rain</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">YY_pk_krig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">min_y_rain</span><span class="p">,</span> <span class="n">max_y_rain</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>

<span class="c1"># Generate ordinary kriging object</span>
<span class="n">OK</span> <span class="o">=</span> <span class="n">OrdinaryKriging</span><span class="p">(</span>
    <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x_rain</span><span class="p">),</span>
    <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y_rain</span><span class="p">),</span>
    <span class="n">value_rain</span><span class="p">,</span>
    <span class="n">variogram_model</span> <span class="o">=</span> <span class="s2">&quot;linear&quot;</span><span class="p">,</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">enable_plotting</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">coordinates_type</span> <span class="o">=</span> <span class="s2">&quot;euclidean&quot;</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># Evaluate the method on grid</span>
<span class="n">Z_pk_krig</span><span class="p">,</span> <span class="n">sigma_squared_p_krig</span> <span class="o">=</span> <span class="n">OK</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;grid&quot;</span><span class="p">,</span> <span class="n">XX_pk_krig</span><span class="p">,</span> <span class="n">YY_pk_krig</span><span class="p">)</span>

<span class="c1"># Export raster</span>
<span class="n">export_kde_raster</span><span class="p">(</span><span class="n">Z</span> <span class="o">=</span> <span class="n">Z_pk_krig</span><span class="p">,</span> <span class="n">XX</span> <span class="o">=</span> <span class="n">XX_pk_krig</span><span class="p">,</span> <span class="n">YY</span> <span class="o">=</span> <span class="n">YY_pk_krig</span><span class="p">,</span>
                  <span class="n">min_x</span> <span class="o">=</span> <span class="n">min_x_rain</span><span class="p">,</span> <span class="n">max_x</span> <span class="o">=</span> <span class="n">max_x_rain</span><span class="p">,</span> <span class="n">min_y</span> <span class="o">=</span> <span class="n">min_y_rain</span><span class="p">,</span> <span class="n">max_y</span> <span class="o">=</span> <span class="n">max_y_rain</span><span class="p">,</span>
                  <span class="n">proj</span> <span class="o">=</span> <span class="n">proj</span><span class="p">,</span> <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;../temp/e_bay-area-rain_pk_kriging.tif&quot;</span><span class="p">)</span>

<span class="c1"># Open raster</span>
<span class="n">raster_pk</span> <span class="o">=</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;../temp/e_bay-area-rain_pk_kriging.tif&quot;</span><span class="p">)</span>


<span class="c1"># Create polygon with extent of raster</span>
<span class="n">poly_shapely</span> <span class="o">=</span> <span class="n">box</span><span class="p">(</span><span class="o">*</span><span class="n">raster_pk</span><span class="o">.</span><span class="n">bounds</span><span class="p">)</span>

<span class="c1"># Create a dictionary with needed attributes and required geometry column</span>
<span class="n">attributes_df</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Attribute&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;name1&#39;</span><span class="p">],</span> <span class="s1">&#39;geometry&#39;</span><span class="p">:</span> <span class="n">poly_shapely</span><span class="p">}</span>

<span class="c1"># Convert shapely object to a GeoDataFrame</span>
<span class="n">raster_pk_extent</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">attributes_df</span><span class="p">,</span> <span class="n">geometry</span> <span class="o">=</span> <span class="s1">&#39;geometry&#39;</span><span class="p">,</span> <span class="n">crs</span> <span class="o">=</span> <span class="n">proj</span><span class="p">)</span>

<span class="c1"># Create copy of test dataset</span>
<span class="n">rain_test_gdf_pk_krig</span> <span class="o">=</span> <span class="n">rain_test_gdf</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="c1"># Subset the GeoDataFrame by checking which test points are within the raster extent polygon</span>
<span class="c1"># If a test point is beyond the extent of training points dataset, the kriging output may not cover that test point</span>
<span class="n">rain_test_gdf_pk_krig</span> <span class="o">=</span> <span class="n">rain_test_gdf_pk_krig</span><span class="p">[</span><span class="n">rain_test_gdf_pk_krig</span><span class="o">.</span><span class="n">within</span><span class="p">(</span><span class="n">raster_pk_extent</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>

<span class="c1"># Create list of XY coordinate pairs for the test points that fall within raster extent polygon</span>
<span class="n">coords_rain_test_pk_krig</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">xy</span><span class="p">)</span> <span class="k">for</span> <span class="n">xy</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">rain_test_gdf_pk_krig</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">rain_test_gdf_pk_krig</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="p">)]</span>

<span class="c1"># Extract raster value at each test point and add the values to the GeoDataFrame</span>
<span class="n">rain_test_gdf_pk_krig</span><span class="p">[</span><span class="s2">&quot;VALUE_Predict&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">raster_pk</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">coords_rain_test_pk_krig</span><span class="p">)]</span>

<span class="c1"># Generate out-of-sample R^2</span>
<span class="n">out_r_squared_tp</span> <span class="o">=</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">rain_test_gdf_pk_krig</span><span class="o">.</span><span class="n">Actual_Value</span><span class="p">,</span> <span class="n">rain_test_gdf_pk_krig</span><span class="o">.</span><span class="n">VALUE_Predict</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;PyKrige Kriging out-of-sample r-squared: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">out_r_squared_tp</span><span class="p">,</span> <span class="mi">2</span><span class="p">)))</span>

<span class="c1"># Display attribute table</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Attribute Table: Random Points Interpolated Values - PyKrige Kriging Method&quot;</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">rain_test_gdf_pk_krig</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>


<span class="c1"># Mask raster to counties shape</span>
<span class="n">out_image_pk</span><span class="p">,</span> <span class="n">out_transform_pk</span> <span class="o">=</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">mask</span><span class="o">.</span><span class="n">mask</span><span class="p">(</span><span class="n">raster_pk</span><span class="p">,</span> <span class="n">counties</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">crop</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

<span class="c1"># Stylize plots</span>
<span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;bmh&#39;</span><span class="p">)</span>

<span class="c1"># Plot data</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="n">show</span><span class="p">(</span><span class="n">out_image_pk</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span> <span class="n">transform</span> <span class="o">=</span> <span class="n">out_transform_pk</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="s2">&quot;RdPu&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_rain</span><span class="p">,</span> <span class="n">y_rain</span><span class="p">,</span> <span class="s1">&#39;k.&#39;</span><span class="p">,</span> <span class="n">markersize</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">)</span>
<span class="n">counties</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;dimgray&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span>

<span class="c1"># Set title</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;San Francisco Bay Area - Interpolating Rainfall using Kriging from PyKrige&#39;</span><span class="p">,</span> <span class="n">fontdict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;fontsize&#39;</span><span class="p">:</span> <span class="s1">&#39;15&#39;</span><span class="p">,</span> <span class="s1">&#39;fontweight&#39;</span> <span class="p">:</span> <span class="s1">&#39;3&#39;</span><span class="p">})</span>

<span class="c1"># Display plot</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>PyKrige Kriging out-of-sample r-squared: 0.99

Attribute Table: Random Points Interpolated Values - PyKrige Kriging Method
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>geometry</th>
      <th>Actual_Value</th>
      <th>VALUE_Predict</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>POINT (-229633.026 40063.754)</td>
      <td>56</td>
      <td>55.089479</td>
    </tr>
    <tr>
      <th>2</th>
      <td>POINT (-244809.950 1296.393)</td>
      <td>62</td>
      <td>61.013348</td>
    </tr>
  </tbody>
</table>
</div></div><img alt="../_images/e_interpolation_34_2.png" src="../_images/e_interpolation_34_2.png" />
</div>
</div>
</div>
<div class="section" id="method-2-using-scikit-learn">
<h4>Method 2- Using <code class="docutils literal notranslate"><span class="pre">scikit-learn</span></code><a class="headerlink" href="#method-2-using-scikit-learn" title="Permalink to this headline">#</a></h4>
<p>Kriging can be performed using <a class="reference external" href="https://scikit-learn.org/stable/modules/gaussian_process.html">Gaussian processes from the <code class="docutils literal notranslate"><span class="pre">scikit-learn</span></code> module</a> (Gaussian processes is essentially equivalent to kriging). Various kernels for Gaussian processes can be specified. We will continue to use the training and testing datasets created from our KNN analysis.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd"># Create a 100 by 100 cell mesh grid</span>
<span class="sd"># Horizontal and vertical cell counts should be the same</span>
<span class="sd">XX_sk_krig, YY_sk_krig = np.mgrid[min_x_rain_wgs:max_x_rain_wgs:100j, min_y_rain_wgs:max_y_rain_wgs:100j]</span>

<span class="sd"># Create 2-D array of the coordinates (paired) of each cell in the mesh grid</span>
<span class="sd">positions_sk_krig = np.vstack([XX_sk_krig.ravel(), YY_sk_krig.ravel()]).T</span>

<span class="sd"># Generate Gaussian Process model (can change parameters as desired)</span>
<span class="sd">gp = GaussianProcessRegressor(n_restarts_optimizer = 10)</span>

<span class="sd"># Fit kernel density estimator to coordinates and values</span>
<span class="sd">gp.fit(coords_rain_train_wgs, value_rain_train)</span>

<span class="sd"># Evaluate the model on coordinate pairs</span>
<span class="sd">Z_sk_krig = gp.predict(positions_sk_krig)</span>

<span class="sd"># Reshape the data to fit mesh grid</span>
<span class="sd">Z_sk_krig = Z_sk_krig.reshape(XX_sk_krig.shape)</span>
<span class="sd">&#39;&#39;&#39;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;\n# Create a 100 by 100 cell mesh grid\n# Horizontal and vertical cell counts should be the same\nXX_sk_krig, YY_sk_krig = np.mgrid[min_x_rain_wgs:max_x_rain_wgs:100j, min_y_rain_wgs:max_y_rain_wgs:100j]\n\n# Create 2-D array of the coordinates (paired) of each cell in the mesh grid\npositions_sk_krig = np.vstack([XX_sk_krig.ravel(), YY_sk_krig.ravel()]).T\n\n# Generate Gaussian Process model (can change parameters as desired)\ngp = GaussianProcessRegressor(n_restarts_optimizer = 10)\n\n# Fit kernel density estimator to coordinates and values\ngp.fit(coords_rain_train_wgs, value_rain_train)\n\n# Evaluate the model on coordinate pairs\nZ_sk_krig = gp.predict(positions_sk_krig)\n\n# Reshape the data to fit mesh grid\nZ_sk_krig = Z_sk_krig.reshape(XX_sk_krig.shape)\n&#39;
</pre></div>
</div>
</div>
</div>
<p>Next, we can calculate our r-squared statistics and predictions.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd"># Generate in-sample R^2</span>
<span class="sd">in_r_squared_sk_krig = gp.score(coords_rain_train_wgs, value_rain_train)</span>
<span class="sd">print(&quot;Scikit-Learn Kriging in-sample r-squared: {}&quot;.format(round(in_r_squared_sk_krig, 2)))</span>

<span class="sd"># Generate out-of-sample R^2</span>
<span class="sd">out_r_squared_sk_krig = gp.score(coords_rain_test_wgs, value_rain_test)</span>
<span class="sd">print(&quot;Scikit-Learn Kriging out-of-sample r-squared: {}&quot;.format(round(out_r_squared_sk_krig, 2)))</span>

<span class="sd"># Predict values for testing dataset</span>
<span class="sd">coords_rain_test_predict_sk_krig = gp.predict(coords_rain_test_wgs)</span>

<span class="sd"># Create dictionary holding the actual and predicted values</span>
<span class="sd">predict_dict_sk_krig = {&quot;Coordinate_Pair&quot;: coords_rain_test_wgs, &quot;VALUE_Actual&quot;: value_rain_test, &quot;VALUE_Predict&quot;: coords_rain_test_predict_sk_krig}</span>

<span class="sd"># Create dataframe from dictionary</span>
<span class="sd">predict_df_sk_krig = pd.DataFrame(predict_dict_sk_krig)</span>

<span class="sd"># Display attribute table</span>
<span class="sd">print(&quot;\nAttribute Table: Testing Set Interpolated Values - Scikit-Learn Kriging Method&quot;)</span>
<span class="sd">display(predict_df_sk_krig.head(2))</span>
<span class="sd">&#39;&#39;&#39;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;\n# Generate in-sample R^2\nin_r_squared_sk_krig = gp.score(coords_rain_train_wgs, value_rain_train)\nprint(&quot;Scikit-Learn Kriging in-sample r-squared: {}&quot;.format(round(in_r_squared_sk_krig, 2)))\n\n# Generate out-of-sample R^2\nout_r_squared_sk_krig = gp.score(coords_rain_test_wgs, value_rain_test)\nprint(&quot;Scikit-Learn Kriging out-of-sample r-squared: {}&quot;.format(round(out_r_squared_sk_krig, 2)))\n\n# Predict values for testing dataset\ncoords_rain_test_predict_sk_krig = gp.predict(coords_rain_test_wgs)\n\n# Create dictionary holding the actual and predicted values\npredict_dict_sk_krig = {&quot;Coordinate_Pair&quot;: coords_rain_test_wgs, &quot;VALUE_Actual&quot;: value_rain_test, &quot;VALUE_Predict&quot;: coords_rain_test_predict_sk_krig}\n\n# Create dataframe from dictionary\npredict_df_sk_krig = pd.DataFrame(predict_dict_sk_krig)\n\n# Display attribute table\nprint(&quot;\nAttribute Table: Testing Set Interpolated Values - Scikit-Learn Kriging Method&quot;)\ndisplay(predict_df_sk_krig.head(2))\n&#39;
</pre></div>
</div>
</div>
</div>
<p>Model seems like a good fit! Let’s export the raster.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd"># Flip array vertically and rotate 270 degrees</span>
<span class="sd">Z_sk_krig = np.rot90(np.flip(Z_sk_krig, 0), 3)</span>

<span class="sd"># Export raster</span>
<span class="sd">export_kde_raster(Z = Z_sk_krig, XX = XX_sk_krig, YY = YY_sk_krig,</span>
<span class="sd">                  min_x = min_x_rain_wgs, max_x = max_x_rain_wgs, min_y = min_y_rain_wgs, max_y = max_y_rain_wgs,</span>
<span class="sd">                  proj = proj_wgs, filename = ../temp/e_bay-area-rain_sk_kriging.tif&quot;)</span>
<span class="sd">&#39;&#39;&#39;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;\n# Flip array vertically and rotate 270 degrees\nZ_sk_krig = np.rot90(np.flip(Z_sk_krig, 0), 3)\n\n# Export raster\nexport_kde_raster(Z = Z_sk_krig, XX = XX_sk_krig, YY = YY_sk_krig,\n                  min_x = min_x_rain_wgs, max_x = max_x_rain_wgs, min_y = min_y_rain_wgs, max_y = max_y_rain_wgs,\n                  proj = proj_wgs, filename = ../temp/e_bay-area-rain_sk_kriging.tif&quot;)\n&#39;
</pre></div>
</div>
</div>
</div>
<div class="admonition attention">
<p class="admonition-title">Attention</p>
<p>The resulting raster should be clipped. Because the resulting raster covers the extent of the points in a bounding box fashion, the raster in this case covers areas that are not within the counties boundaries (such as in the ocean) where we do not have sample points. Thus, there will be interpolated values in those areas that might not make sense.</p>
</div>
<p>Finally, we import the raster, mask it to the counties boundaries, and plot the data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd"># Open raster</span>
<span class="sd">raster_sk = rasterio.open(&quot;../temp/e_bay-area-rain_sk_kriging.tif&quot;)</span>

<span class="sd"># Mask raster to counties shape</span>
<span class="sd">out_image_sk, out_transform_sk = rasterio.mask.mask(raster_sk, counties_wgs.geometry.values, crop = True)</span>

<span class="sd"># Stylize plots</span>
<span class="sd">plt.style.use(&#39;bmh&#39;)</span>
<span class="sd">&#39;&#39;&#39;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;\n# Open raster\nraster_sk = rasterio.open(&quot;../temp/e_bay-area-rain_sk_kriging.tif&quot;)\n\n# Mask raster to counties shape\nout_image_sk, out_transform_sk = rasterio.mask.mask(raster_sk, counties_wgs.geometry.values, crop = True)\n\n# Stylize plots\nplt.style.use(\&#39;bmh\&#39;)\n&#39;
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="id7">
<h4>Method 2- Using <code class="docutils literal notranslate"><span class="pre">scikit-learn</span></code><a class="headerlink" href="#id7" title="Permalink to this headline">#</a></h4>
<p>Kriging can be performed using <a class="reference external" href="https://scikit-learn.org/stable/modules/gaussian_process.html">Gaussian processes from the <code class="docutils literal notranslate"><span class="pre">scikit-learn</span></code> module</a> (Gaussian processes is essentially equivalent to kriging). Various kernels for Gaussian processes can be specified. We will continue to use the training and testing datasets created from our KNN analysis.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd"># Create a 100 by 100 cell mesh grid</span>
<span class="sd"># Horizontal and vertical cell counts should be the same</span>
<span class="sd">XX_sk_krig, YY_sk_krig = np.mgrid[min_x_rain_wgs:max_x_rain_wgs:100j, min_y_rain_wgs:max_y_rain_wgs:100j]</span>

<span class="sd"># Create 2-D array of the coordinates (paired) of each cell in the mesh grid</span>
<span class="sd">positions_sk_krig = np.vstack([XX_sk_krig.ravel(), YY_sk_krig.ravel()]).T</span>

<span class="sd"># Generate Gaussian Process model (can change parameters as desired)</span>
<span class="sd">gp = GaussianProcessRegressor(n_restarts_optimizer = 10)</span>

<span class="sd"># Fit kernel density estimator to coordinates and values</span>
<span class="sd">gp.fit(coords_rain_train_wgs, value_rain_train)</span>

<span class="sd"># Evaluate the model on coordinate pairs</span>
<span class="sd">Z_sk_krig = gp.predict(positions_sk_krig)</span>

<span class="sd"># Reshape the data to fit mesh grid</span>
<span class="sd">Z_sk_krig = Z_sk_krig.reshape(XX_sk_krig.shape)</span>
<span class="sd">&#39;&#39;&#39;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;\n# Create a 100 by 100 cell mesh grid\n# Horizontal and vertical cell counts should be the same\nXX_sk_krig, YY_sk_krig = np.mgrid[min_x_rain_wgs:max_x_rain_wgs:100j, min_y_rain_wgs:max_y_rain_wgs:100j]\n\n# Create 2-D array of the coordinates (paired) of each cell in the mesh grid\npositions_sk_krig = np.vstack([XX_sk_krig.ravel(), YY_sk_krig.ravel()]).T\n\n# Generate Gaussian Process model (can change parameters as desired)\ngp = GaussianProcessRegressor(n_restarts_optimizer = 10)\n\n# Fit kernel density estimator to coordinates and values\ngp.fit(coords_rain_train_wgs, value_rain_train)\n\n# Evaluate the model on coordinate pairs\nZ_sk_krig = gp.predict(positions_sk_krig)\n\n# Reshape the data to fit mesh grid\nZ_sk_krig = Z_sk_krig.reshape(XX_sk_krig.shape)\n&#39;
</pre></div>
</div>
</div>
</div>
<p>Next, we can calculate our r-squared statistics and predictions.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd"># Generate in-sample R^2</span>
<span class="sd">in_r_squared_sk_krig = gp.score(coords_rain_train_wgs, value_rain_train)</span>
<span class="sd">print(&quot;Scikit-Learn Kriging in-sample r-squared: {}&quot;.format(round(in_r_squared_sk_krig, 2)))</span>

<span class="sd"># Generate out-of-sample R^2</span>
<span class="sd">out_r_squared_sk_krig = gp.score(coords_rain_test_wgs, value_rain_test)</span>
<span class="sd">print(&quot;Scikit-Learn Kriging out-of-sample r-squared: {}&quot;.format(round(out_r_squared_sk_krig, 2)))</span>

<span class="sd"># Predict values for testing dataset</span>
<span class="sd">coords_rain_test_predict_sk_krig = gp.predict(coords_rain_test_wgs)</span>

<span class="sd"># Create dictionary holding the actual and predicted values</span>
<span class="sd">predict_dict_sk_krig = {&quot;Coordinate_Pair&quot;: coords_rain_test_wgs, &quot;VALUE_Actual&quot;: value_rain_test, &quot;VALUE_Predict&quot;: coords_rain_test_predict_sk_krig}</span>

<span class="sd"># Create dataframe from dictionary</span>
<span class="sd">predict_df_sk_krig = pd.DataFrame(predict_dict_sk_krig)</span>

<span class="sd"># Display attribute table</span>
<span class="sd">print(&quot;\nAttribute Table: Testing Set Interpolated Values - Scikit-Learn Kriging Method&quot;)</span>
<span class="sd">display(predict_df_sk_krig.head(2))</span>
<span class="sd">&#39;&#39;&#39;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;\n# Generate in-sample R^2\nin_r_squared_sk_krig = gp.score(coords_rain_train_wgs, value_rain_train)\nprint(&quot;Scikit-Learn Kriging in-sample r-squared: {}&quot;.format(round(in_r_squared_sk_krig, 2)))\n\n# Generate out-of-sample R^2\nout_r_squared_sk_krig = gp.score(coords_rain_test_wgs, value_rain_test)\nprint(&quot;Scikit-Learn Kriging out-of-sample r-squared: {}&quot;.format(round(out_r_squared_sk_krig, 2)))\n\n# Predict values for testing dataset\ncoords_rain_test_predict_sk_krig = gp.predict(coords_rain_test_wgs)\n\n# Create dictionary holding the actual and predicted values\npredict_dict_sk_krig = {&quot;Coordinate_Pair&quot;: coords_rain_test_wgs, &quot;VALUE_Actual&quot;: value_rain_test, &quot;VALUE_Predict&quot;: coords_rain_test_predict_sk_krig}\n\n# Create dataframe from dictionary\npredict_df_sk_krig = pd.DataFrame(predict_dict_sk_krig)\n\n# Display attribute table\nprint(&quot;\nAttribute Table: Testing Set Interpolated Values - Scikit-Learn Kriging Method&quot;)\ndisplay(predict_df_sk_krig.head(2))\n&#39;
</pre></div>
</div>
</div>
</div>
<p>Model seems like a good fit! Let’s export the raster.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd"># Flip array vertically and rotate 270 degrees</span>
<span class="sd">Z_sk_krig = np.rot90(np.flip(Z_sk_krig, 0), 3)</span>

<span class="sd"># Export raster</span>
<span class="sd">export_kde_raster(Z = Z_sk_krig, XX = XX_sk_krig, YY = YY_sk_krig,</span>
<span class="sd">                  min_x = min_x_rain_wgs, max_x = max_x_rain_wgs, min_y = min_y_rain_wgs, max_y = max_y_rain_wgs,</span>
<span class="sd">                  proj = proj_wgs, filename = ../temp/e_bay-area-rain_sk_kriging.tif&quot;)</span>
<span class="sd">&#39;&#39;&#39;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;\n# Flip array vertically and rotate 270 degrees\nZ_sk_krig = np.rot90(np.flip(Z_sk_krig, 0), 3)\n\n# Export raster\nexport_kde_raster(Z = Z_sk_krig, XX = XX_sk_krig, YY = YY_sk_krig,\n                  min_x = min_x_rain_wgs, max_x = max_x_rain_wgs, min_y = min_y_rain_wgs, max_y = max_y_rain_wgs,\n                  proj = proj_wgs, filename = ../temp/e_bay-area-rain_sk_kriging.tif&quot;)\n&#39;
</pre></div>
</div>
</div>
</div>
<div class="admonition attention">
<p class="admonition-title">Attention</p>
<p>The resulting raster should be clipped. Because the resulting raster covers the extent of the points in a bounding box fashion, the raster in this case covers areas that are not within the counties boundaries (such as in the ocean) where we do not have sample points. Thus, there will be interpolated values in those areas that might not make sense.</p>
</div>
<p>Finally, we import the raster, mask it to the counties boundaries, and plot the data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd"># Open raster</span>
<span class="sd">raster_sk = rasterio.open(&quot;../temp/e_bay-area-rain_sk_kriging.tif&quot;)</span>

<span class="sd"># Mask raster to counties shape</span>
<span class="sd">out_image_sk, out_transform_sk = rasterio.mask.mask(raster_sk, counties_wgs.geometry.values, crop = True)</span>

<span class="sd"># Stylize plots</span>
<span class="sd">plt.style.use(&#39;bmh&#39;)</span>

<span class="sd"># Plot data</span>
<span class="sd">fig, ax = plt.subplots(1, figsize = (10, 10))</span>
<span class="sd">show(out_image_sk, ax = ax, transform = out_transform_sk, cmap = &quot;RdPu&quot;)</span>
<span class="sd">ax.plot(x_rain_wgs, y_rain_wgs, &#39;k.&#39;, markersize = 2, alpha = 0.5)</span>
<span class="sd">counties_wgs.plot(ax = ax, color = &#39;none&#39;, edgecolor = &#39;dimgray&#39;)</span>
<span class="sd">plt.gca().invert_yaxis()</span>

<span class="sd"># Set title</span>
<span class="sd">ax.set_title(&#39;San Francisco Bay Area - Interpolating Rainfall using Kriging from Scikit-Learn&#39;, fontdict = {&#39;fontsize&#39;: &#39;15&#39;, &#39;fontweight&#39; : &#39;3&#39;})</span>

<span class="sd"># Display plot</span>
<span class="sd">plt.show()</span>


<span class="sd"># Plot data</span>
<span class="sd">fig, ax = plt.subplots(1, figsize = (10, 10))</span>
<span class="sd">show(out_image_sk, ax = ax, transform = out_transform_sk, cmap = &quot;RdPu&quot;)</span>
<span class="sd">ax.plot(x_rain_wgs, y_rain_wgs, &#39;k.&#39;, markersize = 2, alpha = 0.5)</span>
<span class="sd">counties_wgs.plot(ax = ax, color = &#39;none&#39;, edgecolor = &#39;dimgray&#39;)</span>
<span class="sd">plt.gca().invert_yaxis()</span>

<span class="sd"># Set title</span>
<span class="sd">ax.set_title(&#39;San Francisco Bay Area - Interpolating Rainfall using Kriging from Scikit-Learn&#39;, fontdict = {&#39;fontsize&#39;: &#39;15&#39;, &#39;fontweight&#39; : &#39;3&#39;})</span>

<span class="sd"># Display plot</span>
<span class="sd">plt.show()</span>
<span class="sd">&#39;&#39;&#39;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;\n# Open raster\nraster_sk = rasterio.open(&quot;../temp/e_bay-area-rain_sk_kriging.tif&quot;)\n\n# Mask raster to counties shape\nout_image_sk, out_transform_sk = rasterio.mask.mask(raster_sk, counties_wgs.geometry.values, crop = True)\n\n# Stylize plots\nplt.style.use(\&#39;bmh\&#39;)\n\n# Plot data\nfig, ax = plt.subplots(1, figsize = (10, 10))\nshow(out_image_sk, ax = ax, transform = out_transform_sk, cmap = &quot;RdPu&quot;)\nax.plot(x_rain_wgs, y_rain_wgs, \&#39;k.\&#39;, markersize = 2, alpha = 0.5)\ncounties_wgs.plot(ax = ax, color = \&#39;none\&#39;, edgecolor = \&#39;dimgray\&#39;)\nplt.gca().invert_yaxis()\n\n# Set title\nax.set_title(\&#39;San Francisco Bay Area - Interpolating Rainfall using Kriging from Scikit-Learn\&#39;, fontdict = {\&#39;fontsize\&#39;: \&#39;15\&#39;, \&#39;fontweight\&#39; : \&#39;3\&#39;})\n\n# Display plot\nplt.show()\n\n\n# Plot data\nfig, ax = plt.subplots(1, figsize = (10, 10))\nshow(out_image_sk, ax = ax, transform = out_transform_sk, cmap = &quot;RdPu&quot;)\nax.plot(x_rain_wgs, y_rain_wgs, \&#39;k.\&#39;, markersize = 2, alpha = 0.5)\ncounties_wgs.plot(ax = ax, color = \&#39;none\&#39;, edgecolor = \&#39;dimgray\&#39;)\nplt.gca().invert_yaxis()\n\n# Set title\nax.set_title(\&#39;San Francisco Bay Area - Interpolating Rainfall using Kriging from Scikit-Learn\&#39;, fontdict = {\&#39;fontsize\&#39;: \&#39;15\&#39;, \&#39;fontweight\&#39; : \&#39;3\&#39;})\n\n# Display plot\nplt.show()\n&#39;
</pre></div>
</div>
</div>
</div>
<hr class="footnotes docutils" />
<dl class="footnote brackets">
<dt class="label" id="bolstad"><span class="brackets">1</span><span class="fn-backref">(<a href="#id1">1</a>,<a href="#id2">2</a>,<a href="#id5">3</a>)</span></dt>
<dd><p>GIS Fundamentals: A First Text on Geographic Information Systems, 5th ed., Paul Bolstad</p>
</dd>
<dt class="label" id="scipy-voronoi"><span class="brackets"><a class="fn-backref" href="#id3">2</a></span></dt>
<dd><p><a class="reference external" href="https://docs.scipy.org/doc/scipy/reference/generated/scipy.spatial.Voronoi.html">scipy.spatial.Voronoi, SciPy</a></p>
</dd>
<dt class="label" id="sk-nn"><span class="brackets"><a class="fn-backref" href="#id4">3</a></span></dt>
<dd><p><a class="reference external" href="https://scikit-learn.org/stable/modules/neighbors.html">Nearest Neighbors, scikit-learn</a></p>
</dd>
<dt class="label" id="esri-kriging"><span class="brackets"><a class="fn-backref" href="#id6">4</a></span></dt>
<dd><p><a class="reference external" href="https://pro.arcgis.com/en/pro-app/latest/tool-reference/3d-analyst/how-kriging-works.htm">How Kriging works, Esri</a></p>
</dd>
</dl>
</div>
</div>
</div>
</div>
<div class="toctree-wrapper compound">
<span id="document-docs/e_new_rasters"></span><hr class="docutils" id="e-raster-reproject" />
<div class="admonition-learning-objectives admonition">
<p class="admonition-title">Learning Objectives</p>
<ul class="simple">
<li><p>Creating raster data with Rasterio</p></li>
<li><p>Creating raster data with Rasterio</p></li>
</ul>
</div>
<div class="admonition-review admonition">
<p class="admonition-title">Review</p>
<ul class="simple">
<li><p><a class="reference internal" href="docs/a_intro.html#document-docs/d_affine"><span class="doc std std-doc">Affine transformation</span></a></p></li>
<li><p><a class="reference internal" href="docs/a_intro.html#document-docs/d_raster_crs_intro"><span class="doc std std-doc">Raster Coordinate Reference Systems</span></a></p></li>
<li><p><a class="reference internal" href="docs/a_intro.html#document-docs/c_rasters"><span class="doc std std-doc">Spatial Raster Data</span></a></p></li>
</ul>
</div>
<hr class="docutils" />
<div class="tex2jax_ignore mathjax_ignore section" id="reading-writing-rasters-with-rasterio">
<h2>Reading &amp; Writing Rasters with Rasterio<a class="headerlink" href="#reading-writing-rasters-with-rasterio" title="Permalink to this headline">#</a></h2>
<p>In order to work with raster data we will be using <code class="docutils literal notranslate"><span class="pre">rasterio</span></code> and later <code class="docutils literal notranslate"><span class="pre">geowombat</span></code>. Behind the scenes a <code class="docutils literal notranslate"><span class="pre">numpy.ndarray</span></code> does all the heavy lifting. To understand how raster works it helps to construct one from scratch.</p>
<p>Here we create two <code class="docutils literal notranslate"><span class="pre">ndarray</span></code> objects one <code class="docutils literal notranslate"><span class="pre">X</span></code> spans [-90°,90°] longitude, and <code class="docutils literal notranslate"><span class="pre">Y</span></code> covers [-90°,90°] latitude.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">90</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">90</span><span class="p">,</span> <span class="o">-</span><span class="mi">90</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
<span class="n">X</span><span class="p">,</span> <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<span class="n">X</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[-90., -54., -18.,  18.,  54.,  90.],
       [-90., -54., -18.,  18.,  54.,  90.],
       [-90., -54., -18.,  18.,  54.,  90.],
       [-90., -54., -18.,  18.,  54.,  90.],
       [-90., -54., -18.,  18.,  54.,  90.],
       [-90., -54., -18.,  18.,  54.,  90.]])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Y</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[ 90.,  90.,  90.,  90.,  90.,  90.],
       [ 54.,  54.,  54.,  54.,  54.,  54.],
       [ 18.,  18.,  18.,  18.,  18.,  18.],
       [-18., -18., -18., -18., -18., -18.],
       [-54., -54., -54., -54., -54., -54.],
       [-90., -90., -90., -90., -90., -90.]])
</pre></div>
</div>
</div>
</div>
<p>Let’s generate some data representing temperature and store it an array <code class="docutils literal notranslate"><span class="pre">Z</span></code></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="n">Z1</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(((</span><span class="n">X</span> <span class="o">-</span> <span class="mi">10</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">Y</span> <span class="o">-</span> <span class="mi">10</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">Z2</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(((</span><span class="n">X</span> <span class="o">+</span> <span class="mi">10</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">Y</span> <span class="o">+</span> <span class="mi">10</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.5</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">Z</span> <span class="o">=</span>  <span class="p">(</span><span class="n">Z1</span> <span class="o">-</span> <span class="n">Z2</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">Z</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Temperature&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/e_new_rasters_4_0.png" src="../_images/e_new_rasters_4_0.png" />
</div>
</div>
<div class="section" id="creating-raster-data">
<h3>Creating Raster Data<a class="headerlink" href="#creating-raster-data" title="Permalink to this headline">#</a></h3>
<p>The final array <code class="docutils literal notranslate"><span class="pre">Z</span></code> still lacks a number of elements that transform it from being a non-spatial <code class="docutils literal notranslate"><span class="pre">numpy</span></code> array to a spatial one usable by <code class="docutils literal notranslate"><span class="pre">rasterio</span></code> etc. <code class="docutils literal notranslate"><span class="pre">Rasterio</span></code> requires the following elements to write out a geotif, or spatial raster dataset:</p>
<table class="colwidths-auto docutils align-default">
<thead>
<tr class="row-odd"><th class="text-align:left head"><p>Parameters</p></th>
<th class="text-align:right head"><p>Description</p></th>
<th class="text-align:right head"><p>Argument</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td class="text-align:left"><p>driver</p></td>
<td class="text-align:right"><p>the name of the desired format driver</p></td>
<td class="text-align:right"><p><code class="docutils literal notranslate"><span class="pre">'GTiff'</span></code></p></td>
</tr>
<tr class="row-odd"><td class="text-align:left"><p>width</p></td>
<td class="text-align:right"><p>the number of columns of the dataset</p></td>
<td class="text-align:right"><p><code class="docutils literal notranslate"><span class="pre">Z.shape[1]</span></code></p></td>
</tr>
<tr class="row-even"><td class="text-align:left"><p>height</p></td>
<td class="text-align:right"><p>the number of rows of the dataset</p></td>
<td class="text-align:right"><p><code class="docutils literal notranslate"><span class="pre">Z.shape[0]</span></code></p></td>
</tr>
<tr class="row-odd"><td class="text-align:left"><p>count</p></td>
<td class="text-align:right"><p>a count of the dataset bands</p></td>
<td class="text-align:right"><p><code class="docutils literal notranslate"><span class="pre">1</span></code></p></td>
</tr>
<tr class="row-even"><td class="text-align:left"><p>dtype</p></td>
<td class="text-align:right"><p>the data type of the dataset</p></td>
<td class="text-align:right"><p><code class="docutils literal notranslate"><span class="pre">Z.dtype</span></code></p></td>
</tr>
<tr class="row-odd"><td class="text-align:left"><p>crs</p></td>
<td class="text-align:right"><p>a coordinate reference system identifier or description</p></td>
<td class="text-align:right"><p><code class="docutils literal notranslate"><span class="pre">'+proj=latlong'</span></code></p></td>
</tr>
<tr class="row-even"><td class="text-align:left"><p>transform</p></td>
<td class="text-align:right"><p>an affine transformation matrix</p></td>
<td class="text-align:right"><p><code class="docutils literal notranslate"><span class="pre">Affine.translation(x[0]</span> <span class="pre">-</span> <span class="pre">xres</span> <span class="pre">/</span> <span class="pre">2,</span> <span class="pre">y[0]</span> <span class="pre">-</span> <span class="pre">yres</span> <span class="pre">/</span> <span class="pre">2)</span> <span class="pre">*</span> <span class="pre">Affine.scale(xres,</span> <span class="pre">yres)</span></code></p></td>
</tr>
<tr class="row-odd"><td class="text-align:left"><p>nodata</p></td>
<td class="text-align:right"><p>a “nodata” value</p></td>
<td class="text-align:right"><p><code class="docutils literal notranslate"><span class="pre">-9999</span></code></p></td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code class="docutils literal notranslate"><span class="pre">transform</span></code> defines the location of the upper left hand corner of the raster on the globe, and its spatial resolution. The arguments for <code class="docutils literal notranslate"><span class="pre">transform</span></code> are complex and beyond the scope of the chapter, please refer to the next chapter &#64; <a class="reference internal" href="docs/a_intro.html#document-docs/d_affine"><span class="doc std std-doc">affine transforms</span></a> and <a class="reference internal" href="docs/a_intro.html#document-docs/d_raster_crs_intro"><span class="doc std std-doc">raster crs</span></a> for more info.</p>
</div>
</div>
<div class="section" id="writing-rasters">
<h3>Writing Rasters<a class="headerlink" href="#writing-rasters" title="Permalink to this headline">#</a></h3>
<p>To save this array along with spatial information to a file, we call <code class="docutils literal notranslate"><span class="pre">rasterio.open()</span></code> with a path to the new file to be created, and ‘w’ to specify writing mode, along with the arguments above.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">rasterio</span>
<span class="kn">from</span> <span class="nn">rasterio.transform</span> <span class="kn">import</span> <span class="n">Affine</span>

<span class="n">xres</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">yres</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>

<span class="n">transform</span> <span class="o">=</span> <span class="n">Affine</span><span class="o">.</span><span class="n">translation</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">xres</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">yres</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">Affine</span><span class="o">.</span><span class="n">scale</span><span class="p">(</span><span class="n">xres</span><span class="p">,</span> <span class="n">yres</span><span class="p">)</span>

<span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span>
        <span class="s2">&quot;../temp/temperature.tif&quot;</span><span class="p">,</span>
        <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">,</span>
        <span class="n">driver</span><span class="o">=</span><span class="s2">&quot;GTiff&quot;</span><span class="p">,</span>
        <span class="n">height</span><span class="o">=</span><span class="n">Z</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="n">width</span><span class="o">=</span><span class="n">Z</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
        <span class="n">count</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">=</span><span class="n">Z</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
        <span class="n">crs</span><span class="o">=</span><span class="s2">&quot;+proj=latlong&quot;</span><span class="p">,</span>
        <span class="n">transform</span><span class="o">=</span><span class="n">transform</span><span class="p">,</span>
<span class="p">)</span> <span class="k">as</span> <span class="n">new_dataset</span><span class="p">:</span>
        <span class="n">new_dataset</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>When we go to look again at our data we can read it back in using <code class="docutils literal notranslate"><span class="pre">open</span></code>. Before plotting we <code class="docutils literal notranslate"><span class="pre">raster.read(1)</span></code> the first band, which converts the data back to a <code class="docutils literal notranslate"><span class="pre">numpy</span></code> array that can be plotted in <code class="docutils literal notranslate"><span class="pre">matplotlib</span></code>.  Notice that we also specify the band number (in this case 1), with <code class="docutils literal notranslate"><span class="pre">.write(Z,</span> <span class="pre">1)</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="n">raster</span> <span class="o">=</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;../temp/temperature.tif&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">raster</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;BrBG&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Temperature&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/e_new_rasters_8_0.png" src="../_images/e_new_rasters_8_0.png" />
</div>
</div>
<p>So in summary, a spatial dataset is essentially just a <code class="docutils literal notranslate"><span class="pre">numpy.ndarray</span></code> with information about the location and resolution of the array, the <a class="reference internal" href="docs/a_intro.html#document-docs/d_crs_what_is_it"><span class="doc std std-doc">coordinate reference system</span></a>, and number of bands. This information is typically accessed and updated via the <code class="docutils literal notranslate"><span class="pre">.profile</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">raster</span><span class="o">.</span><span class="n">profile</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;driver&#39;: &#39;GTiff&#39;, &#39;dtype&#39;: &#39;float64&#39;, &#39;nodata&#39;: None, &#39;width&#39;: 6, &#39;height&#39;: 6, &#39;count&#39;: 1, &#39;crs&#39;: CRS.from_epsg(4326), &#39;transform&#39;: Affine(30.0, 0.0, -105.0,
       0.0, -30.0, 105.0), &#39;tiled&#39;: False, &#39;interleave&#39;: &#39;band&#39;}
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="update-raster-metadata">
<h3>Update Raster Metadata<a class="headerlink" href="#update-raster-metadata" title="Permalink to this headline">#</a></h3>
<p>Notice the the <code class="docutils literal notranslate"><span class="pre">.profile</span></code> above is missing a meaningful <code class="docutils literal notranslate"><span class="pre">nodata</span></code> value and was uncompressed. Let’s learn how to update these values. For this we can update the <code class="docutils literal notranslate"><span class="pre">.profile</span></code> dictionary.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># start with the original profile</span>
<span class="n">profile</span> <span class="o">=</span> <span class="n">raster</span><span class="o">.</span><span class="n">profile</span>
<span class="c1"># update values for nodata and compression type</span>
<span class="n">profile</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">nodata</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">compress</span><span class="o">=</span><span class="s2">&quot;lzw&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">profile</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;driver&#39;: &#39;GTiff&#39;, &#39;dtype&#39;: &#39;float64&#39;, &#39;nodata&#39;: 0, &#39;width&#39;: 6, &#39;height&#39;: 6, &#39;count&#39;: 1, &#39;crs&#39;: CRS.from_epsg(4326), &#39;transform&#39;: Affine(30.0, 0.0, -105.0,
       0.0, -30.0, 105.0), &#39;tiled&#39;: False, &#39;interleave&#39;: &#39;band&#39;, &#39;compress&#39;: &#39;lzw&#39;}
</pre></div>
</div>
</div>
</div>
<p>Now we just need to write the array of data (obtained from <code class="docutils literal notranslate"><span class="pre">raster.read(1)</span></code>) out with the updated profile info. We can unpack all the dictionary values from the profile using <code class="docutils literal notranslate"><span class="pre">**profile</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;../temp/temperature.tif&quot;</span><span class="p">,</span> 
                  <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">,</span> 
                  <span class="o">**</span><span class="n">profile</span><span class="p">,)</span> <span class="k">as</span> <span class="n">update_dataset</span><span class="p">:</span>
    <span class="n">update_dataset</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">raster</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="rasterio-multiband-rasters">
<h3>Rasterio Multiband Rasters<a class="headerlink" href="#rasterio-multiband-rasters" title="Permalink to this headline">#</a></h3>
<p>Working with multiband imagery starts to get a bit tricky, especially with <code class="docutils literal notranslate"><span class="pre">rasterio</span></code> alone.</p>
<p>Let’s start with a problematic raster file, a landsat image that stores its red, green, and blue bands in reverse order (blue, green, red), that is scaled by 100 (multiplied by 100 to store data as integers rather than float), and that is missing a meaningful nodata value.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span>
    <span class="s2">&quot;../data/LC08_L1TP_224078_20200518_20200518_01_RT.TIF&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">nodata</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
    <span class="c1"># read in the array, band 3 first, then band 2, then band 1</span>
    <span class="n">arr</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">([</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="c1"># the array has three bands</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Array shape:&quot;</span><span class="p">,</span> <span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="c1"># look at the profile, despite setting nodata=0, there still isn&#39;t a nodata value </span>
    <span class="c1"># this is because we need to update the profile and write out a new image with</span>
    <span class="c1">#  nodata set</span>
    <span class="n">profile</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">profile</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">profile</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Array shape: (3, 1860, 2041)
{&#39;driver&#39;: &#39;GTiff&#39;, &#39;dtype&#39;: &#39;uint16&#39;, &#39;nodata&#39;: None, &#39;width&#39;: 2041, &#39;height&#39;: 1860, &#39;count&#39;: 3, &#39;crs&#39;: CRS.from_epsg(32621), &#39;transform&#39;: Affine(30.0, 0.0, 717345.0,
       0.0, -30.0, -2776995.0), &#39;blockxsize&#39;: 256, &#39;blockysize&#39;: 256, &#39;tiled&#39;: True, &#39;compress&#39;: &#39;lzw&#39;, &#39;interleave&#39;: &#39;pixel&#39;}
</pre></div>
</div>
</div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>We use <code class="docutils literal notranslate"><span class="pre">src.read([3,</span> <span class="pre">2,</span> <span class="pre">1])</span></code> in order to reverse the read order of our bands. With this the original blue, green, red order is read in reverse as red, green, blue, which is required for true color images.</p>
</div>
<p>To see what it looks like, let’s use rasterio’s <code class="docutils literal notranslate"><span class="pre">show</span></code> function which <em>sort of helps</em> when viewing multiband imagery.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">rasterio.plot</span> <span class="kn">import</span> <span class="n">show</span>
<span class="nb">print</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;--------------&#39;</span><span class="p">)</span>
<span class="n">show</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[[[   0    0    0 ...    0    0    0]
  [   0    0    0 ...    0    0    0]
  [   0    0    0 ...    0    0    0]
  ...
  [6672 6168 6100 ... 6028 6015 6008]
  [6291 6457 6423 ... 6021 6001 6017]
  [6181 6727 6747 ... 6098 6023 5991]]

 [[   0    0    0 ...    0    0    0]
  [   0    0    0 ...    0    0    0]
  [   0    0    0 ...    0    0    0]
  ...
  [7083 6794 6731 ... 6760 6724 6685]
  [6951 7079 7016 ... 6699 6687 6715]
  [6864 7286 7338 ... 6817 6732 6659]]

 [[   0    0    0 ...    0    0    0]
  [   0    0    0 ...    0    0    0]
  [   0    0    0 ...    0    0    0]
  ...
  [7692 7518 7513 ... 7440 7432 7415]
  [7586 7590 7610 ... 7440 7411 7425]
  [7576 7743 7770 ... 7464 7443 7406]]]
--------------
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Clipping input data to the valid range for imshow with RGB data ([0..1] for floats or [0..255] for integers).
</pre></div>
</div>
<img alt="../_images/e_new_rasters_18_2.png" src="../_images/e_new_rasters_18_2.png" />
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;AxesSubplot:&gt;
</pre></div>
</div>
</div>
</div>
<p>Arg… it looks terrible. A few things, the primary problem is that the zeros aren’t being treated as missing data, and therefor messing everything up. Second, there is a message at the top of the image saying its <code class="docutils literal notranslate"><span class="pre">clipping...</span> <span class="pre">[0..255]</span> <span class="pre">for</span> <span class="pre">integers)</span></code>.</p>
<p>Let’s check what the range of values are in our raster. To do this we will use <code class="docutils literal notranslate"><span class="pre">scipy</span></code> <code class="docutils literal notranslate"><span class="pre">stats</span></code>, and <code class="docutils literal notranslate"><span class="pre">.ravel()</span></code> to convert our <code class="docutils literal notranslate"><span class="pre">n</span></code> dimension array to a <code class="docutils literal notranslate"><span class="pre">1d</span></code> array.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span>

<span class="nb">print</span><span class="p">(</span><span class="n">stats</span><span class="o">.</span><span class="n">describe</span><span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">ravel</span><span class="p">()))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DescribeResult(nobs=11388780, minmax=(0, 24147), mean=6095.312502656123, variance=7725568.74402071, skewness=-1.6071105370358574, kurtosis=0.9303298625510847)
</pre></div>
</div>
</div>
</div>
<p>Since we currently have integer data that ranges from 0 to 24147, we should try scaling it, if we go to the documentation we would see that we need to divide all values by 100.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">scaled_arr</span> <span class="o">=</span> <span class="n">arr</span> <span class="o">/</span> <span class="mi">100</span>
<span class="nb">print</span><span class="p">(</span><span class="n">scaled_arr</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>float64
</pre></div>
</div>
</div>
</div>
<p>Then let’s write the data back out again with an updated profile. Notice that the datatype (<code class="docutils literal notranslate"><span class="pre">dtype</span></code>) has changed since we divided by 100.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># update the profile for the new raster</span>
<span class="n">profile</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">profile</span>
<span class="n">profile</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">nodata</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">compress</span><span class="o">=</span><span class="s2">&quot;lzw&quot;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">scaled_arr</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

<span class="c1"># write out raster as RGB </span>
<span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span>
    <span class="s2">&quot;../temp/LS_scaled_20200518.tif&quot;</span><span class="p">,</span>
    <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">,</span>
    <span class="o">**</span><span class="n">profile</span><span class="p">,</span>  <span class="c1"># unpack the profile arguments set above</span>
<span class="p">)</span> <span class="k">as</span> <span class="n">new_dataset</span><span class="p">:</span>
    <span class="n">new_dataset</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">scaled_arr</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Since the bands have already been put in the right order in the array (ie. RGB), we can just write it out as follows <code class="docutils literal notranslate"><span class="pre">.write(scaled_arr,</span> <span class="pre">[1,</span> <span class="pre">2,</span> <span class="pre">3])</span></code>.</p>
</div>
<p>There you go! A fixed raster. Try opening it in Qgis to make sure. We can look at it now using rasterio <code class="docutils literal notranslate"><span class="pre">show</span></code>, but again it isn’t great, but better.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;../temp/LS_scaled_20200518.tif&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
    <span class="n">show</span><span class="p">(</span><span class="n">src</span><span class="p">,</span><span class="n">adjust</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/e_new_rasters_26_0.png" src="../_images/e_new_rasters_26_0.png" />
</div>
</div>
<p>To help make all of this easier and more intuitive we will be presenting the use of <code class="docutils literal notranslate"><span class="pre">geowombat</span></code> for remote sensing applications later, <span class="xref myst">start here</span>.</p>
<p>Just as a preview, here’s how to do this in <code class="docutils literal notranslate"><span class="pre">geowombat</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">geowombat</span> <span class="k">as</span> <span class="nn">gw</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>

<span class="c1"># tell gw to read a blue green red</span>
<span class="k">with</span> <span class="n">gw</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">sensor</span><span class="o">=</span><span class="s2">&quot;bgr&quot;</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">gw</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;../data/LC08_L1TP_224078_20200518_20200518_01_RT.TIF&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
        
        <span class="c1"># see that bands names, blue green red are assigned</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">band</span><span class="p">)</span>

        <span class="c1"># remove 0 value, rearrange band order </span>
        <span class="n">temp</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">src</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">band</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="s2">&quot;blue&quot;</span><span class="p">])</span>

        <span class="c1"># plot</span>
        <span class="n">temp</span><span class="o">.</span><span class="n">gw</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">robust</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>

        <span class="c1">#save to file</span>
        <span class="n">temp</span><span class="o">.</span><span class="n">gw</span><span class="o">.</span><span class="n">to_raster</span><span class="p">(</span>
            <span class="s2">&quot;../temp/LS_scaled_20200518.tif&quot;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_workers</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;xarray.DataArray &#39;band&#39; (band: 3)&gt;
array([&#39;blue&#39;, &#39;green&#39;, &#39;red&#39;], dtype=&#39;&lt;U5&#39;)
Coordinates:
  * band     (band) &lt;U5 &#39;blue&#39; &#39;green&#39; &#39;red&#39;
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  0%|          | 0/50 [00:00&lt;?, ?it/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> 18%|█▊        | 9/50 [00:00&lt;00:00, 82.56it/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> 36%|███▌      | 18/50 [00:00&lt;00:00, 79.51it/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> 52%|█████▏    | 26/50 [00:00&lt;00:00, 78.19it/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> 68%|██████▊   | 34/50 [00:00&lt;00:00, 74.41it/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> 84%|████████▍ | 42/50 [00:00&lt;00:00, 75.57it/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|██████████| 50/50 [00:00&lt;00:00, 76.03it/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|██████████| 50/50 [00:00&lt;00:00, 76.54it/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  0%|          | 0/14 [00:00&lt;?, ?it/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> 57%|█████▋    | 8/14 [00:00&lt;00:00, 75.63it/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|██████████| 14/14 [00:00&lt;00:00, 80.66it/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
<img alt="../_images/e_new_rasters_28_13.png" src="../_images/e_new_rasters_28_13.png" />
</div>
</div>
<hr class="docutils" />
<p>Credits: <a class="reference external" href="https://rasterio.readthedocs.io/en/latest/quickstart.html">rasterio quickstart</a></p>
</div>
</div>
<span id="document-docs/e_raster_reproject"></span><hr class="docutils" id="e-raster-reproject" />
<div class="admonition-learning-objectives admonition">
<p class="admonition-title">Learning Objectives</p>
<ul class="simple">
<li><p>Reproject a raster with rasterio</p></li>
<li><p>Reproject a raster with geowombat</p></li>
</ul>
</div>
<div class="admonition-review admonition">
<p class="admonition-title">Review</p>
<ul class="simple">
<li><p><a class="reference internal" href="docs/a_intro.html#document-docs/d_affine"><span class="doc std std-doc">Affine transformation</span></a></p></li>
<li><p><a class="reference internal" href="docs/a_intro.html#document-docs/d_raster_crs_intro"><span class="doc std std-doc">Raster Coordinate Reference Systems</span></a></p></li>
</ul>
</div>
<hr class="docutils" />
<div class="tex2jax_ignore mathjax_ignore section" id="reproject-rasters-w-rasterio-and-geowombat">
<h2>Reproject Rasters w. Rasterio and Geowombat<a class="headerlink" href="#reproject-rasters-w-rasterio-and-geowombat" title="Permalink to this headline">#</a></h2>
<div class="section" id="reprojecting-a-raster-with-geowombat">
<h3>Reprojecting a Raster with Geowombat<a class="headerlink" href="#reprojecting-a-raster-with-geowombat" title="Permalink to this headline">#</a></h3>
<p>Far and away the easiest way to handle raster data is by using <a class="reference external" href="https://geowombat.readthedocs.io/en/latest/index.html">geowombat</a>. Here’s an example of quickly and easily reprojecting a three band landsat image, and writing it to disk.</p>
<p>In order to reproject on the fly we are going to open the raster using <code class="docutils literal notranslate"><span class="pre">gw.config.update()</span></code>.  The configuration manager allows easy control over opened raster dimensions, alignment, and transformations. All we need to do is pass a <code class="docutils literal notranslate"><span class="pre">ref_crs</span></code> to the configuration manager. We can also use the <code class="docutils literal notranslate"><span class="pre">resampling</span></code> method when we <code class="docutils literal notranslate"><span class="pre">open</span></code> the image, by default it will be <code class="docutils literal notranslate"><span class="pre">nearest</span></code>, but you can also choose one of [‘average’, ‘bilinear’, ‘cubic’, ‘cubic_spline’, ‘gauss’, ‘lanczos’, ‘max’, ‘med’, ‘min’, ‘mode’, ‘nearest’].</p>
<div class="cell tag_hide-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">geowombat</span> <span class="k">as</span> <span class="nn">gw</span>

<span class="n">proj4</span> <span class="o">=</span> <span class="s2">&quot;+proj=aea +lat_1=20 +lat_2=60 +lat_0=40 +lon_0=-96 +x_0=0 +y_0=0 +datum=NAD83 +units=m +no_defs&quot;</span>
<span class="n">image</span> <span class="o">=</span> <span class="s2">&quot;../data/LC08_L1TP_224078_20200518_20200518_01_RT.TIF&quot;</span>

<span class="k">with</span> <span class="n">gw</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">ref_crs</span><span class="o">=</span><span class="n">proj4</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">gw</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">resampling</span><span class="o">=</span><span class="s2">&quot;nearest&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
    
        <span class="n">src</span><span class="o">.</span><span class="n">gw</span><span class="o">.</span><span class="n">to_raster</span><span class="p">(</span>
            <span class="s2">&quot;../temp/LC08_20200518_aea.tif&quot;</span><span class="p">,</span>
            <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">n_workers</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>  <span class="c1"># number of process workers </span>
            <span class="n">n_threads</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>  <span class="c1"># number of thread workers ``dask.compute``</span>
            <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span> 
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  0%|          | 0/130 [00:00&lt;?, ?it/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  1%|          | 1/130 [00:00&lt;00:16,  7.78it/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  5%|▍         | 6/130 [00:00&lt;00:04, 27.91it/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  8%|▊         | 11/130 [00:00&lt;00:03, 31.87it/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> 13%|█▎        | 17/130 [00:00&lt;00:02, 41.15it/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> 17%|█▋        | 22/130 [00:00&lt;00:03, 33.56it/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> 20%|██        | 26/130 [00:00&lt;00:02, 35.01it/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> 24%|██▍       | 31/130 [00:00&lt;00:02, 35.96it/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> 27%|██▋       | 35/130 [00:01&lt;00:03, 30.97it/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> 30%|███       | 39/130 [00:01&lt;00:02, 31.57it/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> 34%|███▍      | 44/130 [00:01&lt;00:02, 30.00it/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> 37%|███▋      | 48/130 [00:01&lt;00:03, 24.84it/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> 39%|███▉      | 51/130 [00:01&lt;00:03, 25.35it/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> 42%|████▏     | 54/130 [00:01&lt;00:03, 25.24it/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> 44%|████▍     | 57/130 [00:02&lt;00:03, 21.64it/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> 46%|████▌     | 60/130 [00:02&lt;00:03, 21.94it/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> 48%|████▊     | 63/130 [00:02&lt;00:03, 20.75it/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> 51%|█████     | 66/130 [00:02&lt;00:03, 19.31it/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> 53%|█████▎    | 69/130 [00:02&lt;00:02, 21.01it/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> 55%|█████▌    | 72/130 [00:02&lt;00:03, 18.28it/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> 57%|█████▋    | 74/130 [00:02&lt;00:03, 17.82it/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> 61%|██████    | 79/130 [00:03&lt;00:02, 22.24it/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> 63%|██████▎   | 82/130 [00:03&lt;00:02, 20.21it/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> 65%|██████▌   | 85/130 [00:03&lt;00:02, 21.08it/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> 69%|██████▉   | 90/130 [00:03&lt;00:01, 25.16it/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> 72%|███████▏  | 93/130 [00:03&lt;00:01, 26.23it/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> 74%|███████▍  | 96/130 [00:03&lt;00:01, 19.07it/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> 79%|███████▉  | 103/130 [00:04&lt;00:00, 28.55it/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> 82%|████████▏ | 107/130 [00:04&lt;00:00, 26.00it/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> 86%|████████▌ | 112/130 [00:04&lt;00:00, 29.47it/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> 89%|████████▉ | 116/130 [00:04&lt;00:00, 31.71it/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> 92%|█████████▏| 120/130 [00:04&lt;00:00, 31.86it/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> 97%|█████████▋| 126/130 [00:04&lt;00:00, 36.98it/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|██████████| 130/130 [00:04&lt;00:00, 27.11it/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
</div>
<p>Let’s take a look, remember from earlier that this image is stored as green, blue, red (rather than red, green, blue), so we will use <code class="docutils literal notranslate"><span class="pre">.sel(band=[3,2,1])</span></code> to put them back in the right order.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>

<span class="n">image</span> <span class="o">=</span> <span class="s2">&quot;../temp/LC08_20200518_aea.tif&quot;</span>
<span class="k">with</span> <span class="n">gw</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">image</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
    <span class="n">src</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">src</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">band</span><span class="o">=</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">gw</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">robust</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">pad</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/e_raster_reproject_3_0.png" src="../_images/e_raster_reproject_3_0.png" />
</div>
</div>
<p>Too easy? Want something more complex? Try the same thing with Rasterio. Yes, there will be a little matrix algebra.</p>
</div>
<div class="section" id="calculate-default-transform-explained">
<h3>Calculate_default_transform Explained<a class="headerlink" href="#calculate-default-transform-explained" title="Permalink to this headline">#</a></h3>
<p>How do we reproject a raster? Before we get into it, we need to talk some more… about <code class="docutils literal notranslate"><span class="pre">calculate_default_transform</span></code>. <code class="docutils literal notranslate"><span class="pre">calculate_default_transform</span></code> allows us to generate the transform matrix required for the new reprojected raster based on the characteristics of the original and the desired output CRS. Note that the <code class="docutils literal notranslate"><span class="pre">source</span></code> (src) is the original input raster, and the <code class="docutils literal notranslate"><span class="pre">destination</span></code> (dst) is the outputed reprojected raster.</p>
<p>First, remember that the transform matrix takes the following form (<a class="reference internal" href="docs/a_intro.html#document-docs/d_affine"><span class="doc std std-doc">review affine transforms here</span></a>):</p>
<div class="math notranslate nohighlight">
\[\begin{split}
    \mbox{Transform} =  \begin{bmatrix} xres &amp; 0 &amp; \Delta x \\ 0 &amp; yres &amp; \Delta y \\ 0 &amp; 0 &amp; 1 \end{bmatrix} 
\end{split}\]</div>
<p>Now let’s calculate the tranform matrix for the destination raster:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">rasterio</span>
<span class="kn">from</span> <span class="nn">rasterio.warp</span> <span class="kn">import</span> <span class="n">reproject</span><span class="p">,</span> <span class="n">Resampling</span><span class="p">,</span> <span class="n">calculate_default_transform</span>

<span class="n">dst_crs</span> <span class="o">=</span> <span class="s2">&quot;EPSG:3857&quot;</span>  <span class="c1"># web mercator(ie google maps)</span>

<span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;../data/LC08_L1TP_224078_20200518_20200518_01_RT.TIF&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>

    <span class="c1"># transform for input raster</span>
    <span class="n">src_transform</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">transform</span>

    <span class="c1"># calculate the transform matrix for the output</span>
    <span class="n">dst_transform</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="n">calculate_default_transform</span><span class="p">(</span>
        <span class="n">src</span><span class="o">.</span><span class="n">crs</span><span class="p">,</span>    <span class="c1"># source CRS</span>
        <span class="n">dst_crs</span><span class="p">,</span>    <span class="c1"># destination CRS</span>
        <span class="n">src</span><span class="o">.</span><span class="n">width</span><span class="p">,</span>    <span class="c1"># column count</span>
        <span class="n">src</span><span class="o">.</span><span class="n">height</span><span class="p">,</span>  <span class="c1"># row count</span>
        <span class="o">*</span><span class="n">src</span><span class="o">.</span><span class="n">bounds</span><span class="p">,</span>  <span class="c1"># unpacks outer boundaries (left, bottom, right, top)</span>
    <span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Source Transform:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span><span class="n">src_transform</span><span class="p">,</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Destination Transform:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">dst_transform</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Source Transform:
 | 30.00, 0.00, 717345.00|
| 0.00,-30.00,-2776995.00|
| 0.00, 0.00, 1.00| 

Destination Transform:
 | 33.24, 0.00,-6105300.09|
| 0.00,-33.24,-2885952.71|
| 0.00, 0.00, 1.00|
</pre></div>
</div>
</div>
</div>
<p>Notice that in order to keep the same number of rows and columns that the resolution of the destination raster increased from 30 meters to 33.24 meters. Also the coordinates of the upper left hand corner have shifted (check <span class="math notranslate nohighlight">\(\Delta x, \Delta x\)</span>).</p>
</div>
<div class="section" id="reprojecting-a-raster-with-rasterio">
<h3>Reprojecting a Raster with Rasterio<a class="headerlink" href="#reprojecting-a-raster-with-rasterio" title="Permalink to this headline">#</a></h3>
<p>Ok finally!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dst_crs</span> <span class="o">=</span> <span class="s2">&quot;EPSG:3857&quot;</span>  <span class="c1"># web mercator(ie google maps)</span>

<span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;../data/LC08_L1TP_224078_20200518_20200518_01_RT.TIF&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
    <span class="n">src_transform</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">transform</span>

    <span class="c1"># calculate the transform matrix for the output</span>
    <span class="n">dst_transform</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="n">calculate_default_transform</span><span class="p">(</span>
        <span class="n">src</span><span class="o">.</span><span class="n">crs</span><span class="p">,</span>
        <span class="n">dst_crs</span><span class="p">,</span>
        <span class="n">src</span><span class="o">.</span><span class="n">width</span><span class="p">,</span>
        <span class="n">src</span><span class="o">.</span><span class="n">height</span><span class="p">,</span>
        <span class="o">*</span><span class="n">src</span><span class="o">.</span><span class="n">bounds</span><span class="p">,</span>  <span class="c1"># unpacks outer boundaries (left, bottom, right, top)</span>
    <span class="p">)</span>

    <span class="c1"># set properties for output</span>
    <span class="n">dst_kwargs</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">dst_kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="s2">&quot;crs&quot;</span><span class="p">:</span> <span class="n">dst_crs</span><span class="p">,</span>
            <span class="s2">&quot;transform&quot;</span><span class="p">:</span> <span class="n">dst_transform</span><span class="p">,</span>
            <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="n">width</span><span class="p">,</span>
            <span class="s2">&quot;height&quot;</span><span class="p">:</span> <span class="n">height</span><span class="p">,</span>
            <span class="s2">&quot;nodata&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>  <span class="c1"># replace 0 with np.nan</span>
        <span class="p">}</span>
    <span class="p">)</span>

    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;../temp/LC08_20200518_webMC.tif&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">dst_kwargs</span><span class="p">)</span> <span class="k">as</span> <span class="n">dst</span><span class="p">:</span>
        <span class="c1"># iterate through bands</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">src</span><span class="o">.</span><span class="n">count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">reproject</span><span class="p">(</span>
                <span class="n">source</span><span class="o">=</span><span class="n">rasterio</span><span class="o">.</span><span class="n">band</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">i</span><span class="p">),</span>
                <span class="n">destination</span><span class="o">=</span><span class="n">rasterio</span><span class="o">.</span><span class="n">band</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">i</span><span class="p">),</span>
                <span class="n">src_transform</span><span class="o">=</span><span class="n">src</span><span class="o">.</span><span class="n">transform</span><span class="p">,</span>
                <span class="n">src_crs</span><span class="o">=</span><span class="n">src</span><span class="o">.</span><span class="n">crs</span><span class="p">,</span>
                <span class="n">dst_transform</span><span class="o">=</span><span class="n">dst_transform</span><span class="p">,</span>
                <span class="n">dst_crs</span><span class="o">=</span><span class="n">dst_crs</span><span class="p">,</span>
                <span class="n">resampling</span><span class="o">=</span><span class="n">Resampling</span><span class="o">.</span><span class="n">nearest</span><span class="p">,</span>
            <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="figure align-default" id="reprojected-landsat-image">
<a class="reference internal image-reference" href="../_images/d_reproj_image.png"><img alt="../_images/d_reproj_image.png" src="../_images/d_reproj_image.png" style="width: 400px;" /></a>
<p class="caption"><span class="caption-number">Fig. 54 </span><span class="caption-text">Reprojected Landsat Image</span><a class="headerlink" href="#reprojected-landsat-image" title="Permalink to this image">#</a></p>
</div>
</div>
</div>
<span id="document-docs/e_raster_resample"></span><hr class="docutils" id="e-raster-reproject" />
<div class="admonition-learning-objectives admonition">
<p class="admonition-title">Learning Objectives</p>
<ul class="simple">
<li><p>Resample a raster with rasterio &amp; geowombat</p></li>
<li><p>Learn how to match the extent</p></li>
</ul>
</div>
<div class="admonition-review admonition">
<p class="admonition-title">Review</p>
<ul class="simple">
<li><p><a class="reference internal" href="docs/a_intro.html#d-affine"><span class="std std-ref">Affine transformation</span></a></p></li>
<li><p><a class="reference internal" href="docs/a_intro.html#d-raster-crs-intro"><span class="std std-ref">Raster Coordinate Reference Systems</span></a></p></li>
<li><p><a class="reference internal" href="docs/a_intro.html#document-docs/e_raster_reproject"><span class="doc std std-doc">Reprojecting Rasters</span></a></p></li>
<li><p><a class="reference internal" href="docs/a_intro.html#d-raster-crs-intro-interpolation-options"><span class="std std-ref">Interpolation Methods Explained</span></a></p></li>
</ul>
</div>
<hr class="docutils" />
<div class="tex2jax_ignore mathjax_ignore section" id="resampling-registering-rasters-w-rasterio-and-geowombat">
<h2>Resampling &amp; Registering Rasters w. Rasterio and Geowombat<a class="headerlink" href="#resampling-registering-rasters-w-rasterio-and-geowombat" title="Permalink to this headline">#</a></h2>
<div class="section" id="why-is-resampling-important">
<h3>Why is Resampling Important?<a class="headerlink" href="#why-is-resampling-important" title="Permalink to this headline">#</a></h3>
<p><em>Before you begin</em> any analysis using rater data it is critical that you have rasters that are “co-registered”. Co-registration requires that any two rasters have the same resolution, and orientation - the origins can differ but they much align. <em>In other words, co-registration requires that cell centroids align perfectly for all intersecting areas.</em> Resampling is also extremely common during reprojection operations as it often requires changing the orientation, scale or resolution of an image.</p>
<p><strong>Examples of data that is <em>not</em> co-registered</strong></p>
<div class="figure align-default" id="resampling-rasters-different-orientation">
<a class="reference internal image-reference" href="../_images/Raster_diff-orientation.jpg"><img alt="../_images/Raster_diff-orientation.jpg" src="../_images/Raster_diff-orientation.jpg" style="width: 400px;" /></a>
<p class="caption"><span class="caption-number">Fig. 55 </span><span class="caption-text">Resampling rasters - different orientation</span><a class="headerlink" href="#resampling-rasters-different-orientation" title="Permalink to this image">#</a></p>
</div>
<div class="figure align-default" id="resampling-rasters-different-orientation-and-origin">
<a class="reference internal image-reference" href="../_images/Raster_diff-orientation-origin.jpg"><img alt="../_images/Raster_diff-orientation-origin.jpg" src="../_images/Raster_diff-orientation-origin.jpg" style="width: 400px;" /></a>
<p class="caption"><span class="caption-number">Fig. 56 </span><span class="caption-text">Resampling rasters - different orientation and origin</span><a class="headerlink" href="#resampling-rasters-different-orientation-and-origin" title="Permalink to this image">#</a></p>
</div>
<div class="figure align-default" id="resampling-rasters-different-resolution">
<a class="reference internal image-reference" href="../_images/Raster_diff-res.jpg"><img alt="../_images/Raster_diff-res.jpg" src="../_images/Raster_diff-res.jpg" style="width: 400px;" /></a>
<p class="caption"><span class="caption-number">Fig. 57 </span><span class="caption-text">Resampling rasters - different resolution</span><a class="headerlink" href="#resampling-rasters-different-resolution" title="Permalink to this image">#</a></p>
</div>
<p>We can co-register images by resampling, and often reprojecting, one image to match another.</p>
</div>
<div class="section" id="methods-for-resampling-explained">
<span id="raster-resample-methods"></span><h3>Methods for Resampling Explained<a class="headerlink" href="#methods-for-resampling-explained" title="Permalink to this headline">#</a></h3>
<p>There are <a class="reference external" href="https://rasterio.readthedocs.io/en/latest/api/rasterio.enums.html#rasterio.enums.Resampling">a number of methods</a> to resample data, but they often take the form of “nearest neighbor”, “bilinear”, and “cubic convolusion” - these interpolation methods <span class="xref myst">are explained here in some detail</span>. But there are a number of other including: [‘average’, ‘cubic_spline’, ‘gauss’, ‘lanczos’, ‘max’, ‘med’, ‘min’, ‘mode’, ‘nearest’].</p>
<p><strong>resampling direction</strong></p>
<ul class="simple">
<li><p>Upsampling - converting to higher resolution/smaller cells.</p></li>
<li><p>Downsampling - converting to lower resolution/larger cell sizes.</p></li>
</ul>
</div>
<div class="section" id="simple-up-downsampling-in-rasterio-geowombat">
<h3>Simple Up/Downsampling in Rasterio &amp; Geowombat<a class="headerlink" href="#simple-up-downsampling-in-rasterio-geowombat" title="Permalink to this headline">#</a></h3>
<div class="section" id="rasterio-upsampling-example">
<h4>Rasterio Upsampling Example<a class="headerlink" href="#rasterio-upsampling-example" title="Permalink to this headline">#</a></h4>
<p>Occationally you will need to resample your data by some factor, for instance you might want data upsampled to a courser resolution due to memory constraints.</p>
<p>Here’s an example of how to generate the <code class="docutils literal notranslate"><span class="pre">data</span></code> array and the <code class="docutils literal notranslate"><span class="pre">transform</span></code> needed to write it out. We will start by simply reading in the data and coersing a higher resolution, by adding more rows and columns. To understand the <code class="docutils literal notranslate"><span class="pre">transform</span></code>, let’s review <a class="reference internal" href="docs/a_intro.html#d-affine"><span class="std std-ref">affine transformations</span></a>. Here we will update the scale values with the new resolution using <span class="math notranslate nohighlight">\(S_{y}\)</span> and <span class="math notranslate nohighlight">\(S_{x}\)</span> show below</p>
<div class="math notranslate nohighlight">
\[\begin{split}
   \begin{eqnarray}
   \mbox{Scale transform: }  \begin{bmatrix} S_{x} &amp; 0 &amp; 0 \\ 0 &amp; S_{y} &amp; 0 \\ 0 &amp; 0 &amp; 1 \end{bmatrix} 
   \end{eqnarray}
\end{split}\]</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">rasterio</span>
<span class="kn">from</span> <span class="nn">rasterio.enums</span> <span class="kn">import</span> <span class="n">Resampling</span>

<span class="n">image</span> <span class="o">=</span> <span class="s2">&quot;../data/LC08_L1TP_224078_20200518_20200518_01_RT.TIF&quot;</span>

<span class="n">upscale_factor</span> <span class="o">=</span> <span class="mi">2</span>

<span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">image</span><span class="p">)</span> <span class="k">as</span> <span class="n">dataset</span><span class="p">:</span>

    <span class="c1"># resample data to target shape using upscale_factor</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">read</span><span class="p">(</span>
        <span class="n">out_shape</span><span class="o">=</span><span class="p">(</span>
            <span class="n">dataset</span><span class="o">.</span><span class="n">count</span><span class="p">,</span>
            <span class="nb">int</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">height</span> <span class="o">*</span> <span class="n">upscale_factor</span><span class="p">),</span>
            <span class="nb">int</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">width</span> <span class="o">*</span> <span class="n">upscale_factor</span><span class="p">)</span>
        <span class="p">),</span>
        <span class="n">resampling</span><span class="o">=</span><span class="n">Resampling</span><span class="o">.</span><span class="n">bilinear</span>
    <span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Shape before resample:&#39;</span><span class="p">,</span> <span class="n">dataset</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Shape after resample:&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>

    <span class="c1"># scale image transform</span>
    <span class="n">dst_transform</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">transform</span> <span class="o">*</span> <span class="n">dataset</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="n">scale</span><span class="p">(</span>
        <span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">width</span> <span class="o">/</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span>
        <span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">height</span> <span class="o">/</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
    <span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Transform before resample:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">dataset</span><span class="o">.</span><span class="n">transform</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Transform after resample:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">dst_transform</span><span class="p">)</span>

    <span class="c1">## Write outputs</span>
    <span class="c1"># set properties for output</span>
    <span class="c1"># dst_kwargs = src.meta.copy()</span>
    <span class="c1"># dst_kwargs.update(</span>
    <span class="c1">#     {</span>
    <span class="c1">#         &quot;crs&quot;: dst_crs,</span>
    <span class="c1">#         &quot;transform&quot;: dst_transform,</span>
    <span class="c1">#         &quot;width&quot;: data.shape[-1],</span>
    <span class="c1">#         &quot;height&quot;: data.shape[-2],</span>
    <span class="c1">#         &quot;nodata&quot;: 0,  </span>
    <span class="c1">#     }</span>
    <span class="c1"># )</span>

    <span class="c1"># with rasterio.open(&quot;../temp/LC08_20200518_15m.tif&quot;, &quot;w&quot;, **dst_kwargs) as dst:</span>
    <span class="c1">#     # iterate through bands</span>
    <span class="c1">#     for i in range(data.shape[0]):</span>
    <span class="c1">#           dst.write(data[i].astype(rasterio.uint32), i+1)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Shape before resample: (1860, 2041)
Shape after resample: (3720, 4082)
Transform before resample:
 | 30.00, 0.00, 717345.00|
| 0.00,-30.00,-2776995.00|
| 0.00, 0.00, 1.00| 

Transform after resample:
 | 15.00, 0.00, 717345.00|
| 0.00,-15.00,-2776995.00|
| 0.00, 0.00, 1.00|
</pre></div>
</div>
</div>
</div>
<div class="admonition-reminder admonition">
<p class="admonition-title">Reminder</p>
<p>Read up on <a class="reference internal" href="docs/a_intro.html#d-affine-transform-matrix"><span class="std std-ref">affine transformations</span></a> to help you understand the <code class="docutils literal notranslate"><span class="pre">transform.scale</span></code> function above.</p>
</div>
</div>
<div class="section" id="geowombat-up-down-sampling-example">
<h4>Geowombat Up/Down Sampling Example<a class="headerlink" href="#geowombat-up-down-sampling-example" title="Permalink to this headline">#</a></h4>
<p>As always the easiest way to deal with resampling is by deploying geowombat. It’s like a swiss army knife for kicking raster butt. Here we just need to set the desired resolution with <code class="docutils literal notranslate"><span class="pre">ref_res</span></code>, and the <code class="docutils literal notranslate"><span class="pre">resampling</span></code> method in the open statement. We have a number of resampling methods available depending on the context <a class="reference internal" href="#raster-resample-methods"><span class="std std-ref">listed above</span></a>. Writing a file is a bit more intuitive too.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">geowombat</span> <span class="k">as</span> <span class="nn">gw</span>
 
<span class="n">image</span> <span class="o">=</span> <span class="s2">&quot;../data/LC08_L1TP_224078_20200518_20200518_01_RT.TIF&quot;</span>

<span class="k">with</span> <span class="n">gw</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">ref_res</span><span class="o">=</span><span class="mi">15</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">gw</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">resampling</span><span class="o">=</span><span class="s2">&quot;bilinear&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
        
        <span class="c1"># to write out simply:</span>
        <span class="c1"># src.gw.to_raster(</span>
        <span class="c1">#     &quot;../temp/LC08_20200518_15m.tif&quot;,</span>
        <span class="c1">#     overwrite=True,</span>
        <span class="c1"># ) </span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;xarray.DataArray (band: 3, y: 3720, x: 4082)&gt;
dask.array&lt;open_rasterio-5d3779c5d83524d14a4bbcf537a1f23d&lt;this-array&gt;, shape=(3, 3720, 4082), dtype=uint16, chunksize=(1, 256, 256), chunktype=numpy.ndarray&gt;
Coordinates:
  * band     (band) int64 1 2 3
  * y        (y) float64 -2.777e+06 -2.777e+06 ... -2.833e+06 -2.833e+06
  * x        (x) float64 7.174e+05 7.174e+05 7.174e+05 ... 7.786e+05 7.786e+05
Attributes:
    transform:          (15.0, 0.0, 717345.0, 0.0, -15.0, -2776995.0)
    crs:                +init=epsg:32621
    res:                (15.0, 15.0)
    is_tiled:           1
    nodatavals:         (0, 0, 0)
    scales:             (1.0, 1.0, 1.0)
    offsets:            (0.0, 0.0, 0.0)
    filename:           ../data/LC08_L1TP_224078_20200518_20200518_01_RT.TIF
    resampling:         bilinear
    AREA_OR_POINT:      Area
    data_are_separate:  0
    data_are_stacked:   0
</pre></div>
</div>
</div>
</div>
<p>Much…. easier….</p>
</div>
</div>
<div class="section" id="co-registering-rasters-aligning-cells">
<h3>Co-registering Rasters (Aligning cells)<a class="headerlink" href="#co-registering-rasters-aligning-cells" title="Permalink to this headline">#</a></h3>
<p>One common problem is how to get raster data to align on a cell by cell basis so you can complete your analysis. We will walk through how to do this for both rasterio and geowombat. In the following example we will learn how to align rasters with different origins, resolutions, or orientations.</p>
<p>Our example data will look at registering LandSat data with precipitation data from CHIRPS.</p>
<div class="section" id="example-of-co-registering-rasters-with-rasterio">
<h4>Example of Co-registering Rasters with Rasterio<a class="headerlink" href="#example-of-co-registering-rasters-with-rasterio" title="Permalink to this headline">#</a></h4>
<p>Co-registering data is a bit complicated with rasterio, you simply need to choose an “reference image” to match the bounds, CRS, and cell size.</p>
<p>The original input data LandSat data is 30 meters and will be downsampled to match <code class="docutils literal notranslate"><span class="pre">precip</span></code> which is 500m.  Also note the use of <code class="docutils literal notranslate"><span class="pre">nodata</span></code> to avoid missing values stored as 0. Note we can choose a number of <code class="docutils literal notranslate"><span class="pre">resampling</span></code> techniques <a class="reference internal" href="#raster-resample-methods"><span class="std std-ref">listed above</span></a>. For more detail on resampling go to <a class="reference internal" href="docs/a_intro.html#d-raster-crs-intro"><span class="std std-ref">Introduction to Raster CRS</span></a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">rasterio.warp</span> <span class="kn">import</span> <span class="n">reproject</span><span class="p">,</span> <span class="n">Resampling</span><span class="p">,</span> <span class="n">calculate_default_transform</span>
<span class="kn">import</span> <span class="nn">rasterio</span>
<span class="k">def</span> <span class="nf">reproj_match</span><span class="p">(</span><span class="n">infile</span><span class="p">,</span> <span class="n">match</span><span class="p">,</span> <span class="n">outfile</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Reproject a file to match the shape and projection of existing raster. </span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    infile : (string) path to input file to reproject</span>
<span class="sd">    match : (string) path to raster with desired shape and projection </span>
<span class="sd">    outfile : (string) path to output file tif</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># open input</span>
    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">infile</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
        <span class="n">src_transform</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">transform</span>
        
        <span class="c1"># open input to match</span>
        <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">match</span><span class="p">)</span> <span class="k">as</span> <span class="n">match</span><span class="p">:</span>
            <span class="n">dst_crs</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">crs</span>
            
            <span class="c1"># calculate the output transform matrix</span>
            <span class="n">dst_transform</span><span class="p">,</span> <span class="n">dst_width</span><span class="p">,</span> <span class="n">dst_height</span> <span class="o">=</span> <span class="n">calculate_default_transform</span><span class="p">(</span>
                <span class="n">src</span><span class="o">.</span><span class="n">crs</span><span class="p">,</span>     <span class="c1"># input CRS</span>
                <span class="n">dst_crs</span><span class="p">,</span>     <span class="c1"># output CRS</span>
                <span class="n">match</span><span class="o">.</span><span class="n">width</span><span class="p">,</span>   <span class="c1"># input width</span>
                <span class="n">match</span><span class="o">.</span><span class="n">height</span><span class="p">,</span>  <span class="c1"># input height </span>
                <span class="o">*</span><span class="n">match</span><span class="o">.</span><span class="n">bounds</span><span class="p">,</span>  <span class="c1"># unpacks input outer boundaries (left, bottom, right, top)</span>
            <span class="p">)</span>

        <span class="c1"># set properties for output</span>
        <span class="n">dst_kwargs</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">dst_kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;crs&quot;</span><span class="p">:</span> <span class="n">dst_crs</span><span class="p">,</span>
                           <span class="s2">&quot;transform&quot;</span><span class="p">:</span> <span class="n">dst_transform</span><span class="p">,</span>
                           <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="n">dst_width</span><span class="p">,</span>
                           <span class="s2">&quot;height&quot;</span><span class="p">:</span> <span class="n">dst_height</span><span class="p">,</span>
                           <span class="s2">&quot;nodata&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">})</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Coregistered to shape:&quot;</span><span class="p">,</span> <span class="n">dst_height</span><span class="p">,</span><span class="n">dst_width</span><span class="p">,</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> Affine&#39;</span><span class="p">,</span><span class="n">dst_transform</span><span class="p">)</span>
        <span class="c1"># open output</span>
        <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">dst_kwargs</span><span class="p">)</span> <span class="k">as</span> <span class="n">dst</span><span class="p">:</span>
            <span class="c1"># iterate through bands and write using reproject function</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">src</span><span class="o">.</span><span class="n">count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">reproject</span><span class="p">(</span>
                    <span class="n">source</span><span class="o">=</span><span class="n">rasterio</span><span class="o">.</span><span class="n">band</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">i</span><span class="p">),</span>
                    <span class="n">destination</span><span class="o">=</span><span class="n">rasterio</span><span class="o">.</span><span class="n">band</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">i</span><span class="p">),</span>
                    <span class="n">src_transform</span><span class="o">=</span><span class="n">src</span><span class="o">.</span><span class="n">transform</span><span class="p">,</span>
                    <span class="n">src_crs</span><span class="o">=</span><span class="n">src</span><span class="o">.</span><span class="n">crs</span><span class="p">,</span>
                    <span class="n">dst_transform</span><span class="o">=</span><span class="n">dst_transform</span><span class="p">,</span>
                    <span class="n">dst_crs</span><span class="o">=</span><span class="n">dst_crs</span><span class="p">,</span>
                    <span class="n">resampling</span><span class="o">=</span><span class="n">Resampling</span><span class="o">.</span><span class="n">nearest</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Now we can execute out code to co-register two rasters</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">LS</span> <span class="o">=</span> <span class="s2">&quot;../data/LC08_L1TP_224078_20200518_20200518_01_RT.TIF&quot;</span>
<span class="n">precip</span> <span class="o">=</span> <span class="s2">&quot;../data/precipitation_20200601_500m.tif&quot;</span>

<span class="c1"># co-register LS to match precip raster</span>
<span class="n">reproj_match</span><span class="p">(</span><span class="n">infile</span> <span class="o">=</span> <span class="n">LS</span><span class="p">,</span> 
             <span class="n">match</span><span class="o">=</span> <span class="n">precip</span><span class="p">,</span>
             <span class="n">outfile</span> <span class="o">=</span> <span class="s1">&#39;../temp/LS_reg_precip.tif&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Coregistered to shape: 136 157 
 Affine | 0.00, 0.00,-61.49|
| 0.00,-0.00,-0.00|
| 0.00, 0.00, 1.00|
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="example-of-co-registering-rasters-with-geowombat">
<h4>Example of Co-registering Rasters with Geowombat<a class="headerlink" href="#example-of-co-registering-rasters-with-geowombat" title="Permalink to this headline">#</a></h4>
<p>Co-registering data is simple in geowombat, you simply need to choose an “reference image” to match the bounds, CRS, and cell size.</p>
<p>The original input data <code class="docutils literal notranslate"><span class="pre">precip</span></code> is currently 500m but will be upsampled to 30m as seen in <code class="docutils literal notranslate"><span class="pre">print(src)</span></code>.  Also note the use of <code class="docutils literal notranslate"><span class="pre">nodata</span></code> to avoid missing values stored as -9999. Note we can choose a number of <code class="docutils literal notranslate"><span class="pre">resampling</span></code> techniques <a class="reference internal" href="#raster-resample-methods"><span class="std std-ref">listed above</span></a>. For more detail on resampling go to <a class="reference internal" href="docs/a_intro.html#d-raster-crs-intro"><span class="std std-ref">Introduction to Raster CRS</span></a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">geowombat</span> <span class="k">as</span> <span class="nn">gw</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>


<span class="n">LS</span> <span class="o">=</span> <span class="s2">&quot;../data/LC08_L1TP_224078_20200518_20200518_01_RT.TIF&quot;</span>
<span class="n">precip</span> <span class="o">=</span> <span class="s2">&quot;../data/precipitation_20200601_500m.tif&quot;</span>

<span class="k">with</span> <span class="n">gw</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">ref_image</span><span class="o">=</span><span class="n">LS</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">gw</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">precip</span><span class="p">,</span> <span class="n">resampling</span><span class="o">=</span><span class="s2">&quot;bilinear&quot;</span><span class="p">,</span> <span class="n">nodata</span><span class="o">=-</span><span class="mi">9999</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        
        <span class="c1"># to write out simply:</span>
        <span class="c1"># src.gw.to_raster(</span>
        <span class="c1">#     &quot;../temp/precip_20200601_30m.tif&quot;,</span>
        <span class="c1">#     overwrite=True,</span>
        <span class="c1"># ) </span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;xarray.DataArray (band: 1, y: 1860, x: 2041)&gt;
dask.array&lt;open_rasterio-5ea1b887333ee835e34ed81f251d6116&lt;this-array&gt;, shape=(1, 1860, 2041), dtype=float32, chunksize=(1, 135, 157), chunktype=numpy.ndarray&gt;
Coordinates:
  * band     (band) int64 1
  * y        (y) float64 -2.777e+06 -2.777e+06 ... -2.833e+06 -2.833e+06
  * x        (x) float64 7.174e+05 7.174e+05 7.174e+05 ... 7.785e+05 7.786e+05
Attributes: (12/13)
    transform:          (30.0, 0.0, 717345.0, 0.0, -30.0, -2776995.0)
    crs:                +init=epsg:32621
    res:                (30.0, 30.0)
    is_tiled:           1
    nodatavals:         (0,)
    scales:             (1.0,)
    ...                 ...
    descriptions:       (&#39;precipitation&#39;,)
    filename:           ../data/precipitation_20200601_500m.tif
    resampling:         bilinear
    AREA_OR_POINT:      Area
    data_are_separate:  0
    data_are_stacked:   0
</pre></div>
</div>
<img alt="../_images/e_raster_resample_9_1.png" src="../_images/e_raster_resample_9_1.png" />
</div>
</div>
<p>Although it’s a bit hard to tell, the cell size is now 30m (see the slices of the larger original cells at the top of the image).</p>
<div class="admonition-note admonition">
<p class="admonition-title">Note</p>
<p>Also note that geowombat’s built in <code class="docutils literal notranslate"><span class="pre">.imshow</span></code> functionality doesn’t currently work for single band images. To get an image we have to extract a <code class="docutils literal notranslate"><span class="pre">np.ndarray</span></code> that has the shape <code class="docutils literal notranslate"><span class="pre">(1,</span> <span class="pre">1860,</span> <span class="pre">2041)</span></code>. Where <code class="docutils literal notranslate"><span class="pre">(1,.,.)</span></code> is the band, so to get a 2d array we select <code class="docutils literal notranslate"><span class="pre">data[0]</span></code>. We also avoid missing values (-9999).</p>
</div>
</div>
</div>
</div>
<span id="document-docs/e_raster_math"></span><div class="tex2jax_ignore mathjax_ignore section" id="band-math-w-rasterio">
<h2>Band Math w. Rasterio<a class="headerlink" href="#band-math-w-rasterio" title="Permalink to this headline">#</a></h2>
<hr class="docutils" />
<div class="admonition-learning-objectives admonition">
<p class="admonition-title">Learning Objectives</p>
<ul class="simple">
<li><p>Conduct mathematical operations on raster bands with rasterio</p></li>
<li><p>Understand the requirements for successful mathematical operations</p></li>
</ul>
</div>
<div class="admonition-review admonition">
<p class="admonition-title">Review</p>
<ul class="simple">
<li><p><a class="reference internal" href="docs/a_intro.html#document-docs/e_raster_reproject"><span class="doc std std-doc">Reproject Rasters w. Rasterio and Geowombat</span></a></p></li>
<li><p><a class="reference internal" href="docs/a_intro.html#document-docs/e_raster_resample"><span class="doc std std-doc">Resampling Rasters w. Rasterio and Geowombat</span></a></p></li>
</ul>
</div>
<hr class="docutils" />
<p>Band math is useful when you want to perform a mathematical operation to each pixel value in a raster. You might find band math helpful for calculating NDVI or multiplying all values by a constant.</p>
<div class="section" id="setup">
<h3>Setup<a class="headerlink" href="#setup" title="Permalink to this headline">#</a></h3>
<p>To begin, we will import our modules (click the + below to show code cell).</p>
<div class="cell tag_hide-cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Import modules</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">rasterio</span>
<span class="kn">from</span> <span class="nn">rasterio.transform</span> <span class="kn">import</span> <span class="n">Affine</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="band-math-with-rasterio-with-multiple-images">
<h3>Band Math with rasterio with multiple images<a class="headerlink" href="#band-math-with-rasterio-with-multiple-images" title="Permalink to this headline">#</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">Rasterio</span></code> makes band math relatively straightforward since the rasters are essentially read in as numpy arrays, so you can perform math on the raster arrays just like any numpy array.</p>
<div class="admonition attention">
<p class="admonition-title">Attention</p>
<p>Mathematical operations on rasters using <code class="docutils literal notranslate"><span class="pre">rasterio</span></code> are not spatially aware. Any mathematical operation with multiple rasters will work even if the rasters are not representing the same geographical extent. Consequently, you need to ensure that the cell size and extent represented in all rasters are the same. In other words, if you are using two rasters in a mathematical operation, they must have the same shape (same number of rows and columns).</p>
</div>
<p>In this example we will write two raster files to the disk: <code class="docutils literal notranslate"><span class="pre">math_raster_a.tif</span></code> and <code class="docutils literal notranslate"><span class="pre">math_raster_b.tif</span></code>. We will then read then back in and do math on them. Let’s generate some rasters (click the + below to show code cell).</p>
<div class="cell tag_hide-cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Generate mesh grid for rasters</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">90</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">90</span><span class="p">,</span> <span class="o">-</span><span class="mi">90</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
<span class="n">X</span><span class="p">,</span> <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

<span class="c1"># Generate values for mesh grid</span>
<span class="n">Z1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(((</span><span class="n">X</span> <span class="o">-</span> <span class="mi">10</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">Y</span> <span class="o">-</span> <span class="mi">10</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">Z2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(((</span><span class="n">X</span> <span class="o">+</span> <span class="mi">10</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">Y</span> <span class="o">+</span> <span class="mi">10</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.5</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">Z3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(((</span><span class="n">X</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">Y</span> <span class="o">-</span> <span class="mi">8</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">3</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>

<span class="c1"># Generate raster values for two rasters</span>
<span class="n">Z_a</span> <span class="o">=</span> <span class="p">(</span><span class="n">Z1</span> <span class="o">-</span> <span class="n">Z2</span><span class="p">)</span>
<span class="n">Z_b</span> <span class="o">=</span> <span class="p">(</span><span class="n">Z2</span> <span class="o">-</span> <span class="n">Z3</span><span class="p">)</span>

<span class="c1"># Set transform</span>
<span class="n">xres</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">yres</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
<span class="n">transform</span> <span class="o">=</span> <span class="n">Affine</span><span class="o">.</span><span class="n">translation</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">xres</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">yres</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">Affine</span><span class="o">.</span><span class="n">scale</span><span class="p">(</span><span class="n">xres</span><span class="p">,</span> <span class="n">yres</span><span class="p">)</span>

<span class="c1"># Save first raster</span>
<span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span>
        <span class="s2">&quot;../temp/math_raster_a.tif&quot;</span><span class="p">,</span>
        <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">,</span>
        <span class="n">driver</span><span class="o">=</span><span class="s2">&quot;GTiff&quot;</span><span class="p">,</span>
        <span class="n">height</span><span class="o">=</span><span class="n">Z_a</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="n">width</span><span class="o">=</span><span class="n">Z_a</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
        <span class="n">count</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">=</span><span class="n">Z_a</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
        <span class="n">crs</span><span class="o">=</span><span class="s2">&quot;+proj=latlong&quot;</span><span class="p">,</span>
        <span class="n">transform</span><span class="o">=</span><span class="n">transform</span><span class="p">,</span>
<span class="p">)</span> <span class="k">as</span> <span class="n">new_dataset</span><span class="p">:</span>
        <span class="n">new_dataset</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">Z_a</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="c1"># Save second raster</span>
<span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span>
        <span class="s2">&quot;../temp/math_raster_b.tif&quot;</span><span class="p">,</span>
        <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">,</span>
        <span class="n">driver</span><span class="o">=</span><span class="s2">&quot;GTiff&quot;</span><span class="p">,</span>
        <span class="n">height</span><span class="o">=</span><span class="n">Z_b</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="n">width</span><span class="o">=</span><span class="n">Z_b</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
        <span class="n">count</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">=</span><span class="n">Z_b</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
        <span class="n">crs</span><span class="o">=</span><span class="s2">&quot;+proj=latlong&quot;</span><span class="p">,</span>
        <span class="n">transform</span><span class="o">=</span><span class="n">transform</span><span class="p">,</span>
<span class="p">)</span> <span class="k">as</span> <span class="n">new_dataset</span><span class="p">:</span>
        <span class="n">new_dataset</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">Z_b</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Next, we’ll view the raster values.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Open raster and plot</span>
<span class="n">raster_a</span> <span class="o">=</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;../temp/math_raster_a.tif&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">raster_a</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="s2">&quot;BrBG&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Raster A&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># View raster values</span>
<span class="nb">print</span><span class="p">(</span><span class="n">raster_a</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/e_raster_math_5_0.png" src="../_images/e_raster_math_5_0.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[[13776.    8586.24  5573.76  4738.56  6080.64  9600.  ]
 [10256.64  5066.88  2054.4   1219.2   2561.28  6080.64]
 [ 8914.56  3724.8    712.32  -122.88  1219.2   4738.56]
 [ 9749.76  4560.    1547.52   712.32  2054.4   5573.76]
 [12762.24  7572.48  4560.    3724.8   5066.88  8586.24]
 [17952.   12762.24  9749.76  8914.56 10256.64 13776.  ]]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Open raster and plot</span>
<span class="n">raster_b</span> <span class="o">=</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;../temp/math_raster_b.tif&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">raster_b</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="s2">&quot;BrBG&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Raster B&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># View raster values</span>
<span class="nb">print</span><span class="p">(</span><span class="n">raster_b</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/e_raster_math_6_0.png" src="../_images/e_raster_math_6_0.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[[1886.55555556 1168.31555556  864.79555556  975.99555556 1501.91555556
  2442.55555556]
 [1453.91555556  735.67555556  432.15555556  543.35555556 1069.27555556
  2009.91555556]
 [1147.99555556  429.75555556  126.23555556  237.43555556  763.35555556
  1703.99555556]
 [ 968.79555556  250.55555556  -52.96444444   58.23555556  584.15555556
  1524.79555556]
 [ 916.31555556  198.07555556 -105.44444444    5.75555556  531.67555556
  1472.31555556]
 [ 990.55555556  272.31555556  -31.20444444   79.99555556  605.91555556
  1546.55555556]]
</pre></div>
</div>
</div>
</div>
<div class="section" id="example-band-math-operations">
<h4>Example band math operations<a class="headerlink" href="#example-band-math-operations" title="Permalink to this headline">#</a></h4>
<p>We can get the difference between the two rasters.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get difference</span>
<span class="n">difference_a_b</span> <span class="o">=</span> <span class="n">raster_a</span> <span class="o">-</span> <span class="n">raster_b</span>

<span class="c1"># Plot raster</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">difference_a_b</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="s2">&quot;BrBG&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Difference between Raster A &amp; Raster B&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Show raster values</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Raster values:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">difference_a_b</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/e_raster_math_8_0.png" src="../_images/e_raster_math_8_0.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Raster values:
 [[11889.44444444  7417.92444444  4708.96444444  3762.56444444
   4578.72444444  7157.44444444]
 [ 8802.72444444  4331.20444444  1622.24444444   675.84444444
   1492.00444444  4070.72444444]
 [ 7766.56444444  3295.04444444   586.08444444  -360.31555556
    455.84444444  3034.56444444]
 [ 8780.96444444  4309.44444444  1600.48444444   654.08444444
   1470.24444444  4048.96444444]
 [11845.92444444  7374.40444444  4665.44444444  3719.04444444
   4535.20444444  7113.92444444]
 [16961.44444444 12489.92444444  9780.96444444  8834.56444444
   9650.72444444 12229.44444444]]
</pre></div>
</div>
</div>
</div>
<p>We can multiply a raster by a constant.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get product</span>
<span class="n">product_a</span> <span class="o">=</span> <span class="n">raster_a</span> <span class="o">*</span> <span class="mi">2</span>

<span class="c1"># Plot raster</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">product_a</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="s2">&quot;BrBG&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Product of Raster A and 2&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Show raster values</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Raster values:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">product_a</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/e_raster_math_10_0.png" src="../_images/e_raster_math_10_0.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Raster values:
 [[27552.   17172.48 11147.52  9477.12 12161.28 19200.  ]
 [20513.28 10133.76  4108.8   2438.4   5122.56 12161.28]
 [17829.12  7449.6   1424.64  -245.76  2438.4   9477.12]
 [19499.52  9120.    3095.04  1424.64  4108.8  11147.52]
 [25524.48 15144.96  9120.    7449.6  10133.76 17172.48]
 [35904.   25524.48 19499.52 17829.12 20513.28 27552.  ]]
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="band-math-with-nodata-values">
<h4>Band math with NoData values<a class="headerlink" href="#band-math-with-nodata-values" title="Permalink to this headline">#</a></h4>
<p>If a pixel has a value of <code class="docutils literal notranslate"><span class="pre">nan</span></code>, <code class="docutils literal notranslate"><span class="pre">None</span></code>, or <code class="docutils literal notranslate"><span class="pre">NoData</span></code> value, those pixels will automatically be ignored in any band math. The output raster will maintain the <code class="docutils literal notranslate"><span class="pre">nan</span></code>, <code class="docutils literal notranslate"><span class="pre">None</span></code>, or <code class="docutils literal notranslate"><span class="pre">NoData</span></code> value at that pixel location.</p>
<p>Not all rasters, however, use those values to signify that a pixel has no value. Some rasters might use 0 or another number to indicate no value. In that case, we have to explicitly mark that pixel to be skipped.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create a copy of first raster</span>
<span class="n">raster_0</span> <span class="o">=</span> <span class="n">raster_a</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="c1"># Set a pixel value to 0 as an example, which will signify NoData</span>
<span class="c1"># (top right pixel)</span>
<span class="n">raster_0</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

<span class="c1"># Mask out any NoData (0) values</span>
<span class="n">raster_0_masked</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_array</span><span class="p">(</span><span class="n">raster_0</span><span class="p">,</span> <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">raster_0</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>

<span class="c1"># Get difference between masked raster and second raster</span>
<span class="n">difference_0_b</span> <span class="o">=</span> <span class="n">raster_0_masked</span> <span class="o">-</span> <span class="n">raster_b</span>

<span class="c1"># Plot raster</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">difference_0_b</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="s2">&quot;BrBG&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Difference between Raster A with NoData values &amp; Raster B&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Show raster values</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Raster values:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">difference_0_b</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/e_raster_math_12_0.png" src="../_images/e_raster_math_12_0.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Raster values:
 [[11889.444444444445 7417.924444444445 4708.964444444445
  3762.564444444444 4578.724444444444 --]
 [8802.724444444444 4331.204444444445 1622.2444444444445
  675.8444444444445 1492.0044444444443 4070.7244444444436]
 [7766.564444444444 3295.0444444444447 586.0844444444443
  -360.31555555555553 455.84444444444455 3034.564444444444]
 [8780.964444444444 4309.444444444444 1600.4844444444443
  654.0844444444443 1470.2444444444445 4048.964444444445]
 [11845.924444444445 7374.404444444444 4665.444444444444
  3719.0444444444447 4535.204444444445 7113.924444444445]
 [16961.444444444445 12489.924444444445 9780.964444444444
  8834.564444444444 9650.724444444444 12229.444444444445]]
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="example-calculating-ndvi">
<h4>Example: Calculating NDVI<a class="headerlink" href="#example-calculating-ndvi" title="Permalink to this headline">#</a></h4>
<p>In the example below, we will read in a clipped Landsat 8, Collection 2 Level-2 image and use the band math concepts to calculate the normalized difference vegetation index (NDVI) for the image. As you may recall, NDVI is a spectral approach used to assess vegetation. The formula for NDVI is:</p>
<div class="math notranslate nohighlight">
\[
  NDVI = \frac{NIR - Red}{NIR + Red}
\]</div>
<p>where <code class="docutils literal notranslate"><span class="pre">NIR</span></code> is the near-infrared band and <code class="docutils literal notranslate"><span class="pre">Red</span></code> is the red band.</p>
<p>High NDVI values (towards 1) reflect a higher density of green vegetation, and low values (towards -1) reflect a lower density.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Open raster (Landsat 8, Collection 2 Level-2)</span>
<span class="c1"># Band 1 - Blue, Band 2 - Green, Band 3 - Red, Band 4 - Near Infrared</span>
<span class="c1"># Source: https://www.usgs.gov/centers/eros/science/usgs-eros-archive-landsat-archives-landsat-8-9-olitirs-collection-2-level-2</span>
<span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;../data/LC08_L2SP_016040_20210317_20210328_02_T1_clip.tif&quot;</span><span class="p">,</span> <span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">nodata</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>

    <span class="c1"># Get red band</span>
    <span class="n">band_red</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

    <span class="c1"># Get NIR band</span>
    <span class="n">band_nir</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>

    <span class="c1"># Allow division by zero</span>
    <span class="n">np</span><span class="o">.</span><span class="n">seterr</span><span class="p">(</span><span class="n">divide</span> <span class="o">=</span> <span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">invalid</span> <span class="o">=</span> <span class="s2">&quot;ignore&quot;</span><span class="p">)</span>

    <span class="c1"># Calculate NDVI</span>
    <span class="n">ndvi</span> <span class="o">=</span> <span class="p">(</span><span class="n">band_nir</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span> <span class="o">-</span> <span class="n">band_red</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">band_nir</span> <span class="o">+</span> <span class="n">band_red</span><span class="p">)</span>

<span class="c1"># Set pixels whose values are outside the NDVI range (-1, 1) to NaN</span>
<span class="c1"># Likely due to errors in the Landsat imagery</span>
<span class="n">ndvi</span><span class="p">[</span><span class="n">ndvi</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
<span class="n">ndvi</span><span class="p">[</span><span class="n">ndvi</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

<span class="c1"># Plot raster</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">ndvi</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;NDVI&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Show raster values</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Raster values:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ndvi</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/e_raster_math_14_0.png" src="../_images/e_raster_math_14_0.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Raster values:
 [[0.1045768  0.08932138 0.09787864 ... 0.21016596 0.27657979 0.24717701]
 [0.07188325 0.1010677  0.1213656  ... 0.22981464 0.24469611 0.23835025]
 [0.03591049 0.14069341 0.17257186 ... 0.22467695 0.2150974  0.21510794]
 ...
 [0.27475696 0.24538079 0.24003341 ... 0.2692435  0.26424982 0.2754381 ]
 [0.28198954 0.26983464 0.25958875 ... 0.26693343 0.2685162  0.25831458]
 [0.27442722 0.28693113 0.2514506  ... 0.27998016 0.28904986 0.2745722 ]]
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="band-math-with-geowombat">
<h3>Band Math with GeoWombat<a class="headerlink" href="#band-math-with-geowombat" title="Permalink to this headline">#</a></h3>
<p>For band math with <code class="docutils literal notranslate"><span class="pre">GeoWombat</span></code>, see the chapter on <a class="reference internal" href="docs/a_intro.html#document-docs/f_rs_band_math"><span class="doc std std-doc">Band Math &amp; Vegetation Indices</span></a>.</p>
</div>
</div>
<span id="document-docs/e_raster_replace_values"></span><div class="tex2jax_ignore mathjax_ignore section" id="replacing-values-w-rasterio">
<h2>Replacing Values w. Rasterio<a class="headerlink" href="#replacing-values-w-rasterio" title="Permalink to this headline">#</a></h2>
<hr class="docutils" />
<div class="admonition-learning-objectives admonition">
<p class="admonition-title">Learning Objectives</p>
<ul class="simple">
<li><p>Replace and interpolate values in a raster with rasterio</p></li>
</ul>
</div>
<div class="admonition-review admonition">
<p class="admonition-title">Review</p>
<ul class="simple">
<li><p><a class="reference internal" href="docs/a_intro.html#document-docs/c_rasters"><span class="doc std std-doc">Spatial Raster Data</span></a></p></li>
</ul>
</div>
<hr class="docutils" />
<p>Imagery may sometimes have errors due to factors such as noise, distortion, or sensor errors. Some pixels may have extremely high or low values or no value at all. One way to resolve this issue is to manually replace a pixel value with another pixel value. Another option is to interpolate the pixel value based on the values of the pixel’s neighbors.</p>
<p>We’ll explore how to replace raster values with <code class="docutils literal notranslate"><span class="pre">rasterio</span></code>.</p>
<div class="section" id="setup">
<h3>Setup<a class="headerlink" href="#setup" title="Permalink to this headline">#</a></h3>
<p>First, we will import our modules (click the + below to show code cell).</p>
<div class="cell tag_hide-cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Import modules</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">rasterio</span>
<span class="kn">from</span> <span class="nn">rasterio.transform</span> <span class="kn">import</span> <span class="n">Affine</span>
<span class="kn">from</span> <span class="nn">rasterio.fill</span> <span class="kn">import</span> <span class="n">fillnodata</span>
</pre></div>
</div>
</div>
</div>
<p>Next, we will generate a sample raster to be used (click the + below to show code cell).</p>
<div class="cell tag_hide-cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Generate mesh grid for rasters</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">90</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">90</span><span class="p">,</span> <span class="o">-</span><span class="mi">90</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
<span class="n">X</span><span class="p">,</span> <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

<span class="c1"># Generate values for mesh grid</span>
<span class="n">Z1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(((</span><span class="n">X</span> <span class="o">-</span> <span class="mi">10</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">Y</span> <span class="o">-</span> <span class="mi">10</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">Z2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(((</span><span class="n">X</span> <span class="o">+</span> <span class="mi">10</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">Y</span> <span class="o">+</span> <span class="mi">10</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.5</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>

<span class="c1"># Generate raster values</span>
<span class="n">Z</span> <span class="o">=</span> <span class="p">(</span><span class="n">Z1</span> <span class="o">-</span> <span class="n">Z2</span><span class="p">)</span>

<span class="c1"># Set transform</span>
<span class="n">xres</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">yres</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
<span class="n">transform</span> <span class="o">=</span> <span class="n">Affine</span><span class="o">.</span><span class="n">translation</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">xres</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">yres</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">Affine</span><span class="o">.</span><span class="n">scale</span><span class="p">(</span><span class="n">xres</span><span class="p">,</span> <span class="n">yres</span><span class="p">)</span>

<span class="c1"># Save raster</span>
<span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span>
        <span class="s2">&quot;../temp/replace_values_raster.tif&quot;</span><span class="p">,</span>
        <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">,</span>
        <span class="n">driver</span><span class="o">=</span><span class="s2">&quot;GTiff&quot;</span><span class="p">,</span>
        <span class="n">height</span><span class="o">=</span><span class="n">Z</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="n">width</span><span class="o">=</span><span class="n">Z</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
        <span class="n">count</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">=</span><span class="n">Z</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
        <span class="n">crs</span><span class="o">=</span><span class="s2">&quot;+proj=latlong&quot;</span><span class="p">,</span>
        <span class="n">transform</span><span class="o">=</span><span class="n">transform</span><span class="p">,</span>
<span class="p">)</span> <span class="k">as</span> <span class="n">new_dataset</span><span class="p">:</span>
        <span class="n">new_dataset</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="replace-values-with-rasterio">
<h3>Replace values with rasterio<a class="headerlink" href="#replace-values-with-rasterio" title="Permalink to this headline">#</a></h3>
<p>We will open the example raster that we generated above.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Open raster and plot</span>
<span class="n">raster_file</span> <span class="o">=</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;../temp/replace_values_raster.tif&quot;</span><span class="p">)</span>
<span class="n">raster</span> <span class="o">=</span> <span class="n">raster_file</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">raster</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;BrBG&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Raster&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/e_raster_replace_values_5_0.png" src="../_images/e_raster_replace_values_5_0.png" />
</div>
</div>
<div class="section" id="replace-values-with-a-specified-number">
<h4>Replace values with a specified number<a class="headerlink" href="#replace-values-with-a-specified-number" title="Permalink to this headline">#</a></h4>
<p>Let’s say that we want to change the pixel value at row 150, column 100 because it’s wrong. We can simply call that pixel value by its row index and column index.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Replace value with 0 at one location</span>
<span class="n">raster</span><span class="p">[</span><span class="mi">150</span><span class="p">,</span> <span class="mi">100</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">raster</span><span class="p">[</span><span class="mi">150</span><span class="p">,</span> <span class="mi">100</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.0
</pre></div>
</div>
</div>
</div>
<p>We can also change multiple pixel values by slicing. In this case, we replace the values in rows 99-101 and columns 6-8 with the value <code class="docutils literal notranslate"><span class="pre">0</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Replace values with 0 at multiple locations</span>
<span class="n">raster</span><span class="p">[</span><span class="mi">99</span><span class="p">:</span><span class="mi">102</span><span class="p">,</span> <span class="mi">6</span><span class="p">:</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">raster</span><span class="p">[</span><span class="mi">99</span><span class="p">:</span><span class="mi">102</span><span class="p">,</span> <span class="mi">6</span><span class="p">:</span><span class="mi">9</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[0., 0., 0.],
       [0., 0., 0.],
       [0., 0., 0.]])
</pre></div>
</div>
</div>
</div>
<p>Finally, we can change any pixel values that are of a certain value.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Replace values with 0 if they are greater than or equal to certain number (in this case, 13776)</span>
<span class="n">raster</span><span class="p">[</span><span class="n">raster</span> <span class="o">&gt;=</span> <span class="mi">13776</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">raster</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[    0.        , 13618.93851165, 13463.25153405, ...,
         9371.19123254,  9484.9083609 ,  9600.        ],
       [13660.9083609 , 13503.84687255, 13348.15989495, ...,
         9256.09959344,  9369.8167218 ,  9484.9083609 ],
       [13547.19123254, 13390.1297442 , 13234.4427666 , ...,
         9142.38246509,  9256.09959344,  9371.19123254],
       ...,
       [    0.        ,     0.        ,     0.        , ...,
        13234.4427666 , 13348.15989495, 13463.25153405],
       [    0.        ,     0.        ,     0.        , ...,
        13390.1297442 , 13503.84687255, 13618.93851165],
       [    0.        ,     0.        ,     0.        , ...,
        13547.19123254, 13660.9083609 ,     0.        ]])
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="replace-values-through-interpolation">
<h4>Replace values through interpolation<a class="headerlink" href="#replace-values-through-interpolation" title="Permalink to this headline">#</a></h4>
<p>Sometimes, we don’t know or have an exact value to replace pixel values with. We can “fill in” those pixel values through interpolation. Recall that interpolation uses the pixel values surrounding a certain pixel to determine the value for that certain pixel.</p>
<p>In the following example, we will interpolate the values for the pixels that were previously set to <code class="docutils literal notranslate"><span class="pre">0</span></code>.</p>
<p><code class="docutils literal notranslate"><span class="pre">Rasterio</span></code> provides a function <code class="docutils literal notranslate"><span class="pre">fillnodata()</span></code> that does this for us. In addition to specifying a raster, we also need to provide a mask, which tells the function which pixel values need to be filled in. The mask can either be an array of Boolean values (<code class="docutils literal notranslate"><span class="pre">True</span></code> or <code class="docutils literal notranslate"><span class="pre">False</span></code>, where <code class="docutils literal notranslate"><span class="pre">False</span></code> indicates pixels to be filled in) or numbers (where values equal to <code class="docutils literal notranslate"><span class="pre">0</span></code> indicate pixels to be filled in and values equal to <code class="docutils literal notranslate"><span class="pre">1</span></code> indicate pixels to ignore).</p>
<p>For more information this function, see the <a class="reference external" href="https://rasterio.readthedocs.io/en/latest/api/rasterio.fill.html">function documentation</a>.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Mask must be in the same shape (number of rows and columns) as that of the input raster.</p>
</div>
<p>Below, we will interpolate the pixels whose values were previously set to <code class="docutils literal notranslate"><span class="pre">0</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create a Boolean mask (True/False), with a value of False for pixels that equal 0</span>
<span class="n">mask_boolean</span> <span class="o">=</span> <span class="p">(</span><span class="n">raster</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">mask_boolean</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[False,  True,  True, ...,  True,  True,  True],
       [ True,  True,  True, ...,  True,  True,  True],
       [ True,  True,  True, ...,  True,  True,  True],
       ...,
       [False, False, False, ...,  True,  True,  True],
       [False, False, False, ...,  True,  True,  True],
       [False, False, False, ...,  True,  True, False]])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create a value mask, with a value of 0 for pixels that equal 0</span>
<span class="n">mask_numbers</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">raster</span><span class="p">)</span>
<span class="n">mask_numbers</span><span class="p">[</span><span class="n">raster</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">255</span>
<span class="n">mask_numbers</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[  0., 255., 255., ..., 255., 255., 255.],
       [255., 255., 255., ..., 255., 255., 255.],
       [255., 255., 255., ..., 255., 255., 255.],
       ...,
       [  0.,   0.,   0., ..., 255., 255., 255.],
       [  0.,   0.,   0., ..., 255., 255., 255.],
       [  0.,   0.,   0., ..., 255., 255.,   0.]])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Fill in missing values with interpolation</span>
<span class="c1"># Can use either a Boolean mask or a value mask</span>
<span class="n">fillnodata</span><span class="p">(</span><span class="n">raster</span><span class="p">,</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">mask_boolean</span><span class="p">,</span> <span class="n">max_search_distance</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[13604.37988281, 13618.93847656, 13463.25195312, ...,
         9371.19140625,  9484.90820312,  9600.        ],
       [13660.90820312, 13503.84667969, 13348.16015625, ...,
         9256.09960938,  9369.81640625,  9484.90820312],
       [13547.19140625, 13390.12988281, 13234.44238281, ...,
         9142.3828125 ,  9256.09960938,  9371.19140625],
       ...,
       [13687.77148438, 13674.72460938, 13698.35644531, ...,
        13234.44238281, 13348.16015625, 13463.25195312],
       [13698.04101562, 13686.17285156, 13709.640625  , ...,
        13390.12988281, 13503.84667969, 13618.93847656],
       [13688.7734375 , 13672.33984375, 13704.9375    , ...,
        13547.19140625, 13660.90820312, 13618.93847656]])
</pre></div>
</div>
</div>
</div>
<p>Finally, we can check the raster values to see the interpolated values.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Print raster array</span>
<span class="n">raster</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[13604.37988281, 13618.93847656, 13463.25195312, ...,
         9371.19140625,  9484.90820312,  9600.        ],
       [13660.90820312, 13503.84667969, 13348.16015625, ...,
         9256.09960938,  9369.81640625,  9484.90820312],
       [13547.19140625, 13390.12988281, 13234.44238281, ...,
         9142.3828125 ,  9256.09960938,  9371.19140625],
       ...,
       [13687.77148438, 13674.72460938, 13698.35644531, ...,
        13234.44238281, 13348.16015625, 13463.25195312],
       [13698.04101562, 13686.17285156, 13709.640625  , ...,
        13390.12988281, 13503.84667969, 13618.93847656],
       [13688.7734375 , 13672.33984375, 13704.9375    , ...,
        13547.19140625, 13660.90820312, 13618.93847656]])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Print subset of raster around row 150, column 100</span>
<span class="n">raster</span><span class="p">[</span><span class="mi">148</span><span class="p">:</span><span class="mi">153</span><span class="p">,</span> <span class="mi">98</span><span class="p">:</span><span class="mi">103</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[2835.38891602, 2813.02954102, 2792.04467773, 2772.43432617,
        2754.19824219],
       [2923.72485352, 2901.36547852, 2880.38061523, 2860.77026367,
        2842.53417969],
       [3013.43530273, 2991.07592773, 2978.80517578, 2950.48071289,
        2932.24462891],
       [3104.52050781, 3082.16088867, 3061.17602539, 3041.56567383,
        3023.32983398],
       [3196.97998047, 3174.62036133, 3153.63549805, 3134.02514648,
        3115.78930664]])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Print subset of raster around rows 99-101, columns 6-8]</span>
<span class="n">raster</span><span class="p">[</span><span class="mi">97</span><span class="p">:</span><span class="mi">104</span><span class="p">,</span> <span class="mi">4</span><span class="p">:</span><span class="mi">11</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[8391.83398438, 8240.27050781, 8090.08154297, 7941.26757812,
        7793.82763672, 7647.76220703, 7503.07128906],
       [8410.0703125 , 8258.50683594, 8108.31787109, 7959.50341797,
        7812.06347656, 7665.99804688, 7521.30712891],
       [8429.68066406, 8278.1171875 , 8072.66064453, 7934.33056641,
        7755.44726562, 7685.60839844, 7540.91748047],
       [8450.66503906, 8299.1015625 , 8203.32421875, 7863.87109375,
        7767.40527344, 7706.59326172, 7561.90234375],
       [8473.02441406, 8321.4609375 , 8150.89306641, 7999.92822266,
        7799.43115234, 7728.95263672, 7584.26171875],
       [8496.75878906, 8345.1953125 , 8195.00683594, 8046.19189453,
        7898.75195312, 7752.68652344, 7607.99560547],
       [8521.8671875 , 8370.30371094, 8220.11523438, 8071.30029297,
        7923.86035156, 7777.79492188, 7633.10400391]])
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="replace-values-with-geowombat">
<h3>Replace values with <code class="docutils literal notranslate"><span class="pre">GeoWombat</span></code><a class="headerlink" href="#replace-values-with-geowombat" title="Permalink to this headline">#</a></h3>
<p>For replacing raster values with <code class="docutils literal notranslate"><span class="pre">GeoWombat</span></code>, see the chapter on <a class="reference internal" href="docs/a_intro.html#document-docs/f_rs_edit"><span class="doc std std-doc">Editing Rasters and Remotely Sensed Data</span></a>.</p>
</div>
</div>
<span id="document-docs/e_raster_rasterize"></span><div class="tex2jax_ignore mathjax_ignore section" id="rasterize-vectors-w-rasterio">
<h2>Rasterize Vectors w. Rasterio<a class="headerlink" href="#rasterize-vectors-w-rasterio" title="Permalink to this headline">#</a></h2>
<hr class="docutils" />
<div class="admonition-learning-objectives admonition">
<p class="admonition-title">Learning Objectives</p>
<ul class="simple">
<li><p>Convert vector data into raster format with rasterio</p></li>
<li><p>Understand the requirements for successful conversion</p></li>
</ul>
</div>
<div class="admonition-review admonition">
<p class="admonition-title">Review</p>
<ul class="simple">
<li><p><a class="reference internal" href="docs/a_intro.html#document-docs/c_vectors"><span class="doc std std-doc">Spatial Vector Data</span></a></p></li>
<li><p><a class="reference internal" href="docs/a_intro.html#document-docs/c_rasters"><span class="doc std std-doc">Spatial Raster Data</span></a></p></li>
<li><p><a class="reference internal" href="docs/a_intro.html#document-docs/e_raster_reproject"><span class="doc std std-doc">Reproject Rasters w. Rasterio and Geowombat</span></a></p></li>
</ul>
</div>
<hr class="docutils" />
<p>Rasterizing vectors can be helpful if you want to incorporate vector data (i.e., point, line, or polygon) in your raster analysis. The process is essentially what the name suggests: We take a vector and convert it into pixels. This can be done with <code class="docutils literal notranslate"><span class="pre">rasterio</span></code>.</p>
<div class="section" id="setup">
<h3>Setup<a class="headerlink" href="#setup" title="Permalink to this headline">#</a></h3>
<p>We’ll begin by importing our modules (click the + below to show code cell).</p>
<div class="cell tag_hide-cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Import modules</span>
<span class="kn">import</span> <span class="nn">geopandas</span> <span class="k">as</span> <span class="nn">gpd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">rasterio</span>
<span class="kn">from</span> <span class="nn">rasterio</span> <span class="kn">import</span> <span class="n">features</span>
<span class="kn">from</span> <span class="nn">rasterio.enums</span> <span class="kn">import</span> <span class="n">MergeAlg</span>
<span class="kn">from</span> <span class="nn">rasterio.plot</span> <span class="kn">import</span> <span class="n">show</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="rasterize-vectors-with-rasterio">
<h3>Rasterize vectors with rasterio<a class="headerlink" href="#rasterize-vectors-with-rasterio" title="Permalink to this headline">#</a></h3>
<p>We’ll read in the vector file of some of California’s counties. We will also read in a raster file to get the raster’s metadata (i.e., coordinate system) so that we can apply those parameters to the vector file. In other words, the raster will serve as a “reference” for the the rasterization of the vector. In particular, we are going to match the shape (number of rows and columns) and the transform (UL corner location, cell size etc). For a refresher on transforms, please see the chapter on <a class="reference internal" href="docs/a_intro.html#document-docs/d_affine"><span class="doc std std-doc">Affine Transforms</span></a>.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>The vector and raster <strong>must be</strong> be in the same coordinate system. If not, you’ll need to re-project one of them so they are the same. To re-project vectors, see the chapter on <a class="reference internal" href="docs/a_intro.html#document-docs/d_understand_crs_codes"><span class="doc std std-doc">Understanding CRS Codes</span></a>. To re-project rasters, see the chapter on <a class="reference internal" href="docs/a_intro.html#document-docs/e_raster_reproject"><span class="doc std std-doc">Reproject Rasters w. Rasterio and Geowombat</span></a>.</p>
</div>
<p>One important parameter in this function is <code class="docutils literal notranslate"><span class="pre">all_touched</span></code> which determines how zones are determined by polygons relative to the reference raster’s cell centroids. Setting it to <code class="docutils literal notranslate"><span class="pre">False</span></code> implies that membership in a zone, defined by a polygon geometry, should be defined by whether it contains the centroid of a cell. <code class="docutils literal notranslate"><span class="pre">True</span></code> includes any cell that geometry boundary intersects.</p>
<div class="figure align-default" id="all-touched-rasterization">
<img alt="../_images/zonal_stats.jpg" src="../_images/zonal_stats.jpg" />
<p class="caption"><span class="caption-number">Fig. 58 </span><span class="caption-text">all_touched determines the extent of zones</span><a class="headerlink" href="#all-touched-rasterization" title="Permalink to this image">#</a></p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Read in vector</span>
<span class="n">vector</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;../_static/e_vector_shapefiles/sf_bay_counties/sf_bay_counties.shp&quot;</span><span class="p">)</span>

<span class="c1"># Get list of geometries for all features in vector file</span>
<span class="n">geom</span> <span class="o">=</span> <span class="p">[</span><span class="n">shapes</span> <span class="k">for</span> <span class="n">shapes</span> <span class="ow">in</span> <span class="n">vector</span><span class="o">.</span><span class="n">geometry</span><span class="p">]</span>

<span class="c1"># Open example raster</span>
<span class="n">raster</span> <span class="o">=</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;../_static/e_raster/bay-area-wells_kde_sklearn.tif&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="rasterize-binary-values-for-shapes">
<h4>Rasterize Binary Values for Shapes<a class="headerlink" href="#rasterize-binary-values-for-shapes" title="Permalink to this headline">#</a></h4>
<p>With our data loaded, we can rasterize the vector using the metadata from the raster using <code class="docutils literal notranslate"><span class="pre">rasterize()</span></code> in the <code class="docutils literal notranslate"><span class="pre">rasterio.features</span></code> module. For more information on this function, check out <a class="reference external" href="https://rasterio.readthedocs.io/en/latest/api/rasterio.features.html#rasterio.features.rasterize">the <code class="docutils literal notranslate"><span class="pre">rasterio</span></code> documentation</a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Rasterize vector using the shape and coordinate system of the raster</span>
<span class="n">rasterized</span> <span class="o">=</span> <span class="n">features</span><span class="o">.</span><span class="n">rasterize</span><span class="p">(</span><span class="n">geom</span><span class="p">,</span>
                                <span class="n">out_shape</span> <span class="o">=</span> <span class="n">raster</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
                                <span class="n">fill</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                                <span class="n">out</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                <span class="n">transform</span> <span class="o">=</span> <span class="n">raster</span><span class="o">.</span><span class="n">transform</span><span class="p">,</span>
                                <span class="n">all_touched</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                                <span class="n">default_value</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
                                <span class="n">dtype</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span>

<span class="c1"># Plot raster</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="n">show</span><span class="p">(</span><span class="n">rasterized</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/e_raster_rasterize_5_0.png" src="../_images/e_raster_rasterize_5_0.png" />
</div>
</div>
</div>
<div class="section" id="rasterize-attribute-value-using-rasterio">
<h4>Rasterize Attribute Value using Rasterio<a class="headerlink" href="#rasterize-attribute-value-using-rasterio" title="Permalink to this headline">#</a></h4>
<p>Often we want to burn in the value of a shapefile’s attributes to the raster. We can do this by creating geometry, value pairs. In this example we take create a columns called <code class="docutils literal notranslate"><span class="pre">id</span></code> and assign the same values as the index. <code class="docutils literal notranslate"><span class="pre">id</span></code> will then be used to create our (geometry, value) pairs used for rasterization.</p>
<p>Note we use <code class="docutils literal notranslate"><span class="pre">all_touched=True</span></code> to avoid gaps between counties, which can introduce its own problems b/c two counties can compete for the same cell.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># create a numeric unique value for each row</span>
<span class="n">vector</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">vector</span><span class="p">))</span>

<span class="c1"># create tuples of geometry, value pairs, where value is the attribute value you want to burn</span>
<span class="n">geom_value</span> <span class="o">=</span> <span class="p">((</span><span class="n">geom</span><span class="p">,</span><span class="n">value</span><span class="p">)</span> <span class="k">for</span> <span class="n">geom</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">vector</span><span class="o">.</span><span class="n">geometry</span><span class="p">,</span> <span class="n">vector</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]))</span>

<span class="c1"># Rasterize vector using the shape and transform of the raster</span>
<span class="n">rasterized</span> <span class="o">=</span> <span class="n">features</span><span class="o">.</span><span class="n">rasterize</span><span class="p">(</span><span class="n">geom_value</span><span class="p">,</span>
                                <span class="n">out_shape</span> <span class="o">=</span> <span class="n">raster</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
                                <span class="n">transform</span> <span class="o">=</span> <span class="n">raster</span><span class="o">.</span><span class="n">transform</span><span class="p">,</span>
                                <span class="n">all_touched</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                <span class="n">fill</span> <span class="o">=</span> <span class="o">-</span><span class="mi">5</span><span class="p">,</span>   <span class="c1"># background value</span>
                                <span class="n">merge_alg</span> <span class="o">=</span> <span class="n">MergeAlg</span><span class="o">.</span><span class="n">replace</span><span class="p">,</span>
                                <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span>

<span class="c1"># Plot raster</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="n">show</span><span class="p">(</span><span class="n">rasterized</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/e_raster_rasterize_7_0.png" src="../_images/e_raster_rasterize_7_0.png" />
</div>
</div>
<p>Finally, we can save the rasterized vector out.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span>
        <span class="s2">&quot;../temp/rasterized_vector.tif&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span>
        <span class="n">driver</span> <span class="o">=</span> <span class="s2">&quot;GTiff&quot;</span><span class="p">,</span>
        <span class="n">transform</span> <span class="o">=</span> <span class="n">raster</span><span class="o">.</span><span class="n">transform</span><span class="p">,</span>
        <span class="n">dtype</span> <span class="o">=</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">uint8</span><span class="p">,</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">width</span> <span class="o">=</span> <span class="n">raster</span><span class="o">.</span><span class="n">width</span><span class="p">,</span>
        <span class="n">height</span> <span class="o">=</span> <span class="n">raster</span><span class="o">.</span><span class="n">height</span><span class="p">)</span> <span class="k">as</span> <span class="n">dst</span><span class="p">:</span>
    <span class="n">dst</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">rasterized</span><span class="p">,</span> <span class="n">indexes</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
</div>
<span id="document-docs/e_raster_window_operations"></span><div class="tex2jax_ignore mathjax_ignore section" id="window-operations-with-rasterio-and-geowombat">
<h2>Window Operations with Rasterio and GeoWombat<a class="headerlink" href="#window-operations-with-rasterio-and-geowombat" title="Permalink to this headline">#</a></h2>
<hr class="docutils" />
<div class="admonition-learning-objectives admonition">
<p class="admonition-title">Learning Objectives</p>
<ul class="simple">
<li><p>Conduct and understand window operations with rasterio</p></li>
<li><p>Conduct window operations with GeoWombat</p></li>
</ul>
</div>
<div class="admonition-review admonition">
<p class="admonition-title">Review</p>
<ul class="simple">
<li><p><a class="reference internal" href="docs/a_intro.html#document-docs/c_rasters"><span class="doc std std-doc">Spatial Raster Data</span></a></p></li>
</ul>
</div>
<hr class="docutils" />
<div class="section" id="background">
<h3>Background<a class="headerlink" href="#background" title="Permalink to this headline">#</a></h3>
<p>Moving windows or filters are often used in raster analysis. For example, they can be used to obtain the maximum value within a certain neighborhood, to smooth out values, or detect holes or edges (i.e., where pixel values that are near each other change abruptly).</p>
<p>These moving windows can also be called filters or kernels. They can be of many different sizes and shapes (the most common is 3-cell-by-3-cell rectangular window) and can have different or the same values for each cell. The center of the filter can be called the target cell or the center pixel, and the surrounding cells are referred to as the neighbors.</p>
<p>The filter passes through all <em>non-edge</em> cells in the raster. During each pass of the filter, the center cell is updated based on the cells adjacent to it. In the <code class="docutils literal notranslate"><span class="pre">3x3</span></code> filter example, the center cell is updated by the eight cells that neighbor it. The filter then pulls the values from the neighboring cells and the center pixel itself, performs a calculation based on the filter values (e.g., calculates the mean), reports that resulting value back to the identical location of the original pixel, moves to the next pixel, and repeats the process.</p>
<div class="figure align-default" id="sliding-window-operations">
<img alt="../_images/raster_sliding_window.jpg" src="../_images/raster_sliding_window.jpg" />
<p class="caption"><span class="caption-number">Fig. 59 </span><span class="caption-text">Sliding window operations move across an entire raster.</span><a class="headerlink" href="#sliding-window-operations" title="Permalink to this image">#</a></p>
</div>
<p>The filter values can essentially be any number–they can be the same across the filter or be all different. The values determine how the output is calculated (equation below assuming a <code class="docutils literal notranslate"><span class="pre">3x3</span></code> filter for nine cells total in the kernel):</p>
<div class="math notranslate nohighlight">
\[
    X_{w} = \sum_{i=1}^{9}X_{i}k_{i}
\]</div>
<p><em>where:</em>
X_{i} = raster cell value</p>
<p>k_{i} = kernel cell value</p>
<p>i = index of cells in the nine kernel cell values</p>
<p>The values also determine <em>what</em> is calculated. For example, setting all filter values to <code class="docutils literal notranslate"><span class="pre">1</span></code> will result in the filter outputting the sum of all raster pixel values within the filter. Setting all filter values to <code class="docutils literal notranslate"><span class="pre">1/9</span></code> for a <code class="docutils literal notranslate"><span class="pre">3x3</span></code> filter will result in the filter outputting the average of all raster pixel values within the filter.</p>
<div class="figure align-default" id="moving-window-operation-examples">
<img alt="../_images/raster_window_operations.jpg" src="../_images/raster_window_operations.jpg" />
<p class="caption"><span class="caption-number">Fig. 60 </span><span class="caption-text">Example filter values for <code class="docutils literal notranslate"><span class="pre">3x3</span></code> moving windows. Different filter value combinations and arrangements can produce different outputs.</span><a class="headerlink" href="#moving-window-operation-examples" title="Permalink to this image">#</a></p>
</div>
<p>For more information on moving windows, see the <a class="reference external" href="https://saylordotorg.github.io/text_essentials-of-geographic-information-systems/s12-02-scale-of-analysis.html">“Neighborhood Operations” section in this chapter on raster geoprocessing</a>.</p>
<div class="admonition attention">
<p class="admonition-title">Attention</p>
<p>With window operations, the edge pixels will generally be cut out from the output because those edge pixels do not have neighboring pixels all around it. As window operations generally require a pixel to be surrounded on all four sides, we cannot perform calculations on these edge pixels. The pixels that constitute the “edge” depends on the shape of the kernel. For example, a <code class="docutils literal notranslate"><span class="pre">3x3</span></code> kernel only requires 1 neighboring pixel in each direction, so only the outer ring of pixels will be cut out from the output. A <code class="docutils literal notranslate"><span class="pre">5x5</span></code> kernel requires 2 neighboring pixels in each direction, so the two outer rings of pixels will be cut out.</p>
</div>
</div>
<div class="section" id="setup">
<h3>Setup<a class="headerlink" href="#setup" title="Permalink to this headline">#</a></h3>
<p>We’ll explore two methods, one using <code class="docutils literal notranslate"><span class="pre">rasterio</span></code> and another using <code class="docutils literal notranslate"><span class="pre">GeoWombat</span></code>.</p>
<p>First, we’ll import our modules (click the + below to show code cell).</p>
<div class="cell tag_hide-cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Import modules</span>
<span class="kn">import</span> <span class="nn">geowombat</span> <span class="k">as</span> <span class="nn">gw</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">product</span>
<span class="kn">import</span> <span class="nn">rasterio</span>
<span class="kn">from</span> <span class="nn">rasterio.transform</span> <span class="kn">import</span> <span class="n">Affine</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="window-operations-with-rasterio">
<h3>Window operations with rasterio<a class="headerlink" href="#window-operations-with-rasterio" title="Permalink to this headline">#</a></h3>
<p>The most intuitive way to perform window operations in Python is to use a <code class="docutils literal notranslate"><span class="pre">for</span></code> loop. With this method, we would iterate through each non-edge pixel, obtain the surrounding pixel values and the center pixel value, perform some sort of calculation, report that resulting value back to the identical location of the original pixel, move to the next pixel, and repeat the process. Iterating through each pixel, however, has the potential to be extremely time and computationally intensive (there could be many, many pixels).</p>
<p>To mitigate this limitation, instead of using a <code class="docutils literal notranslate"><span class="pre">for</span></code> loop, we can get each neighbor value simultaneously for all non-edge pixels. Another way to think of it is that instead of using a <code class="docutils literal notranslate"><span class="pre">for</span></code> loop to iterate through each pixel to get neighboring values, we can iterate through each kernel position to get the neighboring value corresponding to a certain kernel position for all non-edge pixels at once. This is what a vectorized sliding window does.</p>
<p>The vectorized sliding window is grounded in the concept that each position in the kernel has a certain relative position or offset (e.g., one pixel to the left) from the center pixel of the kernel. This method works because each pixel in a raster is in essence a neighbor to at least one other pixel. The vectorized sliding window simply offsets itself within the raster array extent so that each pixel that falls within the vectorized sliding window is the neighbor of the same relative position (e.g., one pixel to the left) to its center pixel.</p>
<p>A vectorized sliding window is created for each position in the kernel. The vectorized sliding window of a certain kernel position is applied over the raster and obtains–all at once–the neighboring pixel value corresponding to that kernel position for all non-edge pixels. The size of vectorized sliding window is dependent on the size of the raster and kernel but will always fall between the two.</p>
<p>For more conceptual information on vectorized sliding windows and how they compare to iterating through each pixel, see <a class="reference external" href="https://opensourceoptions.com/blog/vectorize-moving-window-grid-operations-on-numpy-arrays/">this article</a>.</p>
<p>Let’s create a raster (click the + below to show code cell).</p>
<div class="cell tag_hide-cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Generate mesh grid for rasters</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">90</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">90</span><span class="p">,</span> <span class="o">-</span><span class="mi">90</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
<span class="n">X</span><span class="p">,</span> <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

<span class="c1"># Generate values for mesh grid</span>
<span class="n">Z1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(((</span><span class="n">X</span> <span class="o">-</span> <span class="mi">10</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">Y</span> <span class="o">-</span> <span class="mi">10</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">Z2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(((</span><span class="n">X</span> <span class="o">+</span> <span class="mi">10</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">Y</span> <span class="o">+</span> <span class="mi">10</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.5</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">Z3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(((</span><span class="n">X</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">Y</span> <span class="o">-</span> <span class="mi">8</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">3</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>

<span class="c1"># Generate raster values</span>
<span class="n">Z</span> <span class="o">=</span> <span class="p">(</span><span class="n">Z1</span> <span class="o">-</span> <span class="n">Z2</span><span class="p">)</span>

<span class="c1"># Set transform</span>
<span class="n">xres</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">yres</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
<span class="n">transform</span> <span class="o">=</span> <span class="n">Affine</span><span class="o">.</span><span class="n">translation</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">xres</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">yres</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">Affine</span><span class="o">.</span><span class="n">scale</span><span class="p">(</span><span class="n">xres</span><span class="p">,</span> <span class="n">yres</span><span class="p">)</span>

<span class="c1"># Save first raster</span>
<span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span>
        <span class="s2">&quot;../temp/window_raster.tif&quot;</span><span class="p">,</span>
        <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">,</span>
        <span class="n">driver</span><span class="o">=</span><span class="s2">&quot;GTiff&quot;</span><span class="p">,</span>
        <span class="n">height</span><span class="o">=</span><span class="n">Z</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="n">width</span><span class="o">=</span><span class="n">Z</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
        <span class="n">count</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">=</span><span class="n">Z</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
        <span class="n">crs</span><span class="o">=</span><span class="s2">&quot;+proj=latlong&quot;</span><span class="p">,</span>
        <span class="n">transform</span><span class="o">=</span><span class="n">transform</span><span class="p">,</span>
<span class="p">)</span> <span class="k">as</span> <span class="n">new_dataset</span><span class="p">:</span>
        <span class="n">new_dataset</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="c1"># Open and read raster</span>
<span class="n">src</span> <span class="o">=</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;../temp/window_raster.tif&quot;</span><span class="p">)</span>
<span class="n">raster</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Plot raster</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">raster</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;BrBG&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Raster&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Show raster values</span>
<span class="nb">print</span><span class="p">(</span><span class="n">raster</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/e_raster_window_operations_3_0.png" src="../_images/e_raster_window_operations_3_0.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[[13776.    8586.24  5573.76  4738.56  6080.64  9600.  ]
 [10256.64  5066.88  2054.4   1219.2   2561.28  6080.64]
 [ 8914.56  3724.8    712.32  -122.88  1219.2   4738.56]
 [ 9749.76  4560.    1547.52   712.32  2054.4   5573.76]
 [12762.24  7572.48  4560.    3724.8   5066.88  8586.24]
 [17952.   12762.24  9749.76  8914.56 10256.64 13776.  ]]
</pre></div>
</div>
</div>
</div>
<div class="section" id="create-kernel">
<h4>Create kernel<a class="headerlink" href="#create-kernel" title="Permalink to this headline">#</a></h4>
<p>Second, we can generate a kernel array. The array can consist of a single value or multiple values. Below, we generate a <code class="docutils literal notranslate"><span class="pre">3x3</span></code> kernel consisting of the value <code class="docutils literal notranslate"><span class="pre">1/9</span></code>. This kernel will output the average value of the center cell and its surrounding eight neighbors.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>The kernel should have an odd number of rows and columns and should not have more rows and columns than the input raster.</p>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>To create a non-rectangular shape, simply add <code class="docutils literal notranslate"><span class="pre">0</span></code>s in the kernel positions to be ignored.</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create a kernel to calculate the average</span>
<span class="n">kernel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="mi">1</span><span class="o">/</span><span class="mi">9</span><span class="p">)</span>

<span class="c1"># Get kernel shape</span>
<span class="n">kernel_shape</span> <span class="o">=</span> <span class="n">kernel</span><span class="o">.</span><span class="n">shape</span>

<span class="c1"># Convert the kernel to a flattened array</span>
<span class="n">kernel_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">kernel</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="create-output-arrays">
<h4>Create output arrays<a class="headerlink" href="#create-output-arrays" title="Permalink to this headline">#</a></h4>
<p>Next, we will create two arrays that will store our calculations.</p>
<p>The first array is the output array, which has the same shape as that of the input raster. We will initially fill the array with placeholder values. This array will be the final result that is exported and saved.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create raster array with placeholder values in shape of raster</span>
<span class="n">output_rio</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">raster</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">raster</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="o">-</span><span class="mi">9999</span><span class="p">)</span>

<span class="c1"># Set array data type</span>
<span class="n">output_rio</span> <span class="o">=</span> <span class="n">output_rio</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span> <span class="c1">###</span>

<span class="c1"># Display raster array with placeholder values</span>
<span class="nb">print</span><span class="p">(</span><span class="n">output_rio</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[[-9999. -9999. -9999. -9999. -9999. -9999.]
 [-9999. -9999. -9999. -9999. -9999. -9999.]
 [-9999. -9999. -9999. -9999. -9999. -9999.]
 [-9999. -9999. -9999. -9999. -9999. -9999.]
 [-9999. -9999. -9999. -9999. -9999. -9999.]
 [-9999. -9999. -9999. -9999. -9999. -9999.]]
</pre></div>
</div>
</div>
</div>
<p>The second array, initially filled with <code class="docutils literal notranslate"><span class="pre">0</span></code>s, will hold the pixel value as calculated from the vectorized sliding windows (e.g., mean). Since we are not performing calculations on any edge pixels, the shape of this array is slightly smaller than that of the input raster and also dependent on the shape of the kernel. This array will be inserted into and replace the non-edge placeholder values in the output array (which we just created).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create raster array used to store window operation calculations for each pixel (excluding boundary pixels)</span>
<span class="n">aggregate</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">raster</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">kernel_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">raster</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">kernel_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>

<span class="c1"># Set array data type</span>
<span class="n">aggregate</span> <span class="o">=</span> <span class="n">aggregate</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

<span class="c1"># Display raster array</span>
<span class="nb">print</span><span class="p">(</span><span class="n">aggregate</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[[0. 0. 0. 0.]
 [0. 0. 0. 0.]
 [0. 0. 0. 0.]
 [0. 0. 0. 0.]]
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="create-vectorized-sliding-window">
<h4>Create vectorized sliding window<a class="headerlink" href="#create-vectorized-sliding-window" title="Permalink to this headline">#</a></h4>
<p>The next step is to generate the vectorized sliding windows. The shape of the vectorized sliding windows depends on the kernel shape, so we utilize indices and slicing to obtain the extent of a vectorized sliding window for each position in the kernel.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Generate row index pairs for slicing</span>
<span class="n">pairs_x</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">([</span><span class="kc">None</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">kernel_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])),</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="n">kernel_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">+</span> <span class="p">[</span><span class="kc">None</span><span class="p">]))</span>

<span class="c1"># Generate column index pairs for slicing</span>
<span class="n">pairs_y</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">([</span><span class="kc">None</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">kernel_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])),</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="n">kernel_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">+</span> <span class="p">[</span><span class="kc">None</span><span class="p">]))</span>

<span class="c1"># Combine row and column index pairs together to get the extent for each vectorized sliding window</span>
<span class="n">combos</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">product</span><span class="p">(</span><span class="n">pairs_x</span><span class="p">,</span> <span class="n">pairs_y</span><span class="p">))</span>

<span class="c1"># Display combined pairs</span>
<span class="nb">print</span><span class="p">(</span><span class="n">combos</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[((None, -2), (None, -2)), ((None, -2), (1, -1)), ((None, -2), (2, None)), ((1, -1), (None, -2)), ((1, -1), (1, -1)), ((1, -1), (2, None)), ((2, None), (None, -2)), ((2, None), (1, -1)), ((2, None), (2, None))]
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="apply-vectorized-sliding-window">
<h4>Apply vectorized sliding window<a class="headerlink" href="#apply-vectorized-sliding-window" title="Permalink to this headline">#</a></h4>
<p>Once the vectorized sliding windows are specified, we can apply them to the raster. The vectorized sliding window will get a subset of the raster array, and we can multiply all the pixel values in that subset by the corresponding value in the kernel, which is based on window’s specific kernel position.</p>
<p>The product is then added to the array that keeps track of the running total.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create empty list to store each window operation calculation</span>
<span class="n">sub_array_list</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># Iterate through the combined pairs (which give extent of a sliding window)</span>
<span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">combos</span><span class="p">)):</span>

    <span class="c1"># Get the sub-array via slicing and multiply all the values by corresponding value in kernel (based on location)</span>
    <span class="n">sub_array</span> <span class="o">=</span> <span class="n">raster</span><span class="p">[</span><span class="n">combos</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span><span class="n">combos</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">combos</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span><span class="n">combos</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span> <span class="o">*</span> <span class="n">kernel_array</span><span class="p">[</span><span class="n">p</span><span class="p">]</span>

    <span class="c1"># Add sub-array values to array storing window operation calculations</span>
    <span class="n">aggregate</span> <span class="o">+=</span> <span class="n">sub_array</span>

    <span class="c1"># Add sub-array to list</span>
    <span class="n">sub_array_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sub_array</span><span class="p">)</span>

<span class="c1"># View array storing window operation calculations</span>
<span class="nb">print</span><span class="p">(</span><span class="n">aggregate</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[[6518.4  3505.92 2670.72 4012.8 ]
 [5176.32 2163.84 1328.64 2670.72]
 [6011.52 2999.04 2163.84 3505.92]
 [9024.   6011.52 5176.32 6518.4 ]]
</pre></div>
</div>
</div>
</div>
<p>Once we get the aggregate of all windows, we can perform additional computations. In this case, we multiply all values by <code class="docutils literal notranslate"><span class="pre">2</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get average value</span>
<span class="n">aggregate</span> <span class="o">=</span> <span class="n">aggregate</span> <span class="o">*</span> <span class="mi">2</span>

<span class="c1"># View array storing window operation calculations</span>
<span class="nb">print</span><span class="p">(</span><span class="n">aggregate</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[[13036.8   7011.84  5341.44  8025.6 ]
 [10352.64  4327.68  2657.28  5341.44]
 [12023.04  5998.08  4327.68  7011.84]
 [18048.   12023.04 10352.64 13036.8 ]]
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="window-operations-with-predefined-functions">
<h4>Window operations with predefined functions<a class="headerlink" href="#window-operations-with-predefined-functions" title="Permalink to this headline">#</a></h4>
<p>We can also perform window operations with predefined functions, such as getting the maximum value of a pixel and its surrounding pixels. We simply take the calculations from each vectorized sliding window and get the maximum value from those calculations.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>To get the maximum or minimum value of a pixel and its surrounding neighbors, the kernel should be filled with values of <code class="docutils literal notranslate"><span class="pre">1</span></code> so that the pixel values don’t change.</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get maximum value</span>
<span class="n">window_maximum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">sub_array_list</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">window_maximum</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[[1530.66666667  954.02666667  675.62666667 1066.66666667]
 [1139.62666667  562.98666667  284.58666667  675.62666667]
 [1418.02666667  841.38666667  562.98666667  954.02666667]
 [1994.66666667 1418.02666667 1139.62666667 1530.66666667]]
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="save-output">
<h4>Save output<a class="headerlink" href="#save-output" title="Permalink to this headline">#</a></h4>
<p>We can insert the processed aggregate array into the output array, with each value replacing the placeholder value at its corresponding original position in the array. Recall that because edge pixels are ignored, the edge pixels of the output array will still keep their placeholder values.</p>
<p>In this example, each non-edge output pixel value is the average pixel value–with pixel values drawn from the input raster–of the 8 pixels surrounding that pixel and the pixel itself.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Use kernel shape to determine the row and column index extent of the calculated array</span>
<span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">kernel_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">m</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">kernel_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>

<span class="c1"># Replace placeholder values in the output array with the corresponding values (based on location) from the calculated array</span>
<span class="n">output_rio</span><span class="p">[</span><span class="n">n</span><span class="p">:</span><span class="o">-</span><span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">:</span><span class="o">-</span><span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="n">aggregate</span>

<span class="c1"># Display output array</span>
<span class="nb">print</span><span class="p">(</span><span class="n">output_rio</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[[-9999.   -9999.   -9999.   -9999.   -9999.   -9999.  ]
 [-9999.   13036.8   7011.84  5341.44  8025.6  -9999.  ]
 [-9999.   10352.64  4327.68  2657.28  5341.44 -9999.  ]
 [-9999.   12023.04  5998.08  4327.68  7011.84 -9999.  ]
 [-9999.   18048.   12023.04 10352.64 13036.8  -9999.  ]
 [-9999.   -9999.   -9999.   -9999.   -9999.   -9999.  ]]
</pre></div>
</div>
</div>
</div>
<p>Finally, we can export the raster (click the + below to show code cell).</p>
<div class="cell tag_hide-cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Export raster</span>
<span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span>
        <span class="s2">&quot;../temp/raster_window_3x3_average.tif&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span>
        <span class="n">driver</span><span class="o">=</span><span class="s2">&quot;GTiff&quot;</span><span class="p">,</span>
        <span class="n">transform</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">transform</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">=</span><span class="n">rasterio</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span>
        <span class="n">count</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">width</span><span class="o">=</span><span class="n">src</span><span class="o">.</span><span class="n">width</span><span class="p">,</span>
        <span class="n">height</span><span class="o">=</span><span class="n">src</span><span class="o">.</span><span class="n">height</span><span class="p">)</span> <span class="k">as</span> <span class="n">dst</span><span class="p">:</span>
    <span class="n">dst</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">output_rio</span><span class="p">,</span> <span class="n">indexes</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="window-operations-with-geowombat">
<h3>Window operations with GeoWombat<a class="headerlink" href="#window-operations-with-geowombat" title="Permalink to this headline">#</a></h3>
<p>We can use <code class="docutils literal notranslate"><span class="pre">GeoWombat</span></code> for window operations if we’re only interested in calculating a statistic. The code to do this with <code class="docutils literal notranslate"><span class="pre">GeoWombat</span></code> is less complex and much shorter than with <code class="docutils literal notranslate"><span class="pre">rasterio</span></code>–we can simply use the <code class="docutils literal notranslate"><span class="pre">geowombat.moving()</span></code> function.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">geowombat.moving()</span></code> function provides us with a few parameters that we can specify:</p>
<table class="colwidths-auto docutils align-default">
<thead>
<tr class="row-odd"><th class="text-align:left head"><p>Parameter</p></th>
<th class="text-align:right head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td class="text-align:left"><p><code class="docutils literal notranslate"><span class="pre">stat</span></code></p></td>
<td class="text-align:right"><p>statistic calculated (options: mean, standard deviation, variance, minimum, maximum, percentile)</p></td>
</tr>
<tr class="row-odd"><td class="text-align:left"><p><code class="docutils literal notranslate"><span class="pre">perc</span></code></p></td>
<td class="text-align:right"><p>percentile used for window operation if <code class="docutils literal notranslate"><span class="pre">stat</span> <span class="pre">=</span> <span class="pre">perc</span></code></p></td>
</tr>
<tr class="row-even"><td class="text-align:left"><p><code class="docutils literal notranslate"><span class="pre">w</span></code></p></td>
<td class="text-align:right"><p>moving window size in pixels</p></td>
</tr>
<tr class="row-odd"><td class="text-align:left"><p><code class="docutils literal notranslate"><span class="pre">nodata</span></code></p></td>
<td class="text-align:right"><p>value that will be ignored in calculations</p></td>
</tr>
</tbody>
</table>
<p>For more information this function, see the <a class="reference external" href="https://geowombat.readthedocs.io/en/latest/moving.html">function documentation</a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Open file</span>
<span class="k">with</span> <span class="n">gw</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;../temp/window_raster.tif&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>

    <span class="c1"># Create plot</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">dpi</span> <span class="o">=</span> <span class="mi">200</span><span class="p">)</span>

    <span class="c1"># Calculate local average</span>
    <span class="n">output_gw</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">gw</span><span class="o">.</span><span class="n">moving</span><span class="p">(</span><span class="n">stat</span> <span class="o">=</span> <span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="n">n_jobs</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="n">nodata</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">output_gw</span><span class="p">)</span>

    <span class="c1"># Plot raster</span>
    <span class="n">output_gw</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">band</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">gw</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">robust</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">pad</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;xarray.DataArray &#39;stack-ebf4780c581d90fd1a920017bb13440d&#39; (band: 1, y: 6, x: 6)&gt;
dask.array&lt;stack, shape=(1, 6, 6), dtype=float64, chunksize=(1, 6, 6), chunktype=numpy.ndarray&gt;
Coordinates:
  * band     (band) int64 1
  * y        (y) float64 90.0 60.0 30.0 0.0 -30.0 -60.0
  * x        (x) float64 -90.0 -60.0 -30.0 0.0 30.0 60.0
Attributes: (12/14)
    transform:           (30.0, 0.0, -105.0, 0.0, -30.0, 105.0)
    crs:                 +init=epsg:4326
    res:                 (30.0, 30.0)
    is_tiled:            0
    nodatavals:          (nan,)
    scales:              (1.0,)
    ...                  ...
    filename:            ../temp/window_raster.tif
    resampling:          nearest
    data_are_separate:   0
    data_are_stacked:    0
    moving_stat:         mean
    moving_window_size:  5
</pre></div>
</div>
<img alt="../_images/e_raster_window_operations_23_1.png" src="../_images/e_raster_window_operations_23_1.png" />
</div>
</div>
</div>
</div>
</div>
<div class="toctree-wrapper compound">
<span id="document-docs/d_access_osm"></span><!-- (d_access_osm)= -->
<hr class="docutils" />
<div class="admonition-learning-objectives admonition">
<p class="admonition-title">Learning Objectives</p>
<ul class="simple">
<li><p>Download and utilize OpenStreetMap data</p></li>
</ul>
</div>
<div class="admonition-review admonition">
<p class="admonition-title">Review</p>
<ul class="simple">
<li><p><a class="reference internal" href="docs/a_intro.html#document-docs/d_understand_crs_codes"><span class="doc std std-doc">Understanding CRS codes</span></a></p></li>
<li><p><a class="reference internal" href="docs/a_intro.html#document-docs/c_new_vectors"><span class="doc std std-doc">Creating Points, Lines, Polygons</span></a></p></li>
</ul>
</div>
<hr class="docutils" />
<div class="tex2jax_ignore mathjax_ignore section" id="accessing-osm-data-in-python">
<h2>Accessing OSM Data in Python<a class="headerlink" href="#accessing-osm-data-in-python" title="Permalink to this headline">#</a></h2>
<div class="section" id="what-is-openstreetmap">
<h3>What is OpenStreetMap?<a class="headerlink" href="#what-is-openstreetmap" title="Permalink to this headline">#</a></h3>
<p>OpenStreetMap (OSM) is a global collaborative (crowd-sourced) dataset and project that aims at creating a free editable map of the world containing a lot of information about our environment <a class="footnote-reference brackets" href="#gpd-clip" id="id1">1</a>. It contains data for example about streets, buildings, different services, and landuse to mention a few. You can view the map at <a class="reference external" href="http://www.openstreetmap.org">www.openstreetmap.org</a>. You can also sign up as a contributor if you want to edit the map. More details about OpenStreetMap and its contents are available in the <a class="reference external" href="https://wiki.openstreetmap.org/wiki/Main_Page">OpenStreetMap Wiki</a>.</p>
</div>
<div class="section" id="osmnx">
<h3>OSMnx<a class="headerlink" href="#osmnx" title="Permalink to this headline">#</a></h3>
<p>This week we will explore a Python module called <a class="reference external" href="https://github.com/gboeing/osmnx">OSMnx</a>
that can be used to retrieve, construct, analyze, and visualize street networks from OpenStreetMap, and also retrieve data about Points of Interest such as restaurants, schools, and lots of different kind of services. It is also easy to conduct network routing based on walking, cycling or driving by combining OSMnx functionalities with a package called <a class="reference external" href="https://networkx.github.io/documentation/stable/">NetworkX</a>.</p>
<p>To get an overview of the capabilities of the package, see an introductory video given by the lead developer of the package, Prof. Geoff Boeing: <a class="reference external" href="https://www.youtube.com/watch?v=Q0uxu25ddc4&amp;list=PLs9D4XVqc6dCAhhvhZB7aHGD8fCeCC_6N">“Meet the developer: Introduction to OSMnx package by Geoff Boeing”</a>.</p>
</div>
<div class="section" id="download-and-visualize-openstreetmap-data-with-osmnx">
<h3>Download and visualize OpenStreetMap data with OSMnx<a class="headerlink" href="#download-and-visualize-openstreetmap-data-with-osmnx" title="Permalink to this headline">#</a></h3>
<p>One the most useful features that OSMnx provides is an easy-to-use way of retrieving <a class="reference external" href="http://www.openstreetmap.org">OpenStreetMap</a> data (using <a class="reference external" href="http://wiki.openstreetmap.org/wiki/Overpass_API">OverPass API</a>).</p>
<p>In this tutorial, we will learn how to download and visualize OSM data covering a specified area of interest: the neighborhood of Edgewood in Washington DC USA.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Specify the name that is used to seach for the data</span>
<span class="n">place_name</span> <span class="o">=</span> <span class="s2">&quot;Edgewood Washington, DC, USA&quot;</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="osm-location-boundary">
<h4>OSM Location Boundary<a class="headerlink" href="#osm-location-boundary" title="Permalink to this headline">#</a></h4>
<p>Let’s also plot the Polygon that represents the boundary of our area of interest (Washington DC). We can retrieve the Polygon geometry using the <code class="docutils literal notranslate"><span class="pre">ox.geocode_to_gdf</span></code> [docs](<a class="reference external" href="https://osmnx.readthedocs.io/en/stable/osmnx.html?highlight=geocode_to_gdf(#osmnx.geocoder.geocode_to_gdf)">https://osmnx.readthedocs.io/en/stable/osmnx.html?highlight=geocode_to_gdf(#osmnx.geocoder.geocode_to_gdf)</a> function.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># import osmnx</span>
<span class="kn">import</span> <span class="nn">osmnx</span> <span class="k">as</span> <span class="nn">ox</span>
<span class="kn">import</span> <span class="nn">geopandas</span> <span class="k">as</span> <span class="nn">gpd</span>

<span class="c1"># Get place boundary related to the place name as a geodataframe</span>
<span class="n">area</span> <span class="o">=</span> <span class="n">ox</span><span class="o">.</span><span class="n">geocode_to_gdf</span><span class="p">(</span><span class="n">place_name</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>As the name of the function already tells us, <code class="docutils literal notranslate"><span class="pre">gdf_from_place()</span></code>returns a GeoDataFrame based on the specified place name query.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Check the data type</span>
<span class="n">area</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>geometry</th>
      <th>bbox_north</th>
      <th>bbox_south</th>
      <th>bbox_east</th>
      <th>bbox_west</th>
      <th>place_id</th>
      <th>osm_type</th>
      <th>osm_id</th>
      <th>lat</th>
      <th>lon</th>
      <th>display_name</th>
      <th>class</th>
      <th>type</th>
      <th>importance</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>POLYGON ((-77.00892 38.92123, -77.00890 38.920...</td>
      <td>38.934159</td>
      <td>38.917008</td>
      <td>-76.99358</td>
      <td>-77.008915</td>
      <td>282956700</td>
      <td>relation</td>
      <td>4634158</td>
      <td>38.922613</td>
      <td>-77.000537</td>
      <td>Edgewood, Washington, District of Columbia, Un...</td>
      <td>place</td>
      <td>neighbourhood</td>
      <td>0.47</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Let’s still verify the data type:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Check the data type</span>
<span class="nb">type</span><span class="p">(</span><span class="n">area</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>geopandas.geodataframe.GeoDataFrame
</pre></div>
</div>
</div>
</div>
<p>Finally, let’s plot it.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">area</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;AxesSubplot:&gt;
</pre></div>
</div>
<img alt="../_images/d_access_osm_9_1.png" src="../_images/d_access_osm_9_1.png" />
</div>
</div>
</div>
<div class="section" id="osm-building-footprints">
<h4>OSM Building footprints<a class="headerlink" href="#osm-building-footprints" title="Permalink to this headline">#</a></h4>
<p>It is also possible to retrieve other types of OSM data features with OSMnx such as buildings or points of interest (POIs). Let’s download the buildings with <code class="docutils literal notranslate"><span class="pre">ox.geometries_from_place</span></code> <a class="reference external" href="https://osmnx.readthedocs.io/en/stable/osmnx.html?highlight=geometries_from_place#osmnx.geometries.geometries_from_place">docs</a> function and plot them on top of our street network in Kamppi.</p>
<p>When fetching spesific types of geometries from OpenStreetMap using OSMnx <code class="docutils literal notranslate"><span class="pre">geometries_from_place</span></code> we also need to specify the correct tags. For getting <a class="reference external" href="https://wiki.openstreetmap.org/wiki/Buildings">all types of buildings</a>, we can use the tag <code class="docutils literal notranslate"><span class="pre">building=yes</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># List key-value pairs for tags</span>
<span class="n">tags</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;building&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>   

<span class="n">buildings</span> <span class="o">=</span> <span class="n">ox</span><span class="o">.</span><span class="n">geometries_from_place</span><span class="p">(</span><span class="n">place_name</span><span class="p">,</span> <span class="n">tags</span><span class="p">)</span>
<span class="n">buildings</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>addr:state</th>
      <th>amenity</th>
      <th>building</th>
      <th>ele</th>
      <th>gnis:county_id</th>
      <th>gnis:county_name</th>
      <th>gnis:created</th>
      <th>gnis:edited</th>
      <th>gnis:feature_id</th>
      <th>gnis:import_uuid</th>
      <th>...</th>
      <th>shop</th>
      <th>denomination</th>
      <th>old_name</th>
      <th>url</th>
      <th>wikidata</th>
      <th>office</th>
      <th>short_name</th>
      <th>shelter_type</th>
      <th>ways</th>
      <th>type</th>
    </tr>
    <tr>
      <th>element_type</th>
      <th>osmid</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="2" valign="top">node</th>
      <th>358955022</th>
      <td>DC</td>
      <td>school</td>
      <td>yes</td>
      <td>60</td>
      <td>001</td>
      <td>District of Columbia</td>
      <td>12/18/1979</td>
      <td>01/22/2008</td>
      <td>2062869</td>
      <td>57871b70-0100-4405-bb30-88b2e001a944</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>367143640</th>
      <td>DC</td>
      <td>NaN</td>
      <td>yes</td>
      <td>56</td>
      <td>NaN</td>
      <td>District of Columbia</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>2110453</td>
      <td>57871b70-0100-4405-bb30-88b2e001a944</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th rowspan="3" valign="top">way</th>
      <th>52291432</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>yes</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>55321503</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>yes</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>55321504</th>
      <td>DC</td>
      <td>NaN</td>
      <td>yes</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 55 columns</p>
</div></div></div>
</div>
<p>We can plot the footprints quickly.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot footprints </span>
<span class="n">buildings</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/home/mmann1123/anaconda3/envs/pygisbookgw/lib/python3.7/site-packages/ipykernel/ipkernel.py:287: DeprecationWarning: `should_run_async` will not call `transform_cell` automatically in the future. Please pass the result to `transformed_cell` argument and any exception that happen during thetransform in `preprocessing_exc_tuple` in IPython 7.17 and above.
  and should_run_async(code)
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;AxesSubplot:&gt;
</pre></div>
</div>
<img alt="../_images/d_access_osm_13_2.png" src="../_images/d_access_osm_13_2.png" />
</div>
</div>
</div>
<div class="section" id="osm-write-features-to-shp">
<h4>OSM Write Features to .shp<a class="headerlink" href="#osm-write-features-to-shp" title="Permalink to this headline">#</a></h4>
<p>Now let’s assume we want to access this data outside of python, or have a permanent copy of our building footprints for Edgewood.</p>
<p>Since these objects are already <code class="docutils literal notranslate"><span class="pre">geopandas.GeoDataFrame</span></code> it’s easy to save them to disk. We simply use <code class="docutils literal notranslate"><span class="pre">gpd.to_file</span></code> <a class="reference external" href="https://geopandas.org/en/stable/docs/reference/api/geopandas.GeoDataFrame.to_file.html">docs</a>.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>We can’t write OSM GeoDataFrames directly to disk because they contain field types (like lists) that can’t be saved in .shp or .geojsons etc. Instead lets isolate only the attributes we are interested in, <strong>including geometry</strong> which is required.</p>
</div>
<p>We need to isolate just the attributes we are interested in:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">buildings</span>  <span class="o">=</span> <span class="n">buildings</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">buildings</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;addr:|geometry&#39;</span><span class="p">)]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/home/mmann1123/anaconda3/envs/pygisbookgw/lib/python3.7/site-packages/ipykernel/ipkernel.py:287: DeprecationWarning: `should_run_async` will not call `transform_cell` automatically in the future. Please pass the result to `transformed_cell` argument and any exception that happen during thetransform in `preprocessing_exc_tuple` in IPython 7.17 and above.
  and should_run_async(code)
</pre></div>
</div>
</div>
</div>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>OSM data often contains multiple feature types like mixing points with polygons. This is a problem when we try to write it to disk.</p>
</div>
<p>We also need to isolate the feature type we are looking for [e.g. Multipolygon, Polygon, Point]. Since here we want building footprints we are going to keep only polygons.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">buildings</span> <span class="o">=</span> <span class="n">buildings</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">buildings</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">type</span><span class="o">==</span><span class="s1">&#39;Polygon&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>Now, finally, we can write it to disk.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Save footprints </span>
<span class="n">buildings</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span><span class="s1">&#39;../temp/edgewood_buildings.shp&#39;</span><span class="p">)</span>  
<span class="c1"># Or save in a more open source format</span>
<span class="c1">#buildings.to_file(&#39;../temp/edgewood_buildings.geojson&#39;, driver=&#39;GeoJSON&#39;)  </span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/home/mmann1123/anaconda3/envs/pygisbookgw/lib/python3.7/site-packages/ipykernel_launcher.py:2: UserWarning: Column names longer than 10 characters will be truncated when saved to ESRI Shapefile.
  
</pre></div>
</div>
</div>
</div>
<p>Sources</p>
<hr class="footnotes docutils" />
<dl class="footnote brackets">
<dt class="label" id="gpd-clip"><span class="brackets"><a class="fn-backref" href="#id1">1</a></span></dt>
<dd><p><a class="reference external" href="https://automating-gis-processes.github.io/2017/lessons/L3/nearest-neighbour.html">automating-gis-processes</a></p>
</dd>
</dl>
</div>
</div>
</div>
<span id="document-docs/d_access_census"></span><div class="tex2jax_ignore mathjax_ignore section" id="accessing-census-and-acs-data-in-python">
<h2>Accessing Census and ACS Data in Python<a class="headerlink" href="#accessing-census-and-acs-data-in-python" title="Permalink to this headline">#</a></h2>
<p>By: Steven Chao</p>
<hr class="docutils" />
<div class="admonition-learning-objectives admonition">
<p class="admonition-title">Learning Objectives</p>
<ul class="simple">
<li><p>Import dataframes into Python for analysis</p></li>
<li><p>Perform basic dataframe column operations</p></li>
<li><p>Merge dataframes using a unique key</p></li>
<li><p>Group attributes based on a similar attribute</p></li>
<li><p>Dissolve vector geometries based on attribute values</p></li>
</ul>
</div>
<div class="admonition-review admonition">
<p class="admonition-title">Review</p>
<ul class="simple">
<li><p><a class="reference internal" href="docs/a_intro.html#document-docs/c_features"><span class="doc std std-doc">Data Structures</span></a></p></li>
<li><p><a class="reference internal" href="docs/a_intro.html#document-docs/c_vectors"><span class="doc std std-doc">Vector Data </span></a></p></li>
</ul>
</div>
<hr class="docutils" />
<div class="section" id="introduction">
<h3>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">#</a></h3>
<p>This chapter will show you how to access US  Decennial Census and American Community Survey Data (ACS). We will use these basic operations in order to calculate and map poverty rates in the Commonwealth of Virginia. We will pull data from the US Census Bureau’s <a class="reference external" href="https://www.census.gov/programs-surveys/acs">American Community Survey (ACS)</a> 2019 (see <a class="reference external" href="https://www.census.gov/data/developers/data-sets/acs-5year.html">this page</a> for the data).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Import modules</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">geopandas</span> <span class="k">as</span> <span class="nn">gpd</span>
<span class="kn">from</span> <span class="nn">census</span> <span class="kn">import</span> <span class="n">Census</span>
<span class="kn">from</span> <span class="nn">us</span> <span class="kn">import</span> <span class="n">states</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="accessing-data">
<h3>Accessing Data<a class="headerlink" href="#accessing-data" title="Permalink to this headline">#</a></h3>
<div class="section" id="import-census-data">
<h4>Import census data<a class="headerlink" href="#import-census-data" title="Permalink to this headline">#</a></h4>
<p>Let’s begin by accessing and importing census data. Importing census data into Python requires a Census API key. A key can be obtained from <a class="reference external" href="http://api.census.gov/data/key_signup.html">Census API Key</a>.  <strong>It will provide you with a unique 40 digit text string. Please keep track of this number. Store it in a safe place.</strong></p>
<div class="cell tag_remove-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set API key</span>
<span class="n">c</span> <span class="o">=</span> <span class="n">Census</span><span class="p">(</span><span class="s2">&quot;CENSUS API KEY HERE&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#ignore this, I am just reading in my api key privately</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;../../../census_api.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">Census</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>With the Census API key set, we will access the census data at the tract level for the Commonwealth of Virginia from the 2019 ACS, specifically the <code class="docutils literal notranslate"><span class="pre">ratio</span> <span class="pre">of</span> <span class="pre">income</span> <span class="pre">to</span> <span class="pre">poverty</span> <span class="pre">in</span> <span class="pre">the</span> <span class="pre">past</span> <span class="pre">12</span> <span class="pre">months</span></code> (<code class="docutils literal notranslate"><span class="pre">C17002_001E</span></code>, total; <code class="docutils literal notranslate"><span class="pre">C17002_002E</span></code>, &lt; 0.50; and <code class="docutils literal notranslate"><span class="pre">C17002_003E</span></code>, 0.50 - 0.99) variables and the <code class="docutils literal notranslate"><span class="pre">total</span> <span class="pre">population</span></code> (<code class="docutils literal notranslate"><span class="pre">B01003_001E</span></code>) variable. For more information on why these variables are used, refer to the US Census Bureau’s <a class="reference external" href="https://www.census.gov/topics/income-poverty/poverty/guidance/poverty-measures.html">article on how the Census Bureau measures poverty</a> and the <a class="reference external" href="https://api.census.gov/data/2019/acs/acs5/variables.html">list of variables found in ACS</a>.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">census</span></code> package provides us with some easy convenience methods that allow us to obtain data for a wide variety of geographies. The FIPS code for Virginia is 51, but if needed, we can also use the <code class="docutils literal notranslate"><span class="pre">us</span></code> library to help us figure out the relevant FIPS code.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Obtain Census variables from the 2019 ACS at the tract level for the Commonwealth of Virginia (FIPS code: 51)</span>
<span class="c1"># C17002_001E: count of ratio of income to poverty in the past 12 months (total)</span>
<span class="c1"># C17002_002E: count of ratio of income to poverty in the past 12 months (&lt; 0.50)</span>
<span class="c1"># C17002_003E: count of ratio of income to poverty in the past 12 months (0.50 - 0.99)</span>
<span class="c1"># B01003_001E: total population</span>
<span class="c1"># Sources: https://api.census.gov/data/2019/acs/acs5/variables.html; https://pypi.org/project/census/</span>
<span class="n">va_census</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">acs5</span><span class="o">.</span><span class="n">state_county_tract</span><span class="p">(</span><span class="n">fields</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;NAME&#39;</span><span class="p">,</span> <span class="s1">&#39;C17002_001E&#39;</span><span class="p">,</span> <span class="s1">&#39;C17002_002E&#39;</span><span class="p">,</span> <span class="s1">&#39;C17002_003E&#39;</span><span class="p">,</span> <span class="s1">&#39;B01003_001E&#39;</span><span class="p">),</span>
                                      <span class="n">state_fips</span> <span class="o">=</span> <span class="n">states</span><span class="o">.</span><span class="n">VA</span><span class="o">.</span><span class="n">fips</span><span class="p">,</span>
                                      <span class="n">county_fips</span> <span class="o">=</span> <span class="s2">&quot;*&quot;</span><span class="p">,</span>
                                      <span class="n">tract</span> <span class="o">=</span> <span class="s2">&quot;*&quot;</span><span class="p">,</span>
                                      <span class="n">year</span> <span class="o">=</span> <span class="mi">2017</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Now that we have accessed the data and assigned it to a variable, we can read the data into a dataframe using the <code class="docutils literal notranslate"><span class="pre">pandas</span></code> library.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create a dataframe from the census data</span>
<span class="n">va_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">va_census</span><span class="p">)</span>

<span class="c1"># Show the dataframe</span>
<span class="nb">print</span><span class="p">(</span><span class="n">va_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Shape: &#39;</span><span class="p">,</span> <span class="n">va_df</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                                         NAME  C17002_001E  C17002_002E  \
0     Census Tract 60, Norfolk city, Virginia       3947.0        284.0   
1  Census Tract 65.02, Norfolk city, Virginia       3287.0        383.0   

   C17002_003E  B01003_001E state county   tract  
0        507.0       3947.0    51    710  006000  
1        480.0       3302.0    51    710  006502  
Shape:  (1907, 8)
</pre></div>
</div>
</div>
</div>
<p>By showing the dataframe, we can see that there are 1907 rows (therefore 1907 census tracts) and 8 columns.</p>
</div>
<div class="section" id="import-shapefile">
<h4>Import Shapefile<a class="headerlink" href="#import-shapefile" title="Permalink to this headline">#</a></h4>
<p>Let’s also read into Python a shapefile of the Virginia census tracts and reproject it to the UTM Zone 17N projection. (This shapefile can be downloaded on the Census Bureau’s website on the <a class="reference external" href="https://www.census.gov/geographies/mapping-files/time-series/geo/cartographic-boundary.html">Cartographic Boundary Files page</a> or the <a class="reference external" href="https://www.census.gov/geographies/mapping-files/time-series/geo/tiger-line-file.html">TIGER/Line Shapefiles page</a>.)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Access shapefile of Virginia census tracts</span>
<span class="n">va_tract</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="s2">&quot;https://www2.census.gov/geo/tiger/TIGER2019/TRACT/tl_2019_51_tract.zip&quot;</span><span class="p">)</span>

<span class="c1"># Reproject shapefile to UTM Zone 17N</span>
<span class="c1"># https://spatialreference.org/ref/epsg/wgs-84-utm-zone-17n/</span>
<span class="n">va_tract</span> <span class="o">=</span> <span class="n">va_tract</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">epsg</span> <span class="o">=</span> <span class="mi">32617</span><span class="p">)</span>

<span class="c1"># Print GeoDataFrame of shapefile</span>
<span class="nb">print</span><span class="p">(</span><span class="n">va_tract</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Shape: &#39;</span><span class="p">,</span> <span class="n">va_tract</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="c1"># Check shapefile projection</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">The shapefile projection is: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">va_tract</span><span class="o">.</span><span class="n">crs</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  STATEFP COUNTYFP TRACTCE        GEOID    NAME             NAMELSAD  MTFCC  \
0      51      700  032132  51700032132  321.32  Census Tract 321.32  G5020   
1      51      700  032226  51700032226  322.26  Census Tract 322.26  G5020   

  FUNCSTAT    ALAND  AWATER     INTPTLAT      INTPTLON  \
0        S  2552457       0  +37.1475176  -076.5212499   
1        S  3478916  165945  +37.1625163  -076.5527816   

                                            geometry  
0  POLYGON ((897174.191 4119897.084, 897174.811 4...  
1  POLYGON ((893470.562 4123469.385, 893542.722 4...  
Shape:  (1907, 13)

The shapefile projection is: epsg:32617
</pre></div>
</div>
</div>
</div>
<p>By printing the shapefile, we can see that the shapefile also has 1907 rows (1907 tracts). This number matches with the number of census records that we have on file. Perfect!</p>
<p>Not so fast, though. We have a potential problem: We have the census data, and we have the shapefile of census tracts that correspond with that data, but they are stored in two separate variables (<code class="docutils literal notranslate"><span class="pre">va_df</span></code> and <code class="docutils literal notranslate"><span class="pre">va_tract</span></code> respectively)! That makes it a bit difficult to map since these two separate datasets aren’t connected to each other.</p>
</div>
</div>
<div class="section" id="performing-dataframe-operations">
<h3>Performing Dataframe Operations<a class="headerlink" href="#performing-dataframe-operations" title="Permalink to this headline">#</a></h3>
<div class="section" id="create-new-column-from-old-columns-to-get-combined-fips-code">
<h4>Create new column from old columns to get combined FIPS code<a class="headerlink" href="#create-new-column-from-old-columns-to-get-combined-fips-code" title="Permalink to this headline">#</a></h4>
<p>To solve this problem, we can join the two dataframes together via a field or column that is common to both dataframes, which is referred to as a key.</p>
<p>Looking at the two datasets above, it appears that the <code class="docutils literal notranslate"><span class="pre">GEOID</span></code> column from <code class="docutils literal notranslate"><span class="pre">va_tract</span></code> and the <code class="docutils literal notranslate"><span class="pre">state</span></code>, <code class="docutils literal notranslate"><span class="pre">county</span></code>, and <code class="docutils literal notranslate"><span class="pre">tract</span></code> columns combined from <code class="docutils literal notranslate"><span class="pre">va_df</span></code> could serve as the unique key for joining these two dataframes together. In their current forms, this join will not be successful, as we’ll need to merge the <code class="docutils literal notranslate"><span class="pre">state</span></code>, <code class="docutils literal notranslate"><span class="pre">county</span></code>, and <code class="docutils literal notranslate"><span class="pre">tract</span></code> columns from <code class="docutils literal notranslate"><span class="pre">va_df</span></code> together to make it parallel to the <code class="docutils literal notranslate"><span class="pre">GEOID</span></code> column from <code class="docutils literal notranslate"><span class="pre">va_tract</span></code>. We can simply add the columns together, much like math or the basic operators in Python, and assign the “sum” to a new column.</p>
<p>To create a new column–or call an existing column in a dataframe–we can use indexing with <code class="docutils literal notranslate"><span class="pre">[]</span></code> and the column name (string). (There is a different way if you want to access columns using the index number; read more about indexing and selecting data <a class="reference external" href="https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html">in the pandas documentation</a>.)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Combine state, county, and tract columns together to create a new string and assign to new column</span>
<span class="n">va_df</span><span class="p">[</span><span class="s2">&quot;GEOID&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">va_df</span><span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">va_df</span><span class="p">[</span><span class="s2">&quot;county&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">va_df</span><span class="p">[</span><span class="s2">&quot;tract&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>Printing out the first rew rows of the dataframe, we can see that the new column <code class="docutils literal notranslate"><span class="pre">GEOID</span></code> has been created with the values from the three columns combined.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Print head of dataframe</span>
<span class="n">va_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>NAME</th>
      <th>C17002_001E</th>
      <th>C17002_002E</th>
      <th>C17002_003E</th>
      <th>B01003_001E</th>
      <th>state</th>
      <th>county</th>
      <th>tract</th>
      <th>GEOID</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Census Tract 60, Norfolk city, Virginia</td>
      <td>3947.0</td>
      <td>284.0</td>
      <td>507.0</td>
      <td>3947.0</td>
      <td>51</td>
      <td>710</td>
      <td>006000</td>
      <td>51710006000</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Census Tract 65.02, Norfolk city, Virginia</td>
      <td>3287.0</td>
      <td>383.0</td>
      <td>480.0</td>
      <td>3302.0</td>
      <td>51</td>
      <td>710</td>
      <td>006502</td>
      <td>51710006502</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</div>
<div class="section" id="remove-dataframe-columns-that-are-no-longer-needed">
<h4>Remove dataframe columns that are no longer needed<a class="headerlink" href="#remove-dataframe-columns-that-are-no-longer-needed" title="Permalink to this headline">#</a></h4>
<p>To reduce clutter, we can delete the <code class="docutils literal notranslate"><span class="pre">state</span></code>, <code class="docutils literal notranslate"><span class="pre">county</span></code>, and <code class="docutils literal notranslate"><span class="pre">tract</span></code> columns from <code class="docutils literal notranslate"><span class="pre">va_df</span></code> since we don’t need them anymore. Remember that when we want to modify a dataframe, we must assign the modified dataframe back to the original variable (or a new one, if preferred). Otherwise, any modifications won’t be saved. An alternative to assigning the dataframe back to the variable is to simply pass <code class="docutils literal notranslate"><span class="pre">inplace</span> <span class="pre">=</span> <span class="pre">True</span></code>. For more information, see the <a class="reference external" href="https://pandas.pydata.org/docs/reference/api/pandas.DataFrame.drop.html">pandas help documentation on <code class="docutils literal notranslate"><span class="pre">drop</span></code></a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Remove columns</span>
<span class="n">va_df</span> <span class="o">=</span> <span class="n">va_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">,</span> <span class="s2">&quot;county&quot;</span><span class="p">,</span> <span class="s2">&quot;tract&quot;</span><span class="p">])</span>

<span class="c1"># Show updated dataframe</span>
<span class="n">va_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>NAME</th>
      <th>C17002_001E</th>
      <th>C17002_002E</th>
      <th>C17002_003E</th>
      <th>B01003_001E</th>
      <th>GEOID</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Census Tract 60, Norfolk city, Virginia</td>
      <td>3947.0</td>
      <td>284.0</td>
      <td>507.0</td>
      <td>3947.0</td>
      <td>51710006000</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Census Tract 65.02, Norfolk city, Virginia</td>
      <td>3287.0</td>
      <td>383.0</td>
      <td>480.0</td>
      <td>3302.0</td>
      <td>51710006502</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</div>
<div class="section" id="check-column-data-types">
<h4>Check column data types<a class="headerlink" href="#check-column-data-types" title="Permalink to this headline">#</a></h4>
<p>The key in both dataframe must be of the same data type. Let’s check the data type of the <code class="docutils literal notranslate"><span class="pre">GEOID</span></code> columns in both dataframes. If they aren’t the same, we will have to change the data type of columns to make them the same.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Check column data types for census data</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Column data types for census data:</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">va_df</span><span class="o">.</span><span class="n">dtypes</span><span class="p">))</span>

<span class="c1"># Check column data types for census shapefile</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Column data types for census shapefile:</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">va_tract</span><span class="o">.</span><span class="n">dtypes</span><span class="p">))</span>

<span class="c1"># Source: https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.dtypes.html</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Column data types for census data:
NAME            object
C17002_001E    float64
C17002_002E    float64
C17002_003E    float64
B01003_001E    float64
GEOID           object
dtype: object

Column data types for census shapefile:
STATEFP       object
COUNTYFP      object
TRACTCE       object
GEOID         object
NAME          object
NAMELSAD      object
MTFCC         object
FUNCSTAT      object
ALAND          int64
AWATER         int64
INTPTLAT      object
INTPTLON      object
geometry    geometry
dtype: object
</pre></div>
</div>
</div>
</div>
<p>Looks like the <code class="docutils literal notranslate"><span class="pre">GEOID</span></code> columns are the same!</p>
</div>
<div class="section" id="merge-dataframes">
<h4>Merge dataframes<a class="headerlink" href="#merge-dataframes" title="Permalink to this headline">#</a></h4>
<p>Now, we are ready to merge the two dataframes together, using the <code class="docutils literal notranslate"><span class="pre">GEOID</span></code> columns as the primary key. We can use the <code class="docutils literal notranslate"><span class="pre">merge</span></code> method in <code class="docutils literal notranslate"><span class="pre">GeoPandas</span></code> called on the <code class="docutils literal notranslate"><span class="pre">va_tract</span></code> shapefile dataset.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Join the attributes of the dataframes together</span>
<span class="c1"># Source: https://geopandas.org/docs/user_guide/mergingdata.html</span>
<span class="n">va_merge</span> <span class="o">=</span> <span class="n">va_tract</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">va_df</span><span class="p">,</span> <span class="n">on</span> <span class="o">=</span> <span class="s2">&quot;GEOID&quot;</span><span class="p">)</span>

<span class="c1"># Show result</span>
<span class="nb">print</span><span class="p">(</span><span class="n">va_merge</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Shape: &#39;</span><span class="p">,</span> <span class="n">va_merge</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  STATEFP COUNTYFP TRACTCE        GEOID  NAME_x             NAMELSAD  MTFCC  \
0      51      700  032132  51700032132  321.32  Census Tract 321.32  G5020   
1      51      700  032226  51700032226  322.26  Census Tract 322.26  G5020   

  FUNCSTAT    ALAND  AWATER     INTPTLAT      INTPTLON  \
0        S  2552457       0  +37.1475176  -076.5212499   
1        S  3478916  165945  +37.1625163  -076.5527816   

                                            geometry  \
0  POLYGON ((897174.191 4119897.084, 897174.811 4...   
1  POLYGON ((893470.562 4123469.385, 893542.722 4...   

                                             NAME_y  C17002_001E  C17002_002E  \
0  Census Tract 321.32, Newport News city, Virginia       5025.0        161.0   
1  Census Tract 322.26, Newport News city, Virginia       4167.0        736.0   

   C17002_003E  B01003_001E  
0        342.0       5079.0  
1        559.0       4167.0  
Shape:  (1907, 18)
</pre></div>
</div>
</div>
</div>
<p>Success! We still have 1907 rows, which means that all rows (or most of them) were successfully matched! Notice how the census data has been added on after the shapefile data in the dataframe.</p>
<p>Some additional notes about joining dataframes:</p>
<ul class="simple">
<li><p>the columns for the key do not need to have the same name.</p></li>
<li><p>for this join, we had a one-to-one relationship, meaning one attribute in one dataframe matched to one (and only one) attribute in the other dataframe. Joins with a many-to-one, one-to-many, or many-to-many relationship are also possible, but in some cases, they require some special considerations. See this <a class="reference external" href="https://desktop.arcgis.com/en/arcmap/10.3/manage-data/tables/about-joining-and-relating-tables.htm">Esri ArcGIS help documentation on joins and relates</a> for more information.</p></li>
</ul>
</div>
<div class="section" id="subset-dataframe">
<h4>Subset dataframe<a class="headerlink" href="#subset-dataframe" title="Permalink to this headline">#</a></h4>
<p>Now that we merged the dataframes together, we can further clean up the dataframe and remove columns that are not needed. Instead of using the <code class="docutils literal notranslate"><span class="pre">drop</span></code> method, we can simply select the columns we want to keep and create a new dataframe with those selected columns.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create new dataframe from select columns</span>
<span class="n">va_poverty_tract</span> <span class="o">=</span> <span class="n">va_merge</span><span class="p">[[</span><span class="s2">&quot;STATEFP&quot;</span><span class="p">,</span> <span class="s2">&quot;COUNTYFP&quot;</span><span class="p">,</span> <span class="s2">&quot;TRACTCE&quot;</span><span class="p">,</span> <span class="s2">&quot;GEOID&quot;</span><span class="p">,</span> <span class="s2">&quot;geometry&quot;</span><span class="p">,</span> <span class="s2">&quot;C17002_001E&quot;</span><span class="p">,</span> <span class="s2">&quot;C17002_002E&quot;</span><span class="p">,</span> <span class="s2">&quot;C17002_003E&quot;</span><span class="p">,</span> <span class="s2">&quot;B01003_001E&quot;</span><span class="p">]]</span>

<span class="c1"># Show dataframe</span>
<span class="nb">print</span><span class="p">(</span><span class="n">va_poverty_tract</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Shape: &#39;</span><span class="p">,</span> <span class="n">va_poverty_tract</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  STATEFP COUNTYFP TRACTCE        GEOID  \
0      51      700  032132  51700032132   
1      51      700  032226  51700032226   

                                            geometry  C17002_001E  \
0  POLYGON ((897174.191 4119897.084, 897174.811 4...       5025.0   
1  POLYGON ((893470.562 4123469.385, 893542.722 4...       4167.0   

   C17002_002E  C17002_003E  B01003_001E  
0        161.0        342.0       5079.0  
1        736.0        559.0       4167.0  
Shape:  (1907, 9)
</pre></div>
</div>
</div>
</div>
<p>Notice how the number of columns dropped from 13 to 9.</p>
</div>
<div class="section" id="dissolve-geometries-and-get-summarized-statistics-to-get-poverty-statistics-at-the-county-level">
<h4>Dissolve geometries and get summarized statistics to get poverty statistics at the county level<a class="headerlink" href="#dissolve-geometries-and-get-summarized-statistics-to-get-poverty-statistics-at-the-county-level" title="Permalink to this headline">#</a></h4>
<p>Next, we will group all the census tracts within the same county (<code class="docutils literal notranslate"><span class="pre">COUNTYFP</span></code>) and aggregate the poverty and population values for those tracts within the same county. We can use the <code class="docutils literal notranslate"><span class="pre">dissolve</span></code> function in <code class="docutils literal notranslate"><span class="pre">GeoPandas</span></code>, which is the spatial version of <code class="docutils literal notranslate"><span class="pre">groupby</span></code> in <code class="docutils literal notranslate"><span class="pre">pandas</span></code>. We use <code class="docutils literal notranslate"><span class="pre">dissolve</span></code> instead of <code class="docutils literal notranslate"><span class="pre">groupby</span></code> because the former also groups and merges all the geometries (in this case, census tracts) within a given group (in this case, counties).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Dissolve and group the census tracts within each county and aggregate all the values together</span>
<span class="c1"># Source: https://geopandas.org/docs/user_guide/aggregation_with_dissolve.html</span>
<span class="n">va_poverty_county</span> <span class="o">=</span> <span class="n">va_poverty_tract</span><span class="o">.</span><span class="n">dissolve</span><span class="p">(</span><span class="n">by</span> <span class="o">=</span> <span class="s1">&#39;COUNTYFP&#39;</span><span class="p">,</span> <span class="n">aggfunc</span> <span class="o">=</span> <span class="s1">&#39;sum&#39;</span><span class="p">)</span>

<span class="c1"># Show dataframe</span>
<span class="nb">print</span><span class="p">(</span><span class="n">va_poverty_county</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Shape: &#39;</span><span class="p">,</span> <span class="n">va_poverty_county</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                                                   geometry  C17002_001E  \
COUNTYFP                                                                   
001       POLYGON ((971901.668 4160101.088, 971814.409 4...      32345.0   
003       POLYGON ((734957.267 4207640.156, 734931.249 4...      97587.0   

          C17002_002E  C17002_003E  B01003_001E  
COUNTYFP                                         
001            2423.0       3993.0      32840.0  
003            5276.0       4305.0     105105.0  
Shape:  (133, 5)
</pre></div>
</div>
</div>
</div>
<p>Notice that we got the number of rows down from 1907 to 133.</p>
</div>
<div class="section" id="perform-column-math-to-get-poverty-rates">
<h4>Perform column math to get poverty rates<a class="headerlink" href="#perform-column-math-to-get-poverty-rates" title="Permalink to this headline">#</a></h4>
<p>We can estimate the poverty rate by dividing the sum of <code class="docutils literal notranslate"><span class="pre">C17002_002E</span></code> (ratio of income to poverty in the past 12 months, &lt; 0.50) and <code class="docutils literal notranslate"><span class="pre">C17002_003E</span></code> (ratio of income to poverty in the past 12 months, 0.50 - 0.99) by <code class="docutils literal notranslate"><span class="pre">B01003_001E</span></code> (total population).</p>
<p>Side note: Notice that <code class="docutils literal notranslate"><span class="pre">C17002_001E</span></code> (ratio of income to poverty in the past 12 months, total), which theoretically should count everyone, does not exactly match up with <code class="docutils literal notranslate"><span class="pre">B01003_001E</span></code> (total population). We’ll disregard this for now since the difference is not too significant.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get poverty rate and store values in new column</span>
<span class="n">va_poverty_county</span><span class="p">[</span><span class="s2">&quot;Poverty_Rate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">va_poverty_county</span><span class="p">[</span><span class="s2">&quot;C17002_002E&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">va_poverty_county</span><span class="p">[</span><span class="s2">&quot;C17002_003E&quot;</span><span class="p">])</span> <span class="o">/</span> <span class="n">va_poverty_county</span><span class="p">[</span><span class="s2">&quot;B01003_001E&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span>

<span class="c1"># Show dataframe</span>
<span class="n">va_poverty_county</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>geometry</th>
      <th>C17002_001E</th>
      <th>C17002_002E</th>
      <th>C17002_003E</th>
      <th>B01003_001E</th>
      <th>Poverty_Rate</th>
    </tr>
    <tr>
      <th>COUNTYFP</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>001</th>
      <td>POLYGON ((971901.668 4160101.088, 971814.409 4...</td>
      <td>32345.0</td>
      <td>2423.0</td>
      <td>3993.0</td>
      <td>32840.0</td>
      <td>19.537150</td>
    </tr>
    <tr>
      <th>003</th>
      <td>POLYGON ((734957.267 4207640.156, 734931.249 4...</td>
      <td>97587.0</td>
      <td>5276.0</td>
      <td>4305.0</td>
      <td>105105.0</td>
      <td>9.115646</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</div>
</div>
<div class="section" id="plotting-results">
<h3>Plotting Results<a class="headerlink" href="#plotting-results" title="Permalink to this headline">#</a></h3>
<p>Finally, since we have the spatial component connected to our census data, we can plot the results!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create subplots</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

<span class="c1"># Plot data</span>
<span class="c1"># Source: https://geopandas.readthedocs.io/en/latest/docs/user_guide/mapping.html</span>
<span class="n">va_poverty_county</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">column</span> <span class="o">=</span> <span class="s2">&quot;Poverty_Rate&quot;</span><span class="p">,</span>
                       <span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span>
                       <span class="n">cmap</span> <span class="o">=</span> <span class="s2">&quot;RdPu&quot;</span><span class="p">,</span>
                       <span class="n">legend</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

<span class="c1"># Stylize plots</span>
<span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;bmh&#39;</span><span class="p">)</span>

<span class="c1"># Set title</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Poverty Rates (%) in Virginia&#39;</span><span class="p">,</span> <span class="n">fontdict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;fontsize&#39;</span><span class="p">:</span> <span class="s1">&#39;25&#39;</span><span class="p">,</span> <span class="s1">&#39;fontweight&#39;</span> <span class="p">:</span> <span class="s1">&#39;3&#39;</span><span class="p">})</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0.5, 1.0, &#39;Poverty Rates (%) in Virginia&#39;)
</pre></div>
</div>
<img alt="../_images/d_access_census_28_1.png" src="../_images/d_access_census_28_1.png" />
</div>
</div>
</div>
</div>
</div>
<div class="toctree-wrapper compound">
<span id="document-docs/f_rs_io"></span><hr class="docutils" id="f-rs-io" />
<div class="admonition-learning-objectives admonition">
<p class="admonition-title">Learning Objectives</p>
<ul class="simple">
<li><p>How to open multiple common remotely sensed image types</p></li>
<li><p>Handle RGB, BGR, LandSat, PlanetScope images and other sensor types</p></li>
<li><p>Mosaic multiple remotely sensed images</p></li>
<li><p>Create a time series stack</p></li>
<li><p>Write files to disk</p></li>
</ul>
</div>
<div class="admonition-review admonition">
<p class="admonition-title">Review</p>
<ul class="simple">
<li><p><a class="reference internal" href="docs/a_intro.html#document-docs/c_features"><span class="doc std std-doc">Data Structures</span></a></p></li>
<li><p><a class="reference internal" href="docs/a_intro.html#document-docs/c_rasters"><span class="doc std std-doc">Raster Data </span></a></p></li>
</ul>
</div>
<hr class="docutils" />
<div class="tex2jax_ignore mathjax_ignore section" id="reading-writing-remote-sensed-images">
<h2>Reading/Writing Remote Sensed Images<a class="headerlink" href="#reading-writing-remote-sensed-images" title="Permalink to this headline">#</a></h2>
<p>GeoWombat’s file opening is meant to mimic Xarray and Rasterio. That is, rasters are typically opened with a context manager using the function <code class="docutils literal notranslate"><span class="pre">geowombat.open</span></code>. GeoWombat uses <code class="docutils literal notranslate"><span class="pre">xarray.open_rasterio</span></code> to load data into an <code class="docutils literal notranslate"><span class="pre">xarray.DataArray</span></code>. In GeoWombat, the data are always chunked, meaning the data are always loaded as Dask arrays. As with <code class="docutils literal notranslate"><span class="pre">xarray.open_rasterio</span></code>, the opened DataArrays always have at least 1 band.</p>
<div class="section" id="opening-a-single-image">
<h3>Opening a single image<a class="headerlink" href="#opening-a-single-image" title="Permalink to this headline">#</a></h3>
<p>Opening an image with default settings looks similar to <code class="docutils literal notranslate"><span class="pre">xarray.open_rasterio</span></code> and <code class="docutils literal notranslate"><span class="pre">rasterio.open</span></code>. <code class="docutils literal notranslate"><span class="pre">geowombat.open</span></code> expects a file name (<code class="docutils literal notranslate"><span class="pre">str</span></code> or <code class="docutils literal notranslate"><span class="pre">pathlib.Path</span></code>).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">geowombat</span> <span class="k">as</span> <span class="nn">gw</span>
<span class="kn">from</span> <span class="nn">geowombat.data</span> <span class="kn">import</span> <span class="n">l8_224078_20200518</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="k">with</span> <span class="n">gw</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">l8_224078_20200518</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;xarray.DataArray (band: 3, y: 1860, x: 2041)&gt;
dask.array&lt;open_rasterio-cd30c5f7c3868320497352519d525008&lt;this-array&gt;, shape=(3, 1860, 2041), dtype=uint16, chunksize=(1, 256, 256), chunktype=numpy.ndarray&gt;
Coordinates:
  * band     (band) int64 1 2 3
  * y        (y) float64 -2.777e+06 -2.777e+06 ... -2.833e+06 -2.833e+06
  * x        (x) float64 7.174e+05 7.174e+05 7.174e+05 ... 7.785e+05 7.786e+05
Attributes:
    transform:          (30.0, 0.0, 717345.0, 0.0, -30.0, -2776995.0)
    crs:                +init=epsg:32621
    res:                (30.0, 30.0)
    is_tiled:           1
    nodatavals:         (nan, nan, nan)
    scales:             (1.0, 1.0, 1.0)
    offsets:            (0.0, 0.0, 0.0)
    AREA_OR_POINT:      Area
    filename:           /home/mmann1123/anaconda3/envs/pygisbookgw/lib/python...
    resampling:         nearest
    data_are_separate:  0
    data_are_stacked:   0
</pre></div>
</div>
</div>
</div>
<p>In the example above, <code class="docutils literal notranslate"><span class="pre">src</span></code> is an <code class="docutils literal notranslate"><span class="pre">xarray.DataArray</span></code>. Thus, printing the object will display the underlying Dask array dimensions and chunks, the DataArray named coordinates, and the DataArray attributes.</p>
<p>It automatically converts the coordinates stored in <code class="docutils literal notranslate"><span class="pre">x</span></code> and <code class="docutils literal notranslate"><span class="pre">y</span></code>, and the different bands are stored in <code class="docutils literal notranslate"><span class="pre">band</span></code>. To select a single band we can simply select it with <code class="docutils literal notranslate"><span class="pre">src.sel(band=1)</span></code>.</p>
<p>Let’s plot out what we have while removing missing values, stored at <code class="docutils literal notranslate"><span class="pre">0</span></code>, and switch the band order around to be RGB.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
<span class="k">with</span> <span class="n">gw</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">l8_224078_20200518</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
    <span class="n">src</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">src</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">band</span><span class="o">=</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">gw</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">robust</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">pad</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/f_rs_io_3_0.png" src="../_images/f_rs_io_3_0.png" />
</div>
</div>
</div>
<div class="section" id="opening-multiple-bands-as-a-stack">
<h3>Opening multiple bands as a stack<a class="headerlink" href="#opening-multiple-bands-as-a-stack" title="Permalink to this headline">#</a></h3>
<p>Often, satellite bands will be stored in separate raster files. To open the files as one DataArray, specify a list instead of a file name.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">geowombat.data</span> <span class="kn">import</span> <span class="n">l8_224078_20200518_B2</span><span class="p">,</span> <span class="n">l8_224078_20200518_B3</span><span class="p">,</span> <span class="n">l8_224078_20200518_B4</span>

<span class="k">with</span> <span class="n">gw</span><span class="o">.</span><span class="n">open</span><span class="p">([</span><span class="n">l8_224078_20200518_B2</span><span class="p">,</span> <span class="n">l8_224078_20200518_B3</span><span class="p">,</span> <span class="n">l8_224078_20200518_B4</span><span class="p">])</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;xarray.DataArray (time: 3, band: 1, y: 1860, x: 2041)&gt;
dask.array&lt;concatenate, shape=(3, 1, 1860, 2041), dtype=uint16, chunksize=(1, 1, 256, 256), chunktype=numpy.ndarray&gt;
Coordinates:
  * band     (band) int64 1
  * y        (y) float64 -2.777e+06 -2.777e+06 ... -2.833e+06 -2.833e+06
  * x        (x) float64 7.174e+05 7.174e+05 7.174e+05 ... 7.785e+05 7.786e+05
  * time     (time) int64 1 2 3
Attributes:
    transform:          (30.0, 0.0, 717345.0, 0.0, -30.0, -2776995.0)
    crs:                +init=epsg:32621
    res:                (30.0, 30.0)
    is_tiled:           1
    nodatavals:         (nan,)
    scales:             (1.0,)
    offsets:            (0.0,)
    AREA_OR_POINT:      Point
    filename:           [&#39;LC08_L1TP_224078_20200518_20200518_01_RT_B2.TIF&#39;, &#39;...
    data_are_separate:  1
    data_are_stacked:   1
</pre></div>
</div>
</div>
</div>
<p>By default, GeoWombat will stack multiple files by time. So, to stack multiple bands with the same timestamp, change the <code class="docutils literal notranslate"><span class="pre">stack_dim</span></code> keyword.</p>
<p>Also note the use of <code class="docutils literal notranslate"><span class="pre">band_names</span></code> parameter. Here we can set it to anything we want for instance <code class="docutils literal notranslate"><span class="pre">['blue','green','red']</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">geowombat.data</span> <span class="kn">import</span> <span class="n">l8_224078_20200518_B2</span><span class="p">,</span> <span class="n">l8_224078_20200518_B3</span><span class="p">,</span> <span class="n">l8_224078_20200518_B4</span>

<span class="k">with</span> <span class="n">gw</span><span class="o">.</span><span class="n">open</span><span class="p">(</span>
    <span class="p">[</span><span class="n">l8_224078_20200518_B2</span><span class="p">,</span> <span class="n">l8_224078_20200518_B3</span><span class="p">,</span> <span class="n">l8_224078_20200518_B4</span><span class="p">],</span>
    <span class="n">stack_dim</span><span class="o">=</span><span class="s2">&quot;band&quot;</span><span class="p">,</span>
    <span class="n">band_names</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
<span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;xarray.DataArray (band: 3, y: 1860, x: 2041)&gt;
dask.array&lt;concatenate, shape=(3, 1860, 2041), dtype=uint16, chunksize=(1, 256, 256), chunktype=numpy.ndarray&gt;
Coordinates:
  * band     (band) int64 1 2 3
  * y        (y) float64 -2.777e+06 -2.777e+06 ... -2.833e+06 -2.833e+06
  * x        (x) float64 7.174e+05 7.174e+05 7.174e+05 ... 7.785e+05 7.786e+05
Attributes:
    transform:          (30.0, 0.0, 717345.0, 0.0, -30.0, -2776995.0)
    crs:                +init=epsg:32621
    res:                (30.0, 30.0)
    is_tiled:           1
    nodatavals:         (nan,)
    scales:             (1.0,)
    offsets:            (0.0,)
    AREA_OR_POINT:      Point
    filename:           [&#39;LC08_L1TP_224078_20200518_20200518_01_RT_B2.TIF&#39;, &#39;...
    data_are_separate:  1
    data_are_stacked:   1
</pre></div>
</div>
</div>
</div>
<p>You will see this looks the same as the multiband raster:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
<span class="k">with</span> <span class="n">gw</span><span class="o">.</span><span class="n">open</span><span class="p">(</span>
    <span class="p">[</span><span class="n">l8_224078_20200518_B2</span><span class="p">,</span> <span class="n">l8_224078_20200518_B3</span><span class="p">,</span> <span class="n">l8_224078_20200518_B4</span><span class="p">],</span>
    <span class="n">stack_dim</span><span class="o">=</span><span class="s2">&quot;band&quot;</span><span class="p">,</span>
    <span class="n">band_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span><span class="s1">&#39;green&#39;</span><span class="p">,</span><span class="s1">&#39;red&#39;</span><span class="p">],</span>
<span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
    <span class="n">src</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">src</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">band</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;red&#39;</span><span class="p">,</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span><span class="s1">&#39;green&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">gw</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">robust</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">pad</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/f_rs_io_9_0.png" src="../_images/f_rs_io_9_0.png" />
</div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If time names are not specified with <code class="docutils literal notranslate"><span class="pre">stack_dim</span></code> = ‘time’, GeoWombat will attempt to parse dates from the file names. This could incur significant overhead when the file list is long. Therefore, it is good practice to specify the time names.</p>
</div>
<p>Overhead required to parse file names</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">gw</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">long_file_list</span><span class="p">,</span> <span class="n">stack_dim</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
      <span class="o">...</span>
</pre></div>
</div>
<p>No file parsing overhead</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">gw</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">long_file_list</span><span class="p">,</span> <span class="n">time_names</span><span class="o">=</span><span class="n">my_time_names</span><span class="p">,</span> <span class="n">stack_dim</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
    <span class="o">...</span>
</pre></div>
</div>
</div>
<div class="section" id="opening-images-from-different-sensors">
<h3>Opening images from different sensors<a class="headerlink" href="#opening-images-from-different-sensors" title="Permalink to this headline">#</a></h3>
<p>One of many complications of using remotely sensed data is that there are so many different sensors such as LandSat, Sentinel, PlantScope etc each with their own band order and properties. Geowombat makes this much easier by providing a broad list of potential sensor configurations. <a class="reference internal" href="docs/a_intro.html#f-rs-crs-sensors"><span class="std std-ref">Read in more detail about sensor configurations here.</span></a> For this section, let’s keep things simple and show you how to open a Sentinel 2 image using the configuration manager, frankly, it’s pretty easy:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">gw</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">sensor</span><span class="o">=</span><span class="s1">&#39;s2&#39;</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">gw</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;filepath.tif&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">band</span><span class="p">)</span>
</pre></div>
</div>
<p>To see all available sensor names, use the <strong>avail_sensors</strong> property.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">gw</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;filepath.tif&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">sensor_name</span> <span class="ow">in</span> <span class="n">src</span><span class="o">.</span><span class="n">gw</span><span class="o">.</span><span class="n">avail_sensors</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">sensor_name</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="opening-multiple-bands-as-a-mosaic">
<h3>Opening multiple bands as a mosaic<a class="headerlink" href="#opening-multiple-bands-as-a-mosaic" title="Permalink to this headline">#</a></h3>
<p>When a list of files are given, GeoWombat will stack the data by default. To mosaic multiple files into the same band coordinate, use the <strong>mosaic</strong> keyword.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">geowombat.data</span> <span class="kn">import</span> <span class="n">l8_224077_20200518_B2</span><span class="p">,</span> <span class="n">l8_224078_20200518_B2</span>

<span class="k">with</span> <span class="n">gw</span><span class="o">.</span><span class="n">open</span><span class="p">([</span><span class="n">l8_224077_20200518_B2</span><span class="p">,</span> <span class="n">l8_224078_20200518_B2</span><span class="p">],</span>
              <span class="n">mosaic</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;xarray.DataArray (y: 1515, x: 2006, band: 1)&gt;
dask.array&lt;where, shape=(1515, 2006, 1), dtype=uint16, chunksize=(256, 256, 1), chunktype=numpy.ndarray&gt;
Coordinates:
  * y        (y) float64 -2.767e+06 -2.767e+06 ... -2.812e+06 -2.812e+06
  * x        (x) float64 6.94e+05 6.940e+05 6.941e+05 ... 7.541e+05 7.542e+05
  * band     (band) int64 1
Attributes:
    transform:          (30.0, 0.0, 694005.0, 0.0, -30.0, -2766615.0)
    crs:                +init=epsg:32621
    res:                (30.0, 30.0)
    is_tiled:           1
    nodatavals:         (nan,)
    scales:             (1.0,)
    offsets:            (0.0,)
    AREA_OR_POINT:      Point
    filename:           [&#39;LC08_L1TP_224077_20200518_20200518_01_RT_B2.TIF&#39;, &#39;...
    resampling:         nearest
    data_are_separate:  1
    data_are_stacked:   0
</pre></div>
</div>
</div>
</div>
<p>Now let’s take a look at the mosaiced band 2 image values.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
<span class="k">with</span> <span class="n">gw</span><span class="o">.</span><span class="n">open</span><span class="p">([</span><span class="n">l8_224077_20200518_B2</span><span class="p">,</span> <span class="n">l8_224078_20200518_B2</span><span class="p">],</span>
              <span class="n">mosaic</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
    <span class="n">src</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">src</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">band</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">gw</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">robust</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">pad</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/f_rs_io_13_0.png" src="../_images/f_rs_io_13_0.png" />
</div>
</div>
<!-- See :ref:`io` for more examples illustrating file opening. -->
</div>
<div class="section" id="create-a-time-series-stack">
<h3>Create a Time Series Stack<a class="headerlink" href="#create-a-time-series-stack" title="Permalink to this headline">#</a></h3>
<p>Let’s pretend for a moment that we have a time series of images from the same tile. We can stack them by passing a list of file names <code class="docutils literal notranslate"><span class="pre">[l8_224078_20200518,</span> <span class="pre">l8_224078_20200518]</span></code>, it also helps to be specific and assign <code class="docutils literal notranslate"><span class="pre">time_names=['t1',</span> <span class="pre">'t2']</span></code>, and specify which dimension we want to stack our data along with <code class="docutils literal notranslate"><span class="pre">stack_dim='time'</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">gw</span><span class="o">.</span><span class="n">open</span><span class="p">([</span><span class="n">l8_224078_20200518</span><span class="p">,</span> <span class="n">l8_224078_20200518</span><span class="p">],</span>
            <span class="n">band_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="s1">&#39;red&#39;</span><span class="p">],</span>
            <span class="n">time_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;t1&#39;</span><span class="p">,</span> <span class="s1">&#39;t2&#39;</span><span class="p">],</span>
            <span class="n">stack_dim</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;xarray.DataArray (time: 2, band: 3, y: 1860, x: 2041)&gt;
dask.array&lt;concatenate, shape=(2, 3, 1860, 2041), dtype=uint16, chunksize=(1, 1, 256, 256), chunktype=numpy.ndarray&gt;
Coordinates:
  * band     (band) &lt;U5 &#39;blue&#39; &#39;green&#39; &#39;red&#39;
  * y        (y) float64 -2.777e+06 -2.777e+06 ... -2.833e+06 -2.833e+06
  * x        (x) float64 7.174e+05 7.174e+05 7.174e+05 ... 7.785e+05 7.786e+05
  * time     (time) &lt;U2 &#39;t1&#39; &#39;t2&#39;
Attributes:
    transform:          (30.0, 0.0, 717345.0, 0.0, -30.0, -2776995.0)
    crs:                +init=epsg:32621
    res:                (30.0, 30.0)
    is_tiled:           1
    nodatavals:         (nan, nan, nan)
    scales:             (1.0, 1.0, 1.0)
    offsets:            (0.0, 0.0, 0.0)
    AREA_OR_POINT:      Area
    filename:           [&#39;LC08_L1TP_224078_20200518_20200518_01_RT.TIF&#39;, &#39;LC0...
    resampling:         nearest
    data_are_separate:  1
    data_are_stacked:   1
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="writing-dataarrays-to-file">
<h3>Writing DataArrays to file<a class="headerlink" href="#writing-dataarrays-to-file" title="Permalink to this headline">#</a></h3>
<p>GeoWombat’s I/O can be accessed through the <code class="docutils literal notranslate"><span class="pre">to_vrt</span></code> and <code class="docutils literal notranslate"><span class="pre">to_raster</span></code> functions. These functions use
Rasterio’s <code class="docutils literal notranslate"><span class="pre">write</span></code> and Dask.array <code class="docutils literal notranslate"><span class="pre">store</span></code> functions as I/O backends. In the examples below,
<code class="docutils literal notranslate"><span class="pre">src</span></code> is an <code class="docutils literal notranslate"><span class="pre">xarray.DataArray</span></code> with the necessary transform information to write to an image file.</p>
<p>Write to a VRT file.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">geowombat.data</span> <span class="kn">import</span> <span class="n">l8_224077_20200518_B4</span>

<span class="c1"># Transform the data to lat/lon</span>
<span class="k">with</span> <span class="n">gw</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">ref_crs</span><span class="o">=</span><span class="mi">4326</span><span class="p">):</span>

    <span class="k">with</span> <span class="n">gw</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">l8_224077_20200518_B4</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>

        <span class="c1"># Write the data to a VRT</span>
        <span class="n">gw</span><span class="o">.</span><span class="n">to_vrt</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="s1">&#39;lat_lon_file.vrt&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Write to a raster file.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">geowombat</span> <span class="k">as</span> <span class="nn">gw</span>

<span class="k">with</span> <span class="n">gw</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">l8_224077_20200518_B4</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>

    <span class="c1"># Xarray drops attributes</span>
    <span class="n">attrs</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="c1"># Apply operations on the DataArray</span>
    <span class="n">src</span> <span class="o">=</span> <span class="n">src</span> <span class="o">*</span> <span class="mf">10.0</span>

    <span class="n">src</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">attrs</span>

    <span class="c1"># Write the data to a GeoTiff</span>
    <span class="n">src</span><span class="o">.</span><span class="n">gw</span><span class="o">.</span><span class="n">to_raster</span><span class="p">(</span><span class="s1">&#39;output.tif&#39;</span><span class="p">,</span>
                        <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                        <span class="n">n_workers</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>    <span class="c1"># number of process workers sent to ``concurrent.futures``</span>
                        <span class="n">n_threads</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>    <span class="c1"># number of thread workers sent to ``dask.compute``</span>
                        <span class="n">n_chunks</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>   <span class="c1"># number of window chunks to send as concurrent futures</span>
</pre></div>
</div>
<!-- See :ref:`io-distributed` for more examples describing concurrent file writing with GeoWombat. --></div>
</div>
<span id="document-docs/f_rs_config"></span><hr class="docutils" id="f-rs-crs" />
<div class="admonition-learning-objectives admonition">
<p class="admonition-title">Learning Objectives</p>
<ul class="simple">
<li><p>Reproject remotely sensed data (change CRS)</p></li>
<li><p>Reproject on-the-fly</p></li>
<li><p>Understand resampling options</p></li>
</ul>
</div>
<div class="admonition-review admonition">
<p class="admonition-title">Review</p>
<ul class="simple">
<li><p><a class="reference internal" href="docs/a_intro.html#document-docs/d_crs_what_is_it"><span class="doc std std-doc">What is a CRS</span></a></p></li>
<li><p><a class="reference internal" href="docs/a_intro.html#document-docs/d_understand_crs_codes"><span class="doc std std-doc">Understanding CRS codes</span></a></p></li>
<li><p><a class="reference internal" href="docs/a_intro.html#document-docs/d_raster_crs_intro"><span class="doc std std-doc">Raster CRS</span></a></p></li>
</ul>
</div>
<hr class="docutils" />
<div class="tex2jax_ignore mathjax_ignore section" id="configuration-manager">
<h2>Configuration manager<a class="headerlink" href="#configuration-manager" title="Permalink to this headline">#</a></h2>
<div class="section" id="what-is-a-context-manager">
<h3>What is a context manager?<a class="headerlink" href="#what-is-a-context-manager" title="Permalink to this headline">#</a></h3>
<p>In short, a context manager ensures proper file closing using <a class="reference external" href="https://docs.python.org/2.5/whatsnew/pep-343.html">with statements</a>. But it also allows us to set up default behavoirs for opening and writing our images.</p>
</div>
<div class="section" id="what-is-the-purpose-of-geowombat-s-context-manager">
<h3>What is the purpose of GeoWombat’s context manager?<a class="headerlink" href="#what-is-the-purpose-of-geowombat-s-context-manager" title="Permalink to this headline">#</a></h3>
<p>The examples shown in <a class="reference internal" href="docs/a_intro.html#document-docs/f_rs_io"><span class="doc std std-doc">reading remotely sensed data</span></a> opened the entire raster as DataArrays as they were stored on file. The configuration manager allows easy control over opened raster dimensions, alignment, and transformations.</p>
<p>For instance you might want to set the bound (extent) of your analysis. By setting bounds with the configuration manager we will minimize our overhead (less data processed) and uniformly treat all images we process.</p>
</div>
<div class="section" id="how-do-i-use-it">
<h3>How do I use it?<a class="headerlink" href="#how-do-i-use-it" title="Permalink to this headline">#</a></h3>
<p>To use GeoWombat’s configuration manager, just call <code class="docutils literal notranslate"><span class="pre">geowombat.config.update</span></code> before opening a file. For example,</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">geowombat</span> <span class="k">as</span> <span class="nn">gw</span>

<span class="k">with</span> <span class="n">gw</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">&lt;</span><span class="n">keywords</span><span class="o">&gt;...</span><span class="p">):</span>

<span class="c1"># Every file opened within the configuration block will use</span>
<span class="c1"># configuration keywords</span>
<span class="k">with</span> <span class="n">gw</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;image.tif&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
    <span class="c1"># do something</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">geowombat.config.update</span></code> stores keywords in a dictionary. To see all GeoWombat configuration keywords, just iterate over the dictionary.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">geowombat</span> <span class="k">as</span> <span class="nn">gw</span>
<span class="kn">from</span> <span class="nn">geowombat.data</span> <span class="kn">import</span> <span class="n">l8_224078_20200518</span>

<span class="c1"># Using the manager without keywords will set defaults</span>
<span class="k">with</span> <span class="n">gw</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">():</span>
    <span class="k">with</span> <span class="n">gw</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">l8_224078_20200518</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">src</span><span class="o">.</span><span class="n">gw</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Keyword:&#39;</span><span class="p">,</span> <span class="n">k</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">15</span><span class="p">),</span> <span class="s1">&#39;Value:&#39;</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Keyword: with_config     Value: True
Keyword: ignore_warnings Value: False
Keyword: sensor          Value: None
Keyword: scale_factor    Value: 1.0
Keyword: nodata          Value: None
Keyword: ref_image       Value: None
Keyword: ref_bounds      Value: None
Keyword: ref_crs         Value: None
Keyword: ref_res         Value: None
Keyword: ref_tar         Value: None
Keyword: blockxsize      Value: 512
Keyword: blockysize      Value: 512
Keyword: compress        Value: None
Keyword: driver          Value: GTiff
Keyword: tiled           Value: True
Keyword: bigtiff         Value: NO
Keyword: l57_angles_path Value: None
Keyword: l8_angles_path  Value: None
</pre></div>
</div>
</div>
</div>
<div class="section" id="reference-settings-crs">
<h4>Reference settings: CRS<a class="headerlink" href="#reference-settings-crs" title="Permalink to this headline">#</a></h4>
<p>Configuration keywords beginning with <strong>ref</strong> are the most important commands when opening rasters. For example, to transform the CRS of the data on-the-fly, use <strong>ref_crs</strong>. For more on Coordinate Reference Systems, see <a class="reference internal" href="docs/a_intro.html#document-docs/f_rs_crs"><span class="doc std std-doc">here</span></a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">geowombat</span> <span class="k">as</span> <span class="nn">gw</span>
<span class="kn">from</span> <span class="nn">geowombat.data</span> <span class="kn">import</span> <span class="n">l8_224078_20200518</span>

<span class="n">proj4</span> <span class="o">=</span> <span class="s2">&quot;+proj=aea +lat_1=-5 +lat_2=-42 +lat_0=-32 +lon_0=-60 +x_0=0 +y_0=0 +ellps=aust_SA +units=m +no_defs &quot;</span>
<span class="mi">0</span>
<span class="c1"># Without the manager</span>
<span class="k">with</span> <span class="n">gw</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">l8_224078_20200518</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>

<span class="c1"># With the manager</span>
<span class="k">with</span> <span class="n">gw</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">ref_crs</span><span class="o">=</span><span class="n">proj4</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">gw</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">l8_224078_20200518</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>+init=epsg:32621
+proj=aea +lat_0=-32 +lon_0=-60 +lat_1=-5 +lat_2=-42 +x_0=0 +y_0=0 +ellps=aust_SA +units=m +no_defs=True
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="reference-settings-cell-size">
<h4>Reference settings: Cell size<a class="headerlink" href="#reference-settings-cell-size" title="Permalink to this headline">#</a></h4>
<p>It is possible to combine multiple configuration keywords. In the example below, the raster CRS is transformed from UTM to Albers Equal Area with a resampled cell size of 100m x 100m.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">geowombat</span> <span class="k">as</span> <span class="nn">gw</span>
<span class="kn">from</span> <span class="nn">geowombat.data</span> <span class="kn">import</span> <span class="n">l8_224078_20200518</span>

<span class="c1"># Without the manager</span>
<span class="k">with</span> <span class="n">gw</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">l8_224078_20200518</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">gw</span><span class="o">.</span><span class="n">celly</span><span class="p">,</span> <span class="n">src</span><span class="o">.</span><span class="n">gw</span><span class="o">.</span><span class="n">cellx</span><span class="p">)</span>

<span class="c1"># With the manager</span>
<span class="k">with</span> <span class="n">gw</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">ref_crs</span><span class="o">=</span><span class="n">proj4</span><span class="p">,</span> <span class="n">ref_res</span><span class="o">=</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">)):</span>
    <span class="k">with</span> <span class="n">gw</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">l8_224078_20200518</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">gw</span><span class="o">.</span><span class="n">celly</span><span class="p">,</span> <span class="n">src</span><span class="o">.</span><span class="n">gw</span><span class="o">.</span><span class="n">cellx</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>30.0 30.0
100.0 100.0
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="reference-settings-bounds">
<h4>Reference settings: Bounds<a class="headerlink" href="#reference-settings-bounds" title="Permalink to this headline">#</a></h4>
<p>To subset an image, specify bounds as a <strong>tuple</strong> of (left, bottom, right, top) or a rasterio <strong>BoundingBox</strong> object.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">geowombat</span> <span class="k">as</span> <span class="nn">gw</span>
<span class="kn">from</span> <span class="nn">geowombat.data</span> <span class="kn">import</span> <span class="n">l8_224078_20200518</span>
<span class="kn">from</span> <span class="nn">rasterio.coords</span> <span class="kn">import</span> <span class="n">BoundingBox</span>

<span class="n">bounds</span> <span class="o">=</span> <span class="n">BoundingBox</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="mf">724634.17</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=-</span><span class="mf">2806501.39</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="mf">737655.48</span><span class="p">,</span> <span class="n">top</span><span class="o">=-</span><span class="mf">2796221.42</span><span class="p">)</span>

<span class="c1"># or</span>
<span class="c1"># bounds = (724634.17, -2806501.39, 737655.48, -2796221.42)</span>

<span class="c1"># Without the manager</span>
<span class="k">with</span> <span class="n">gw</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">l8_224078_20200518</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">gw</span><span class="o">.</span><span class="n">bounds</span><span class="p">)</span>

<span class="c1"># With the manager</span>
<span class="k">with</span> <span class="n">gw</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">ref_bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">gw</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">l8_224078_20200518</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">gw</span><span class="o">.</span><span class="n">bounds</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(717345.0, -2832795.0, 778575.0, -2776995.0)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(724634.17, -2806481.42, 737654.17, -2796221.42)
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="reference-settings-snap-raster-target">
<h4>Reference settings: Snap Raster Target<a class="headerlink" href="#reference-settings-snap-raster-target" title="Permalink to this headline">#</a></h4>
<p>By default, the bounding subset will be returned by the upper left coordinates of the bounds, potentially shifting cell alignment with the reference raster. To subset a raster and align it to the same grid, use the <strong>ref_tar</strong> keyword. This is equivalent to a “snap raster” in ArcGIS.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">gw</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">ref_bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span> <span class="n">ref_tar</span><span class="o">=</span><span class="n">rgbn</span><span class="p">):</span>

    <span class="k">with</span> <span class="n">gw</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">rgbn</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="reference-image">
<h4>Reference Image<a class="headerlink" href="#reference-image" title="Permalink to this headline">#</a></h4>
<p>To use another image as a reference, just set <strong>ref_image</strong>. Then, the opened file’s bounds, CRS, and cell size will be transformed to match those of the reference image.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">geowombat</span> <span class="k">as</span> <span class="nn">gw</span>
<span class="kn">from</span> <span class="nn">geowombat.data</span> <span class="kn">import</span> <span class="n">l8_224078_20200518</span><span class="p">,</span> <span class="n">l8_224077_20200518_B2</span>

<span class="c1"># Without the manager</span>
<span class="k">with</span> <span class="n">gw</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">l8_224078_20200518</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">gw</span><span class="o">.</span><span class="n">bounds</span><span class="p">)</span>

<span class="k">with</span> <span class="n">gw</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">l8_224077_20200518_B2</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">gw</span><span class="o">.</span><span class="n">bounds</span><span class="p">)</span>

<span class="c1"># With the manager</span>
<span class="k">with</span> <span class="n">gw</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">ref_image</span><span class="o">=</span><span class="n">l8_224077_20200518_B2</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">gw</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">l8_224078_20200518</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">gw</span><span class="o">.</span><span class="n">bounds</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(717345.0, -2832795.0, 778575.0, -2776995.0)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(694005.0, -2812065.0, 754185.0, -2766615.0)
(694005.0, -2812065.0, 754185.0, -2766615.0)
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="reference-settings-sensors">
<span id="f-rs-crs-sensors"></span><h4>Reference settings: Sensors<a class="headerlink" href="#reference-settings-sensors" title="Permalink to this headline">#</a></h4>
<p>Because rasters are opened as DataArrays, the band coordinates will be named. By default, the bands will be named by their index position (starting at 1). It might, however, be more intuitive to store the band names as strings, where the names correspond to the sensor wavelengths. In GeoWombat, you can set the band names explicitly upon opening a file by using the :func:<code class="docutils literal notranslate"><span class="pre">geowombat.open</span></code> <strong>band_names</strong> keyword. Alternatively, if the sensor is known (and supported by GeoWombat), then you can set the band names by specifying the sensor name in the configuration settings.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In the example below, the example raster comes from a Landsat image. However, only the visible (blue, green, and red) wavelengths are stored. Thus, we use ‘rgb’ as the sensor name. If we had a full 6-band Landsat 7 image, for example, we could use the ‘l7’ sensor flag.</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">geowombat</span> <span class="k">as</span> <span class="nn">gw</span>
<span class="kn">from</span> <span class="nn">geowombat.data</span> <span class="kn">import</span> <span class="n">l8_224078_20200518</span>

<span class="c1"># Without the manager</span>
<span class="k">with</span> <span class="n">gw</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">l8_224078_20200518</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">band</span><span class="p">)</span>

<span class="c1"># With the manager</span>
<span class="k">with</span> <span class="n">gw</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">sensor</span><span class="o">=</span><span class="s1">&#39;bgr&#39;</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">gw</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">l8_224078_20200518</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">band</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;xarray.DataArray &#39;band&#39; (band: 3)&gt;
array([1, 2, 3])
Coordinates:
  * band     (band) int64 1 2 3
&lt;xarray.DataArray &#39;band&#39; (band: 3)&gt;
array([&#39;blue&#39;, &#39;green&#39;, &#39;red&#39;], dtype=&#39;&lt;U5&#39;)
Coordinates:
  * band     (band) &lt;U5 &#39;blue&#39; &#39;green&#39; &#39;red&#39;
</pre></div>
</div>
</div>
</div>
<p>To see all available sensor names, use the <strong>avail_sensors</strong> property.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">gw</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">l8_224078_20200518</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">sensor_name</span> <span class="ow">in</span> <span class="n">src</span><span class="o">.</span><span class="n">gw</span><span class="o">.</span><span class="n">avail_sensors</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">sensor_name</span><span class="p">)</span>
</pre></div>
</div>
<p>For a short description of the sensor, use the <strong>sensor_names</strong> property.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">gw</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">l8_224078_20200518</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">sensor_name</span><span class="p">,</span> <span class="n">description</span> <span class="ow">in</span> <span class="n">src</span><span class="o">.</span><span class="n">gw</span><span class="o">.</span><span class="n">sensor_names</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sensor_name</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">15</span><span class="p">),</span> <span class="n">description</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>rgb            : red, green, and blue
rgbn           : red, green, blue, and NIR
bgr            : blue, green, and red
bgrn           : blue, green, red, and NIR
l5             : Landsat 5 Thematic Mapper (TM)
l7             : Landsat 7 Enhanced Thematic Mapper Plus (ETM+) without panchromatic and thermal bands
l7th           : Landsat 7 Enhanced Thematic Mapper Plus (ETM+) with thermal band
l7mspan        : Landsat 7 Enhanced Thematic Mapper Plus (ETM+) with panchromatic band
l7pan          : Landsat 7 panchromatic band
l8             : Landsat 8 Operational Land Imager (OLI) and Thermal Infrared Sensor (TIRS) without panchromatic and thermal bands
l8l7           : Landsat 8 Operational Land Imager (OLI) and Thermal Infrared Sensor (TIRS) with 6 Landsat 7-like bands
l8l7mspan      : Landsat 8 Operational Land Imager (OLI) and panchromatic band with 6 Landsat 7-like bands
l8th           : Landsat 8 Operational Land Imager (OLI) and Thermal Infrared Sensor (TIRS) with thermal band
l8pan          : Landsat 8 panchromatic band
s2             : Sentinel 2 Multi-Spectral Instrument (MSI) without 3 60m bands (coastal, water vapor, cirrus)
s2f            : Sentinel 2 Multi-Spectral Instrument (MSI) with 3 60m bands (coastal, water vapor, cirrus)
s2l7           : Sentinel 2 Multi-Spectral Instrument (MSI) with 6 Landsat 7-like bands
s210           : Sentinel 2 Multi-Spectral Instrument (MSI) with 4 10m (visible + NIR) bands
s220           : Sentinel 2 Multi-Spectral Instrument (MSI) with 6 20m bands
s2cloudless    : Sentinel 2 Multi-Spectral Instrument (MSI) with 10 bands for s2cloudless
ps             : PlanetScope with 4 (visible + NIR) bands
qb             : Quickbird with 4 (visible + NIR) bands
ik             : IKONOS with 4 (visible + NIR) bands
</pre></div>
</div>
</div>
</div>
<p>The following is a list of all available sensor names. This documentation may become out of date, if so please refer to geowombat/core/properties.py for the full list.</p>
<table class="colwidths-given docutils align-default">
<colgroup>
<col style="width: 25%" />
<col style="width: 75%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Abbreviated Name</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>‘rgb’</p></td>
<td><p>red, green, and blue</p></td>
</tr>
<tr class="row-odd"><td><p>‘rgbn’</p></td>
<td><p>red, green, blue, and NIR</p></td>
</tr>
<tr class="row-even"><td><p>‘bgr’</p></td>
<td><p>blue, green, and red</p></td>
</tr>
<tr class="row-odd"><td><p>‘bgrn’</p></td>
<td><p>blue, green, red, and NIR</p></td>
</tr>
<tr class="row-even"><td><p>‘l5’</p></td>
<td><p>Landsat 5 Thematic Mapper (TM)</p></td>
</tr>
<tr class="row-odd"><td><p>‘l7’</p></td>
<td><p>Landsat 7 Enhanced Thematic Mapper Plus (ETM+) without panchromatic and thermal bands</p></td>
</tr>
<tr class="row-even"><td><p>‘l7th’</p></td>
<td><p>Landsat 7 Enhanced Thematic Mapper Plus (ETM+) with thermal band</p></td>
</tr>
<tr class="row-odd"><td><p>‘l7mspan’</p></td>
<td><p>Landsat 7 Enhanced Thematic Mapper Plus (ETM+) with panchromatic band</p></td>
</tr>
<tr class="row-even"><td><p>‘l7pan’</p></td>
<td><p>Landsat 7 panchromatic band</p></td>
</tr>
<tr class="row-odd"><td><p>‘l8’</p></td>
<td><p>Landsat 8 Operational Land Imager (OLI) and Thermal Infrared Sensor (TIRS) without panchromatic and thermal bands</p></td>
</tr>
<tr class="row-even"><td><p>‘l8l7’</p></td>
<td><p>Landsat 8 Operational Land Imager (OLI) and Thermal Infrared Sensor (TIRS) with 6 Landsat 7-like bands</p></td>
</tr>
<tr class="row-odd"><td><p>‘l8l7mspan’</p></td>
<td><p>Landsat 8 Operational Land Imager (OLI) and panchromatic band with 6 Landsat 7-like bands</p></td>
</tr>
<tr class="row-even"><td><p>‘l8th’</p></td>
<td><p>Landsat 8 Operational Land Imager (OLI) and Thermal Infrared Sensor (TIRS) with thermal band</p></td>
</tr>
<tr class="row-odd"><td><p>‘l8pan’</p></td>
<td><p>Landsat 8 panchromatic band</p></td>
</tr>
<tr class="row-even"><td><p>‘s2’</p></td>
<td><p>Sentinel 2 Multi-Spectral Instrument (MSI) without 3 60m bands (coastal, water vapor, cirrus)</p></td>
</tr>
<tr class="row-odd"><td><p>‘s2f’</p></td>
<td><p>Sentinel 2 Multi-Spectral Instrument (MSI) with 3 60m bands (coastal, water vapor, cirrus)</p></td>
</tr>
<tr class="row-even"><td><p>‘s2l7’</p></td>
<td><p>Sentinel 2 Multi-Spectral Instrument (MSI) with 6 Landsat 7-like bands</p></td>
</tr>
<tr class="row-odd"><td><p>‘s210’</p></td>
<td><p>Sentinel 2 Multi-Spectral Instrument (MSI) with 4 10m (visible + NIR) bands</p></td>
</tr>
<tr class="row-even"><td><p>‘s220’</p></td>
<td><p>Sentinel 2 Multi-Spectral Instrument (MSI) with 6 20m bands</p></td>
</tr>
<tr class="row-odd"><td><p>‘s2cloudless’</p></td>
<td><p>Sentinel 2 Multi-Spectral Instrument (MSI) with 10 bands for s2cloudless</p></td>
</tr>
<tr class="row-even"><td><p>‘ps’</p></td>
<td><p>PlanetScope with 4 (visible + NIR) bands</p></td>
</tr>
<tr class="row-odd"><td><p>‘qb’</p></td>
<td><p>Quickbird with 4 (visible + NIR) bands</p></td>
</tr>
<tr class="row-even"><td><p>‘ik’</p></td>
<td><p>IKONOS with 4 (visible + NIR) bands</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<span id="document-docs/f_rs_edit"></span><hr class="docutils" id="f-rs-edit" />
<div class="admonition-learning-objectives admonition">
<p class="admonition-title">Learning Objectives</p>
<ul class="simple">
<li><p>Handle missing values</p></li>
<li><p>Setting missing values</p></li>
<li><p>Replacing values</p></li>
</ul>
</div>
<div class="admonition-review admonition">
<p class="admonition-title">Review</p>
<ul class="simple">
<li><p><a class="reference internal" href="docs/a_intro.html#document-docs/f_rs_io"><span class="doc std std-doc">Opening remotely sensed data</span></a></p></li>
</ul>
</div>
<hr class="docutils" />
<div class="tex2jax_ignore mathjax_ignore section" id="editing-rasters-and-remotely-sensed-data">
<h2>Editing Rasters and Remotely Sensed Data<a class="headerlink" href="#editing-rasters-and-remotely-sensed-data" title="Permalink to this headline">#</a></h2>
<div class="section" id="setting-no-data-values">
<h3>Setting ‘no data’ Values<a class="headerlink" href="#setting-no-data-values" title="Permalink to this headline">#</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">xarray.DataArray.where</span></code> function masks data by setting nans, as demonstrated by the example below.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">geowombat</span> <span class="k">as</span> <span class="nn">gw</span>
<span class="kn">from</span> <span class="nn">geowombat.data</span> <span class="kn">import</span> <span class="n">l8_224078_20200518</span>

<span class="c1"># Zeros are replaced with nans</span>
<span class="k">with</span> <span class="n">gw</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">l8_224078_20200518</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">src</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="setting-no-data-values-with-scaling">
<h3>Setting ‘no data’ Values with Scaling<a class="headerlink" href="#setting-no-data-values-with-scaling" title="Permalink to this headline">#</a></h3>
<p>In GeoWombat, we use <code class="docutils literal notranslate"><span class="pre">xarray.where</span></code> and <code class="docutils literal notranslate"><span class="pre">xarray.DataArray.where</span></code> along with optional scaling in the <code class="docutils literal notranslate"><span class="pre">set_nodata</span></code> function. In this example, we set zeros as 65535 and scale all other values from a [0,10000] range to [0,1].</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">geowombat</span> <span class="k">as</span> <span class="nn">gw</span>
<span class="kn">from</span> <span class="nn">geowombat.data</span> <span class="kn">import</span> <span class="n">l8_224078_20200518</span>

<span class="c1"># Set the &#39;no data&#39; value and scale all other values</span>
<span class="k">with</span> <span class="n">gw</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">l8_224078_20200518</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">gw</span><span class="o">.</span><span class="n">set_nodata</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">65535</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="s1">&#39;float64&#39;</span><span class="p">,</span> <span class="n">scale_factor</span><span class="o">=</span><span class="mf">0.0001</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="replace-values">
<h3>Replace values<a class="headerlink" href="#replace-values" title="Permalink to this headline">#</a></h3>
<p>The GeoWombat <code class="docutils literal notranslate"><span class="pre">replace</span></code> function mimics <code class="docutils literal notranslate"><span class="pre">pandas.DataFrame.replace</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">geowombat</span> <span class="k">as</span> <span class="nn">gw</span>
<span class="kn">from</span> <span class="nn">geowombat.data</span> <span class="kn">import</span> <span class="n">l8_224078_20200518</span>

<span class="c1"># Replace 1 with 10</span>
<span class="k">with</span> <span class="n">gw</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">l8_224078_20200518</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">gw</span><span class="o">.</span><span class="n">replace</span><span class="p">({</span><span class="mi">1</span><span class="p">:</span> <span class="mi">10</span><span class="p">})</span>
</pre></div>
</div>
</div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The <code class="docutils literal notranslate"><span class="pre">replace</span></code> function is typically used with categorical data.</p>
</div>
</div>
</div>
<span id="document-docs/f_rs_plot"></span><hr class="docutils" id="f-rs-plot" />
<div class="admonition-learning-objectives admonition">
<p class="admonition-title">Learning Objectives</p>
<ul class="simple">
<li><p>Visualize RGB images from remotely sensed data</p></li>
<li><p>Visualize true-color and false-color composites</p></li>
<li></li>
</ul>
</div>
<div class="admonition-review admonition">
<p class="admonition-title">Review</p>
<ul class="simple">
<li><p><a class="reference internal" href="docs/a_intro.html#document-docs/c_features"><span class="doc std std-doc">Data Structures</span></a></p></li>
<li><p><a class="reference internal" href="docs/a_intro.html#document-docs/c_rasters"><span class="doc std std-doc">Raster Data </span></a></p></li>
<li><p><a class="reference internal" href="docs/a_intro.html#document-docs/f_rs_io"><span class="doc std std-doc">Opening Remotely Sensed Data</span></a></p></li>
</ul>
</div>
<hr class="docutils" />
<div class="tex2jax_ignore mathjax_ignore section" id="plot-remote-sensed-images">
<h2>Plot Remote Sensed Images<a class="headerlink" href="#plot-remote-sensed-images" title="Permalink to this headline">#</a></h2>
<p>Import required modules and data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Import GeoWombat</span>
<span class="kn">import</span> <span class="nn">geowombat</span> <span class="k">as</span> <span class="nn">gw</span>

<span class="c1"># import plotting</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">matplotlib.patheffects</span> <span class="k">as</span> <span class="nn">pe</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="plot-a-single-band-image">
<h3>Plot a Single Band Image<a class="headerlink" href="#plot-a-single-band-image" title="Permalink to this headline">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">geowombat.data</span> <span class="kn">import</span> <span class="n">l8_224077_20200518_B2</span> 

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>

<span class="k">with</span> <span class="n">gw</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">l8_224077_20200518_B2</span><span class="p">,</span>
                <span class="n">band_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;blue&#39;</span><span class="p">])</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
    <span class="n">src</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">src</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">band</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">robust</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">pad</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/f_rs_plot_3_0.png" src="../_images/f_rs_plot_3_0.png" />
</div>
</div>
</div>
<div class="section" id="plot-a-true-color-landsat-image">
<h3>Plot a True Color LandSat Image<a class="headerlink" href="#plot-a-true-color-landsat-image" title="Permalink to this headline">#</a></h3>
<p>Here we open the image, missing data is removed with <code class="docutils literal notranslate"><span class="pre">.where(src</span> <span class="pre">!=</span> <span class="pre">0)</span></code>, remember the bands in this file are stored in reverse order (blue, green, red), so we put them back into order <code class="docutils literal notranslate"><span class="pre">.sel(band=[3,</span> <span class="pre">2,</span> <span class="pre">1])</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># load example data</span>
<span class="kn">from</span> <span class="nn">geowombat.data</span> <span class="kn">import</span> <span class="n">l8_224078_20200518</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
<span class="k">with</span> <span class="n">gw</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">l8_224078_20200518</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
    <span class="n">src</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">src</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">band</span><span class="o">=</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">robust</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">pad</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/f_rs_plot_5_0.png" src="../_images/f_rs_plot_5_0.png" />
</div>
</div>
</div>
<div class="section" id="plot-false-color-composites">
<h3>Plot False Color Composites<a class="headerlink" href="#plot-false-color-composites" title="Permalink to this headline">#</a></h3>
<p>We can use the red, green, and blue channels to show different parts of the spectrum. This allows us for instance to “see” near-infrared (nir). Moreover certain combinations of bands allow us to better identify vegetation, urban environments, water, etc. There are many false colored composites that can be used to highlight different features.</p>
<iframe width="560" height="315" src="https://www.youtube.com/embed/YP0et8l_bvY" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
<div class="section" id="color-infrared-vegetation">
<h4>Color Infrared (vegetation)<a class="headerlink" href="#color-infrared-vegetation" title="Permalink to this headline">#</a></h4>
<p>Here we will look at a common false color combo to assigns the nir band to the color red. This make vegetation appear bright red.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">geowombat.data</span> <span class="kn">import</span> <span class="n">rgbn</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>

<span class="k">with</span> <span class="n">gw</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">rgbn</span><span class="p">,</span>
            <span class="n">band_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;red&#39;</span><span class="p">,</span><span class="s1">&#39;green&#39;</span><span class="p">,</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span><span class="s1">&#39;nir&#39;</span><span class="p">],)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
    <span class="n">src</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">src</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">band</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;nir&#39;</span><span class="p">,</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="s1">&#39;green&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">robust</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">pad</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;rgb_plot.png&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/f_rs_plot_7_0.png" src="../_images/f_rs_plot_7_0.png" />
</div>
</div>
</div>
<div class="section" id="common-band-combinations-for-landsat-8">
<h4>Common Band Combinations for Landsat 8<a class="headerlink" href="#common-band-combinations-for-landsat-8" title="Permalink to this headline">#</a></h4>
<table class="colwidths-auto docutils align-default">
<thead>
<tr class="row-odd"><th class="text-align:left head"><p>Name</p></th>
<th class="text-align:right head"><p>Band Combination</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td class="text-align:left"><p>Natural Color</p></td>
<td class="text-align:right"><p>4 3 2</p></td>
</tr>
<tr class="row-odd"><td class="text-align:left"><p>False Color (urban)</p></td>
<td class="text-align:right"><p>7 6 4</p></td>
</tr>
<tr class="row-even"><td class="text-align:left"><p>Color Infrared (vegetation)</p></td>
<td class="text-align:right"><p>5 4 3</p></td>
</tr>
<tr class="row-odd"><td class="text-align:left"><p>Agriculture</p></td>
<td class="text-align:right"><p>6 5 2</p></td>
</tr>
<tr class="row-even"><td class="text-align:left"><p>Atmospheric Penetration</p></td>
<td class="text-align:right"><p>7 6 5</p></td>
</tr>
<tr class="row-odd"><td class="text-align:left"><p>Healthy Vegetation</p></td>
<td class="text-align:right"><p>5 6 2</p></td>
</tr>
<tr class="row-even"><td class="text-align:left"><p>Land/Water</p></td>
<td class="text-align:right"><p>5 6 4</p></td>
</tr>
<tr class="row-odd"><td class="text-align:left"><p>Natural With Atmospheric Removal</p></td>
<td class="text-align:right"><p>7 5 3</p></td>
</tr>
<tr class="row-even"><td class="text-align:left"><p>Shortwave Infrared</p></td>
<td class="text-align:right"><p>7 5 4</p></td>
</tr>
<tr class="row-odd"><td class="text-align:left"><p>Vegetation Analysis</p></td>
<td class="text-align:right"><p>6 5 4</p></td>
</tr>
</tbody>
</table>
<!-- 
## Plot Union of two LandSat Images
As an example let's plot the union with `mosaic=True` of two images taken on the same day, but blue band only. Note we rename the band name with `band_names=['blue']`.

```{code-cell} ipython3
# from geowombat.data import l8_224077_20200518_B2, l8_224078_20200518_B2

# fig, ax = plt.subplots(dpi=200)
# filenames = [l8_224077_20200518_B2, l8_224078_20200518_B2]
# with gw.open(filenames,
#                 band_names=['blue'],
#                 mosaic=True,
#                 bounds_by='union') as src:
#     src.where(src != 0).sel(band='blue').plot.imshow(robust=True, ax=ax)
# plt.tight_layout(pad=1)
```

## Plot Intersection of two LandSat Images
Same idea with the intersection, using `bounds_by='intersection'`, we still need to mosaic the two images `mosaic=True`.

```{code-cell} ipython3
# fig, ax = plt.subplots(dpi=200)
# filenames = [l8_224077_20200518_B2, l8_224078_20200518_B2]
# with gw.open(filenames,
#                 band_names=['blue'],
#                 mosaic=True,
#                 bounds_by='intersection') as src:
#     src.where(src != 0).sel(band='blue').plot.imshow(robust=True, ax=ax)
# plt.tight_layout(pad=1)
```
 -->
</div>
</div>
<div class="section" id="plot-landsat-tile-footprints">
<h3>Plot LandSat Tile Footprints<a class="headerlink" href="#plot-landsat-tile-footprints" title="Permalink to this headline">#</a></h3>
<p>Here we set up a more complicated plotting function for near IR ‘nir’.  Note the use of <code class="docutils literal notranslate"><span class="pre">footprint_grid</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">geowombat.data</span> <span class="kn">import</span> <span class="n">l8_224077_20200518_B4</span><span class="p">,</span> <span class="n">l8_224078_20200518_B4</span>

<span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="n">bounds_by</span><span class="p">,</span> <span class="n">ref_image</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">):</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">gw</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">ref_image</span><span class="o">=</span><span class="n">ref_image</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">gw</span><span class="o">.</span><span class="n">open</span><span class="p">([</span><span class="n">l8_224077_20200518_B4</span><span class="p">,</span> <span class="n">l8_224078_20200518_B4</span><span class="p">],</span>
                        <span class="n">band_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;nir&#39;</span><span class="p">],</span>
                        <span class="n">chunks</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span>
                        <span class="n">mosaic</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">bounds_by</span><span class="o">=</span><span class="n">bounds_by</span><span class="p">)</span> <span class="k">as</span> <span class="n">srca</span><span class="p">:</span>
            <span class="c1"># Plot the NIR band</span>
            <span class="n">srca</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">srca</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">band</span><span class="o">=</span><span class="s1">&#39;nir&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">robust</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cbar_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="s1">&#39;DN&#39;</span><span class="p">},</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
            <span class="c1"># Plot the image chunks</span>
            <span class="n">srca</span><span class="o">.</span><span class="n">gw</span><span class="o">.</span><span class="n">chunk_grid</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
            <span class="c1"># Plot the image footprints</span>
            <span class="n">srca</span><span class="o">.</span><span class="n">gw</span><span class="o">.</span><span class="n">footprint_grid</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
            <span class="c1"># Label the image footprints</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">srca</span><span class="o">.</span><span class="n">gw</span><span class="o">.</span><span class="n">footprint_grid</span><span class="o">.</span><span class="n">itertuples</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">centroid</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">centroid</span><span class="o">.</span><span class="n">y</span><span class="p">,</span>
                            <span class="n">s</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">footprint</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.TIF&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
                            <span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">centroid</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">centroid</span><span class="o">.</span><span class="n">y</span><span class="p">),</span>
                            <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span>
                            <span class="n">size</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
                            <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
                            <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
                            <span class="n">path_effects</span><span class="o">=</span><span class="p">[</span><span class="n">pe</span><span class="o">.</span><span class="n">withStroke</span><span class="p">(</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">foreground</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">)])</span>
            <span class="c1"># Set the display bounds</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">srca</span><span class="o">.</span><span class="n">gw</span><span class="o">.</span><span class="n">footprint_grid</span><span class="o">.</span><span class="n">total_bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="n">srca</span><span class="o">.</span><span class="n">gw</span><span class="o">.</span><span class="n">footprint_grid</span><span class="o">.</span><span class="n">total_bounds</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="mi">10</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">srca</span><span class="o">.</span><span class="n">gw</span><span class="o">.</span><span class="n">footprint_grid</span><span class="o">.</span><span class="n">total_bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="n">srca</span><span class="o">.</span><span class="n">gw</span><span class="o">.</span><span class="n">footprint_grid</span><span class="o">.</span><span class="n">total_bounds</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">title</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Image </span><span class="si">{</span><span class="n">bounds_by</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">if</span> <span class="n">bounds_by</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">ref_image</span><span class="p">)</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39; as reference&#39;</span>
    <span class="n">size</span> <span class="o">=</span> <span class="mi">12</span> <span class="k">if</span> <span class="n">bounds_by</span> <span class="k">else</span> <span class="mi">8</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">pad</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The two plots below illustrate how two images can be mosaicked. The orange grids highlight the image footprints while the black grids illustrate the <code class="docutils literal notranslate"><span class="pre">DataArray</span></code> chunks.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot</span><span class="p">(</span><span class="s1">&#39;union&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/f_rs_plot_11_0.png" src="../_images/f_rs_plot_11_0.png" />
</div>
</div>
</div>
</div>
<span id="document-docs/f_rs_crs"></span><hr class="docutils" id="f-rs-crs" />
<div class="admonition-learning-objectives admonition">
<p class="admonition-title">Learning Objectives</p>
<ul class="simple">
<li><p>Reproject remotely sensed data (change CRS)</p></li>
<li><p>Reproject on-the-fly</p></li>
<li><p>Understand resampling options</p></li>
</ul>
</div>
<div class="admonition-review admonition">
<p class="admonition-title">Review</p>
<ul class="simple">
<li><p><a class="reference internal" href="docs/a_intro.html#document-docs/d_crs_what_is_it"><span class="doc std std-doc">What is a CRS</span></a></p></li>
<li><p><a class="reference internal" href="docs/a_intro.html#document-docs/d_understand_crs_codes"><span class="doc std std-doc">Understanding CRS codes</span></a></p></li>
<li><p><a class="reference internal" href="docs/a_intro.html#document-docs/d_raster_crs_intro"><span class="doc std std-doc">Raster CRS</span></a></p></li>
</ul>
</div>
<hr class="docutils" />
<div class="tex2jax_ignore mathjax_ignore section" id="remote-sensing-coordinate-reference-systems">
<h2>Remote Sensing Coordinate Reference Systems<a class="headerlink" href="#remote-sensing-coordinate-reference-systems" title="Permalink to this headline">#</a></h2>
<p>Image projections can be transformed in GeoWombat using the configuration manager (see <a class="reference internal" href="docs/a_intro.html#document-docs/f_rs_config"><span class="doc std std-doc">Config Manager</span></a>). With the configuration manager, the CRS is transformed using <a class="reference external" href="https://rasterio.readthedocs.io/en/latest/api/rasterio.crs.html">rasterio CRS</a> and <a class="reference external" href="https://rasterio.readthedocs.io/en/latest/topics/virtual-warping.html">virtual warping</a>. For references, see <a class="reference external" href="https://spatialreference.org/">Spatial Reference</a> and <a class="reference external" href="http://epsg.io/">epsg.io</a>.</p>
<div class="section" id="view-image-coordinate-reference-system-properties">
<h3>View Image Coordinate Reference System &amp; Properties<a class="headerlink" href="#view-image-coordinate-reference-system-properties" title="Permalink to this headline">#</a></h3>
<p>In the following we will print out the properties relevant to CRS for the red, green blue image. The CRS can be accessed from the <a class="reference external" href="http://xarray.pydata.org/en/stable/generated/xarray.DataArray.html">xarray.DataArray</a> attributes.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">geowombat</span> <span class="k">as</span> <span class="nn">gw</span>
<span class="kn">from</span> <span class="nn">geowombat.data</span> <span class="kn">import</span> <span class="n">rgbn</span>

<span class="k">with</span> <span class="n">gw</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">rgbn</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">transform</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">gw</span><span class="o">.</span><span class="n">transform</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">resampling</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">res</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">gw</span><span class="o">.</span><span class="n">cellx</span><span class="p">,</span> <span class="n">src</span><span class="o">.</span><span class="n">gw</span><span class="o">.</span><span class="n">celly</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(5.0, 0.0, 792988.0, 0.0, -5.0, 2050382.0)
(5.0, 0.0, 792988.0, 0.0, -5.0, 2050382.0)
+init=epsg:32618
nearest
(5.0, 5.0)
5.0 5.0
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="transforming-a-crs-on-the-fly">
<h3>Transforming a CRS On-The-Fly<a class="headerlink" href="#transforming-a-crs-on-the-fly" title="Permalink to this headline">#</a></h3>
<p>To transform the CRS, use the context manager. In this example, an proj4 code is used. See <a class="reference internal" href="docs/a_intro.html#document-docs/d_understand_crs_codes"><span class="doc std std-doc">understanding CRS codes</span></a> for more details.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>

<span class="n">proj4</span> <span class="o">=</span> <span class="s2">&quot;+proj=aea +lat_1=20 +lat_2=60 +lat_0=40 +lon_0=-96 +x_0=0 +y_0=0 +datum=NAD83 +units=m +no_defs&quot;</span>

<span class="k">with</span> <span class="n">gw</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">ref_crs</span><span class="o">=</span><span class="n">proj4</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">gw</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">rgbn</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">transform</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">resampling</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">res</span><span class="p">)</span>
        <span class="n">src</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">src</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">band</span><span class="o">=</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">robust</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">pad</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(5.0, 0.0, 2502400.7632678417, 0.0, -5.0, -2147313.7330151177)
+proj=aea +lat_0=40 +lon_0=-96 +lat_1=20 +lat_2=60 +x_0=0 +y_0=0 +datum=NAD83 +units=m +no_defs=True
nearest
(5.0, 5.0)
</pre></div>
</div>
<img alt="../_images/f_rs_crs_3_1.png" src="../_images/f_rs_crs_3_1.png" />
</div>
</div>
<p>Other formats supported by rasterio, (e.g., PROJ4 strings) can be used.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">gw</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">ref_crs</span><span class="o">=</span><span class="n">proj4</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">gw</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">rgbn</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">transform</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">resampling</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">res</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(5.0, 0.0, 2502400.7632678417, 0.0, -5.0, -2147313.7330151177)
+proj=aea +lat_0=40 +lon_0=-96 +lat_1=20 +lat_2=60 +x_0=0 +y_0=0 +datum=NAD83 +units=m +no_defs=True
nearest
(5.0, 5.0)
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="resampling-the-cell-size">
<h3>Resampling the Cell Size<a class="headerlink" href="#resampling-the-cell-size" title="Permalink to this headline">#</a></h3>
<p>The resampling algorithm can be specified in the <code class="docutils literal notranslate"><span class="pre">geowombat.open</span></code> function. Here, we use cubic convolution resampling to warp the data to EPSG code 31972 (a UTM projection).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">gw</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">ref_crs</span><span class="o">=</span><span class="mi">31972</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">gw</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">rgbn</span><span class="p">,</span> <span class="n">resampling</span><span class="o">=</span><span class="s1">&#39;cubic&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">transform</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">resampling</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">res</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(5.0, 0.0, 792988.0000004865, 0.0, -5.0, 2050381.9999358936)
+init=epsg:31972
cubic
(5.0, 5.0)
</pre></div>
</div>
</div>
</div>
<p>The transformed cell resolution can be added in the context manager. Here, we resample the data to 10m x 10m spatial resolution.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">gw</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">ref_crs</span><span class="o">=</span><span class="mi">31972</span><span class="p">,</span> <span class="n">ref_res</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">)):</span>
    <span class="k">with</span> <span class="n">gw</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">rgbn</span><span class="p">,</span> <span class="n">resampling</span><span class="o">=</span><span class="s1">&#39;cubic&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">transform</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">resampling</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">res</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(10.0, 0.0, 792988.0000004865, 0.0, -10.0, 2050381.9999358936)
+init=epsg:31972
cubic
(10.0, 10.0)
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="transformations-outside-context-manager">
<h3>Transformations Outside Context Manager<a class="headerlink" href="#transformations-outside-context-manager" title="Permalink to this headline">#</a></h3>
<p>To transform an <code class="docutils literal notranslate"><span class="pre">xarray.DataArray</span></code> outside of a configuration context, use the <code class="docutils literal notranslate"><span class="pre">geowombat.transform_crs</span></code> function.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">gw</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">rgbn</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">transform</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">resampling</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">res</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">src_tr</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">gw</span><span class="o">.</span><span class="n">transform_crs</span><span class="p">(</span><span class="n">proj4</span><span class="p">,</span> <span class="n">dst_res</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="n">resampling</span><span class="o">=</span><span class="s1">&#39;bilinear&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">src_tr</span><span class="o">.</span><span class="n">transform</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">src_tr</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">src_tr</span><span class="o">.</span><span class="n">resampling</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">src_tr</span><span class="o">.</span><span class="n">res</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(5.0, 0.0, 792988.0, 0.0, -5.0, 2050382.0)
+init=epsg:32618
nearest
(5.0, 5.0)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(10.0, 0.0, 2502400.7632678417, 0.0, -10.0, -2147313.7330151177)
PROJCS[&quot;unknown&quot;,GEOGCS[&quot;unknown&quot;,DATUM[&quot;North_American_Datum_1983&quot;,SPHEROID[&quot;GRS 1980&quot;,6378137,298.257222101,AUTHORITY[&quot;EPSG&quot;,&quot;7019&quot;]],AUTHORITY[&quot;EPSG&quot;,&quot;6269&quot;]],PRIMEM[&quot;Greenwich&quot;,0,AUTHORITY[&quot;EPSG&quot;,&quot;8901&quot;]],UNIT[&quot;degree&quot;,0.0174532925199433,AUTHORITY[&quot;EPSG&quot;,&quot;9122&quot;]]],PROJECTION[&quot;Albers_Conic_Equal_Area&quot;],PARAMETER[&quot;latitude_of_center&quot;,40],PARAMETER[&quot;longitude_of_center&quot;,-96],PARAMETER[&quot;standard_parallel_1&quot;,20],PARAMETER[&quot;standard_parallel_2&quot;,60],PARAMETER[&quot;false_easting&quot;,0],PARAMETER[&quot;false_northing&quot;,0],UNIT[&quot;metre&quot;,1,AUTHORITY[&quot;EPSG&quot;,&quot;9001&quot;]],AXIS[&quot;Easting&quot;,EAST],AXIS[&quot;Northing&quot;,NORTH]]
bilinear
(10, 10)
</pre></div>
</div>
</div>
</div>
<p>For more help we can read through the docs a bit.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">gw</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">rgbn</span><span class="p">,</span> <span class="n">resampling</span><span class="o">=</span><span class="s1">&#39;cubic&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">help</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">gw</span><span class="o">.</span><span class="n">transform_crs</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Help on method transform_crs in module geowombat.core.geoxarray:

transform_crs(dst_crs=None, dst_res=None, dst_width=None, dst_height=None, dst_bounds=None, resampling=&#39;nearest&#39;, warp_mem_limit=512, num_threads=1) method of geowombat.core.geoxarray.GeoWombatAccessor instance
    Transforms a DataArray to a new coordinate reference system
    
    Args:
        dst_crs (Optional[CRS | int | dict | str]): The destination CRS.
        dst_res (Optional[tuple]): The destination resolution.
        dst_width (Optional[int]): The destination width. Cannot be used with ``dst_res``.
        dst_height (Optional[int]): The destination height. Cannot be used with ``dst_res``.
        dst_bounds (Optional[BoundingBox | tuple]): The destination bounds, as a ``rasterio.coords.BoundingBox``
            or as a tuple of (left, bottom, right, top).
        resampling (Optional[str]): The resampling method if ``filename`` is a ``list``.
            Choices are [&#39;average&#39;, &#39;bilinear&#39;, &#39;cubic&#39;, &#39;cubic_spline&#39;, &#39;gauss&#39;, &#39;lanczos&#39;, &#39;max&#39;, &#39;med&#39;, &#39;min&#39;, &#39;mode&#39;, &#39;nearest&#39;].
        warp_mem_lim    it (Optional[int]): The warp memory limit.
        num_threads (Optional[int]): The number of parallel threads.
    
    Returns:
        ``xarray.DataArray``
    
    Example:
        &gt;&gt;&gt; import geowombat as gw
        &gt;&gt;&gt;
        &gt;&gt;&gt; with gw.open(&#39;image.tif&#39;) as src:
        &gt;&gt;&gt;     dst = src.gw.transform_crs(4326)

None
</pre></div>
</div>
</div>
</div>
</div>
</div>
<span id="document-docs/f_rs_mosaic"></span><hr class="docutils" id="f-rs-mosaic" />
<div class="admonition-learning-objectives admonition">
<p class="admonition-title">Learning Objectives</p>
<ul class="simple">
<li><p>Create mosaics of more than one multiband image</p></li>
<li><p>Find the intersection of two images</p></li>
<li><p>View the footprint of multiple image tiles</p></li>
</ul>
</div>
<div class="admonition-review admonition">
<p class="admonition-title">Review</p>
<ul class="simple">
<li><p><a class="reference internal" href="docs/a_intro.html#document-docs/f_rs_io"><span class="doc std std-doc">Opening Remotely Sensed Data</span></a></p></li>
<li><p><span class="xref myst">Raster Operations</span></p></li>
</ul>
</div>
<hr class="docutils" />
<!-- https://www.l3harrisgeospatial.com/docs/MosaicSeamless.html -->
<!-- 
https://desktop.arcgis.com/en/arcmap/10.3/manage-data/raster-and-images/what-is-a-mosaic.htm -->
<div class="tex2jax_ignore mathjax_ignore section" id="handle-multiple-remotely-sensed-images">
<h2>Handle Multiple Remotely Sensed Images<a class="headerlink" href="#handle-multiple-remotely-sensed-images" title="Permalink to this headline">#</a></h2>
<p>Doing analysis over larger areas often requires the use of image mosaics (combining two or more images). Luckily for us geowombat makes this process relatively easy.</p>
<div class="section" id="union-mosaic-of-remotely-sensed-image">
<h3>Union (Mosaic) of Remotely Sensed Image<a class="headerlink" href="#union-mosaic-of-remotely-sensed-image" title="Permalink to this headline">#</a></h3>
<p>As an example let’s plot the union with <code class="docutils literal notranslate"><span class="pre">mosaic=True</span></code> of two images taken on the same day, for the overlapping portions we will use the mean pixel value by setting <code class="docutils literal notranslate"><span class="pre">overlap='mean'</span></code>, but blue band only. Alternatively we could use one of ‘mean’, ‘min’, or ‘max’.</p>
<p>Note we rename the band name with <code class="docutils literal notranslate"><span class="pre">band_names=['blue']</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Import GeoWombat</span>
<span class="kn">import</span> <span class="nn">geowombat</span> <span class="k">as</span> <span class="nn">gw</span>

<span class="c1"># import plotting</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">matplotlib.patheffects</span> <span class="k">as</span> <span class="nn">pe</span>

<span class="c1"># load data</span>
<span class="kn">from</span> <span class="nn">geowombat.data</span> <span class="kn">import</span> <span class="n">l8_224077_20200518_B2</span><span class="p">,</span> <span class="n">l8_224078_20200518_B2</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
<span class="n">filenames</span> <span class="o">=</span> <span class="p">[</span><span class="n">l8_224077_20200518_B2</span><span class="p">,</span> <span class="n">l8_224078_20200518_B2</span><span class="p">]</span>
<span class="k">with</span> <span class="n">gw</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filenames</span><span class="p">,</span>
                <span class="n">band_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;blue&#39;</span><span class="p">],</span>
                <span class="n">mosaic</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">overlap</span> <span class="o">=</span> <span class="s1">&#39;mean&#39;</span><span class="p">,</span>
                <span class="n">bounds_by</span><span class="o">=</span><span class="s1">&#39;union&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
    <span class="n">src</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">src</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">band</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">robust</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">pad</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/f_rs_mosaic_1_0.png" src="../_images/f_rs_mosaic_1_0.png" />
</div>
</div>
</div>
<div class="section" id="intersection-of-remotely-sensed-image">
<h3>Intersection of Remotely Sensed Image<a class="headerlink" href="#intersection-of-remotely-sensed-image" title="Permalink to this headline">#</a></h3>
<p>Same idea with the intersection, using <code class="docutils literal notranslate"><span class="pre">bounds_by='intersection'</span></code>, we still need to mosaic the two images <code class="docutils literal notranslate"><span class="pre">mosaic=True</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
<span class="n">filenames</span> <span class="o">=</span> <span class="p">[</span><span class="n">l8_224077_20200518_B2</span><span class="p">,</span> <span class="n">l8_224078_20200518_B2</span><span class="p">]</span>
<span class="k">with</span> <span class="n">gw</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filenames</span><span class="p">,</span>
                <span class="n">band_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;blue&#39;</span><span class="p">],</span>
                <span class="n">mosaic</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">overlap</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span>
                <span class="n">bounds_by</span><span class="o">=</span><span class="s1">&#39;intersection&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
    <span class="n">src</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">src</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">band</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">robust</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">pad</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/f_rs_mosaic_3_0.png" src="../_images/f_rs_mosaic_3_0.png" />
</div>
</div>
</div>
<div class="section" id="view-image-tile-footprints">
<h3>View Image Tile Footprints<a class="headerlink" href="#view-image-tile-footprints" title="Permalink to this headline">#</a></h3>
<p>Here we set up a more complicated plotting function for near IR ‘nir’.  Note the use of <code class="docutils literal notranslate"><span class="pre">footprint_grid</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">geowombat.data</span> <span class="kn">import</span> <span class="n">l8_224077_20200518_B4</span><span class="p">,</span> <span class="n">l8_224078_20200518_B4</span>

<span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="n">bounds_by</span><span class="p">,</span> <span class="n">ref_image</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">):</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">gw</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">ref_image</span><span class="o">=</span><span class="n">ref_image</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">gw</span><span class="o">.</span><span class="n">open</span><span class="p">([</span><span class="n">l8_224077_20200518_B4</span><span class="p">,</span> <span class="n">l8_224078_20200518_B4</span><span class="p">],</span>
                        <span class="n">band_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;nir&#39;</span><span class="p">],</span>
                        <span class="n">chunks</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span>
                        <span class="n">mosaic</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">bounds_by</span><span class="o">=</span><span class="n">bounds_by</span><span class="p">)</span> <span class="k">as</span> <span class="n">srca</span><span class="p">:</span>
            <span class="c1"># Plot the NIR band</span>
            <span class="n">srca</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">srca</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">band</span><span class="o">=</span><span class="s1">&#39;nir&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">robust</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cbar_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="s1">&#39;DN&#39;</span><span class="p">},</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
            <span class="c1"># Plot the image chunks</span>
            <span class="n">srca</span><span class="o">.</span><span class="n">gw</span><span class="o">.</span><span class="n">chunk_grid</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
            <span class="c1"># Plot the image footprints</span>
            <span class="n">srca</span><span class="o">.</span><span class="n">gw</span><span class="o">.</span><span class="n">footprint_grid</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
            <span class="c1"># Label the image footprints</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">srca</span><span class="o">.</span><span class="n">gw</span><span class="o">.</span><span class="n">footprint_grid</span><span class="o">.</span><span class="n">itertuples</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">centroid</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">centroid</span><span class="o">.</span><span class="n">y</span><span class="p">,</span>
                            <span class="n">s</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">footprint</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.TIF&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
                            <span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">centroid</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">centroid</span><span class="o">.</span><span class="n">y</span><span class="p">),</span>
                            <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span>
                            <span class="n">size</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
                            <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
                            <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
                            <span class="n">path_effects</span><span class="o">=</span><span class="p">[</span><span class="n">pe</span><span class="o">.</span><span class="n">withStroke</span><span class="p">(</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">foreground</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">)])</span>
            <span class="c1"># Set the display bounds</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">srca</span><span class="o">.</span><span class="n">gw</span><span class="o">.</span><span class="n">footprint_grid</span><span class="o">.</span><span class="n">total_bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="n">srca</span><span class="o">.</span><span class="n">gw</span><span class="o">.</span><span class="n">footprint_grid</span><span class="o">.</span><span class="n">total_bounds</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="mi">10</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">srca</span><span class="o">.</span><span class="n">gw</span><span class="o">.</span><span class="n">footprint_grid</span><span class="o">.</span><span class="n">total_bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="n">srca</span><span class="o">.</span><span class="n">gw</span><span class="o">.</span><span class="n">footprint_grid</span><span class="o">.</span><span class="n">total_bounds</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">title</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Image </span><span class="si">{</span><span class="n">bounds_by</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">if</span> <span class="n">bounds_by</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">ref_image</span><span class="p">)</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39; as reference&#39;</span>
    <span class="n">size</span> <span class="o">=</span> <span class="mi">12</span> <span class="k">if</span> <span class="n">bounds_by</span> <span class="k">else</span> <span class="mi">8</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">pad</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The two plots below illustrate how two images can be mosaicked. The orange grids highlight the image footprints while the black grids illustrate the <code class="docutils literal notranslate"><span class="pre">DataArray</span></code> chunks.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot</span><span class="p">(</span><span class="s1">&#39;union&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/f_rs_mosaic_7_0.png" src="../_images/f_rs_mosaic_7_0.png" />
</div>
</div>
</div>
</div>
<span id="document-docs/f_rs_band_math"></span><hr class="docutils" id="f-rs-band-math" />
<div class="admonition-learning-objectives admonition">
<p class="admonition-title">Learning Objectives</p>
<ul class="simple">
<li><p>Learn about basic principals of band math</p></li>
<li><p>Calculate common indicies like NDVI, EVI etc</p></li>
</ul>
</div>
<div class="admonition-review admonition">
<p class="admonition-title">Review</p>
<ul class="simple">
<li><p><a class="reference internal" href="docs/a_intro.html#document-docs/c_rasters"><span class="doc std std-doc">Raster Data </span></a></p></li>
<li><p><a class="reference internal" href="docs/a_intro.html#document-docs/f_rs_io"><span class="doc std std-doc">Opening Remotely Sensed Data</span></a></p></li>
<li><p><a class="reference internal" href="docs/a_intro.html#document-docs/f_rs_config"><span class="doc std std-doc">Sensor specific configurations</span></a></p></li>
</ul>
</div>
<hr class="docutils" />
<div class="tex2jax_ignore mathjax_ignore section" id="band-math-vegetation-indices">
<h2>Band Math &amp; Vegetation Indices<a class="headerlink" href="#band-math-vegetation-indices" title="Permalink to this headline">#</a></h2>
<div class="section" id="vegetation-indices">
<h3>Vegetation indices<a class="headerlink" href="#vegetation-indices" title="Permalink to this headline">#</a></h3>
<p>Healthy vegetation (with chlorophyll) reflects more near-infrared (NIR) and green light compared to other wavelengths and absorbs more red and blue light. We can use this effect to generate a number of vegetation indices including the following:</p>
<div class="section" id="enhanced-vegetation-index-evi">
<h4>Enhanced Vegetation Index (EVI)<a class="headerlink" href="#enhanced-vegetation-index-evi" title="Permalink to this headline">#</a></h4>
<p>EVI is an index of vegetation that is optimized to improve sensitivity to high biomass and better handling of background and atmospheric influences. It is calculated with the formula below using the Near Infrared (NIR), Red and Blue bands. There are also a number of parameters like <span class="math notranslate nohighlight">\(C_{1}\)</span> that are specific to each sensor. Luckily geowombat handles this all for you!</p>
<div class="math notranslate nohighlight">
\[EVI = G\times \frac{NIR-Red}{NIR+C_{1}\times Red-C_{2}\times Blue+L}\]</div>
<p>The result of this formula generates a value between -1 and +1.  Low reflectance (low values) in the red channel and high reflectance in the NIR channel will yield a high EVI value.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">geowombat</span> <span class="k">as</span> <span class="nn">gw</span>
<span class="kn">from</span> <span class="nn">geowombat.data</span> <span class="kn">import</span> <span class="n">rgbn</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
</pre></div>
</div>
</div>
</div>
<p>Calculate a vegetation index, returning an <code class="docutils literal notranslate"><span class="pre">Xarray.DataArray</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">gw</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">rgbn</span><span class="p">)</span> <span class="k">as</span> <span class="n">ds</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span>
    <span class="n">evi</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">gw</span><span class="o">.</span><span class="n">evi</span><span class="p">(</span><span class="n">sensor</span><span class="o">=</span><span class="s1">&#39;rgbn&#39;</span><span class="p">,</span> <span class="n">scale_factor</span><span class="o">=</span><span class="mf">0.0001</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">evi</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;xarray.DataArray (band: 4, y: 403, x: 515)&gt;
dask.array&lt;open_rasterio-b3d223d294244e0149d01d15b4a9c936&lt;this-array&gt;, shape=(4, 403, 515), dtype=uint8, chunksize=(1, 64, 64), chunktype=numpy.ndarray&gt;
Coordinates:
  * band     (band) int64 1 2 3 4
  * y        (y) float64 2.05e+06 2.05e+06 2.05e+06 ... 2.048e+06 2.048e+06
  * x        (x) float64 7.93e+05 7.93e+05 7.93e+05 ... 7.956e+05 7.956e+05
Attributes: (12/13)
    transform:          (5.0, 0.0, 792988.0, 0.0, -5.0, 2050382.0)
    crs:                +init=epsg:32618
    res:                (5.0, 5.0)
    is_tiled:           1
    nodatavals:         (nan, nan, nan, nan)
    scales:             (1.0, 1.0, 1.0, 1.0)
    ...                 ...
    AREA_OR_POINT:      Area
    DataType:           Generic
    filename:           /home/mmann1123/anaconda3/envs/pygisbookgw/lib/python...
    resampling:         nearest
    data_are_separate:  0
    data_are_stacked:   0
&lt;xarray.DataArray (band: 1, y: 403, x: 515)&gt;
dask.array&lt;broadcast_to, shape=(1, 403, 515), dtype=float64, chunksize=(1, 64, 64), chunktype=numpy.ndarray&gt;
Coordinates:
  * y        (y) float64 2.05e+06 2.05e+06 2.05e+06 ... 2.048e+06 2.048e+06
  * x        (x) float64 7.93e+05 7.93e+05 7.93e+05 ... 7.956e+05 7.956e+05
  * band     (band) &lt;U3 &#39;evi&#39;
Attributes: (12/17)
    transform:          (5.0, 0.0, 792988.0, 0.0, -5.0, 2050382.0)
    crs:                +init=epsg:32618
    res:                (5.0, 5.0)
    is_tiled:           1
    nodatavals:         None
    scales:             (1.0,)
    ...                 ...
    data_are_separate:  0
    data_are_stacked:   0
    pre-scaling:        0.0001
    sensor:             rgbn
    vi:                 evi
    drange:             (0, 1)
</pre></div>
</div>
</div>
</div>
<p>Or use the configuration context to set parameters.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>

<span class="k">with</span> <span class="n">gw</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">sensor</span><span class="o">=</span><span class="s1">&#39;rgbn&#39;</span><span class="p">,</span> <span class="n">scale_factor</span><span class="o">=</span><span class="mf">0.0001</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">gw</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">rgbn</span><span class="p">)</span> <span class="k">as</span> <span class="n">ds</span><span class="p">:</span>
        <span class="n">evi</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">gw</span><span class="o">.</span><span class="n">evi</span><span class="p">()</span>
        <span class="n">evi</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">robust</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">pad</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/f_rs_band_math_5_0.png" src="../_images/f_rs_band_math_5_0.png" />
</div>
</div>
</div>
<div class="section" id="two-band-enhanced-vegetation-index-evi2">
<h4>Two-band Enhanced Vegetation Index (EVI2)<a class="headerlink" href="#two-band-enhanced-vegetation-index-evi2" title="Permalink to this headline">#</a></h4>
<p>We can also calcuate an approximation of EVI with two bands using <span class="math notranslate nohighlight">\(G\times ((NIR-RED)/(L+NIR+C\times Red))\)</span></p>
<p>This allows us to extend EVI calculations back in time using AVHRR, and avoids some problems with the blue band which tends to be noisy.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>

<span class="k">with</span> <span class="n">gw</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">sensor</span><span class="o">=</span><span class="s1">&#39;rgbn&#39;</span><span class="p">,</span> <span class="n">scale_factor</span><span class="o">=</span><span class="mf">0.0001</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">gw</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">rgbn</span><span class="p">)</span> <span class="k">as</span> <span class="n">ds</span><span class="p">:</span>
        <span class="n">evi2</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">gw</span><span class="o">.</span><span class="n">evi2</span><span class="p">()</span>
        <span class="n">evi2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">robust</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">pad</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/f_rs_band_math_7_0.png" src="../_images/f_rs_band_math_7_0.png" />
</div>
</div>
</div>
<div class="section" id="normalized-difference-indices-ndvi">
<h4>Normalized Difference Indices (NDVI)<a class="headerlink" href="#normalized-difference-indices-ndvi" title="Permalink to this headline">#</a></h4>
<p>The simplest vegetation metric is NDVI, which is just the normalized difference between the Red and NIR bands. It is calculated as follows <span class="math notranslate nohighlight">\(\frac{NIR-Red}{NIR+Red}\)</span>.</p>
<p>We can calculate it using the generic <code class="docutils literal notranslate"><span class="pre">norm_diff</span></code> function for any two-band combination.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">gw</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">sensor</span><span class="o">=</span><span class="s1">&#39;rgbn&#39;</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">gw</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">rgbn</span><span class="p">)</span> <span class="k">as</span> <span class="n">ds</span><span class="p">:</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">gw</span><span class="o">.</span><span class="n">norm_diff</span><span class="p">(</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="s1">&#39;nir&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;xarray.DataArray (band: 1, y: 403, x: 515)&gt;
dask.array&lt;broadcast_to, shape=(1, 403, 515), dtype=float64, chunksize=(1, 64, 64), chunktype=numpy.ndarray&gt;
Coordinates:
  * y        (y) float64 2.05e+06 2.05e+06 2.05e+06 ... 2.048e+06 2.048e+06
  * x        (x) float64 7.93e+05 7.93e+05 7.93e+05 ... 7.956e+05 7.956e+05
  * band     (band) &lt;U9 &#39;norm-diff&#39;
Attributes: (12/17)
    transform:          (5.0, 0.0, 792988.0, 0.0, -5.0, 2050382.0)
    crs:                +init=epsg:32618
    res:                (5.0, 5.0)
    is_tiled:           1
    nodatavals:         None
    scales:             (1.0,)
    ...                 ...
    resampling:         nearest
    data_are_separate:  0
    data_are_stacked:   0
    pre-scaling:        1.0
    vi:                 norm-diff
    drange:             (-1, 1)
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="tasseled-cap-transformations">
<h4>Tasseled Cap Transformations<a class="headerlink" href="#tasseled-cap-transformations" title="Permalink to this headline">#</a></h4>
<p>Tasseled cap tranform uses a linear equation to try to differentiate different components of the spectrum that are of interest for vegetation dynamics such as phenological stages. The output includes three bands including <code class="docutils literal notranslate"><span class="pre">brightness</span></code>, <code class="docutils literal notranslate"><span class="pre">greeness</span></code> for vegetation, and <code class="docutils literal notranslate"><span class="pre">wetness</span></code> as an idicator of soil and canopy moisture. Use <code class="docutils literal notranslate"><span class="pre">.sel(band='wetness')</span></code> to select them individually.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>

<span class="k">with</span> <span class="n">gw</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">sensor</span><span class="o">=</span><span class="s1">&#39;qb&#39;</span><span class="p">,</span> <span class="n">scale_factor</span><span class="o">=</span><span class="mf">0.0001</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">gw</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">rgbn</span><span class="p">)</span> <span class="k">as</span> <span class="n">ds</span><span class="p">:</span>
        <span class="n">tcap</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">gw</span><span class="o">.</span><span class="n">tasseled_cap</span><span class="p">()</span>
        <span class="n">tcap</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">band</span><span class="o">=</span><span class="s1">&#39;wetness&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">robust</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">tcap</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">pad</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;xarray.DataArray (band: 3, y: 403, x: 515)&gt;
dask.array&lt;astype, shape=(3, 403, 515), dtype=float64, chunksize=(3, 64, 64), chunktype=numpy.ndarray&gt;
Coordinates:
  * y        (y) float64 2.05e+06 2.05e+06 2.05e+06 ... 2.048e+06 2.048e+06
  * x        (x) float64 7.93e+05 7.93e+05 7.93e+05 ... 7.956e+05 7.956e+05
  * band     (band) &lt;U10 &#39;brightness&#39; &#39;greenness&#39; &#39;wetness&#39;
Attributes: (12/14)
    transform:          (5.0, 0.0, 792988.0, 0.0, -5.0, 2050382.0)
    crs:                +init=epsg:32618
    res:                (5.0, 5.0)
    is_tiled:           1
    nodatavals:         (nan, nan, nan, nan)
    scales:             (1.0, 1.0, 1.0, 1.0)
    ...                 ...
    DataType:           Generic
    sensor:             Quickbird with 4 (visible + NIR) bands
    filename:           /home/mmann1123/anaconda3/envs/pygisbookgw/lib/python...
    resampling:         nearest
    data_are_separate:  0
    data_are_stacked:   0
</pre></div>
</div>
<img alt="../_images/f_rs_band_math_11_1.png" src="../_images/f_rs_band_math_11_1.png" />
</div>
</div>
<p>Sources:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://en.wikipedia.org/wiki/Enhanced_vegetation_index">Wikipedia EVI</a></p></li>
<li><p><a class="reference external" href="https://en.wikipedia.org/wiki/Tasseled_cap_transformation">Wikipedia Tasseled Cap</a></p></li>
</ul>
</div>
</div>
</div>
<span id="document-docs/f_rs_extraction"></span><hr class="docutils" id="f-rs-extraction" />
<div class="admonition-learning-objectives admonition">
<p class="admonition-title">Learning Objectives</p>
<ul class="simple">
<li><p>Subset bands by index or name</p></li>
<li><p>Extract raster data by row and column number</p></li>
<li><p>Extract data by bounding window</p></li>
<li><p>Extract raster data by coordinates</p></li>
<li><p>Extract raster data by geometry (point, polygon)</p></li>
</ul>
</div>
<div class="admonition-review admonition">
<p class="admonition-title">Review</p>
<ul class="simple">
<li><p><a class="reference internal" href="docs/a_intro.html#document-docs/c_features"><span class="doc std std-doc">Data Structures</span></a></p></li>
<li><p><a class="reference internal" href="docs/a_intro.html#document-docs/c_rasters"><span class="doc std std-doc">Raster Data </span></a></p></li>
<li><p><a class="reference internal" href="docs/a_intro.html#document-docs/f_rs_io"><span class="doc std std-doc">Reading and writing remotely sensed data </span></a></p></li>
</ul>
</div>
<hr class="docutils" />
<div class="tex2jax_ignore mathjax_ignore section" id="raster-data-extraction">
<h2>Raster Data Extraction<a class="headerlink" href="#raster-data-extraction" title="Permalink to this headline">#</a></h2>
<p>Raster data is often of little use unless we can extract and summarize the data. For instance, extracting raster to points by coordinates allows us to pass data to machine learning models for land cover classification or cloud masking.</p>
<div class="section" id="subsetting-rasters">
<h3>Subsetting rasters<a class="headerlink" href="#subsetting-rasters" title="Permalink to this headline">#</a></h3>
<p>We can subset sections of the data array in a number of ways. In this case we will create a slice based on row and column location to subset LandSat data using a <code class="docutils literal notranslate"><span class="pre">rasterio.window.Window</span></code>.</p>
<p>Either a <code class="docutils literal notranslate"><span class="pre">rasterio.window.Window</span></code> object or tuple can be used with <code class="docutils literal notranslate"><span class="pre">geowombat.open</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">geowombat</span> <span class="k">as</span> <span class="nn">gw</span>
<span class="kn">from</span> <span class="nn">geowombat.data</span> <span class="kn">import</span> <span class="n">rgbn</span>

<span class="kn">from</span> <span class="nn">rasterio.windows</span> <span class="kn">import</span> <span class="n">Window</span>
<span class="n">w</span> <span class="o">=</span> <span class="n">Window</span><span class="p">(</span><span class="n">row_off</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">col_off</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>

<span class="k">with</span> <span class="n">gw</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">rgbn</span><span class="p">,</span>
                <span class="n">band_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="s1">&#39;red&#39;</span><span class="p">],</span>
                <span class="n">num_workers</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
                <span class="n">indexes</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
                <span class="n">window</span><span class="o">=</span><span class="n">w</span><span class="p">,</span>
                <span class="n">out_dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;xarray.DataArray &#39;array-c1686f70048cb766e2fe94fb3c34fb6d&#39; (band: 3, y: 100, x: 100)&gt;
dask.array&lt;array, shape=(3, 100, 100), dtype=float32, chunksize=(1, 64, 64), chunktype=numpy.ndarray&gt;
Coordinates:
  * band     (band) &lt;U5 &#39;blue&#39; &#39;green&#39; &#39;red&#39;
  * y        (y) float64 2.05e+06 2.05e+06 2.05e+06 ... 2.05e+06 2.05e+06
  * x        (x) float64 7.93e+05 7.93e+05 7.93e+05 ... 7.935e+05 7.935e+05
Attributes:
    transform:          | 5.00, 0.00, 792988.00|\n| 0.00,-5.00, 2050382.00|\n...
    crs:                +init=epsg:32618
    res:                (5.0, 5.0)
    is_tiled:           1
    nodatavals:         (nan, nan, nan, nan)
    offsets:            (0.0, 0.0, 0.0, 0.0)
    data_are_separate:  0
    data_are_stacked:   0
</pre></div>
</div>
</div>
</div>
<p>We can also slice a subset of data using a tuple of bounded coordinates.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">bounds</span> <span class="o">=</span> <span class="p">(</span><span class="mf">793475.76</span><span class="p">,</span> <span class="mf">2049033.03</span><span class="p">,</span> <span class="mf">794222.03</span><span class="p">,</span> <span class="mf">2049527.24</span><span class="p">)</span>

<span class="k">with</span> <span class="n">gw</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">rgbn</span><span class="p">,</span>
                <span class="n">band_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="s1">&#39;nir&#39;</span><span class="p">],</span>
                <span class="n">num_workers</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
                <span class="n">indexes</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span>
                <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span>
                <span class="n">out_dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
</pre></div>
</div>
<p>The configuration manager provides an alternative method to subset rasters. See <code class="docutils literal notranslate"><span class="pre">tutorial-config</span></code> for more details.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">gw</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">ref_bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">):</span>

    <span class="k">with</span> <span class="n">gw</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">rgbn</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
</pre></div>
</div>
<p>By default, the subset will be returned by the upper left coordinates of the bounds, potentially shifting cell alignment with the reference raster. To subset a raster and align it to the same grid, use the <strong>ref_tar</strong> keyword. This is equivalent to a “snap raster” in ArcGIS.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">gw</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">ref_bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span> <span class="n">ref_tar</span><span class="o">=</span><span class="n">rgbn</span><span class="p">):</span>

    <span class="k">with</span> <span class="n">gw</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">rgbn</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="extracting-data-by-coordinates">
<h3>Extracting data by coordinates<a class="headerlink" href="#extracting-data-by-coordinates" title="Permalink to this headline">#</a></h3>
<p>To extract values at a coordinate pair, translate the coordinates into array indices. For extraction by geometry, for instance with a shapefile, see <a class="reference internal" href="#f-rs-extraction-point"><span class="std std-ref">extract by point geometry</span></a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">geowombat</span> <span class="k">as</span> <span class="nn">gw</span>
<span class="kn">from</span> <span class="nn">geowombat.data</span> <span class="kn">import</span> <span class="n">l8_224078_20200518</span>

<span class="c1"># Coordinates in map projection units</span>
<span class="n">y</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="o">-</span><span class="mf">2823031.15</span><span class="p">,</span> <span class="mf">761592.60</span>

<span class="k">with</span> <span class="n">gw</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">l8_224078_20200518</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
    <span class="c1"># Transform the map coordinates to data indices</span>
    <span class="n">j</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="n">gw</span><span class="o">.</span><span class="n">coords_to_indices</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">src</span><span class="p">)</span>
    <span class="c1"># Subset by index</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">src</span><span class="p">[:,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[7448 6882 6090]
</pre></div>
</div>
</div>
</div>
<p>A latitude/longitude pair can be extracted after converting to the map projection.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">geowombat</span> <span class="k">as</span> <span class="nn">gw</span>
<span class="kn">from</span> <span class="nn">geowombat.data</span> <span class="kn">import</span> <span class="n">l8_224078_20200518</span>

<span class="c1"># Coordinates in latitude/longitude</span>
<span class="n">lat</span><span class="p">,</span> <span class="n">lon</span> <span class="o">=</span> <span class="o">-</span><span class="mf">25.50142964</span><span class="p">,</span> <span class="o">-</span><span class="mf">54.39756038</span>

<span class="k">with</span> <span class="n">gw</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">l8_224078_20200518</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
    <span class="c1"># Transform the coordinates to map units</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">gw</span><span class="o">.</span><span class="n">lonlat_to_xy</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">src</span><span class="p">)</span>
    <span class="c1"># Transform the map coordinates to data indices</span>
    <span class="n">j</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="n">gw</span><span class="o">.</span><span class="n">coords_to_indices</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">src</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">src</span><span class="p">[:,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[7448 6882 6090]
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="extracting-data-with-point-geometry">
<span id="f-rs-extraction-point"></span><h3>Extracting data with point geometry<a class="headerlink" href="#extracting-data-with-point-geometry" title="Permalink to this headline">#</a></h3>
<p>In the example below, ‘l8_224078_20200518_points’ is a <a class="reference external" href="https://www.geopackage.org/">GeoPackage</a> of point locations, and the output <code class="docutils literal notranslate"><span class="pre">df</span></code> is a <a class="reference external" href="https://geopandas.org/docs/reference/api/geopandas.GeoDataFrame.html?highlight=geodataframe#geopandas.GeoDataFrame">GeoPandas GeoDataFrame</a>. To extract the raster values at the point locations, use <code class="docutils literal notranslate"><span class="pre">geowombat.extract</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">geowombat</span> <span class="k">as</span> <span class="nn">gw</span>
<span class="kn">from</span> <span class="nn">geowombat.data</span> <span class="kn">import</span> <span class="n">l8_224078_20200518</span><span class="p">,</span> <span class="n">l8_224078_20200518_points</span>

<span class="k">with</span> <span class="n">gw</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">l8_224078_20200518</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">gw</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">l8_224078_20200518_points</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>        name                         geometry  id     1     2     3
0      water  POINT (741522.314 -2811204.698)   0  7966  7326  6254
1       crop  POINT (736140.845 -2806478.364)   1  8030  7490  8080
2       tree  POINT (745919.508 -2805168.579)   2  7561  6874  6106
3  developed  POINT (739056.735 -2811710.662)   3  8302  8202  8111
4      water  POINT (737802.183 -2818016.412)   4  8277  7982  7341
5       tree  POINT (759209.443 -2828566.230)   5  7398  6711  6007
</pre></div>
</div>
</div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The line <code class="docutils literal notranslate"><span class="pre">df</span> <span class="pre">=</span> <span class="pre">src.gw.extract(l8_224078_20200518_points)</span></code> could also have been written as <code class="docutils literal notranslate"><span class="pre">df</span> <span class="pre">=</span> <span class="pre">gw.extract(src,</span> <span class="pre">l8_224078_20200518_points)</span></code>.</p>
</div>
<p>In the previous example, the point vector had a CRS that matched the raster (i.e., EPSG=32621, or UTM zone 21N). If the CRS had not matched, the <code class="docutils literal notranslate"><span class="pre">geowombat.extract</span></code> function transforms the CRS on-the-fly.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">geowombat</span> <span class="k">as</span> <span class="nn">gw</span>
<span class="kn">from</span> <span class="nn">geowombat.data</span> <span class="kn">import</span> <span class="n">l8_224078_20200518</span><span class="p">,</span> <span class="n">l8_224078_20200518_points</span>
<span class="kn">import</span> <span class="nn">geopandas</span> <span class="k">as</span> <span class="nn">gpd</span>

<span class="n">point_df</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">l8_224078_20200518_points</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">point_df</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>

<span class="c1"># Transform the CRS to WGS84 lat/lon</span>
<span class="n">point_df</span> <span class="o">=</span> <span class="n">point_df</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="s1">&#39;epsg:4326&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">point_df</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>

<span class="k">with</span> <span class="n">gw</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">l8_224078_20200518</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">gw</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">point_df</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>epsg:32621
epsg:4326
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>        name                         geometry  id     1     2     3
0      water  POINT (741522.314 -2811204.698)   0  7966  7326  6254
1       crop  POINT (736140.845 -2806478.364)   1  8030  7490  8080
2       tree  POINT (745919.508 -2805168.579)   2  7561  6874  6106
3  developed  POINT (739056.735 -2811710.662)   3  8302  8202  8111
4      water  POINT (737802.183 -2818016.412)   4  8277  7982  7341
5       tree  POINT (759209.443 -2828566.230)   5  7398  6711  6007
</pre></div>
</div>
</div>
</div>
<p>Set the data band names using <code class="docutils literal notranslate"><span class="pre">sensor</span> <span class="pre">=</span> <span class="pre">'bgr'</span></code>, which assigns the band names blue, green, red.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">geowombat</span> <span class="k">as</span> <span class="nn">gw</span>
<span class="kn">from</span> <span class="nn">geowombat.data</span> <span class="kn">import</span> <span class="n">l8_224078_20200518</span><span class="p">,</span> <span class="n">l8_224078_20200518_points</span>

<span class="k">with</span> <span class="n">gw</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">sensor</span><span class="o">=</span><span class="s1">&#39;bgr&#39;</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">gw</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">l8_224078_20200518</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">gw</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">l8_224078_20200518_points</span><span class="p">,</span>
                            <span class="n">band_names</span><span class="o">=</span><span class="n">src</span><span class="o">.</span><span class="n">band</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>

<span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>        name                         geometry  id  blue  green   red
0      water  POINT (741522.314 -2811204.698)   0  7966   7326  6254
1       crop  POINT (736140.845 -2806478.364)   1  8030   7490  8080
2       tree  POINT (745919.508 -2805168.579)   2  7561   6874  6106
3  developed  POINT (739056.735 -2811710.662)   3  8302   8202  8111
4      water  POINT (737802.183 -2818016.412)   4  8277   7982  7341
5       tree  POINT (759209.443 -2828566.230)   5  7398   6711  6007
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="extracting-time-series-images-by-point-geometry">
<h3>Extracting time series images by point geometry<a class="headerlink" href="#extracting-time-series-images-by-point-geometry" title="Permalink to this headline">#</a></h3>
<p>We can also easily extract a time series of raster images. Extracted pixel values are provided in ‘wide’ format with appropriate labels, for instance the column ‘t2_blue’ would be the blue band for the second time period</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">geowombat.data</span> <span class="kn">import</span> <span class="n">l8_224078_20200518</span><span class="p">,</span> <span class="n">l8_224078_20200518_points</span>

<span class="k">with</span> <span class="n">gw</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">sensor</span><span class="o">=</span><span class="s1">&#39;bgr&#39;</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">gw</span><span class="o">.</span><span class="n">open</span><span class="p">([</span><span class="n">l8_224078_20200518</span><span class="p">,</span> <span class="n">l8_224078_20200518</span><span class="p">],</span>
            <span class="n">time_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;t1&#39;</span><span class="p">,</span> <span class="s1">&#39;t2&#39;</span><span class="p">],</span>
            <span class="n">stack_dim</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>

        <span class="c1"># Extract and by point geometry</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">gw</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">l8_224078_20200518_points</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>        name                         geometry  id  t1_blue  t1_green  t1_red  \
0      water  POINT (741522.314 -2811204.698)   0     7966      7326    6254   
1       crop  POINT (736140.845 -2806478.364)   1     8030      7490    8080   
2       tree  POINT (745919.508 -2805168.579)   2     7561      6874    6106   
3  developed  POINT (739056.735 -2811710.662)   3     8302      8202    8111   
4      water  POINT (737802.183 -2818016.412)   4     8277      7982    7341   
5       tree  POINT (759209.443 -2828566.230)   5     7398      6711    6007   

   t2_blue  t2_green  t2_red  
0     7966      7326    6254  
1     8030      7490    8080  
2     7561      6874    6106  
3     8302      8202    8111  
4     8277      7982    7341  
5     7398      6711    6007  
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="extracting-data-by-polygon-geometry">
<h3>Extracting data by polygon geometry<a class="headerlink" href="#extracting-data-by-polygon-geometry" title="Permalink to this headline">#</a></h3>
<p>To extract values within polygons, use the same <code class="docutils literal notranslate"><span class="pre">geowombat.extract</span></code> function.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">geowombat.data</span> <span class="kn">import</span> <span class="n">l8_224078_20200518</span><span class="p">,</span> <span class="n">l8_224078_20200518_polygons</span>

<span class="k">with</span> <span class="n">gw</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">sensor</span><span class="o">=</span><span class="s1">&#39;bgr&#39;</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">gw</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">l8_224078_20200518</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">gw</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">l8_224078_20200518_polygons</span><span class="p">,</span>
                            <span class="n">band_names</span><span class="o">=</span><span class="n">src</span><span class="o">.</span><span class="n">band</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>     id  point                         geometry       name   blue  green  \
0     0      0  POINT (737535.000 -2795205.000)      water   8017   7435   
1     0      1  POINT (737565.000 -2795205.000)      water   8016   7439   
2     0      2  POINT (737595.000 -2795205.000)      water   8012   7442   
3     0      3  POINT (737625.000 -2795205.000)      water   7997   7422   
4     0      4  POINT (737655.000 -2795205.000)      water   7997   7405   
..   ..    ...                              ...        ...    ...    ...   
667   3    667  POINT (739005.000 -2811795.000)  developed   9014   8236   
668   3    668  POINT (739035.000 -2811795.000)  developed   8567   8564   
669   3    669  POINT (739065.000 -2811795.000)  developed   8099   7676   
670   3    670  POINT (739095.000 -2811795.000)  developed  10151   9651   
671   3    671  POINT (739125.000 -2811795.000)  developed   8065   7735   

       red  
0     6283  
1     6294  
2     6295  
3     6284  
4     6266  
..     ...  
667   8325  
668   8447  
669   7332  
670  10153  
671   7501  

[672 rows x 7 columns]
</pre></div>
</div>
</div>
</div>
<div class="section" id="calculate-mean-pixel-value-by-polygon">
<h4>Calculate mean pixel value by polygon<a class="headerlink" href="#calculate-mean-pixel-value-by-polygon" title="Permalink to this headline">#</a></h4>
<p>It is simple then to calculate the mean value of pixels within each polygon by using the polygon <code class="docutils literal notranslate"><span class="pre">id</span></code> column and pandas groupby function. You can easily calculate other statistics like min, max, median etc.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">geowombat.data</span> <span class="kn">import</span> <span class="n">l8_224078_20200518</span><span class="p">,</span> <span class="n">l8_224078_20200518_polygons</span>

<span class="k">with</span> <span class="n">gw</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">sensor</span><span class="o">=</span><span class="s1">&#39;bgr&#39;</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">gw</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">l8_224078_20200518</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">gw</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">l8_224078_20200518_polygons</span><span class="p">,</span>
                            <span class="n">band_names</span><span class="o">=</span><span class="n">src</span><span class="o">.</span><span class="n">band</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
        <span class="c1"># use pandas groupby to calc pixel mean  </span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>    point         blue        green          red
id                                              
0   103.5  7990.052885  7388.432692  6264.807692
1   304.0  7692.481865  7037.419689  7571.207254
2   497.0  7506.901554  6838.704663  6091.932642
3   632.5  8668.423077  8294.717949  8312.192308
</pre></div>
</div>
</div>
</div>
</div>
</div>
</div>
<span id="document-docs/f_rs_ml_predict"></span><hr class="docutils" id="f-rs-ml-predict" />
<div class="admonition-learning-objectives admonition">
<p class="admonition-title">Learning Objectives</p>
<ul class="simple">
<li><p>Fit and predict machine learning models to make spatial predictions</p>
<ul>
<li><p>Use sklearn pipelines, cross-validation and hyper parameter tuning for spatial data</p></li>
</ul>
</li>
<li><p>Predict landcover or continuous models</p></li>
<li><p>Make predictions using timeseries data</p></li>
</ul>
</div>
<div class="admonition-review admonition">
<p class="admonition-title">Review</p>
<ul class="simple">
<li><p><a class="reference internal" href="docs/a_intro.html#document-docs/f_rs_io"><span class="doc std std-doc">Geowombat IO</span></a></p></li>
<li><p><a class="reference internal" href="docs/a_intro.html#document-docs/f_rs_extraction"><span class="doc std std-doc">Geowombat Extraction</span></a></p></li>
<li><p><a class="reference external" href="https://phausamann.github.io/sklearn-xarray/">Sklearn_xarray</a></p></li>
<li><p><a class="reference external" href="https://medium.com/vickdata/a-simple-guide-to-scikit-learn-pipelines-4ac0d974bdcf">Sklearn pipelines</a></p></li>
</ul>
</div>
<hr class="docutils" />
<div class="tex2jax_ignore mathjax_ignore section" id="spatial-prediction-using-ml-in-python">
<h2>Spatial Prediction using ML in Python<a class="headerlink" href="#spatial-prediction-using-ml-in-python" title="Permalink to this headline">#</a></h2>
<div class="section" id="create-land-use-classification-using-geowombat-sklearn">
<h3>Create Land Use Classification using Geowombat &amp; Sklearn<a class="headerlink" href="#create-land-use-classification-using-geowombat-sklearn" title="Permalink to this headline">#</a></h3>
<p>The most common task for remotely sensed data is creating land cover classification. In this tutorial we will walk you through how to train a ML model using raster data. These methods are heavily dependent on the great package <a class="reference external" href="https://phausamann.github.io/sklearn-xarray/">sklearn_xarray</a>. To understand the pipeline commands please see their <a class="reference external" href="https://scikit-learn.org/stable/modules/generated/sklearn.pipeline.Pipeline.html">documentation</a> and <a class="reference external" href="https://scikit-learn.org/stable/auto_examples/index.html#pipelines-and-composite-estimators">examples</a>.</p>
<div class="section" id="supervised-classification-in-python">
<h4>Supervised Classification in Python<a class="headerlink" href="#supervised-classification-in-python" title="Permalink to this headline">#</a></h4>
<p>In the following example we will use Landsat data, some training data to train a supervised sklearn model. In order to do this we first need  to have land classifications for a set of points of polygons. In this case we have three polygons with the classes [‘water’,’crop’,’tree’,’developed’]. The first step is to use <code class="docutils literal notranslate"><span class="pre">LabelEncoder</span></code> to convert these to integer based categories, which we store in a new column called ‘lc’.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">geowombat</span> <span class="k">as</span> <span class="nn">gw</span>
<span class="kn">from</span> <span class="nn">geowombat.data</span> <span class="kn">import</span> <span class="n">l8_224078_20200518</span><span class="p">,</span> <span class="n">l8_224078_20200518_polygons</span>
<span class="kn">from</span> <span class="nn">geowombat.ml</span> <span class="kn">import</span> <span class="n">fit</span><span class="p">,</span> <span class="n">predict</span><span class="p">,</span> <span class="n">fit_predict</span>
<span class="kn">import</span> <span class="nn">geopandas</span> <span class="k">as</span> <span class="nn">gpd</span>
<span class="kn">from</span> <span class="nn">sklearn_xarray.preprocessing</span> <span class="kn">import</span> <span class="n">Featurizer</span>
<span class="kn">from</span> <span class="nn">sklearn.pipeline</span> <span class="kn">import</span> <span class="n">Pipeline</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">LabelEncoder</span><span class="p">,</span> <span class="n">StandardScaler</span>
<span class="kn">from</span> <span class="nn">sklearn.decomposition</span> <span class="kn">import</span> <span class="n">PCA</span>
<span class="kn">from</span> <span class="nn">sklearn.naive_bayes</span> <span class="kn">import</span> <span class="n">GaussianNB</span>

<span class="n">le</span> <span class="o">=</span> <span class="n">LabelEncoder</span><span class="p">()</span>

<span class="c1"># The labels are string names, so here we convert them to integers</span>
<span class="n">labels</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">l8_224078_20200518_polygons</span><span class="p">)</span>
<span class="n">labels</span><span class="p">[</span><span class="s1">&#39;lc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">le</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">labels</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">labels</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>        name                                           geometry  lc
0      water  POLYGON ((737544.502 -2795232.772, 737544.502 ...   3
1       crop  POLYGON ((742517.658 -2798160.232, 743046.717 ...   0
2       tree  POLYGON ((742435.360 -2801875.403, 742458.874 ...   2
3  developed  POLYGON ((738903.667 -2811573.845, 738926.586 ...   1
</pre></div>
</div>
</div>
</div>
<p>We are then going to generate our sklearn pipeline (<a class="reference external" href="https://medium.com/vickdata/a-simple-guide-to-scikit-learn-pipelines-4ac0d974bdcf">see simple tutorial here</a>). A pipeline simply allows us to pass a numpy array through a defined set of operations. In this case the data is passed through the following operations:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">StandardScaler</span></code>: <a class="reference external" href="https://scikit-learn.org/stable/modules/generated/sklearn.preprocessing.StandardScaler.html">Normalizes</a> all variables by removing the mean and scaling to unit variance</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">PCA</span></code>: Calculates <a class="reference external" href="https://scikit-learn.org/stable/modules/generated/sklearn.decomposition.PCA.html?highlight=pca#sklearn.decomposition.PCA">Principal Components</a> to reduce dimensionality.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">GaussianNB</span></code>: Fits a <a class="reference external" href="https://scikit-learn.org/stable/modules/generated/sklearn.naive_bayes.GaussianNB.html?highlight=gaussiannb#sklearn.naive_bayes.GaussianNB">Gaussian Naive Bayes</a> model for a quick classification.</p></li>
</ul>
<p>In this example we will fit and predict the model in two steps. The <code class="docutils literal notranslate"><span class="pre">fit</span></code> method returns three objects, a transformed version of the original dataset <code class="docutils literal notranslate"><span class="pre">X</span></code> that can be used by sklearn, <code class="docutils literal notranslate"><span class="pre">Xy</span></code> a tuple containing the data used for training <code class="docutils literal notranslate"><span class="pre">(X,y)</span></code> where any data outside the polygons is removed, and the trained pipeline <code class="docutils literal notranslate"><span class="pre">clf</span></code> object.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="c1"># Use a data pipeline</span>
<span class="n">pl</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">([</span> <span class="p">(</span><span class="s1">&#39;scaler&#39;</span><span class="p">,</span> <span class="n">StandardScaler</span><span class="p">()),</span>
                <span class="p">(</span><span class="s1">&#39;pca&#39;</span><span class="p">,</span> <span class="n">PCA</span><span class="p">()),</span>
                <span class="p">(</span><span class="s1">&#39;clf&#39;</span><span class="p">,</span> <span class="n">GaussianNB</span><span class="p">())])</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>

<span class="c1"># Fit the classifier</span>
<span class="k">with</span> <span class="n">gw</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">ref_res</span><span class="o">=</span><span class="mi">150</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">gw</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">l8_224078_20200518</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
        <span class="n">X</span><span class="p">,</span> <span class="n">Xy</span><span class="p">,</span> <span class="n">clf</span> <span class="o">=</span> <span class="n">fit</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">pl</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="s2">&quot;lc&quot;</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">predict</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">clf</span><span class="p">)</span>
        <span class="n">y</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">robust</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">pad</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/f_rs_ml_predict_3_0.png" src="../_images/f_rs_ml_predict_3_0.png" />
</div>
</div>
<p>In order to fit and predict to our original data in one step, we simply use <code class="docutils literal notranslate"><span class="pre">fit_predict</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">geowombat.ml</span> <span class="kn">import</span> <span class="n">fit_predict</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>

<span class="k">with</span> <span class="n">gw</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">ref_res</span><span class="o">=</span><span class="mi">150</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">gw</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">l8_224078_20200518</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">fit_predict</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">pl</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="s1">&#39;lc&#39;</span><span class="p">)</span>
        <span class="n">y</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">robust</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">pad</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/f_rs_ml_predict_5_0.png" src="../_images/f_rs_ml_predict_5_0.png" />
</div>
</div>
</div>
<div class="section" id="unsupervised-classification-in-python">
<h4>Unsupervised Classification in Python<a class="headerlink" href="#unsupervised-classification-in-python" title="Permalink to this headline">#</a></h4>
<p>Unsupervised classification takes a different approach. Here we don’t have to provide examples of different land cover types. Instead we rely on the algorithm to identify distinct clusters of similar data, and apply a unique label to each cluster. For instance, if we are talking about land cover water and trees are going to look very different. Water reflects more blue and absorbs all the near infrared, while trees reflect little blue and reflect lots of near infrared.  Therefore water and trees should ‘cluster’ together when plotted out according to their different blue and near infrared reflectances. These clusters will be assigned a unique value to each pixel, e.g. water will be assigned 1 and trees 2. Later, the end user will need to go back and assign the label to each numbered cluster, e.g. water=1, trees=2.</p>
<p>In this example we will use <a class="reference external" href="https://scikit-learn.org/stable/modules/generated/sklearn.cluster.KMeans.html">kmeans</a> to do our clustering. To run we need to decide apriori how many clusters we want to identify. Typically you want to roughly double the number of expected classes and then recombine them later into the desired labels. This helps to better understand and categorize the variation in your image.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.cluster</span> <span class="kn">import</span> <span class="n">KMeans</span>
<span class="n">cl</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">([</span> <span class="p">(</span><span class="s1">&#39;clf&#39;</span><span class="p">,</span> <span class="n">KMeans</span><span class="p">(</span><span class="n">n_clusters</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">))])</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>

<span class="c1"># Fit_predict unsupervised classifier</span>
<span class="k">with</span> <span class="n">gw</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">ref_res</span><span class="o">=</span><span class="mi">150</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">gw</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">l8_224078_20200518</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
        <span class="n">y</span><span class="o">=</span> <span class="n">fit_predict</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">cl</span><span class="p">)</span>
        <span class="n">y</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">robust</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">pad</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/f_rs_ml_predict_7_0.png" src="../_images/f_rs_ml_predict_7_0.png" />
</div>
</div>
<p>In this case we can see that it effective labels different clusters of data, and now it is up to us to determine which clusters should be categorized as water, trees, and fields etc.</p>
</div>
</div>
<div class="section" id="spatial-prediction-with-time-series-stack-using-geowombat-sklearn">
<h3>Spatial prediction with time series stack using Geowombat &amp; Sklearn<a class="headerlink" href="#spatial-prediction-with-time-series-stack-using-geowombat-sklearn" title="Permalink to this headline">#</a></h3>
<p>If you have a stack of time series data it is simple to apply the same method as we described previously, except we need to open multiple images, set <code class="docutils literal notranslate"><span class="pre">stack_dim</span></code> to ‘time’ and set the <code class="docutils literal notranslate"><span class="pre">time_names</span></code>.  <em>Note</em> we are just pretending we have two dates of LandSat imagery here.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>

<span class="k">with</span> <span class="n">gw</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">ref_res</span><span class="o">=</span><span class="mi">150</span><span class="p">):</span>
   <span class="k">with</span> <span class="n">gw</span><span class="o">.</span><span class="n">open</span><span class="p">([</span><span class="n">l8_224078_20200518</span><span class="p">,</span> <span class="n">l8_224078_20200518</span><span class="p">],</span> <span class="n">time_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;t1&#39;</span><span class="p">,</span> <span class="s1">&#39;t2&#39;</span><span class="p">],</span> <span class="n">stack_dim</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">fit_predict</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">pl</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="s1">&#39;lc&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        <span class="c1"># plot one time period prediction</span>
        <span class="n">y</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="s1">&#39;t1&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">robust</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;xarray.DataArray (time: 2, y: 372, x: 408)&gt;
dask.array&lt;getitem, shape=(2, 372, 408), dtype=float64, chunksize=(1, 256, 256), chunktype=numpy.ndarray&gt;
Coordinates:
    band     &lt;U4 &#39;targ&#39;
  * y        (y) float64 -2.777e+06 -2.777e+06 ... -2.833e+06 -2.833e+06
  * x        (x) float64 7.174e+05 7.176e+05 7.177e+05 ... 7.783e+05 7.785e+05
  * time     (time) &lt;U2 &#39;t1&#39; &#39;t2&#39;
    targ     (time, y, x) float64 nan nan nan nan nan ... nan nan nan nan nan
Attributes:
    transform:          (150.0, 0.0, 717345.0, 0.0, -150.0, -2776995.0)
    crs:                +init=epsg:32621
    res:                (150.0, 150.0)
    is_tiled:           0
    nodatavals:         (0, 0, 0)
    scales:             (1.0, 1.0, 1.0)
    offsets:            (0.0, 0.0, 0.0)
    filename:           [&#39;LC08_L1TP_224078_20200518_20200518_01_RT.TIF&#39;, &#39;LC0...
    resampling:         nearest
    AREA_OR_POINT:      Area
    data_are_separate:  1
    data_are_stacked:   1
</pre></div>
</div>
<img alt="../_images/f_rs_ml_predict_9_1.png" src="../_images/f_rs_ml_predict_9_1.png" />
</div>
</div>
<p>If you want to do more sophisticated model tuning using sklearn it is also possible to break up your fit and predict steps as follows:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>

<span class="k">with</span> <span class="n">gw</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">ref_res</span><span class="o">=</span><span class="mi">150</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">gw</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">l8_224078_20200518</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
        <span class="n">X</span><span class="p">,</span> <span class="n">Xy</span><span class="p">,</span> <span class="n">clf</span> <span class="o">=</span> <span class="n">fit</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">pl</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="s2">&quot;lc&quot;</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">predict</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">clf</span><span class="p">)</span>
        <span class="n">y</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">robust</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/f_rs_ml_predict_11_0.png" src="../_images/f_rs_ml_predict_11_0.png" />
</div>
</div>
</div>
<div class="section" id="cross-validation-and-hyperparameter-tuning-with-spatial-prediction">
<h3>Cross-validation and Hyperparameter Tuning with Spatial Prediction<a class="headerlink" href="#cross-validation-and-hyperparameter-tuning-with-spatial-prediction" title="Permalink to this headline">#</a></h3>
<p>One of the most important parts of successfully building a model is a careful assessment of model performance. To do this we will leverage some of <code class="docutils literal notranslate"><span class="pre">sklearn</span></code> built in tools. One of the most common cross-validation methods is called k-fold, where you data is broken in to independent sets of training and testing data multiple times. The ability of the model - trained on the ‘training’ data - to predict the outcome of the ‘testing’ data multiple times. We can then have a measure of how well our model will work on data it has never seen before.</p>
<p>In this case we are going to use our supervised classification pipeline <code class="docutils literal notranslate"><span class="pre">pl</span></code> from earlier. And we will use <a class="reference external" href="https://scikit-learn.org/stable/modules/generated/sklearn.model_selection.KFold.html?highlight=kfold#sklearn.model_selection.KFold">kfold</a> to do <a class="reference external" href="https://scikit-learn.org/stable/modules/cross_validation.html">cross-validation</a>. To use <code class="docutils literal notranslate"><span class="pre">kfold</span></code> with <code class="docutils literal notranslate"><span class="pre">geowombat</span></code> we need to use <code class="docutils literal notranslate"><span class="pre">CrossValidatorWrapper</span></code> as seen in the example below to allow it to work with <code class="docutils literal notranslate"><span class="pre">xarray</span></code> objects.</p>
<p>We often also need to <a class="reference external" href="https://scikit-learn.org/stable/modules/grid_search.html">hyper-parameter tune</a>
our model. In this case we will see if we need to keep 1, 2, or 3 <a class="reference external" href="https://scikit-learn.org/stable/modules/generated/sklearn.decomposition.PCA.html?highlight=pca#sklearn.decomposition.PCA">pca</a> components. We might also want to experiment with whether scaling the data range impacts our perforamnce with <a class="reference external" href="https://scikit-learn.org/stable/modules/generated/sklearn.preprocessing.StandardScaler.html?highlight=standardscaler#sklearn.preprocessing.StandardScaler">StandardScaler</a> by changing whether or not variables are divided by their standard deviation.</p>
<p>To do hyper-parameter tuning with <a class="reference external" href="https://scikit-learn.org/stable/modules/generated/sklearn.model_selection.GridSearchCV.html?highlight=gridsearchcv#sklearn.model_selection.GridSearchCV">GridSearchCV</a> in a pipeline we need to set up the ‘parameter-grid’. This part can be a little confusing. To help us let’s isolate the <code class="docutils literal notranslate"><span class="pre">Pipeline</span></code> and <code class="docutils literal notranslate"><span class="pre">param_grid</span></code> from the example below:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">pl</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">([(</span><span class="s1">&#39;scaler&#39;</span><span class="p">,</span> <span class="n">StandardScaler</span><span class="p">()),</span>
               <span class="p">(</span><span class="s1">&#39;pca&#39;</span><span class="p">,</span> <span class="n">PCA</span><span class="p">()),</span>
               <span class="p">(</span><span class="s1">&#39;clf&#39;</span><span class="p">,</span> <span class="n">GaussianNB</span><span class="p">())])</span>

<span class="n">param_grid</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;scaler__with_std&quot;</span><span class="p">:[</span><span class="kc">True</span><span class="p">,</span><span class="kc">False</span><span class="p">],</span>
            <span class="s2">&quot;pca__n_components&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
            <span class="p">}</span>
</pre></div>
</div>
<p>Notice that each step in the pipeline is labeled (e.g. ‘scaler’, ‘pca’, ‘clf’). To try out different parameters for each step we are going to need to reference them by name in our <code class="docutils literal notranslate"><span class="pre">param_grid</span></code> dictionary. The dictionary follows this convention:</p>
<p><code class="docutils literal notranslate"><span class="pre">(step_name)__(parameter_name):[value_1,</span> <span class="pre">value2]</span></code></p>
<p>So <code class="docutils literal notranslate"><span class="pre">&quot;pca__n_components&quot;:</span> <span class="pre">[1,</span> <span class="pre">2,</span> <span class="pre">3]</span></code> says that for the <code class="docutils literal notranslate"><span class="pre">pca</span></code> step of the pipeline, we will try out tree different values for the parameter <code class="docutils literal notranslate"><span class="pre">n_components</span></code>, allowing us to choose the one that performs best at predicting our ‘testing’ data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">GridSearchCV</span><span class="p">,</span> <span class="n">KFold</span>
<span class="kn">from</span> <span class="nn">sklearn_xarray.model_selection</span> <span class="kn">import</span> <span class="n">CrossValidatorWrapper</span>

<span class="n">pl</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">([(</span><span class="s1">&#39;scaler&#39;</span><span class="p">,</span> <span class="n">StandardScaler</span><span class="p">()),</span>
               <span class="p">(</span><span class="s1">&#39;pca&#39;</span><span class="p">,</span> <span class="n">PCA</span><span class="p">()),</span>
               <span class="p">(</span><span class="s1">&#39;clf&#39;</span><span class="p">,</span> <span class="n">GaussianNB</span><span class="p">())])</span>

<span class="n">cv</span> <span class="o">=</span> <span class="n">CrossValidatorWrapper</span><span class="p">(</span><span class="n">KFold</span><span class="p">())</span>
<span class="n">gridsearch</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span><span class="n">pl</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="n">cv</span><span class="p">,</span> <span class="n">scoring</span><span class="o">=</span><span class="s1">&#39;balanced_accuracy&#39;</span><span class="p">,</span>
                    <span class="n">param_grid</span><span class="o">=</span><span class="p">{</span>
                      <span class="s2">&quot;scaler__with_std&quot;</span><span class="p">:[</span><span class="kc">True</span><span class="p">,</span><span class="kc">False</span><span class="p">],</span>
                      <span class="s2">&quot;pca__n_components&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
                      <span class="p">})</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>

<span class="k">with</span> <span class="n">gw</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">ref_res</span><span class="o">=</span><span class="mi">150</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">gw</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">l8_224078_20200518</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
        <span class="c1"># fit a model to get Xy used to train model</span>
        <span class="n">X</span><span class="p">,</span> <span class="n">Xy</span><span class="p">,</span> <span class="n">pipe</span> <span class="o">=</span> <span class="n">fit</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">pl</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="s2">&quot;lc&quot;</span><span class="p">)</span>

        <span class="c1"># fit cross valiation and parameter tuning</span>
        <span class="c1"># NOTE: must unpack * object Xy</span>
        <span class="n">gridsearch</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="o">*</span><span class="n">Xy</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">gridsearch</span><span class="o">.</span><span class="n">cv_results_</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">gridsearch</span><span class="o">.</span><span class="n">best_score_</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">gridsearch</span><span class="o">.</span><span class="n">best_params_</span><span class="p">)</span>        

        <span class="c1"># get set tuned parameters and make the prediction</span>
        <span class="c1"># Note: predict(gridsearch.best_model_) not currently supported</span>
        <span class="n">pipe</span><span class="o">.</span><span class="n">set_params</span><span class="p">(</span><span class="o">**</span><span class="n">gridsearch</span><span class="o">.</span><span class="n">best_params_</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">predict</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">pipe</span><span class="p">)</span>
        <span class="n">y</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">robust</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">pad</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;mean_fit_time&#39;: array([0.15127478, 0.17484608, 0.14793749, 0.14352918, 0.15261936,
       0.18515682]), &#39;std_fit_time&#39;: array([0.00583673, 0.04766097, 0.00490675, 0.00348462, 0.00864314,
       0.03577372]), &#39;mean_score_time&#39;: array([0.09150372, 0.11217704, 0.09275851, 0.09279857, 0.10127025,
       0.11805472]), &#39;std_score_time&#39;: array([0.00606398, 0.02464995, 0.0030899 , 0.00282972, 0.01786448,
       0.0282516 ]), &#39;param_pca__n_components&#39;: masked_array(data=[1, 1, 2, 2, 3, 3],
             mask=[False, False, False, False, False, False],
       fill_value=&#39;?&#39;,
            dtype=object), &#39;param_scaler__with_std&#39;: masked_array(data=[True, False, True, False, True, False],
             mask=[False, False, False, False, False, False],
       fill_value=&#39;?&#39;,
            dtype=object), &#39;params&#39;: [{&#39;pca__n_components&#39;: 1, &#39;scaler__with_std&#39;: True}, {&#39;pca__n_components&#39;: 1, &#39;scaler__with_std&#39;: False}, {&#39;pca__n_components&#39;: 2, &#39;scaler__with_std&#39;: True}, {&#39;pca__n_components&#39;: 2, &#39;scaler__with_std&#39;: False}, {&#39;pca__n_components&#39;: 3, &#39;scaler__with_std&#39;: True}, {&#39;pca__n_components&#39;: 3, &#39;scaler__with_std&#39;: False}], &#39;split0_test_score&#39;: array([1., 1., 1., 1., 1., 1.]), &#39;split1_test_score&#39;: array([1., 1., 1., 1., 1., 1.]), &#39;split2_test_score&#39;: array([0.75 , 0.875, 0.75 , 0.75 , 0.625, 0.5  ]), &#39;split3_test_score&#39;: array([1., 1., 1., 1., 1., 1.]), &#39;split4_test_score&#39;: array([0., 0., 0., 0., 0., 0.]), &#39;mean_test_score&#39;: array([0.75 , 0.775, 0.75 , 0.75 , 0.725, 0.7  ]), &#39;std_test_score&#39;: array([0.38729833, 0.39051248, 0.38729833, 0.38729833, 0.39051248,
       0.4       ]), &#39;rank_test_score&#39;: array([2, 1, 2, 2, 5, 6], dtype=int32)}
0.775
{&#39;pca__n_components&#39;: 1, &#39;scaler__with_std&#39;: False}
</pre></div>
</div>
<img alt="../_images/f_rs_ml_predict_13_1.png" src="../_images/f_rs_ml_predict_13_1.png" />
</div>
</div>
<p>In order to create a model with the optimal parameters we need to use <code class="docutils literal notranslate"><span class="pre">gridsearch.best_params_</span></code>, which holds a dictionary of each parameter and its optimal value. To ‘use’ these values we need to update the parameters held in our returned pipeline, <code class="docutils literal notranslate"><span class="pre">pipe</span></code>, by using the <code class="docutils literal notranslate"><span class="pre">.set_params</span></code> method. We use <code class="docutils literal notranslate"><span class="pre">**</span></code> to unpack the dictionary values, tutorial on <a class="reference external" href="https://medium.com/ml-and-automation/how-to-unpack-list-dictionary-tuple-in-python-c0705d29931c">unpacking here</a>.</p>
<p>Notice that the <code class="docutils literal notranslate"><span class="pre">gridsearch</span></code> has a few attributes of interest. This includes all the results of the kfold rounds <code class="docutils literal notranslate"><span class="pre">.cv_results_</span></code>, the best score obtained <code class="docutils literal notranslate"><span class="pre">.best_score_</span></code>, and the ideal set of parameters to use in the pipeline <code class="docutils literal notranslate"><span class="pre">.best_params_</span></code>.  This lase one <code class="docutils literal notranslate"><span class="pre">.best_params_</span></code> will be use to update our <code class="docutils literal notranslate"><span class="pre">pipe</span></code> pipeline for prediction.</p>
</div>
</div>
</div>
<!-- -----------------------

https://autogis-site.readthedocs.io/en/latest/index.html

# A: Data Types
- Vector Data
  - Geojson
  - Shp
  - Geopkg

- Raster Data
  - Arrays 
  - Spatial Arrays
 
- Materials
  - https://mgimond.github.io/Spatial/chp02-0.html


-----------------------------
# B: Nature of Coordinate Systems
- Geographic Coordinates
- Projected Coordinates
- CRS and Proj4Strings
- Use mostly https://mgimond.github.io/Spatial/chp09-0.html  and https://automating-gis-processes.github.io/CSC18/lessons/L2/projections.html

## Reproject vs Warp
- Example reproject (might be example in book)
- Example of warp focus on affine transform

## Exercises: 
- Plot dots for distortion
- What's in a proj4string?
- Create your own projection

## Materials
- https://automating-gis-processes.github.io/site/notebooks/L2/projections.html
- https://mgimond.github.io/Spatial/chp09-0.html
- Turtle draw excercise in "mastering geospatil analysis with python"
- https://autogis-site.readthedocs.io/en/latest/notebooks/L2/02-projections.html
 -https://docs.geotools.org/stable/userguide/tutorial/affinetransform.html
 - https://people.cs.clemson.edu/~dhouse/courses/401/notes/affines-matrices.pdf
----------------------
# C: Basics with Spatial Data
## Vector
- read/write geopandas
- plots
- Basic operations
  - Subset rows
  - Create new data from lat lon
  - reproject
  - Non-spatial left join new data into shapefile
- Geoprocessing
  - Unions
  - Intersect
  - etc
  
- Merge & Aggregate Attributes

## Raster
- read/write rasterio
- plots
- Basic operations
  - band math
  - clip
- Vector Raster Operations
  - Extract by feature
  - Summarize by feature


----------------------
# D: Remote Sensing with Geowombat

- Common Operations
  - Mosaic
  - Band Math and NDVI
  - Cloud masking
  - Landcover classfication
  - Others?

-----------------------
# Deep Learning Feature Classification
- Common Operations
  - Simple label transfer learning
  - Object detection
  - Others?

# Visualization
- https://handsondataviz.org/geojsonio.html

## Book rendering options
- https://executablebooks.github.io/quantecon-mini-example/docs/python_by_example.html
- https://jupyterbook.org/intro.html
- https://www.sphinx-doc.org/en/master/ --></div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./docs"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By Michael Mann, Steven Chao, Jordan Graesser, Nina Feldman<br/>
  
    <div class="extra_footer">
      <div>
    <b>Supported by:</b>  <br>
    <a href="https://geography.columbian.gwu.edu/">
 <img alt="GW Geography" src="../_static/global/GWBlue.png"
  width="300" align="left">
</div>
<div>
<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" ><img align="right" alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" /></a> 
</div>

    </div>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>